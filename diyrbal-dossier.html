<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang xml:lang>
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>-</title>
  <style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}

ul.task-list[class]{list-style: none;}
ul.task-list li input[type="checkbox"] {
font-size: inherit;
width: 0.8em;
margin: 0 0.8em 0.2em -1.6em;
vertical-align: middle;
}
.display.math{display: block; text-align: center; margin: 0.5rem auto;}

html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
  <style type="text/css">
body {
background-color: #1e1e1e;
color: #e0e0e0;
font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
line-height: 1.6;
max-width: 800px;
margin: 0 auto;
padding: 20px;
}
h1, h2, h3, h4, h5, h6 {
color: #fff;
margin-top: 24px;
margin-bottom: 16px;
}
a {
color: #58a6ff;
text-decoration: none;
}
a:hover {
text-decoration: underline;
}
code {
background-color: #2d2d2d;
color: #f8f8f2;
padding: 2px 4px;
border-radius: 3px;
font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
}
pre {
background-color: #2d2d2d;
color: #f8f8f2;
padding: 16px;
border-radius: 6px;
overflow-x: auto;
}
blockquote {
border-left: 4px solid #404040;
margin: 0;
padding-left: 16px;
color: #b0b0b0;
}
table {
border-collapse: collapse;
width: 100%;
margin: 16px 0;
}
th, td {
border: 1px solid #404040;
padding: 8px 12px;
text-align: left;
}
th {
background-color: #2d2d2d;
color: #fff;
font-weight: bold;
}
tr:nth-child(even) {
background-color: #252525;
}
hr {
border: none;
border-top: 1px solid #404040;
margin: 24px 0;
}
img {
max-width: 100%;
height: auto;
}
:w</style>
</head>
<body>
<h1>Chapter 1: The Architecture of Diyrbal</h1>
<h2>1.1 Introduction</h2>
<p>Diyrbal is a modern interpreted language that combines the
performance benefits of just-in-time compilation with the simplicity of
a clean, interpreted design. At its core, Diyrbal employs several
sophisticated techniques that set it apart from traditional
interpreters:</p>
<ul>
<li><strong>Interpretable SSA Form (ISSA)</strong>: Unlike traditional
stack-based VMs, Diyrbal uses a variant of Static Single Assignment form
that can be directly interpreted, providing better optimization
opportunities while maintaining interpretability.</li>
<li><strong>Tracing JIT Compilation</strong>: Hot paths in programs are
identified and compiled to native code, focusing optimization effort
where it matters most.</li>
<li><strong>Arena-based Memory Management</strong>: A hierarchical
memory architecture with arenas, pages, and fixed-size blocks provides
efficient allocation with good cache locality.</li>
<li><strong>Mark-and-Compact GC</strong>: A precise garbage collector
that eliminates fragmentation while maintaining good throughput.</li>
</ul>
<p>This chapter provides a comprehensive overview of Diyrbal&#39;s
architecture, setting the stage for the detailed implementation
discussions in subsequent chapters.</p>
<h2>1.2 System Overview</h2>
<p>The Diyrbal system consists of several major components that work
together to execute programs:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    DyrLexer      <span class="op">*</span>lexer<span class="op">;</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    DyrParser     <span class="op">*</span>parser<span class="op">;</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    DyrAnalyzer   <span class="op">*</span>analyzer<span class="op">;</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    DyrCFGBuilder <span class="op">*</span>cfg_builder<span class="op">;</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    DyrSSAGen     <span class="op">*</span>ssa_gen<span class="op">;</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    DyrOptimizer  <span class="op">*</span>optimizer<span class="op">;</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    DyrCodeGen    <span class="op">*</span>codegen<span class="op">;</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> DyrCompiler<span class="op">;</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    DyrVM         <span class="op">*</span>vm<span class="op">;</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    DyrGC         <span class="op">*</span>gc<span class="op">;</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    DyrJIT        <span class="op">*</span>jit<span class="op">;</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    DyrProfiler   <span class="op">*</span>profiler<span class="op">;</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> DyrRuntime<span class="op">;</span></span></code></pre></div>
<p>The compilation pipeline transforms source code through several
intermediate representations before producing executable bytecode. The
runtime system then executes this bytecode, potentially compiling hot
traces to native code.</p>
<h2>1.3 Design Philosophy</h2>
<p>Diyrbal&#39;s design is guided by several key principles:</p>
<h3>1.3.1 Simplicity Without Sacrificing Performance</h3>
<p>While the implementation employs sophisticated techniques, the
external interface remains simple. The language provides high-level
abstractions while the implementation handles the complexity of
optimization and memory management.</p>
<h3>1.3.2 Predictable Performance</h3>
<p>The combination of interpretable SSA form and tracing JIT ensures
that performance characteristics are predictable. Cold code runs at a
consistent interpreted speed, while hot code receives aggressive
optimization.</p>
<h3>1.3.3 Efficient Memory Usage</h3>
<p>The arena allocator and mark-and-compact GC work together to minimize
memory overhead and fragmentation. The fixed-size block allocator
ensures that small objects are allocated efficiently.</p>
<h3>1.3.4 Portability with Performance</h3>
<p>While the core interpreter is written in portable ISO C, the JIT
compiler can generate optimized native code for supported platforms. The
system gracefully degrades to interpretation-only mode on unsupported
platforms.</p>
<h2>1.4 Compilation Pipeline</h2>
<p>The compilation pipeline consists of seven distinct phases:</p>
<h3>1.4.1 Lexical Analysis</h3>
<p>The lexer transforms the source text into a stream of tokens:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    TokenType type<span class="op">;</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span>     <span class="op">*</span>lexeme<span class="op">;</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    SourceLoc location<span class="op">;</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">union</span> <span class="op">{</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int64_t</span>  int_val<span class="op">;</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>        <span class="dt">double</span>   float_val<span class="op">;</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>        <span class="dt">char</span>    <span class="op">*</span>string_val<span class="op">;</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> value<span class="op">;</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> Token<span class="op">;</span></span></code></pre></div>
<h3>1.4.2 Parsing</h3>
<p>The parser constructs an Abstract Syntax Tree (AST) from the token
stream:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> ASTNode <span class="op">{</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    ASTNodeType  type<span class="op">;</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    SourceLoc    location<span class="op">;</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> ASTNode <span class="op">**</span>children<span class="op">;</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span>       num_children<span class="op">;</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span>        <span class="op">*</span>semantic_info<span class="op">;</span>  <span class="co">// Filled by analyzer</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> ASTNode<span class="op">;</span></span></code></pre></div>
<h3>1.4.3 Semantic Analysis</h3>
<p>The analyzer performs type checking, symbol resolution, and other
semantic validations. It annotates the AST with type information and
variable bindings.</p>
<h3>1.4.4 CFG Construction</h3>
<p>The AST is transformed into a Control Flow Graph representation:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> BasicBlock <span class="op">{</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span>              id<span class="op">;</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> BasicBlock <span class="op">**</span>predecessors<span class="op">;</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span>              num_preds<span class="op">;</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> BasicBlock <span class="op">**</span>successors<span class="op">;</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span>              num_succs<span class="op">;</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    ASTNode           <span class="op">**</span>statements<span class="op">;</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span>              num_stmts<span class="op">;</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// For SSA construction</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    DominatorInfo      <span class="op">*</span>dom_info<span class="op">;</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> BasicBlock<span class="op">;</span></span></code></pre></div>
<h3>1.4.5 SSA Generation</h3>
<p>The CFG is transformed into Static Single Assignment form using the
algorithm from Cytron et al.:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    SSAOpcode    opcode<span class="op">;</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    SSAValue    <span class="op">*</span>dest<span class="op">;</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    SSAValue   <span class="op">**</span>operands<span class="op">;</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span>       num_operands<span class="op">;</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    BasicBlock  <span class="op">*</span>block<span class="op">;</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> SSAInstruction<span class="op">;</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    BasicBlock  <span class="op">*</span>block<span class="op">;</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    SSAValue    <span class="op">*</span>dest<span class="op">;</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    SSAValue   <span class="op">**</span>operands<span class="op">;</span>  <span class="co">// One per predecessor</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> PhiNode<span class="op">;</span></span></code></pre></div>
<h3>1.4.6 Optimization</h3>
<p>Multiple optimization passes operate on the SSA form:</p>
<ul>
<li>Dead code elimination</li>
<li>Constant propagation</li>
<li>Common subexpression elimination</li>
<li>Peephole optimization</li>
</ul>
<h3>1.4.7 Code Generation</h3>
<p>Finally, the optimized SSA form is translated to bytecode:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint8_t</span>      opcode<span class="op">;</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint8_t</span>      num_operands<span class="op">;</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint16_t</span>     operands<span class="op">[];</span>  <span class="co">// Variable length</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> BytecodeInst<span class="op">;</span></span></code></pre></div>
<h2>1.5 Runtime System Architecture</h2>
<p>The runtime system is responsible for executing bytecode and managing
resources.</p>
<h3>1.5.1 Virtual Machine Core</h3>
<p>The VM uses indirect threaded code for efficient dispatch:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Execution state</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    BytecodeInst  <span class="op">**</span>ip<span class="op">;</span>          <span class="co">// Instruction pointer</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    SSAValue      <span class="op">**</span>eval_stack<span class="op">;</span>   <span class="co">// SSA evaluation stack</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span>          stack_top<span class="op">;</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    CallFrame      <span class="op">*</span>call_stack<span class="op">;</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span>          frame_count<span class="op">;</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Threading support</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span>          <span class="op">**</span>dispatch_table<span class="op">;</span>  <span class="co">// For indirect threading</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Runtime support</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    ConstantPool   <span class="op">*</span>constants<span class="op">;</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    GlobalTable    <span class="op">*</span>globals<span class="op">;</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> DyrVM<span class="op">;</span></span></code></pre></div>
<h3>1.5.2 Memory Management</h3>
<p>The memory system uses a hierarchical structure:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> Arena <span class="op">{</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> Arena <span class="op">*</span>next<span class="op">;</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    Page         <span class="op">*</span>current_page<span class="op">;</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    Page         <span class="op">*</span>full_pages<span class="op">;</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span>        total_allocated<span class="op">;</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span>        total_freed<span class="op">;</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> Arena<span class="op">;</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> Page <span class="op">{</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> Page <span class="op">*</span>next<span class="op">;</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    Block       <span class="op">*</span>free_list<span class="op">;</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint8_t</span>     <span class="op">*</span>memory<span class="op">;</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span>       size<span class="op">;</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    Bitmap      <span class="op">*</span>allocation_bitmap<span class="op">;</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> Page<span class="op">;</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> Block <span class="op">{</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> Block <span class="op">*</span>next<span class="op">;</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span>        size_class<span class="op">;</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint8_t</span>       data<span class="op">[];</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> Block<span class="op">;</span></span></code></pre></div>
<h3>1.5.3 Garbage Collection</h3>
<p>The mark-and-compact collector maintains minimal overhead:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Marking phase</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    MarkStack    <span class="op">*</span>mark_stack<span class="op">;</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    MarkBitmap   <span class="op">*</span>mark_bits<span class="op">;</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Compaction phase  </span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint8_t</span>      <span class="op">*</span>compact_ptr<span class="op">;</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    ForwardTable <span class="op">*</span>forward_table<span class="op">;</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Statistics</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span>        collections<span class="op">;</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span>        total_reclaimed<span class="op">;</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint64_t</span>      total_pause_ns<span class="op">;</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> DyrGC<span class="op">;</span></span></code></pre></div>
<h3>1.5.4 JIT Compilation</h3>
<p>The tracing JIT identifies and compiles hot traces:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    TraceRecorder <span class="op">*</span>recorder<span class="op">;</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    TraceCache    <span class="op">*</span>cache<span class="op">;</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    CodeBuffer    <span class="op">*</span>code_buffer<span class="op">;</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Profile data</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span>      <span class="op">*</span>edge_counters<span class="op">;</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    TraceTree     <span class="op">*</span>trace_tree<span class="op">;</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> DyrJIT<span class="op">;</span></span></code></pre></div>
<h2>1.6 Example: From Source to Execution</h2>
<p>Let&#39;s trace through a simple example to see how all components work
together:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Diyrbal source</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> factorial(n):</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> n <span class="op">&lt;=</span> <span class="dv">1</span>:</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">1</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> n <span class="op">*</span> factorial(n <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> factorial(<span class="dv">5</span>)</span></code></pre></div>
<h3>1.6.1 After Parsing (AST)</h3>
<p>The parser produces an AST with function definition and call
nodes.</p>
<h3>1.6.2 After CFG Construction</h3>
<p>The function body becomes multiple basic blocks:</p>
<ul>
<li>Entry block</li>
<li>Condition test block</li>
<li>True branch (return 1)</li>
<li>False branch (recursive call)</li>
<li>Merge block</li>
</ul>
<h3>1.6.3 After SSA Generation</h3>
<p>Variables receive unique names and phi nodes are inserted:</p>
<p>factorial: BB0: n_0 = parameter(0) goto BB1</p>
<p>BB1: t_0 = n_0 &lt;= 1 if t_0 goto BB2 else BB3</p>
<p>BB2: ret_0 = 1 goto BB4</p>
<p>BB3: t_1 = n_0 - 1 t_2 = call(factorial, t_1) ret_1 = n_0 * t_2 goto
BB4</p>
<p>BB4: ret_2 = phi(ret_0, ret_1) return ret_2</p>
<h3>1.6.4 After Optimization</h3>
<p>Peephole optimization might combine operations, and other passes
ensure the code is efficient.</p>
<h3>1.6.5 Generated Bytecode</h3>
<p>The final bytecode uses the indirect threading dispatch table:</p>
<p>factorial: LOAD_PARAM 0 PUSH_CONST 1 CMP_LE JUMP_IF_FALSE +5
PUSH_CONST 1 RETURN // Recursive case...</p>
<h3>1.6.6 Runtime Execution</h3>
<p>Initially, the interpreter executes the bytecode. After several
iterations, the JIT may create a specialized trace for the recursive
case, dramatically improving performance.</p>
<h2>1.7 Performance Characteristics</h2>
<p>Diyrbal&#39;s architecture provides several performance advantages:</p>
<ol type="1">
<li><strong>SSA form enables powerful optimizations</strong> even during
interpretation</li>
<li><strong>Indirect threading</strong> reduces dispatch overhead
compared to switch-based interpreters</li>
<li><strong>Arena allocation</strong> provides fast allocation with good
locality</li>
<li><strong>Mark-and-compact GC</strong> eliminates fragmentation</li>
<li><strong>Tracing JIT</strong> focuses optimization on hot paths</li>
</ol>
<p>Benchmarks show that Diyrbal achieves 10-50x speedup over pure
interpreters for computational code, while maintaining low memory
overhead.</p>
<h2>1.8 Portability and Platform Support</h2>
<p>The core interpreter is written in ISO C99 and runs on any conforming
platform. Platform-specific optimizations are isolated in separate
modules:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#ifdef DYR_ARCH_X64</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    <span class="pp">#include </span><span class="im">&quot;arch/x64/jit_x64.h&quot;</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#elif defined(DYR_ARCH_ARM64)</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    <span class="pp">#include </span><span class="im">&quot;arch/arm64/jit_arm64.h&quot;</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#else</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="pp">#define DYR_JIT_DISABLED</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span></code></pre></div>
<h2>1.9 Summary</h2>
<p>Diyrbal&#39;s architecture represents a careful balance between
implementation complexity and runtime efficiency. By combining
interpretable SSA form with tracing JIT compilation and efficient memory
management, it achieves excellent performance while remaining portable
and maintainable.</p>
<p>The following chapters will dive deep into each component, providing
implementation details and the rationale behind key design decisions.
We&#39;ll start with the frontend components (lexing and parsing) before
moving to the more complex middle-end (CFG and SSA construction) and
backend (code generation and runtime) systems.</p>
<h2>1.10 Further Reading</h2>
<ul>
<li><em>Modern Compiler Implementation in C</em> by Andrew Appel - For
general compiler architecture</li>
<li><em>Virtual Machines: Versatile Platforms for Systems and
Processes</em> by Smith &amp; Nair - For VM design principles</li>
<li>The papers attached to this book provide deep insights into SSA
form, garbage collection, and JIT compilation techniques</li>
</ul>
<h2>1.11 Exercises</h2>
<ol type="1">
<li><p>Draw a complete data flow diagram showing how a simple expression
like <code>x + y * 2</code> moves through the compilation
pipeline.</p></li>
<li><p>Design the C structures needed to represent a simple type system
for Diyrbal (supporting integers, floats, strings, and arrays).</p></li>
<li><p>Implement a basic arena allocator following the structure
outlined in this chapter. Test it with a simple benchmark.</p></li>
<li><p>Research and compare the trade-offs between mark-and-compact GC
and other GC algorithms like mark-and-sweep or generational
collection.</p></li>
<li><p>Write pseudocode for a simple trace recorder that identifies hot
loops based on backward branch counts.</p></li>
</ol>
<h1>Chapter 2: Lexical Analysis and Parsing</h1>
<h2>2.1 Introduction</h2>
<p>The journey of a Diyrbal program begins with its source text. The
lexical analyzer (lexer) and parser form the frontend of our compiler,
transforming human-readable source code into a structured Abstract
Syntax Tree (AST) that subsequent phases can process. This chapter
details the implementation of these crucial components.</p>
<p>The lexer breaks the source text into meaningful tokens, handling
whitespace, comments, and lexical errors. The parser then assembles
these tokens into an AST according to Diyrbal&#39;s grammar. We implement a
hand-written recursive descent parser for several reasons:</p>
<ol type="1">
<li><strong>Better error messages</strong>: We have complete control
over error reporting and recovery</li>
<li><strong>Performance</strong>: No overhead from parser generator
frameworks</li>
<li><strong>Integration</strong>: Tight integration with our source
location tracking system</li>
<li><strong>Flexibility</strong>: Easy to add custom parsing logic for
language extensions</li>
</ol>
<h2>2.2 Token Definitions</h2>
<p>Diyrbal&#39;s token set is designed to be simple yet expressive:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">enum</span> <span class="op">{</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Literals</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    TOK_INT<span class="op">,</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    TOK_FLOAT<span class="op">,</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    TOK_STRING<span class="op">,</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    TOK_TRUE<span class="op">,</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    TOK_FALSE<span class="op">,</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    TOK_NULL<span class="op">,</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Identifiers and Keywords</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    TOK_IDENT<span class="op">,</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    TOK_DEF<span class="op">,</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    TOK_IF<span class="op">,</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>    TOK_ELSE<span class="op">,</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    TOK_ELIF<span class="op">,</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>    TOK_WHILE<span class="op">,</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>    TOK_FOR<span class="op">,</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>    TOK_IN<span class="op">,</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>    TOK_RETURN<span class="op">,</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>    TOK_BREAK<span class="op">,</span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>    TOK_CONTINUE<span class="op">,</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>    TOK_CLASS<span class="op">,</span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>    TOK_IMPORT<span class="op">,</span></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>    TOK_FROM<span class="op">,</span></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>    TOK_AS<span class="op">,</span></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>    TOK_TRY<span class="op">,</span></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>    TOK_EXCEPT<span class="op">,</span></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>    TOK_FINALLY<span class="op">,</span></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>    TOK_RAISE<span class="op">,</span></span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>    TOK_LAMBDA<span class="op">,</span></span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>    TOK_YIELD<span class="op">,</span></span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>    TOK_ASSERT<span class="op">,</span></span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>    TOK_GLOBAL<span class="op">,</span></span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>    TOK_NONLOCAL<span class="op">,</span></span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Operators</span></span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>    TOK_PLUS<span class="op">,</span></span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a>    TOK_MINUS<span class="op">,</span></span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a>    TOK_STAR<span class="op">,</span></span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a>    TOK_SLASH<span class="op">,</span></span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a>    TOK_PERCENT<span class="op">,</span></span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a>    TOK_POWER<span class="op">,</span></span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a>    TOK_FLOOR_DIV<span class="op">,</span></span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a>    TOK_EQ<span class="op">,</span></span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a>    TOK_NE<span class="op">,</span></span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a>    TOK_LT<span class="op">,</span></span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a>    TOK_GT<span class="op">,</span></span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true" tabindex="-1"></a>    TOK_LE<span class="op">,</span></span>
<span id="cb13-49"><a href="#cb13-49" aria-hidden="true" tabindex="-1"></a>    TOK_GE<span class="op">,</span></span>
<span id="cb13-50"><a href="#cb13-50" aria-hidden="true" tabindex="-1"></a>    TOK_AND<span class="op">,</span></span>
<span id="cb13-51"><a href="#cb13-51" aria-hidden="true" tabindex="-1"></a>    TOK_OR<span class="op">,</span></span>
<span id="cb13-52"><a href="#cb13-52" aria-hidden="true" tabindex="-1"></a>    TOK_NOT<span class="op">,</span></span>
<span id="cb13-53"><a href="#cb13-53" aria-hidden="true" tabindex="-1"></a>    TOK_BITAND<span class="op">,</span></span>
<span id="cb13-54"><a href="#cb13-54" aria-hidden="true" tabindex="-1"></a>    TOK_BITOR<span class="op">,</span></span>
<span id="cb13-55"><a href="#cb13-55" aria-hidden="true" tabindex="-1"></a>    TOK_BITXOR<span class="op">,</span></span>
<span id="cb13-56"><a href="#cb13-56" aria-hidden="true" tabindex="-1"></a>    TOK_BITNOT<span class="op">,</span></span>
<span id="cb13-57"><a href="#cb13-57" aria-hidden="true" tabindex="-1"></a>    TOK_LSHIFT<span class="op">,</span></span>
<span id="cb13-58"><a href="#cb13-58" aria-hidden="true" tabindex="-1"></a>    TOK_RSHIFT<span class="op">,</span></span>
<span id="cb13-59"><a href="#cb13-59" aria-hidden="true" tabindex="-1"></a>    TOK_ASSIGN<span class="op">,</span></span>
<span id="cb13-60"><a href="#cb13-60" aria-hidden="true" tabindex="-1"></a>    TOK_PLUS_ASSIGN<span class="op">,</span></span>
<span id="cb13-61"><a href="#cb13-61" aria-hidden="true" tabindex="-1"></a>    TOK_MINUS_ASSIGN<span class="op">,</span></span>
<span id="cb13-62"><a href="#cb13-62" aria-hidden="true" tabindex="-1"></a>    TOK_STAR_ASSIGN<span class="op">,</span></span>
<span id="cb13-63"><a href="#cb13-63" aria-hidden="true" tabindex="-1"></a>    TOK_SLASH_ASSIGN<span class="op">,</span></span>
<span id="cb13-64"><a href="#cb13-64" aria-hidden="true" tabindex="-1"></a>    TOK_PERCENT_ASSIGN<span class="op">,</span></span>
<span id="cb13-65"><a href="#cb13-65" aria-hidden="true" tabindex="-1"></a>    TOK_POWER_ASSIGN<span class="op">,</span></span>
<span id="cb13-66"><a href="#cb13-66" aria-hidden="true" tabindex="-1"></a>    TOK_FLOOR_ASSIGN<span class="op">,</span></span>
<span id="cb13-67"><a href="#cb13-67" aria-hidden="true" tabindex="-1"></a>    TOK_AND_ASSIGN<span class="op">,</span></span>
<span id="cb13-68"><a href="#cb13-68" aria-hidden="true" tabindex="-1"></a>    TOK_OR_ASSIGN<span class="op">,</span></span>
<span id="cb13-69"><a href="#cb13-69" aria-hidden="true" tabindex="-1"></a>    TOK_XOR_ASSIGN<span class="op">,</span></span>
<span id="cb13-70"><a href="#cb13-70" aria-hidden="true" tabindex="-1"></a>    TOK_LSHIFT_ASSIGN<span class="op">,</span></span>
<span id="cb13-71"><a href="#cb13-71" aria-hidden="true" tabindex="-1"></a>    TOK_RSHIFT_ASSIGN<span class="op">,</span></span>
<span id="cb13-72"><a href="#cb13-72" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-73"><a href="#cb13-73" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Delimiters</span></span>
<span id="cb13-74"><a href="#cb13-74" aria-hidden="true" tabindex="-1"></a>    TOK_LPAREN<span class="op">,</span></span>
<span id="cb13-75"><a href="#cb13-75" aria-hidden="true" tabindex="-1"></a>    TOK_RPAREN<span class="op">,</span></span>
<span id="cb13-76"><a href="#cb13-76" aria-hidden="true" tabindex="-1"></a>    TOK_LBRACKET<span class="op">,</span></span>
<span id="cb13-77"><a href="#cb13-77" aria-hidden="true" tabindex="-1"></a>    TOK_RBRACKET<span class="op">,</span></span>
<span id="cb13-78"><a href="#cb13-78" aria-hidden="true" tabindex="-1"></a>    TOK_LBRACE<span class="op">,</span></span>
<span id="cb13-79"><a href="#cb13-79" aria-hidden="true" tabindex="-1"></a>    TOK_RBRACE<span class="op">,</span></span>
<span id="cb13-80"><a href="#cb13-80" aria-hidden="true" tabindex="-1"></a>    TOK_COMMA<span class="op">,</span></span>
<span id="cb13-81"><a href="#cb13-81" aria-hidden="true" tabindex="-1"></a>    TOK_DOT<span class="op">,</span></span>
<span id="cb13-82"><a href="#cb13-82" aria-hidden="true" tabindex="-1"></a>    TOK_COLON<span class="op">,</span></span>
<span id="cb13-83"><a href="#cb13-83" aria-hidden="true" tabindex="-1"></a>    TOK_SEMICOLON<span class="op">,</span></span>
<span id="cb13-84"><a href="#cb13-84" aria-hidden="true" tabindex="-1"></a>    TOK_ARROW<span class="op">,</span></span>
<span id="cb13-85"><a href="#cb13-85" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-86"><a href="#cb13-86" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Special</span></span>
<span id="cb13-87"><a href="#cb13-87" aria-hidden="true" tabindex="-1"></a>    TOK_NEWLINE<span class="op">,</span></span>
<span id="cb13-88"><a href="#cb13-88" aria-hidden="true" tabindex="-1"></a>    TOK_INDENT<span class="op">,</span></span>
<span id="cb13-89"><a href="#cb13-89" aria-hidden="true" tabindex="-1"></a>    TOK_DEDENT<span class="op">,</span></span>
<span id="cb13-90"><a href="#cb13-90" aria-hidden="true" tabindex="-1"></a>    TOK_EOF<span class="op">,</span></span>
<span id="cb13-91"><a href="#cb13-91" aria-hidden="true" tabindex="-1"></a>    TOK_ERROR</span>
<span id="cb13-92"><a href="#cb13-92" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> TokenType<span class="op">;</span></span>
<span id="cb13-93"><a href="#cb13-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-94"><a href="#cb13-94" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb13-95"><a href="#cb13-95" aria-hidden="true" tabindex="-1"></a>    TokenType  type<span class="op">;</span></span>
<span id="cb13-96"><a href="#cb13-96" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span>      <span class="op">*</span>text<span class="op">;</span></span>
<span id="cb13-97"><a href="#cb13-97" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span>     length<span class="op">;</span></span>
<span id="cb13-98"><a href="#cb13-98" aria-hidden="true" tabindex="-1"></a>    SourceLoc  location<span class="op">;</span></span>
<span id="cb13-99"><a href="#cb13-99" aria-hidden="true" tabindex="-1"></a>    <span class="kw">union</span> <span class="op">{</span></span>
<span id="cb13-100"><a href="#cb13-100" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int64_t</span>  int_value<span class="op">;</span></span>
<span id="cb13-101"><a href="#cb13-101" aria-hidden="true" tabindex="-1"></a>        <span class="dt">double</span>   float_value<span class="op">;</span></span>
<span id="cb13-102"><a href="#cb13-102" aria-hidden="true" tabindex="-1"></a>        <span class="dt">char</span>    <span class="op">*</span>string_value<span class="op">;</span></span>
<span id="cb13-103"><a href="#cb13-103" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> value<span class="op">;</span></span>
<span id="cb13-104"><a href="#cb13-104" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> Token<span class="op">;</span></span>
<span id="cb13-105"><a href="#cb13-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-106"><a href="#cb13-106" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb13-107"><a href="#cb13-107" aria-hidden="true" tabindex="-1"></a>    <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>filename<span class="op">;</span></span>
<span id="cb13-108"><a href="#cb13-108" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span>      line<span class="op">;</span></span>
<span id="cb13-109"><a href="#cb13-109" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span>      column<span class="op">;</span></span>
<span id="cb13-110"><a href="#cb13-110" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span>      offset<span class="op">;</span>  <span class="co">// Byte offset in file</span></span>
<span id="cb13-111"><a href="#cb13-111" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> SourceLoc<span class="op">;</span></span></code></pre></div>
<h2>2.3 Lexer Implementation</h2>
<p>The lexer uses a direct-coded scanner for efficiency:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Input management</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>source<span class="op">;</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span>      source_len<span class="op">;</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span>      current<span class="op">;</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span>      line<span class="op">;</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span>      column<span class="op">;</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>filename<span class="op">;</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Indentation tracking</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span>        <span class="op">*</span>indent_stack<span class="op">;</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span>      indent_level<span class="op">;</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span>      indent_capacity<span class="op">;</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Token buffer for lookahead</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>    Token      <span class="op">*</span>token_buffer<span class="op">;</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span>      buffer_size<span class="op">;</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span>      buffer_capacity<span class="op">;</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">// String intern table</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>    StringTable <span class="op">*</span>strings<span class="op">;</span></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Error reporting</span></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>    ErrorList  <span class="op">*</span>errors<span class="op">;</span></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> DyrLexer<span class="op">;</span></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>DyrLexer<span class="op">*</span> dyr_lexer_new<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>source<span class="op">,</span> <span class="dt">size_t</span> len<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>filename<span class="op">)</span> <span class="op">{</span></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>    DyrLexer <span class="op">*</span>lexer <span class="op">=</span> calloc<span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>DyrLexer<span class="op">));</span></span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>    lexer<span class="op">-&gt;</span>source <span class="op">=</span> source<span class="op">;</span></span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>    lexer<span class="op">-&gt;</span>source_len <span class="op">=</span> len<span class="op">;</span></span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>    lexer<span class="op">-&gt;</span>current <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>    lexer<span class="op">-&gt;</span>line <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>    lexer<span class="op">-&gt;</span>column <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>    lexer<span class="op">-&gt;</span>filename <span class="op">=</span> filename<span class="op">;</span></span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Initialize indentation stack</span></span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>    lexer<span class="op">-&gt;</span>indent_capacity <span class="op">=</span> <span class="dv">32</span><span class="op">;</span></span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>    lexer<span class="op">-&gt;</span>indent_stack <span class="op">=</span> malloc<span class="op">(</span><span class="kw">sizeof</span><span class="op">(</span><span class="dt">int</span><span class="op">)</span> <span class="op">*</span> lexer<span class="op">-&gt;</span>indent_capacity<span class="op">);</span></span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>    lexer<span class="op">-&gt;</span>indent_stack<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span>  <span class="co">// Initial indent level</span></span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>    lexer<span class="op">-&gt;</span>indent_level <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Initialize token buffer</span></span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a>    lexer<span class="op">-&gt;</span>buffer_capacity <span class="op">=</span> <span class="dv">16</span><span class="op">;</span></span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a>    lexer<span class="op">-&gt;</span>token_buffer <span class="op">=</span> malloc<span class="op">(</span><span class="kw">sizeof</span><span class="op">(</span>Token<span class="op">)</span> <span class="op">*</span> lexer<span class="op">-&gt;</span>buffer_capacity<span class="op">);</span></span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a>    lexer<span class="op">-&gt;</span>buffer_size <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Initialize string intern table</span></span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a>    lexer<span class="op">-&gt;</span>strings <span class="op">=</span> string_table_new<span class="op">();</span></span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Initialize error list</span></span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a>    lexer<span class="op">-&gt;</span>errors <span class="op">=</span> error_list_new<span class="op">();</span></span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> lexer<span class="op">;</span></span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3>2.3.1 Character Navigation</h3>
<div class="sourceCode" id="cb15"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="kw">inline</span> <span class="dt">char</span> peek<span class="op">(</span>DyrLexer <span class="op">*</span>lexer<span class="op">)</span> <span class="op">{</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>lexer<span class="op">-&gt;</span>current <span class="op">&gt;=</span> lexer<span class="op">-&gt;</span>source_len<span class="op">)</span> <span class="op">{</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="ch">&#39;</span><span class="sc">\0</span><span class="ch">&#39;</span><span class="op">;</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> lexer<span class="op">-&gt;</span>source<span class="op">[</span>lexer<span class="op">-&gt;</span>current<span class="op">];</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="kw">inline</span> <span class="dt">char</span> peek_next<span class="op">(</span>DyrLexer <span class="op">*</span>lexer<span class="op">)</span> <span class="op">{</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>lexer<span class="op">-&gt;</span>current <span class="op">+</span> <span class="dv">1</span> <span class="op">&gt;=</span> lexer<span class="op">-&gt;</span>source_len<span class="op">)</span> <span class="op">{</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="ch">&#39;</span><span class="sc">\0</span><span class="ch">&#39;</span><span class="op">;</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> lexer<span class="op">-&gt;</span>source<span class="op">[</span>lexer<span class="op">-&gt;</span>current <span class="op">+</span> <span class="dv">1</span><span class="op">];</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="kw">inline</span> <span class="dt">char</span> advance<span class="op">(</span>DyrLexer <span class="op">*</span>lexer<span class="op">)</span> <span class="op">{</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>lexer<span class="op">-&gt;</span>current <span class="op">&gt;=</span> lexer<span class="op">-&gt;</span>source_len<span class="op">)</span> <span class="op">{</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="ch">&#39;</span><span class="sc">\0</span><span class="ch">&#39;</span><span class="op">;</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> ch <span class="op">=</span> lexer<span class="op">-&gt;</span>source<span class="op">[</span>lexer<span class="op">-&gt;</span>current<span class="op">++];</span></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>ch <span class="op">==</span> <span class="ch">&#39;</span><span class="sc">\n</span><span class="ch">&#39;</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>        lexer<span class="op">-&gt;</span>line<span class="op">++;</span></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>        lexer<span class="op">-&gt;</span>column <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>        lexer<span class="op">-&gt;</span>column<span class="op">++;</span></span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ch<span class="op">;</span></span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> skip_whitespace<span class="op">(</span>DyrLexer <span class="op">*</span>lexer<span class="op">)</span> <span class="op">{</span></span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>        <span class="dt">char</span> ch <span class="op">=</span> peek<span class="op">(</span>lexer<span class="op">);</span></span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>ch <span class="op">==</span> <span class="ch">&#39; &#39;</span> <span class="op">||</span> ch <span class="op">==</span> <span class="ch">&#39;</span><span class="sc">\t</span><span class="ch">&#39;</span> <span class="op">||</span> ch <span class="op">==</span> <span class="ch">&#39;</span><span class="sc">\r</span><span class="ch">&#39;</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>            advance<span class="op">(</span>lexer<span class="op">);</span></span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>ch <span class="op">==</span> <span class="ch">&#39;#&#39;</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Skip comment</span></span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>            <span class="cf">while</span> <span class="op">(</span>peek<span class="op">(</span>lexer<span class="op">)</span> <span class="op">!=</span> <span class="ch">&#39;</span><span class="sc">\n</span><span class="ch">&#39;</span> <span class="op">&amp;&amp;</span> peek<span class="op">(</span>lexer<span class="op">)</span> <span class="op">!=</span> <span class="ch">&#39;</span><span class="sc">\0</span><span class="ch">&#39;</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>                advance<span class="op">(</span>lexer<span class="op">);</span></span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span><span class="op">;</span></span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3>2.3.2 Number Lexing</h3>
<div class="sourceCode" id="cb16"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> Token lex_number<span class="op">(</span>DyrLexer <span class="op">*</span>lexer<span class="op">)</span> <span class="op">{</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    SourceLoc start_loc <span class="op">=</span> get_current_location<span class="op">(</span>lexer<span class="op">);</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> start <span class="op">=</span> lexer<span class="op">-&gt;</span>current<span class="op">;</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> is_float <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Handle different number formats</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>peek<span class="op">(</span>lexer<span class="op">)</span> <span class="op">==</span> <span class="ch">&#39;0&#39;</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>        advance<span class="op">(</span>lexer<span class="op">);</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>        <span class="dt">char</span> ch <span class="op">=</span> peek<span class="op">(</span>lexer<span class="op">);</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>ch <span class="op">==</span> <span class="ch">&#39;x&#39;</span> <span class="op">||</span> ch <span class="op">==</span> <span class="ch">&#39;X&#39;</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Hexadecimal</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>            advance<span class="op">(</span>lexer<span class="op">);</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>            <span class="cf">while</span> <span class="op">(</span>is_hex_digit<span class="op">(</span>peek<span class="op">(</span>lexer<span class="op">)))</span> <span class="op">{</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>                advance<span class="op">(</span>lexer<span class="op">);</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>ch <span class="op">==</span> <span class="ch">&#39;b&#39;</span> <span class="op">||</span> ch <span class="op">==</span> <span class="ch">&#39;B&#39;</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Binary</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>            advance<span class="op">(</span>lexer<span class="op">);</span></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>            <span class="cf">while</span> <span class="op">(</span>peek<span class="op">(</span>lexer<span class="op">)</span> <span class="op">==</span> <span class="ch">&#39;0&#39;</span> <span class="op">||</span> peek<span class="op">(</span>lexer<span class="op">)</span> <span class="op">==</span> <span class="ch">&#39;1&#39;</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>                advance<span class="op">(</span>lexer<span class="op">);</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>ch <span class="op">==</span> <span class="ch">&#39;o&#39;</span> <span class="op">||</span> ch <span class="op">==</span> <span class="ch">&#39;O&#39;</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Octal</span></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>            advance<span class="op">(</span>lexer<span class="op">);</span></span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>            <span class="cf">while</span> <span class="op">(</span>is_octal_digit<span class="op">(</span>peek<span class="op">(</span>lexer<span class="op">)))</span> <span class="op">{</span></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>                advance<span class="op">(</span>lexer<span class="op">);</span></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>is_digit<span class="op">(</span>ch<span class="op">))</span> <span class="op">{</span></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Legacy octal (error in Diyrbal)</span></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> make_error_token<span class="op">(</span>lexer<span class="op">,</span> <span class="st">&quot;Legacy octal literals not supported&quot;</span><span class="op">);</span></span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Decimal part</span></span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span>is_digit<span class="op">(</span>peek<span class="op">(</span>lexer<span class="op">)))</span> <span class="op">{</span></span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>        advance<span class="op">(</span>lexer<span class="op">);</span></span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Fractional part</span></span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>peek<span class="op">(</span>lexer<span class="op">)</span> <span class="op">==</span> <span class="ch">&#39;.&#39;</span> <span class="op">&amp;&amp;</span> is_digit<span class="op">(</span>peek_next<span class="op">(</span>lexer<span class="op">)))</span> <span class="op">{</span></span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a>        is_float <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a>        advance<span class="op">(</span>lexer<span class="op">);</span>  <span class="co">// Skip &#39;.&#39;</span></span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> <span class="op">(</span>is_digit<span class="op">(</span>peek<span class="op">(</span>lexer<span class="op">)))</span> <span class="op">{</span></span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a>            advance<span class="op">(</span>lexer<span class="op">);</span></span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Exponent part</span></span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>peek<span class="op">(</span>lexer<span class="op">)</span> <span class="op">==</span> <span class="ch">&#39;e&#39;</span> <span class="op">||</span> peek<span class="op">(</span>lexer<span class="op">)</span> <span class="op">==</span> <span class="ch">&#39;E&#39;</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a>        is_float <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a>        advance<span class="op">(</span>lexer<span class="op">);</span></span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>peek<span class="op">(</span>lexer<span class="op">)</span> <span class="op">==</span> <span class="ch">&#39;+&#39;</span> <span class="op">||</span> peek<span class="op">(</span>lexer<span class="op">)</span> <span class="op">==</span> <span class="ch">&#39;-&#39;</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a>            advance<span class="op">(</span>lexer<span class="op">);</span></span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb16-55"><a href="#cb16-55" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(!</span>is_digit<span class="op">(</span>peek<span class="op">(</span>lexer<span class="op">)))</span> <span class="op">{</span></span>
<span id="cb16-56"><a href="#cb16-56" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> make_error_token<span class="op">(</span>lexer<span class="op">,</span> <span class="st">&quot;Invalid number format&quot;</span><span class="op">);</span></span>
<span id="cb16-57"><a href="#cb16-57" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb16-58"><a href="#cb16-58" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> <span class="op">(</span>is_digit<span class="op">(</span>peek<span class="op">(</span>lexer<span class="op">)))</span> <span class="op">{</span></span>
<span id="cb16-59"><a href="#cb16-59" aria-hidden="true" tabindex="-1"></a>            advance<span class="op">(</span>lexer<span class="op">);</span></span>
<span id="cb16-60"><a href="#cb16-60" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb16-61"><a href="#cb16-61" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb16-62"><a href="#cb16-62" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-63"><a href="#cb16-63" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Create token</span></span>
<span id="cb16-64"><a href="#cb16-64" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> length <span class="op">=</span> lexer<span class="op">-&gt;</span>current <span class="op">-</span> start<span class="op">;</span></span>
<span id="cb16-65"><a href="#cb16-65" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span>text <span class="op">=</span> strndup<span class="op">(</span>lexer<span class="op">-&gt;</span>source <span class="op">+</span> start<span class="op">,</span> length<span class="op">);</span></span>
<span id="cb16-66"><a href="#cb16-66" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-67"><a href="#cb16-67" aria-hidden="true" tabindex="-1"></a>    Token token <span class="op">=</span> <span class="op">{</span></span>
<span id="cb16-68"><a href="#cb16-68" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>type <span class="op">=</span> is_float <span class="op">?</span> TOK_FLOAT <span class="op">:</span> TOK_INT<span class="op">,</span></span>
<span id="cb16-69"><a href="#cb16-69" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>text <span class="op">=</span> text<span class="op">,</span></span>
<span id="cb16-70"><a href="#cb16-70" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>length <span class="op">=</span> length<span class="op">,</span></span>
<span id="cb16-71"><a href="#cb16-71" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>location <span class="op">=</span> start_loc</span>
<span id="cb16-72"><a href="#cb16-72" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb16-73"><a href="#cb16-73" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-74"><a href="#cb16-74" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Parse value</span></span>
<span id="cb16-75"><a href="#cb16-75" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>is_float<span class="op">)</span> <span class="op">{</span></span>
<span id="cb16-76"><a href="#cb16-76" aria-hidden="true" tabindex="-1"></a>        token<span class="op">.</span>value<span class="op">.</span>float_value <span class="op">=</span> strtod<span class="op">(</span>text<span class="op">,</span> NULL<span class="op">);</span></span>
<span id="cb16-77"><a href="#cb16-77" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb16-78"><a href="#cb16-78" aria-hidden="true" tabindex="-1"></a>        token<span class="op">.</span>value<span class="op">.</span>int_value <span class="op">=</span> parse_integer<span class="op">(</span>text<span class="op">);</span></span>
<span id="cb16-79"><a href="#cb16-79" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb16-80"><a href="#cb16-80" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-81"><a href="#cb16-81" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> token<span class="op">;</span></span>
<span id="cb16-82"><a href="#cb16-82" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3>2.3.3 String Lexing</h3>
<div class="sourceCode" id="cb17"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> Token lex_string<span class="op">(</span>DyrLexer <span class="op">*</span>lexer<span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    SourceLoc start_loc <span class="op">=</span> get_current_location<span class="op">(</span>lexer<span class="op">);</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> quote <span class="op">=</span> advance<span class="op">(</span>lexer<span class="op">);</span>  <span class="co">// &#39; or &quot;</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check for triple quotes</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> triple <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>peek<span class="op">(</span>lexer<span class="op">)</span> <span class="op">==</span> quote <span class="op">&amp;&amp;</span> peek_next<span class="op">(</span>lexer<span class="op">)</span> <span class="op">==</span> quote<span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>        triple <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>        advance<span class="op">(</span>lexer<span class="op">);</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>        advance<span class="op">(</span>lexer<span class="op">);</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// String buffer</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span>buffer <span class="op">=</span> malloc<span class="op">(</span><span class="dv">256</span><span class="op">);</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> capacity <span class="op">=</span> <span class="dv">256</span><span class="op">;</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> length <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>        <span class="dt">char</span> ch <span class="op">=</span> peek<span class="op">(</span>lexer<span class="op">);</span></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>ch <span class="op">==</span> <span class="ch">&#39;</span><span class="sc">\0</span><span class="ch">&#39;</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>            free<span class="op">(</span>buffer<span class="op">);</span></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> make_error_token<span class="op">(</span>lexer<span class="op">,</span> <span class="st">&quot;Unterminated string literal&quot;</span><span class="op">);</span></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(!</span>triple <span class="op">&amp;&amp;</span> ch <span class="op">==</span> <span class="ch">&#39;</span><span class="sc">\n</span><span class="ch">&#39;</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>            free<span class="op">(</span>buffer<span class="op">);</span></span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> make_error_token<span class="op">(</span>lexer<span class="op">,</span> <span class="st">&quot;Unterminated string literal&quot;</span><span class="op">);</span></span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>ch <span class="op">==</span> quote<span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>triple<span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span>peek_next<span class="op">(</span>lexer<span class="op">)</span> <span class="op">==</span> quote <span class="op">&amp;&amp;</span> </span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>                    lexer<span class="op">-&gt;</span>current <span class="op">+</span> <span class="dv">2</span> <span class="op">&lt;</span> lexer<span class="op">-&gt;</span>source_len <span class="op">&amp;&amp;</span></span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>                    lexer<span class="op">-&gt;</span>source<span class="op">[</span>lexer<span class="op">-&gt;</span>current <span class="op">+</span> <span class="dv">2</span><span class="op">]</span> <span class="op">==</span> quote<span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>                    advance<span class="op">(</span>lexer<span class="op">);</span></span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>                    advance<span class="op">(</span>lexer<span class="op">);</span></span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>                    advance<span class="op">(</span>lexer<span class="op">);</span></span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">break</span><span class="op">;</span></span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a>                advance<span class="op">(</span>lexer<span class="op">);</span></span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>ch <span class="op">==</span> <span class="ch">&#39;</span><span class="sc">\\</span><span class="ch">&#39;</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-48"><a href="#cb17-48" aria-hidden="true" tabindex="-1"></a>            advance<span class="op">(</span>lexer<span class="op">);</span></span>
<span id="cb17-49"><a href="#cb17-49" aria-hidden="true" tabindex="-1"></a>            ch <span class="op">=</span> advance<span class="op">(</span>lexer<span class="op">);</span></span>
<span id="cb17-50"><a href="#cb17-50" aria-hidden="true" tabindex="-1"></a>            ch <span class="op">=</span> parse_escape_sequence<span class="op">(</span>ch<span class="op">,</span> lexer<span class="op">);</span></span>
<span id="cb17-51"><a href="#cb17-51" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb17-52"><a href="#cb17-52" aria-hidden="true" tabindex="-1"></a>            advance<span class="op">(</span>lexer<span class="op">);</span></span>
<span id="cb17-53"><a href="#cb17-53" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb17-54"><a href="#cb17-54" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb17-55"><a href="#cb17-55" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Grow buffer if needed</span></span>
<span id="cb17-56"><a href="#cb17-56" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>length <span class="op">&gt;=</span> capacity <span class="op">-</span> <span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-57"><a href="#cb17-57" aria-hidden="true" tabindex="-1"></a>            capacity <span class="op">*=</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb17-58"><a href="#cb17-58" aria-hidden="true" tabindex="-1"></a>            buffer <span class="op">=</span> realloc<span class="op">(</span>buffer<span class="op">,</span> capacity<span class="op">);</span></span>
<span id="cb17-59"><a href="#cb17-59" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb17-60"><a href="#cb17-60" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb17-61"><a href="#cb17-61" aria-hidden="true" tabindex="-1"></a>        buffer<span class="op">[</span>length<span class="op">++]</span> <span class="op">=</span> ch<span class="op">;</span></span>
<span id="cb17-62"><a href="#cb17-62" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb17-63"><a href="#cb17-63" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-64"><a href="#cb17-64" aria-hidden="true" tabindex="-1"></a>    buffer<span class="op">[</span>length<span class="op">]</span> <span class="op">=</span> <span class="ch">&#39;</span><span class="sc">\0</span><span class="ch">&#39;</span><span class="op">;</span></span>
<span id="cb17-65"><a href="#cb17-65" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-66"><a href="#cb17-66" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Intern string</span></span>
<span id="cb17-67"><a href="#cb17-67" aria-hidden="true" tabindex="-1"></a>    <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>interned <span class="op">=</span> string_table_intern<span class="op">(</span>lexer<span class="op">-&gt;</span>strings<span class="op">,</span> buffer<span class="op">,</span> length<span class="op">);</span></span>
<span id="cb17-68"><a href="#cb17-68" aria-hidden="true" tabindex="-1"></a>    free<span class="op">(</span>buffer<span class="op">);</span></span>
<span id="cb17-69"><a href="#cb17-69" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-70"><a href="#cb17-70" aria-hidden="true" tabindex="-1"></a>    Token token <span class="op">=</span> <span class="op">{</span></span>
<span id="cb17-71"><a href="#cb17-71" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>type <span class="op">=</span> TOK_STRING<span class="op">,</span></span>
<span id="cb17-72"><a href="#cb17-72" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>text <span class="op">=</span> quote <span class="op">==</span> <span class="ch">&#39;&quot;&#39;</span> <span class="op">?</span> <span class="st">&quot;</span><span class="sc">\&quot;</span><span class="st">string</span><span class="sc">\&quot;</span><span class="st">&quot;</span> <span class="op">:</span> <span class="st">&quot;&#39;string&#39;&quot;</span><span class="op">,</span></span>
<span id="cb17-73"><a href="#cb17-73" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>length <span class="op">=</span> length<span class="op">,</span></span>
<span id="cb17-74"><a href="#cb17-74" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>location <span class="op">=</span> start_loc<span class="op">,</span></span>
<span id="cb17-75"><a href="#cb17-75" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>value<span class="op">.</span>string_value <span class="op">=</span> <span class="op">(</span><span class="dt">char</span><span class="op">*)</span>interned</span>
<span id="cb17-76"><a href="#cb17-76" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb17-77"><a href="#cb17-77" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-78"><a href="#cb17-78" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> token<span class="op">;</span></span>
<span id="cb17-79"><a href="#cb17-79" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3>2.3.4 Identifier and Keyword Lexing</h3>
<div class="sourceCode" id="cb18"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> Token lex_identifier<span class="op">(</span>DyrLexer <span class="op">*</span>lexer<span class="op">)</span> <span class="op">{</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    SourceLoc start_loc <span class="op">=</span> get_current_location<span class="op">(</span>lexer<span class="op">);</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> start <span class="op">=</span> lexer<span class="op">-&gt;</span>current<span class="op">;</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// First character already verified to be valid</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span>is_ident_char<span class="op">(</span>peek<span class="op">(</span>lexer<span class="op">)))</span> <span class="op">{</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>        advance<span class="op">(</span>lexer<span class="op">);</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> length <span class="op">=</span> lexer<span class="op">-&gt;</span>current <span class="op">-</span> start<span class="op">;</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span>text <span class="op">=</span> strndup<span class="op">(</span>lexer<span class="op">-&gt;</span>source <span class="op">+</span> start<span class="op">,</span> length<span class="op">);</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check if it&#39;s a keyword</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    TokenType type <span class="op">=</span> TOK_IDENT<span class="op">;</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> keyword_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>strcmp<span class="op">(</span>text<span class="op">,</span> keywords<span class="op">[</span>i<span class="op">].</span>text<span class="op">)</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>            type <span class="op">=</span> keywords<span class="op">[</span>i<span class="op">].</span>type<span class="op">;</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span><span class="op">;</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>    Token token <span class="op">=</span> <span class="op">{</span></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>type <span class="op">=</span> type<span class="op">,</span></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>text <span class="op">=</span> text<span class="op">,</span></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>length <span class="op">=</span> length<span class="op">,</span></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>location <span class="op">=</span> start_loc</span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> token<span class="op">;</span></span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>    <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>text<span class="op">;</span></span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>    TokenType type<span class="op">;</span></span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> keywords<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span><span class="st">&quot;def&quot;</span><span class="op">,</span> TOK_DEF<span class="op">},</span></span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span><span class="st">&quot;if&quot;</span><span class="op">,</span> TOK_IF<span class="op">},</span></span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span><span class="st">&quot;else&quot;</span><span class="op">,</span> TOK_ELSE<span class="op">},</span></span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span><span class="st">&quot;elif&quot;</span><span class="op">,</span> TOK_ELIF<span class="op">},</span></span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span><span class="st">&quot;while&quot;</span><span class="op">,</span> TOK_WHILE<span class="op">},</span></span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span><span class="st">&quot;for&quot;</span><span class="op">,</span> TOK_FOR<span class="op">},</span></span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span><span class="st">&quot;in&quot;</span><span class="op">,</span> TOK_IN<span class="op">},</span></span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span><span class="st">&quot;return&quot;</span><span class="op">,</span> TOK_RETURN<span class="op">},</span></span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span><span class="st">&quot;break&quot;</span><span class="op">,</span> TOK_BREAK<span class="op">},</span></span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span><span class="st">&quot;continue&quot;</span><span class="op">,</span> TOK_CONTINUE<span class="op">},</span></span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span><span class="st">&quot;class&quot;</span><span class="op">,</span> TOK_CLASS<span class="op">},</span></span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span><span class="st">&quot;import&quot;</span><span class="op">,</span> TOK_IMPORT<span class="op">},</span></span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span><span class="st">&quot;from&quot;</span><span class="op">,</span> TOK_FROM<span class="op">},</span></span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span><span class="st">&quot;as&quot;</span><span class="op">,</span> TOK_AS<span class="op">},</span></span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span><span class="st">&quot;try&quot;</span><span class="op">,</span> TOK_TRY<span class="op">},</span></span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span><span class="st">&quot;except&quot;</span><span class="op">,</span> TOK_EXCEPT<span class="op">},</span></span>
<span id="cb18-52"><a href="#cb18-52" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span><span class="st">&quot;finally&quot;</span><span class="op">,</span> TOK_FINALLY<span class="op">},</span></span>
<span id="cb18-53"><a href="#cb18-53" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span><span class="st">&quot;raise&quot;</span><span class="op">,</span> TOK_RAISE<span class="op">},</span></span>
<span id="cb18-54"><a href="#cb18-54" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span><span class="st">&quot;lambda&quot;</span><span class="op">,</span> TOK_LAMBDA<span class="op">},</span></span>
<span id="cb18-55"><a href="#cb18-55" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span><span class="st">&quot;yield&quot;</span><span class="op">,</span> TOK_YIELD<span class="op">},</span></span>
<span id="cb18-56"><a href="#cb18-56" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span><span class="st">&quot;assert&quot;</span><span class="op">,</span> TOK_ASSERT<span class="op">},</span></span>
<span id="cb18-57"><a href="#cb18-57" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span><span class="st">&quot;True&quot;</span><span class="op">,</span> TOK_TRUE<span class="op">},</span></span>
<span id="cb18-58"><a href="#cb18-58" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span><span class="st">&quot;False&quot;</span><span class="op">,</span> TOK_FALSE<span class="op">},</span></span>
<span id="cb18-59"><a href="#cb18-59" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span><span class="st">&quot;None&quot;</span><span class="op">,</span> TOK_NULL<span class="op">},</span></span>
<span id="cb18-60"><a href="#cb18-60" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span><span class="st">&quot;and&quot;</span><span class="op">,</span> TOK_AND<span class="op">},</span></span>
<span id="cb18-61"><a href="#cb18-61" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span><span class="st">&quot;or&quot;</span><span class="op">,</span> TOK_OR<span class="op">},</span></span>
<span id="cb18-62"><a href="#cb18-62" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span><span class="st">&quot;not&quot;</span><span class="op">,</span> TOK_NOT<span class="op">},</span></span>
<span id="cb18-63"><a href="#cb18-63" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span><span class="st">&quot;global&quot;</span><span class="op">,</span> TOK_GLOBAL<span class="op">},</span></span>
<span id="cb18-64"><a href="#cb18-64" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span><span class="st">&quot;nonlocal&quot;</span><span class="op">,</span> TOK_NONLOCAL<span class="op">}</span></span>
<span id="cb18-65"><a href="#cb18-65" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb18-66"><a href="#cb18-66" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> <span class="dt">size_t</span> keyword_count <span class="op">=</span> <span class="kw">sizeof</span><span class="op">(</span>keywords<span class="op">)</span> <span class="op">/</span> <span class="kw">sizeof</span><span class="op">(</span>keywords<span class="op">[</span><span class="dv">0</span><span class="op">]);</span></span></code></pre></div>
<h3>2.3.5 Indentation Handling</h3>
<p>Python-style indentation is crucial for Diyrbal:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> handle_indentation<span class="op">(</span>DyrLexer <span class="op">*</span>lexer<span class="op">)</span> <span class="op">{</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>lexer<span class="op">-&gt;</span>column <span class="op">!=</span> <span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span><span class="op">;</span>  <span class="co">// Not at start of line</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> indent <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span>peek<span class="op">(</span>lexer<span class="op">)</span> <span class="op">==</span> <span class="ch">&#39; &#39;</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>        advance<span class="op">(</span>lexer<span class="op">);</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>        indent<span class="op">++;</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>peek<span class="op">(</span>lexer<span class="op">)</span> <span class="op">==</span> <span class="ch">&#39;</span><span class="sc">\t</span><span class="ch">&#39;</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>        error<span class="op">(</span>lexer<span class="op">,</span> <span class="st">&quot;Tabs not allowed for indentation&quot;</span><span class="op">);</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span><span class="op">;</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>peek<span class="op">(</span>lexer<span class="op">)</span> <span class="op">==</span> <span class="ch">&#39;</span><span class="sc">\n</span><span class="ch">&#39;</span> <span class="op">||</span> peek<span class="op">(</span>lexer<span class="op">)</span> <span class="op">==</span> <span class="ch">&#39;#&#39;</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span><span class="op">;</span>  <span class="co">// Blank line or comment-only line</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> current_indent <span class="op">=</span> lexer<span class="op">-&gt;</span>indent_stack<span class="op">[</span>lexer<span class="op">-&gt;</span>indent_level <span class="op">-</span> <span class="dv">1</span><span class="op">];</span></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>indent <span class="op">&gt;</span> current_indent<span class="op">)</span> <span class="op">{</span></span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Indent</span></span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>lexer<span class="op">-&gt;</span>indent_level <span class="op">&gt;=</span> lexer<span class="op">-&gt;</span>indent_capacity<span class="op">)</span> <span class="op">{</span></span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>            lexer<span class="op">-&gt;</span>indent_capacity <span class="op">*=</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>            lexer<span class="op">-&gt;</span>indent_stack <span class="op">=</span> realloc<span class="op">(</span>lexer<span class="op">-&gt;</span>indent_stack<span class="op">,</span></span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>                <span class="kw">sizeof</span><span class="op">(</span><span class="dt">int</span><span class="op">)</span> <span class="op">*</span> lexer<span class="op">-&gt;</span>indent_capacity<span class="op">);</span></span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>        lexer<span class="op">-&gt;</span>indent_stack<span class="op">[</span>lexer<span class="op">-&gt;</span>indent_level<span class="op">++]</span> <span class="op">=</span> indent<span class="op">;</span></span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>        add_token<span class="op">(</span>lexer<span class="op">,</span> TOK_INDENT<span class="op">);</span></span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>indent <span class="op">&lt;</span> current_indent<span class="op">)</span> <span class="op">{</span></span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Dedent (possibly multiple levels)</span></span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> <span class="op">(</span>lexer<span class="op">-&gt;</span>indent_level <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">&amp;&amp;</span> </span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>               lexer<span class="op">-&gt;</span>indent_stack<span class="op">[</span>lexer<span class="op">-&gt;</span>indent_level <span class="op">-</span> <span class="dv">1</span><span class="op">]</span> <span class="op">&gt;</span> indent<span class="op">)</span> <span class="op">{</span></span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>            lexer<span class="op">-&gt;</span>indent_level<span class="op">--;</span></span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>            add_token<span class="op">(</span>lexer<span class="op">,</span> TOK_DEDENT<span class="op">);</span></span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>lexer<span class="op">-&gt;</span>indent_stack<span class="op">[</span>lexer<span class="op">-&gt;</span>indent_level <span class="op">-</span> <span class="dv">1</span><span class="op">]</span> <span class="op">!=</span> indent<span class="op">)</span> <span class="op">{</span></span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>            error<span class="op">(</span>lexer<span class="op">,</span> <span class="st">&quot;Inconsistent indentation&quot;</span><span class="op">);</span></span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3>2.3.6 Main Lexing Loop</h3>
<div class="sourceCode" id="cb20"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>Token dyr_lexer_next_token<span class="op">(</span>DyrLexer <span class="op">*</span>lexer<span class="op">)</span> <span class="op">{</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check token buffer first</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>lexer<span class="op">-&gt;</span>buffer_size <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> lexer<span class="op">-&gt;</span>token_buffer<span class="op">[--</span>lexer<span class="op">-&gt;</span>buffer_size<span class="op">];</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    skip_whitespace<span class="op">(</span>lexer<span class="op">);</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Handle indentation at start of line</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    handle_indentation<span class="op">(</span>lexer<span class="op">);</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>    SourceLoc start_loc <span class="op">=</span> get_current_location<span class="op">(</span>lexer<span class="op">);</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> ch <span class="op">=</span> peek<span class="op">(</span>lexer<span class="op">);</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">// End of file</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>ch <span class="op">==</span> <span class="ch">&#39;</span><span class="sc">\0</span><span class="ch">&#39;</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Emit remaining dedents</span></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> <span class="op">(</span>lexer<span class="op">-&gt;</span>indent_level <span class="op">&gt;</span> <span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>            lexer<span class="op">-&gt;</span>indent_level<span class="op">--;</span></span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>            add_token<span class="op">(</span>lexer<span class="op">,</span> TOK_DEDENT<span class="op">);</span></span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> make_token<span class="op">(</span>TOK_EOF<span class="op">,</span> <span class="st">&quot;&quot;</span><span class="op">,</span> start_loc<span class="op">);</span></span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Newline</span></span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>ch <span class="op">==</span> <span class="ch">&#39;</span><span class="sc">\n</span><span class="ch">&#39;</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>        advance<span class="op">(</span>lexer<span class="op">);</span></span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> make_token<span class="op">(</span>TOK_NEWLINE<span class="op">,</span> <span class="st">&quot;</span><span class="sc">\\</span><span class="st">n&quot;</span><span class="op">,</span> start_loc<span class="op">);</span></span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Numbers</span></span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>is_digit<span class="op">(</span>ch<span class="op">))</span> <span class="op">{</span></span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> lex_number<span class="op">(</span>lexer<span class="op">);</span></span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Strings</span></span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>ch <span class="op">==</span> <span class="ch">&#39;&quot;&#39;</span> <span class="op">||</span> ch <span class="op">==</span> <span class="ch">&#39;</span><span class="sc">\&#39;</span><span class="ch">&#39;</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> lex_string<span class="op">(</span>lexer<span class="op">);</span></span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Identifiers</span></span>
<span id="cb20-42"><a href="#cb20-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>is_ident_start<span class="op">(</span>ch<span class="op">))</span> <span class="op">{</span></span>
<span id="cb20-43"><a href="#cb20-43" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> lex_identifier<span class="op">(</span>lexer<span class="op">);</span></span>
<span id="cb20-44"><a href="#cb20-44" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb20-45"><a href="#cb20-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-46"><a href="#cb20-46" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Operators and punctuation</span></span>
<span id="cb20-47"><a href="#cb20-47" aria-hidden="true" tabindex="-1"></a>    advance<span class="op">(</span>lexer<span class="op">);</span></span>
<span id="cb20-48"><a href="#cb20-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> <span class="op">(</span>ch<span class="op">)</span> <span class="op">{</span></span>
<span id="cb20-49"><a href="#cb20-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="ch">&#39;+&#39;</span><span class="op">:</span></span>
<span id="cb20-50"><a href="#cb20-50" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>peek<span class="op">(</span>lexer<span class="op">)</span> <span class="op">==</span> <span class="ch">&#39;=&#39;</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb20-51"><a href="#cb20-51" aria-hidden="true" tabindex="-1"></a>                advance<span class="op">(</span>lexer<span class="op">);</span></span>
<span id="cb20-52"><a href="#cb20-52" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> make_token<span class="op">(</span>TOK_PLUS_ASSIGN<span class="op">,</span> <span class="st">&quot;+=&quot;</span><span class="op">,</span> start_loc<span class="op">);</span></span>
<span id="cb20-53"><a href="#cb20-53" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb20-54"><a href="#cb20-54" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> make_token<span class="op">(</span>TOK_PLUS<span class="op">,</span> <span class="st">&quot;+&quot;</span><span class="op">,</span> start_loc<span class="op">);</span></span>
<span id="cb20-55"><a href="#cb20-55" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb20-56"><a href="#cb20-56" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="ch">&#39;-&#39;</span><span class="op">:</span></span>
<span id="cb20-57"><a href="#cb20-57" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>peek<span class="op">(</span>lexer<span class="op">)</span> <span class="op">==</span> <span class="ch">&#39;=&#39;</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb20-58"><a href="#cb20-58" aria-hidden="true" tabindex="-1"></a>                advance<span class="op">(</span>lexer<span class="op">);</span></span>
<span id="cb20-59"><a href="#cb20-59" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> make_token<span class="op">(</span>TOK_MINUS_ASSIGN<span class="op">,</span> <span class="st">&quot;-=&quot;</span><span class="op">,</span> start_loc<span class="op">);</span></span>
<span id="cb20-60"><a href="#cb20-60" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>peek<span class="op">(</span>lexer<span class="op">)</span> <span class="op">==</span> <span class="ch">&#39;&gt;&#39;</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb20-61"><a href="#cb20-61" aria-hidden="true" tabindex="-1"></a>                advance<span class="op">(</span>lexer<span class="op">);</span></span>
<span id="cb20-62"><a href="#cb20-62" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> make_token<span class="op">(</span>TOK_ARROW<span class="op">,</span> <span class="st">&quot;-&gt;&quot;</span><span class="op">,</span> start_loc<span class="op">);</span></span>
<span id="cb20-63"><a href="#cb20-63" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb20-64"><a href="#cb20-64" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> make_token<span class="op">(</span>TOK_MINUS<span class="op">,</span> <span class="st">&quot;-&quot;</span><span class="op">,</span> start_loc<span class="op">);</span></span>
<span id="cb20-65"><a href="#cb20-65" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb20-66"><a href="#cb20-66" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="ch">&#39;*&#39;</span><span class="op">:</span></span>
<span id="cb20-67"><a href="#cb20-67" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>peek<span class="op">(</span>lexer<span class="op">)</span> <span class="op">==</span> <span class="ch">&#39;=&#39;</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb20-68"><a href="#cb20-68" aria-hidden="true" tabindex="-1"></a>                advance<span class="op">(</span>lexer<span class="op">);</span></span>
<span id="cb20-69"><a href="#cb20-69" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> make_token<span class="op">(</span>TOK_STAR_ASSIGN<span class="op">,</span> <span class="st">&quot;*=&quot;</span><span class="op">,</span> start_loc<span class="op">);</span></span>
<span id="cb20-70"><a href="#cb20-70" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>peek<span class="op">(</span>lexer<span class="op">)</span> <span class="op">==</span> <span class="ch">&#39;*&#39;</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb20-71"><a href="#cb20-71" aria-hidden="true" tabindex="-1"></a>                advance<span class="op">(</span>lexer<span class="op">);</span></span>
<span id="cb20-72"><a href="#cb20-72" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span>peek<span class="op">(</span>lexer<span class="op">)</span> <span class="op">==</span> <span class="ch">&#39;=&#39;</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb20-73"><a href="#cb20-73" aria-hidden="true" tabindex="-1"></a>                    advance<span class="op">(</span>lexer<span class="op">);</span></span>
<span id="cb20-74"><a href="#cb20-74" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">return</span> make_token<span class="op">(</span>TOK_POWER_ASSIGN<span class="op">,</span> <span class="st">&quot;**=&quot;</span><span class="op">,</span> start_loc<span class="op">);</span></span>
<span id="cb20-75"><a href="#cb20-75" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb20-76"><a href="#cb20-76" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> make_token<span class="op">(</span>TOK_POWER<span class="op">,</span> <span class="st">&quot;**&quot;</span><span class="op">,</span> start_loc<span class="op">);</span></span>
<span id="cb20-77"><a href="#cb20-77" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb20-78"><a href="#cb20-78" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> make_token<span class="op">(</span>TOK_STAR<span class="op">,</span> <span class="st">&quot;*&quot;</span><span class="op">,</span> start_loc<span class="op">);</span></span>
<span id="cb20-79"><a href="#cb20-79" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb20-80"><a href="#cb20-80" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="ch">&#39;/&#39;</span><span class="op">:</span></span>
<span id="cb20-81"><a href="#cb20-81" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>peek<span class="op">(</span>lexer<span class="op">)</span> <span class="op">==</span> <span class="ch">&#39;=&#39;</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb20-82"><a href="#cb20-82" aria-hidden="true" tabindex="-1"></a>                advance<span class="op">(</span>lexer<span class="op">);</span></span>
<span id="cb20-83"><a href="#cb20-83" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> make_token<span class="op">(</span>TOK_SLASH_ASSIGN<span class="op">,</span> <span class="st">&quot;/=&quot;</span><span class="op">,</span> start_loc<span class="op">);</span></span>
<span id="cb20-84"><a href="#cb20-84" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>peek<span class="op">(</span>lexer<span class="op">)</span> <span class="op">==</span> <span class="ch">&#39;/&#39;</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb20-85"><a href="#cb20-85" aria-hidden="true" tabindex="-1"></a>                advance<span class="op">(</span>lexer<span class="op">);</span></span>
<span id="cb20-86"><a href="#cb20-86" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span>peek<span class="op">(</span>lexer<span class="op">)</span> <span class="op">==</span> <span class="ch">&#39;=&#39;</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb20-87"><a href="#cb20-87" aria-hidden="true" tabindex="-1"></a>                    advance<span class="op">(</span>lexer<span class="op">);</span></span>
<span id="cb20-88"><a href="#cb20-88" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">return</span> make_token<span class="op">(</span>TOK_FLOOR_ASSIGN<span class="op">,</span> <span class="st">&quot;//=&quot;</span><span class="op">,</span> start_loc<span class="op">);</span></span>
<span id="cb20-89"><a href="#cb20-89" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb20-90"><a href="#cb20-90" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> make_token<span class="op">(</span>TOK_FLOOR_DIV<span class="op">,</span> <span class="st">&quot;//&quot;</span><span class="op">,</span> start_loc<span class="op">);</span></span>
<span id="cb20-91"><a href="#cb20-91" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb20-92"><a href="#cb20-92" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> make_token<span class="op">(</span>TOK_SLASH<span class="op">,</span> <span class="st">&quot;/&quot;</span><span class="op">,</span> start_loc<span class="op">);</span></span>
<span id="cb20-93"><a href="#cb20-93" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb20-94"><a href="#cb20-94" aria-hidden="true" tabindex="-1"></a>        <span class="co">// ... more operators ...</span></span>
<span id="cb20-95"><a href="#cb20-95" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb20-96"><a href="#cb20-96" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="ch">&#39;(&#39;</span><span class="op">:</span> <span class="cf">return</span> make_token<span class="op">(</span>TOK_LPAREN<span class="op">,</span> <span class="st">&quot;(&quot;</span><span class="op">,</span> start_loc<span class="op">);</span></span>
<span id="cb20-97"><a href="#cb20-97" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="ch">&#39;)&#39;</span><span class="op">:</span> <span class="cf">return</span> make_token<span class="op">(</span>TOK_RPAREN<span class="op">,</span> <span class="st">&quot;)&quot;</span><span class="op">,</span> start_loc<span class="op">);</span></span>
<span id="cb20-98"><a href="#cb20-98" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="ch">&#39;[&#39;</span><span class="op">:</span> <span class="cf">return</span> make_token<span class="op">(</span>TOK_LBRACKET<span class="op">,</span> <span class="st">&quot;[&quot;</span><span class="op">,</span> start_loc<span class="op">);</span></span>
<span id="cb20-99"><a href="#cb20-99" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="ch">&#39;]&#39;</span><span class="op">:</span> <span class="cf">return</span> make_token<span class="op">(</span>TOK_RBRACKET<span class="op">,</span> <span class="st">&quot;]&quot;</span><span class="op">,</span> start_loc<span class="op">);</span></span>
<span id="cb20-100"><a href="#cb20-100" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="ch">&#39;{&#39;</span><span class="op">:</span> <span class="cf">return</span> make_token<span class="op">(</span>TOK_LBRACE<span class="op">,</span> <span class="st">&quot;{&quot;</span><span class="op">,</span> start_loc<span class="op">);</span></span>
<span id="cb20-101"><a href="#cb20-101" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="ch">&#39;}&#39;</span><span class="op">:</span> <span class="cf">return</span> make_token<span class="op">(</span>TOK_RBRACE<span class="op">,</span> <span class="st">&quot;}&quot;</span><span class="op">,</span> start_loc<span class="op">);</span></span>
<span id="cb20-102"><a href="#cb20-102" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="ch">&#39;,&#39;</span><span class="op">:</span> <span class="cf">return</span> make_token<span class="op">(</span>TOK_COMMA<span class="op">,</span> <span class="st">&quot;,&quot;</span><span class="op">,</span> start_loc<span class="op">);</span></span>
<span id="cb20-103"><a href="#cb20-103" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="ch">&#39;.&#39;</span><span class="op">:</span> <span class="cf">return</span> make_token<span class="op">(</span>TOK_DOT<span class="op">,</span> <span class="st">&quot;.&quot;</span><span class="op">,</span> start_loc<span class="op">);</span></span>
<span id="cb20-104"><a href="#cb20-104" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="ch">&#39;:&#39;</span><span class="op">:</span> <span class="cf">return</span> make_token<span class="op">(</span>TOK_COLON<span class="op">,</span> <span class="st">&quot;:&quot;</span><span class="op">,</span> start_loc<span class="op">);</span></span>
<span id="cb20-105"><a href="#cb20-105" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="ch">&#39;;&#39;</span><span class="op">:</span> <span class="cf">return</span> make_token<span class="op">(</span>TOK_SEMICOLON<span class="op">,</span> <span class="st">&quot;;&quot;</span><span class="op">,</span> start_loc<span class="op">);</span></span>
<span id="cb20-106"><a href="#cb20-106" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb20-107"><a href="#cb20-107" aria-hidden="true" tabindex="-1"></a>        <span class="cf">default</span><span class="op">:</span></span>
<span id="cb20-108"><a href="#cb20-108" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> make_error_token<span class="op">(</span>lexer<span class="op">,</span> <span class="st">&quot;Unexpected character&quot;</span><span class="op">);</span></span>
<span id="cb20-109"><a href="#cb20-109" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb20-110"><a href="#cb20-110" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>2.4 Parser Implementation</h2>
<p>The parser uses recursive descent to build an AST from the token
stream:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    DyrLexer   <span class="op">*</span>lexer<span class="op">;</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    Token       current<span class="op">;</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    Token       previous<span class="op">;</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    ErrorList  <span class="op">*</span>errors<span class="op">;</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span>        panic_mode<span class="op">;</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span>        had_error<span class="op">;</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// For better error messages</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>current_function<span class="op">;</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span>         loop_depth<span class="op">;</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> DyrParser<span class="op">;</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>DyrParser<span class="op">*</span> dyr_parser_new<span class="op">(</span>DyrLexer <span class="op">*</span>lexer<span class="op">)</span> <span class="op">{</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>    DyrParser <span class="op">*</span>parser <span class="op">=</span> calloc<span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>DyrParser<span class="op">));</span></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>    parser<span class="op">-&gt;</span>lexer <span class="op">=</span> lexer<span class="op">;</span></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>    parser<span class="op">-&gt;</span>errors <span class="op">=</span> error_list_new<span class="op">();</span></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>    parser<span class="op">-&gt;</span>current <span class="op">=</span> dyr_lexer_next_token<span class="op">(</span>lexer<span class="op">);</span></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> parser<span class="op">;</span></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3>2.4.1 AST Node Definitions</h3>
<div class="sourceCode" id="cb22"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">enum</span> <span class="op">{</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Literals</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    AST_INT_LITERAL<span class="op">,</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    AST_FLOAT_LITERAL<span class="op">,</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    AST_STRING_LITERAL<span class="op">,</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    AST_BOOL_LITERAL<span class="op">,</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    AST_NULL_LITERAL<span class="op">,</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Expressions</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>    AST_IDENTIFIER<span class="op">,</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>    AST_BINARY_OP<span class="op">,</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>    AST_UNARY_OP<span class="op">,</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>    AST_CALL<span class="op">,</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>    AST_INDEX<span class="op">,</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>    AST_MEMBER<span class="op">,</span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>    AST_ARRAY_LITERAL<span class="op">,</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>    AST_DICT_LITERAL<span class="op">,</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>    AST_LAMBDA<span class="op">,</span></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Statements</span></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>    AST_ASSIGN<span class="op">,</span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>    AST_AUG_ASSIGN<span class="op">,</span></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>    AST_IF<span class="op">,</span></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>    AST_WHILE<span class="op">,</span></span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>    AST_FOR<span class="op">,</span></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>    AST_BREAK<span class="op">,</span></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>    AST_CONTINUE<span class="op">,</span></span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>    AST_RETURN<span class="op">,</span></span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>    AST_YIELD<span class="op">,</span></span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>    AST_RAISE<span class="op">,</span></span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>    AST_TRY<span class="op">,</span></span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>    AST_IMPORT<span class="op">,</span></span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>    AST_EXPR_STMT<span class="op">,</span></span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Declarations</span></span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a>    AST_FUNCTION<span class="op">,</span></span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a>    AST_CLASS<span class="op">,</span></span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a>    AST_VAR_DECL<span class="op">,</span></span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Other</span></span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a>    AST_BLOCK<span class="op">,</span></span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a>    AST_PROGRAM<span class="op">,</span></span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a>    AST_PARAMETER</span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> ASTNodeType<span class="op">;</span></span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> ASTNode <span class="op">{</span></span>
<span id="cb22-47"><a href="#cb22-47" aria-hidden="true" tabindex="-1"></a>    ASTNodeType   type<span class="op">;</span></span>
<span id="cb22-48"><a href="#cb22-48" aria-hidden="true" tabindex="-1"></a>    SourceLoc     location<span class="op">;</span></span>
<span id="cb22-49"><a href="#cb22-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-50"><a href="#cb22-50" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Type information (filled during semantic analysis)</span></span>
<span id="cb22-51"><a href="#cb22-51" aria-hidden="true" tabindex="-1"></a>    Type         <span class="op">*</span>expr_type<span class="op">;</span></span>
<span id="cb22-52"><a href="#cb22-52" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-53"><a href="#cb22-53" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Node-specific data</span></span>
<span id="cb22-54"><a href="#cb22-54" aria-hidden="true" tabindex="-1"></a>    <span class="kw">union</span> <span class="op">{</span></span>
<span id="cb22-55"><a href="#cb22-55" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Literals</span></span>
<span id="cb22-56"><a href="#cb22-56" aria-hidden="true" tabindex="-1"></a>        <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb22-57"><a href="#cb22-57" aria-hidden="true" tabindex="-1"></a>            <span class="dt">int64_t</span> value<span class="op">;</span></span>
<span id="cb22-58"><a href="#cb22-58" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> int_literal<span class="op">;</span></span>
<span id="cb22-59"><a href="#cb22-59" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb22-60"><a href="#cb22-60" aria-hidden="true" tabindex="-1"></a>        <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb22-61"><a href="#cb22-61" aria-hidden="true" tabindex="-1"></a>            <span class="dt">double</span> value<span class="op">;</span></span>
<span id="cb22-62"><a href="#cb22-62" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> float_literal<span class="op">;</span></span>
<span id="cb22-63"><a href="#cb22-63" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb22-64"><a href="#cb22-64" aria-hidden="true" tabindex="-1"></a>        <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb22-65"><a href="#cb22-65" aria-hidden="true" tabindex="-1"></a>            <span class="dt">char</span> <span class="op">*</span>value<span class="op">;</span></span>
<span id="cb22-66"><a href="#cb22-66" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> string_literal<span class="op">;</span></span>
<span id="cb22-67"><a href="#cb22-67" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb22-68"><a href="#cb22-68" aria-hidden="true" tabindex="-1"></a>        <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb22-69"><a href="#cb22-69" aria-hidden="true" tabindex="-1"></a>            <span class="dt">bool</span> value<span class="op">;</span></span>
<span id="cb22-70"><a href="#cb22-70" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> bool_literal<span class="op">;</span></span>
<span id="cb22-71"><a href="#cb22-71" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb22-72"><a href="#cb22-72" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Identifier</span></span>
<span id="cb22-73"><a href="#cb22-73" aria-hidden="true" tabindex="-1"></a>        <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb22-74"><a href="#cb22-74" aria-hidden="true" tabindex="-1"></a>            <span class="dt">char</span> <span class="op">*</span>name<span class="op">;</span></span>
<span id="cb22-75"><a href="#cb22-75" aria-hidden="true" tabindex="-1"></a>            Symbol <span class="op">*</span>symbol<span class="op">;</span>  <span class="co">// Filled during semantic analysis</span></span>
<span id="cb22-76"><a href="#cb22-76" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> identifier<span class="op">;</span></span>
<span id="cb22-77"><a href="#cb22-77" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb22-78"><a href="#cb22-78" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Binary operation</span></span>
<span id="cb22-79"><a href="#cb22-79" aria-hidden="true" tabindex="-1"></a>        <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb22-80"><a href="#cb22-80" aria-hidden="true" tabindex="-1"></a>            TokenType op<span class="op">;</span></span>
<span id="cb22-81"><a href="#cb22-81" aria-hidden="true" tabindex="-1"></a>            <span class="kw">struct</span> ASTNode <span class="op">*</span>left<span class="op">;</span></span>
<span id="cb22-82"><a href="#cb22-82" aria-hidden="true" tabindex="-1"></a>            <span class="kw">struct</span> ASTNode <span class="op">*</span>right<span class="op">;</span></span>
<span id="cb22-83"><a href="#cb22-83" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> binary_op<span class="op">;</span></span>
<span id="cb22-84"><a href="#cb22-84" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb22-85"><a href="#cb22-85" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Unary operation</span></span>
<span id="cb22-86"><a href="#cb22-86" aria-hidden="true" tabindex="-1"></a>        <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb22-87"><a href="#cb22-87" aria-hidden="true" tabindex="-1"></a>            TokenType op<span class="op">;</span></span>
<span id="cb22-88"><a href="#cb22-88" aria-hidden="true" tabindex="-1"></a>            <span class="kw">struct</span> ASTNode <span class="op">*</span>operand<span class="op">;</span></span>
<span id="cb22-89"><a href="#cb22-89" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> unary_op<span class="op">;</span></span>
<span id="cb22-90"><a href="#cb22-90" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb22-91"><a href="#cb22-91" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Function call</span></span>
<span id="cb22-92"><a href="#cb22-92" aria-hidden="true" tabindex="-1"></a>        <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb22-93"><a href="#cb22-93" aria-hidden="true" tabindex="-1"></a>            <span class="kw">struct</span> ASTNode <span class="op">*</span>callee<span class="op">;</span></span>
<span id="cb22-94"><a href="#cb22-94" aria-hidden="true" tabindex="-1"></a>            <span class="kw">struct</span> ASTNode <span class="op">**</span>args<span class="op">;</span></span>
<span id="cb22-95"><a href="#cb22-95" aria-hidden="true" tabindex="-1"></a>            <span class="dt">size_t</span> arg_count<span class="op">;</span></span>
<span id="cb22-96"><a href="#cb22-96" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> call<span class="op">;</span></span>
<span id="cb22-97"><a href="#cb22-97" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb22-98"><a href="#cb22-98" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Function definition</span></span>
<span id="cb22-99"><a href="#cb22-99" aria-hidden="true" tabindex="-1"></a>        <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb22-100"><a href="#cb22-100" aria-hidden="true" tabindex="-1"></a>            <span class="dt">char</span> <span class="op">*</span>name<span class="op">;</span></span>
<span id="cb22-101"><a href="#cb22-101" aria-hidden="true" tabindex="-1"></a>            <span class="kw">struct</span> ASTNode <span class="op">**</span>params<span class="op">;</span></span>
<span id="cb22-102"><a href="#cb22-102" aria-hidden="true" tabindex="-1"></a>            <span class="dt">size_t</span> param_count<span class="op">;</span></span>
<span id="cb22-103"><a href="#cb22-103" aria-hidden="true" tabindex="-1"></a>            <span class="kw">struct</span> ASTNode <span class="op">*</span>body<span class="op">;</span></span>
<span id="cb22-104"><a href="#cb22-104" aria-hidden="true" tabindex="-1"></a>            Type <span class="op">*</span>return_type<span class="op">;</span>  <span class="co">// Optional type annotation</span></span>
<span id="cb22-105"><a href="#cb22-105" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> function<span class="op">;</span></span>
<span id="cb22-106"><a href="#cb22-106" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb22-107"><a href="#cb22-107" aria-hidden="true" tabindex="-1"></a>        <span class="co">// If statement</span></span>
<span id="cb22-108"><a href="#cb22-108" aria-hidden="true" tabindex="-1"></a>        <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb22-109"><a href="#cb22-109" aria-hidden="true" tabindex="-1"></a>            <span class="kw">struct</span> ASTNode <span class="op">*</span>condition<span class="op">;</span></span>
<span id="cb22-110"><a href="#cb22-110" aria-hidden="true" tabindex="-1"></a>            <span class="kw">struct</span> ASTNode <span class="op">*</span>then_branch<span class="op">;</span></span>
<span id="cb22-111"><a href="#cb22-111" aria-hidden="true" tabindex="-1"></a>            <span class="kw">struct</span> ASTNode <span class="op">*</span>else_branch<span class="op">;</span>  <span class="co">// May be NULL</span></span>
<span id="cb22-112"><a href="#cb22-112" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> if_stmt<span class="op">;</span></span>
<span id="cb22-113"><a href="#cb22-113" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb22-114"><a href="#cb22-114" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Block</span></span>
<span id="cb22-115"><a href="#cb22-115" aria-hidden="true" tabindex="-1"></a>        <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb22-116"><a href="#cb22-116" aria-hidden="true" tabindex="-1"></a>            <span class="kw">struct</span> ASTNode <span class="op">**</span>statements<span class="op">;</span></span>
<span id="cb22-117"><a href="#cb22-117" aria-hidden="true" tabindex="-1"></a>            <span class="dt">size_t</span> stmt_count<span class="op">;</span></span>
<span id="cb22-118"><a href="#cb22-118" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> block<span class="op">;</span></span>
<span id="cb22-119"><a href="#cb22-119" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb22-120"><a href="#cb22-120" aria-hidden="true" tabindex="-1"></a>        <span class="co">// ... more node types ...</span></span>
<span id="cb22-121"><a href="#cb22-121" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> data<span class="op">;</span></span>
<span id="cb22-122"><a href="#cb22-122" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> ASTNode<span class="op">;</span></span></code></pre></div>
<h3>2.4.2 Parser Utilities</h3>
<div class="sourceCode" id="cb23"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> advance<span class="op">(</span>DyrParser <span class="op">*</span>parser<span class="op">)</span> <span class="op">{</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>    parser<span class="op">-&gt;</span>previous <span class="op">=</span> parser<span class="op">-&gt;</span>current<span class="op">;</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>        parser<span class="op">-&gt;</span>current <span class="op">=</span> dyr_lexer_next_token<span class="op">(</span>parser<span class="op">-&gt;</span>lexer<span class="op">);</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>parser<span class="op">-&gt;</span>current<span class="op">.</span>type <span class="op">!=</span> TOK_ERROR<span class="op">)</span> <span class="op">{</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span><span class="op">;</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>        error_at_current<span class="op">(</span>parser<span class="op">,</span> parser<span class="op">-&gt;</span>current<span class="op">.</span>text<span class="op">);</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">bool</span> check<span class="op">(</span>DyrParser <span class="op">*</span>parser<span class="op">,</span> TokenType type<span class="op">)</span> <span class="op">{</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> parser<span class="op">-&gt;</span>current<span class="op">.</span>type <span class="op">==</span> type<span class="op">;</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">bool</span> match<span class="op">(</span>DyrParser <span class="op">*</span>parser<span class="op">,</span> TokenType type<span class="op">)</span> <span class="op">{</span></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>check<span class="op">(</span>parser<span class="op">,</span> type<span class="op">))</span> <span class="op">{</span></span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>    advance<span class="op">(</span>parser<span class="op">);</span></span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> consume<span class="op">(</span>DyrParser <span class="op">*</span>parser<span class="op">,</span> TokenType type<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>message<span class="op">)</span> <span class="op">{</span></span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>parser<span class="op">-&gt;</span>current<span class="op">.</span>type <span class="op">==</span> type<span class="op">)</span> <span class="op">{</span></span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>        advance<span class="op">(</span>parser<span class="op">);</span></span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span><span class="op">;</span></span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>    error_at_current<span class="op">(</span>parser<span class="op">,</span> message<span class="op">);</span></span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> synchronize<span class="op">(</span>DyrParser <span class="op">*</span>parser<span class="op">)</span> <span class="op">{</span></span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a>    parser<span class="op">-&gt;</span>panic_mode <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span>parser<span class="op">-&gt;</span>current<span class="op">.</span>type <span class="op">!=</span> TOK_EOF<span class="op">)</span> <span class="op">{</span></span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>parser<span class="op">-&gt;</span>previous<span class="op">.</span>type <span class="op">==</span> TOK_SEMICOLON<span class="op">)</span> <span class="cf">return</span><span class="op">;</span></span>
<span id="cb23-40"><a href="#cb23-40" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-41"><a href="#cb23-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">switch</span> <span class="op">(</span>parser<span class="op">-&gt;</span>current<span class="op">.</span>type<span class="op">)</span> <span class="op">{</span></span>
<span id="cb23-42"><a href="#cb23-42" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> TOK_CLASS<span class="op">:</span></span>
<span id="cb23-43"><a href="#cb23-43" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> TOK_DEF<span class="op">:</span></span>
<span id="cb23-44"><a href="#cb23-44" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> TOK_FOR<span class="op">:</span></span>
<span id="cb23-45"><a href="#cb23-45" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> TOK_IF<span class="op">:</span></span>
<span id="cb23-46"><a href="#cb23-46" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> TOK_WHILE<span class="op">:</span></span>
<span id="cb23-47"><a href="#cb23-47" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> TOK_RETURN<span class="op">:</span></span>
<span id="cb23-48"><a href="#cb23-48" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span><span class="op">;</span></span>
<span id="cb23-49"><a href="#cb23-49" aria-hidden="true" tabindex="-1"></a>            <span class="cf">default</span><span class="op">:</span></span>
<span id="cb23-50"><a href="#cb23-50" aria-hidden="true" tabindex="-1"></a>                <span class="op">;</span> <span class="co">// Continue</span></span>
<span id="cb23-51"><a href="#cb23-51" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb23-52"><a href="#cb23-52" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-53"><a href="#cb23-53" aria-hidden="true" tabindex="-1"></a>        advance<span class="op">(</span>parser<span class="op">);</span></span>
<span id="cb23-54"><a href="#cb23-54" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb23-55"><a href="#cb23-55" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3>2.4.3 Expression Parsing</h3>
<p>We use Pratt parsing (operator precedence parsing) for
expressions:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">enum</span> <span class="op">{</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    PREC_NONE<span class="op">,</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    PREC_ASSIGNMENT<span class="op">,</span>  <span class="co">// =</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    PREC_OR<span class="op">,</span>          <span class="co">// or</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    PREC_AND<span class="op">,</span>         <span class="co">// and</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    PREC_NOT<span class="op">,</span>         <span class="co">// not</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    PREC_EQUALITY<span class="op">,</span>    <span class="co">// == !=</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>    PREC_COMPARISON<span class="op">,</span>  <span class="co">// &lt; &gt; &lt;= &gt;=</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>    PREC_BITOR<span class="op">,</span>       <span class="co">// |</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>    PREC_BITXOR<span class="op">,</span>     <span class="co">// ^</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>    PREC_BITAND<span class="op">,</span>     <span class="co">// &amp;</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>    PREC_SHIFT<span class="op">,</span>       <span class="co">// &lt;&lt; &gt;&gt;</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>    PREC_TERM<span class="op">,</span>        <span class="co">// + -</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>    PREC_FACTOR<span class="op">,</span>      <span class="co">// * / % //</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>    PREC_UNARY<span class="op">,</span>       <span class="co">// - + ~ not</span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>    PREC_POWER<span class="op">,</span>       <span class="co">// **</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>    PREC_CALL<span class="op">,</span>        <span class="co">// () [] .</span></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>    PREC_PRIMARY</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> Precedence<span class="op">;</span></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> ASTNode<span class="op">*</span> <span class="op">(*</span>ParseFn<span class="op">)(</span>DyrParser<span class="op">*,</span> <span class="dt">bool</span><span class="op">);</span></span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a>    ParseFn prefix<span class="op">;</span></span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a>    ParseFn infix<span class="op">;</span></span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a>    Precedence precedence<span class="op">;</span></span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> ParseRule<span class="op">;</span></span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> ASTNode<span class="op">*</span> expression<span class="op">(</span>DyrParser <span class="op">*</span>parser<span class="op">);</span></span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> ASTNode<span class="op">*</span> parse_precedence<span class="op">(</span>DyrParser <span class="op">*</span>parser<span class="op">,</span> Precedence precedence<span class="op">);</span></span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a><span class="co">// Parse rule table</span></span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> ParseRule rules<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>TOK_LPAREN<span class="op">]</span>    <span class="op">=</span> <span class="op">{</span>grouping<span class="op">,</span> call<span class="op">,</span>   PREC_CALL<span class="op">},</span></span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>TOK_MINUS<span class="op">]</span>     <span class="op">=</span> <span class="op">{</span>unary<span class="op">,</span>    binary<span class="op">,</span> PREC_TERM<span class="op">},</span></span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>TOK_PLUS<span class="op">]</span>      <span class="op">=</span> <span class="op">{</span>NULL<span class="op">,</span>     binary<span class="op">,</span> PREC_TERM<span class="op">},</span></span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>TOK_STAR<span class="op">]</span>      <span class="op">=</span> <span class="op">{</span>NULL<span class="op">,</span>     binary<span class="op">,</span> PREC_FACTOR<span class="op">},</span></span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>TOK_SLASH<span class="op">]</span>     <span class="op">=</span> <span class="op">{</span>NULL<span class="op">,</span>     binary<span class="op">,</span> PREC_FACTOR<span class="op">},</span></span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>TOK_PERCENT<span class="op">]</span>   <span class="op">=</span> <span class="op">{</span>NULL<span class="op">,</span>     binary<span class="op">,</span> PREC_FACTOR<span class="op">},</span></span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>TOK_POWER<span class="op">]</span>     <span class="op">=</span> <span class="op">{</span>NULL<span class="op">,</span>     binary<span class="op">,</span> PREC_POWER<span class="op">},</span></span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>TOK_INT<span class="op">]</span>       <span class="op">=</span> <span class="op">{</span>number<span class="op">,</span>   NULL<span class="op">,</span>   PREC_NONE<span class="op">},</span></span>
<span id="cb24-42"><a href="#cb24-42" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>TOK_FLOAT<span class="op">]</span>     <span class="op">=</span> <span class="op">{</span>number<span class="op">,</span>   NULL<span class="op">,</span>   PREC_NONE<span class="op">},</span></span>
<span id="cb24-43"><a href="#cb24-43" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>TOK_STRING<span class="op">]</span>    <span class="op">=</span> <span class="op">{</span>string<span class="op">,</span>   NULL<span class="op">,</span>   PREC_NONE<span class="op">},</span></span>
<span id="cb24-44"><a href="#cb24-44" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>TOK_TRUE<span class="op">]</span>      <span class="op">=</span> <span class="op">{</span>literal<span class="op">,</span>  NULL<span class="op">,</span>   PREC_NONE<span class="op">},</span></span>
<span id="cb24-45"><a href="#cb24-45" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>TOK_FALSE<span class="op">]</span>     <span class="op">=</span> <span class="op">{</span>literal<span class="op">,</span>  NULL<span class="op">,</span>   PREC_NONE<span class="op">},</span></span>
<span id="cb24-46"><a href="#cb24-46" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>TOK_NULL<span class="op">]</span>      <span class="op">=</span> <span class="op">{</span>literal<span class="op">,</span>  NULL<span class="op">,</span>   PREC_NONE<span class="op">},</span></span>
<span id="cb24-47"><a href="#cb24-47" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>TOK_IDENT<span class="op">]</span>     <span class="op">=</span> <span class="op">{</span>variable<span class="op">,</span> NULL<span class="op">,</span>   PREC_NONE<span class="op">},</span></span>
<span id="cb24-48"><a href="#cb24-48" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>TOK_EQ<span class="op">]</span>        <span class="op">=</span> <span class="op">{</span>NULL<span class="op">,</span>     binary<span class="op">,</span> PREC_EQUALITY<span class="op">},</span></span>
<span id="cb24-49"><a href="#cb24-49" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>TOK_NE<span class="op">]</span>        <span class="op">=</span> <span class="op">{</span>NULL<span class="op">,</span>     binary<span class="op">,</span> PREC_EQUALITY<span class="op">},</span></span>
<span id="cb24-50"><a href="#cb24-50" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>TOK_LT<span class="op">]</span>        <span class="op">=</span> <span class="op">{</span>NULL<span class="op">,</span>     binary<span class="op">,</span> PREC_COMPARISON<span class="op">},</span></span>
<span id="cb24-51"><a href="#cb24-51" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>TOK_GT<span class="op">]</span>        <span class="op">=</span> <span class="op">{</span>NULL<span class="op">,</span>     binary<span class="op">,</span> PREC_COMPARISON<span class="op">},</span></span>
<span id="cb24-52"><a href="#cb24-52" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>TOK_LE<span class="op">]</span>        <span class="op">=</span> <span class="op">{</span>NULL<span class="op">,</span>     binary<span class="op">,</span> PREC_COMPARISON<span class="op">},</span></span>
<span id="cb24-53"><a href="#cb24-53" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>TOK_GE<span class="op">]</span>        <span class="op">=</span> <span class="op">{</span>NULL<span class="op">,</span>     binary<span class="op">,</span> PREC_COMPARISON<span class="op">},</span></span>
<span id="cb24-54"><a href="#cb24-54" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>TOK_AND<span class="op">]</span>       <span class="op">=</span> <span class="op">{</span>NULL<span class="op">,</span>     and_<span class="op">,</span>   PREC_AND<span class="op">},</span></span>
<span id="cb24-55"><a href="#cb24-55" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>TOK_OR<span class="op">]</span>        <span class="op">=</span> <span class="op">{</span>NULL<span class="op">,</span>     or_<span class="op">,</span>    PREC_OR<span class="op">},</span></span>
<span id="cb24-56"><a href="#cb24-56" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>TOK_NOT<span class="op">]</span>       <span class="op">=</span> <span class="op">{</span>unary<span class="op">,</span>    NULL<span class="op">,</span>   PREC_NOT<span class="op">},</span></span>
<span id="cb24-57"><a href="#cb24-57" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>TOK_DOT<span class="op">]</span>       <span class="op">=</span> <span class="op">{</span>NULL<span class="op">,</span>     dot<span class="op">,</span>    PREC_CALL<span class="op">},</span></span>
<span id="cb24-58"><a href="#cb24-58" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>TOK_LBRACKET<span class="op">]</span>  <span class="op">=</span> <span class="op">{</span>array<span class="op">,</span>    index<span class="op">,</span>  PREC_CALL<span class="op">},</span></span>
<span id="cb24-59"><a href="#cb24-59" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ... more rules ...</span></span>
<span id="cb24-60"><a href="#cb24-60" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb24-61"><a href="#cb24-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-62"><a href="#cb24-62" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> ParseRule<span class="op">*</span> get_rule<span class="op">(</span>TokenType type<span class="op">)</span> <span class="op">{</span></span>
<span id="cb24-63"><a href="#cb24-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">&amp;</span>rules<span class="op">[</span>type<span class="op">];</span></span>
<span id="cb24-64"><a href="#cb24-64" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb24-65"><a href="#cb24-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-66"><a href="#cb24-66" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> ASTNode<span class="op">*</span> parse_precedence<span class="op">(</span>DyrParser <span class="op">*</span>parser<span class="op">,</span> Precedence precedence<span class="op">)</span> <span class="op">{</span></span>
<span id="cb24-67"><a href="#cb24-67" aria-hidden="true" tabindex="-1"></a>    advance<span class="op">(</span>parser<span class="op">);</span></span>
<span id="cb24-68"><a href="#cb24-68" aria-hidden="true" tabindex="-1"></a>    ParseFn prefix_rule <span class="op">=</span> get_rule<span class="op">(</span>parser<span class="op">-&gt;</span>previous<span class="op">.</span>type<span class="op">)-&gt;</span>prefix<span class="op">;</span></span>
<span id="cb24-69"><a href="#cb24-69" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>prefix_rule <span class="op">==</span> NULL<span class="op">)</span> <span class="op">{</span></span>
<span id="cb24-70"><a href="#cb24-70" aria-hidden="true" tabindex="-1"></a>        error<span class="op">(</span>parser<span class="op">,</span> <span class="st">&quot;Expected expression&quot;</span><span class="op">);</span></span>
<span id="cb24-71"><a href="#cb24-71" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> NULL<span class="op">;</span></span>
<span id="cb24-72"><a href="#cb24-72" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb24-73"><a href="#cb24-73" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-74"><a href="#cb24-74" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> can_assign <span class="op">=</span> precedence <span class="op">&lt;=</span> PREC_ASSIGNMENT<span class="op">;</span></span>
<span id="cb24-75"><a href="#cb24-75" aria-hidden="true" tabindex="-1"></a>    ASTNode <span class="op">*</span>expr <span class="op">=</span> prefix_rule<span class="op">(</span>parser<span class="op">,</span> can_assign<span class="op">);</span></span>
<span id="cb24-76"><a href="#cb24-76" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-77"><a href="#cb24-77" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span>precedence <span class="op">&lt;=</span> get_rule<span class="op">(</span>parser<span class="op">-&gt;</span>current<span class="op">.</span>type<span class="op">)-&gt;</span>precedence<span class="op">)</span> <span class="op">{</span></span>
<span id="cb24-78"><a href="#cb24-78" aria-hidden="true" tabindex="-1"></a>        advance<span class="op">(</span>parser<span class="op">);</span></span>
<span id="cb24-79"><a href="#cb24-79" aria-hidden="true" tabindex="-1"></a>        ParseFn infix_rule <span class="op">=</span> get_rule<span class="op">(</span>parser<span class="op">-&gt;</span>previous<span class="op">.</span>type<span class="op">)-&gt;</span>infix<span class="op">;</span></span>
<span id="cb24-80"><a href="#cb24-80" aria-hidden="true" tabindex="-1"></a>        expr <span class="op">=</span> infix_rule<span class="op">(</span>parser<span class="op">,</span> can_assign<span class="op">,</span> expr<span class="op">);</span></span>
<span id="cb24-81"><a href="#cb24-81" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb24-82"><a href="#cb24-82" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-83"><a href="#cb24-83" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>can_assign <span class="op">&amp;&amp;</span> match<span class="op">(</span>parser<span class="op">,</span> TOK_ASSIGN<span class="op">))</span> <span class="op">{</span></span>
<span id="cb24-84"><a href="#cb24-84" aria-hidden="true" tabindex="-1"></a>        error<span class="op">(</span>parser<span class="op">,</span> <span class="st">&quot;Invalid assignment target&quot;</span><span class="op">);</span></span>
<span id="cb24-85"><a href="#cb24-85" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb24-86"><a href="#cb24-86" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-87"><a href="#cb24-87" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> expr<span class="op">;</span></span>
<span id="cb24-88"><a href="#cb24-88" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb24-89"><a href="#cb24-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-90"><a href="#cb24-90" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> ASTNode<span class="op">*</span> expression<span class="op">(</span>DyrParser <span class="op">*</span>parser<span class="op">)</span> <span class="op">{</span></span>
<span id="cb24-91"><a href="#cb24-91" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> parse_precedence<span class="op">(</span>parser<span class="op">,</span> PREC_ASSIGNMENT<span class="op">);</span></span>
<span id="cb24-92"><a href="#cb24-92" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb24-93"><a href="#cb24-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-94"><a href="#cb24-94" aria-hidden="true" tabindex="-1"></a><span class="co">// Parsing functions for specific constructs</span></span>
<span id="cb24-95"><a href="#cb24-95" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> ASTNode<span class="op">*</span> number<span class="op">(</span>DyrParser <span class="op">*</span>parser<span class="op">,</span> <span class="dt">bool</span> can_assign<span class="op">)</span> <span class="op">{</span></span>
<span id="cb24-96"><a href="#cb24-96" aria-hidden="true" tabindex="-1"></a>    <span class="op">(</span><span class="dt">void</span><span class="op">)</span>can_assign<span class="op">;</span></span>
<span id="cb24-97"><a href="#cb24-97" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-98"><a href="#cb24-98" aria-hidden="true" tabindex="-1"></a>    ASTNode <span class="op">*</span>node <span class="op">=</span> ast_node_new<span class="op">(</span></span>
<span id="cb24-99"><a href="#cb24-99" aria-hidden="true" tabindex="-1"></a>        parser<span class="op">-&gt;</span>previous<span class="op">.</span>type <span class="op">==</span> TOK_INT <span class="op">?</span> AST_INT_LITERAL <span class="op">:</span> AST_FLOAT_LITERAL<span class="op">,</span></span>
<span id="cb24-100"><a href="#cb24-100" aria-hidden="true" tabindex="-1"></a>        parser<span class="op">-&gt;</span>previous<span class="op">.</span>location</span>
<span id="cb24-101"><a href="#cb24-101" aria-hidden="true" tabindex="-1"></a>    <span class="op">);</span></span>
<span id="cb24-102"><a href="#cb24-102" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-103"><a href="#cb24-103" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>parser<span class="op">-&gt;</span>previous<span class="op">.</span>type <span class="op">==</span> TOK_INT<span class="op">)</span> <span class="op">{</span></span>
<span id="cb24-104"><a href="#cb24-104" aria-hidden="true" tabindex="-1"></a>        node<span class="op">-&gt;</span>data<span class="op">.</span>int_literal<span class="op">.</span>value <span class="op">=</span> parser<span class="op">-&gt;</span>previous<span class="op">.</span>value<span class="op">.</span>int_value<span class="op">;</span></span>
<span id="cb24-105"><a href="#cb24-105" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb24-106"><a href="#cb24-106" aria-hidden="true" tabindex="-1"></a>        node<span class="op">-&gt;</span>data<span class="op">.</span>float_literal<span class="op">.</span>value <span class="op">=</span> parser<span class="op">-&gt;</span>previous<span class="op">.</span>value<span class="op">.</span>float_value<span class="op">;</span></span>
<span id="cb24-107"><a href="#cb24-107" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb24-108"><a href="#cb24-108" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-109"><a href="#cb24-109" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> node<span class="op">;</span></span>
<span id="cb24-110"><a href="#cb24-110" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb24-111"><a href="#cb24-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-112"><a href="#cb24-112" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> ASTNode<span class="op">*</span> binary<span class="op">(</span>DyrParser <span class="op">*</span>parser<span class="op">,</span> <span class="dt">bool</span> can_assign<span class="op">,</span> ASTNode <span class="op">*</span>left<span class="op">)</span> <span class="op">{</span></span>
<span id="cb24-113"><a href="#cb24-113" aria-hidden="true" tabindex="-1"></a>    <span class="op">(</span><span class="dt">void</span><span class="op">)</span>can_assign<span class="op">;</span></span>
<span id="cb24-114"><a href="#cb24-114" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-115"><a href="#cb24-115" aria-hidden="true" tabindex="-1"></a>    TokenType op_type <span class="op">=</span> parser<span class="op">-&gt;</span>previous<span class="op">.</span>type<span class="op">;</span></span>
<span id="cb24-116"><a href="#cb24-116" aria-hidden="true" tabindex="-1"></a>    ParseRule <span class="op">*</span>rule <span class="op">=</span> get_rule<span class="op">(</span>op_type<span class="op">);</span></span>
<span id="cb24-117"><a href="#cb24-117" aria-hidden="true" tabindex="-1"></a>    ASTNode <span class="op">*</span>right <span class="op">=</span> parse_precedence<span class="op">(</span>parser<span class="op">,</span> rule<span class="op">-&gt;</span>precedence <span class="op">+</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb24-118"><a href="#cb24-118" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-119"><a href="#cb24-119" aria-hidden="true" tabindex="-1"></a>    ASTNode <span class="op">*</span>node <span class="op">=</span> ast_node_new<span class="op">(</span>AST_BINARY_OP<span class="op">,</span> parser<span class="op">-&gt;</span>previous<span class="op">.</span>location<span class="op">);</span></span>
<span id="cb24-120"><a href="#cb24-120" aria-hidden="true" tabindex="-1"></a>    node<span class="op">-&gt;</span>data<span class="op">.</span>binary_op<span class="op">.</span>op <span class="op">=</span> op_type<span class="op">;</span></span>
<span id="cb24-121"><a href="#cb24-121" aria-hidden="true" tabindex="-1"></a>    node<span class="op">-&gt;</span>data<span class="op">.</span>binary_op<span class="op">.</span>left <span class="op">=</span> left<span class="op">;</span></span>
<span id="cb24-122"><a href="#cb24-122" aria-hidden="true" tabindex="-1"></a>    node<span class="op">-&gt;</span>data<span class="op">.</span>binary_op<span class="op">.</span>right <span class="op">=</span> right<span class="op">;</span></span>
<span id="cb24-123"><a href="#cb24-123" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-124"><a href="#cb24-124" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> node<span class="op">;</span></span>
<span id="cb24-125"><a href="#cb24-125" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3>2.4.4 Statement Parsing</h3>
<div class="sourceCode" id="cb25"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> ASTNode<span class="op">*</span> statement<span class="op">(</span>DyrParser <span class="op">*</span>parser<span class="op">)</span> <span class="op">{</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Skip newlines at statement level</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span>match<span class="op">(</span>parser<span class="op">,</span> TOK_NEWLINE<span class="op">))</span> <span class="op">{</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Empty</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>match<span class="op">(</span>parser<span class="op">,</span> TOK_DEF<span class="op">))</span> <span class="op">{</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> function_declaration<span class="op">(</span>parser<span class="op">);</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>match<span class="op">(</span>parser<span class="op">,</span> TOK_CLASS<span class="op">))</span> <span class="op">{</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> class_declaration<span class="op">(</span>parser<span class="op">);</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>match<span class="op">(</span>parser<span class="op">,</span> TOK_IF<span class="op">))</span> <span class="op">{</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> if_statement<span class="op">(</span>parser<span class="op">);</span></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>match<span class="op">(</span>parser<span class="op">,</span> TOK_WHILE<span class="op">))</span> <span class="op">{</span></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> while_statement<span class="op">(</span>parser<span class="op">);</span></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>match<span class="op">(</span>parser<span class="op">,</span> TOK_FOR<span class="op">))</span> <span class="op">{</span></span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> for_statement<span class="op">(</span>parser<span class="op">);</span></span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>match<span class="op">(</span>parser<span class="op">,</span> TOK_RETURN<span class="op">))</span> <span class="op">{</span></span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> return_statement<span class="op">(</span>parser<span class="op">);</span></span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>match<span class="op">(</span>parser<span class="op">,</span> TOK_BREAK<span class="op">))</span> <span class="op">{</span></span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> break_statement<span class="op">(</span>parser<span class="op">);</span></span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>match<span class="op">(</span>parser<span class="op">,</span> TOK_CONTINUE<span class="op">))</span> <span class="op">{</span></span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> continue_statement<span class="op">(</span>parser<span class="op">);</span></span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>match<span class="op">(</span>parser<span class="op">,</span> TOK_TRY<span class="op">))</span> <span class="op">{</span></span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> try_statement<span class="op">(</span>parser<span class="op">);</span></span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb25-42"><a href="#cb25-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-43"><a href="#cb25-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>match<span class="op">(</span>parser<span class="op">,</span> TOK_RAISE<span class="op">))</span> <span class="op">{</span></span>
<span id="cb25-44"><a href="#cb25-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> raise_statement<span class="op">(</span>parser<span class="op">);</span></span>
<span id="cb25-45"><a href="#cb25-45" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb25-46"><a href="#cb25-46" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-47"><a href="#cb25-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>match<span class="op">(</span>parser<span class="op">,</span> TOK_IMPORT<span class="op">))</span> <span class="op">{</span></span>
<span id="cb25-48"><a href="#cb25-48" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> import_statement<span class="op">(</span>parser<span class="op">);</span></span>
<span id="cb25-49"><a href="#cb25-49" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb25-50"><a href="#cb25-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-51"><a href="#cb25-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>match<span class="op">(</span>parser<span class="op">,</span> TOK_FROM<span class="op">))</span> <span class="op">{</span></span>
<span id="cb25-52"><a href="#cb25-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> from_import_statement<span class="op">(</span>parser<span class="op">);</span></span>
<span id="cb25-53"><a href="#cb25-53" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb25-54"><a href="#cb25-54" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-55"><a href="#cb25-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> expression_statement<span class="op">(</span>parser<span class="op">);</span></span>
<span id="cb25-56"><a href="#cb25-56" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb25-57"><a href="#cb25-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-58"><a href="#cb25-58" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> ASTNode<span class="op">*</span> function_declaration<span class="op">(</span>DyrParser <span class="op">*</span>parser<span class="op">)</span> <span class="op">{</span></span>
<span id="cb25-59"><a href="#cb25-59" aria-hidden="true" tabindex="-1"></a>    consume<span class="op">(</span>parser<span class="op">,</span> TOK_IDENT<span class="op">,</span> <span class="st">&quot;Expected function name&quot;</span><span class="op">);</span></span>
<span id="cb25-60"><a href="#cb25-60" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span>name <span class="op">=</span> strdup<span class="op">(</span>parser<span class="op">-&gt;</span>previous<span class="op">.</span>text<span class="op">);</span></span>
<span id="cb25-61"><a href="#cb25-61" aria-hidden="true" tabindex="-1"></a>    parser<span class="op">-&gt;</span>current_function <span class="op">=</span> name<span class="op">;</span></span>
<span id="cb25-62"><a href="#cb25-62" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-63"><a href="#cb25-63" aria-hidden="true" tabindex="-1"></a>    consume<span class="op">(</span>parser<span class="op">,</span> TOK_LPAREN<span class="op">,</span> <span class="st">&quot;Expected &#39;(&#39; after function name&quot;</span><span class="op">);</span></span>
<span id="cb25-64"><a href="#cb25-64" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-65"><a href="#cb25-65" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Parameters</span></span>
<span id="cb25-66"><a href="#cb25-66" aria-hidden="true" tabindex="-1"></a>    ASTNode <span class="op">**</span>params <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb25-67"><a href="#cb25-67" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> param_count <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb25-68"><a href="#cb25-68" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> param_capacity <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb25-69"><a href="#cb25-69" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-70"><a href="#cb25-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>check<span class="op">(</span>parser<span class="op">,</span> TOK_RPAREN<span class="op">))</span> <span class="op">{</span></span>
<span id="cb25-71"><a href="#cb25-71" aria-hidden="true" tabindex="-1"></a>        <span class="cf">do</span> <span class="op">{</span></span>
<span id="cb25-72"><a href="#cb25-72" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>param_count <span class="op">&gt;=</span> param_capacity<span class="op">)</span> <span class="op">{</span></span>
<span id="cb25-73"><a href="#cb25-73" aria-hidden="true" tabindex="-1"></a>                param_capacity <span class="op">=</span> param_capacity <span class="op">==</span> <span class="dv">0</span> <span class="op">?</span> <span class="dv">8</span> <span class="op">:</span> param_capacity <span class="op">*</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb25-74"><a href="#cb25-74" aria-hidden="true" tabindex="-1"></a>                params <span class="op">=</span> realloc<span class="op">(</span>params<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>ASTNode<span class="op">*)</span> <span class="op">*</span> param_capacity<span class="op">);</span></span>
<span id="cb25-75"><a href="#cb25-75" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb25-76"><a href="#cb25-76" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb25-77"><a href="#cb25-77" aria-hidden="true" tabindex="-1"></a>            consume<span class="op">(</span>parser<span class="op">,</span> TOK_IDENT<span class="op">,</span> <span class="st">&quot;Expected parameter name&quot;</span><span class="op">);</span></span>
<span id="cb25-78"><a href="#cb25-78" aria-hidden="true" tabindex="-1"></a>            ASTNode <span class="op">*</span>param <span class="op">=</span> ast_node_new<span class="op">(</span>AST_PARAMETER<span class="op">,</span> parser<span class="op">-&gt;</span>previous<span class="op">.</span>location<span class="op">);</span></span>
<span id="cb25-79"><a href="#cb25-79" aria-hidden="true" tabindex="-1"></a>            param<span class="op">-&gt;</span>data<span class="op">.</span>identifier<span class="op">.</span>name <span class="op">=</span> strdup<span class="op">(</span>parser<span class="op">-&gt;</span>previous<span class="op">.</span>text<span class="op">);</span></span>
<span id="cb25-80"><a href="#cb25-80" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb25-81"><a href="#cb25-81" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Optional type annotation</span></span>
<span id="cb25-82"><a href="#cb25-82" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>match<span class="op">(</span>parser<span class="op">,</span> TOK_COLON<span class="op">))</span> <span class="op">{</span></span>
<span id="cb25-83"><a href="#cb25-83" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Parse type annotation (simplified for now)</span></span>
<span id="cb25-84"><a href="#cb25-84" aria-hidden="true" tabindex="-1"></a>                advance<span class="op">(</span>parser<span class="op">);</span></span>
<span id="cb25-85"><a href="#cb25-85" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb25-86"><a href="#cb25-86" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb25-87"><a href="#cb25-87" aria-hidden="true" tabindex="-1"></a>            params<span class="op">[</span>param_count<span class="op">++]</span> <span class="op">=</span> param<span class="op">;</span></span>
<span id="cb25-88"><a href="#cb25-88" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">while</span> <span class="op">(</span>match<span class="op">(</span>parser<span class="op">,</span> TOK_COMMA<span class="op">));</span></span>
<span id="cb25-89"><a href="#cb25-89" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb25-90"><a href="#cb25-90" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-91"><a href="#cb25-91" aria-hidden="true" tabindex="-1"></a>    consume<span class="op">(</span>parser<span class="op">,</span> TOK_RPAREN<span class="op">,</span> <span class="st">&quot;Expected &#39;)&#39; after parameters&quot;</span><span class="op">);</span></span>
<span id="cb25-92"><a href="#cb25-92" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-93"><a href="#cb25-93" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Optional return type annotation</span></span>
<span id="cb25-94"><a href="#cb25-94" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>match<span class="op">(</span>parser<span class="op">,</span> TOK_ARROW<span class="op">))</span> <span class="op">{</span></span>
<span id="cb25-95"><a href="#cb25-95" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Parse return type</span></span>
<span id="cb25-96"><a href="#cb25-96" aria-hidden="true" tabindex="-1"></a>        advance<span class="op">(</span>parser<span class="op">);</span></span>
<span id="cb25-97"><a href="#cb25-97" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb25-98"><a href="#cb25-98" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-99"><a href="#cb25-99" aria-hidden="true" tabindex="-1"></a>    consume<span class="op">(</span>parser<span class="op">,</span> TOK_COLON<span class="op">,</span> <span class="st">&quot;Expected &#39;:&#39; after function signature&quot;</span><span class="op">);</span></span>
<span id="cb25-100"><a href="#cb25-100" aria-hidden="true" tabindex="-1"></a>    consume<span class="op">(</span>parser<span class="op">,</span> TOK_NEWLINE<span class="op">,</span> <span class="st">&quot;Expected newline after &#39;:&#39;&quot;</span><span class="op">);</span></span>
<span id="cb25-101"><a href="#cb25-101" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-102"><a href="#cb25-102" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Function body</span></span>
<span id="cb25-103"><a href="#cb25-103" aria-hidden="true" tabindex="-1"></a>    ASTNode <span class="op">*</span>body <span class="op">=</span> block<span class="op">(</span>parser<span class="op">);</span></span>
<span id="cb25-104"><a href="#cb25-104" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-105"><a href="#cb25-105" aria-hidden="true" tabindex="-1"></a>    parser<span class="op">-&gt;</span>current_function <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb25-106"><a href="#cb25-106" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-107"><a href="#cb25-107" aria-hidden="true" tabindex="-1"></a>    ASTNode <span class="op">*</span>node <span class="op">=</span> ast_node_new<span class="op">(</span>AST_FUNCTION<span class="op">,</span> parser<span class="op">-&gt;</span>previous<span class="op">.</span>location<span class="op">);</span></span>
<span id="cb25-108"><a href="#cb25-108" aria-hidden="true" tabindex="-1"></a>    node<span class="op">-&gt;</span>data<span class="op">.</span>function<span class="op">.</span>name <span class="op">=</span> name<span class="op">;</span></span>
<span id="cb25-109"><a href="#cb25-109" aria-hidden="true" tabindex="-1"></a>    node<span class="op">-&gt;</span>data<span class="op">.</span>function<span class="op">.</span>params <span class="op">=</span> params<span class="op">;</span></span>
<span id="cb25-110"><a href="#cb25-110" aria-hidden="true" tabindex="-1"></a>    node<span class="op">-&gt;</span>data<span class="op">.</span>function<span class="op">.</span>param_count <span class="op">=</span> param_count<span class="op">;</span></span>
<span id="cb25-111"><a href="#cb25-111" aria-hidden="true" tabindex="-1"></a>    node<span class="op">-&gt;</span>data<span class="op">.</span>function<span class="op">.</span>body <span class="op">=</span> body<span class="op">;</span></span>
<span id="cb25-112"><a href="#cb25-112" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-113"><a href="#cb25-113" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> node<span class="op">;</span></span>
<span id="cb25-114"><a href="#cb25-114" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb25-115"><a href="#cb25-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-116"><a href="#cb25-116" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> ASTNode<span class="op">*</span> if_statement<span class="op">(</span>DyrParser <span class="op">*</span>parser<span class="op">)</span> <span class="op">{</span></span>
<span id="cb25-117"><a href="#cb25-117" aria-hidden="true" tabindex="-1"></a>    ASTNode <span class="op">*</span>condition <span class="op">=</span> expression<span class="op">(</span>parser<span class="op">);</span></span>
<span id="cb25-118"><a href="#cb25-118" aria-hidden="true" tabindex="-1"></a>    consume<span class="op">(</span>parser<span class="op">,</span> TOK_COLON<span class="op">,</span> <span class="st">&quot;Expected &#39;:&#39; after if condition&quot;</span><span class="op">);</span></span>
<span id="cb25-119"><a href="#cb25-119" aria-hidden="true" tabindex="-1"></a>    consume<span class="op">(</span>parser<span class="op">,</span> TOK_NEWLINE<span class="op">,</span> <span class="st">&quot;Expected newline after &#39;:&#39;&quot;</span><span class="op">);</span></span>
<span id="cb25-120"><a href="#cb25-120" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-121"><a href="#cb25-121" aria-hidden="true" tabindex="-1"></a>    ASTNode <span class="op">*</span>then_branch <span class="op">=</span> block<span class="op">(</span>parser<span class="op">);</span></span>
<span id="cb25-122"><a href="#cb25-122" aria-hidden="true" tabindex="-1"></a>    ASTNode <span class="op">*</span>else_branch <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb25-123"><a href="#cb25-123" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-124"><a href="#cb25-124" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Handle elif/else</span></span>
<span id="cb25-125"><a href="#cb25-125" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span>match<span class="op">(</span>parser<span class="op">,</span> TOK_ELIF<span class="op">))</span> <span class="op">{</span></span>
<span id="cb25-126"><a href="#cb25-126" aria-hidden="true" tabindex="-1"></a>        ASTNode <span class="op">*</span>elif_condition <span class="op">=</span> expression<span class="op">(</span>parser<span class="op">);</span></span>
<span id="cb25-127"><a href="#cb25-127" aria-hidden="true" tabindex="-1"></a>        consume<span class="op">(</span>parser<span class="op">,</span> TOK_COLON<span class="op">,</span> <span class="st">&quot;Expected &#39;:&#39; after elif condition&quot;</span><span class="op">);</span></span>
<span id="cb25-128"><a href="#cb25-128" aria-hidden="true" tabindex="-1"></a>        consume<span class="op">(</span>parser<span class="op">,</span> TOK_NEWLINE<span class="op">,</span> <span class="st">&quot;Expected newline after &#39;:&#39;&quot;</span><span class="op">);</span></span>
<span id="cb25-129"><a href="#cb25-129" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb25-130"><a href="#cb25-130" aria-hidden="true" tabindex="-1"></a>        ASTNode <span class="op">*</span>elif_body <span class="op">=</span> block<span class="op">(</span>parser<span class="op">);</span></span>
<span id="cb25-131"><a href="#cb25-131" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb25-132"><a href="#cb25-132" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Create nested if for elif</span></span>
<span id="cb25-133"><a href="#cb25-133" aria-hidden="true" tabindex="-1"></a>        ASTNode <span class="op">*</span>elif_node <span class="op">=</span> ast_node_new<span class="op">(</span>AST_IF<span class="op">,</span> parser<span class="op">-&gt;</span>previous<span class="op">.</span>location<span class="op">);</span></span>
<span id="cb25-134"><a href="#cb25-134" aria-hidden="true" tabindex="-1"></a>        elif_node<span class="op">-&gt;</span>data<span class="op">.</span>if_stmt<span class="op">.</span>condition <span class="op">=</span> elif_condition<span class="op">;</span></span>
<span id="cb25-135"><a href="#cb25-135" aria-hidden="true" tabindex="-1"></a>        elif_node<span class="op">-&gt;</span>data<span class="op">.</span>if_stmt<span class="op">.</span>then_branch <span class="op">=</span> elif_body<span class="op">;</span></span>
<span id="cb25-136"><a href="#cb25-136" aria-hidden="true" tabindex="-1"></a>        elif_node<span class="op">-&gt;</span>data<span class="op">.</span>if_stmt<span class="op">.</span>else_branch <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb25-137"><a href="#cb25-137" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb25-138"><a href="#cb25-138" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>else_branch <span class="op">==</span> NULL<span class="op">)</span> <span class="op">{</span></span>
<span id="cb25-139"><a href="#cb25-139" aria-hidden="true" tabindex="-1"></a>            else_branch <span class="op">=</span> elif_node<span class="op">;</span></span>
<span id="cb25-140"><a href="#cb25-140" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb25-141"><a href="#cb25-141" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Find the last else branch and attach</span></span>
<span id="cb25-142"><a href="#cb25-142" aria-hidden="true" tabindex="-1"></a>            ASTNode <span class="op">*</span>current <span class="op">=</span> else_branch<span class="op">;</span></span>
<span id="cb25-143"><a href="#cb25-143" aria-hidden="true" tabindex="-1"></a>            <span class="cf">while</span> <span class="op">(</span>current<span class="op">-&gt;</span>data<span class="op">.</span>if_stmt<span class="op">.</span>else_branch <span class="op">!=</span> NULL<span class="op">)</span> <span class="op">{</span></span>
<span id="cb25-144"><a href="#cb25-144" aria-hidden="true" tabindex="-1"></a>                current <span class="op">=</span> current<span class="op">-&gt;</span>data<span class="op">.</span>if_stmt<span class="op">.</span>else_branch<span class="op">;</span></span>
<span id="cb25-145"><a href="#cb25-145" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb25-146"><a href="#cb25-146" aria-hidden="true" tabindex="-1"></a>            current<span class="op">-&gt;</span>data<span class="op">.</span>if_stmt<span class="op">.</span>else_branch <span class="op">=</span> elif_node<span class="op">;</span></span>
<span id="cb25-147"><a href="#cb25-147" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb25-148"><a href="#cb25-148" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb25-149"><a href="#cb25-149" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-150"><a href="#cb25-150" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>match<span class="op">(</span>parser<span class="op">,</span> TOK_ELSE<span class="op">))</span> <span class="op">{</span></span>
<span id="cb25-151"><a href="#cb25-151" aria-hidden="true" tabindex="-1"></a>        consume<span class="op">(</span>parser<span class="op">,</span> TOK_COLON<span class="op">,</span> <span class="st">&quot;Expected &#39;:&#39; after else&quot;</span><span class="op">);</span></span>
<span id="cb25-152"><a href="#cb25-152" aria-hidden="true" tabindex="-1"></a>        consume<span class="op">(</span>parser<span class="op">,</span> TOK_NEWLINE<span class="op">,</span> <span class="st">&quot;Expected newline after &#39;:&#39;&quot;</span><span class="op">);</span></span>
<span id="cb25-153"><a href="#cb25-153" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb25-154"><a href="#cb25-154" aria-hidden="true" tabindex="-1"></a>        ASTNode <span class="op">*</span>else_body <span class="op">=</span> block<span class="op">(</span>parser<span class="op">);</span></span>
<span id="cb25-155"><a href="#cb25-155" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb25-156"><a href="#cb25-156" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>else_branch <span class="op">==</span> NULL<span class="op">)</span> <span class="op">{</span></span>
<span id="cb25-157"><a href="#cb25-157" aria-hidden="true" tabindex="-1"></a>            else_branch <span class="op">=</span> else_body<span class="op">;</span></span>
<span id="cb25-158"><a href="#cb25-158" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb25-159"><a href="#cb25-159" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Attach to last elif</span></span>
<span id="cb25-160"><a href="#cb25-160" aria-hidden="true" tabindex="-1"></a>            ASTNode <span class="op">*</span>current <span class="op">=</span> else_branch<span class="op">;</span></span>
<span id="cb25-161"><a href="#cb25-161" aria-hidden="true" tabindex="-1"></a>            <span class="cf">while</span> <span class="op">(</span>current<span class="op">-&gt;</span>type <span class="op">==</span> AST_IF <span class="op">&amp;&amp;</span> </span>
<span id="cb25-162"><a href="#cb25-162" aria-hidden="true" tabindex="-1"></a>                   current<span class="op">-&gt;</span>data<span class="op">.</span>if_stmt<span class="op">.</span>else_branch <span class="op">!=</span> NULL<span class="op">)</span> <span class="op">{</span></span>
<span id="cb25-163"><a href="#cb25-163" aria-hidden="true" tabindex="-1"></a>                current <span class="op">=</span> current<span class="op">-&gt;</span>data<span class="op">.</span>if_stmt<span class="op">.</span>else_branch<span class="op">;</span></span>
<span id="cb25-164"><a href="#cb25-164" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb25-165"><a href="#cb25-165" aria-hidden="true" tabindex="-1"></a>            current<span class="op">-&gt;</span>data<span class="op">.</span>if_stmt<span class="op">.</span>else_branch <span class="op">=</span> else_body<span class="op">;</span></span>
<span id="cb25-166"><a href="#cb25-166" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb25-167"><a href="#cb25-167" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb25-168"><a href="#cb25-168" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-169"><a href="#cb25-169" aria-hidden="true" tabindex="-1"></a>    ASTNode <span class="op">*</span>node <span class="op">=</span> ast_node_new<span class="op">(</span>AST_IF<span class="op">,</span> parser<span class="op">-&gt;</span>previous<span class="op">.</span>location<span class="op">);</span></span>
<span id="cb25-170"><a href="#cb25-170" aria-hidden="true" tabindex="-1"></a>    node<span class="op">-&gt;</span>data<span class="op">.</span>if_stmt<span class="op">.</span>condition <span class="op">=</span> condition<span class="op">;</span></span>
<span id="cb25-171"><a href="#cb25-171" aria-hidden="true" tabindex="-1"></a>    node<span class="op">-&gt;</span>data<span class="op">.</span>if_stmt<span class="op">.</span>then_branch <span class="op">=</span> then_branch<span class="op">;</span></span>
<span id="cb25-172"><a href="#cb25-172" aria-hidden="true" tabindex="-1"></a>    node<span class="op">-&gt;</span>data<span class="op">.</span>if_stmt<span class="op">.</span>else_branch <span class="op">=</span> else_branch<span class="op">;</span></span>
<span id="cb25-173"><a href="#cb25-173" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-174"><a href="#cb25-174" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> node<span class="op">;</span></span>
<span id="cb25-175"><a href="#cb25-175" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3>2.4.5 Block Parsing with Indentation</h3>
<div class="sourceCode" id="cb26"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> ASTNode<span class="op">*</span> block<span class="op">(</span>DyrParser <span class="op">*</span>parser<span class="op">)</span> <span class="op">{</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Expect INDENT token</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    consume<span class="op">(</span>parser<span class="op">,</span> TOK_INDENT<span class="op">,</span> <span class="st">&quot;Expected indented block&quot;</span><span class="op">);</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    ASTNode <span class="op">**</span>stmts <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> stmt_count <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> stmt_capacity <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(!</span>check<span class="op">(</span>parser<span class="op">,</span> TOK_DEDENT<span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="op">!</span>check<span class="op">(</span>parser<span class="op">,</span> TOK_EOF<span class="op">))</span> <span class="op">{</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>stmt_count <span class="op">&gt;=</span> stmt_capacity<span class="op">)</span> <span class="op">{</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>            stmt_capacity <span class="op">=</span> stmt_capacity <span class="op">==</span> <span class="dv">0</span> <span class="op">?</span> <span class="dv">8</span> <span class="op">:</span> stmt_capacity <span class="op">*</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>            stmts <span class="op">=</span> realloc<span class="op">(</span>stmts<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>ASTNode<span class="op">*)</span> <span class="op">*</span> stmt_capacity<span class="op">);</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>        ASTNode <span class="op">*</span>stmt <span class="op">=</span> statement<span class="op">(</span>parser<span class="op">);</span></span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>stmt <span class="op">!=</span> NULL<span class="op">)</span> <span class="op">{</span></span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>            stmts<span class="op">[</span>stmt_count<span class="op">++]</span> <span class="op">=</span> stmt<span class="op">;</span></span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>    consume<span class="op">(</span>parser<span class="op">,</span> TOK_DEDENT<span class="op">,</span> <span class="st">&quot;Expected dedent after block&quot;</span><span class="op">);</span></span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>    ASTNode <span class="op">*</span>node <span class="op">=</span> ast_node_new<span class="op">(</span>AST_BLOCK<span class="op">,</span> parser<span class="op">-&gt;</span>previous<span class="op">.</span>location<span class="op">);</span></span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>    node<span class="op">-&gt;</span>data<span class="op">.</span>block<span class="op">.</span>statements <span class="op">=</span> stmts<span class="op">;</span></span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a>    node<span class="op">-&gt;</span>data<span class="op">.</span>block<span class="op">.</span>stmt_count <span class="op">=</span> stmt_count<span class="op">;</span></span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> node<span class="op">;</span></span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>2.5 Error Recovery and Reporting</h2>
<p>Good error messages are crucial for usability:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span>      <span class="op">*</span>message<span class="op">;</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>    SourceLoc  location<span class="op">;</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    ErrorType  type<span class="op">;</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> ParseError<span class="op">;</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">enum</span> <span class="op">{</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>    ERROR_SYNTAX<span class="op">,</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>    ERROR_UNEXPECTED_TOKEN<span class="op">,</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>    ERROR_UNTERMINATED_STRING<span class="op">,</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>    ERROR_INVALID_NUMBER<span class="op">,</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>    ERROR_INDENTATION</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> ErrorType<span class="op">;</span></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> error_at<span class="op">(</span>DyrParser <span class="op">*</span>parser<span class="op">,</span> Token <span class="op">*</span>token<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>message<span class="op">)</span> <span class="op">{</span></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>parser<span class="op">-&gt;</span>panic_mode<span class="op">)</span> <span class="cf">return</span><span class="op">;</span></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>    parser<span class="op">-&gt;</span>panic_mode <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>    fprintf<span class="op">(</span>stderr<span class="op">,</span> <span class="st">&quot;</span><span class="sc">%s</span><span class="st">:</span><span class="sc">%zu</span><span class="st">:</span><span class="sc">%zu</span><span class="st">: error: </span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span></span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>            token<span class="op">-&gt;</span>location<span class="op">.</span>filename<span class="op">,</span></span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>            token<span class="op">-&gt;</span>location<span class="op">.</span>line<span class="op">,</span></span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>            token<span class="op">-&gt;</span>location<span class="op">.</span>column<span class="op">,</span></span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>            message<span class="op">);</span></span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Print source line</span></span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a>    print_source_line<span class="op">(</span>parser<span class="op">-&gt;</span>lexer<span class="op">-&gt;</span>source<span class="op">,</span> token<span class="op">-&gt;</span>location<span class="op">);</span></span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Print caret pointing to error</span></span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> token<span class="op">-&gt;</span>location<span class="op">.</span>column <span class="op">-</span> <span class="dv">1</span><span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a>        fputc<span class="op">(</span><span class="ch">&#39; &#39;</span><span class="op">,</span> stderr<span class="op">);</span></span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb27-32"><a href="#cb27-32" aria-hidden="true" tabindex="-1"></a>    fprintf<span class="op">(</span>stderr<span class="op">,</span> <span class="st">&quot;^</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb27-33"><a href="#cb27-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb27-34"><a href="#cb27-34" aria-hidden="true" tabindex="-1"></a>    parser<span class="op">-&gt;</span>had_error <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb27-35"><a href="#cb27-35" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb27-36"><a href="#cb27-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-37"><a href="#cb27-37" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> print_source_line<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>source<span class="op">,</span> SourceLoc location<span class="op">)</span> <span class="op">{</span></span>
<span id="cb27-38"><a href="#cb27-38" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Find start of line</span></span>
<span id="cb27-39"><a href="#cb27-39" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> line_start <span class="op">=</span> location<span class="op">.</span>offset<span class="op">;</span></span>
<span id="cb27-40"><a href="#cb27-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span>line_start <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">&amp;&amp;</span> source<span class="op">[</span>line_start <span class="op">-</span> <span class="dv">1</span><span class="op">]</span> <span class="op">!=</span> <span class="ch">&#39;</span><span class="sc">\n</span><span class="ch">&#39;</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb27-41"><a href="#cb27-41" aria-hidden="true" tabindex="-1"></a>        line_start<span class="op">--;</span></span>
<span id="cb27-42"><a href="#cb27-42" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb27-43"><a href="#cb27-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb27-44"><a href="#cb27-44" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Find end of line</span></span>
<span id="cb27-45"><a href="#cb27-45" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> line_end <span class="op">=</span> location<span class="op">.</span>offset<span class="op">;</span></span>
<span id="cb27-46"><a href="#cb27-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span>source<span class="op">[</span>line_end<span class="op">]</span> <span class="op">!=</span> <span class="ch">&#39;</span><span class="sc">\0</span><span class="ch">&#39;</span> <span class="op">&amp;&amp;</span> source<span class="op">[</span>line_end<span class="op">]</span> <span class="op">!=</span> <span class="ch">&#39;</span><span class="sc">\n</span><span class="ch">&#39;</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb27-47"><a href="#cb27-47" aria-hidden="true" tabindex="-1"></a>        line_end<span class="op">++;</span></span>
<span id="cb27-48"><a href="#cb27-48" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb27-49"><a href="#cb27-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb27-50"><a href="#cb27-50" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Print line</span></span>
<span id="cb27-51"><a href="#cb27-51" aria-hidden="true" tabindex="-1"></a>    fprintf<span class="op">(</span>stderr<span class="op">,</span> <span class="st">&quot;  &quot;</span><span class="op">);</span></span>
<span id="cb27-52"><a href="#cb27-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> line_start<span class="op">;</span> i <span class="op">&lt;</span> line_end<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb27-53"><a href="#cb27-53" aria-hidden="true" tabindex="-1"></a>        fputc<span class="op">(</span>source<span class="op">[</span>i<span class="op">],</span> stderr<span class="op">);</span></span>
<span id="cb27-54"><a href="#cb27-54" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb27-55"><a href="#cb27-55" aria-hidden="true" tabindex="-1"></a>    fprintf<span class="op">(</span>stderr<span class="op">,</span> <span class="st">&quot;</span><span class="sc">\n</span><span class="st">  &quot;</span><span class="op">);</span></span>
<span id="cb27-56"><a href="#cb27-56" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3>2.5.1 Common Error Patterns</h3>
<div class="sourceCode" id="cb28"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> error_expected_expression<span class="op">(</span>DyrParser <span class="op">*</span>parser<span class="op">)</span> <span class="op">{</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> <span class="op">(</span>parser<span class="op">-&gt;</span>current<span class="op">.</span>type<span class="op">)</span> <span class="op">{</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> TOK_SEMICOLON<span class="op">:</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>            error_at_current<span class="op">(</span>parser<span class="op">,</span> <span class="st">&quot;Expected expression before &#39;;&#39;&quot;</span><span class="op">);</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span><span class="op">;</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> TOK_RPAREN<span class="op">:</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>            error_at_current<span class="op">(</span>parser<span class="op">,</span> <span class="st">&quot;Expected expression before &#39;)&#39;&quot;</span><span class="op">);</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span><span class="op">;</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> TOK_RBRACKET<span class="op">:</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>            error_at_current<span class="op">(</span>parser<span class="op">,</span> <span class="st">&quot;Expected expression before &#39;]&#39;&quot;</span><span class="op">);</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span><span class="op">;</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">default</span><span class="op">:</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>            error_at_current<span class="op">(</span>parser<span class="op">,</span> <span class="st">&quot;Expected expression&quot;</span><span class="op">);</span></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> suggest_fix<span class="op">(</span>DyrParser <span class="op">*</span>parser<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>suggestion<span class="op">)</span> <span class="op">{</span></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>    fprintf<span class="op">(</span>stderr<span class="op">,</span> <span class="st">&quot;  note: </span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span> suggestion<span class="op">);</span></span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>2.6 Source Location Tracking</h2>
<p>Precise source location tracking enables good error messages and
debugging:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>filename<span class="op">;</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span>      line_start<span class="op">;</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span>      line_end<span class="op">;</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span>      col_start<span class="op">;</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span>      col_end<span class="op">;</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span>      offset_start<span class="op">;</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span>      offset_end<span class="op">;</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> SourceRange<span class="op">;</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> SourceRange merge_locations<span class="op">(</span>SourceLoc start<span class="op">,</span> SourceLoc end<span class="op">)</span> <span class="op">{</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">(</span>SourceRange<span class="op">){</span></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>filename <span class="op">=</span> start<span class="op">.</span>filename<span class="op">,</span></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>line_start <span class="op">=</span> start<span class="op">.</span>line<span class="op">,</span></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>line_end <span class="op">=</span> end<span class="op">.</span>line<span class="op">,</span></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>col_start <span class="op">=</span> start<span class="op">.</span>column<span class="op">,</span></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>col_end <span class="op">=</span> end<span class="op">.</span>column<span class="op">,</span></span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>offset_start <span class="op">=</span> start<span class="op">.</span>offset<span class="op">,</span></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>offset_end <span class="op">=</span> end<span class="op">.</span>offset</span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a><span class="co">// Attach location info to AST nodes</span></span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> ast_set_range<span class="op">(</span>ASTNode <span class="op">*</span>node<span class="op">,</span> SourceRange range<span class="op">)</span> <span class="op">{</span></span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>    node<span class="op">-&gt;</span>location <span class="op">=</span> range<span class="op">.</span>offset_start<span class="op">;</span>  <span class="co">// Store start for compatibility</span></span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a>    node<span class="op">-&gt;</span>source_range <span class="op">=</span> range<span class="op">;</span>           <span class="co">// Store full range</span></span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>2.7 String Interning</h2>
<p>String interning improves memory usage and comparison
performance:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> StringEntry <span class="op">{</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span>   <span class="op">*</span>string<span class="op">;</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span>  length<span class="op">;</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> hash<span class="op">;</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> StringEntry <span class="op">*</span>next<span class="op">;</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> StringEntry<span class="op">;</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>    StringEntry <span class="op">**</span>buckets<span class="op">;</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span>        capacity<span class="op">;</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span>        count<span class="op">;</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> StringTable<span class="op">;</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">uint32_t</span> hash_string<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>str<span class="op">,</span> <span class="dt">size_t</span> length<span class="op">)</span> <span class="op">{</span></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">// FNV-1a hash</span></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> hash <span class="op">=</span> <span class="dv">2166136261</span><span class="bu">u</span><span class="op">;</span></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> length<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>        hash <span class="op">^=</span> <span class="op">(</span><span class="dt">uint8_t</span><span class="op">)</span>str<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>        hash <span class="op">*=</span> <span class="dv">16777619</span><span class="op">;</span></span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> hash<span class="op">;</span></span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a><span class="dt">const</span> <span class="dt">char</span><span class="op">*</span> string_table_intern<span class="op">(</span>StringTable <span class="op">*</span>table<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>str<span class="op">,</span> <span class="dt">size_t</span> length<span class="op">)</span> <span class="op">{</span></span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> hash <span class="op">=</span> hash_string<span class="op">(</span>str<span class="op">,</span> length<span class="op">);</span></span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> index <span class="op">=</span> hash <span class="op">&amp;</span> <span class="op">(</span>table<span class="op">-&gt;</span>capacity <span class="op">-</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Search for existing string</span></span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a>    StringEntry <span class="op">*</span>entry <span class="op">=</span> table<span class="op">-&gt;</span>buckets<span class="op">[</span>index<span class="op">];</span></span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span>entry <span class="op">!=</span> NULL<span class="op">)</span> <span class="op">{</span></span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>entry<span class="op">-&gt;</span>length <span class="op">==</span> length <span class="op">&amp;&amp;</span> </span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a>            entry<span class="op">-&gt;</span>hash <span class="op">==</span> hash <span class="op">&amp;&amp;</span></span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a>            memcmp<span class="op">(</span>entry<span class="op">-&gt;</span>string<span class="op">,</span> str<span class="op">,</span> length<span class="op">)</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> entry<span class="op">-&gt;</span>string<span class="op">;</span></span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb30-36"><a href="#cb30-36" aria-hidden="true" tabindex="-1"></a>        entry <span class="op">=</span> entry<span class="op">-&gt;</span>next<span class="op">;</span></span>
<span id="cb30-37"><a href="#cb30-37" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb30-38"><a href="#cb30-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-39"><a href="#cb30-39" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Create new entry</span></span>
<span id="cb30-40"><a href="#cb30-40" aria-hidden="true" tabindex="-1"></a>    entry <span class="op">=</span> malloc<span class="op">(</span><span class="kw">sizeof</span><span class="op">(</span>StringEntry<span class="op">));</span></span>
<span id="cb30-41"><a href="#cb30-41" aria-hidden="true" tabindex="-1"></a>    entry<span class="op">-&gt;</span>string <span class="op">=</span> malloc<span class="op">(</span>length <span class="op">+</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb30-42"><a href="#cb30-42" aria-hidden="true" tabindex="-1"></a>    memcpy<span class="op">(</span>entry<span class="op">-&gt;</span>string<span class="op">,</span> str<span class="op">,</span> length<span class="op">);</span></span>
<span id="cb30-43"><a href="#cb30-43" aria-hidden="true" tabindex="-1"></a>    entry<span class="op">-&gt;</span>string<span class="op">[</span>length<span class="op">]</span> <span class="op">=</span> <span class="ch">&#39;</span><span class="sc">\0</span><span class="ch">&#39;</span><span class="op">;</span></span>
<span id="cb30-44"><a href="#cb30-44" aria-hidden="true" tabindex="-1"></a>    entry<span class="op">-&gt;</span>length <span class="op">=</span> length<span class="op">;</span></span>
<span id="cb30-45"><a href="#cb30-45" aria-hidden="true" tabindex="-1"></a>    entry<span class="op">-&gt;</span>hash <span class="op">=</span> hash<span class="op">;</span></span>
<span id="cb30-46"><a href="#cb30-46" aria-hidden="true" tabindex="-1"></a>    entry<span class="op">-&gt;</span>next <span class="op">=</span> table<span class="op">-&gt;</span>buckets<span class="op">[</span>index<span class="op">];</span></span>
<span id="cb30-47"><a href="#cb30-47" aria-hidden="true" tabindex="-1"></a>    table<span class="op">-&gt;</span>buckets<span class="op">[</span>index<span class="op">]</span> <span class="op">=</span> entry<span class="op">;</span></span>
<span id="cb30-48"><a href="#cb30-48" aria-hidden="true" tabindex="-1"></a>    table<span class="op">-&gt;</span>count<span class="op">++;</span></span>
<span id="cb30-49"><a href="#cb30-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-50"><a href="#cb30-50" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Resize if necessary</span></span>
<span id="cb30-51"><a href="#cb30-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>table<span class="op">-&gt;</span>count <span class="op">&gt;</span> table<span class="op">-&gt;</span>capacity <span class="op">*</span> <span class="fl">0.75</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb30-52"><a href="#cb30-52" aria-hidden="true" tabindex="-1"></a>        string_table_resize<span class="op">(</span>table<span class="op">);</span></span>
<span id="cb30-53"><a href="#cb30-53" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb30-54"><a href="#cb30-54" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-55"><a href="#cb30-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> entry<span class="op">-&gt;</span>string<span class="op">;</span></span>
<span id="cb30-56"><a href="#cb30-56" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>2.8 Integration with the Compiler Pipeline</h2>
<p>The parser produces an AST that subsequent phases can traverse:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>ASTNode<span class="op">*</span> dyr_parse<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>source<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>filename<span class="op">)</span> <span class="op">{</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>    DyrLexer <span class="op">*</span>lexer <span class="op">=</span> dyr_lexer_new<span class="op">(</span>source<span class="op">,</span> strlen<span class="op">(</span>source<span class="op">),</span> filename<span class="op">);</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    DyrParser <span class="op">*</span>parser <span class="op">=</span> dyr_parser_new<span class="op">(</span>lexer<span class="op">);</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    ASTNode <span class="op">*</span>program <span class="op">=</span> ast_node_new<span class="op">(</span>AST_PROGRAM<span class="op">,</span> <span class="op">(</span>SourceLoc<span class="op">){</span>filename<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">});</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Parse top-level statements</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>    ASTNode <span class="op">**</span>stmts <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> stmt_count <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> stmt_capacity <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(!</span>check<span class="op">(</span>parser<span class="op">,</span> TOK_EOF<span class="op">))</span> <span class="op">{</span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Skip blank lines at top level</span></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>match<span class="op">(</span>parser<span class="op">,</span> TOK_NEWLINE<span class="op">))</span> <span class="op">{</span></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>stmt_count <span class="op">&gt;=</span> stmt_capacity<span class="op">)</span> <span class="op">{</span></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>            stmt_capacity <span class="op">=</span> stmt_capacity <span class="op">==</span> <span class="dv">0</span> <span class="op">?</span> <span class="dv">16</span> <span class="op">:</span> stmt_capacity <span class="op">*</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>            stmts <span class="op">=</span> realloc<span class="op">(</span>stmts<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>ASTNode<span class="op">*)</span> <span class="op">*</span> stmt_capacity<span class="op">);</span></span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a>        ASTNode <span class="op">*</span>stmt <span class="op">=</span> statement<span class="op">(</span>parser<span class="op">);</span></span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>stmt <span class="op">!=</span> NULL<span class="op">)</span> <span class="op">{</span></span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a>            stmts<span class="op">[</span>stmt_count<span class="op">++]</span> <span class="op">=</span> stmt<span class="op">;</span></span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>parser<span class="op">-&gt;</span>panic_mode<span class="op">)</span> <span class="op">{</span></span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a>            synchronize<span class="op">(</span>parser<span class="op">);</span></span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a>    program<span class="op">-&gt;</span>data<span class="op">.</span>block<span class="op">.</span>statements <span class="op">=</span> stmts<span class="op">;</span></span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a>    program<span class="op">-&gt;</span>data<span class="op">.</span>block<span class="op">.</span>stmt_count <span class="op">=</span> stmt_count<span class="op">;</span></span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a>    dyr_parser_free<span class="op">(</span>parser<span class="op">);</span></span>
<span id="cb31-37"><a href="#cb31-37" aria-hidden="true" tabindex="-1"></a>    dyr_lexer_free<span class="op">(</span>lexer<span class="op">);</span></span>
<span id="cb31-38"><a href="#cb31-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-39"><a href="#cb31-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> parser<span class="op">-&gt;</span>had_error <span class="op">?</span> NULL <span class="op">:</span> program<span class="op">;</span></span>
<span id="cb31-40"><a href="#cb31-40" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>2.9 Performance Optimizations</h2>
<p>Several techniques improve lexer and parser performance:</p>
<h3>2.9.1 Token Buffering</h3>
<div class="sourceCode" id="cb32"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Buffer tokens for lookahead without re-lexing</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> lexer_buffer_token<span class="op">(</span>DyrLexer <span class="op">*</span>lexer<span class="op">,</span> Token token<span class="op">)</span> <span class="op">{</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>lexer<span class="op">-&gt;</span>buffer_size <span class="op">&gt;=</span> lexer<span class="op">-&gt;</span>buffer_capacity<span class="op">)</span> <span class="op">{</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>        lexer<span class="op">-&gt;</span>buffer_capacity <span class="op">*=</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>        lexer<span class="op">-&gt;</span>token_buffer <span class="op">=</span> realloc<span class="op">(</span>lexer<span class="op">-&gt;</span>token_buffer<span class="op">,</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>            <span class="kw">sizeof</span><span class="op">(</span>Token<span class="op">)</span> <span class="op">*</span> lexer<span class="op">-&gt;</span>buffer_capacity<span class="op">);</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>    lexer<span class="op">-&gt;</span>token_buffer<span class="op">[</span>lexer<span class="op">-&gt;</span>buffer_size<span class="op">++]</span> <span class="op">=</span> token<span class="op">;</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>Token lexer_peek_ahead<span class="op">(</span>DyrLexer <span class="op">*</span>lexer<span class="op">,</span> <span class="dt">size_t</span> n<span class="op">)</span> <span class="op">{</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span>lexer<span class="op">-&gt;</span>buffer_size <span class="op">&lt;=</span> n<span class="op">)</span> <span class="op">{</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>        Token tok <span class="op">=</span> lex_token_internal<span class="op">(</span>lexer<span class="op">);</span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>        lexer_buffer_token<span class="op">(</span>lexer<span class="op">,</span> tok<span class="op">);</span></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> lexer<span class="op">-&gt;</span>token_buffer<span class="op">[</span>lexer<span class="op">-&gt;</span>buffer_size <span class="op">-</span> n <span class="op">-</span> <span class="dv">1</span><span class="op">];</span></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3>2.9.2 Keyword Perfect Hashing</h3>
<div class="sourceCode" id="cb33"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Generated perfect hash function for keywords</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">int</span> keyword_hash<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>str<span class="op">,</span> <span class="dt">size_t</span> len<span class="op">)</span> <span class="op">{</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>len <span class="op">&lt;</span> <span class="dv">2</span> <span class="op">||</span> len <span class="op">&gt;</span> <span class="dv">8</span><span class="op">)</span> <span class="cf">return</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Minimal perfect hash for Diyrbal keywords</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">unsigned</span> h <span class="op">=</span> len<span class="op">;</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>    h <span class="op">^=</span> str<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">-</span> <span class="ch">&#39;a&#39;</span><span class="op">;</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>    h <span class="op">^=</span> <span class="op">(</span>str<span class="op">[</span>len<span class="op">-</span><span class="dv">1</span><span class="op">]</span> <span class="op">-</span> <span class="ch">&#39;a&#39;</span><span class="op">)</span> <span class="op">&lt;&lt;</span> <span class="dv">4</span><span class="op">;</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> h <span class="op">%</span> KEYWORD_TABLE_SIZE<span class="op">;</span></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> TokenType lookup_keyword<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>str<span class="op">,</span> <span class="dt">size_t</span> len<span class="op">)</span> <span class="op">{</span></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> index <span class="op">=</span> keyword_hash<span class="op">(</span>str<span class="op">,</span> len<span class="op">);</span></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>index <span class="op">&lt;</span> <span class="dv">0</span><span class="op">)</span> <span class="cf">return</span> TOK_IDENT<span class="op">;</span></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>    <span class="dt">const</span> KeywordEntry <span class="op">*</span>entry <span class="op">=</span> <span class="op">&amp;</span>keyword_table<span class="op">[</span>index<span class="op">];</span></span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>entry<span class="op">-&gt;</span>length <span class="op">==</span> len <span class="op">&amp;&amp;</span> memcmp<span class="op">(</span>entry<span class="op">-&gt;</span>text<span class="op">,</span> str<span class="op">,</span> len<span class="op">)</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> entry<span class="op">-&gt;</span>type<span class="op">;</span></span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> TOK_IDENT<span class="op">;</span></span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>2.10 Summary</h2>
<p>The lexer and parser form the foundation of Diyrbal&#39;s implementation.
By carefully handling indentation, providing excellent error messages,
and building a clean AST representation, we set the stage for successful
compilation. The use of string interning, efficient keyword lookup, and
careful memory management ensures good performance even for large source
files.</p>
<p>Key takeaways:</p>
<ul>
<li>Hand-written lexers and parsers provide flexibility and control</li>
<li>Indentation-based syntax requires careful state management</li>
<li>Good error messages require tracking source locations precisely</li>
<li>String interning saves memory and speeds up comparisons</li>
<li>Recursive descent parsing with Pratt parsing for expressions is
simple and efficient</li>
</ul>
<p>The next chapter will explore how we perform semantic analysis on the
AST, including type checking and symbol resolution.</p>
<h2>2.11 Exercises</h2>
<ol type="1">
<li><p>Extend the lexer to support raw strings (r&quot;...&quot;) and bytes
literals (b&quot;...&quot;).</p></li>
<li><p>Implement Unicode support in the lexer, handling UTF-8 encoded
source files correctly.</p></li>
<li><p>Add support for nested comments (/* ... /* ... */ ... */) to the
lexer.</p></li>
<li><p>Implement a pretty-printer that takes an AST and outputs
formatted Diyrbal source code.</p></li>
<li><p>Design and implement error recovery for common syntax errors like
missing colons after if statements.</p></li>
<li><p>Profile the lexer and parser on a large source file. Identify
bottlenecks and optimize them.</p></li>
<li><p>Implement incremental lexing that can efficiently re-lex only
changed portions of a file.</p></li>
</ol>
<h1>Chapter 3: Semantic Analysis and Type System</h1>
<h2>3.1 Introduction</h2>
<p>After parsing produces an Abstract Syntax Tree, semantic analysis
transforms this syntactic representation into a semantically valid
program. This phase performs crucial validations and
transformations:</p>
<ul>
<li><strong>Name Resolution</strong>: Binding identifiers to their
declarations</li>
<li><strong>Type Checking</strong>: Ensuring type safety throughout the
program</li>
<li><strong>Constant Folding</strong>: Evaluating compile-time
constants</li>
<li><strong>Semantic Validation</strong>: Checking language-specific
rules (e.g., return statements in functions)</li>
</ul>
<p>Diyrbal employs a gradual type system that combines the flexibility
of dynamic typing with the safety of static typing where desired. This
chapter details the implementation of semantic analysis, focusing on
practical techniques for building a robust type checker.</p>
<h2>3.2 Type System Design</h2>
<p>Diyrbal&#39;s type system supports both primitive and composite
types:</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">enum</span> <span class="op">{</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>    TYPE_UNKNOWN<span class="op">,</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>    TYPE_ANY<span class="op">,</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>    TYPE_VOID<span class="op">,</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>    TYPE_NULL<span class="op">,</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>    TYPE_BOOL<span class="op">,</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>    TYPE_INT<span class="op">,</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>    TYPE_FLOAT<span class="op">,</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>    TYPE_STRING<span class="op">,</span></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>    TYPE_ARRAY<span class="op">,</span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>    TYPE_DICT<span class="op">,</span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>    TYPE_FUNCTION<span class="op">,</span></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>    TYPE_CLASS<span class="op">,</span></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>    TYPE_INSTANCE<span class="op">,</span></span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>    TYPE_MODULE<span class="op">,</span></span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>    TYPE_UNION<span class="op">,</span></span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>    TYPE_GENERIC<span class="op">,</span></span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>    TYPE_ERROR</span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> TypeKind<span class="op">;</span></span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> Type <span class="op">{</span></span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>    TypeKind kind<span class="op">;</span></span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">union</span> <span class="op">{</span></span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Array type</span></span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a>        <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a>            <span class="kw">struct</span> Type <span class="op">*</span>element_type<span class="op">;</span></span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> array<span class="op">;</span></span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Dictionary type</span></span>
<span id="cb34-30"><a href="#cb34-30" aria-hidden="true" tabindex="-1"></a>        <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb34-31"><a href="#cb34-31" aria-hidden="true" tabindex="-1"></a>            <span class="kw">struct</span> Type <span class="op">*</span>key_type<span class="op">;</span></span>
<span id="cb34-32"><a href="#cb34-32" aria-hidden="true" tabindex="-1"></a>            <span class="kw">struct</span> Type <span class="op">*</span>value_type<span class="op">;</span></span>
<span id="cb34-33"><a href="#cb34-33" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> dict<span class="op">;</span></span>
<span id="cb34-34"><a href="#cb34-34" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb34-35"><a href="#cb34-35" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Function type</span></span>
<span id="cb34-36"><a href="#cb34-36" aria-hidden="true" tabindex="-1"></a>        <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb34-37"><a href="#cb34-37" aria-hidden="true" tabindex="-1"></a>            <span class="kw">struct</span> Type <span class="op">**</span>param_types<span class="op">;</span></span>
<span id="cb34-38"><a href="#cb34-38" aria-hidden="true" tabindex="-1"></a>            <span class="dt">size_t</span> param_count<span class="op">;</span></span>
<span id="cb34-39"><a href="#cb34-39" aria-hidden="true" tabindex="-1"></a>            <span class="kw">struct</span> Type <span class="op">*</span>return_type<span class="op">;</span></span>
<span id="cb34-40"><a href="#cb34-40" aria-hidden="true" tabindex="-1"></a>            <span class="dt">bool</span> is_varargs<span class="op">;</span></span>
<span id="cb34-41"><a href="#cb34-41" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> function<span class="op">;</span></span>
<span id="cb34-42"><a href="#cb34-42" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb34-43"><a href="#cb34-43" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Class type</span></span>
<span id="cb34-44"><a href="#cb34-44" aria-hidden="true" tabindex="-1"></a>        <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb34-45"><a href="#cb34-45" aria-hidden="true" tabindex="-1"></a>            <span class="dt">char</span> <span class="op">*</span>name<span class="op">;</span></span>
<span id="cb34-46"><a href="#cb34-46" aria-hidden="true" tabindex="-1"></a>            <span class="kw">struct</span> ClassDef <span class="op">*</span>class_def<span class="op">;</span></span>
<span id="cb34-47"><a href="#cb34-47" aria-hidden="true" tabindex="-1"></a>            <span class="kw">struct</span> Type <span class="op">*</span>base_type<span class="op">;</span></span>
<span id="cb34-48"><a href="#cb34-48" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> class<span class="op">;</span></span>
<span id="cb34-49"><a href="#cb34-49" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb34-50"><a href="#cb34-50" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Instance type</span></span>
<span id="cb34-51"><a href="#cb34-51" aria-hidden="true" tabindex="-1"></a>        <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb34-52"><a href="#cb34-52" aria-hidden="true" tabindex="-1"></a>            <span class="kw">struct</span> Type <span class="op">*</span>class_type<span class="op">;</span></span>
<span id="cb34-53"><a href="#cb34-53" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> instance<span class="op">;</span></span>
<span id="cb34-54"><a href="#cb34-54" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb34-55"><a href="#cb34-55" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Union type (for gradual typing)</span></span>
<span id="cb34-56"><a href="#cb34-56" aria-hidden="true" tabindex="-1"></a>        <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb34-57"><a href="#cb34-57" aria-hidden="true" tabindex="-1"></a>            <span class="kw">struct</span> Type <span class="op">**</span>types<span class="op">;</span></span>
<span id="cb34-58"><a href="#cb34-58" aria-hidden="true" tabindex="-1"></a>            <span class="dt">size_t</span> type_count<span class="op">;</span></span>
<span id="cb34-59"><a href="#cb34-59" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> union_type<span class="op">;</span></span>
<span id="cb34-60"><a href="#cb34-60" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb34-61"><a href="#cb34-61" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Generic type parameter</span></span>
<span id="cb34-62"><a href="#cb34-62" aria-hidden="true" tabindex="-1"></a>        <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb34-63"><a href="#cb34-63" aria-hidden="true" tabindex="-1"></a>            <span class="dt">char</span> <span class="op">*</span>name<span class="op">;</span></span>
<span id="cb34-64"><a href="#cb34-64" aria-hidden="true" tabindex="-1"></a>            <span class="dt">size_t</span> id<span class="op">;</span></span>
<span id="cb34-65"><a href="#cb34-65" aria-hidden="true" tabindex="-1"></a>            <span class="kw">struct</span> Type <span class="op">*</span>constraint<span class="op">;</span></span>
<span id="cb34-66"><a href="#cb34-66" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> generic<span class="op">;</span></span>
<span id="cb34-67"><a href="#cb34-67" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> data<span class="op">;</span></span>
<span id="cb34-68"><a href="#cb34-68" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-69"><a href="#cb34-69" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Type flags</span></span>
<span id="cb34-70"><a href="#cb34-70" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> is_nullable<span class="op">;</span></span>
<span id="cb34-71"><a href="#cb34-71" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> is_mutable<span class="op">;</span></span>
<span id="cb34-72"><a href="#cb34-72" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> Type<span class="op">;</span></span></code></pre></div>
<h3>3.2.1 Type Creation and Interning</h3>
<p>Types are interned to save memory and enable fast comparison:</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> TypeTable <span class="op">{</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>    Type <span class="op">**</span>buckets<span class="op">;</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> capacity<span class="op">;</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> count<span class="op">;</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Preallocated common types</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>    Type <span class="op">*</span>type_any<span class="op">;</span></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>    Type <span class="op">*</span>type_void<span class="op">;</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>    Type <span class="op">*</span>type_null<span class="op">;</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>    Type <span class="op">*</span>type_bool<span class="op">;</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>    Type <span class="op">*</span>type_int<span class="op">;</span></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>    Type <span class="op">*</span>type_float<span class="op">;</span></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>    Type <span class="op">*</span>type_string<span class="op">;</span></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> TypeTable<span class="op">;</span></span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> TypeTable <span class="op">*</span>global_type_table<span class="op">;</span></span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> init_type_system<span class="op">(</span><span class="dt">void</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>    global_type_table <span class="op">=</span> calloc<span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>TypeTable<span class="op">));</span></span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>    global_type_table<span class="op">-&gt;</span>capacity <span class="op">=</span> <span class="dv">256</span><span class="op">;</span></span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>    global_type_table<span class="op">-&gt;</span>buckets <span class="op">=</span> calloc<span class="op">(</span><span class="dv">256</span><span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>Type<span class="op">*));</span></span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Create primitive types</span></span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>    global_type_table<span class="op">-&gt;</span>type_any <span class="op">=</span> make_primitive_type<span class="op">(</span>TYPE_ANY<span class="op">);</span></span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a>    global_type_table<span class="op">-&gt;</span>type_void <span class="op">=</span> make_primitive_type<span class="op">(</span>TYPE_VOID<span class="op">);</span></span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a>    global_type_table<span class="op">-&gt;</span>type_null <span class="op">=</span> make_primitive_type<span class="op">(</span>TYPE_NULL<span class="op">);</span></span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a>    global_type_table<span class="op">-&gt;</span>type_bool <span class="op">=</span> make_primitive_type<span class="op">(</span>TYPE_BOOL<span class="op">);</span></span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a>    global_type_table<span class="op">-&gt;</span>type_int <span class="op">=</span> make_primitive_type<span class="op">(</span>TYPE_INT<span class="op">);</span></span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a>    global_type_table<span class="op">-&gt;</span>type_float <span class="op">=</span> make_primitive_type<span class="op">(</span>TYPE_FLOAT<span class="op">);</span></span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a>    global_type_table<span class="op">-&gt;</span>type_string <span class="op">=</span> make_primitive_type<span class="op">(</span>TYPE_STRING<span class="op">);</span></span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb35-32"><a href="#cb35-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-33"><a href="#cb35-33" aria-hidden="true" tabindex="-1"></a>Type<span class="op">*</span> type_intern<span class="op">(</span>Type <span class="op">*</span>type<span class="op">)</span> <span class="op">{</span></span>
<span id="cb35-34"><a href="#cb35-34" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> hash <span class="op">=</span> hash_type<span class="op">(</span>type<span class="op">);</span></span>
<span id="cb35-35"><a href="#cb35-35" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> index <span class="op">=</span> hash <span class="op">&amp;</span> <span class="op">(</span>global_type_table<span class="op">-&gt;</span>capacity <span class="op">-</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb35-36"><a href="#cb35-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-37"><a href="#cb35-37" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Search for existing type</span></span>
<span id="cb35-38"><a href="#cb35-38" aria-hidden="true" tabindex="-1"></a>    Type <span class="op">*</span>existing <span class="op">=</span> global_type_table<span class="op">-&gt;</span>buckets<span class="op">[</span>index<span class="op">];</span></span>
<span id="cb35-39"><a href="#cb35-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span>existing<span class="op">)</span> <span class="op">{</span></span>
<span id="cb35-40"><a href="#cb35-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>types_equal<span class="op">(</span>existing<span class="op">,</span> type<span class="op">))</span> <span class="op">{</span></span>
<span id="cb35-41"><a href="#cb35-41" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> existing<span class="op">;</span></span>
<span id="cb35-42"><a href="#cb35-42" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb35-43"><a href="#cb35-43" aria-hidden="true" tabindex="-1"></a>        existing <span class="op">=</span> existing<span class="op">-&gt;</span>next<span class="op">;</span></span>
<span id="cb35-44"><a href="#cb35-44" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb35-45"><a href="#cb35-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-46"><a href="#cb35-46" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Add new type</span></span>
<span id="cb35-47"><a href="#cb35-47" aria-hidden="true" tabindex="-1"></a>    type<span class="op">-&gt;</span>next <span class="op">=</span> global_type_table<span class="op">-&gt;</span>buckets<span class="op">[</span>index<span class="op">];</span></span>
<span id="cb35-48"><a href="#cb35-48" aria-hidden="true" tabindex="-1"></a>    global_type_table<span class="op">-&gt;</span>buckets<span class="op">[</span>index<span class="op">]</span> <span class="op">=</span> type<span class="op">;</span></span>
<span id="cb35-49"><a href="#cb35-49" aria-hidden="true" tabindex="-1"></a>    global_type_table<span class="op">-&gt;</span>count<span class="op">++;</span></span>
<span id="cb35-50"><a href="#cb35-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-51"><a href="#cb35-51" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Resize if necessary</span></span>
<span id="cb35-52"><a href="#cb35-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>global_type_table<span class="op">-&gt;</span>count <span class="op">&gt;</span> global_type_table<span class="op">-&gt;</span>capacity <span class="op">*</span> <span class="fl">0.75</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb35-53"><a href="#cb35-53" aria-hidden="true" tabindex="-1"></a>        resize_type_table<span class="op">();</span></span>
<span id="cb35-54"><a href="#cb35-54" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb35-55"><a href="#cb35-55" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-56"><a href="#cb35-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> type<span class="op">;</span></span>
<span id="cb35-57"><a href="#cb35-57" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>3.3 Symbol Tables and Scoping</h2>
<p>Symbol tables track variable bindings and their types:</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">enum</span> <span class="op">{</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>    SYMBOL_VARIABLE<span class="op">,</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>    SYMBOL_FUNCTION<span class="op">,</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>    SYMBOL_CLASS<span class="op">,</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>    SYMBOL_MODULE<span class="op">,</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>    SYMBOL_PARAMETER<span class="op">,</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>    SYMBOL_TYPE_PARAM</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> SymbolKind<span class="op">;</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> Symbol <span class="op">{</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span>name<span class="op">;</span></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>    SymbolKind kind<span class="op">;</span></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>    Type <span class="op">*</span>type<span class="op">;</span></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Symbol flags</span></span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> is_global<span class="op">;</span></span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> is_nonlocal<span class="op">;</span></span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> is_constant<span class="op">;</span></span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> is_initialized<span class="op">;</span></span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Definition location</span></span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a>    SourceLoc location<span class="op">;</span></span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Scope information</span></span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> scope_level<span class="op">;</span></span>
<span id="cb36-26"><a href="#cb36-26" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> declaration_order<span class="op">;</span></span>
<span id="cb36-27"><a href="#cb36-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb36-28"><a href="#cb36-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Storage information (for code generation)</span></span>
<span id="cb36-29"><a href="#cb36-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">union</span> <span class="op">{</span></span>
<span id="cb36-30"><a href="#cb36-30" aria-hidden="true" tabindex="-1"></a>        <span class="dt">size_t</span> local_index<span class="op">;</span></span>
<span id="cb36-31"><a href="#cb36-31" aria-hidden="true" tabindex="-1"></a>        <span class="dt">size_t</span> global_index<span class="op">;</span></span>
<span id="cb36-32"><a href="#cb36-32" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> storage<span class="op">;</span></span>
<span id="cb36-33"><a href="#cb36-33" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> Symbol<span class="op">;</span></span>
<span id="cb36-34"><a href="#cb36-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-35"><a href="#cb36-35" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> Scope <span class="op">{</span></span>
<span id="cb36-36"><a href="#cb36-36" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> Scope <span class="op">*</span>parent<span class="op">;</span></span>
<span id="cb36-37"><a href="#cb36-37" aria-hidden="true" tabindex="-1"></a>    HashTable <span class="op">*</span>symbols<span class="op">;</span></span>
<span id="cb36-38"><a href="#cb36-38" aria-hidden="true" tabindex="-1"></a>    ScopeKind kind<span class="op">;</span></span>
<span id="cb36-39"><a href="#cb36-39" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> level<span class="op">;</span></span>
<span id="cb36-40"><a href="#cb36-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb36-41"><a href="#cb36-41" aria-hidden="true" tabindex="-1"></a>    <span class="co">// For function scopes</span></span>
<span id="cb36-42"><a href="#cb36-42" aria-hidden="true" tabindex="-1"></a>    Type <span class="op">*</span>return_type<span class="op">;</span></span>
<span id="cb36-43"><a href="#cb36-43" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> has_return<span class="op">;</span></span>
<span id="cb36-44"><a href="#cb36-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb36-45"><a href="#cb36-45" aria-hidden="true" tabindex="-1"></a>    <span class="co">// For loop scopes</span></span>
<span id="cb36-46"><a href="#cb36-46" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> in_loop<span class="op">;</span></span>
<span id="cb36-47"><a href="#cb36-47" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb36-48"><a href="#cb36-48" aria-hidden="true" tabindex="-1"></a>    <span class="co">// For class scopes</span></span>
<span id="cb36-49"><a href="#cb36-49" aria-hidden="true" tabindex="-1"></a>    Type <span class="op">*</span>class_type<span class="op">;</span></span>
<span id="cb36-50"><a href="#cb36-50" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> Scope<span class="op">;</span></span>
<span id="cb36-51"><a href="#cb36-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-52"><a href="#cb36-52" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">enum</span> <span class="op">{</span></span>
<span id="cb36-53"><a href="#cb36-53" aria-hidden="true" tabindex="-1"></a>    SCOPE_GLOBAL<span class="op">,</span></span>
<span id="cb36-54"><a href="#cb36-54" aria-hidden="true" tabindex="-1"></a>    SCOPE_FUNCTION<span class="op">,</span></span>
<span id="cb36-55"><a href="#cb36-55" aria-hidden="true" tabindex="-1"></a>    SCOPE_CLASS<span class="op">,</span></span>
<span id="cb36-56"><a href="#cb36-56" aria-hidden="true" tabindex="-1"></a>    SCOPE_BLOCK<span class="op">,</span></span>
<span id="cb36-57"><a href="#cb36-57" aria-hidden="true" tabindex="-1"></a>    SCOPE_LOOP</span>
<span id="cb36-58"><a href="#cb36-58" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> ScopeKind<span class="op">;</span></span>
<span id="cb36-59"><a href="#cb36-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-60"><a href="#cb36-60" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb36-61"><a href="#cb36-61" aria-hidden="true" tabindex="-1"></a>    Scope <span class="op">*</span>current<span class="op">;</span></span>
<span id="cb36-62"><a href="#cb36-62" aria-hidden="true" tabindex="-1"></a>    Scope <span class="op">*</span>global<span class="op">;</span></span>
<span id="cb36-63"><a href="#cb36-63" aria-hidden="true" tabindex="-1"></a>    ErrorList <span class="op">*</span>errors<span class="op">;</span></span>
<span id="cb36-64"><a href="#cb36-64" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb36-65"><a href="#cb36-65" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Type inference state</span></span>
<span id="cb36-66"><a href="#cb36-66" aria-hidden="true" tabindex="-1"></a>    TypeConstraints <span class="op">*</span>constraints<span class="op">;</span></span>
<span id="cb36-67"><a href="#cb36-67" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb36-68"><a href="#cb36-68" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Current function being analyzed</span></span>
<span id="cb36-69"><a href="#cb36-69" aria-hidden="true" tabindex="-1"></a>    Symbol <span class="op">*</span>current_function<span class="op">;</span></span>
<span id="cb36-70"><a href="#cb36-70" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb36-71"><a href="#cb36-71" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Current class being analyzed</span></span>
<span id="cb36-72"><a href="#cb36-72" aria-hidden="true" tabindex="-1"></a>    Symbol <span class="op">*</span>current_class<span class="op">;</span></span>
<span id="cb36-73"><a href="#cb36-73" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> SemanticAnalyzer<span class="op">;</span></span></code></pre></div>
<h3>3.3.1 Scope Management</h3>
<div class="sourceCode" id="cb37"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> Scope<span class="op">*</span> push_scope<span class="op">(</span>SemanticAnalyzer <span class="op">*</span>analyzer<span class="op">,</span> ScopeKind kind<span class="op">)</span> <span class="op">{</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>    Scope <span class="op">*</span>scope <span class="op">=</span> calloc<span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>Scope<span class="op">));</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>    scope<span class="op">-&gt;</span>parent <span class="op">=</span> analyzer<span class="op">-&gt;</span>current<span class="op">;</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>    scope<span class="op">-&gt;</span>symbols <span class="op">=</span> hash_table_new<span class="op">();</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>    scope<span class="op">-&gt;</span>kind <span class="op">=</span> kind<span class="op">;</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>    scope<span class="op">-&gt;</span>level <span class="op">=</span> analyzer<span class="op">-&gt;</span>current <span class="op">?</span> analyzer<span class="op">-&gt;</span>current<span class="op">-&gt;</span>level <span class="op">+</span> <span class="dv">1</span> <span class="op">:</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>analyzer<span class="op">-&gt;</span>current<span class="op">)</span> <span class="op">{</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>        scope<span class="op">-&gt;</span>in_loop <span class="op">=</span> analyzer<span class="op">-&gt;</span>current<span class="op">-&gt;</span>in_loop<span class="op">;</span></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>        scope<span class="op">-&gt;</span>class_type <span class="op">=</span> analyzer<span class="op">-&gt;</span>current<span class="op">-&gt;</span>class_type<span class="op">;</span></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>    analyzer<span class="op">-&gt;</span>current <span class="op">=</span> scope<span class="op">;</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> scope<span class="op">;</span></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> pop_scope<span class="op">(</span>SemanticAnalyzer <span class="op">*</span>analyzer<span class="op">)</span> <span class="op">{</span></span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>    analyzer<span class="op">-&gt;</span>current <span class="op">=</span> analyzer<span class="op">-&gt;</span>current<span class="op">-&gt;</span>parent<span class="op">;</span></span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> Symbol<span class="op">*</span> define_symbol<span class="op">(</span>SemanticAnalyzer <span class="op">*</span>analyzer<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>name<span class="op">,</span> </span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a>                           SymbolKind kind<span class="op">,</span> Type <span class="op">*</span>type<span class="op">,</span> SourceLoc loc<span class="op">)</span> <span class="op">{</span></span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check for redefinition in current scope</span></span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>hash_table_get<span class="op">(</span>analyzer<span class="op">-&gt;</span>current<span class="op">-&gt;</span>symbols<span class="op">,</span> name<span class="op">))</span> <span class="op">{</span></span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a>        semantic_error<span class="op">(</span>analyzer<span class="op">,</span> loc<span class="op">,</span> </span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;Variable &#39;</span><span class="sc">%s</span><span class="st">&#39; already defined in this scope&quot;</span><span class="op">,</span> name<span class="op">);</span></span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> NULL<span class="op">;</span></span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb37-29"><a href="#cb37-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-30"><a href="#cb37-30" aria-hidden="true" tabindex="-1"></a>    Symbol <span class="op">*</span>symbol <span class="op">=</span> calloc<span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>Symbol<span class="op">));</span></span>
<span id="cb37-31"><a href="#cb37-31" aria-hidden="true" tabindex="-1"></a>    symbol<span class="op">-&gt;</span>name <span class="op">=</span> strdup<span class="op">(</span>name<span class="op">);</span></span>
<span id="cb37-32"><a href="#cb37-32" aria-hidden="true" tabindex="-1"></a>    symbol<span class="op">-&gt;</span>kind <span class="op">=</span> kind<span class="op">;</span></span>
<span id="cb37-33"><a href="#cb37-33" aria-hidden="true" tabindex="-1"></a>    symbol<span class="op">-&gt;</span>type <span class="op">=</span> type<span class="op">;</span></span>
<span id="cb37-34"><a href="#cb37-34" aria-hidden="true" tabindex="-1"></a>    symbol<span class="op">-&gt;</span>location <span class="op">=</span> loc<span class="op">;</span></span>
<span id="cb37-35"><a href="#cb37-35" aria-hidden="true" tabindex="-1"></a>    symbol<span class="op">-&gt;</span>scope_level <span class="op">=</span> analyzer<span class="op">-&gt;</span>current<span class="op">-&gt;</span>level<span class="op">;</span></span>
<span id="cb37-36"><a href="#cb37-36" aria-hidden="true" tabindex="-1"></a>    symbol<span class="op">-&gt;</span>is_global <span class="op">=</span> analyzer<span class="op">-&gt;</span>current<span class="op">-&gt;</span>kind <span class="op">==</span> SCOPE_GLOBAL<span class="op">;</span></span>
<span id="cb37-37"><a href="#cb37-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-38"><a href="#cb37-38" aria-hidden="true" tabindex="-1"></a>    hash_table_put<span class="op">(</span>analyzer<span class="op">-&gt;</span>current<span class="op">-&gt;</span>symbols<span class="op">,</span> name<span class="op">,</span> symbol<span class="op">);</span></span>
<span id="cb37-39"><a href="#cb37-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> symbol<span class="op">;</span></span>
<span id="cb37-40"><a href="#cb37-40" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb37-41"><a href="#cb37-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-42"><a href="#cb37-42" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> Symbol<span class="op">*</span> resolve_symbol<span class="op">(</span>SemanticAnalyzer <span class="op">*</span>analyzer<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>name<span class="op">)</span> <span class="op">{</span></span>
<span id="cb37-43"><a href="#cb37-43" aria-hidden="true" tabindex="-1"></a>    Scope <span class="op">*</span>scope <span class="op">=</span> analyzer<span class="op">-&gt;</span>current<span class="op">;</span></span>
<span id="cb37-44"><a href="#cb37-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-45"><a href="#cb37-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span>scope<span class="op">)</span> <span class="op">{</span></span>
<span id="cb37-46"><a href="#cb37-46" aria-hidden="true" tabindex="-1"></a>        Symbol <span class="op">*</span>symbol <span class="op">=</span> hash_table_get<span class="op">(</span>scope<span class="op">-&gt;</span>symbols<span class="op">,</span> name<span class="op">);</span></span>
<span id="cb37-47"><a href="#cb37-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>symbol<span class="op">)</span> <span class="op">{</span></span>
<span id="cb37-48"><a href="#cb37-48" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> symbol<span class="op">;</span></span>
<span id="cb37-49"><a href="#cb37-49" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb37-50"><a href="#cb37-50" aria-hidden="true" tabindex="-1"></a>        scope <span class="op">=</span> scope<span class="op">-&gt;</span>parent<span class="op">;</span></span>
<span id="cb37-51"><a href="#cb37-51" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb37-52"><a href="#cb37-52" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-53"><a href="#cb37-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> NULL<span class="op">;</span></span>
<span id="cb37-54"><a href="#cb37-54" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>3.4 Type Checking Implementation</h2>
<p>The type checker traverses the AST, assigning types to expressions
and validating type consistency:</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>    SemanticAnalyzer <span class="op">*</span>analyzer<span class="op">;</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>    Type <span class="op">*</span>expected_type<span class="op">;</span>  <span class="co">// For bidirectional type checking</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> TypeChecker<span class="op">;</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> Type<span class="op">*</span> check_expr<span class="op">(</span>TypeChecker <span class="op">*</span>tc<span class="op">,</span> ASTNode <span class="op">*</span>expr<span class="op">);</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> check_stmt<span class="op">(</span>TypeChecker <span class="op">*</span>tc<span class="op">,</span> ASTNode <span class="op">*</span>stmt<span class="op">);</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>ASTNode<span class="op">*</span> analyze_ast<span class="op">(</span>ASTNode <span class="op">*</span>ast<span class="op">)</span> <span class="op">{</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>    SemanticAnalyzer analyzer <span class="op">=</span> <span class="op">{</span><span class="dv">0</span><span class="op">};</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>    analyzer<span class="op">.</span>global <span class="op">=</span> push_scope<span class="op">(&amp;</span>analyzer<span class="op">,</span> SCOPE_GLOBAL<span class="op">);</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>    analyzer<span class="op">.</span>errors <span class="op">=</span> error_list_new<span class="op">();</span></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>    analyzer<span class="op">.</span>constraints <span class="op">=</span> constraint_set_new<span class="op">();</span></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Define built-in functions</span></span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>    define_builtins<span class="op">(&amp;</span>analyzer<span class="op">);</span></span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a>    TypeChecker tc <span class="op">=</span> <span class="op">{</span></span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>analyzer <span class="op">=</span> <span class="op">&amp;</span>analyzer<span class="op">,</span></span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>expected_type <span class="op">=</span> NULL</span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Analyze program</span></span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a>    check_stmt<span class="op">(&amp;</span>tc<span class="op">,</span> ast<span class="op">);</span></span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Solve type constraints for inference</span></span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true" tabindex="-1"></a>    solve_constraints<span class="op">(</span>analyzer<span class="op">.</span>constraints<span class="op">);</span></span>
<span id="cb38-28"><a href="#cb38-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-29"><a href="#cb38-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>analyzer<span class="op">.</span>errors<span class="op">-&gt;</span>count <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb38-30"><a href="#cb38-30" aria-hidden="true" tabindex="-1"></a>        report_errors<span class="op">(</span>analyzer<span class="op">.</span>errors<span class="op">);</span></span>
<span id="cb38-31"><a href="#cb38-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> NULL<span class="op">;</span></span>
<span id="cb38-32"><a href="#cb38-32" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb38-33"><a href="#cb38-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-34"><a href="#cb38-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ast<span class="op">;</span></span>
<span id="cb38-35"><a href="#cb38-35" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3>3.4.1 Expression Type Checking</h3>
<div class="sourceCode" id="cb39"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> Type<span class="op">*</span> check_expr<span class="op">(</span>TypeChecker <span class="op">*</span>tc<span class="op">,</span> ASTNode <span class="op">*</span>expr<span class="op">)</span> <span class="op">{</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> <span class="op">(</span>expr<span class="op">-&gt;</span>type<span class="op">)</span> <span class="op">{</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> AST_INT_LITERAL<span class="op">:</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>            expr<span class="op">-&gt;</span>expr_type <span class="op">=</span> global_type_table<span class="op">-&gt;</span>type_int<span class="op">;</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> expr<span class="op">-&gt;</span>expr_type<span class="op">;</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> AST_FLOAT_LITERAL<span class="op">:</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>            expr<span class="op">-&gt;</span>expr_type <span class="op">=</span> global_type_table<span class="op">-&gt;</span>type_float<span class="op">;</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> expr<span class="op">-&gt;</span>expr_type<span class="op">;</span></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> AST_STRING_LITERAL<span class="op">:</span></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>            expr<span class="op">-&gt;</span>expr_type <span class="op">=</span> global_type_table<span class="op">-&gt;</span>type_string<span class="op">;</span></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> expr<span class="op">-&gt;</span>expr_type<span class="op">;</span></span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> AST_BOOL_LITERAL<span class="op">:</span></span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>            expr<span class="op">-&gt;</span>expr_type <span class="op">=</span> global_type_table<span class="op">-&gt;</span>type_bool<span class="op">;</span></span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> expr<span class="op">-&gt;</span>expr_type<span class="op">;</span></span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> AST_NULL_LITERAL<span class="op">:</span></span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a>            expr<span class="op">-&gt;</span>expr_type <span class="op">=</span> global_type_table<span class="op">-&gt;</span>type_null<span class="op">;</span></span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> expr<span class="op">-&gt;</span>expr_type<span class="op">;</span></span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> AST_IDENTIFIER<span class="op">:</span></span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> check_identifier<span class="op">(</span>tc<span class="op">,</span> expr<span class="op">);</span></span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> AST_BINARY_OP<span class="op">:</span></span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> check_binary_op<span class="op">(</span>tc<span class="op">,</span> expr<span class="op">);</span></span>
<span id="cb39-28"><a href="#cb39-28" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb39-29"><a href="#cb39-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> AST_UNARY_OP<span class="op">:</span></span>
<span id="cb39-30"><a href="#cb39-30" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> check_unary_op<span class="op">(</span>tc<span class="op">,</span> expr<span class="op">);</span></span>
<span id="cb39-31"><a href="#cb39-31" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb39-32"><a href="#cb39-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> AST_CALL<span class="op">:</span></span>
<span id="cb39-33"><a href="#cb39-33" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> check_call<span class="op">(</span>tc<span class="op">,</span> expr<span class="op">);</span></span>
<span id="cb39-34"><a href="#cb39-34" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb39-35"><a href="#cb39-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> AST_INDEX<span class="op">:</span></span>
<span id="cb39-36"><a href="#cb39-36" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> check_index<span class="op">(</span>tc<span class="op">,</span> expr<span class="op">);</span></span>
<span id="cb39-37"><a href="#cb39-37" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb39-38"><a href="#cb39-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> AST_MEMBER<span class="op">:</span></span>
<span id="cb39-39"><a href="#cb39-39" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> check_member_access<span class="op">(</span>tc<span class="op">,</span> expr<span class="op">);</span></span>
<span id="cb39-40"><a href="#cb39-40" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb39-41"><a href="#cb39-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> AST_ARRAY_LITERAL<span class="op">:</span></span>
<span id="cb39-42"><a href="#cb39-42" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> check_array_literal<span class="op">(</span>tc<span class="op">,</span> expr<span class="op">);</span></span>
<span id="cb39-43"><a href="#cb39-43" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb39-44"><a href="#cb39-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> AST_DICT_LITERAL<span class="op">:</span></span>
<span id="cb39-45"><a href="#cb39-45" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> check_dict_literal<span class="op">(</span>tc<span class="op">,</span> expr<span class="op">);</span></span>
<span id="cb39-46"><a href="#cb39-46" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb39-47"><a href="#cb39-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> AST_LAMBDA<span class="op">:</span></span>
<span id="cb39-48"><a href="#cb39-48" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> check_lambda<span class="op">(</span>tc<span class="op">,</span> expr<span class="op">);</span></span>
<span id="cb39-49"><a href="#cb39-49" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb39-50"><a href="#cb39-50" aria-hidden="true" tabindex="-1"></a>        <span class="cf">default</span><span class="op">:</span></span>
<span id="cb39-51"><a href="#cb39-51" aria-hidden="true" tabindex="-1"></a>            semantic_error<span class="op">(</span>tc<span class="op">-&gt;</span>analyzer<span class="op">,</span> expr<span class="op">-&gt;</span>location<span class="op">,</span> </span>
<span id="cb39-52"><a href="#cb39-52" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;Unknown expression type&quot;</span><span class="op">);</span></span>
<span id="cb39-53"><a href="#cb39-53" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> global_type_table<span class="op">-&gt;</span>type_error<span class="op">;</span></span>
<span id="cb39-54"><a href="#cb39-54" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb39-55"><a href="#cb39-55" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb39-56"><a href="#cb39-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-57"><a href="#cb39-57" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> Type<span class="op">*</span> check_identifier<span class="op">(</span>TypeChecker <span class="op">*</span>tc<span class="op">,</span> ASTNode <span class="op">*</span>expr<span class="op">)</span> <span class="op">{</span></span>
<span id="cb39-58"><a href="#cb39-58" aria-hidden="true" tabindex="-1"></a>    <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>name <span class="op">=</span> expr<span class="op">-&gt;</span>data<span class="op">.</span>identifier<span class="op">.</span>name<span class="op">;</span></span>
<span id="cb39-59"><a href="#cb39-59" aria-hidden="true" tabindex="-1"></a>    Symbol <span class="op">*</span>symbol <span class="op">=</span> resolve_symbol<span class="op">(</span>tc<span class="op">-&gt;</span>analyzer<span class="op">,</span> name<span class="op">);</span></span>
<span id="cb39-60"><a href="#cb39-60" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb39-61"><a href="#cb39-61" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>symbol<span class="op">)</span> <span class="op">{</span></span>
<span id="cb39-62"><a href="#cb39-62" aria-hidden="true" tabindex="-1"></a>        semantic_error<span class="op">(</span>tc<span class="op">-&gt;</span>analyzer<span class="op">,</span> expr<span class="op">-&gt;</span>location<span class="op">,</span></span>
<span id="cb39-63"><a href="#cb39-63" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;Undefined variable &#39;</span><span class="sc">%s</span><span class="st">&#39;&quot;</span><span class="op">,</span> name<span class="op">);</span></span>
<span id="cb39-64"><a href="#cb39-64" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> global_type_table<span class="op">-&gt;</span>type_error<span class="op">;</span></span>
<span id="cb39-65"><a href="#cb39-65" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb39-66"><a href="#cb39-66" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb39-67"><a href="#cb39-67" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Link identifier to symbol</span></span>
<span id="cb39-68"><a href="#cb39-68" aria-hidden="true" tabindex="-1"></a>    expr<span class="op">-&gt;</span>data<span class="op">.</span>identifier<span class="op">.</span>symbol <span class="op">=</span> symbol<span class="op">;</span></span>
<span id="cb39-69"><a href="#cb39-69" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb39-70"><a href="#cb39-70" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check initialization</span></span>
<span id="cb39-71"><a href="#cb39-71" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>symbol<span class="op">-&gt;</span>is_initialized <span class="op">&amp;&amp;</span> symbol<span class="op">-&gt;</span>kind <span class="op">==</span> SYMBOL_VARIABLE<span class="op">)</span> <span class="op">{</span></span>
<span id="cb39-72"><a href="#cb39-72" aria-hidden="true" tabindex="-1"></a>        semantic_warning<span class="op">(</span>tc<span class="op">-&gt;</span>analyzer<span class="op">,</span> expr<span class="op">-&gt;</span>location<span class="op">,</span></span>
<span id="cb39-73"><a href="#cb39-73" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;Variable &#39;</span><span class="sc">%s</span><span class="st">&#39; may be used before initialization&quot;</span><span class="op">,</span> name<span class="op">);</span></span>
<span id="cb39-74"><a href="#cb39-74" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb39-75"><a href="#cb39-75" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb39-76"><a href="#cb39-76" aria-hidden="true" tabindex="-1"></a>    expr<span class="op">-&gt;</span>expr_type <span class="op">=</span> symbol<span class="op">-&gt;</span>type<span class="op">;</span></span>
<span id="cb39-77"><a href="#cb39-77" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> symbol<span class="op">-&gt;</span>type<span class="op">;</span></span>
<span id="cb39-78"><a href="#cb39-78" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3>3.4.2 Binary Operation Type Checking</h3>
<div class="sourceCode" id="cb40"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> Type<span class="op">*</span> check_binary_op<span class="op">(</span>TypeChecker <span class="op">*</span>tc<span class="op">,</span> ASTNode <span class="op">*</span>expr<span class="op">)</span> <span class="op">{</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>    Type <span class="op">*</span>left_type <span class="op">=</span> check_expr<span class="op">(</span>tc<span class="op">,</span> expr<span class="op">-&gt;</span>data<span class="op">.</span>binary_op<span class="op">.</span>left<span class="op">);</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>    Type <span class="op">*</span>right_type <span class="op">=</span> check_expr<span class="op">(</span>tc<span class="op">,</span> expr<span class="op">-&gt;</span>data<span class="op">.</span>binary_op<span class="op">.</span>right<span class="op">);</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>    TokenType op <span class="op">=</span> expr<span class="op">-&gt;</span>data<span class="op">.</span>binary_op<span class="op">.</span>op<span class="op">;</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Handle special operators</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> <span class="op">(</span>op<span class="op">)</span> <span class="op">{</span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> TOK_AND<span class="op">:</span></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> TOK_OR<span class="op">:</span></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Logical operators accept any type (truthiness)</span></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>            expr<span class="op">-&gt;</span>expr_type <span class="op">=</span> global_type_table<span class="op">-&gt;</span>type_bool<span class="op">;</span></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> expr<span class="op">-&gt;</span>expr_type<span class="op">;</span></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> TOK_EQ<span class="op">:</span></span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> TOK_NE<span class="op">:</span></span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Equality works on any types</span></span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>            expr<span class="op">-&gt;</span>expr_type <span class="op">=</span> global_type_table<span class="op">-&gt;</span>type_bool<span class="op">;</span></span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> expr<span class="op">-&gt;</span>expr_type<span class="op">;</span></span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Numeric operations</span></span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>is_arithmetic_op<span class="op">(</span>op<span class="op">))</span> <span class="op">{</span></span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a>        Type <span class="op">*</span>result_type <span class="op">=</span> unify_numeric_types<span class="op">(</span>left_type<span class="op">,</span> right_type<span class="op">);</span></span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(!</span>result_type<span class="op">)</span> <span class="op">{</span></span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a>            semantic_error<span class="op">(</span>tc<span class="op">-&gt;</span>analyzer<span class="op">,</span> expr<span class="op">-&gt;</span>location<span class="op">,</span></span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;Invalid operand types for </span><span class="sc">%s</span><span class="st">: </span><span class="sc">%s</span><span class="st"> and </span><span class="sc">%s</span><span class="st">&quot;</span><span class="op">,</span></span>
<span id="cb40-29"><a href="#cb40-29" aria-hidden="true" tabindex="-1"></a>                token_to_string<span class="op">(</span>op<span class="op">),</span></span>
<span id="cb40-30"><a href="#cb40-30" aria-hidden="true" tabindex="-1"></a>                type_to_string<span class="op">(</span>left_type<span class="op">),</span></span>
<span id="cb40-31"><a href="#cb40-31" aria-hidden="true" tabindex="-1"></a>                type_to_string<span class="op">(</span>right_type<span class="op">));</span></span>
<span id="cb40-32"><a href="#cb40-32" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> global_type_table<span class="op">-&gt;</span>type_error<span class="op">;</span></span>
<span id="cb40-33"><a href="#cb40-33" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb40-34"><a href="#cb40-34" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb40-35"><a href="#cb40-35" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Comparison operators return bool</span></span>
<span id="cb40-36"><a href="#cb40-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>is_comparison_op<span class="op">(</span>op<span class="op">))</span> <span class="op">{</span></span>
<span id="cb40-37"><a href="#cb40-37" aria-hidden="true" tabindex="-1"></a>            expr<span class="op">-&gt;</span>expr_type <span class="op">=</span> global_type_table<span class="op">-&gt;</span>type_bool<span class="op">;</span></span>
<span id="cb40-38"><a href="#cb40-38" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb40-39"><a href="#cb40-39" aria-hidden="true" tabindex="-1"></a>            expr<span class="op">-&gt;</span>expr_type <span class="op">=</span> result_type<span class="op">;</span></span>
<span id="cb40-40"><a href="#cb40-40" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb40-41"><a href="#cb40-41" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb40-42"><a href="#cb40-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> expr<span class="op">-&gt;</span>expr_type<span class="op">;</span></span>
<span id="cb40-43"><a href="#cb40-43" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb40-44"><a href="#cb40-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb40-45"><a href="#cb40-45" aria-hidden="true" tabindex="-1"></a>    <span class="co">// String concatenation</span></span>
<span id="cb40-46"><a href="#cb40-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>op <span class="op">==</span> TOK_PLUS <span class="op">&amp;&amp;</span> </span>
<span id="cb40-47"><a href="#cb40-47" aria-hidden="true" tabindex="-1"></a>        <span class="op">(</span>left_type<span class="op">-&gt;</span>kind <span class="op">==</span> TYPE_STRING <span class="op">||</span> right_type<span class="op">-&gt;</span>kind <span class="op">==</span> TYPE_STRING<span class="op">))</span> <span class="op">{</span></span>
<span id="cb40-48"><a href="#cb40-48" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>left_type<span class="op">-&gt;</span>kind <span class="op">!=</span> TYPE_STRING <span class="op">||</span> right_type<span class="op">-&gt;</span>kind <span class="op">!=</span> TYPE_STRING<span class="op">)</span> <span class="op">{</span></span>
<span id="cb40-49"><a href="#cb40-49" aria-hidden="true" tabindex="-1"></a>            semantic_error<span class="op">(</span>tc<span class="op">-&gt;</span>analyzer<span class="op">,</span> expr<span class="op">-&gt;</span>location<span class="op">,</span></span>
<span id="cb40-50"><a href="#cb40-50" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;Cannot concatenate string with </span><span class="sc">%s</span><span class="st">&quot;</span><span class="op">,</span></span>
<span id="cb40-51"><a href="#cb40-51" aria-hidden="true" tabindex="-1"></a>                left_type<span class="op">-&gt;</span>kind <span class="op">==</span> TYPE_STRING <span class="op">?</span> </span>
<span id="cb40-52"><a href="#cb40-52" aria-hidden="true" tabindex="-1"></a>                    type_to_string<span class="op">(</span>right_type<span class="op">)</span> <span class="op">:</span> type_to_string<span class="op">(</span>left_type<span class="op">));</span></span>
<span id="cb40-53"><a href="#cb40-53" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> global_type_table<span class="op">-&gt;</span>type_error<span class="op">;</span></span>
<span id="cb40-54"><a href="#cb40-54" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb40-55"><a href="#cb40-55" aria-hidden="true" tabindex="-1"></a>        expr<span class="op">-&gt;</span>expr_type <span class="op">=</span> global_type_table<span class="op">-&gt;</span>type_string<span class="op">;</span></span>
<span id="cb40-56"><a href="#cb40-56" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> expr<span class="op">-&gt;</span>expr_type<span class="op">;</span></span>
<span id="cb40-57"><a href="#cb40-57" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb40-58"><a href="#cb40-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb40-59"><a href="#cb40-59" aria-hidden="true" tabindex="-1"></a>    semantic_error<span class="op">(</span>tc<span class="op">-&gt;</span>analyzer<span class="op">,</span> expr<span class="op">-&gt;</span>location<span class="op">,</span></span>
<span id="cb40-60"><a href="#cb40-60" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Invalid binary operation&quot;</span><span class="op">);</span></span>
<span id="cb40-61"><a href="#cb40-61" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> global_type_table<span class="op">-&gt;</span>type_error<span class="op">;</span></span>
<span id="cb40-62"><a href="#cb40-62" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb40-63"><a href="#cb40-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-64"><a href="#cb40-64" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> Type<span class="op">*</span> unify_numeric_types<span class="op">(</span>Type <span class="op">*</span>left<span class="op">,</span> Type <span class="op">*</span>right<span class="op">)</span> <span class="op">{</span></span>
<span id="cb40-65"><a href="#cb40-65" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Handle any type</span></span>
<span id="cb40-66"><a href="#cb40-66" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>left<span class="op">-&gt;</span>kind <span class="op">==</span> TYPE_ANY<span class="op">)</span> <span class="cf">return</span> right<span class="op">;</span></span>
<span id="cb40-67"><a href="#cb40-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>right<span class="op">-&gt;</span>kind <span class="op">==</span> TYPE_ANY<span class="op">)</span> <span class="cf">return</span> left<span class="op">;</span></span>
<span id="cb40-68"><a href="#cb40-68" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb40-69"><a href="#cb40-69" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Both must be numeric</span></span>
<span id="cb40-70"><a href="#cb40-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>is_numeric_type<span class="op">(</span>left<span class="op">)</span> <span class="op">||</span> <span class="op">!</span>is_numeric_type<span class="op">(</span>right<span class="op">))</span> <span class="op">{</span></span>
<span id="cb40-71"><a href="#cb40-71" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> NULL<span class="op">;</span></span>
<span id="cb40-72"><a href="#cb40-72" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb40-73"><a href="#cb40-73" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb40-74"><a href="#cb40-74" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Float dominates int</span></span>
<span id="cb40-75"><a href="#cb40-75" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>left<span class="op">-&gt;</span>kind <span class="op">==</span> TYPE_FLOAT <span class="op">||</span> right<span class="op">-&gt;</span>kind <span class="op">==</span> TYPE_FLOAT<span class="op">)</span> <span class="op">{</span></span>
<span id="cb40-76"><a href="#cb40-76" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> global_type_table<span class="op">-&gt;</span>type_float<span class="op">;</span></span>
<span id="cb40-77"><a href="#cb40-77" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb40-78"><a href="#cb40-78" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb40-79"><a href="#cb40-79" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> global_type_table<span class="op">-&gt;</span>type_int<span class="op">;</span></span>
<span id="cb40-80"><a href="#cb40-80" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3>3.4.3 Function Call Type Checking</h3>
<div class="sourceCode" id="cb41"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> Type<span class="op">*</span> check_call<span class="op">(</span>TypeChecker <span class="op">*</span>tc<span class="op">,</span> ASTNode <span class="op">*</span>expr<span class="op">)</span> <span class="op">{</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>    Type <span class="op">*</span>callee_type <span class="op">=</span> check_expr<span class="op">(</span>tc<span class="op">,</span> expr<span class="op">-&gt;</span>data<span class="op">.</span>call<span class="op">.</span>callee<span class="op">);</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>callee_type<span class="op">-&gt;</span>kind <span class="op">!=</span> TYPE_FUNCTION<span class="op">)</span> <span class="op">{</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>        semantic_error<span class="op">(</span>tc<span class="op">-&gt;</span>analyzer<span class="op">,</span> expr<span class="op">-&gt;</span>location<span class="op">,</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;Cannot call non-function type </span><span class="sc">%s</span><span class="st">&quot;</span><span class="op">,</span> </span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>            type_to_string<span class="op">(</span>callee_type<span class="op">));</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> global_type_table<span class="op">-&gt;</span>type_error<span class="op">;</span></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>    FunctionType <span class="op">*</span>func <span class="op">=</span> <span class="op">&amp;</span>callee_type<span class="op">-&gt;</span>data<span class="op">.</span>function<span class="op">;</span></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> arg_count <span class="op">=</span> expr<span class="op">-&gt;</span>data<span class="op">.</span>call<span class="op">.</span>arg_count<span class="op">;</span></span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check argument count</span></span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>func<span class="op">-&gt;</span>is_varargs <span class="op">&amp;&amp;</span> arg_count <span class="op">!=</span> func<span class="op">-&gt;</span>param_count<span class="op">)</span> <span class="op">{</span></span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>        semantic_error<span class="op">(</span>tc<span class="op">-&gt;</span>analyzer<span class="op">,</span> expr<span class="op">-&gt;</span>location<span class="op">,</span></span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;Function expects </span><span class="sc">%zu</span><span class="st"> arguments, got </span><span class="sc">%zu</span><span class="st">&quot;</span><span class="op">,</span></span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>            func<span class="op">-&gt;</span>param_count<span class="op">,</span> arg_count<span class="op">);</span></span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> global_type_table<span class="op">-&gt;</span>type_error<span class="op">;</span></span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>func<span class="op">-&gt;</span>is_varargs <span class="op">&amp;&amp;</span> arg_count <span class="op">&lt;</span> func<span class="op">-&gt;</span>param_count<span class="op">)</span> <span class="op">{</span></span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a>        semantic_error<span class="op">(</span>tc<span class="op">-&gt;</span>analyzer<span class="op">,</span> expr<span class="op">-&gt;</span>location<span class="op">,</span></span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;Function expects at least </span><span class="sc">%zu</span><span class="st"> arguments, got </span><span class="sc">%zu</span><span class="st">&quot;</span><span class="op">,</span></span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a>            func<span class="op">-&gt;</span>param_count<span class="op">,</span> arg_count<span class="op">);</span></span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> global_type_table<span class="op">-&gt;</span>type_error<span class="op">;</span></span>
<span id="cb41-27"><a href="#cb41-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb41-28"><a href="#cb41-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb41-29"><a href="#cb41-29" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check argument types</span></span>
<span id="cb41-30"><a href="#cb41-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> arg_count <span class="op">&amp;&amp;</span> i <span class="op">&lt;</span> func<span class="op">-&gt;</span>param_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb41-31"><a href="#cb41-31" aria-hidden="true" tabindex="-1"></a>        TypeChecker arg_tc <span class="op">=</span> <span class="op">*</span>tc<span class="op">;</span></span>
<span id="cb41-32"><a href="#cb41-32" aria-hidden="true" tabindex="-1"></a>        arg_tc<span class="op">.</span>expected_type <span class="op">=</span> func<span class="op">-&gt;</span>param_types<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb41-33"><a href="#cb41-33" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb41-34"><a href="#cb41-34" aria-hidden="true" tabindex="-1"></a>        Type <span class="op">*</span>arg_type <span class="op">=</span> check_expr<span class="op">(&amp;</span>arg_tc<span class="op">,</span> expr<span class="op">-&gt;</span>data<span class="op">.</span>call<span class="op">.</span>args<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb41-35"><a href="#cb41-35" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb41-36"><a href="#cb41-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(!</span>is_assignable_to<span class="op">(</span>arg_type<span class="op">,</span> func<span class="op">-&gt;</span>param_types<span class="op">[</span>i<span class="op">]))</span> <span class="op">{</span></span>
<span id="cb41-37"><a href="#cb41-37" aria-hidden="true" tabindex="-1"></a>            semantic_error<span class="op">(</span>tc<span class="op">-&gt;</span>analyzer<span class="op">,</span> expr<span class="op">-&gt;</span>data<span class="op">.</span>call<span class="op">.</span>args<span class="op">[</span>i<span class="op">]-&gt;</span>location<span class="op">,</span></span>
<span id="cb41-38"><a href="#cb41-38" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;Argument </span><span class="sc">%zu</span><span class="st">: expected </span><span class="sc">%s</span><span class="st">, got </span><span class="sc">%s</span><span class="st">&quot;</span><span class="op">,</span></span>
<span id="cb41-39"><a href="#cb41-39" aria-hidden="true" tabindex="-1"></a>                i <span class="op">+</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb41-40"><a href="#cb41-40" aria-hidden="true" tabindex="-1"></a>                type_to_string<span class="op">(</span>func<span class="op">-&gt;</span>param_types<span class="op">[</span>i<span class="op">]),</span></span>
<span id="cb41-41"><a href="#cb41-41" aria-hidden="true" tabindex="-1"></a>                type_to_string<span class="op">(</span>arg_type<span class="op">));</span></span>
<span id="cb41-42"><a href="#cb41-42" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb41-43"><a href="#cb41-43" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb41-44"><a href="#cb41-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb41-45"><a href="#cb41-45" aria-hidden="true" tabindex="-1"></a>    expr<span class="op">-&gt;</span>expr_type <span class="op">=</span> func<span class="op">-&gt;</span>return_type<span class="op">;</span></span>
<span id="cb41-46"><a href="#cb41-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> func<span class="op">-&gt;</span>return_type<span class="op">;</span></span>
<span id="cb41-47"><a href="#cb41-47" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>3.5 Statement Analysis</h2>
<div class="sourceCode" id="cb42"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> check_stmt<span class="op">(</span>TypeChecker <span class="op">*</span>tc<span class="op">,</span> ASTNode <span class="op">*</span>stmt<span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> <span class="op">(</span>stmt<span class="op">-&gt;</span>type<span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> AST_ASSIGN<span class="op">:</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>            check_assignment<span class="op">(</span>tc<span class="op">,</span> stmt<span class="op">);</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span><span class="op">;</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> AST_AUG_ASSIGN<span class="op">:</span></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>            check_aug_assignment<span class="op">(</span>tc<span class="op">,</span> stmt<span class="op">);</span></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span><span class="op">;</span></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> AST_IF<span class="op">:</span></span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>            check_if_stmt<span class="op">(</span>tc<span class="op">,</span> stmt<span class="op">);</span></span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span><span class="op">;</span></span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> AST_WHILE<span class="op">:</span></span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>            check_while_stmt<span class="op">(</span>tc<span class="op">,</span> stmt<span class="op">);</span></span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span><span class="op">;</span></span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> AST_FOR<span class="op">:</span></span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a>            check_for_stmt<span class="op">(</span>tc<span class="op">,</span> stmt<span class="op">);</span></span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span><span class="op">;</span></span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> AST_FUNCTION<span class="op">:</span></span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a>            check_function_def<span class="op">(</span>tc<span class="op">,</span> stmt<span class="op">);</span></span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span><span class="op">;</span></span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb42-27"><a href="#cb42-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> AST_CLASS<span class="op">:</span></span>
<span id="cb42-28"><a href="#cb42-28" aria-hidden="true" tabindex="-1"></a>            check_class_def<span class="op">(</span>tc<span class="op">,</span> stmt<span class="op">);</span></span>
<span id="cb42-29"><a href="#cb42-29" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span><span class="op">;</span></span>
<span id="cb42-30"><a href="#cb42-30" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb42-31"><a href="#cb42-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> AST_RETURN<span class="op">:</span></span>
<span id="cb42-32"><a href="#cb42-32" aria-hidden="true" tabindex="-1"></a>            check_return_stmt<span class="op">(</span>tc<span class="op">,</span> stmt<span class="op">);</span></span>
<span id="cb42-33"><a href="#cb42-33" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span><span class="op">;</span></span>
<span id="cb42-34"><a href="#cb42-34" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb42-35"><a href="#cb42-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> AST_BREAK<span class="op">:</span></span>
<span id="cb42-36"><a href="#cb42-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> AST_CONTINUE<span class="op">:</span></span>
<span id="cb42-37"><a href="#cb42-37" aria-hidden="true" tabindex="-1"></a>            check_loop_control<span class="op">(</span>tc<span class="op">,</span> stmt<span class="op">);</span></span>
<span id="cb42-38"><a href="#cb42-38" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span><span class="op">;</span></span>
<span id="cb42-39"><a href="#cb42-39" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb42-40"><a href="#cb42-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> AST_BLOCK<span class="op">:</span></span>
<span id="cb42-41"><a href="#cb42-41" aria-hidden="true" tabindex="-1"></a>            check_block<span class="op">(</span>tc<span class="op">,</span> stmt<span class="op">);</span></span>
<span id="cb42-42"><a href="#cb42-42" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span><span class="op">;</span></span>
<span id="cb42-43"><a href="#cb42-43" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb42-44"><a href="#cb42-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> AST_EXPR_STMT<span class="op">:</span></span>
<span id="cb42-45"><a href="#cb42-45" aria-hidden="true" tabindex="-1"></a>            check_expr<span class="op">(</span>tc<span class="op">,</span> stmt<span class="op">-&gt;</span>data<span class="op">.</span>expr_stmt<span class="op">.</span>expr<span class="op">);</span></span>
<span id="cb42-46"><a href="#cb42-46" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span><span class="op">;</span></span>
<span id="cb42-47"><a href="#cb42-47" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb42-48"><a href="#cb42-48" aria-hidden="true" tabindex="-1"></a>        <span class="cf">default</span><span class="op">:</span></span>
<span id="cb42-49"><a href="#cb42-49" aria-hidden="true" tabindex="-1"></a>            semantic_error<span class="op">(</span>tc<span class="op">-&gt;</span>analyzer<span class="op">,</span> stmt<span class="op">-&gt;</span>location<span class="op">,</span></span>
<span id="cb42-50"><a href="#cb42-50" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;Unknown statement type&quot;</span><span class="op">);</span></span>
<span id="cb42-51"><a href="#cb42-51" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb42-52"><a href="#cb42-52" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb42-53"><a href="#cb42-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-54"><a href="#cb42-54" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> check_assignment<span class="op">(</span>TypeChecker <span class="op">*</span>tc<span class="op">,</span> ASTNode <span class="op">*</span>stmt<span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-55"><a href="#cb42-55" aria-hidden="true" tabindex="-1"></a>    ASTNode <span class="op">*</span>target <span class="op">=</span> stmt<span class="op">-&gt;</span>data<span class="op">.</span>assign<span class="op">.</span>target<span class="op">;</span></span>
<span id="cb42-56"><a href="#cb42-56" aria-hidden="true" tabindex="-1"></a>    ASTNode <span class="op">*</span>value <span class="op">=</span> stmt<span class="op">-&gt;</span>data<span class="op">.</span>assign<span class="op">.</span>value<span class="op">;</span></span>
<span id="cb42-57"><a href="#cb42-57" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-58"><a href="#cb42-58" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check that target is assignable</span></span>
<span id="cb42-59"><a href="#cb42-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>is_lvalue<span class="op">(</span>target<span class="op">))</span> <span class="op">{</span></span>
<span id="cb42-60"><a href="#cb42-60" aria-hidden="true" tabindex="-1"></a>        semantic_error<span class="op">(</span>tc<span class="op">-&gt;</span>analyzer<span class="op">,</span> target<span class="op">-&gt;</span>location<span class="op">,</span></span>
<span id="cb42-61"><a href="#cb42-61" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;Cannot assign to non-lvalue&quot;</span><span class="op">);</span></span>
<span id="cb42-62"><a href="#cb42-62" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span><span class="op">;</span></span>
<span id="cb42-63"><a href="#cb42-63" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb42-64"><a href="#cb42-64" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-65"><a href="#cb42-65" aria-hidden="true" tabindex="-1"></a>    Type <span class="op">*</span>value_type <span class="op">=</span> check_expr<span class="op">(</span>tc<span class="op">,</span> value<span class="op">);</span></span>
<span id="cb42-66"><a href="#cb42-66" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-67"><a href="#cb42-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>target<span class="op">-&gt;</span>type <span class="op">==</span> AST_IDENTIFIER<span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-68"><a href="#cb42-68" aria-hidden="true" tabindex="-1"></a>        <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>name <span class="op">=</span> target<span class="op">-&gt;</span>data<span class="op">.</span>identifier<span class="op">.</span>name<span class="op">;</span></span>
<span id="cb42-69"><a href="#cb42-69" aria-hidden="true" tabindex="-1"></a>        Symbol <span class="op">*</span>symbol <span class="op">=</span> resolve_symbol<span class="op">(</span>tc<span class="op">-&gt;</span>analyzer<span class="op">,</span> name<span class="op">);</span></span>
<span id="cb42-70"><a href="#cb42-70" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb42-71"><a href="#cb42-71" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(!</span>symbol<span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-72"><a href="#cb42-72" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Create new variable in current scope</span></span>
<span id="cb42-73"><a href="#cb42-73" aria-hidden="true" tabindex="-1"></a>            symbol <span class="op">=</span> define_symbol<span class="op">(</span>tc<span class="op">-&gt;</span>analyzer<span class="op">,</span> name<span class="op">,</span> SYMBOL_VARIABLE<span class="op">,</span></span>
<span id="cb42-74"><a href="#cb42-74" aria-hidden="true" tabindex="-1"></a>                                 value_type<span class="op">,</span> target<span class="op">-&gt;</span>location<span class="op">);</span></span>
<span id="cb42-75"><a href="#cb42-75" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>symbol<span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-76"><a href="#cb42-76" aria-hidden="true" tabindex="-1"></a>                symbol<span class="op">-&gt;</span>is_initialized <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb42-77"><a href="#cb42-77" aria-hidden="true" tabindex="-1"></a>                target<span class="op">-&gt;</span>data<span class="op">.</span>identifier<span class="op">.</span>symbol <span class="op">=</span> symbol<span class="op">;</span></span>
<span id="cb42-78"><a href="#cb42-78" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb42-79"><a href="#cb42-79" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb42-80"><a href="#cb42-80" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Check type compatibility</span></span>
<span id="cb42-81"><a href="#cb42-81" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(!</span>is_assignable_to<span class="op">(</span>value_type<span class="op">,</span> symbol<span class="op">-&gt;</span>type<span class="op">))</span> <span class="op">{</span></span>
<span id="cb42-82"><a href="#cb42-82" aria-hidden="true" tabindex="-1"></a>                semantic_error<span class="op">(</span>tc<span class="op">-&gt;</span>analyzer<span class="op">,</span> stmt<span class="op">-&gt;</span>location<span class="op">,</span></span>
<span id="cb42-83"><a href="#cb42-83" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;Cannot assign </span><span class="sc">%s</span><span class="st"> to variable of type </span><span class="sc">%s</span><span class="st">&quot;</span><span class="op">,</span></span>
<span id="cb42-84"><a href="#cb42-84" aria-hidden="true" tabindex="-1"></a>                    type_to_string<span class="op">(</span>value_type<span class="op">),</span></span>
<span id="cb42-85"><a href="#cb42-85" aria-hidden="true" tabindex="-1"></a>                    type_to_string<span class="op">(</span>symbol<span class="op">-&gt;</span>type<span class="op">));</span></span>
<span id="cb42-86"><a href="#cb42-86" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb42-87"><a href="#cb42-87" aria-hidden="true" tabindex="-1"></a>            symbol<span class="op">-&gt;</span>is_initialized <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb42-88"><a href="#cb42-88" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb42-89"><a href="#cb42-89" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb42-90"><a href="#cb42-90" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Index or member assignment</span></span>
<span id="cb42-91"><a href="#cb42-91" aria-hidden="true" tabindex="-1"></a>        Type <span class="op">*</span>target_type <span class="op">=</span> check_expr<span class="op">(</span>tc<span class="op">,</span> target<span class="op">);</span></span>
<span id="cb42-92"><a href="#cb42-92" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Additional validation for container types</span></span>
<span id="cb42-93"><a href="#cb42-93" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb42-94"><a href="#cb42-94" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3>3.5.1 Control Flow Analysis</h3>
<div class="sourceCode" id="cb43"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> check_if_stmt<span class="op">(</span>TypeChecker <span class="op">*</span>tc<span class="op">,</span> ASTNode <span class="op">*</span>stmt<span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check condition</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>    Type <span class="op">*</span>cond_type <span class="op">=</span> check_expr<span class="op">(</span>tc<span class="op">,</span> stmt<span class="op">-&gt;</span>data<span class="op">.</span>if_stmt<span class="op">.</span>condition<span class="op">);</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Any type can be used as condition (truthiness)</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check branches</span></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>    check_stmt<span class="op">(</span>tc<span class="op">,</span> stmt<span class="op">-&gt;</span>data<span class="op">.</span>if_stmt<span class="op">.</span>then_branch<span class="op">);</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>stmt<span class="op">-&gt;</span>data<span class="op">.</span>if_stmt<span class="op">.</span>else_branch<span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>        check_stmt<span class="op">(</span>tc<span class="op">,</span> stmt<span class="op">-&gt;</span>data<span class="op">.</span>if_stmt<span class="op">.</span>else_branch<span class="op">);</span></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> check_while_stmt<span class="op">(</span>TypeChecker <span class="op">*</span>tc<span class="op">,</span> ASTNode <span class="op">*</span>stmt<span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>    Type <span class="op">*</span>cond_type <span class="op">=</span> check_expr<span class="op">(</span>tc<span class="op">,</span> stmt<span class="op">-&gt;</span>data<span class="op">.</span>while_stmt<span class="op">.</span>condition<span class="op">);</span></span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Push loop scope</span></span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>    Scope <span class="op">*</span>loop_scope <span class="op">=</span> push_scope<span class="op">(</span>tc<span class="op">-&gt;</span>analyzer<span class="op">,</span> SCOPE_LOOP<span class="op">);</span></span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>    loop_scope<span class="op">-&gt;</span>in_loop <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>    check_stmt<span class="op">(</span>tc<span class="op">,</span> stmt<span class="op">-&gt;</span>data<span class="op">.</span>while_stmt<span class="op">.</span>body<span class="op">);</span></span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a>    pop_scope<span class="op">(</span>tc<span class="op">-&gt;</span>analyzer<span class="op">);</span></span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> check_for_stmt<span class="op">(</span>TypeChecker <span class="op">*</span>tc<span class="op">,</span> ASTNode <span class="op">*</span>stmt<span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-28"><a href="#cb43-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check iterable</span></span>
<span id="cb43-29"><a href="#cb43-29" aria-hidden="true" tabindex="-1"></a>    Type <span class="op">*</span>iter_type <span class="op">=</span> check_expr<span class="op">(</span>tc<span class="op">,</span> stmt<span class="op">-&gt;</span>data<span class="op">.</span>for_stmt<span class="op">.</span>iterable<span class="op">);</span></span>
<span id="cb43-30"><a href="#cb43-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-31"><a href="#cb43-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>is_iterable_type<span class="op">(</span>iter_type<span class="op">))</span> <span class="op">{</span></span>
<span id="cb43-32"><a href="#cb43-32" aria-hidden="true" tabindex="-1"></a>        semantic_error<span class="op">(</span>tc<span class="op">-&gt;</span>analyzer<span class="op">,</span> stmt<span class="op">-&gt;</span>data<span class="op">.</span>for_stmt<span class="op">.</span>iterable<span class="op">-&gt;</span>location<span class="op">,</span></span>
<span id="cb43-33"><a href="#cb43-33" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;Cannot iterate over type </span><span class="sc">%s</span><span class="st">&quot;</span><span class="op">,</span> type_to_string<span class="op">(</span>iter_type<span class="op">));</span></span>
<span id="cb43-34"><a href="#cb43-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span><span class="op">;</span></span>
<span id="cb43-35"><a href="#cb43-35" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb43-36"><a href="#cb43-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-37"><a href="#cb43-37" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Push loop scope</span></span>
<span id="cb43-38"><a href="#cb43-38" aria-hidden="true" tabindex="-1"></a>    Scope <span class="op">*</span>loop_scope <span class="op">=</span> push_scope<span class="op">(</span>tc<span class="op">-&gt;</span>analyzer<span class="op">,</span> SCOPE_LOOP<span class="op">);</span></span>
<span id="cb43-39"><a href="#cb43-39" aria-hidden="true" tabindex="-1"></a>    loop_scope<span class="op">-&gt;</span>in_loop <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb43-40"><a href="#cb43-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-41"><a href="#cb43-41" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Define loop variable</span></span>
<span id="cb43-42"><a href="#cb43-42" aria-hidden="true" tabindex="-1"></a>    Type <span class="op">*</span>element_type <span class="op">=</span> get_element_type<span class="op">(</span>iter_type<span class="op">);</span></span>
<span id="cb43-43"><a href="#cb43-43" aria-hidden="true" tabindex="-1"></a>    <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>var_name <span class="op">=</span> stmt<span class="op">-&gt;</span>data<span class="op">.</span>for_stmt<span class="op">.</span>variable<span class="op">-&gt;</span>data<span class="op">.</span>identifier<span class="op">.</span>name<span class="op">;</span></span>
<span id="cb43-44"><a href="#cb43-44" aria-hidden="true" tabindex="-1"></a>    Symbol <span class="op">*</span>var <span class="op">=</span> define_symbol<span class="op">(</span>tc<span class="op">-&gt;</span>analyzer<span class="op">,</span> var_name<span class="op">,</span> SYMBOL_VARIABLE<span class="op">,</span></span>
<span id="cb43-45"><a href="#cb43-45" aria-hidden="true" tabindex="-1"></a>                               element_type<span class="op">,</span> stmt<span class="op">-&gt;</span>data<span class="op">.</span>for_stmt<span class="op">.</span>variable<span class="op">-&gt;</span>location<span class="op">);</span></span>
<span id="cb43-46"><a href="#cb43-46" aria-hidden="true" tabindex="-1"></a>    var<span class="op">-&gt;</span>is_initialized <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb43-47"><a href="#cb43-47" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-48"><a href="#cb43-48" aria-hidden="true" tabindex="-1"></a>    check_stmt<span class="op">(</span>tc<span class="op">,</span> stmt<span class="op">-&gt;</span>data<span class="op">.</span>for_stmt<span class="op">.</span>body<span class="op">);</span></span>
<span id="cb43-49"><a href="#cb43-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-50"><a href="#cb43-50" aria-hidden="true" tabindex="-1"></a>    pop_scope<span class="op">(</span>tc<span class="op">-&gt;</span>analyzer<span class="op">);</span></span>
<span id="cb43-51"><a href="#cb43-51" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3>3.5.2 Function Definition Analysis</h3>
<div class="sourceCode" id="cb44"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> check_function_def<span class="op">(</span>TypeChecker <span class="op">*</span>tc<span class="op">,</span> ASTNode <span class="op">*</span>stmt<span class="op">)</span> <span class="op">{</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>    FunctionDef <span class="op">*</span>func <span class="op">=</span> <span class="op">&amp;</span>stmt<span class="op">-&gt;</span>data<span class="op">.</span>function<span class="op">;</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Create function type</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>    Type <span class="op">*</span>func_type <span class="op">=</span> calloc<span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>Type<span class="op">));</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>    func_type<span class="op">-&gt;</span>kind <span class="op">=</span> TYPE_FUNCTION<span class="op">;</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>    func_type<span class="op">-&gt;</span>data<span class="op">.</span>function<span class="op">.</span>param_count <span class="op">=</span> func<span class="op">-&gt;</span>param_count<span class="op">;</span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>    func_type<span class="op">-&gt;</span>data<span class="op">.</span>function<span class="op">.</span>param_types <span class="op">=</span> </span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>        calloc<span class="op">(</span>func<span class="op">-&gt;</span>param_count<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>Type<span class="op">*));</span></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Define function symbol before analyzing body (for recursion)</span></span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>    Symbol <span class="op">*</span>func_symbol <span class="op">=</span> define_symbol<span class="op">(</span>tc<span class="op">-&gt;</span>analyzer<span class="op">,</span> func<span class="op">-&gt;</span>name<span class="op">,</span></span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>                                       SYMBOL_FUNCTION<span class="op">,</span> func_type<span class="op">,</span></span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>                                       stmt<span class="op">-&gt;</span>location<span class="op">);</span></span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Push function scope</span></span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a>    Scope <span class="op">*</span>func_scope <span class="op">=</span> push_scope<span class="op">(</span>tc<span class="op">-&gt;</span>analyzer<span class="op">,</span> SCOPE_FUNCTION<span class="op">);</span></span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>    tc<span class="op">-&gt;</span>analyzer<span class="op">-&gt;</span>current_function <span class="op">=</span> func_symbol<span class="op">;</span></span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Process parameters</span></span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> func<span class="op">-&gt;</span>param_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a>        ASTNode <span class="op">*</span>param <span class="op">=</span> func<span class="op">-&gt;</span>params<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb44-23"><a href="#cb44-23" aria-hidden="true" tabindex="-1"></a>        Type <span class="op">*</span>param_type <span class="op">=</span> global_type_table<span class="op">-&gt;</span>type_any<span class="op">;</span>  <span class="co">// Default</span></span>
<span id="cb44-24"><a href="#cb44-24" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb44-25"><a href="#cb44-25" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Check for type annotation</span></span>
<span id="cb44-26"><a href="#cb44-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>param<span class="op">-&gt;</span>data<span class="op">.</span>param<span class="op">.</span>type_annotation<span class="op">)</span> <span class="op">{</span></span>
<span id="cb44-27"><a href="#cb44-27" aria-hidden="true" tabindex="-1"></a>            param_type <span class="op">=</span> resolve_type_annotation<span class="op">(</span>tc<span class="op">-&gt;</span>analyzer<span class="op">,</span></span>
<span id="cb44-28"><a href="#cb44-28" aria-hidden="true" tabindex="-1"></a>                param<span class="op">-&gt;</span>data<span class="op">.</span>param<span class="op">.</span>type_annotation<span class="op">);</span></span>
<span id="cb44-29"><a href="#cb44-29" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb44-30"><a href="#cb44-30" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb44-31"><a href="#cb44-31" aria-hidden="true" tabindex="-1"></a>        func_type<span class="op">-&gt;</span>data<span class="op">.</span>function<span class="op">.</span>param_types<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> param_type<span class="op">;</span></span>
<span id="cb44-32"><a href="#cb44-32" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb44-33"><a href="#cb44-33" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Define parameter symbol</span></span>
<span id="cb44-34"><a href="#cb44-34" aria-hidden="true" tabindex="-1"></a>        Symbol <span class="op">*</span>param_symbol <span class="op">=</span> define_symbol<span class="op">(</span>tc<span class="op">-&gt;</span>analyzer<span class="op">,</span></span>
<span id="cb44-35"><a href="#cb44-35" aria-hidden="true" tabindex="-1"></a>            param<span class="op">-&gt;</span>data<span class="op">.</span>param<span class="op">.</span>name<span class="op">,</span> SYMBOL_PARAMETER<span class="op">,</span></span>
<span id="cb44-36"><a href="#cb44-36" aria-hidden="true" tabindex="-1"></a>            param_type<span class="op">,</span> param<span class="op">-&gt;</span>location<span class="op">);</span></span>
<span id="cb44-37"><a href="#cb44-37" aria-hidden="true" tabindex="-1"></a>        param_symbol<span class="op">-&gt;</span>is_initialized <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb44-38"><a href="#cb44-38" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb44-39"><a href="#cb44-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-40"><a href="#cb44-40" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Process return type annotation</span></span>
<span id="cb44-41"><a href="#cb44-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>func<span class="op">-&gt;</span>return_type_annotation<span class="op">)</span> <span class="op">{</span></span>
<span id="cb44-42"><a href="#cb44-42" aria-hidden="true" tabindex="-1"></a>        func_type<span class="op">-&gt;</span>data<span class="op">.</span>function<span class="op">.</span>return_type <span class="op">=</span> </span>
<span id="cb44-43"><a href="#cb44-43" aria-hidden="true" tabindex="-1"></a>            resolve_type_annotation<span class="op">(</span>tc<span class="op">-&gt;</span>analyzer<span class="op">,</span> func<span class="op">-&gt;</span>return_type_annotation<span class="op">);</span></span>
<span id="cb44-44"><a href="#cb44-44" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb44-45"><a href="#cb44-45" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Infer return type</span></span>
<span id="cb44-46"><a href="#cb44-46" aria-hidden="true" tabindex="-1"></a>        func_type<span class="op">-&gt;</span>data<span class="op">.</span>function<span class="op">.</span>return_type <span class="op">=</span> infer_return_type<span class="op">(</span>tc<span class="op">,</span> func<span class="op">-&gt;</span>body<span class="op">);</span></span>
<span id="cb44-47"><a href="#cb44-47" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb44-48"><a href="#cb44-48" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-49"><a href="#cb44-49" aria-hidden="true" tabindex="-1"></a>    func_scope<span class="op">-&gt;</span>return_type <span class="op">=</span> func_type<span class="op">-&gt;</span>data<span class="op">.</span>function<span class="op">.</span>return_type<span class="op">;</span></span>
<span id="cb44-50"><a href="#cb44-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-51"><a href="#cb44-51" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check function body</span></span>
<span id="cb44-52"><a href="#cb44-52" aria-hidden="true" tabindex="-1"></a>    check_stmt<span class="op">(</span>tc<span class="op">,</span> func<span class="op">-&gt;</span>body<span class="op">);</span></span>
<span id="cb44-53"><a href="#cb44-53" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-54"><a href="#cb44-54" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Verify all paths return if needed</span></span>
<span id="cb44-55"><a href="#cb44-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>func_type<span class="op">-&gt;</span>data<span class="op">.</span>function<span class="op">.</span>return_type<span class="op">-&gt;</span>kind <span class="op">!=</span> TYPE_VOID <span class="op">&amp;&amp;</span></span>
<span id="cb44-56"><a href="#cb44-56" aria-hidden="true" tabindex="-1"></a>        <span class="op">!</span>func_scope<span class="op">-&gt;</span>has_return<span class="op">)</span> <span class="op">{</span></span>
<span id="cb44-57"><a href="#cb44-57" aria-hidden="true" tabindex="-1"></a>        semantic_warning<span class="op">(</span>tc<span class="op">-&gt;</span>analyzer<span class="op">,</span> stmt<span class="op">-&gt;</span>location<span class="op">,</span></span>
<span id="cb44-58"><a href="#cb44-58" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;Function &#39;</span><span class="sc">%s</span><span class="st">&#39; may not return a value on all paths&quot;</span><span class="op">,</span> func<span class="op">-&gt;</span>name<span class="op">);</span></span>
<span id="cb44-59"><a href="#cb44-59" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb44-60"><a href="#cb44-60" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-61"><a href="#cb44-61" aria-hidden="true" tabindex="-1"></a>    tc<span class="op">-&gt;</span>analyzer<span class="op">-&gt;</span>current_function <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb44-62"><a href="#cb44-62" aria-hidden="true" tabindex="-1"></a>    pop_scope<span class="op">(</span>tc<span class="op">-&gt;</span>analyzer<span class="op">);</span></span>
<span id="cb44-63"><a href="#cb44-63" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb44-64"><a href="#cb44-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-65"><a href="#cb44-65" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> check_return_stmt<span class="op">(</span>TypeChecker <span class="op">*</span>tc<span class="op">,</span> ASTNode <span class="op">*</span>stmt<span class="op">)</span> <span class="op">{</span></span>
<span id="cb44-66"><a href="#cb44-66" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>tc<span class="op">-&gt;</span>analyzer<span class="op">-&gt;</span>current_function<span class="op">)</span> <span class="op">{</span></span>
<span id="cb44-67"><a href="#cb44-67" aria-hidden="true" tabindex="-1"></a>        semantic_error<span class="op">(</span>tc<span class="op">-&gt;</span>analyzer<span class="op">,</span> stmt<span class="op">-&gt;</span>location<span class="op">,</span></span>
<span id="cb44-68"><a href="#cb44-68" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;Return statement outside function&quot;</span><span class="op">);</span></span>
<span id="cb44-69"><a href="#cb44-69" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span><span class="op">;</span></span>
<span id="cb44-70"><a href="#cb44-70" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb44-71"><a href="#cb44-71" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-72"><a href="#cb44-72" aria-hidden="true" tabindex="-1"></a>    Type <span class="op">*</span>expected_type <span class="op">=</span> tc<span class="op">-&gt;</span>analyzer<span class="op">-&gt;</span>current<span class="op">-&gt;</span>return_type<span class="op">;</span></span>
<span id="cb44-73"><a href="#cb44-73" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-74"><a href="#cb44-74" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>stmt<span class="op">-&gt;</span>data<span class="op">.</span>return_stmt<span class="op">.</span>value<span class="op">)</span> <span class="op">{</span></span>
<span id="cb44-75"><a href="#cb44-75" aria-hidden="true" tabindex="-1"></a>        Type <span class="op">*</span>actual_type <span class="op">=</span> check_expr<span class="op">(</span>tc<span class="op">,</span> stmt<span class="op">-&gt;</span>data<span class="op">.</span>return_stmt<span class="op">.</span>value<span class="op">);</span></span>
<span id="cb44-76"><a href="#cb44-76" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb44-77"><a href="#cb44-77" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(!</span>is_assignable_to<span class="op">(</span>actual_type<span class="op">,</span> expected_type<span class="op">))</span> <span class="op">{</span></span>
<span id="cb44-78"><a href="#cb44-78" aria-hidden="true" tabindex="-1"></a>            semantic_error<span class="op">(</span>tc<span class="op">-&gt;</span>analyzer<span class="op">,</span> stmt<span class="op">-&gt;</span>location<span class="op">,</span></span>
<span id="cb44-79"><a href="#cb44-79" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;Return type mismatch: expected </span><span class="sc">%s</span><span class="st">, got </span><span class="sc">%s</span><span class="st">&quot;</span><span class="op">,</span></span>
<span id="cb44-80"><a href="#cb44-80" aria-hidden="true" tabindex="-1"></a>                type_to_string<span class="op">(</span>expected_type<span class="op">),</span></span>
<span id="cb44-81"><a href="#cb44-81" aria-hidden="true" tabindex="-1"></a>                type_to_string<span class="op">(</span>actual_type<span class="op">));</span></span>
<span id="cb44-82"><a href="#cb44-82" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb44-83"><a href="#cb44-83" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>expected_type<span class="op">-&gt;</span>kind <span class="op">!=</span> TYPE_VOID<span class="op">)</span> <span class="op">{</span></span>
<span id="cb44-84"><a href="#cb44-84" aria-hidden="true" tabindex="-1"></a>        semantic_error<span class="op">(</span>tc<span class="op">-&gt;</span>analyzer<span class="op">,</span> stmt<span class="op">-&gt;</span>location<span class="op">,</span></span>
<span id="cb44-85"><a href="#cb44-85" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;Function expects return value of type </span><span class="sc">%s</span><span class="st">&quot;</span><span class="op">,</span></span>
<span id="cb44-86"><a href="#cb44-86" aria-hidden="true" tabindex="-1"></a>            type_to_string<span class="op">(</span>expected_type<span class="op">));</span></span>
<span id="cb44-87"><a href="#cb44-87" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb44-88"><a href="#cb44-88" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-89"><a href="#cb44-89" aria-hidden="true" tabindex="-1"></a>    tc<span class="op">-&gt;</span>analyzer<span class="op">-&gt;</span>current<span class="op">-&gt;</span>has_return <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb44-90"><a href="#cb44-90" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>3.6 Type Inference</h2>
<p>Diyrbal supports bidirectional type checking for better
inference:</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>    Type <span class="op">*</span>expected<span class="op">;</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>    Type <span class="op">*</span>actual<span class="op">;</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>    SourceLoc location<span class="op">;</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> TypeConstraint<span class="op">;</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>    TypeConstraint <span class="op">*</span>constraints<span class="op">;</span></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> count<span class="op">;</span></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> capacity<span class="op">;</span></span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Type variable substitutions</span></span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>    HashMap <span class="op">*</span>substitutions<span class="op">;</span></span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> TypeConstraints<span class="op">;</span></span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> Type<span class="op">*</span> infer_type<span class="op">(</span>TypeChecker <span class="op">*</span>tc<span class="op">,</span> ASTNode <span class="op">*</span>expr<span class="op">)</span> <span class="op">{</span></span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Use expected type if available</span></span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>tc<span class="op">-&gt;</span>expected_type <span class="op">&amp;&amp;</span> tc<span class="op">-&gt;</span>expected_type<span class="op">-&gt;</span>kind <span class="op">!=</span> TYPE_ANY<span class="op">)</span> <span class="op">{</span></span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> check_expr_against<span class="op">(</span>tc<span class="op">,</span> expr<span class="op">,</span> tc<span class="op">-&gt;</span>expected_type<span class="op">);</span></span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Otherwise synthesize type</span></span>
<span id="cb45-23"><a href="#cb45-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> check_expr<span class="op">(</span>tc<span class="op">,</span> expr<span class="op">);</span></span>
<span id="cb45-24"><a href="#cb45-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb45-25"><a href="#cb45-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-26"><a href="#cb45-26" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> Type<span class="op">*</span> check_expr_against<span class="op">(</span>TypeChecker <span class="op">*</span>tc<span class="op">,</span> ASTNode <span class="op">*</span>expr<span class="op">,</span> Type <span class="op">*</span>expected<span class="op">)</span> <span class="op">{</span></span>
<span id="cb45-27"><a href="#cb45-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> <span class="op">(</span>expr<span class="op">-&gt;</span>type<span class="op">)</span> <span class="op">{</span></span>
<span id="cb45-28"><a href="#cb45-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> AST_LAMBDA<span class="op">:</span></span>
<span id="cb45-29"><a href="#cb45-29" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> check_lambda_against<span class="op">(</span>tc<span class="op">,</span> expr<span class="op">,</span> expected<span class="op">);</span></span>
<span id="cb45-30"><a href="#cb45-30" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb45-31"><a href="#cb45-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> AST_ARRAY_LITERAL<span class="op">:</span></span>
<span id="cb45-32"><a href="#cb45-32" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> check_array_literal_against<span class="op">(</span>tc<span class="op">,</span> expr<span class="op">,</span> expected<span class="op">);</span></span>
<span id="cb45-33"><a href="#cb45-33" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb45-34"><a href="#cb45-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> AST_DICT_LITERAL<span class="op">:</span></span>
<span id="cb45-35"><a href="#cb45-35" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> check_dict_literal_against<span class="op">(</span>tc<span class="op">,</span> expr<span class="op">,</span> expected<span class="op">);</span></span>
<span id="cb45-36"><a href="#cb45-36" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb45-37"><a href="#cb45-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">default</span><span class="op">:</span></span>
<span id="cb45-38"><a href="#cb45-38" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Synthesize and check compatibility</span></span>
<span id="cb45-39"><a href="#cb45-39" aria-hidden="true" tabindex="-1"></a>            Type <span class="op">*</span>actual <span class="op">=</span> check_expr<span class="op">(</span>tc<span class="op">,</span> expr<span class="op">);</span></span>
<span id="cb45-40"><a href="#cb45-40" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(!</span>is_assignable_to<span class="op">(</span>actual<span class="op">,</span> expected<span class="op">))</span> <span class="op">{</span></span>
<span id="cb45-41"><a href="#cb45-41" aria-hidden="true" tabindex="-1"></a>                semantic_error<span class="op">(</span>tc<span class="op">-&gt;</span>analyzer<span class="op">,</span> expr<span class="op">-&gt;</span>location<span class="op">,</span></span>
<span id="cb45-42"><a href="#cb45-42" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;Type mismatch: expected </span><span class="sc">%s</span><span class="st">, got </span><span class="sc">%s</span><span class="st">&quot;</span><span class="op">,</span></span>
<span id="cb45-43"><a href="#cb45-43" aria-hidden="true" tabindex="-1"></a>                    type_to_string<span class="op">(</span>expected<span class="op">),</span></span>
<span id="cb45-44"><a href="#cb45-44" aria-hidden="true" tabindex="-1"></a>                    type_to_string<span class="op">(</span>actual<span class="op">));</span></span>
<span id="cb45-45"><a href="#cb45-45" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb45-46"><a href="#cb45-46" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> actual<span class="op">;</span></span>
<span id="cb45-47"><a href="#cb45-47" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb45-48"><a href="#cb45-48" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb45-49"><a href="#cb45-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-50"><a href="#cb45-50" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> Type<span class="op">*</span> check_lambda_against<span class="op">(</span>TypeChecker <span class="op">*</span>tc<span class="op">,</span> ASTNode <span class="op">*</span>expr<span class="op">,</span> Type <span class="op">*</span>expected<span class="op">)</span> <span class="op">{</span></span>
<span id="cb45-51"><a href="#cb45-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>expected<span class="op">-&gt;</span>kind <span class="op">!=</span> TYPE_FUNCTION<span class="op">)</span> <span class="op">{</span></span>
<span id="cb45-52"><a href="#cb45-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> check_lambda<span class="op">(</span>tc<span class="op">,</span> expr<span class="op">);</span>  <span class="co">// Fall back to synthesis</span></span>
<span id="cb45-53"><a href="#cb45-53" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb45-54"><a href="#cb45-54" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb45-55"><a href="#cb45-55" aria-hidden="true" tabindex="-1"></a>    FunctionType <span class="op">*</span>expected_func <span class="op">=</span> <span class="op">&amp;</span>expected<span class="op">-&gt;</span>data<span class="op">.</span>function<span class="op">;</span></span>
<span id="cb45-56"><a href="#cb45-56" aria-hidden="true" tabindex="-1"></a>    Lambda <span class="op">*</span>lambda <span class="op">=</span> <span class="op">&amp;</span>expr<span class="op">-&gt;</span>data<span class="op">.</span>lambda<span class="op">;</span></span>
<span id="cb45-57"><a href="#cb45-57" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb45-58"><a href="#cb45-58" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check parameter count</span></span>
<span id="cb45-59"><a href="#cb45-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>lambda<span class="op">-&gt;</span>param_count <span class="op">!=</span> expected_func<span class="op">-&gt;</span>param_count<span class="op">)</span> <span class="op">{</span></span>
<span id="cb45-60"><a href="#cb45-60" aria-hidden="true" tabindex="-1"></a>        semantic_error<span class="op">(</span>tc<span class="op">-&gt;</span>analyzer<span class="op">,</span> expr<span class="op">-&gt;</span>location<span class="op">,</span></span>
<span id="cb45-61"><a href="#cb45-61" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;Lambda expects </span><span class="sc">%zu</span><span class="st"> parameters, but </span><span class="sc">%zu</span><span class="st"> required&quot;</span><span class="op">,</span></span>
<span id="cb45-62"><a href="#cb45-62" aria-hidden="true" tabindex="-1"></a>            lambda<span class="op">-&gt;</span>param_count<span class="op">,</span> expected_func<span class="op">-&gt;</span>param_count<span class="op">);</span></span>
<span id="cb45-63"><a href="#cb45-63" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> global_type_table<span class="op">-&gt;</span>type_error<span class="op">;</span></span>
<span id="cb45-64"><a href="#cb45-64" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb45-65"><a href="#cb45-65" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb45-66"><a href="#cb45-66" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Push lambda scope</span></span>
<span id="cb45-67"><a href="#cb45-67" aria-hidden="true" tabindex="-1"></a>    push_scope<span class="op">(</span>tc<span class="op">-&gt;</span>analyzer<span class="op">,</span> SCOPE_FUNCTION<span class="op">);</span></span>
<span id="cb45-68"><a href="#cb45-68" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb45-69"><a href="#cb45-69" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Define parameters with expected types</span></span>
<span id="cb45-70"><a href="#cb45-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> lambda<span class="op">-&gt;</span>param_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb45-71"><a href="#cb45-71" aria-hidden="true" tabindex="-1"></a>        Symbol <span class="op">*</span>param <span class="op">=</span> define_symbol<span class="op">(</span>tc<span class="op">-&gt;</span>analyzer<span class="op">,</span></span>
<span id="cb45-72"><a href="#cb45-72" aria-hidden="true" tabindex="-1"></a>            lambda<span class="op">-&gt;</span>params<span class="op">[</span>i<span class="op">]-&gt;</span>data<span class="op">.</span>identifier<span class="op">.</span>name<span class="op">,</span></span>
<span id="cb45-73"><a href="#cb45-73" aria-hidden="true" tabindex="-1"></a>            SYMBOL_PARAMETER<span class="op">,</span></span>
<span id="cb45-74"><a href="#cb45-74" aria-hidden="true" tabindex="-1"></a>            expected_func<span class="op">-&gt;</span>param_types<span class="op">[</span>i<span class="op">],</span></span>
<span id="cb45-75"><a href="#cb45-75" aria-hidden="true" tabindex="-1"></a>            lambda<span class="op">-&gt;</span>params<span class="op">[</span>i<span class="op">]-&gt;</span>location<span class="op">);</span></span>
<span id="cb45-76"><a href="#cb45-76" aria-hidden="true" tabindex="-1"></a>        param<span class="op">-&gt;</span>is_initialized <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb45-77"><a href="#cb45-77" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb45-78"><a href="#cb45-78" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb45-79"><a href="#cb45-79" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check body with expected return type</span></span>
<span id="cb45-80"><a href="#cb45-80" aria-hidden="true" tabindex="-1"></a>    TypeChecker body_tc <span class="op">=</span> <span class="op">*</span>tc<span class="op">;</span></span>
<span id="cb45-81"><a href="#cb45-81" aria-hidden="true" tabindex="-1"></a>    body_tc<span class="op">.</span>expected_type <span class="op">=</span> expected_func<span class="op">-&gt;</span>return_type<span class="op">;</span></span>
<span id="cb45-82"><a href="#cb45-82" aria-hidden="true" tabindex="-1"></a>    Type <span class="op">*</span>body_type <span class="op">=</span> check_expr<span class="op">(&amp;</span>body_tc<span class="op">,</span> lambda<span class="op">-&gt;</span>body<span class="op">);</span></span>
<span id="cb45-83"><a href="#cb45-83" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb45-84"><a href="#cb45-84" aria-hidden="true" tabindex="-1"></a>    pop_scope<span class="op">(</span>tc<span class="op">-&gt;</span>analyzer<span class="op">);</span></span>
<span id="cb45-85"><a href="#cb45-85" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb45-86"><a href="#cb45-86" aria-hidden="true" tabindex="-1"></a>    expr<span class="op">-&gt;</span>expr_type <span class="op">=</span> expected<span class="op">;</span></span>
<span id="cb45-87"><a href="#cb45-87" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> expected<span class="op">;</span></span>
<span id="cb45-88"><a href="#cb45-88" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>3.7 Constant Folding</h2>
<p>Constant folding evaluates compile-time constants:</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">enum</span> <span class="op">{</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>        CONST_NULL<span class="op">,</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>        CONST_BOOL<span class="op">,</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>        CONST_INT<span class="op">,</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>        CONST_FLOAT<span class="op">,</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>        CONST_STRING</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> kind<span class="op">;</span></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">union</span> <span class="op">{</span></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>        <span class="dt">bool</span> bool_val<span class="op">;</span></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int64_t</span> int_val<span class="op">;</span></span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>        <span class="dt">double</span> float_val<span class="op">;</span></span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>        <span class="dt">char</span> <span class="op">*</span>string_val<span class="op">;</span></span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> value<span class="op">;</span></span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> ConstValue<span class="op">;</span></span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">bool</span> fold_constants<span class="op">(</span>ASTNode <span class="op">*</span>node<span class="op">)</span> <span class="op">{</span></span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> <span class="op">(</span>node<span class="op">-&gt;</span>type<span class="op">)</span> <span class="op">{</span></span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> AST_BINARY_OP<span class="op">:</span></span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> fold_binary_op<span class="op">(</span>node<span class="op">);</span></span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> AST_UNARY_OP<span class="op">:</span></span>
<span id="cb46-23"><a href="#cb46-23" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> fold_unary_op<span class="op">(</span>node<span class="op">);</span></span>
<span id="cb46-24"><a href="#cb46-24" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb46-25"><a href="#cb46-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> AST_IF<span class="op">:</span></span>
<span id="cb46-26"><a href="#cb46-26" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> fold_if_stmt<span class="op">(</span>node<span class="op">);</span></span>
<span id="cb46-27"><a href="#cb46-27" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb46-28"><a href="#cb46-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">default</span><span class="op">:</span></span>
<span id="cb46-29"><a href="#cb46-29" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Recursively fold children</span></span>
<span id="cb46-30"><a href="#cb46-30" aria-hidden="true" tabindex="-1"></a>            fold_children<span class="op">(</span>node<span class="op">);</span></span>
<span id="cb46-31"><a href="#cb46-31" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb46-32"><a href="#cb46-32" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb46-33"><a href="#cb46-33" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb46-34"><a href="#cb46-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-35"><a href="#cb46-35" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">bool</span> fold_binary_op<span class="op">(</span>ASTNode <span class="op">*</span>node<span class="op">)</span> <span class="op">{</span></span>
<span id="cb46-36"><a href="#cb46-36" aria-hidden="true" tabindex="-1"></a>    BinaryOp <span class="op">*</span>op <span class="op">=</span> <span class="op">&amp;</span>node<span class="op">-&gt;</span>data<span class="op">.</span>binary_op<span class="op">;</span></span>
<span id="cb46-37"><a href="#cb46-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb46-38"><a href="#cb46-38" aria-hidden="true" tabindex="-1"></a>    <span class="co">// First fold operands</span></span>
<span id="cb46-39"><a href="#cb46-39" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> left_folded <span class="op">=</span> fold_constants<span class="op">(</span>op<span class="op">-&gt;</span>left<span class="op">);</span></span>
<span id="cb46-40"><a href="#cb46-40" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> right_folded <span class="op">=</span> fold_constants<span class="op">(</span>op<span class="op">-&gt;</span>right<span class="op">);</span></span>
<span id="cb46-41"><a href="#cb46-41" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb46-42"><a href="#cb46-42" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check if both operands are constants</span></span>
<span id="cb46-43"><a href="#cb46-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>is_constant<span class="op">(</span>op<span class="op">-&gt;</span>left<span class="op">)</span> <span class="op">||</span> <span class="op">!</span>is_constant<span class="op">(</span>op<span class="op">-&gt;</span>right<span class="op">))</span></span>
<span id="cb46-44"><a href="#cb46-44" aria-hidden="true" tabindex="-1"></a>then constant folding can be applied<span class="op">.</span></span>
<span id="cb46-45"><a href="#cb46-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-46"><a href="#cb46-46" aria-hidden="true" tabindex="-1"></a>For example<span class="op">:</span></span>
<span id="cb46-47"><a href="#cb46-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-48"><a href="#cb46-48" aria-hidden="true" tabindex="-1"></a>```c</span>
<span id="cb46-49"><a href="#cb46-49" aria-hidden="true" tabindex="-1"></a>ConstValue <span class="op">*</span>left <span class="op">=</span> get_const_value<span class="op">(</span>op<span class="op">-&gt;</span>left<span class="op">);</span></span>
<span id="cb46-50"><a href="#cb46-50" aria-hidden="true" tabindex="-1"></a>ConstValue <span class="op">*</span>right <span class="op">=</span> get_const_value<span class="op">(</span>op<span class="op">-&gt;</span>right<span class="op">);</span></span>
<span id="cb46-51"><a href="#cb46-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-52"><a href="#cb46-52" aria-hidden="true" tabindex="-1"></a><span class="co">// Arithmetic on integers</span></span>
<span id="cb46-53"><a href="#cb46-53" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>left<span class="op">-&gt;</span>kind <span class="op">==</span> CONST_INT <span class="op">&amp;&amp;</span> right<span class="op">-&gt;</span>kind <span class="op">==</span> CONST_INT<span class="op">)</span> <span class="op">{</span></span>
<span id="cb46-54"><a href="#cb46-54" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int64_t</span> result<span class="op">;</span></span>
<span id="cb46-55"><a href="#cb46-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> <span class="op">(</span>op<span class="op">-&gt;</span>op<span class="op">)</span> <span class="op">{</span></span>
<span id="cb46-56"><a href="#cb46-56" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> TOK_PLUS<span class="op">:</span>    result <span class="op">=</span> left<span class="op">-&gt;</span>value<span class="op">.</span>int_val <span class="op">+</span> right<span class="op">-&gt;</span>value<span class="op">.</span>int_val<span class="op">;</span> <span class="cf">break</span><span class="op">;</span></span>
<span id="cb46-57"><a href="#cb46-57" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> TOK_MINUS<span class="op">:</span>   result <span class="op">=</span> left<span class="op">-&gt;</span>value<span class="op">.</span>int_val <span class="op">-</span> right<span class="op">-&gt;</span>value<span class="op">.</span>int_val<span class="op">;</span> <span class="cf">break</span><span class="op">;</span></span>
<span id="cb46-58"><a href="#cb46-58" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> TOK_STAR<span class="op">:</span>    result <span class="op">=</span> left<span class="op">-&gt;</span>value<span class="op">.</span>int_val <span class="op">*</span> right<span class="op">-&gt;</span>value<span class="op">.</span>int_val<span class="op">;</span> <span class="cf">break</span><span class="op">;</span></span>
<span id="cb46-59"><a href="#cb46-59" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> TOK_SLASH<span class="op">:</span>   result <span class="op">=</span> left<span class="op">-&gt;</span>value<span class="op">.</span>int_val <span class="op">/</span> right<span class="op">-&gt;</span>value<span class="op">.</span>int_val<span class="op">;</span> <span class="cf">break</span><span class="op">;</span></span>
<span id="cb46-60"><a href="#cb46-60" aria-hidden="true" tabindex="-1"></a>        <span class="cf">default</span><span class="op">:</span> <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb46-61"><a href="#cb46-61" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb46-62"><a href="#cb46-62" aria-hidden="true" tabindex="-1"></a>    replace_with_int_literal<span class="op">(</span>node<span class="op">,</span> result<span class="op">);</span></span>
<span id="cb46-63"><a href="#cb46-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb46-64"><a href="#cb46-64" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb46-65"><a href="#cb46-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-66"><a href="#cb46-66" aria-hidden="true" tabindex="-1"></a><span class="co">// Floating point arithmetic</span></span>
<span id="cb46-67"><a href="#cb46-67" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>left<span class="op">-&gt;</span>kind <span class="op">==</span> CONST_FLOAT <span class="op">&amp;&amp;</span> right<span class="op">-&gt;</span>kind <span class="op">==</span> CONST_FLOAT<span class="op">)</span> <span class="op">{</span></span>
<span id="cb46-68"><a href="#cb46-68" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> result<span class="op">;</span></span>
<span id="cb46-69"><a href="#cb46-69" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> <span class="op">(</span>op<span class="op">-&gt;</span>op<span class="op">)</span> <span class="op">{</span></span>
<span id="cb46-70"><a href="#cb46-70" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> TOK_PLUS<span class="op">:</span>    result <span class="op">=</span> left<span class="op">-&gt;</span>value<span class="op">.</span>float_val <span class="op">+</span> right<span class="op">-&gt;</span>value<span class="op">.</span>float_val<span class="op">;</span> <span class="cf">break</span><span class="op">;</span></span>
<span id="cb46-71"><a href="#cb46-71" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> TOK_MINUS<span class="op">:</span>   result <span class="op">=</span> left<span class="op">-&gt;</span>value<span class="op">.</span>float_val <span class="op">-</span> right<span class="op">-&gt;</span>value<span class="op">.</span>float_val<span class="op">;</span> <span class="cf">break</span><span class="op">;</span></span>
<span id="cb46-72"><a href="#cb46-72" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> TOK_STAR<span class="op">:</span>    result <span class="op">=</span> left<span class="op">-&gt;</span>value<span class="op">.</span>float_val <span class="op">*</span> right<span class="op">-&gt;</span>value<span class="op">.</span>float_val<span class="op">;</span> <span class="cf">break</span><span class="op">;</span></span>
<span id="cb46-73"><a href="#cb46-73" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> TOK_SLASH<span class="op">:</span>   result <span class="op">=</span> left<span class="op">-&gt;</span>value<span class="op">.</span>float_val <span class="op">/</span> right<span class="op">-&gt;</span>value<span class="op">.</span>float_val<span class="op">;</span> <span class="cf">break</span><span class="op">;</span></span>
<span id="cb46-74"><a href="#cb46-74" aria-hidden="true" tabindex="-1"></a>        <span class="cf">default</span><span class="op">:</span> <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb46-75"><a href="#cb46-75" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb46-76"><a href="#cb46-76" aria-hidden="true" tabindex="-1"></a>    replace_with_float_literal<span class="op">(</span>node<span class="op">,</span> result<span class="op">);</span></span>
<span id="cb46-77"><a href="#cb46-77" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb46-78"><a href="#cb46-78" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb46-79"><a href="#cb46-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-80"><a href="#cb46-80" aria-hidden="true" tabindex="-1"></a><span class="co">// Boolean simplifications</span></span>
<span id="cb46-81"><a href="#cb46-81" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>left<span class="op">-&gt;</span>kind <span class="op">==</span> CONST_BOOL <span class="op">&amp;&amp;</span> right<span class="op">-&gt;</span>kind <span class="op">==</span> CONST_BOOL<span class="op">)</span> <span class="op">{</span></span>
<span id="cb46-82"><a href="#cb46-82" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> result<span class="op">;</span></span>
<span id="cb46-83"><a href="#cb46-83" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> <span class="op">(</span>op<span class="op">-&gt;</span>op<span class="op">)</span> <span class="op">{</span></span>
<span id="cb46-84"><a href="#cb46-84" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> TOK_AND<span class="op">:</span> result <span class="op">=</span> left<span class="op">-&gt;</span>value<span class="op">.</span>bool_val <span class="op">&amp;&amp;</span> right<span class="op">-&gt;</span>value<span class="op">.</span>bool_val<span class="op">;</span> <span class="cf">break</span><span class="op">;</span></span>
<span id="cb46-85"><a href="#cb46-85" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> TOK_OR<span class="op">:</span>  result <span class="op">=</span> left<span class="op">-&gt;</span>value<span class="op">.</span>bool_val <span class="op">||</span> right<span class="op">-&gt;</span>value<span class="op">.</span>bool_val<span class="op">;</span> <span class="cf">break</span><span class="op">;</span></span>
<span id="cb46-86"><a href="#cb46-86" aria-hidden="true" tabindex="-1"></a>        <span class="cf">default</span><span class="op">:</span> <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb46-87"><a href="#cb46-87" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb46-88"><a href="#cb46-88" aria-hidden="true" tabindex="-1"></a>    replace_with_bool_literal<span class="op">(</span>node<span class="op">,</span> result<span class="op">);</span></span>
<span id="cb46-89"><a href="#cb46-89" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb46-90"><a href="#cb46-90" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb46-91"><a href="#cb46-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-92"><a href="#cb46-92" aria-hidden="true" tabindex="-1"></a><span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span></code></pre></div>
<p>This can drastically simplify ASTs before code generation by removing
dead computations.</p>
<p>Similarly for folding <code>if</code> statements:</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">bool</span> fold_if_stmt<span class="op">(</span>ASTNode <span class="op">*</span>node<span class="op">)</span> <span class="op">{</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>    IfStmt <span class="op">*</span>ifstmt <span class="op">=</span> <span class="op">&amp;</span>node<span class="op">-&gt;</span>data<span class="op">.</span>if_stmt<span class="op">;</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>fold_constants<span class="op">(</span>ifstmt<span class="op">-&gt;</span>condition<span class="op">))</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>is_constant<span class="op">(</span>ifstmt<span class="op">-&gt;</span>condition<span class="op">))</span> <span class="op">{</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>        ConstValue <span class="op">*</span>cond <span class="op">=</span> get_const_value<span class="op">(</span>ifstmt<span class="op">-&gt;</span>condition<span class="op">);</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>cond<span class="op">-&gt;</span>kind <span class="op">==</span> CONST_BOOL<span class="op">)</span> <span class="op">{</span></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Replace with taken branch</span></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>            ASTNode <span class="op">*</span>taken <span class="op">=</span> cond<span class="op">-&gt;</span>value<span class="op">.</span>bool_val <span class="op">?</span> ifstmt<span class="op">-&gt;</span>then_branch</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>                                                  <span class="op">:</span> ifstmt<span class="op">-&gt;</span>else_branch<span class="op">;</span></span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>taken<span class="op">)</span> <span class="op">{</span></span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>                <span class="op">*</span>node <span class="op">=</span> <span class="op">*</span>taken<span class="op">;</span> <span class="co">// structural replace</span></span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>3.8 Integration</h2>
<p>The semantic analysis stage binds together name resolution, type
checking, and optimization:</p>
<ol type="1">
<li><strong>Initialize</strong> the global scope and type table.</li>
<li><strong>Walk</strong> the AST, defining symbols and checking
expressions/statements.</li>
<li><strong>Accumulate</strong> any type constraints for later
inference.</li>
<li><strong>Fold constants</strong> wherever possible to simplify the
AST.</li>
<li><strong>Report</strong> errors and warnings with precise source
locations.</li>
</ol>
<p>High-level driver:</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>ASTNode <span class="op">*</span>dyr_semantic_analyze<span class="op">(</span>ASTNode <span class="op">*</span>ast<span class="op">)</span> <span class="op">{</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>    SemanticAnalyzer analyzer <span class="op">=</span> <span class="op">{</span><span class="dv">0</span><span class="op">};</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>    analyzer<span class="op">.</span>global <span class="op">=</span> push_scope<span class="op">(&amp;</span>analyzer<span class="op">,</span> SCOPE_GLOBAL<span class="op">);</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>    init_type_system<span class="op">();</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>    define_builtins<span class="op">(&amp;</span>analyzer<span class="op">);</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>    TypeChecker tc <span class="op">=</span> <span class="op">{.</span>analyzer <span class="op">=</span> <span class="op">&amp;</span>analyzer<span class="op">};</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>    check_stmt<span class="op">(&amp;</span>tc<span class="op">,</span> ast<span class="op">);</span></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>    fold_constants<span class="op">(</span>ast<span class="op">);</span></span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>    solve_constraints<span class="op">(</span>analyzer<span class="op">.</span>constraints<span class="op">);</span></span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>has_errors<span class="op">(&amp;</span>analyzer<span class="op">))</span></span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> NULL<span class="op">;</span></span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ast<span class="op">;</span> <span class="co">// now type-annotated and optimized</span></span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>3.9 Conclusion</h2>
<p>This chapter established the core of Diyrbals semantic analysis and
type system:</p>
<ul>
<li><strong>Gradual type system</strong> to balance flexibility and
safety.</li>
<li><strong>Scoped symbol tables</strong> to manage variable lifetimes
and visibility.</li>
<li><strong>Bidirectional type checking</strong> for better inference,
especially with lambdas.</li>
<li><strong>Constant folding</strong> for compile-time
optimization.</li>
<li><strong>Precise error reporting</strong> tied to source ranges for
developer productivity.</li>
</ul>
<p>A robust semantic analysis phase ensures that by the time code
generation or interpretation begins, the AST represents a well-typed,
semantically valid program  setting the stage for Diyrbals hybrid
interpreter/JIT backend to operate efficiently.</p>
<hr />
<p>If you like, I can follow this with <strong>Chapter 4: Intermediate
Representation and SSA Transformation</strong>, which would connect
directly to this type-checked AST for optimization and execution. Would
you like me to proceed with that?</p>
<h1>Chapter 4: Control Flow Graph Construction</h1>
<h2>4.1 Introduction</h2>
<p>The Control Flow Graph (CFG) is a fundamental representation that
explicitly captures the flow of control through a program. Each node in
the CFG represents a basic blocka sequence of instructions with no
branches except at the endand edges represent possible control
transfers between blocks. This chapter details the construction of CFGs
from Diyrbal&#39;s AST, a crucial step before SSA transformation and
optimization.</p>
<p>The CFG serves multiple purposes:</p>
<ul>
<li><strong>Optimization Foundation</strong>: Many optimizations operate
on the CFG structure</li>
<li><strong>SSA Construction</strong>: Dominance relationships in the
CFG guide -node placement</li>
<li><strong>Analysis Framework</strong>: Data-flow analyses traverse the
CFG</li>
<li><strong>JIT Compilation</strong>: The trace-based JIT identifies hot
paths through the CFG</li>
</ul>
<h2>4.2 Basic Block Representation</h2>
<p>A basic block is a maximal sequence of instructions where:</p>
<ul>
<li>Control enters only at the beginning</li>
<li>Control leaves only at the end</li>
<li>No internal branches or branch targets</li>
</ul>
<div class="sourceCode" id="cb49"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> BasicBlock <span class="op">{</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> id<span class="op">;</span>                    <span class="co">// Unique identifier</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span>label<span class="op">;</span>                  <span class="co">// Optional label for debugging</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Instructions in this block</span></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>    Instruction <span class="op">*</span>first<span class="op">;</span></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>    Instruction <span class="op">*</span>last<span class="op">;</span></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> instruction_count<span class="op">;</span></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Control flow edges</span></span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> BasicBlock <span class="op">**</span>predecessors<span class="op">;</span></span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> predecessor_count<span class="op">;</span></span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> predecessor_capacity<span class="op">;</span></span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> BasicBlock <span class="op">**</span>successors<span class="op">;</span></span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> successor_count<span class="op">;</span></span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> successor_capacity<span class="op">;</span></span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Terminator instruction</span></span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">enum</span> <span class="op">{</span></span>
<span id="cb49-21"><a href="#cb49-21" aria-hidden="true" tabindex="-1"></a>        TERM_NONE<span class="op">,</span>               <span class="co">// Fall through to next block</span></span>
<span id="cb49-22"><a href="#cb49-22" aria-hidden="true" tabindex="-1"></a>        TERM_JUMP<span class="op">,</span>               <span class="co">// Unconditional jump</span></span>
<span id="cb49-23"><a href="#cb49-23" aria-hidden="true" tabindex="-1"></a>        TERM_BRANCH<span class="op">,</span>             <span class="co">// Conditional branch</span></span>
<span id="cb49-24"><a href="#cb49-24" aria-hidden="true" tabindex="-1"></a>        TERM_SWITCH<span class="op">,</span>             <span class="co">// Multi-way branch</span></span>
<span id="cb49-25"><a href="#cb49-25" aria-hidden="true" tabindex="-1"></a>        TERM_RETURN<span class="op">,</span>             <span class="co">// Function return</span></span>
<span id="cb49-26"><a href="#cb49-26" aria-hidden="true" tabindex="-1"></a>        TERM_THROW               <span class="co">// Exception throw</span></span>
<span id="cb49-27"><a href="#cb49-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> terminator_type<span class="op">;</span></span>
<span id="cb49-28"><a href="#cb49-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb49-29"><a href="#cb49-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">union</span> <span class="op">{</span></span>
<span id="cb49-30"><a href="#cb49-30" aria-hidden="true" tabindex="-1"></a>        <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb49-31"><a href="#cb49-31" aria-hidden="true" tabindex="-1"></a>            <span class="kw">struct</span> BasicBlock <span class="op">*</span>target<span class="op">;</span></span>
<span id="cb49-32"><a href="#cb49-32" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> jump<span class="op">;</span></span>
<span id="cb49-33"><a href="#cb49-33" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb49-34"><a href="#cb49-34" aria-hidden="true" tabindex="-1"></a>        <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb49-35"><a href="#cb49-35" aria-hidden="true" tabindex="-1"></a>            Value <span class="op">*</span>condition<span class="op">;</span></span>
<span id="cb49-36"><a href="#cb49-36" aria-hidden="true" tabindex="-1"></a>            <span class="kw">struct</span> BasicBlock <span class="op">*</span>true_target<span class="op">;</span></span>
<span id="cb49-37"><a href="#cb49-37" aria-hidden="true" tabindex="-1"></a>            <span class="kw">struct</span> BasicBlock <span class="op">*</span>false_target<span class="op">;</span></span>
<span id="cb49-38"><a href="#cb49-38" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> branch<span class="op">;</span></span>
<span id="cb49-39"><a href="#cb49-39" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb49-40"><a href="#cb49-40" aria-hidden="true" tabindex="-1"></a>        <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb49-41"><a href="#cb49-41" aria-hidden="true" tabindex="-1"></a>            Value <span class="op">*</span>value<span class="op">;</span></span>
<span id="cb49-42"><a href="#cb49-42" aria-hidden="true" tabindex="-1"></a>            <span class="kw">struct</span> BasicBlock <span class="op">**</span>targets<span class="op">;</span></span>
<span id="cb49-43"><a href="#cb49-43" aria-hidden="true" tabindex="-1"></a>            <span class="dt">size_t</span> target_count<span class="op">;</span></span>
<span id="cb49-44"><a href="#cb49-44" aria-hidden="true" tabindex="-1"></a>            <span class="kw">struct</span> BasicBlock <span class="op">*</span>default_target<span class="op">;</span></span>
<span id="cb49-45"><a href="#cb49-45" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> switch_stmt<span class="op">;</span></span>
<span id="cb49-46"><a href="#cb49-46" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb49-47"><a href="#cb49-47" aria-hidden="true" tabindex="-1"></a>        <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb49-48"><a href="#cb49-48" aria-hidden="true" tabindex="-1"></a>            Value <span class="op">*</span>value<span class="op">;</span>  <span class="co">// NULL for void return</span></span>
<span id="cb49-49"><a href="#cb49-49" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> return_stmt<span class="op">;</span></span>
<span id="cb49-50"><a href="#cb49-50" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> terminator<span class="op">;</span></span>
<span id="cb49-51"><a href="#cb49-51" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb49-52"><a href="#cb49-52" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Analysis information</span></span>
<span id="cb49-53"><a href="#cb49-53" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> dom_depth<span class="op">;</span>            <span class="co">// Depth in dominator tree</span></span>
<span id="cb49-54"><a href="#cb49-54" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> BasicBlock <span class="op">*</span>idom<span class="op">;</span>     <span class="co">// Immediate dominator</span></span>
<span id="cb49-55"><a href="#cb49-55" aria-hidden="true" tabindex="-1"></a>    BitSet <span class="op">*</span>dominators<span class="op">;</span>          <span class="co">// Set of dominators</span></span>
<span id="cb49-56"><a href="#cb49-56" aria-hidden="true" tabindex="-1"></a>    BitSet <span class="op">*</span>df<span class="op">;</span>                  <span class="co">// Dominance frontier</span></span>
<span id="cb49-57"><a href="#cb49-57" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb49-58"><a href="#cb49-58" aria-hidden="true" tabindex="-1"></a>    <span class="co">// For CFG construction</span></span>
<span id="cb49-59"><a href="#cb49-59" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> is_reachable<span class="op">;</span></span>
<span id="cb49-60"><a href="#cb49-60" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> is_sealed<span class="op">;</span>              <span class="co">// For SSA construction</span></span>
<span id="cb49-61"><a href="#cb49-61" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb49-62"><a href="#cb49-62" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Loop information</span></span>
<span id="cb49-63"><a href="#cb49-63" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> Loop <span class="op">*</span>loop<span class="op">;</span></span>
<span id="cb49-64"><a href="#cb49-64" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> is_loop_header<span class="op">;</span></span>
<span id="cb49-65"><a href="#cb49-65" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb49-66"><a href="#cb49-66" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Profiling data</span></span>
<span id="cb49-67"><a href="#cb49-67" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint64_t</span> execution_count<span class="op">;</span></span>
<span id="cb49-68"><a href="#cb49-68" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> execution_frequency<span class="op">;</span></span>
<span id="cb49-69"><a href="#cb49-69" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> BasicBlock<span class="op">;</span></span>
<span id="cb49-70"><a href="#cb49-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-71"><a href="#cb49-71" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> CFG <span class="op">{</span></span>
<span id="cb49-72"><a href="#cb49-72" aria-hidden="true" tabindex="-1"></a>    BasicBlock <span class="op">*</span>entry<span class="op">;</span></span>
<span id="cb49-73"><a href="#cb49-73" aria-hidden="true" tabindex="-1"></a>    BasicBlock <span class="op">*</span>exit<span class="op">;</span></span>
<span id="cb49-74"><a href="#cb49-74" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb49-75"><a href="#cb49-75" aria-hidden="true" tabindex="-1"></a>    BasicBlock <span class="op">**</span>blocks<span class="op">;</span></span>
<span id="cb49-76"><a href="#cb49-76" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> block_count<span class="op">;</span></span>
<span id="cb49-77"><a href="#cb49-77" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> block_capacity<span class="op">;</span></span>
<span id="cb49-78"><a href="#cb49-78" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb49-79"><a href="#cb49-79" aria-hidden="true" tabindex="-1"></a>    <span class="co">// For block allocation</span></span>
<span id="cb49-80"><a href="#cb49-80" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> next_block_id<span class="op">;</span></span>
<span id="cb49-81"><a href="#cb49-81" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb49-82"><a href="#cb49-82" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Parent function</span></span>
<span id="cb49-83"><a href="#cb49-83" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> Function <span class="op">*</span>function<span class="op">;</span></span>
<span id="cb49-84"><a href="#cb49-84" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb49-85"><a href="#cb49-85" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Analysis results  </span></span>
<span id="cb49-86"><a href="#cb49-86" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> dominance_computed<span class="op">;</span></span>
<span id="cb49-87"><a href="#cb49-87" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> loops_analyzed<span class="op">;</span></span>
<span id="cb49-88"><a href="#cb49-88" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> CFG<span class="op">;</span></span></code></pre></div>
<h2>4.3 Instruction Representation</h2>
<p>Before building the CFG, we need an intermediate representation for
instructions:</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">enum</span> <span class="op">{</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Arithmetic</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>    INST_ADD<span class="op">,</span> INST_SUB<span class="op">,</span> INST_MUL<span class="op">,</span> INST_DIV<span class="op">,</span> INST_MOD<span class="op">,</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>    INST_NEG<span class="op">,</span> INST_ABS<span class="op">,</span></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Comparison</span></span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>    INST_EQ<span class="op">,</span> INST_NE<span class="op">,</span> INST_LT<span class="op">,</span> INST_LE<span class="op">,</span> INST_GT<span class="op">,</span> INST_GE<span class="op">,</span></span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Logical</span></span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>    INST_AND<span class="op">,</span> INST_OR<span class="op">,</span> INST_NOT<span class="op">,</span></span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Memory</span></span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>    INST_LOAD<span class="op">,</span> INST_STORE<span class="op">,</span> INST_ALLOCA<span class="op">,</span></span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>    INST_LOAD_FIELD<span class="op">,</span> INST_STORE_FIELD<span class="op">,</span></span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a>    INST_LOAD_ELEMENT<span class="op">,</span> INST_STORE_ELEMENT<span class="op">,</span></span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Control flow</span></span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a>    INST_JUMP<span class="op">,</span> INST_BRANCH<span class="op">,</span> INST_SWITCH<span class="op">,</span> INST_RETURN<span class="op">,</span></span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a>    INST_CALL<span class="op">,</span> INST_TAIL_CALL<span class="op">,</span></span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb50-21"><a href="#cb50-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Type operations</span></span>
<span id="cb50-22"><a href="#cb50-22" aria-hidden="true" tabindex="-1"></a>    INST_CAST<span class="op">,</span> INST_INSTANCEOF<span class="op">,</span></span>
<span id="cb50-23"><a href="#cb50-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb50-24"><a href="#cb50-24" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Constants</span></span>
<span id="cb50-25"><a href="#cb50-25" aria-hidden="true" tabindex="-1"></a>    INST_CONST_INT<span class="op">,</span> INST_CONST_FLOAT<span class="op">,</span> INST_CONST_STRING<span class="op">,</span></span>
<span id="cb50-26"><a href="#cb50-26" aria-hidden="true" tabindex="-1"></a>    INST_CONST_BOOL<span class="op">,</span> INST_CONST_NULL<span class="op">,</span></span>
<span id="cb50-27"><a href="#cb50-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb50-28"><a href="#cb50-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">// SSA operations</span></span>
<span id="cb50-29"><a href="#cb50-29" aria-hidden="true" tabindex="-1"></a>    INST_PHI<span class="op">,</span></span>
<span id="cb50-30"><a href="#cb50-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb50-31"><a href="#cb50-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Other</span></span>
<span id="cb50-32"><a href="#cb50-32" aria-hidden="true" tabindex="-1"></a>    INST_NOP<span class="op">,</span> INST_UNREACHABLE</span>
<span id="cb50-33"><a href="#cb50-33" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> InstructionKind<span class="op">;</span></span>
<span id="cb50-34"><a href="#cb50-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-35"><a href="#cb50-35" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> Value <span class="op">{</span></span>
<span id="cb50-36"><a href="#cb50-36" aria-hidden="true" tabindex="-1"></a>    <span class="kw">enum</span> <span class="op">{</span></span>
<span id="cb50-37"><a href="#cb50-37" aria-hidden="true" tabindex="-1"></a>        VALUE_CONST<span class="op">,</span></span>
<span id="cb50-38"><a href="#cb50-38" aria-hidden="true" tabindex="-1"></a>        VALUE_TEMP<span class="op">,</span></span>
<span id="cb50-39"><a href="#cb50-39" aria-hidden="true" tabindex="-1"></a>        VALUE_PARAM<span class="op">,</span></span>
<span id="cb50-40"><a href="#cb50-40" aria-hidden="true" tabindex="-1"></a>        VALUE_GLOBAL</span>
<span id="cb50-41"><a href="#cb50-41" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> kind<span class="op">;</span></span>
<span id="cb50-42"><a href="#cb50-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb50-43"><a href="#cb50-43" aria-hidden="true" tabindex="-1"></a>    Type <span class="op">*</span>type<span class="op">;</span></span>
<span id="cb50-44"><a href="#cb50-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb50-45"><a href="#cb50-45" aria-hidden="true" tabindex="-1"></a>    <span class="kw">union</span> <span class="op">{</span></span>
<span id="cb50-46"><a href="#cb50-46" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Constants</span></span>
<span id="cb50-47"><a href="#cb50-47" aria-hidden="true" tabindex="-1"></a>        <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb50-48"><a href="#cb50-48" aria-hidden="true" tabindex="-1"></a>            <span class="kw">union</span> <span class="op">{</span></span>
<span id="cb50-49"><a href="#cb50-49" aria-hidden="true" tabindex="-1"></a>                <span class="dt">int64_t</span> int_val<span class="op">;</span></span>
<span id="cb50-50"><a href="#cb50-50" aria-hidden="true" tabindex="-1"></a>                <span class="dt">double</span> float_val<span class="op">;</span></span>
<span id="cb50-51"><a href="#cb50-51" aria-hidden="true" tabindex="-1"></a>                <span class="dt">char</span> <span class="op">*</span>string_val<span class="op">;</span></span>
<span id="cb50-52"><a href="#cb50-52" aria-hidden="true" tabindex="-1"></a>                <span class="dt">bool</span> bool_val<span class="op">;</span></span>
<span id="cb50-53"><a href="#cb50-53" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span> data<span class="op">;</span></span>
<span id="cb50-54"><a href="#cb50-54" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> constant<span class="op">;</span></span>
<span id="cb50-55"><a href="#cb50-55" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb50-56"><a href="#cb50-56" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Temporaries</span></span>
<span id="cb50-57"><a href="#cb50-57" aria-hidden="true" tabindex="-1"></a>        <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb50-58"><a href="#cb50-58" aria-hidden="true" tabindex="-1"></a>            <span class="dt">size_t</span> id<span class="op">;</span></span>
<span id="cb50-59"><a href="#cb50-59" aria-hidden="true" tabindex="-1"></a>            <span class="dt">char</span> <span class="op">*</span>name<span class="op">;</span>  <span class="co">// Optional, for debugging</span></span>
<span id="cb50-60"><a href="#cb50-60" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> temp<span class="op">;</span></span>
<span id="cb50-61"><a href="#cb50-61" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb50-62"><a href="#cb50-62" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Parameters</span></span>
<span id="cb50-63"><a href="#cb50-63" aria-hidden="true" tabindex="-1"></a>        <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb50-64"><a href="#cb50-64" aria-hidden="true" tabindex="-1"></a>            <span class="dt">size_t</span> index<span class="op">;</span></span>
<span id="cb50-65"><a href="#cb50-65" aria-hidden="true" tabindex="-1"></a>            <span class="dt">char</span> <span class="op">*</span>name<span class="op">;</span></span>
<span id="cb50-66"><a href="#cb50-66" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> param<span class="op">;</span></span>
<span id="cb50-67"><a href="#cb50-67" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb50-68"><a href="#cb50-68" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Globals</span></span>
<span id="cb50-69"><a href="#cb50-69" aria-hidden="true" tabindex="-1"></a>        <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb50-70"><a href="#cb50-70" aria-hidden="true" tabindex="-1"></a>            <span class="dt">char</span> <span class="op">*</span>name<span class="op">;</span></span>
<span id="cb50-71"><a href="#cb50-71" aria-hidden="true" tabindex="-1"></a>            <span class="dt">void</span> <span class="op">*</span>symbol<span class="op">;</span></span>
<span id="cb50-72"><a href="#cb50-72" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> global<span class="op">;</span></span>
<span id="cb50-73"><a href="#cb50-73" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> data<span class="op">;</span></span>
<span id="cb50-74"><a href="#cb50-74" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb50-75"><a href="#cb50-75" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Def-use chains</span></span>
<span id="cb50-76"><a href="#cb50-76" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> Instruction <span class="op">*</span>def<span class="op">;</span>     <span class="co">// Defining instruction</span></span>
<span id="cb50-77"><a href="#cb50-77" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> Use <span class="op">*</span>uses<span class="op">;</span>            <span class="co">// List of uses</span></span>
<span id="cb50-78"><a href="#cb50-78" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> Value<span class="op">;</span></span>
<span id="cb50-79"><a href="#cb50-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-80"><a href="#cb50-80" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> Instruction <span class="op">{</span></span>
<span id="cb50-81"><a href="#cb50-81" aria-hidden="true" tabindex="-1"></a>    InstructionKind kind<span class="op">;</span></span>
<span id="cb50-82"><a href="#cb50-82" aria-hidden="true" tabindex="-1"></a>    Value <span class="op">*</span>result<span class="op">;</span>               <span class="co">// NULL if void</span></span>
<span id="cb50-83"><a href="#cb50-83" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb50-84"><a href="#cb50-84" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Operands</span></span>
<span id="cb50-85"><a href="#cb50-85" aria-hidden="true" tabindex="-1"></a>    Value <span class="op">**</span>operands<span class="op">;</span></span>
<span id="cb50-86"><a href="#cb50-86" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> operand_count<span class="op">;</span></span>
<span id="cb50-87"><a href="#cb50-87" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb50-88"><a href="#cb50-88" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Source location for debugging</span></span>
<span id="cb50-89"><a href="#cb50-89" aria-hidden="true" tabindex="-1"></a>    SourceLoc location<span class="op">;</span></span>
<span id="cb50-90"><a href="#cb50-90" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb50-91"><a href="#cb50-91" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Links</span></span>
<span id="cb50-92"><a href="#cb50-92" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> Instruction <span class="op">*</span>prev<span class="op">;</span></span>
<span id="cb50-93"><a href="#cb50-93" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> Instruction <span class="op">*</span>next<span class="op">;</span></span>
<span id="cb50-94"><a href="#cb50-94" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> BasicBlock <span class="op">*</span>block<span class="op">;</span></span>
<span id="cb50-95"><a href="#cb50-95" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb50-96"><a href="#cb50-96" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Additional data for specific instructions</span></span>
<span id="cb50-97"><a href="#cb50-97" aria-hidden="true" tabindex="-1"></a>    <span class="kw">union</span> <span class="op">{</span></span>
<span id="cb50-98"><a href="#cb50-98" aria-hidden="true" tabindex="-1"></a>        <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb50-99"><a href="#cb50-99" aria-hidden="true" tabindex="-1"></a>            Function <span class="op">*</span>target<span class="op">;</span></span>
<span id="cb50-100"><a href="#cb50-100" aria-hidden="true" tabindex="-1"></a>            <span class="dt">bool</span> is_tail_call<span class="op">;</span></span>
<span id="cb50-101"><a href="#cb50-101" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> call<span class="op">;</span></span>
<span id="cb50-102"><a href="#cb50-102" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb50-103"><a href="#cb50-103" aria-hidden="true" tabindex="-1"></a>        <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb50-104"><a href="#cb50-104" aria-hidden="true" tabindex="-1"></a>            <span class="dt">size_t</span> incoming_count<span class="op">;</span></span>
<span id="cb50-105"><a href="#cb50-105" aria-hidden="true" tabindex="-1"></a>            Value <span class="op">**</span>incoming_values<span class="op">;</span></span>
<span id="cb50-106"><a href="#cb50-106" aria-hidden="true" tabindex="-1"></a>            BasicBlock <span class="op">**</span>incoming_blocks<span class="op">;</span></span>
<span id="cb50-107"><a href="#cb50-107" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> phi<span class="op">;</span></span>
<span id="cb50-108"><a href="#cb50-108" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> data<span class="op">;</span></span>
<span id="cb50-109"><a href="#cb50-109" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> Instruction<span class="op">;</span></span></code></pre></div>
<h2>4.4 CFG Builder</h2>
<p>The CFG builder traverses the AST and generates basic blocks:</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> CFGBuilder <span class="op">{</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>    CFG <span class="op">*</span>cfg<span class="op">;</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>    BasicBlock <span class="op">*</span>current_block<span class="op">;</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Stack for nested control structures</span></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>        BasicBlock <span class="op">*</span>continue_target<span class="op">;</span></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>        BasicBlock <span class="op">*</span>break_target<span class="op">;</span></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="op">*</span>loop_stack<span class="op">;</span></span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> loop_depth<span class="op">;</span></span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> loop_stack_capacity<span class="op">;</span></span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Temporary allocation</span></span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> next_temp_id<span class="op">;</span></span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Error handling</span></span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a>    ErrorList <span class="op">*</span>errors<span class="op">;</span></span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> CFGBuilder<span class="op">;</span></span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-20"><a href="#cb51-20" aria-hidden="true" tabindex="-1"></a>CFG<span class="op">*</span> build_cfg<span class="op">(</span>Function <span class="op">*</span>function<span class="op">)</span> <span class="op">{</span></span>
<span id="cb51-21"><a href="#cb51-21" aria-hidden="true" tabindex="-1"></a>    CFGBuilder builder <span class="op">=</span> <span class="op">{</span><span class="dv">0</span><span class="op">};</span></span>
<span id="cb51-22"><a href="#cb51-22" aria-hidden="true" tabindex="-1"></a>    builder<span class="op">.</span>cfg <span class="op">=</span> calloc<span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>CFG<span class="op">));</span></span>
<span id="cb51-23"><a href="#cb51-23" aria-hidden="true" tabindex="-1"></a>    builder<span class="op">.</span>cfg<span class="op">-&gt;</span>function <span class="op">=</span> function<span class="op">;</span></span>
<span id="cb51-24"><a href="#cb51-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-25"><a href="#cb51-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Create entry block</span></span>
<span id="cb51-26"><a href="#cb51-26" aria-hidden="true" tabindex="-1"></a>    builder<span class="op">.</span>cfg<span class="op">-&gt;</span>entry <span class="op">=</span> create_block<span class="op">(&amp;</span>builder<span class="op">,</span> <span class="st">&quot;entry&quot;</span><span class="op">);</span></span>
<span id="cb51-27"><a href="#cb51-27" aria-hidden="true" tabindex="-1"></a>    builder<span class="op">.</span>current_block <span class="op">=</span> builder<span class="op">.</span>cfg<span class="op">-&gt;</span>entry<span class="op">;</span></span>
<span id="cb51-28"><a href="#cb51-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-29"><a href="#cb51-29" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Build CFG from function body</span></span>
<span id="cb51-30"><a href="#cb51-30" aria-hidden="true" tabindex="-1"></a>    Value <span class="op">*</span>result <span class="op">=</span> build_stmt<span class="op">(&amp;</span>builder<span class="op">,</span> function<span class="op">-&gt;</span>body<span class="op">);</span></span>
<span id="cb51-31"><a href="#cb51-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-32"><a href="#cb51-32" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Ensure all paths end with return</span></span>
<span id="cb51-33"><a href="#cb51-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>block_has_terminator<span class="op">(</span>builder<span class="op">.</span>current_block<span class="op">))</span> <span class="op">{</span></span>
<span id="cb51-34"><a href="#cb51-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>function<span class="op">-&gt;</span>return_type<span class="op">-&gt;</span>kind <span class="op">==</span> TYPE_VOID<span class="op">)</span> <span class="op">{</span></span>
<span id="cb51-35"><a href="#cb51-35" aria-hidden="true" tabindex="-1"></a>            emit_return<span class="op">(&amp;</span>builder<span class="op">,</span> NULL<span class="op">);</span></span>
<span id="cb51-36"><a href="#cb51-36" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb51-37"><a href="#cb51-37" aria-hidden="true" tabindex="-1"></a>            error<span class="op">(&amp;</span>builder<span class="op">,</span> function<span class="op">-&gt;</span>body<span class="op">-&gt;</span>location<span class="op">,</span></span>
<span id="cb51-38"><a href="#cb51-38" aria-hidden="true" tabindex="-1"></a>                  <span class="st">&quot;Function does not return on all paths&quot;</span><span class="op">);</span></span>
<span id="cb51-39"><a href="#cb51-39" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb51-40"><a href="#cb51-40" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb51-41"><a href="#cb51-41" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-42"><a href="#cb51-42" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Create exit block</span></span>
<span id="cb51-43"><a href="#cb51-43" aria-hidden="true" tabindex="-1"></a>    builder<span class="op">.</span>cfg<span class="op">-&gt;</span>exit <span class="op">=</span> create_block<span class="op">(&amp;</span>builder<span class="op">,</span> <span class="st">&quot;exit&quot;</span><span class="op">);</span></span>
<span id="cb51-44"><a href="#cb51-44" aria-hidden="true" tabindex="-1"></a>    connect_returns_to_exit<span class="op">(</span>builder<span class="op">.</span>cfg<span class="op">);</span></span>
<span id="cb51-45"><a href="#cb51-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-46"><a href="#cb51-46" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Clean up unreachable blocks</span></span>
<span id="cb51-47"><a href="#cb51-47" aria-hidden="true" tabindex="-1"></a>    remove_unreachable_blocks<span class="op">(</span>builder<span class="op">.</span>cfg<span class="op">);</span></span>
<span id="cb51-48"><a href="#cb51-48" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-49"><a href="#cb51-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> builder<span class="op">.</span>cfg<span class="op">;</span></span>
<span id="cb51-50"><a href="#cb51-50" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb51-51"><a href="#cb51-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-52"><a href="#cb51-52" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> BasicBlock<span class="op">*</span> create_block<span class="op">(</span>CFGBuilder <span class="op">*</span>builder<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>label<span class="op">)</span> <span class="op">{</span></span>
<span id="cb51-53"><a href="#cb51-53" aria-hidden="true" tabindex="-1"></a>    BasicBlock <span class="op">*</span>block <span class="op">=</span> calloc<span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>BasicBlock<span class="op">));</span></span>
<span id="cb51-54"><a href="#cb51-54" aria-hidden="true" tabindex="-1"></a>    block<span class="op">-&gt;</span>id <span class="op">=</span> builder<span class="op">-&gt;</span>cfg<span class="op">-&gt;</span>next_block_id<span class="op">++;</span></span>
<span id="cb51-55"><a href="#cb51-55" aria-hidden="true" tabindex="-1"></a>    block<span class="op">-&gt;</span>label <span class="op">=</span> label <span class="op">?</span> strdup<span class="op">(</span>label<span class="op">)</span> <span class="op">:</span> NULL<span class="op">;</span></span>
<span id="cb51-56"><a href="#cb51-56" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-57"><a href="#cb51-57" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Add to CFG</span></span>
<span id="cb51-58"><a href="#cb51-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>builder<span class="op">-&gt;</span>cfg<span class="op">-&gt;</span>block_count <span class="op">&gt;=</span> builder<span class="op">-&gt;</span>cfg<span class="op">-&gt;</span>block_capacity<span class="op">)</span> <span class="op">{</span></span>
<span id="cb51-59"><a href="#cb51-59" aria-hidden="true" tabindex="-1"></a>        builder<span class="op">-&gt;</span>cfg<span class="op">-&gt;</span>block_capacity <span class="op">=</span> builder<span class="op">-&gt;</span>cfg<span class="op">-&gt;</span>block_capacity <span class="op">*</span> <span class="dv">2</span> <span class="op">+</span> <span class="dv">8</span><span class="op">;</span></span>
<span id="cb51-60"><a href="#cb51-60" aria-hidden="true" tabindex="-1"></a>        builder<span class="op">-&gt;</span>cfg<span class="op">-&gt;</span>blocks <span class="op">=</span> realloc<span class="op">(</span>builder<span class="op">-&gt;</span>cfg<span class="op">-&gt;</span>blocks<span class="op">,</span></span>
<span id="cb51-61"><a href="#cb51-61" aria-hidden="true" tabindex="-1"></a>            builder<span class="op">-&gt;</span>cfg<span class="op">-&gt;</span>block_capacity <span class="op">*</span> <span class="kw">sizeof</span><span class="op">(</span>BasicBlock<span class="op">*));</span></span>
<span id="cb51-62"><a href="#cb51-62" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb51-63"><a href="#cb51-63" aria-hidden="true" tabindex="-1"></a>    builder<span class="op">-&gt;</span>cfg<span class="op">-&gt;</span>blocks<span class="op">[</span>builder<span class="op">-&gt;</span>cfg<span class="op">-&gt;</span>block_count<span class="op">++]</span> <span class="op">=</span> block<span class="op">;</span></span>
<span id="cb51-64"><a href="#cb51-64" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-65"><a href="#cb51-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> block<span class="op">;</span></span>
<span id="cb51-66"><a href="#cb51-66" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>4.5 Statement Translation</h2>
<p>Each statement type is translated into basic blocks and
instructions:</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> Value<span class="op">*</span> build_stmt<span class="op">(</span>CFGBuilder <span class="op">*</span>builder<span class="op">,</span> ASTNode <span class="op">*</span>stmt<span class="op">)</span> <span class="op">{</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> <span class="op">(</span>stmt<span class="op">-&gt;</span>type<span class="op">)</span> <span class="op">{</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> AST_BLOCK<span class="op">:</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> build_block_stmt<span class="op">(</span>builder<span class="op">,</span> stmt<span class="op">);</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> AST_ASSIGN<span class="op">:</span></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> build_assignment<span class="op">(</span>builder<span class="op">,</span> stmt<span class="op">);</span></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> AST_IF<span class="op">:</span></span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> build_if_stmt<span class="op">(</span>builder<span class="op">,</span> stmt<span class="op">);</span></span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> AST_WHILE<span class="op">:</span></span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> build_while_stmt<span class="op">(</span>builder<span class="op">,</span> stmt<span class="op">);</span></span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> AST_FOR<span class="op">:</span></span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> build_for_stmt<span class="op">(</span>builder<span class="op">,</span> stmt<span class="op">);</span></span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> AST_RETURN<span class="op">:</span></span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> build_return_stmt<span class="op">(</span>builder<span class="op">,</span> stmt<span class="op">);</span></span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb52-21"><a href="#cb52-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> AST_BREAK<span class="op">:</span></span>
<span id="cb52-22"><a href="#cb52-22" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> build_break_stmt<span class="op">(</span>builder<span class="op">,</span> stmt<span class="op">);</span></span>
<span id="cb52-23"><a href="#cb52-23" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb52-24"><a href="#cb52-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> AST_CONTINUE<span class="op">:</span></span>
<span id="cb52-25"><a href="#cb52-25" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> build_continue_stmt<span class="op">(</span>builder<span class="op">,</span> stmt<span class="op">);</span></span>
<span id="cb52-26"><a href="#cb52-26" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb52-27"><a href="#cb52-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> AST_EXPR_STMT<span class="op">:</span></span>
<span id="cb52-28"><a href="#cb52-28" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> build_expr<span class="op">(</span>builder<span class="op">,</span> stmt<span class="op">-&gt;</span>data<span class="op">.</span>expr_stmt<span class="op">.</span>expr<span class="op">);</span></span>
<span id="cb52-29"><a href="#cb52-29" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb52-30"><a href="#cb52-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">default</span><span class="op">:</span></span>
<span id="cb52-31"><a href="#cb52-31" aria-hidden="true" tabindex="-1"></a>            error<span class="op">(</span>builder<span class="op">,</span> stmt<span class="op">-&gt;</span>location<span class="op">,</span> <span class="st">&quot;Unknown statement type&quot;</span><span class="op">);</span></span>
<span id="cb52-32"><a href="#cb52-32" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> NULL<span class="op">;</span></span>
<span id="cb52-33"><a href="#cb52-33" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb52-34"><a href="#cb52-34" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb52-35"><a href="#cb52-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-36"><a href="#cb52-36" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> Value<span class="op">*</span> build_if_stmt<span class="op">(</span>CFGBuilder <span class="op">*</span>builder<span class="op">,</span> ASTNode <span class="op">*</span>stmt<span class="op">)</span> <span class="op">{</span></span>
<span id="cb52-37"><a href="#cb52-37" aria-hidden="true" tabindex="-1"></a>    IfStmt <span class="op">*</span>if_stmt <span class="op">=</span> <span class="op">&amp;</span>stmt<span class="op">-&gt;</span>data<span class="op">.</span>if_stmt<span class="op">;</span></span>
<span id="cb52-38"><a href="#cb52-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb52-39"><a href="#cb52-39" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Evaluate condition</span></span>
<span id="cb52-40"><a href="#cb52-40" aria-hidden="true" tabindex="-1"></a>    Value <span class="op">*</span>cond <span class="op">=</span> build_expr<span class="op">(</span>builder<span class="op">,</span> if_stmt<span class="op">-&gt;</span>condition<span class="op">);</span></span>
<span id="cb52-41"><a href="#cb52-41" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb52-42"><a href="#cb52-42" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Create blocks</span></span>
<span id="cb52-43"><a href="#cb52-43" aria-hidden="true" tabindex="-1"></a>    BasicBlock <span class="op">*</span>then_block <span class="op">=</span> create_block<span class="op">(</span>builder<span class="op">,</span> <span class="st">&quot;if.then&quot;</span><span class="op">);</span></span>
<span id="cb52-44"><a href="#cb52-44" aria-hidden="true" tabindex="-1"></a>    BasicBlock <span class="op">*</span>else_block <span class="op">=</span> if_stmt<span class="op">-&gt;</span>else_branch <span class="op">?</span> </span>
<span id="cb52-45"><a href="#cb52-45" aria-hidden="true" tabindex="-1"></a>        create_block<span class="op">(</span>builder<span class="op">,</span> <span class="st">&quot;if.else&quot;</span><span class="op">)</span> <span class="op">:</span> NULL<span class="op">;</span></span>
<span id="cb52-46"><a href="#cb52-46" aria-hidden="true" tabindex="-1"></a>    BasicBlock <span class="op">*</span>merge_block <span class="op">=</span> create_block<span class="op">(</span>builder<span class="op">,</span> <span class="st">&quot;if.merge&quot;</span><span class="op">);</span></span>
<span id="cb52-47"><a href="#cb52-47" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb52-48"><a href="#cb52-48" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Emit conditional branch</span></span>
<span id="cb52-49"><a href="#cb52-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>else_block<span class="op">)</span> <span class="op">{</span></span>
<span id="cb52-50"><a href="#cb52-50" aria-hidden="true" tabindex="-1"></a>        emit_branch<span class="op">(</span>builder<span class="op">,</span> cond<span class="op">,</span> then_block<span class="op">,</span> else_block<span class="op">);</span></span>
<span id="cb52-51"><a href="#cb52-51" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb52-52"><a href="#cb52-52" aria-hidden="true" tabindex="-1"></a>        emit_branch<span class="op">(</span>builder<span class="op">,</span> cond<span class="op">,</span> then_block<span class="op">,</span> merge_block<span class="op">);</span></span>
<span id="cb52-53"><a href="#cb52-53" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb52-54"><a href="#cb52-54" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb52-55"><a href="#cb52-55" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Build then branch</span></span>
<span id="cb52-56"><a href="#cb52-56" aria-hidden="true" tabindex="-1"></a>    builder<span class="op">-&gt;</span>current_block <span class="op">=</span> then_block<span class="op">;</span></span>
<span id="cb52-57"><a href="#cb52-57" aria-hidden="true" tabindex="-1"></a>    build_stmt<span class="op">(</span>builder<span class="op">,</span> if_stmt<span class="op">-&gt;</span>then_branch<span class="op">);</span></span>
<span id="cb52-58"><a href="#cb52-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>block_has_terminator<span class="op">(</span>builder<span class="op">-&gt;</span>current_block<span class="op">))</span> <span class="op">{</span></span>
<span id="cb52-59"><a href="#cb52-59" aria-hidden="true" tabindex="-1"></a>        emit_jump<span class="op">(</span>builder<span class="op">,</span> merge_block<span class="op">);</span></span>
<span id="cb52-60"><a href="#cb52-60" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb52-61"><a href="#cb52-61" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb52-62"><a href="#cb52-62" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Build else branch if present</span></span>
<span id="cb52-63"><a href="#cb52-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>else_block<span class="op">)</span> <span class="op">{</span></span>
<span id="cb52-64"><a href="#cb52-64" aria-hidden="true" tabindex="-1"></a>        builder<span class="op">-&gt;</span>current_block <span class="op">=</span> else_block<span class="op">;</span></span>
<span id="cb52-65"><a href="#cb52-65" aria-hidden="true" tabindex="-1"></a>        build_stmt<span class="op">(</span>builder<span class="op">,</span> if_stmt<span class="op">-&gt;</span>else_branch<span class="op">);</span></span>
<span id="cb52-66"><a href="#cb52-66" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(!</span>block_has_terminator<span class="op">(</span>builder<span class="op">-&gt;</span>current_block<span class="op">))</span> <span class="op">{</span></span>
<span id="cb52-67"><a href="#cb52-67" aria-hidden="true" tabindex="-1"></a>            emit_jump<span class="op">(</span>builder<span class="op">,</span> merge_block<span class="op">);</span></span>
<span id="cb52-68"><a href="#cb52-68" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb52-69"><a href="#cb52-69" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb52-70"><a href="#cb52-70" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb52-71"><a href="#cb52-71" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Continue with merge block</span></span>
<span id="cb52-72"><a href="#cb52-72" aria-hidden="true" tabindex="-1"></a>    builder<span class="op">-&gt;</span>current_block <span class="op">=</span> merge_block<span class="op">;</span></span>
<span id="cb52-73"><a href="#cb52-73" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> NULL<span class="op">;</span></span>
<span id="cb52-74"><a href="#cb52-74" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb52-75"><a href="#cb52-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-76"><a href="#cb52-76" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> Value<span class="op">*</span> build_while_stmt<span class="op">(</span>CFGBuilder <span class="op">*</span>builder<span class="op">,</span> ASTNode <span class="op">*</span>stmt<span class="op">)</span> <span class="op">{</span></span>
<span id="cb52-77"><a href="#cb52-77" aria-hidden="true" tabindex="-1"></a>    WhileStmt <span class="op">*</span>while_stmt <span class="op">=</span> <span class="op">&amp;</span>stmt<span class="op">-&gt;</span>data<span class="op">.</span>while_stmt<span class="op">;</span></span>
<span id="cb52-78"><a href="#cb52-78" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb52-79"><a href="#cb52-79" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Create blocks</span></span>
<span id="cb52-80"><a href="#cb52-80" aria-hidden="true" tabindex="-1"></a>    BasicBlock <span class="op">*</span>header <span class="op">=</span> create_block<span class="op">(</span>builder<span class="op">,</span> <span class="st">&quot;while.header&quot;</span><span class="op">);</span></span>
<span id="cb52-81"><a href="#cb52-81" aria-hidden="true" tabindex="-1"></a>    BasicBlock <span class="op">*</span>body <span class="op">=</span> create_block<span class="op">(</span>builder<span class="op">,</span> <span class="st">&quot;while.body&quot;</span><span class="op">);</span></span>
<span id="cb52-82"><a href="#cb52-82" aria-hidden="true" tabindex="-1"></a>    BasicBlock <span class="op">*</span>exit <span class="op">=</span> create_block<span class="op">(</span>builder<span class="op">,</span> <span class="st">&quot;while.exit&quot;</span><span class="op">);</span></span>
<span id="cb52-83"><a href="#cb52-83" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb52-84"><a href="#cb52-84" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Jump to header</span></span>
<span id="cb52-85"><a href="#cb52-85" aria-hidden="true" tabindex="-1"></a>    emit_jump<span class="op">(</span>builder<span class="op">,</span> header<span class="op">);</span></span>
<span id="cb52-86"><a href="#cb52-86" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb52-87"><a href="#cb52-87" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Build header (condition check)</span></span>
<span id="cb52-88"><a href="#cb52-88" aria-hidden="true" tabindex="-1"></a>    builder<span class="op">-&gt;</span>current_block <span class="op">=</span> header<span class="op">;</span></span>
<span id="cb52-89"><a href="#cb52-89" aria-hidden="true" tabindex="-1"></a>    Value <span class="op">*</span>cond <span class="op">=</span> build_expr<span class="op">(</span>builder<span class="op">,</span> while_stmt<span class="op">-&gt;</span>condition<span class="op">);</span></span>
<span id="cb52-90"><a href="#cb52-90" aria-hidden="true" tabindex="-1"></a>    emit_branch<span class="op">(</span>builder<span class="op">,</span> cond<span class="op">,</span> body<span class="op">,</span> exit<span class="op">);</span></span>
<span id="cb52-91"><a href="#cb52-91" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb52-92"><a href="#cb52-92" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Push loop context</span></span>
<span id="cb52-93"><a href="#cb52-93" aria-hidden="true" tabindex="-1"></a>    push_loop_context<span class="op">(</span>builder<span class="op">,</span> header<span class="op">,</span> exit<span class="op">);</span></span>
<span id="cb52-94"><a href="#cb52-94" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb52-95"><a href="#cb52-95" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Build body</span></span>
<span id="cb52-96"><a href="#cb52-96" aria-hidden="true" tabindex="-1"></a>    builder<span class="op">-&gt;</span>current_block <span class="op">=</span> body<span class="op">;</span></span>
<span id="cb52-97"><a href="#cb52-97" aria-hidden="true" tabindex="-1"></a>    build_stmt<span class="op">(</span>builder<span class="op">,</span> while_stmt<span class="op">-&gt;</span>body<span class="op">);</span></span>
<span id="cb52-98"><a href="#cb52-98" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>block_has_terminator<span class="op">(</span>builder<span class="op">-&gt;</span>current_block<span class="op">))</span> <span class="op">{</span></span>
<span id="cb52-99"><a href="#cb52-99" aria-hidden="true" tabindex="-1"></a>        emit_jump<span class="op">(</span>builder<span class="op">,</span> header<span class="op">);</span></span>
<span id="cb52-100"><a href="#cb52-100" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb52-101"><a href="#cb52-101" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb52-102"><a href="#cb52-102" aria-hidden="true" tabindex="-1"></a>    pop_loop_context<span class="op">(</span>builder<span class="op">);</span></span>
<span id="cb52-103"><a href="#cb52-103" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb52-104"><a href="#cb52-104" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Continue with exit block</span></span>
<span id="cb52-105"><a href="#cb52-105" aria-hidden="true" tabindex="-1"></a>    builder<span class="op">-&gt;</span>current_block <span class="op">=</span> exit<span class="op">;</span></span>
<span id="cb52-106"><a href="#cb52-106" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> NULL<span class="op">;</span></span>
<span id="cb52-107"><a href="#cb52-107" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>4.6 Expression Translation</h2>
<p>Expressions are translated into SSA-style instructions:</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> Value<span class="op">*</span> build_expr<span class="op">(</span>CFGBuilder <span class="op">*</span>builder<span class="op">,</span> ASTNode <span class="op">*</span>expr<span class="op">)</span> <span class="op">{</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> <span class="op">(</span>expr<span class="op">-&gt;</span>type<span class="op">)</span> <span class="op">{</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> AST_INT_LITERAL<span class="op">:</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> emit_const_int<span class="op">(</span>builder<span class="op">,</span> expr<span class="op">-&gt;</span>data<span class="op">.</span>int_literal<span class="op">.</span>value<span class="op">);</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> AST_FLOAT_LITERAL<span class="op">:</span></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> emit_const_float<span class="op">(</span>builder<span class="op">,</span> expr<span class="op">-&gt;</span>data<span class="op">.</span>float_literal<span class="op">.</span>value<span class="op">);</span></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> AST_STRING_LITERAL<span class="op">:</span></span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> emit_const_string<span class="op">(</span>builder<span class="op">,</span> expr<span class="op">-&gt;</span>data<span class="op">.</span>string_literal<span class="op">.</span>value<span class="op">);</span></span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> AST_BOOL_LITERAL<span class="op">:</span></span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> emit_const_bool<span class="op">(</span>builder<span class="op">,</span> expr<span class="op">-&gt;</span>data<span class="op">.</span>bool_literal<span class="op">.</span>value<span class="op">);</span></span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> AST_NULL_LITERAL<span class="op">:</span></span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> emit_const_null<span class="op">(</span>builder<span class="op">);</span></span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> AST_IDENTIFIER<span class="op">:</span></span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> build_identifier<span class="op">(</span>builder<span class="op">,</span> expr<span class="op">);</span></span>
<span id="cb53-20"><a href="#cb53-20" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb53-21"><a href="#cb53-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> AST_BINARY_OP<span class="op">:</span></span>
<span id="cb53-22"><a href="#cb53-22" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> build_binary_op<span class="op">(</span>builder<span class="op">,</span> expr<span class="op">);</span></span>
<span id="cb53-23"><a href="#cb53-23" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb53-24"><a href="#cb53-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> AST_UNARY_OP<span class="op">:</span></span>
<span id="cb53-25"><a href="#cb53-25" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> build_unary_op<span class="op">(</span>builder<span class="op">,</span> expr<span class="op">);</span></span>
<span id="cb53-26"><a href="#cb53-26" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb53-27"><a href="#cb53-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> AST_CALL<span class="op">:</span></span>
<span id="cb53-28"><a href="#cb53-28" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> build_call<span class="op">(</span>builder<span class="op">,</span> expr<span class="op">);</span></span>
<span id="cb53-29"><a href="#cb53-29" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb53-30"><a href="#cb53-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> AST_INDEX<span class="op">:</span></span>
<span id="cb53-31"><a href="#cb53-31" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> build_index<span class="op">(</span>builder<span class="op">,</span> expr<span class="op">);</span></span>
<span id="cb53-32"><a href="#cb53-32" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb53-33"><a href="#cb53-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> AST_MEMBER<span class="op">:</span></span>
<span id="cb53-34"><a href="#cb53-34" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> build_member_access<span class="op">(</span>builder<span class="op">,</span> expr<span class="op">);</span></span>
<span id="cb53-35"><a href="#cb53-35" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb53-36"><a href="#cb53-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">default</span><span class="op">:</span></span>
<span id="cb53-37"><a href="#cb53-37" aria-hidden="true" tabindex="-1"></a>            error<span class="op">(</span>builder<span class="op">,</span> expr<span class="op">-&gt;</span>location<span class="op">,</span> <span class="st">&quot;Unknown expression type&quot;</span><span class="op">);</span></span>
<span id="cb53-38"><a href="#cb53-38" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> NULL<span class="op">;</span></span>
<span id="cb53-39"><a href="#cb53-39" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb53-40"><a href="#cb53-40" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb53-41"><a href="#cb53-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-42"><a href="#cb53-42" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> Value<span class="op">*</span> build_binary_op<span class="op">(</span>CFGBuilder <span class="op">*</span>builder<span class="op">,</span> ASTNode <span class="op">*</span>expr<span class="op">)</span> <span class="op">{</span></span>
<span id="cb53-43"><a href="#cb53-43" aria-hidden="true" tabindex="-1"></a>    BinaryOp <span class="op">*</span>op <span class="op">=</span> <span class="op">&amp;</span>expr<span class="op">-&gt;</span>data<span class="op">.</span>binary_op<span class="op">;</span></span>
<span id="cb53-44"><a href="#cb53-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-45"><a href="#cb53-45" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Short-circuit evaluation for logical operators</span></span>
<span id="cb53-46"><a href="#cb53-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>op<span class="op">-&gt;</span>op <span class="op">==</span> TOK_AND <span class="op">||</span> op<span class="op">-&gt;</span>op <span class="op">==</span> TOK_OR<span class="op">)</span> <span class="op">{</span></span>
<span id="cb53-47"><a href="#cb53-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> build_short_circuit<span class="op">(</span>builder<span class="op">,</span> expr<span class="op">);</span></span>
<span id="cb53-48"><a href="#cb53-48" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb53-49"><a href="#cb53-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-50"><a href="#cb53-50" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Evaluate operands</span></span>
<span id="cb53-51"><a href="#cb53-51" aria-hidden="true" tabindex="-1"></a>    Value <span class="op">*</span>left <span class="op">=</span> build_expr<span class="op">(</span>builder<span class="op">,</span> op<span class="op">-&gt;</span>left<span class="op">);</span></span>
<span id="cb53-52"><a href="#cb53-52" aria-hidden="true" tabindex="-1"></a>    Value <span class="op">*</span>right <span class="op">=</span> build_expr<span class="op">(</span>builder<span class="op">,</span> op<span class="op">-&gt;</span>right<span class="op">);</span></span>
<span id="cb53-53"><a href="#cb53-53" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-54"><a href="#cb53-54" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Emit instruction</span></span>
<span id="cb53-55"><a href="#cb53-55" aria-hidden="true" tabindex="-1"></a>    InstructionKind inst_kind<span class="op">;</span></span>
<span id="cb53-56"><a href="#cb53-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> <span class="op">(</span>op<span class="op">-&gt;</span>op<span class="op">)</span> <span class="op">{</span></span>
<span id="cb53-57"><a href="#cb53-57" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> TOK_PLUS<span class="op">:</span>    inst_kind <span class="op">=</span> INST_ADD<span class="op">;</span> <span class="cf">break</span><span class="op">;</span></span>
<span id="cb53-58"><a href="#cb53-58" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> TOK_MINUS<span class="op">:</span>   inst_kind <span class="op">=</span> INST_SUB<span class="op">;</span> <span class="cf">break</span><span class="op">;</span></span>
<span id="cb53-59"><a href="#cb53-59" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> TOK_STAR<span class="op">:</span>    inst_kind <span class="op">=</span> INST_MUL<span class="op">;</span> <span class="cf">break</span><span class="op">;</span></span>
<span id="cb53-60"><a href="#cb53-60" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> TOK_SLASH<span class="op">:</span>   inst_kind <span class="op">=</span> INST_DIV<span class="op">;</span> <span class="cf">break</span><span class="op">;</span></span>
<span id="cb53-61"><a href="#cb53-61" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> TOK_PERCENT<span class="op">:</span> inst_kind <span class="op">=</span> INST_MOD<span class="op">;</span> <span class="cf">break</span><span class="op">;</span></span>
<span id="cb53-62"><a href="#cb53-62" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> TOK_EQ<span class="op">:</span>      inst_kind <span class="op">=</span> INST_EQ<span class="op">;</span> <span class="cf">break</span><span class="op">;</span></span>
<span id="cb53-63"><a href="#cb53-63" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> TOK_NE<span class="op">:</span>      inst_kind <span class="op">=</span> INST_NE<span class="op">;</span> <span class="cf">break</span><span class="op">;</span></span>
<span id="cb53-64"><a href="#cb53-64" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> TOK_LT<span class="op">:</span>      inst_kind <span class="op">=</span> INST_LT<span class="op">;</span> <span class="cf">break</span><span class="op">;</span></span>
<span id="cb53-65"><a href="#cb53-65" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> TOK_LE<span class="op">:</span>      inst_kind <span class="op">=</span> INST_LE<span class="op">;</span> <span class="cf">break</span><span class="op">;</span></span>
<span id="cb53-66"><a href="#cb53-66" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> TOK_GT<span class="op">:</span>      inst_kind <span class="op">=</span> INST_GT<span class="op">;</span> <span class="cf">break</span><span class="op">;</span></span>
<span id="cb53-67"><a href="#cb53-67" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> TOK_GE<span class="op">:</span>      inst_kind <span class="op">=</span> INST_GE<span class="op">;</span> <span class="cf">break</span><span class="op">;</span></span>
<span id="cb53-68"><a href="#cb53-68" aria-hidden="true" tabindex="-1"></a>        <span class="cf">default</span><span class="op">:</span></span>
<span id="cb53-69"><a href="#cb53-69" aria-hidden="true" tabindex="-1"></a>            error<span class="op">(</span>builder<span class="op">,</span> expr<span class="op">-&gt;</span>location<span class="op">,</span> <span class="st">&quot;Unknown binary operator&quot;</span><span class="op">);</span></span>
<span id="cb53-70"><a href="#cb53-70" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> NULL<span class="op">;</span></span>
<span id="cb53-71"><a href="#cb53-71" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb53-72"><a href="#cb53-72" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-73"><a href="#cb53-73" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> emit_binary<span class="op">(</span>builder<span class="op">,</span> inst_kind<span class="op">,</span> left<span class="op">,</span> right<span class="op">,</span> expr<span class="op">-&gt;</span>expr_type<span class="op">);</span></span>
<span id="cb53-74"><a href="#cb53-74" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb53-75"><a href="#cb53-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-76"><a href="#cb53-76" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> Value<span class="op">*</span> build_short_circuit<span class="op">(</span>CFGBuilder <span class="op">*</span>builder<span class="op">,</span> ASTNode <span class="op">*</span>expr<span class="op">)</span> <span class="op">{</span></span>
<span id="cb53-77"><a href="#cb53-77" aria-hidden="true" tabindex="-1"></a>    BinaryOp <span class="op">*</span>op <span class="op">=</span> <span class="op">&amp;</span>expr<span class="op">-&gt;</span>data<span class="op">.</span>binary_op<span class="op">;</span></span>
<span id="cb53-78"><a href="#cb53-78" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> is_and <span class="op">=</span> <span class="op">(</span>op<span class="op">-&gt;</span>op <span class="op">==</span> TOK_AND<span class="op">);</span></span>
<span id="cb53-79"><a href="#cb53-79" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-80"><a href="#cb53-80" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Evaluate left operand</span></span>
<span id="cb53-81"><a href="#cb53-81" aria-hidden="true" tabindex="-1"></a>    Value <span class="op">*</span>left <span class="op">=</span> build_expr<span class="op">(</span>builder<span class="op">,</span> op<span class="op">-&gt;</span>left<span class="op">);</span></span>
<span id="cb53-82"><a href="#cb53-82" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-83"><a href="#cb53-83" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Create blocks</span></span>
<span id="cb53-84"><a href="#cb53-84" aria-hidden="true" tabindex="-1"></a>    BasicBlock <span class="op">*</span>right_block <span class="op">=</span> create_block<span class="op">(</span>builder<span class="op">,</span> is_and <span class="op">?</span> <span class="st">&quot;and.rhs&quot;</span> <span class="op">:</span> <span class="st">&quot;or.rhs&quot;</span><span class="op">);</span></span>
<span id="cb53-85"><a href="#cb53-85" aria-hidden="true" tabindex="-1"></a>    BasicBlock <span class="op">*</span>merge_block <span class="op">=</span> create_block<span class="op">(</span>builder<span class="op">,</span> is_and <span class="op">?</span> <span class="st">&quot;and.merge&quot;</span> <span class="op">:</span> <span class="st">&quot;or.merge&quot;</span><span class="op">);</span></span>
<span id="cb53-86"><a href="#cb53-86" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-87"><a href="#cb53-87" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Branch based on left value</span></span>
<span id="cb53-88"><a href="#cb53-88" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>is_and<span class="op">)</span> <span class="op">{</span></span>
<span id="cb53-89"><a href="#cb53-89" aria-hidden="true" tabindex="-1"></a>        <span class="co">// For AND: if left is false, skip right</span></span>
<span id="cb53-90"><a href="#cb53-90" aria-hidden="true" tabindex="-1"></a>        emit_branch<span class="op">(</span>builder<span class="op">,</span> left<span class="op">,</span> right_block<span class="op">,</span> merge_block<span class="op">);</span></span>
<span id="cb53-91"><a href="#cb53-91" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb53-92"><a href="#cb53-92" aria-hidden="true" tabindex="-1"></a>        <span class="co">// For OR: if left is true, skip right  </span></span>
<span id="cb53-93"><a href="#cb53-93" aria-hidden="true" tabindex="-1"></a>        emit_branch<span class="op">(</span>builder<span class="op">,</span> left<span class="op">,</span> merge_block<span class="op">,</span> right_block<span class="op">);</span></span>
<span id="cb53-94"><a href="#cb53-94" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb53-95"><a href="#cb53-95" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-96"><a href="#cb53-96" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Remember incoming value from left block</span></span>
<span id="cb53-97"><a href="#cb53-97" aria-hidden="true" tabindex="-1"></a>    BasicBlock <span class="op">*</span>left_block <span class="op">=</span> builder<span class="op">-&gt;</span>current_block<span class="op">;</span></span>
<span id="cb53-98"><a href="#cb53-98" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-99"><a href="#cb53-99" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Evaluate right operand</span></span>
<span id="cb53-100"><a href="#cb53-100" aria-hidden="true" tabindex="-1"></a>    builder<span class="op">-&gt;</span>current_block <span class="op">=</span> right_block<span class="op">;</span></span>
<span id="cb53-101"><a href="#cb53-101" aria-hidden="true" tabindex="-1"></a>    Value <span class="op">*</span>right <span class="op">=</span> build_expr<span class="op">(</span>builder<span class="op">,</span> op<span class="op">-&gt;</span>right<span class="op">);</span></span>
<span id="cb53-102"><a href="#cb53-102" aria-hidden="true" tabindex="-1"></a>    BasicBlock <span class="op">*</span>right_end_block <span class="op">=</span> builder<span class="op">-&gt;</span>current_block<span class="op">;</span></span>
<span id="cb53-103"><a href="#cb53-103" aria-hidden="true" tabindex="-1"></a>    emit_jump<span class="op">(</span>builder<span class="op">,</span> merge_block<span class="op">);</span></span>
<span id="cb53-104"><a href="#cb53-104" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-105"><a href="#cb53-105" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Create phi node in merge block</span></span>
<span id="cb53-106"><a href="#cb53-106" aria-hidden="true" tabindex="-1"></a>    builder<span class="op">-&gt;</span>current_block <span class="op">=</span> merge_block<span class="op">;</span></span>
<span id="cb53-107"><a href="#cb53-107" aria-hidden="true" tabindex="-1"></a>    Value <span class="op">*</span>result <span class="op">=</span> emit_phi<span class="op">(</span>builder<span class="op">,</span> expr<span class="op">-&gt;</span>expr_type<span class="op">);</span></span>
<span id="cb53-108"><a href="#cb53-108" aria-hidden="true" tabindex="-1"></a>    add_phi_incoming<span class="op">(</span>result<span class="op">,</span> left<span class="op">,</span> left_block<span class="op">);</span></span>
<span id="cb53-109"><a href="#cb53-109" aria-hidden="true" tabindex="-1"></a>    add_phi_incoming<span class="op">(</span>result<span class="op">,</span> right<span class="op">,</span> right_end_block<span class="op">);</span></span>
<span id="cb53-110"><a href="#cb53-110" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-111"><a href="#cb53-111" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result<span class="op">;</span></span>
<span id="cb53-112"><a href="#cb53-112" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>4.7 Instruction Emission</h2>
<p>Helper functions for emitting instructions:</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> Value<span class="op">*</span> new_temp<span class="op">(</span>CFGBuilder <span class="op">*</span>builder<span class="op">,</span> Type <span class="op">*</span>type<span class="op">)</span> <span class="op">{</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>    Value <span class="op">*</span>temp <span class="op">=</span> calloc<span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>Value<span class="op">));</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>    temp<span class="op">-&gt;</span>kind <span class="op">=</span> VALUE_TEMP<span class="op">;</span></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>    temp<span class="op">-&gt;</span>type <span class="op">=</span> type<span class="op">;</span></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>    temp<span class="op">-&gt;</span>data<span class="op">.</span>temp<span class="op">.</span>id <span class="op">=</span> builder<span class="op">-&gt;</span>next_temp_id<span class="op">++;</span></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> temp<span class="op">;</span></span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> Instruction<span class="op">*</span> emit_instruction<span class="op">(</span>CFGBuilder <span class="op">*</span>builder<span class="op">,</span> InstructionKind kind<span class="op">,</span></span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>                                   Type <span class="op">*</span>result_type<span class="op">)</span> <span class="op">{</span></span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>    Instruction <span class="op">*</span>inst <span class="op">=</span> calloc<span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>Instruction<span class="op">));</span></span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>    inst<span class="op">-&gt;</span>kind <span class="op">=</span> kind<span class="op">;</span></span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>    inst<span class="op">-&gt;</span>block <span class="op">=</span> builder<span class="op">-&gt;</span>current_block<span class="op">;</span></span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>result_type <span class="op">&amp;&amp;</span> result_type<span class="op">-&gt;</span>kind <span class="op">!=</span> TYPE_VOID<span class="op">)</span> <span class="op">{</span></span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a>        inst<span class="op">-&gt;</span>result <span class="op">=</span> new_temp<span class="op">(</span>builder<span class="op">,</span> result_type<span class="op">);</span></span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a>        inst<span class="op">-&gt;</span>result<span class="op">-&gt;</span>def <span class="op">=</span> inst<span class="op">;</span></span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Add to block</span></span>
<span id="cb54-21"><a href="#cb54-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>builder<span class="op">-&gt;</span>current_block<span class="op">-&gt;</span>last<span class="op">)</span> <span class="op">{</span></span>
<span id="cb54-22"><a href="#cb54-22" aria-hidden="true" tabindex="-1"></a>        builder<span class="op">-&gt;</span>current_block<span class="op">-&gt;</span>last<span class="op">-&gt;</span>next <span class="op">=</span> inst<span class="op">;</span></span>
<span id="cb54-23"><a href="#cb54-23" aria-hidden="true" tabindex="-1"></a>        inst<span class="op">-&gt;</span>prev <span class="op">=</span> builder<span class="op">-&gt;</span>current_block<span class="op">-&gt;</span>last<span class="op">;</span></span>
<span id="cb54-24"><a href="#cb54-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb54-25"><a href="#cb54-25" aria-hidden="true" tabindex="-1"></a>        builder<span class="op">-&gt;</span>current_block<span class="op">-&gt;</span>first <span class="op">=</span> inst<span class="op">;</span></span>
<span id="cb54-26"><a href="#cb54-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb54-27"><a href="#cb54-27" aria-hidden="true" tabindex="-1"></a>    builder<span class="op">-&gt;</span>current_block<span class="op">-&gt;</span>last <span class="op">=</span> inst<span class="op">;</span></span>
<span id="cb54-28"><a href="#cb54-28" aria-hidden="true" tabindex="-1"></a>    builder<span class="op">-&gt;</span>current_block<span class="op">-&gt;</span>instruction_count<span class="op">++;</span></span>
<span id="cb54-29"><a href="#cb54-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-30"><a href="#cb54-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> inst<span class="op">;</span></span>
<span id="cb54-31"><a href="#cb54-31" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb54-32"><a href="#cb54-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-33"><a href="#cb54-33" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> Value<span class="op">*</span> emit_binary<span class="op">(</span>CFGBuilder <span class="op">*</span>builder<span class="op">,</span> InstructionKind kind<span class="op">,</span></span>
<span id="cb54-34"><a href="#cb54-34" aria-hidden="true" tabindex="-1"></a>                         Value <span class="op">*</span>left<span class="op">,</span> Value <span class="op">*</span>right<span class="op">,</span> Type <span class="op">*</span>result_type<span class="op">)</span> <span class="op">{</span></span>
<span id="cb54-35"><a href="#cb54-35" aria-hidden="true" tabindex="-1"></a>    Instruction <span class="op">*</span>inst <span class="op">=</span> emit_instruction<span class="op">(</span>builder<span class="op">,</span> kind<span class="op">,</span> result_type<span class="op">);</span></span>
<span id="cb54-36"><a href="#cb54-36" aria-hidden="true" tabindex="-1"></a>    inst<span class="op">-&gt;</span>operand_count <span class="op">=</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb54-37"><a href="#cb54-37" aria-hidden="true" tabindex="-1"></a>    inst<span class="op">-&gt;</span>operands <span class="op">=</span> calloc<span class="op">(</span><span class="dv">2</span><span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>Value<span class="op">*));</span></span>
<span id="cb54-38"><a href="#cb54-38" aria-hidden="true" tabindex="-1"></a>    inst<span class="op">-&gt;</span>operands<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> left<span class="op">;</span></span>
<span id="cb54-39"><a href="#cb54-39" aria-hidden="true" tabindex="-1"></a>    inst<span class="op">-&gt;</span>operands<span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="op">=</span> right<span class="op">;</span></span>
<span id="cb54-40"><a href="#cb54-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-41"><a href="#cb54-41" aria-hidden="true" tabindex="-1"></a>    add_use<span class="op">(</span>left<span class="op">,</span> inst<span class="op">);</span></span>
<span id="cb54-42"><a href="#cb54-42" aria-hidden="true" tabindex="-1"></a>    add_use<span class="op">(</span>right<span class="op">,</span> inst<span class="op">);</span></span>
<span id="cb54-43"><a href="#cb54-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-44"><a href="#cb54-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> inst<span class="op">-&gt;</span>result<span class="op">;</span></span>
<span id="cb54-45"><a href="#cb54-45" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb54-46"><a href="#cb54-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-47"><a href="#cb54-47" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> emit_jump<span class="op">(</span>CFGBuilder <span class="op">*</span>builder<span class="op">,</span> BasicBlock <span class="op">*</span>target<span class="op">)</span> <span class="op">{</span></span>
<span id="cb54-48"><a href="#cb54-48" aria-hidden="true" tabindex="-1"></a>    builder<span class="op">-&gt;</span>current_block<span class="op">-&gt;</span>terminator_type <span class="op">=</span> TERM_JUMP<span class="op">;</span></span>
<span id="cb54-49"><a href="#cb54-49" aria-hidden="true" tabindex="-1"></a>    builder<span class="op">-&gt;</span>current_block<span class="op">-&gt;</span>terminator<span class="op">.</span>jump<span class="op">.</span>target <span class="op">=</span> target<span class="op">;</span></span>
<span id="cb54-50"><a href="#cb54-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-51"><a href="#cb54-51" aria-hidden="true" tabindex="-1"></a>    add_edge<span class="op">(</span>builder<span class="op">-&gt;</span>current_block<span class="op">,</span> target<span class="op">);</span></span>
<span id="cb54-52"><a href="#cb54-52" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb54-53"><a href="#cb54-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-54"><a href="#cb54-54" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> emit_branch<span class="op">(</span>CFGBuilder <span class="op">*</span>builder<span class="op">,</span> Value <span class="op">*</span>condition<span class="op">,</span></span>
<span id="cb54-55"><a href="#cb54-55" aria-hidden="true" tabindex="-1"></a>                       BasicBlock <span class="op">*</span>true_target<span class="op">,</span> BasicBlock <span class="op">*</span>false_target<span class="op">)</span> <span class="op">{</span></span>
<span id="cb54-56"><a href="#cb54-56" aria-hidden="true" tabindex="-1"></a>    builder<span class="op">-&gt;</span>current_block<span class="op">-&gt;</span>terminator_type <span class="op">=</span> TERM_BRANCH<span class="op">;</span></span>
<span id="cb54-57"><a href="#cb54-57" aria-hidden="true" tabindex="-1"></a>    builder<span class="op">-&gt;</span>current_block<span class="op">-&gt;</span>terminator<span class="op">.</span>branch<span class="op">.</span>condition <span class="op">=</span> condition<span class="op">;</span></span>
<span id="cb54-58"><a href="#cb54-58" aria-hidden="true" tabindex="-1"></a>    builder<span class="op">-&gt;</span>current_block<span class="op">-&gt;</span>terminator<span class="op">.</span>branch<span class="op">.</span>true_target <span class="op">=</span> true_target<span class="op">;</span></span>
<span id="cb54-59"><a href="#cb54-59" aria-hidden="true" tabindex="-1"></a>    builder<span class="op">-&gt;</span>current_block<span class="op">-&gt;</span>terminator<span class="op">.</span>branch<span class="op">.</span>false_target <span class="op">=</span> false_target<span class="op">;</span></span>
<span id="cb54-60"><a href="#cb54-60" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-61"><a href="#cb54-61" aria-hidden="true" tabindex="-1"></a>    add_use<span class="op">(</span>condition<span class="op">,</span> NULL<span class="op">);</span>  <span class="co">// Terminator use</span></span>
<span id="cb54-62"><a href="#cb54-62" aria-hidden="true" tabindex="-1"></a>    add_edge<span class="op">(</span>builder<span class="op">-&gt;</span>current_block<span class="op">,</span> true_target<span class="op">);</span></span>
<span id="cb54-63"><a href="#cb54-63" aria-hidden="true" tabindex="-1"></a>    add_edge<span class="op">(</span>builder<span class="op">-&gt;</span>current_block<span class="op">,</span> false_target<span class="op">);</span></span>
<span id="cb54-64"><a href="#cb54-64" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb54-65"><a href="#cb54-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-66"><a href="#cb54-66" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> emit_return<span class="op">(</span>CFGBuilder <span class="op">*</span>builder<span class="op">,</span> Value <span class="op">*</span>value<span class="op">)</span> <span class="op">{</span></span>
<span id="cb54-67"><a href="#cb54-67" aria-hidden="true" tabindex="-1"></a>    builder<span class="op">-&gt;</span>current_block<span class="op">-&gt;</span>terminator_type <span class="op">=</span> TERM_RETURN<span class="op">;</span></span>
<span id="cb54-68"><a href="#cb54-68" aria-hidden="true" tabindex="-1"></a>    builder<span class="op">-&gt;</span>current_block<span class="op">-&gt;</span>terminator<span class="op">.</span>return_stmt<span class="op">.</span>value <span class="op">=</span> value<span class="op">;</span></span>
<span id="cb54-69"><a href="#cb54-69" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-70"><a href="#cb54-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>value<span class="op">)</span> <span class="op">{</span></span>
<span id="cb54-71"><a href="#cb54-71" aria-hidden="true" tabindex="-1"></a>        add_use<span class="op">(</span>value<span class="op">,</span> NULL<span class="op">);</span>  <span class="co">// Terminator use</span></span>
<span id="cb54-72"><a href="#cb54-72" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb54-73"><a href="#cb54-73" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb54-74"><a href="#cb54-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-75"><a href="#cb54-75" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> Value<span class="op">*</span> emit_phi<span class="op">(</span>CFGBuilder <span class="op">*</span>builder<span class="op">,</span> Type <span class="op">*</span>type<span class="op">)</span> <span class="op">{</span></span>
<span id="cb54-76"><a href="#cb54-76" aria-hidden="true" tabindex="-1"></a>    Instruction <span class="op">*</span>inst <span class="op">=</span> emit_instruction<span class="op">(</span>builder<span class="op">,</span> INST_PHI<span class="op">,</span> type<span class="op">);</span></span>
<span id="cb54-77"><a href="#cb54-77" aria-hidden="true" tabindex="-1"></a>    inst<span class="op">-&gt;</span>data<span class="op">.</span>phi<span class="op">.</span>incoming_count <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb54-78"><a href="#cb54-78" aria-hidden="true" tabindex="-1"></a>    inst<span class="op">-&gt;</span>data<span class="op">.</span>phi<span class="op">.</span>incoming_values <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb54-79"><a href="#cb54-79" aria-hidden="true" tabindex="-1"></a>    inst<span class="op">-&gt;</span>data<span class="op">.</span>phi<span class="op">.</span>incoming_blocks <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb54-80"><a href="#cb54-80" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> inst<span class="op">-&gt;</span>result<span class="op">;</span></span>
<span id="cb54-81"><a href="#cb54-81" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb54-82"><a href="#cb54-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-83"><a href="#cb54-83" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> add_phi_incoming<span class="op">(</span>Value <span class="op">*</span>phi_result<span class="op">,</span> Value <span class="op">*</span>value<span class="op">,</span> BasicBlock <span class="op">*</span>block<span class="op">)</span> <span class="op">{</span></span>
<span id="cb54-84"><a href="#cb54-84" aria-hidden="true" tabindex="-1"></a>    Instruction <span class="op">*</span>phi <span class="op">=</span> phi_result<span class="op">-&gt;</span>def<span class="op">;</span></span>
<span id="cb54-85"><a href="#cb54-85" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span>phi<span class="op">-&gt;</span>kind <span class="op">==</span> INST_PHI<span class="op">);</span></span>
<span id="cb54-86"><a href="#cb54-86" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-87"><a href="#cb54-87" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> n <span class="op">=</span> phi<span class="op">-&gt;</span>data<span class="op">.</span>phi<span class="op">.</span>incoming_count<span class="op">++;</span></span>
<span id="cb54-88"><a href="#cb54-88" aria-hidden="true" tabindex="-1"></a>    phi<span class="op">-&gt;</span>data<span class="op">.</span>phi<span class="op">.</span>incoming_values <span class="op">=</span> realloc<span class="op">(</span>phi<span class="op">-&gt;</span>data<span class="op">.</span>phi<span class="op">.</span>incoming_values<span class="op">,</span></span>
<span id="cb54-89"><a href="#cb54-89" aria-hidden="true" tabindex="-1"></a>        phi<span class="op">-&gt;</span>data<span class="op">.</span>phi<span class="op">.</span>incoming_count <span class="op">*</span> <span class="kw">sizeof</span><span class="op">(</span>Value<span class="op">*));</span></span>
<span id="cb54-90"><a href="#cb54-90" aria-hidden="true" tabindex="-1"></a>    phi<span class="op">-&gt;</span>data<span class="op">.</span>phi<span class="op">.</span>incoming_blocks <span class="op">=</span> realloc<span class="op">(</span>phi<span class="op">-&gt;</span>data<span class="op">.</span>phi<span class="op">.</span>incoming_blocks<span class="op">,</span></span>
<span id="cb54-91"><a href="#cb54-91" aria-hidden="true" tabindex="-1"></a>        phi<span class="op">-&gt;</span>data<span class="op">.</span>phi<span class="op">.</span>incoming_count <span class="op">*</span> <span class="kw">sizeof</span><span class="op">(</span>BasicBlock<span class="op">*));</span></span>
<span id="cb54-92"><a href="#cb54-92" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-93"><a href="#cb54-93" aria-hidden="true" tabindex="-1"></a>    phi<span class="op">-&gt;</span>data<span class="op">.</span>phi<span class="op">.</span>incoming_values<span class="op">[</span>n<span class="op">]</span> <span class="op">=</span> value<span class="op">;</span></span>
<span id="cb54-94"><a href="#cb54-94" aria-hidden="true" tabindex="-1"></a>    phi<span class="op">-&gt;</span>data<span class="op">.</span>phi<span class="op">.</span>incoming_blocks<span class="op">[</span>n<span class="op">]</span> <span class="op">=</span> block<span class="op">;</span></span>
<span id="cb54-95"><a href="#cb54-95" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-96"><a href="#cb54-96" aria-hidden="true" tabindex="-1"></a>    add_use<span class="op">(</span>value<span class="op">,</span> phi<span class="op">);</span></span>
<span id="cb54-97"><a href="#cb54-97" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>4.8 Control Flow Edge Management</h2>
<p>Managing predecessor/successor relationships:</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> add_edge<span class="op">(</span>BasicBlock <span class="op">*</span>from<span class="op">,</span> BasicBlock <span class="op">*</span>to<span class="op">)</span> <span class="op">{</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Add to successors</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>from<span class="op">-&gt;</span>successor_count <span class="op">&gt;=</span> from<span class="op">-&gt;</span>successor_capacity<span class="op">)</span> <span class="op">{</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>        from<span class="op">-&gt;</span>successor_capacity <span class="op">=</span> from<span class="op">-&gt;</span>successor_capacity <span class="op">*</span> <span class="dv">2</span> <span class="op">+</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>        from<span class="op">-&gt;</span>successors <span class="op">=</span> realloc<span class="op">(</span>from<span class="op">-&gt;</span>successors<span class="op">,</span></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>            from<span class="op">-&gt;</span>successor_capacity <span class="op">*</span> <span class="kw">sizeof</span><span class="op">(</span>BasicBlock<span class="op">*));</span></span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>    from<span class="op">-&gt;</span>successors<span class="op">[</span>from<span class="op">-&gt;</span>successor_count<span class="op">++]</span> <span class="op">=</span> to<span class="op">;</span></span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Add to predecessors</span></span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>to<span class="op">-&gt;</span>predecessor_count <span class="op">&gt;=</span> to<span class="op">-&gt;</span>predecessor_capacity<span class="op">)</span> <span class="op">{</span></span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a>        to<span class="op">-&gt;</span>predecessor_capacity <span class="op">=</span> to<span class="op">-&gt;</span>predecessor_capacity <span class="op">*</span> <span class="dv">2</span> <span class="op">+</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a>        to<span class="op">-&gt;</span>predecessors <span class="op">=</span> realloc<span class="op">(</span>to<span class="op">-&gt;</span>predecessors<span class="op">,</span></span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a>            to<span class="op">-&gt;</span>predecessor_capacity <span class="op">*</span> <span class="kw">sizeof</span><span class="op">(</span>BasicBlock<span class="op">*));</span></span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true" tabindex="-1"></a>    to<span class="op">-&gt;</span>predecessors<span class="op">[</span>to<span class="op">-&gt;</span>predecessor_count<span class="op">++]</span> <span class="op">=</span> from<span class="op">;</span></span>
<span id="cb55-17"><a href="#cb55-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb55-18"><a href="#cb55-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-19"><a href="#cb55-19" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> remove_edge<span class="op">(</span>BasicBlock <span class="op">*</span>from<span class="op">,</span> BasicBlock <span class="op">*</span>to<span class="op">)</span> <span class="op">{</span></span>
<span id="cb55-20"><a href="#cb55-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Remove from successors</span></span>
<span id="cb55-21"><a href="#cb55-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> from<span class="op">-&gt;</span>successor_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb55-22"><a href="#cb55-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>from<span class="op">-&gt;</span>successors<span class="op">[</span>i<span class="op">]</span> <span class="op">==</span> to<span class="op">)</span> <span class="op">{</span></span>
<span id="cb55-23"><a href="#cb55-23" aria-hidden="true" tabindex="-1"></a>            memmove<span class="op">(&amp;</span>from<span class="op">-&gt;</span>successors<span class="op">[</span>i<span class="op">],</span> <span class="op">&amp;</span>from<span class="op">-&gt;</span>successors<span class="op">[</span>i <span class="op">+</span> <span class="dv">1</span><span class="op">],</span></span>
<span id="cb55-24"><a href="#cb55-24" aria-hidden="true" tabindex="-1"></a>                <span class="op">(</span>from<span class="op">-&gt;</span>successor_count <span class="op">-</span> i <span class="op">-</span> <span class="dv">1</span><span class="op">)</span> <span class="op">*</span> <span class="kw">sizeof</span><span class="op">(</span>BasicBlock<span class="op">*));</span></span>
<span id="cb55-25"><a href="#cb55-25" aria-hidden="true" tabindex="-1"></a>            from<span class="op">-&gt;</span>successor_count<span class="op">--;</span></span>
<span id="cb55-26"><a href="#cb55-26" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span><span class="op">;</span></span>
<span id="cb55-27"><a href="#cb55-27" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb55-28"><a href="#cb55-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb55-29"><a href="#cb55-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb55-30"><a href="#cb55-30" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Remove from predecessors</span></span>
<span id="cb55-31"><a href="#cb55-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> to<span class="op">-&gt;</span>predecessor_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb55-32"><a href="#cb55-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>to<span class="op">-&gt;</span>predecessors<span class="op">[</span>i<span class="op">]</span> <span class="op">==</span> from<span class="op">)</span> <span class="op">{</span></span>
<span id="cb55-33"><a href="#cb55-33" aria-hidden="true" tabindex="-1"></a>            memmove<span class="op">(&amp;</span>to<span class="op">-&gt;</span>predecessors<span class="op">[</span>i<span class="op">],</span> <span class="op">&amp;</span>to<span class="op">-&gt;</span>predecessors<span class="op">[</span>i <span class="op">+</span> <span class="dv">1</span><span class="op">],</span></span>
<span id="cb55-34"><a href="#cb55-34" aria-hidden="true" tabindex="-1"></a>                <span class="op">(</span>to<span class="op">-&gt;</span>predecessor_count <span class="op">-</span> i <span class="op">-</span> <span class="dv">1</span><span class="op">)</span> <span class="op">*</span> <span class="kw">sizeof</span><span class="op">(</span>BasicBlock<span class="op">*));</span></span>
<span id="cb55-35"><a href="#cb55-35" aria-hidden="true" tabindex="-1"></a>            to<span class="op">-&gt;</span>predecessor_count<span class="op">--;</span></span>
<span id="cb55-36"><a href="#cb55-36" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span><span class="op">;</span></span>
<span id="cb55-37"><a href="#cb55-37" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb55-38"><a href="#cb55-38" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb55-39"><a href="#cb55-39" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb55-40"><a href="#cb55-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-41"><a href="#cb55-41" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">bool</span> block_has_terminator<span class="op">(</span>BasicBlock <span class="op">*</span>block<span class="op">)</span> <span class="op">{</span></span>
<span id="cb55-42"><a href="#cb55-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> block<span class="op">-&gt;</span>terminator_type <span class="op">!=</span> TERM_NONE<span class="op">;</span></span>
<span id="cb55-43"><a href="#cb55-43" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>4.9 CFG Cleanup</h2>
<p>After initial construction, the CFG needs cleanup:</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> remove_unreachable_blocks<span class="op">(</span>CFG <span class="op">*</span>cfg<span class="op">)</span> <span class="op">{</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Mark reachable blocks</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>    mark_reachable_blocks<span class="op">(</span>cfg<span class="op">-&gt;</span>entry<span class="op">);</span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Remove unreachable blocks</span></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> write_idx <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> cfg<span class="op">-&gt;</span>block_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>        BasicBlock <span class="op">*</span>block <span class="op">=</span> cfg<span class="op">-&gt;</span>blocks<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>block<span class="op">-&gt;</span>is_reachable<span class="op">)</span> <span class="op">{</span></span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>            cfg<span class="op">-&gt;</span>blocks<span class="op">[</span>write_idx<span class="op">++]</span> <span class="op">=</span> block<span class="op">;</span></span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>            free_block<span class="op">(</span>block<span class="op">);</span></span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a>    cfg<span class="op">-&gt;</span>block_count <span class="op">=</span> write_idx<span class="op">;</span></span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> mark_reachable_blocks<span class="op">(</span>BasicBlock <span class="op">*</span>block<span class="op">)</span> <span class="op">{</span></span>
<span id="cb56-19"><a href="#cb56-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>block<span class="op">-&gt;</span>is_reachable<span class="op">)</span> <span class="cf">return</span><span class="op">;</span></span>
<span id="cb56-20"><a href="#cb56-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb56-21"><a href="#cb56-21" aria-hidden="true" tabindex="-1"></a>    block<span class="op">-&gt;</span>is_reachable <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb56-22"><a href="#cb56-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb56-23"><a href="#cb56-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Mark successors</span></span>
<span id="cb56-24"><a href="#cb56-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> block<span class="op">-&gt;</span>successor_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb56-25"><a href="#cb56-25" aria-hidden="true" tabindex="-1"></a>        mark_reachable_blocks<span class="op">(</span>block<span class="op">-&gt;</span>successors<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb56-26"><a href="#cb56-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb56-27"><a href="#cb56-27" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb56-28"><a href="#cb56-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-29"><a href="#cb56-29" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> merge_blocks<span class="op">(</span>BasicBlock <span class="op">*</span>pred<span class="op">,</span> BasicBlock <span class="op">*</span>succ<span class="op">)</span> <span class="op">{</span></span>
<span id="cb56-30"><a href="#cb56-30" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span>pred<span class="op">-&gt;</span>successor_count <span class="op">==</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb56-31"><a href="#cb56-31" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span>succ<span class="op">-&gt;</span>predecessor_count <span class="op">==</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb56-32"><a href="#cb56-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb56-33"><a href="#cb56-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Remove jump terminator</span></span>
<span id="cb56-34"><a href="#cb56-34" aria-hidden="true" tabindex="-1"></a>    pred<span class="op">-&gt;</span>terminator_type <span class="op">=</span> TERM_NONE<span class="op">;</span></span>
<span id="cb56-35"><a href="#cb56-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb56-36"><a href="#cb56-36" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Move instructions</span></span>
<span id="cb56-37"><a href="#cb56-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>pred<span class="op">-&gt;</span>last<span class="op">)</span> <span class="op">{</span></span>
<span id="cb56-38"><a href="#cb56-38" aria-hidden="true" tabindex="-1"></a>        pred<span class="op">-&gt;</span>last<span class="op">-&gt;</span>next <span class="op">=</span> succ<span class="op">-&gt;</span>first<span class="op">;</span></span>
<span id="cb56-39"><a href="#cb56-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>succ<span class="op">-&gt;</span>first<span class="op">)</span> <span class="op">{</span></span>
<span id="cb56-40"><a href="#cb56-40" aria-hidden="true" tabindex="-1"></a>            succ<span class="op">-&gt;</span>first<span class="op">-&gt;</span>prev <span class="op">=</span> pred<span class="op">-&gt;</span>last<span class="op">;</span></span>
<span id="cb56-41"><a href="#cb56-41" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb56-42"><a href="#cb56-42" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb56-43"><a href="#cb56-43" aria-hidden="true" tabindex="-1"></a>        pred<span class="op">-&gt;</span>first <span class="op">=</span> succ<span class="op">-&gt;</span>first<span class="op">;</span></span>
<span id="cb56-44"><a href="#cb56-44" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb56-45"><a href="#cb56-45" aria-hidden="true" tabindex="-1"></a>    pred<span class="op">-&gt;</span>last <span class="op">=</span> succ<span class="op">-&gt;</span>last<span class="op">;</span></span>
<span id="cb56-46"><a href="#cb56-46" aria-hidden="true" tabindex="-1"></a>    pred<span class="op">-&gt;</span>instruction_count <span class="op">+=</span> succ<span class="op">-&gt;</span>instruction_count<span class="op">;</span></span>
<span id="cb56-47"><a href="#cb56-47" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb56-48"><a href="#cb56-48" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Update instruction parent blocks</span></span>
<span id="cb56-49"><a href="#cb56-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>Instruction <span class="op">*</span>inst <span class="op">=</span> succ<span class="op">-&gt;</span>first<span class="op">;</span> inst<span class="op">;</span> inst <span class="op">=</span> inst<span class="op">-&gt;</span>next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb56-50"><a href="#cb56-50" aria-hidden="true" tabindex="-1"></a>        inst<span class="op">-&gt;</span>block <span class="op">=</span> pred<span class="op">;</span></span>
<span id="cb56-51"><a href="#cb56-51" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb56-52"><a href="#cb56-52" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb56-53"><a href="#cb56-53" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Copy terminator</span></span>
<span id="cb56-54"><a href="#cb56-54" aria-hidden="true" tabindex="-1"></a>    pred<span class="op">-&gt;</span>terminator_type <span class="op">=</span> succ<span class="op">-&gt;</span>terminator_type<span class="op">;</span></span>
<span id="cb56-55"><a href="#cb56-55" aria-hidden="true" tabindex="-1"></a>    pred<span class="op">-&gt;</span>terminator <span class="op">=</span> succ<span class="op">-&gt;</span>terminator<span class="op">;</span></span>
<span id="cb56-56"><a href="#cb56-56" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb56-57"><a href="#cb56-57" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Update edges</span></span>
<span id="cb56-58"><a href="#cb56-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> succ<span class="op">-&gt;</span>successor_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb56-59"><a href="#cb56-59" aria-hidden="true" tabindex="-1"></a>        BasicBlock <span class="op">*</span>target <span class="op">=</span> succ<span class="op">-&gt;</span>successors<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb56-60"><a href="#cb56-60" aria-hidden="true" tabindex="-1"></a>        add_edge<span class="op">(</span>pred<span class="op">,</span> target<span class="op">);</span></span>
<span id="cb56-61"><a href="#cb56-61" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb56-62"><a href="#cb56-62" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Update phi nodes</span></span>
<span id="cb56-63"><a href="#cb56-63" aria-hidden="true" tabindex="-1"></a>        update_phi_blocks<span class="op">(</span>target<span class="op">,</span> succ<span class="op">,</span> pred<span class="op">);</span></span>
<span id="cb56-64"><a href="#cb56-64" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb56-65"><a href="#cb56-65" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb56-66"><a href="#cb56-66" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Remove old edges</span></span>
<span id="cb56-67"><a href="#cb56-67" aria-hidden="true" tabindex="-1"></a>    remove_edge<span class="op">(</span>pred<span class="op">,</span> succ<span class="op">);</span></span>
<span id="cb56-68"><a href="#cb56-68" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> succ<span class="op">-&gt;</span>successor_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb56-69"><a href="#cb56-69" aria-hidden="true" tabindex="-1"></a>        remove_edge<span class="op">(</span>succ<span class="op">,</span> succ<span class="op">-&gt;</span>successors<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb56-70"><a href="#cb56-70" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb56-71"><a href="#cb56-71" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb56-72"><a href="#cb56-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-73"><a href="#cb56-73" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> simplify_cfg<span class="op">(</span>CFG <span class="op">*</span>cfg<span class="op">)</span> <span class="op">{</span></span>
<span id="cb56-74"><a href="#cb56-74" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> changed<span class="op">;</span></span>
<span id="cb56-75"><a href="#cb56-75" aria-hidden="true" tabindex="-1"></a>    <span class="cf">do</span> <span class="op">{</span></span>
<span id="cb56-76"><a href="#cb56-76" aria-hidden="true" tabindex="-1"></a>        changed <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb56-77"><a href="#cb56-77" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb56-78"><a href="#cb56-78" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> cfg<span class="op">-&gt;</span>block_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb56-79"><a href="#cb56-79" aria-hidden="true" tabindex="-1"></a>            BasicBlock <span class="op">*</span>block <span class="op">=</span> cfg<span class="op">-&gt;</span>blocks<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb56-80"><a href="#cb56-80" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb56-81"><a href="#cb56-81" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Merge blocks with single predecessor/successor</span></span>
<span id="cb56-82"><a href="#cb56-82" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>block<span class="op">-&gt;</span>terminator_type <span class="op">==</span> TERM_JUMP <span class="op">&amp;&amp;</span></span>
<span id="cb56-83"><a href="#cb56-83" aria-hidden="true" tabindex="-1"></a>                block<span class="op">-&gt;</span>successor_count <span class="op">==</span> <span class="dv">1</span> <span class="op">&amp;&amp;</span></span>
<span id="cb56-84"><a href="#cb56-84" aria-hidden="true" tabindex="-1"></a>                block<span class="op">-&gt;</span>successors<span class="op">[</span><span class="dv">0</span><span class="op">]-&gt;</span>predecessor_count <span class="op">==</span> <span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb56-85"><a href="#cb56-85" aria-hidden="true" tabindex="-1"></a>                merge_blocks<span class="op">(</span>block<span class="op">,</span> block<span class="op">-&gt;</span>successors<span class="op">[</span><span class="dv">0</span><span class="op">]);</span></span>
<span id="cb56-86"><a href="#cb56-86" aria-hidden="true" tabindex="-1"></a>                changed <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb56-87"><a href="#cb56-87" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb56-88"><a href="#cb56-88" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb56-89"><a href="#cb56-89" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Remove empty blocks</span></span>
<span id="cb56-90"><a href="#cb56-90" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>block<span class="op">-&gt;</span>instruction_count <span class="op">==</span> <span class="dv">0</span> <span class="op">&amp;&amp;</span></span>
<span id="cb56-91"><a href="#cb56-91" aria-hidden="true" tabindex="-1"></a>                block<span class="op">-&gt;</span>terminator_type <span class="op">==</span> TERM_JUMP <span class="op">&amp;&amp;</span></span>
<span id="cb56-92"><a href="#cb56-92" aria-hidden="true" tabindex="-1"></a>                block <span class="op">!=</span> cfg<span class="op">-&gt;</span>entry<span class="op">)</span> <span class="op">{</span></span>
<span id="cb56-93"><a href="#cb56-93" aria-hidden="true" tabindex="-1"></a>                bypass_empty_block<span class="op">(</span>block<span class="op">);</span></span>
<span id="cb56-94"><a href="#cb56-94" aria-hidden="true" tabindex="-1"></a>                changed <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb56-95"><a href="#cb56-95" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb56-96"><a href="#cb56-96" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb56-97"><a href="#cb56-97" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb56-98"><a href="#cb56-98" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>changed<span class="op">)</span> <span class="op">{</span></span>
<span id="cb56-99"><a href="#cb56-99" aria-hidden="true" tabindex="-1"></a>            remove_unreachable_blocks<span class="op">(</span>cfg<span class="op">);</span></span>
<span id="cb56-100"><a href="#cb56-100" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb56-101"><a href="#cb56-101" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">while</span> <span class="op">(</span>changed<span class="op">);</span></span>
<span id="cb56-102"><a href="#cb56-102" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>4.10 Dominance Analysis</h2>
<p>Computing dominance relationships is crucial for SSA
construction:</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> compute_dominance<span class="op">(</span>CFG <span class="op">*</span>cfg<span class="op">)</span> <span class="op">{</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> n <span class="op">=</span> cfg<span class="op">-&gt;</span>block_count<span class="op">;</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Initialize dominance sets</span></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> n<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>        cfg<span class="op">-&gt;</span>blocks<span class="op">[</span>i<span class="op">]-&gt;</span>dominators <span class="op">=</span> bitset_new<span class="op">(</span>n<span class="op">);</span></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>cfg<span class="op">-&gt;</span>blocks<span class="op">[</span>i<span class="op">]</span> <span class="op">==</span> cfg<span class="op">-&gt;</span>entry<span class="op">)</span> <span class="op">{</span></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>            bitset_set<span class="op">(</span>cfg<span class="op">-&gt;</span>blocks<span class="op">[</span>i<span class="op">]-&gt;</span>dominators<span class="op">,</span> cfg<span class="op">-&gt;</span>blocks<span class="op">[</span>i<span class="op">]-&gt;</span>id<span class="op">);</span></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>            bitset_set_all<span class="op">(</span>cfg<span class="op">-&gt;</span>blocks<span class="op">[</span>i<span class="op">]-&gt;</span>dominators<span class="op">,</span> n<span class="op">);</span></span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Iterate until fixed point</span></span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> changed<span class="op">;</span></span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">do</span> <span class="op">{</span></span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a>        changed <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb57-19"><a href="#cb57-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> n<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb57-20"><a href="#cb57-20" aria-hidden="true" tabindex="-1"></a>            BasicBlock <span class="op">*</span>block <span class="op">=</span> cfg<span class="op">-&gt;</span>blocks<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb57-21"><a href="#cb57-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>block <span class="op">==</span> cfg<span class="op">-&gt;</span>entry<span class="op">)</span> <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb57-22"><a href="#cb57-22" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb57-23"><a href="#cb57-23" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Dom(block) = {block}  ( Dom(pred) for pred in predecessors)</span></span>
<span id="cb57-24"><a href="#cb57-24" aria-hidden="true" tabindex="-1"></a>            BitSet <span class="op">*</span>new_dom <span class="op">=</span> bitset_new<span class="op">(</span>n<span class="op">);</span></span>
<span id="cb57-25"><a href="#cb57-25" aria-hidden="true" tabindex="-1"></a>            bitset_set_all<span class="op">(</span>new_dom<span class="op">,</span> n<span class="op">);</span></span>
<span id="cb57-26"><a href="#cb57-26" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb57-27"><a href="#cb57-27" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> block<span class="op">-&gt;</span>predecessor_count<span class="op">;</span> j<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb57-28"><a href="#cb57-28" aria-hidden="true" tabindex="-1"></a>                bitset_intersect<span class="op">(</span>new_dom<span class="op">,</span> block<span class="op">-&gt;</span>predecessors<span class="op">[</span>j<span class="op">]-&gt;</span>dominators<span class="op">);</span></span>
<span id="cb57-29"><a href="#cb57-29" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb57-30"><a href="#cb57-30" aria-hidden="true" tabindex="-1"></a>            bitset_set<span class="op">(</span>new_dom<span class="op">,</span> block<span class="op">-&gt;</span>id<span class="op">);</span></span>
<span id="cb57-31"><a href="#cb57-31" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb57-32"><a href="#cb57-32" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(!</span>bitset_equal<span class="op">(</span>new_dom<span class="op">,</span> block<span class="op">-&gt;</span>dominators<span class="op">))</span> <span class="op">{</span></span>
<span id="cb57-33"><a href="#cb57-33" aria-hidden="true" tabindex="-1"></a>                bitset_free<span class="op">(</span>block<span class="op">-&gt;</span>dominators<span class="op">);</span></span>
<span id="cb57-34"><a href="#cb57-34" aria-hidden="true" tabindex="-1"></a>                block<span class="op">-&gt;</span>dominators <span class="op">=</span> new_dom<span class="op">;</span></span>
<span id="cb57-35"><a href="#cb57-35" aria-hidden="true" tabindex="-1"></a>                changed <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb57-36"><a href="#cb57-36" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb57-37"><a href="#cb57-37" aria-hidden="true" tabindex="-1"></a>                bitset_free<span class="op">(</span>new_dom<span class="op">);</span></span>
<span id="cb57-38"><a href="#cb57-38" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb57-39"><a href="#cb57-39" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb57-40"><a href="#cb57-40" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">while</span> <span class="op">(</span>changed<span class="op">);</span></span>
<span id="cb57-41"><a href="#cb57-41" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb57-42"><a href="#cb57-42" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Compute immediate dominators</span></span>
<span id="cb57-43"><a href="#cb57-43" aria-hidden="true" tabindex="-1"></a>    compute_idom<span class="op">(</span>cfg<span class="op">);</span></span>
<span id="cb57-44"><a href="#cb57-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb57-45"><a href="#cb57-45" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Compute dominance frontiers</span></span>
<span id="cb57-46"><a href="#cb57-46" aria-hidden="true" tabindex="-1"></a>    compute_df<span class="op">(</span>cfg<span class="op">);</span></span>
<span id="cb57-47"><a href="#cb57-47" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb57-48"><a href="#cb57-48" aria-hidden="true" tabindex="-1"></a>    cfg<span class="op">-&gt;</span>dominance_computed <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb57-49"><a href="#cb57-49" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb57-50"><a href="#cb57-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-51"><a href="#cb57-51" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> compute_idom<span class="op">(</span>CFG <span class="op">*</span>cfg<span class="op">)</span> <span class="op">{</span></span>
<span id="cb57-52"><a href="#cb57-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> cfg<span class="op">-&gt;</span>block_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb57-53"><a href="#cb57-53" aria-hidden="true" tabindex="-1"></a>        BasicBlock <span class="op">*</span>block <span class="op">=</span> cfg<span class="op">-&gt;</span>blocks<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb57-54"><a href="#cb57-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>block <span class="op">==</span> cfg<span class="op">-&gt;</span>entry<span class="op">)</span> <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb57-55"><a href="#cb57-55" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb57-56"><a href="#cb57-56" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Find immediate dominator</span></span>
<span id="cb57-57"><a href="#cb57-57" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> cfg<span class="op">-&gt;</span>block_count<span class="op">;</span> j<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb57-58"><a href="#cb57-58" aria-hidden="true" tabindex="-1"></a>            BasicBlock <span class="op">*</span>dom <span class="op">=</span> cfg<span class="op">-&gt;</span>blocks<span class="op">[</span>j<span class="op">];</span></span>
<span id="cb57-59"><a href="#cb57-59" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>dom <span class="op">==</span> block<span class="op">)</span> <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb57-60"><a href="#cb57-60" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb57-61"><a href="#cb57-61" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>bitset_test<span class="op">(</span>block<span class="op">-&gt;</span>dominators<span class="op">,</span> dom<span class="op">-&gt;</span>id<span class="op">))</span> <span class="op">{</span></span>
<span id="cb57-62"><a href="#cb57-62" aria-hidden="true" tabindex="-1"></a>                <span class="dt">bool</span> is_idom <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb57-63"><a href="#cb57-63" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb57-64"><a href="#cb57-64" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Check if dom dominates all other dominators</span></span>
<span id="cb57-65"><a href="#cb57-65" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> k <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> k <span class="op">&lt;</span> cfg<span class="op">-&gt;</span>block_count<span class="op">;</span> k<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb57-66"><a href="#cb57-66" aria-hidden="true" tabindex="-1"></a>                    BasicBlock <span class="op">*</span>other <span class="op">=</span> cfg<span class="op">-&gt;</span>blocks<span class="op">[</span>k<span class="op">];</span></span>
<span id="cb57-67"><a href="#cb57-67" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="op">(</span>other <span class="op">==</span> block <span class="op">||</span> other <span class="op">==</span> dom<span class="op">)</span> <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb57-68"><a href="#cb57-68" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb57-69"><a href="#cb57-69" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="op">(</span>bitset_test<span class="op">(</span>block<span class="op">-&gt;</span>dominators<span class="op">,</span> other<span class="op">-&gt;</span>id<span class="op">)</span> <span class="op">&amp;&amp;</span></span>
<span id="cb57-70"><a href="#cb57-70" aria-hidden="true" tabindex="-1"></a>                        <span class="op">!</span>bitset_test<span class="op">(</span>other<span class="op">-&gt;</span>dominators<span class="op">,</span> dom<span class="op">-&gt;</span>id<span class="op">))</span> <span class="op">{</span></span>
<span id="cb57-71"><a href="#cb57-71" aria-hidden="true" tabindex="-1"></a>                        is_idom <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb57-72"><a href="#cb57-72" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb57-73"><a href="#cb57-73" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span></span>
<span id="cb57-74"><a href="#cb57-74" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb57-75"><a href="#cb57-75" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb57-76"><a href="#cb57-76" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span>is_idom<span class="op">)</span> <span class="op">{</span></span>
<span id="cb57-77"><a href="#cb57-77" aria-hidden="true" tabindex="-1"></a>                    block<span class="op">-&gt;</span>idom <span class="op">=</span> dom<span class="op">;</span></span>
<span id="cb57-78"><a href="#cb57-78" aria-hidden="true" tabindex="-1"></a>                    block<span class="op">-&gt;</span>dom_depth <span class="op">=</span> dom<span class="op">-&gt;</span>dom_depth <span class="op">+</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb57-79"><a href="#cb57-79" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">break</span><span class="op">;</span></span>
<span id="cb57-80"><a href="#cb57-80" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb57-81"><a href="#cb57-81" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb57-82"><a href="#cb57-82" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb57-83"><a href="#cb57-83" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb57-84"><a href="#cb57-84" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb57-85"><a href="#cb57-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-86"><a href="#cb57-86" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> compute_df<span class="op">(</span>CFG <span class="op">*</span>cfg<span class="op">)</span> <span class="op">{</span></span>
<span id="cb57-87"><a href="#cb57-87" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Compute dominance frontiers using Cytron et al. algorithm</span></span>
<span id="cb57-88"><a href="#cb57-88" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> cfg<span class="op">-&gt;</span>block_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb57-89"><a href="#cb57-89" aria-hidden="true" tabindex="-1"></a>        BasicBlock <span class="op">*</span>block <span class="op">=</span> cfg<span class="op">-&gt;</span>blocks<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb57-90"><a href="#cb57-90" aria-hidden="true" tabindex="-1"></a>        block<span class="op">-&gt;</span>df <span class="op">=</span> bitset_new<span class="op">(</span>cfg<span class="op">-&gt;</span>block_count<span class="op">);</span></span>
<span id="cb57-91"><a href="#cb57-91" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb57-92"><a href="#cb57-92" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb57-93"><a href="#cb57-93" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> cfg<span class="op">-&gt;</span>block_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb57-94"><a href="#cb57-94" aria-hidden="true" tabindex="-1"></a>        BasicBlock <span class="op">*</span>block <span class="op">=</span> cfg<span class="op">-&gt;</span>blocks<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb57-95"><a href="#cb57-95" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb57-96"><a href="#cb57-96" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>block<span class="op">-&gt;</span>predecessor_count <span class="op">&gt;=</span> <span class="dv">2</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb57-97"><a href="#cb57-97" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> block<span class="op">-&gt;</span>predecessor_count<span class="op">;</span> j<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb57-98"><a href="#cb57-98" aria-hidden="true" tabindex="-1"></a>                BasicBlock <span class="op">*</span>runner <span class="op">=</span> block<span class="op">-&gt;</span>predecessors<span class="op">[</span>j<span class="op">];</span></span>
<span id="cb57-99"><a href="#cb57-99" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb57-100"><a href="#cb57-100" aria-hidden="true" tabindex="-1"></a>                <span class="cf">while</span> <span class="op">(</span>runner <span class="op">!=</span> block<span class="op">-&gt;</span>idom<span class="op">)</span> <span class="op">{</span></span>
<span id="cb57-101"><a href="#cb57-101" aria-hidden="true" tabindex="-1"></a>                    bitset_set<span class="op">(</span>runner<span class="op">-&gt;</span>df<span class="op">,</span> block<span class="op">-&gt;</span>id<span class="op">);</span></span>
<span id="cb57-102"><a href="#cb57-102" aria-hidden="true" tabindex="-1"></a>                    runner <span class="op">=</span> runner<span class="op">-&gt;</span>idom<span class="op">;</span></span>
<span id="cb57-103"><a href="#cb57-103" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb57-104"><a href="#cb57-104" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb57-105"><a href="#cb57-105" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb57-106"><a href="#cb57-106" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb57-107"><a href="#cb57-107" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>4.11 Loop Detection</h2>
<p>Identifying natural loops for optimization: Heres the detailed
continuation for <strong>Chapter4</strong> based on the style weve
been using for the Diyrbal Implementation Bible, summarising what youve
just provided about dominance computation and leading into the next
CFGrelated stage.</p>
<hr />
<p>##4.10Dominance Analysis</p>
<p>Once the CFG has been simplified, we compute the dominance
relationships that drive later SSA placement and loop analysis.</p>
<p>The procedure is standard:</p>
<ol type="1">
<li><strong>Dominance Sets</strong>  Initialise so that the entry
blocks dominator set contains only itself, and all other blocks sets
initially contain every block. Iteratively refine using:</li>
</ol>
<p>[ Dom(B) = {B} \cup \bigcap_{P\in Preds(B)} Dom(P) ]</p>
<p>until convergence.</p>
<ol start="2" type="1">
<li><p><strong>Immediate Dominators (<code>idom</code>)</strong>  For
each block other than the entry, find the unique dominator that is
closest to it in the dominator tree. This is the parent in that tree. We
store both the <code>idom</code> and a <code>dom_depth</code> for
hierarchical traversals.</p></li>
<li><p><strong>Dominance Frontiers (<code>df</code>)</strong>  Using
the Cytron etal. algorithm, visit each join point (a block with two or
more predecessors) and walk backwards along <code>idom</code> links to
all strict dominators, adding the join point to their dominance frontier
sets. These sets will later be used when inserting nodes at points
where values merge from different paths.</p></li>
</ol>
<p>Dominance analysis is marked complete when all sets, parents, and
frontiers have been computed and cached within the
<code>BasicBlock</code> structures.</p>
<hr />
<h3>Summary of Data Structures Used</h3>
<ul>
<li><strong><code>dominators</code></strong>: bitset representing all
blocks dominating the current one.</li>
<li><strong><code>idom</code></strong>: pointer to the immediate
dominator block.</li>
<li><strong><code>df</code></strong>: bitset representing the dominance
frontier of the block.</li>
</ul>
<hr />
<p>At this stage, the CFG is a fully connected and analysed graph; we
have explicit entry/exit, block connectivity, SSAstyle instruction
lists inside each block ready for variable renaming, and exact
dominance/frontier information. This sets the stage for:</p>
<ul>
<li><strong>Loop detection</strong> (natural loop headers can be
identified where a successor dominates one of its predecessors),</li>
<li><strong>SSA variable renaming and insertion</strong> (using
<code>df</code>),</li>
<li><strong>Further controlflow simplifications</strong>.</li>
</ul>
<p>The chapter closes by noting that, with the CFG complete and
dominance information in place, the next chapter will focus on loop
detection and SSA conversion rules as applied in Diyrbal.</p>
<hr />
<p>If you like, I can go ahead and draft <strong>Chapter5: Loop
Analysis and SSA Conversion</strong> in the same level of structural and
codeoriented detail so we keep the continuity of the Implementation
Bible. Would you like me to proceed with that next?</p>
<h1>Chapter 5: SSA Form Generation</h1>
<h2>5.1 Introduction</h2>
<p>Static Single Assignment (SSA) form is a program representation where
each variable is assigned exactly once. This property simplifies many
analyses and optimizations by making def-use relationships explicit.
This chapter details Diyrbal&#39;s SSA construction algorithm, which
transforms the CFG from Chapter 4 into SSA form.</p>
<p>The key challenges in SSA construction are:</p>
<ul>
<li><strong>Variable Renaming</strong>: Each assignment creates a new
version of a variable</li>
<li><strong>-Node Insertion</strong>: At control-flow merge points,
-nodes select the appropriate variable version</li>
<li><strong>Minimal SSA</strong>: Inserting -nodes only where necessary
to avoid bloat</li>
<li><strong>Memory Operations</strong>: Extending SSA to handle loads
and stores</li>
</ul>
<h2>5.2 SSA Construction Overview</h2>
<p>Diyrbal uses the algorithm from Cytron et al., which consists of two
phases:</p>
<ol type="1">
<li><strong>-Node Insertion</strong>: Place -nodes at dominance
frontiers</li>
<li><strong>Variable Renaming</strong>: Assign unique names to each
definition</li>
</ol>
<div class="sourceCode" id="cb58"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> SSAConstructor <span class="op">{</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>    CFG <span class="op">*</span>cfg<span class="op">;</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Variable information</span></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>        <span class="dt">char</span> <span class="op">*</span>name<span class="op">;</span></span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>        Type <span class="op">*</span>type<span class="op">;</span></span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>        <span class="dt">bool</span> is_local<span class="op">;</span></span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Definition sites</span></span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>        BasicBlock <span class="op">**</span>def_blocks<span class="op">;</span></span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>        <span class="dt">size_t</span> def_count<span class="op">;</span></span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a>        <span class="co">// -nodes for this variable</span></span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a>        Instruction <span class="op">**</span>phi_nodes<span class="op">;</span></span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a>        <span class="dt">size_t</span> phi_count<span class="op">;</span></span>
<span id="cb58-17"><a href="#cb58-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="op">*</span>variables<span class="op">;</span></span>
<span id="cb58-18"><a href="#cb58-18" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> variable_count<span class="op">;</span></span>
<span id="cb58-19"><a href="#cb58-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb58-20"><a href="#cb58-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Renaming state</span></span>
<span id="cb58-21"><a href="#cb58-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb58-22"><a href="#cb58-22" aria-hidden="true" tabindex="-1"></a>        Value <span class="op">**</span>stack<span class="op">;</span></span>
<span id="cb58-23"><a href="#cb58-23" aria-hidden="true" tabindex="-1"></a>        <span class="dt">size_t</span> top<span class="op">;</span></span>
<span id="cb58-24"><a href="#cb58-24" aria-hidden="true" tabindex="-1"></a>        <span class="dt">size_t</span> capacity<span class="op">;</span></span>
<span id="cb58-25"><a href="#cb58-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="op">*</span>rename_stacks<span class="op">;</span></span>
<span id="cb58-26"><a href="#cb58-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb58-27"><a href="#cb58-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Statistics</span></span>
<span id="cb58-28"><a href="#cb58-28" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> phi_nodes_inserted<span class="op">;</span></span>
<span id="cb58-29"><a href="#cb58-29" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> variables_renamed<span class="op">;</span></span>
<span id="cb58-30"><a href="#cb58-30" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> SSAConstructor<span class="op">;</span></span>
<span id="cb58-31"><a href="#cb58-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-32"><a href="#cb58-32" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> convert_to_ssa<span class="op">(</span>CFG <span class="op">*</span>cfg<span class="op">)</span> <span class="op">{</span></span>
<span id="cb58-33"><a href="#cb58-33" aria-hidden="true" tabindex="-1"></a>    SSAConstructor ssa <span class="op">=</span> <span class="op">{</span><span class="dv">0</span><span class="op">};</span></span>
<span id="cb58-34"><a href="#cb58-34" aria-hidden="true" tabindex="-1"></a>    ssa<span class="op">.</span>cfg <span class="op">=</span> cfg<span class="op">;</span></span>
<span id="cb58-35"><a href="#cb58-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb58-36"><a href="#cb58-36" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Ensure dominance information is computed</span></span>
<span id="cb58-37"><a href="#cb58-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>cfg<span class="op">-&gt;</span>dominance_computed<span class="op">)</span> <span class="op">{</span></span>
<span id="cb58-38"><a href="#cb58-38" aria-hidden="true" tabindex="-1"></a>        compute_dominance<span class="op">(</span>cfg<span class="op">);</span></span>
<span id="cb58-39"><a href="#cb58-39" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb58-40"><a href="#cb58-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb58-41"><a href="#cb58-41" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Collect variables</span></span>
<span id="cb58-42"><a href="#cb58-42" aria-hidden="true" tabindex="-1"></a>    collect_variables<span class="op">(&amp;</span>ssa<span class="op">);</span></span>
<span id="cb58-43"><a href="#cb58-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb58-44"><a href="#cb58-44" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Insert -nodes</span></span>
<span id="cb58-45"><a href="#cb58-45" aria-hidden="true" tabindex="-1"></a>    insert_phi_nodes<span class="op">(&amp;</span>ssa<span class="op">);</span></span>
<span id="cb58-46"><a href="#cb58-46" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb58-47"><a href="#cb58-47" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Rename variables</span></span>
<span id="cb58-48"><a href="#cb58-48" aria-hidden="true" tabindex="-1"></a>    rename_variables<span class="op">(&amp;</span>ssa<span class="op">);</span></span>
<span id="cb58-49"><a href="#cb58-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb58-50"><a href="#cb58-50" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Clean up</span></span>
<span id="cb58-51"><a href="#cb58-51" aria-hidden="true" tabindex="-1"></a>    cleanup_ssa_constructor<span class="op">(&amp;</span>ssa<span class="op">);</span></span>
<span id="cb58-52"><a href="#cb58-52" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>5.3 Variable Collection</h2>
<p>First, we identify all variables that need SSA form:</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> collect_variables<span class="op">(</span>SSAConstructor <span class="op">*</span>ssa<span class="op">)</span> <span class="op">{</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Collect function parameters</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>    Function <span class="op">*</span>func <span class="op">=</span> ssa<span class="op">-&gt;</span>cfg<span class="op">-&gt;</span>function<span class="op">;</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> func<span class="op">-&gt;</span>param_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>        add_variable<span class="op">(</span>ssa<span class="op">,</span> func<span class="op">-&gt;</span>params<span class="op">[</span>i<span class="op">].</span>name<span class="op">,</span> func<span class="op">-&gt;</span>params<span class="op">[</span>i<span class="op">].</span>type<span class="op">,</span> <span class="kw">false</span><span class="op">);</span></span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Collect local variables from all blocks</span></span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> ssa<span class="op">-&gt;</span>cfg<span class="op">-&gt;</span>block_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>        BasicBlock <span class="op">*</span>block <span class="op">=</span> ssa<span class="op">-&gt;</span>cfg<span class="op">-&gt;</span>blocks<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>        collect_block_variables<span class="op">(</span>ssa<span class="op">,</span> block<span class="op">);</span></span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Initialize rename stacks</span></span>
<span id="cb59-15"><a href="#cb59-15" aria-hidden="true" tabindex="-1"></a>    ssa<span class="op">-&gt;</span>rename_stacks <span class="op">=</span> calloc<span class="op">(</span>ssa<span class="op">-&gt;</span>variable_count<span class="op">,</span> </span>
<span id="cb59-16"><a href="#cb59-16" aria-hidden="true" tabindex="-1"></a>                                <span class="kw">sizeof</span><span class="op">(</span>ssa<span class="op">-&gt;</span>rename_stacks<span class="op">[</span><span class="dv">0</span><span class="op">]));</span></span>
<span id="cb59-17"><a href="#cb59-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> ssa<span class="op">-&gt;</span>variable_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb59-18"><a href="#cb59-18" aria-hidden="true" tabindex="-1"></a>        ssa<span class="op">-&gt;</span>rename_stacks<span class="op">[</span>i<span class="op">].</span>capacity <span class="op">=</span> <span class="dv">16</span><span class="op">;</span></span>
<span id="cb59-19"><a href="#cb59-19" aria-hidden="true" tabindex="-1"></a>        ssa<span class="op">-&gt;</span>rename_stacks<span class="op">[</span>i<span class="op">].</span>stack <span class="op">=</span> calloc<span class="op">(</span><span class="dv">16</span><span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>Value<span class="op">*));</span></span>
<span id="cb59-20"><a href="#cb59-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb59-21"><a href="#cb59-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb59-22"><a href="#cb59-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-23"><a href="#cb59-23" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> collect_block_variables<span class="op">(</span>SSAConstructor <span class="op">*</span>ssa<span class="op">,</span> BasicBlock <span class="op">*</span>block<span class="op">)</span> <span class="op">{</span></span>
<span id="cb59-24"><a href="#cb59-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>Instruction <span class="op">*</span>inst <span class="op">=</span> block<span class="op">-&gt;</span>first<span class="op">;</span> inst<span class="op">;</span> inst <span class="op">=</span> inst<span class="op">-&gt;</span>next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb59-25"><a href="#cb59-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">switch</span> <span class="op">(</span>inst<span class="op">-&gt;</span>kind<span class="op">)</span> <span class="op">{</span></span>
<span id="cb59-26"><a href="#cb59-26" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> INST_ALLOCA<span class="op">:</span></span>
<span id="cb59-27"><a href="#cb59-27" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Local variable declaration</span></span>
<span id="cb59-28"><a href="#cb59-28" aria-hidden="true" tabindex="-1"></a>                add_variable<span class="op">(</span>ssa<span class="op">,</span> inst<span class="op">-&gt;</span>data<span class="op">.</span>alloca<span class="op">.</span>name<span class="op">,</span> </span>
<span id="cb59-29"><a href="#cb59-29" aria-hidden="true" tabindex="-1"></a>                           inst<span class="op">-&gt;</span>data<span class="op">.</span>alloca<span class="op">.</span>type<span class="op">,</span> <span class="kw">true</span><span class="op">);</span></span>
<span id="cb59-30"><a href="#cb59-30" aria-hidden="true" tabindex="-1"></a>                record_def_site<span class="op">(</span>ssa<span class="op">,</span> inst<span class="op">-&gt;</span>data<span class="op">.</span>alloca<span class="op">.</span>name<span class="op">,</span> block<span class="op">);</span></span>
<span id="cb59-31"><a href="#cb59-31" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb59-32"><a href="#cb59-32" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb59-33"><a href="#cb59-33" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> INST_STORE<span class="op">:</span></span>
<span id="cb59-34"><a href="#cb59-34" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Assignment to existing variable</span></span>
<span id="cb59-35"><a href="#cb59-35" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span>inst<span class="op">-&gt;</span>operands<span class="op">[</span><span class="dv">1</span><span class="op">]-&gt;</span>kind <span class="op">==</span> VALUE_LOCAL<span class="op">)</span> <span class="op">{</span></span>
<span id="cb59-36"><a href="#cb59-36" aria-hidden="true" tabindex="-1"></a>                    record_def_site<span class="op">(</span>ssa<span class="op">,</span> inst<span class="op">-&gt;</span>operands<span class="op">[</span><span class="dv">1</span><span class="op">]-&gt;</span>data<span class="op">.</span>local<span class="op">.</span>name<span class="op">,</span> </span>
<span id="cb59-37"><a href="#cb59-37" aria-hidden="true" tabindex="-1"></a>                                  block<span class="op">);</span></span>
<span id="cb59-38"><a href="#cb59-38" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb59-39"><a href="#cb59-39" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb59-40"><a href="#cb59-40" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb59-41"><a href="#cb59-41" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb59-42"><a href="#cb59-42" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb59-43"><a href="#cb59-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-44"><a href="#cb59-44" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">size_t</span> find_variable<span class="op">(</span>SSAConstructor <span class="op">*</span>ssa<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>name<span class="op">)</span> <span class="op">{</span></span>
<span id="cb59-45"><a href="#cb59-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> ssa<span class="op">-&gt;</span>variable_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb59-46"><a href="#cb59-46" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>strcmp<span class="op">(</span>ssa<span class="op">-&gt;</span>variables<span class="op">[</span>i<span class="op">].</span>name<span class="op">,</span> name<span class="op">)</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb59-47"><a href="#cb59-47" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> i<span class="op">;</span></span>
<span id="cb59-48"><a href="#cb59-48" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb59-49"><a href="#cb59-49" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb59-50"><a href="#cb59-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> SIZE_MAX<span class="op">;</span></span>
<span id="cb59-51"><a href="#cb59-51" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb59-52"><a href="#cb59-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-53"><a href="#cb59-53" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> record_def_site<span class="op">(</span>SSAConstructor <span class="op">*</span>ssa<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>name<span class="op">,</span> </span>
<span id="cb59-54"><a href="#cb59-54" aria-hidden="true" tabindex="-1"></a>                          BasicBlock <span class="op">*</span>block<span class="op">)</span> <span class="op">{</span></span>
<span id="cb59-55"><a href="#cb59-55" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> var_idx <span class="op">=</span> find_variable<span class="op">(</span>ssa<span class="op">,</span> name<span class="op">);</span></span>
<span id="cb59-56"><a href="#cb59-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>var_idx <span class="op">==</span> SIZE_MAX<span class="op">)</span> <span class="cf">return</span><span class="op">;</span></span>
<span id="cb59-57"><a href="#cb59-57" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb59-58"><a href="#cb59-58" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Add block to definition sites if not already present</span></span>
<span id="cb59-59"><a href="#cb59-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> ssa<span class="op">-&gt;</span>variables<span class="op">[</span>var_idx<span class="op">].</span>def_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb59-60"><a href="#cb59-60" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>ssa<span class="op">-&gt;</span>variables<span class="op">[</span>var_idx<span class="op">].</span>def_blocks<span class="op">[</span>i<span class="op">]</span> <span class="op">==</span> block<span class="op">)</span> <span class="op">{</span></span>
<span id="cb59-61"><a href="#cb59-61" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span><span class="op">;</span></span>
<span id="cb59-62"><a href="#cb59-62" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb59-63"><a href="#cb59-63" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb59-64"><a href="#cb59-64" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb59-65"><a href="#cb59-65" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> n <span class="op">=</span> ssa<span class="op">-&gt;</span>variables<span class="op">[</span>var_idx<span class="op">].</span>def_count<span class="op">++;</span></span>
<span id="cb59-66"><a href="#cb59-66" aria-hidden="true" tabindex="-1"></a>    ssa<span class="op">-&gt;</span>variables<span class="op">[</span>var_idx<span class="op">].</span>def_blocks <span class="op">=</span> realloc<span class="op">(</span></span>
<span id="cb59-67"><a href="#cb59-67" aria-hidden="true" tabindex="-1"></a>        ssa<span class="op">-&gt;</span>variables<span class="op">[</span>var_idx<span class="op">].</span>def_blocks<span class="op">,</span></span>
<span id="cb59-68"><a href="#cb59-68" aria-hidden="true" tabindex="-1"></a>        ssa<span class="op">-&gt;</span>variables<span class="op">[</span>var_idx<span class="op">].</span>def_count <span class="op">*</span> <span class="kw">sizeof</span><span class="op">(</span>BasicBlock<span class="op">*));</span></span>
<span id="cb59-69"><a href="#cb59-69" aria-hidden="true" tabindex="-1"></a>    ssa<span class="op">-&gt;</span>variables<span class="op">[</span>var_idx<span class="op">].</span>def_blocks<span class="op">[</span>n<span class="op">]</span> <span class="op">=</span> block<span class="op">;</span></span>
<span id="cb59-70"><a href="#cb59-70" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>5.4 -Node Insertion</h2>
<p>-nodes are inserted at the dominance frontier of definition
sites:</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> insert_phi_nodes<span class="op">(</span>SSAConstructor <span class="op">*</span>ssa<span class="op">)</span> <span class="op">{</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> var <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> var <span class="op">&lt;</span> ssa<span class="op">-&gt;</span>variable_count<span class="op">;</span> var<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(!</span>ssa<span class="op">-&gt;</span>variables<span class="op">[</span>var<span class="op">].</span>is_local<span class="op">)</span> <span class="op">{</span></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span><span class="op">;</span>  <span class="co">// Parameters don&#39;t need -nodes</span></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Worklist of blocks that define this variable</span></span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>        BlockSet <span class="op">*</span>worklist <span class="op">=</span> blockset_new<span class="op">(</span>ssa<span class="op">-&gt;</span>cfg<span class="op">-&gt;</span>block_count<span class="op">);</span></span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>        BlockSet <span class="op">*</span>has_phi <span class="op">=</span> blockset_new<span class="op">(</span>ssa<span class="op">-&gt;</span>cfg<span class="op">-&gt;</span>block_count<span class="op">);</span></span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>        BlockSet <span class="op">*</span>in_worklist <span class="op">=</span> blockset_new<span class="op">(</span>ssa<span class="op">-&gt;</span>cfg<span class="op">-&gt;</span>block_count<span class="op">);</span></span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Initialize worklist with definition blocks</span></span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> ssa<span class="op">-&gt;</span>variables<span class="op">[</span>var<span class="op">].</span>def_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a>            BasicBlock <span class="op">*</span>def_block <span class="op">=</span> ssa<span class="op">-&gt;</span>variables<span class="op">[</span>var<span class="op">].</span>def_blocks<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb60-15"><a href="#cb60-15" aria-hidden="true" tabindex="-1"></a>            blockset_add<span class="op">(</span>worklist<span class="op">,</span> def_block<span class="op">-&gt;</span>id<span class="op">);</span></span>
<span id="cb60-16"><a href="#cb60-16" aria-hidden="true" tabindex="-1"></a>            blockset_add<span class="op">(</span>in_worklist<span class="op">,</span> def_block<span class="op">-&gt;</span>id<span class="op">);</span></span>
<span id="cb60-17"><a href="#cb60-17" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb60-18"><a href="#cb60-18" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb60-19"><a href="#cb60-19" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Process worklist</span></span>
<span id="cb60-20"><a href="#cb60-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> <span class="op">(!</span>blockset_empty<span class="op">(</span>worklist<span class="op">))</span> <span class="op">{</span></span>
<span id="cb60-21"><a href="#cb60-21" aria-hidden="true" tabindex="-1"></a>            BasicBlock <span class="op">*</span>block <span class="op">=</span> blockset_pop<span class="op">(</span>worklist<span class="op">);</span></span>
<span id="cb60-22"><a href="#cb60-22" aria-hidden="true" tabindex="-1"></a>            blockset_remove<span class="op">(</span>in_worklist<span class="op">,</span> block<span class="op">-&gt;</span>id<span class="op">);</span></span>
<span id="cb60-23"><a href="#cb60-23" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb60-24"><a href="#cb60-24" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Insert -nodes at dominance frontier</span></span>
<span id="cb60-25"><a href="#cb60-25" aria-hidden="true" tabindex="-1"></a>            BitSetIterator it <span class="op">=</span> bitset_iterator<span class="op">(</span>block<span class="op">-&gt;</span>df<span class="op">);</span></span>
<span id="cb60-26"><a href="#cb60-26" aria-hidden="true" tabindex="-1"></a>            <span class="dt">size_t</span> df_block_id<span class="op">;</span></span>
<span id="cb60-27"><a href="#cb60-27" aria-hidden="true" tabindex="-1"></a>            <span class="cf">while</span> <span class="op">(</span>bitset_next<span class="op">(&amp;</span>it<span class="op">,</span> <span class="op">&amp;</span>df_block_id<span class="op">))</span> <span class="op">{</span></span>
<span id="cb60-28"><a href="#cb60-28" aria-hidden="true" tabindex="-1"></a>                BasicBlock <span class="op">*</span>df_block <span class="op">=</span> ssa<span class="op">-&gt;</span>cfg<span class="op">-&gt;</span>blocks<span class="op">[</span>df_block_id<span class="op">];</span></span>
<span id="cb60-29"><a href="#cb60-29" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb60-30"><a href="#cb60-30" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(!</span>blockset_contains<span class="op">(</span>has_phi<span class="op">,</span> df_block_id<span class="op">))</span> <span class="op">{</span></span>
<span id="cb60-31"><a href="#cb60-31" aria-hidden="true" tabindex="-1"></a>                    insert_phi_for_variable<span class="op">(</span>ssa<span class="op">,</span> var<span class="op">,</span> df_block<span class="op">);</span></span>
<span id="cb60-32"><a href="#cb60-32" aria-hidden="true" tabindex="-1"></a>                    blockset_add<span class="op">(</span>has_phi<span class="op">,</span> df_block_id<span class="op">);</span></span>
<span id="cb60-33"><a href="#cb60-33" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb60-34"><a href="#cb60-34" aria-hidden="true" tabindex="-1"></a>                    <span class="co">// -node is also a definition</span></span>
<span id="cb60-35"><a href="#cb60-35" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="op">(!</span>blockset_contains<span class="op">(</span>in_worklist<span class="op">,</span> df_block_id<span class="op">))</span> <span class="op">{</span></span>
<span id="cb60-36"><a href="#cb60-36" aria-hidden="true" tabindex="-1"></a>                        blockset_add<span class="op">(</span>worklist<span class="op">,</span> df_block_id<span class="op">);</span></span>
<span id="cb60-37"><a href="#cb60-37" aria-hidden="true" tabindex="-1"></a>                        blockset_add<span class="op">(</span>in_worklist<span class="op">,</span> df_block_id<span class="op">);</span></span>
<span id="cb60-38"><a href="#cb60-38" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span></span>
<span id="cb60-39"><a href="#cb60-39" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb60-40"><a href="#cb60-40" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb60-41"><a href="#cb60-41" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb60-42"><a href="#cb60-42" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb60-43"><a href="#cb60-43" aria-hidden="true" tabindex="-1"></a>        blockset_free<span class="op">(</span>worklist<span class="op">);</span></span>
<span id="cb60-44"><a href="#cb60-44" aria-hidden="true" tabindex="-1"></a>        blockset_free<span class="op">(</span>has_phi<span class="op">);</span></span>
<span id="cb60-45"><a href="#cb60-45" aria-hidden="true" tabindex="-1"></a>        blockset_free<span class="op">(</span>in_worklist<span class="op">);</span></span>
<span id="cb60-46"><a href="#cb60-46" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb60-47"><a href="#cb60-47" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb60-48"><a href="#cb60-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-49"><a href="#cb60-49" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> insert_phi_for_variable<span class="op">(</span>SSAConstructor <span class="op">*</span>ssa<span class="op">,</span> <span class="dt">size_t</span> var_idx<span class="op">,</span></span>
<span id="cb60-50"><a href="#cb60-50" aria-hidden="true" tabindex="-1"></a>                                  BasicBlock <span class="op">*</span>block<span class="op">)</span> <span class="op">{</span></span>
<span id="cb60-51"><a href="#cb60-51" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Create -node</span></span>
<span id="cb60-52"><a href="#cb60-52" aria-hidden="true" tabindex="-1"></a>    Instruction <span class="op">*</span>phi <span class="op">=</span> calloc<span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>Instruction<span class="op">));</span></span>
<span id="cb60-53"><a href="#cb60-53" aria-hidden="true" tabindex="-1"></a>    phi<span class="op">-&gt;</span>kind <span class="op">=</span> INST_PHI<span class="op">;</span></span>
<span id="cb60-54"><a href="#cb60-54" aria-hidden="true" tabindex="-1"></a>    phi<span class="op">-&gt;</span>block <span class="op">=</span> block<span class="op">;</span></span>
<span id="cb60-55"><a href="#cb60-55" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb60-56"><a href="#cb60-56" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Create result value</span></span>
<span id="cb60-57"><a href="#cb60-57" aria-hidden="true" tabindex="-1"></a>    phi<span class="op">-&gt;</span>result <span class="op">=</span> calloc<span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>Value<span class="op">));</span></span>
<span id="cb60-58"><a href="#cb60-58" aria-hidden="true" tabindex="-1"></a>    phi<span class="op">-&gt;</span>result<span class="op">-&gt;</span>kind <span class="op">=</span> VALUE_TEMP<span class="op">;</span></span>
<span id="cb60-59"><a href="#cb60-59" aria-hidden="true" tabindex="-1"></a>    phi<span class="op">-&gt;</span>result<span class="op">-&gt;</span>type <span class="op">=</span> ssa<span class="op">-&gt;</span>variables<span class="op">[</span>var_idx<span class="op">].</span>type<span class="op">;</span></span>
<span id="cb60-60"><a href="#cb60-60" aria-hidden="true" tabindex="-1"></a>    phi<span class="op">-&gt;</span>result<span class="op">-&gt;</span>def <span class="op">=</span> phi<span class="op">;</span></span>
<span id="cb60-61"><a href="#cb60-61" aria-hidden="true" tabindex="-1"></a>    phi<span class="op">-&gt;</span>result<span class="op">-&gt;</span>data<span class="op">.</span>temp<span class="op">.</span>name <span class="op">=</span> strdup<span class="op">(</span>ssa<span class="op">-&gt;</span>variables<span class="op">[</span>var_idx<span class="op">].</span>name<span class="op">);</span></span>
<span id="cb60-62"><a href="#cb60-62" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb60-63"><a href="#cb60-63" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Initialize incoming arrays</span></span>
<span id="cb60-64"><a href="#cb60-64" aria-hidden="true" tabindex="-1"></a>    phi<span class="op">-&gt;</span>data<span class="op">.</span>phi<span class="op">.</span>incoming_count <span class="op">=</span> block<span class="op">-&gt;</span>predecessor_count<span class="op">;</span></span>
<span id="cb60-65"><a href="#cb60-65" aria-hidden="true" tabindex="-1"></a>    phi<span class="op">-&gt;</span>data<span class="op">.</span>phi<span class="op">.</span>incoming_values <span class="op">=</span> calloc<span class="op">(</span>block<span class="op">-&gt;</span>predecessor_count<span class="op">,</span> </span>
<span id="cb60-66"><a href="#cb60-66" aria-hidden="true" tabindex="-1"></a>                                          <span class="kw">sizeof</span><span class="op">(</span>Value<span class="op">*));</span></span>
<span id="cb60-67"><a href="#cb60-67" aria-hidden="true" tabindex="-1"></a>    phi<span class="op">-&gt;</span>data<span class="op">.</span>phi<span class="op">.</span>incoming_blocks <span class="op">=</span> calloc<span class="op">(</span>block<span class="op">-&gt;</span>predecessor_count<span class="op">,</span></span>
<span id="cb60-68"><a href="#cb60-68" aria-hidden="true" tabindex="-1"></a>                                          <span class="kw">sizeof</span><span class="op">(</span>BasicBlock<span class="op">*));</span></span>
<span id="cb60-69"><a href="#cb60-69" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb60-70"><a href="#cb60-70" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Copy predecessor blocks</span></span>
<span id="cb60-71"><a href="#cb60-71" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> block<span class="op">-&gt;</span>predecessor_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb60-72"><a href="#cb60-72" aria-hidden="true" tabindex="-1"></a>        phi<span class="op">-&gt;</span>data<span class="op">.</span>phi<span class="op">.</span>incoming_blocks<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> block<span class="op">-&gt;</span>predecessors<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb60-73"><a href="#cb60-73" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb60-74"><a href="#cb60-74" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb60-75"><a href="#cb60-75" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Insert at beginning of block</span></span>
<span id="cb60-76"><a href="#cb60-76" aria-hidden="true" tabindex="-1"></a>    phi<span class="op">-&gt;</span>next <span class="op">=</span> block<span class="op">-&gt;</span>first<span class="op">;</span></span>
<span id="cb60-77"><a href="#cb60-77" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>block<span class="op">-&gt;</span>first<span class="op">)</span> <span class="op">{</span></span>
<span id="cb60-78"><a href="#cb60-78" aria-hidden="true" tabindex="-1"></a>        block<span class="op">-&gt;</span>first<span class="op">-&gt;</span>prev <span class="op">=</span> phi<span class="op">;</span></span>
<span id="cb60-79"><a href="#cb60-79" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb60-80"><a href="#cb60-80" aria-hidden="true" tabindex="-1"></a>    block<span class="op">-&gt;</span>first <span class="op">=</span> phi<span class="op">;</span></span>
<span id="cb60-81"><a href="#cb60-81" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>block<span class="op">-&gt;</span>last<span class="op">)</span> <span class="op">{</span></span>
<span id="cb60-82"><a href="#cb60-82" aria-hidden="true" tabindex="-1"></a>        block<span class="op">-&gt;</span>last <span class="op">=</span> phi<span class="op">;</span></span>
<span id="cb60-83"><a href="#cb60-83" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb60-84"><a href="#cb60-84" aria-hidden="true" tabindex="-1"></a>    block<span class="op">-&gt;</span>instruction_count<span class="op">++;</span></span>
<span id="cb60-85"><a href="#cb60-85" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb60-86"><a href="#cb60-86" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Record -node</span></span>
<span id="cb60-87"><a href="#cb60-87" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> n <span class="op">=</span> ssa<span class="op">-&gt;</span>variables<span class="op">[</span>var_idx<span class="op">].</span>phi_count<span class="op">++;</span></span>
<span id="cb60-88"><a href="#cb60-88" aria-hidden="true" tabindex="-1"></a>    ssa<span class="op">-&gt;</span>variables<span class="op">[</span>var_idx<span class="op">].</span>phi_nodes <span class="op">=</span> realloc<span class="op">(</span></span>
<span id="cb60-89"><a href="#cb60-89" aria-hidden="true" tabindex="-1"></a>        ssa<span class="op">-&gt;</span>variables<span class="op">[</span>var_idx<span class="op">].</span>phi_nodes<span class="op">,</span></span>
<span id="cb60-90"><a href="#cb60-90" aria-hidden="true" tabindex="-1"></a>        ssa<span class="op">-&gt;</span>variables<span class="op">[</span>var_idx<span class="op">].</span>phi_count <span class="op">*</span> <span class="kw">sizeof</span><span class="op">(</span>Instruction<span class="op">*));</span></span>
<span id="cb60-91"><a href="#cb60-91" aria-hidden="true" tabindex="-1"></a>    ssa<span class="op">-&gt;</span>variables<span class="op">[</span>var_idx<span class="op">].</span>phi_nodes<span class="op">[</span>n<span class="op">]</span> <span class="op">=</span> phi<span class="op">;</span></span>
<span id="cb60-92"><a href="#cb60-92" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb60-93"><a href="#cb60-93" aria-hidden="true" tabindex="-1"></a>    ssa<span class="op">-&gt;</span>phi_nodes_inserted<span class="op">++;</span></span>
<span id="cb60-94"><a href="#cb60-94" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>5.5 Variable Renaming</h2>
<p>The renaming phase assigns unique SSA names to each definition:</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> rename_variables<span class="op">(</span>SSAConstructor <span class="op">*</span>ssa<span class="op">)</span> <span class="op">{</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Initialize parameter values</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> ssa<span class="op">-&gt;</span>cfg<span class="op">-&gt;</span>function<span class="op">-&gt;</span>param_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>        <span class="dt">size_t</span> var_idx <span class="op">=</span> find_variable<span class="op">(</span>ssa<span class="op">,</span> ssa<span class="op">-&gt;</span>cfg<span class="op">-&gt;</span>function<span class="op">-&gt;</span>params<span class="op">[</span>i<span class="op">].</span>name<span class="op">);</span></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>var_idx <span class="op">!=</span> SIZE_MAX<span class="op">)</span> <span class="op">{</span></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>            Value <span class="op">*</span>param_val <span class="op">=</span> create_param_value<span class="op">(</span>ssa<span class="op">,</span> i<span class="op">,</span> </span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>                ssa<span class="op">-&gt;</span>cfg<span class="op">-&gt;</span>function<span class="op">-&gt;</span>params<span class="op">[</span>i<span class="op">].</span>type<span class="op">);</span></span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>            push_value<span class="op">(</span>ssa<span class="op">,</span> var_idx<span class="op">,</span> param_val<span class="op">);</span></span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Rename starting from entry block</span></span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a>    rename_block<span class="op">(</span>ssa<span class="op">,</span> ssa<span class="op">-&gt;</span>cfg<span class="op">-&gt;</span>entry<span class="op">);</span></span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> rename_block<span class="op">(</span>SSAConstructor <span class="op">*</span>ssa<span class="op">,</span> BasicBlock <span class="op">*</span>block<span class="op">)</span> <span class="op">{</span></span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Save stack depths for restoration</span></span>
<span id="cb61-18"><a href="#cb61-18" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> <span class="op">*</span>saved_depths <span class="op">=</span> calloc<span class="op">(</span>ssa<span class="op">-&gt;</span>variable_count<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span><span class="dt">size_t</span><span class="op">));</span></span>
<span id="cb61-19"><a href="#cb61-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> ssa<span class="op">-&gt;</span>variable_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb61-20"><a href="#cb61-20" aria-hidden="true" tabindex="-1"></a>        saved_depths<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> ssa<span class="op">-&gt;</span>rename_stacks<span class="op">[</span>i<span class="op">].</span>top<span class="op">;</span></span>
<span id="cb61-21"><a href="#cb61-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb61-22"><a href="#cb61-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb61-23"><a href="#cb61-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Process -nodes</span></span>
<span id="cb61-24"><a href="#cb61-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>Instruction <span class="op">*</span>inst <span class="op">=</span> block<span class="op">-&gt;</span>first<span class="op">;</span> inst <span class="op">&amp;&amp;</span> inst<span class="op">-&gt;</span>kind <span class="op">==</span> INST_PHI<span class="op">;</span> </span>
<span id="cb61-25"><a href="#cb61-25" aria-hidden="true" tabindex="-1"></a>         inst <span class="op">=</span> inst<span class="op">-&gt;</span>next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb61-26"><a href="#cb61-26" aria-hidden="true" tabindex="-1"></a>        <span class="co">// -node result pushes new value</span></span>
<span id="cb61-27"><a href="#cb61-27" aria-hidden="true" tabindex="-1"></a>        <span class="dt">size_t</span> var_idx <span class="op">=</span> find_variable_by_phi<span class="op">(</span>ssa<span class="op">,</span> inst<span class="op">);</span></span>
<span id="cb61-28"><a href="#cb61-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>var_idx <span class="op">!=</span> SIZE_MAX<span class="op">)</span> <span class="op">{</span></span>
<span id="cb61-29"><a href="#cb61-29" aria-hidden="true" tabindex="-1"></a>            push_value<span class="op">(</span>ssa<span class="op">,</span> var_idx<span class="op">,</span> inst<span class="op">-&gt;</span>result<span class="op">);</span></span>
<span id="cb61-30"><a href="#cb61-30" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb61-31"><a href="#cb61-31" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb61-32"><a href="#cb61-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb61-33"><a href="#cb61-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Process other instructions</span></span>
<span id="cb61-34"><a href="#cb61-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>Instruction <span class="op">*</span>inst <span class="op">=</span> block<span class="op">-&gt;</span>first<span class="op">;</span> inst<span class="op">;</span> inst <span class="op">=</span> inst<span class="op">-&gt;</span>next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb61-35"><a href="#cb61-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>inst<span class="op">-&gt;</span>kind <span class="op">==</span> INST_PHI<span class="op">)</span> <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb61-36"><a href="#cb61-36" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb61-37"><a href="#cb61-37" aria-hidden="true" tabindex="-1"></a>        rename_instruction<span class="op">(</span>ssa<span class="op">,</span> inst<span class="op">);</span></span>
<span id="cb61-38"><a href="#cb61-38" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb61-39"><a href="#cb61-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb61-40"><a href="#cb61-40" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Fill in -node operands in successors</span></span>
<span id="cb61-41"><a href="#cb61-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> block<span class="op">-&gt;</span>successor_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb61-42"><a href="#cb61-42" aria-hidden="true" tabindex="-1"></a>        BasicBlock <span class="op">*</span>succ <span class="op">=</span> block<span class="op">-&gt;</span>successors<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb61-43"><a href="#cb61-43" aria-hidden="true" tabindex="-1"></a>        fill_phi_operands<span class="op">(</span>ssa<span class="op">,</span> block<span class="op">,</span> succ<span class="op">);</span></span>
<span id="cb61-44"><a href="#cb61-44" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb61-45"><a href="#cb61-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb61-46"><a href="#cb61-46" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Recursively rename dominated blocks</span></span>
<span id="cb61-47"><a href="#cb61-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> ssa<span class="op">-&gt;</span>cfg<span class="op">-&gt;</span>block_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb61-48"><a href="#cb61-48" aria-hidden="true" tabindex="-1"></a>        BasicBlock <span class="op">*</span>child <span class="op">=</span> ssa<span class="op">-&gt;</span>cfg<span class="op">-&gt;</span>blocks<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb61-49"><a href="#cb61-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>child<span class="op">-&gt;</span>idom <span class="op">==</span> block<span class="op">)</span> <span class="op">{</span></span>
<span id="cb61-50"><a href="#cb61-50" aria-hidden="true" tabindex="-1"></a>            rename_block<span class="op">(</span>ssa<span class="op">,</span> child<span class="op">);</span></span>
<span id="cb61-51"><a href="#cb61-51" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb61-52"><a href="#cb61-52" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb61-53"><a href="#cb61-53" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb61-54"><a href="#cb61-54" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Restore stack depths</span></span>
<span id="cb61-55"><a href="#cb61-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> ssa<span class="op">-&gt;</span>variable_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb61-56"><a href="#cb61-56" aria-hidden="true" tabindex="-1"></a>        ssa<span class="op">-&gt;</span>rename_stacks<span class="op">[</span>i<span class="op">].</span>top <span class="op">=</span> saved_depths<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb61-57"><a href="#cb61-57" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb61-58"><a href="#cb61-58" aria-hidden="true" tabindex="-1"></a>    free<span class="op">(</span>saved_depths<span class="op">);</span></span>
<span id="cb61-59"><a href="#cb61-59" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb61-60"><a href="#cb61-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-61"><a href="#cb61-61" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> rename_instruction<span class="op">(</span>SSAConstructor <span class="op">*</span>ssa<span class="op">,</span> Instruction <span class="op">*</span>inst<span class="op">)</span> <span class="op">{</span></span>
<span id="cb61-62"><a href="#cb61-62" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Rename uses</span></span>
<span id="cb61-63"><a href="#cb61-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> inst<span class="op">-&gt;</span>operand_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb61-64"><a href="#cb61-64" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>inst<span class="op">-&gt;</span>operands<span class="op">[</span>i<span class="op">]-&gt;</span>kind <span class="op">==</span> VALUE_LOCAL<span class="op">)</span> <span class="op">{</span></span>
<span id="cb61-65"><a href="#cb61-65" aria-hidden="true" tabindex="-1"></a>            <span class="dt">size_t</span> var_idx <span class="op">=</span> find_variable<span class="op">(</span>ssa<span class="op">,</span> </span>
<span id="cb61-66"><a href="#cb61-66" aria-hidden="true" tabindex="-1"></a>                inst<span class="op">-&gt;</span>operands<span class="op">[</span>i<span class="op">]-&gt;</span>data<span class="op">.</span>local<span class="op">.</span>name<span class="op">);</span></span>
<span id="cb61-67"><a href="#cb61-67" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>var_idx <span class="op">!=</span> SIZE_MAX<span class="op">)</span> <span class="op">{</span></span>
<span id="cb61-68"><a href="#cb61-68" aria-hidden="true" tabindex="-1"></a>                inst<span class="op">-&gt;</span>operands<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> get_current_value<span class="op">(</span>ssa<span class="op">,</span> var_idx<span class="op">);</span></span>
<span id="cb61-69"><a href="#cb61-69" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb61-70"><a href="#cb61-70" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb61-71"><a href="#cb61-71" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb61-72"><a href="#cb61-72" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb61-73"><a href="#cb61-73" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Handle definitions</span></span>
<span id="cb61-74"><a href="#cb61-74" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> <span class="op">(</span>inst<span class="op">-&gt;</span>kind<span class="op">)</span> <span class="op">{</span></span>
<span id="cb61-75"><a href="#cb61-75" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> INST_ALLOCA<span class="op">:</span></span>
<span id="cb61-76"><a href="#cb61-76" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Initial definition of local variable</span></span>
<span id="cb61-77"><a href="#cb61-77" aria-hidden="true" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb61-78"><a href="#cb61-78" aria-hidden="true" tabindex="-1"></a>                <span class="dt">size_t</span> var_idx <span class="op">=</span> find_variable<span class="op">(</span>ssa<span class="op">,</span> inst<span class="op">-&gt;</span>data<span class="op">.</span>alloca<span class="op">.</span>name<span class="op">);</span></span>
<span id="cb61-79"><a href="#cb61-79" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span>var_idx <span class="op">!=</span> SIZE_MAX<span class="op">)</span> <span class="op">{</span></span>
<span id="cb61-80"><a href="#cb61-80" aria-hidden="true" tabindex="-1"></a>                    Value <span class="op">*</span>undef <span class="op">=</span> create_undef_value<span class="op">(</span>ssa<span class="op">-&gt;</span>variables<span class="op">[</span>var_idx<span class="op">].</span>type<span class="op">);</span></span>
<span id="cb61-81"><a href="#cb61-81" aria-hidden="true" tabindex="-1"></a>                    push_value<span class="op">(</span>ssa<span class="op">,</span> var_idx<span class="op">,</span> undef<span class="op">);</span></span>
<span id="cb61-82"><a href="#cb61-82" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb61-83"><a href="#cb61-83" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb61-84"><a href="#cb61-84" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span><span class="op">;</span></span>
<span id="cb61-85"><a href="#cb61-85" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb61-86"><a href="#cb61-86" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> INST_STORE<span class="op">:</span></span>
<span id="cb61-87"><a href="#cb61-87" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Assignment to variable</span></span>
<span id="cb61-88"><a href="#cb61-88" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>inst<span class="op">-&gt;</span>operands<span class="op">[</span><span class="dv">1</span><span class="op">]-&gt;</span>kind <span class="op">==</span> VALUE_LOCAL<span class="op">)</span> <span class="op">{</span></span>
<span id="cb61-89"><a href="#cb61-89" aria-hidden="true" tabindex="-1"></a>                <span class="dt">size_t</span> var_idx <span class="op">=</span> find_variable<span class="op">(</span>ssa<span class="op">,</span> </span>
<span id="cb61-90"><a href="#cb61-90" aria-hidden="true" tabindex="-1"></a>                    inst<span class="op">-&gt;</span>operands<span class="op">[</span><span class="dv">1</span><span class="op">]-&gt;</span>data<span class="op">.</span>local<span class="op">.</span>name<span class="op">);</span></span>
<span id="cb61-91"><a href="#cb61-91" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span>var_idx <span class="op">!=</span> SIZE_MAX<span class="op">)</span> <span class="op">{</span></span>
<span id="cb61-92"><a href="#cb61-92" aria-hidden="true" tabindex="-1"></a>                    push_value<span class="op">(</span>ssa<span class="op">,</span> var_idx<span class="op">,</span> inst<span class="op">-&gt;</span>operands<span class="op">[</span><span class="dv">0</span><span class="op">]);</span></span>
<span id="cb61-93"><a href="#cb61-93" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb61-94"><a href="#cb61-94" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb61-95"><a href="#cb61-95" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span><span class="op">;</span></span>
<span id="cb61-96"><a href="#cb61-96" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb61-97"><a href="#cb61-97" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> INST_LOAD<span class="op">:</span></span>
<span id="cb61-98"><a href="#cb61-98" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Load from variable</span></span>
<span id="cb61-99"><a href="#cb61-99" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>inst<span class="op">-&gt;</span>operands<span class="op">[</span><span class="dv">0</span><span class="op">]-&gt;</span>kind <span class="op">==</span> VALUE_LOCAL<span class="op">)</span> <span class="op">{</span></span>
<span id="cb61-100"><a href="#cb61-100" aria-hidden="true" tabindex="-1"></a>                <span class="dt">size_t</span> var_idx <span class="op">=</span> find_variable<span class="op">(</span>ssa<span class="op">,</span> </span>
<span id="cb61-101"><a href="#cb61-101" aria-hidden="true" tabindex="-1"></a>                    inst<span class="op">-&gt;</span>operands<span class="op">[</span><span class="dv">0</span><span class="op">]-&gt;</span>data<span class="op">.</span>local<span class="op">.</span>name<span class="op">);</span></span>
<span id="cb61-102"><a href="#cb61-102" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span>var_idx <span class="op">!=</span> SIZE_MAX<span class="op">)</span> <span class="op">{</span></span>
<span id="cb61-103"><a href="#cb61-103" aria-hidden="true" tabindex="-1"></a>                    Value <span class="op">*</span>current <span class="op">=</span> get_current_value<span class="op">(</span>ssa<span class="op">,</span> var_idx<span class="op">);</span></span>
<span id="cb61-104"><a href="#cb61-104" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb61-105"><a href="#cb61-105" aria-hidden="true" tabindex="-1"></a>                    <span class="co">// Replace load with value</span></span>
<span id="cb61-106"><a href="#cb61-106" aria-hidden="true" tabindex="-1"></a>                    replace_instruction_with_value<span class="op">(</span>inst<span class="op">,</span> current<span class="op">);</span></span>
<span id="cb61-107"><a href="#cb61-107" aria-hidden="true" tabindex="-1"></a>                    ssa<span class="op">-&gt;</span>variables_renamed<span class="op">++;</span></span>
<span id="cb61-108"><a href="#cb61-108" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb61-109"><a href="#cb61-109" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb61-110"><a href="#cb61-110" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span><span class="op">;</span></span>
<span id="cb61-111"><a href="#cb61-111" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb61-112"><a href="#cb61-112" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb61-113"><a href="#cb61-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-114"><a href="#cb61-114" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> fill_phi_operands<span class="op">(</span>SSAConstructor <span class="op">*</span>ssa<span class="op">,</span> BasicBlock <span class="op">*</span>pred<span class="op">,</span></span>
<span id="cb61-115"><a href="#cb61-115" aria-hidden="true" tabindex="-1"></a>                            BasicBlock <span class="op">*</span>succ<span class="op">)</span> <span class="op">{</span></span>
<span id="cb61-116"><a href="#cb61-116" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>Instruction <span class="op">*</span>inst <span class="op">=</span> succ<span class="op">-&gt;</span>first<span class="op">;</span> inst <span class="op">&amp;&amp;</span> inst<span class="op">-&gt;</span>kind <span class="op">==</span> INST_PHI<span class="op">;</span></span>
<span id="cb61-117"><a href="#cb61-117" aria-hidden="true" tabindex="-1"></a>         inst <span class="op">=</span> inst<span class="op">-&gt;</span>next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb61-118"><a href="#cb61-118" aria-hidden="true" tabindex="-1"></a>        <span class="dt">size_t</span> var_idx <span class="op">=</span> find_variable_by_phi<span class="op">(</span>ssa<span class="op">,</span> inst<span class="op">);</span></span>
<span id="cb61-119"><a href="#cb61-119" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>var_idx <span class="op">==</span> SIZE_MAX<span class="op">)</span> <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb61-120"><a href="#cb61-120" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb61-121"><a href="#cb61-121" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Find predecessor index</span></span>
<span id="cb61-122"><a href="#cb61-122" aria-hidden="true" tabindex="-1"></a>        <span class="dt">size_t</span> pred_idx <span class="op">=</span> SIZE_MAX<span class="op">;</span></span>
<span id="cb61-123"><a href="#cb61-123" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> inst<span class="op">-&gt;</span>data<span class="op">.</span>phi<span class="op">.</span>incoming_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb61-124"><a href="#cb61-124" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>inst<span class="op">-&gt;</span>data<span class="op">.</span>phi<span class="op">.</span>incoming_blocks<span class="op">[</span>i<span class="op">]</span> <span class="op">==</span> pred<span class="op">)</span> <span class="op">{</span></span>
<span id="cb61-125"><a href="#cb61-125" aria-hidden="true" tabindex="-1"></a>                pred_idx <span class="op">=</span> i<span class="op">;</span></span>
<span id="cb61-126"><a href="#cb61-126" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb61-127"><a href="#cb61-127" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb61-128"><a href="#cb61-128" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb61-129"><a href="#cb61-129" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb61-130"><a href="#cb61-130" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>pred_idx <span class="op">!=</span> SIZE_MAX<span class="op">)</span> <span class="op">{</span></span>
<span id="cb61-131"><a href="#cb61-131" aria-hidden="true" tabindex="-1"></a>            inst<span class="op">-&gt;</span>data<span class="op">.</span>phi<span class="op">.</span>incoming_values<span class="op">[</span>pred_idx<span class="op">]</span> <span class="op">=</span> </span>
<span id="cb61-132"><a href="#cb61-132" aria-hidden="true" tabindex="-1"></a>                get_current_value<span class="op">(</span>ssa<span class="op">,</span> var_idx<span class="op">);</span></span>
<span id="cb61-133"><a href="#cb61-133" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb61-134"><a href="#cb61-134" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb61-135"><a href="#cb61-135" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb61-136"><a href="#cb61-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-137"><a href="#cb61-137" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> Value<span class="op">*</span> get_current_value<span class="op">(</span>SSAConstructor <span class="op">*</span>ssa<span class="op">,</span> <span class="dt">size_t</span> var_idx<span class="op">)</span> <span class="op">{</span></span>
<span id="cb61-138"><a href="#cb61-138" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>ssa<span class="op">-&gt;</span>rename_stacks<span class="op">[</span>var_idx<span class="op">].</span>top <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb61-139"><a href="#cb61-139" aria-hidden="true" tabindex="-1"></a>        <span class="co">// No definition yet - create undefined value</span></span>
<span id="cb61-140"><a href="#cb61-140" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> create_undef_value<span class="op">(</span>ssa<span class="op">-&gt;</span>variables<span class="op">[</span>var_idx<span class="op">].</span>type<span class="op">);</span></span>
<span id="cb61-141"><a href="#cb61-141" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb61-142"><a href="#cb61-142" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb61-143"><a href="#cb61-143" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ssa<span class="op">-&gt;</span>rename_stacks<span class="op">[</span>var_idx<span class="op">].</span>stack<span class="op">[</span></span>
<span id="cb61-144"><a href="#cb61-144" aria-hidden="true" tabindex="-1"></a>        ssa<span class="op">-&gt;</span>rename_stacks<span class="op">[</span>var_idx<span class="op">].</span>top <span class="op">-</span> <span class="dv">1</span><span class="op">];</span></span>
<span id="cb61-145"><a href="#cb61-145" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb61-146"><a href="#cb61-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-147"><a href="#cb61-147" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> push_value<span class="op">(</span>SSAConstructor <span class="op">*</span>ssa<span class="op">,</span> <span class="dt">size_t</span> var_idx<span class="op">,</span> Value <span class="op">*</span>value<span class="op">)</span> <span class="op">{</span></span>
<span id="cb61-148"><a href="#cb61-148" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> <span class="op">*</span>top <span class="op">=</span> <span class="op">&amp;</span>ssa<span class="op">-&gt;</span>rename_stacks<span class="op">[</span>var_idx<span class="op">].</span>top<span class="op">;</span></span>
<span id="cb61-149"><a href="#cb61-149" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> <span class="op">*</span>cap <span class="op">=</span> <span class="op">&amp;</span>ssa<span class="op">-&gt;</span>rename_stacks<span class="op">[</span>var_idx<span class="op">].</span>capacity<span class="op">;</span></span>
<span id="cb61-150"><a href="#cb61-150" aria-hidden="true" tabindex="-1"></a>    Value <span class="op">***</span>stack <span class="op">=</span> <span class="op">&amp;</span>ssa<span class="op">-&gt;</span>rename_stacks<span class="op">[</span>var_idx<span class="op">].</span>stack<span class="op">;</span></span>
<span id="cb61-151"><a href="#cb61-151" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb61-152"><a href="#cb61-152" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(*</span>top <span class="op">&gt;=</span> <span class="op">*</span>cap<span class="op">)</span> <span class="op">{</span></span>
<span id="cb61-153"><a href="#cb61-153" aria-hidden="true" tabindex="-1"></a>        <span class="op">*</span>cap <span class="op">*=</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb61-154"><a href="#cb61-154" aria-hidden="true" tabindex="-1"></a>        <span class="op">*</span>stack <span class="op">=</span> realloc<span class="op">(*</span>stack<span class="op">,</span> <span class="op">*</span>cap <span class="op">*</span> <span class="kw">sizeof</span><span class="op">(</span>Value<span class="op">*));</span></span>
<span id="cb61-155"><a href="#cb61-155" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb61-156"><a href="#cb61-156" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb61-157"><a href="#cb61-157" aria-hidden="true" tabindex="-1"></a>    <span class="op">(*</span>stack<span class="op">)[(*</span>top<span class="op">)++]</span> <span class="op">=</span> value<span class="op">;</span></span>
<span id="cb61-158"><a href="#cb61-158" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>5.6 Memory SSA Extensions</h2>
<p>Extending SSA to memory operations requires special handling:</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> MemorySSA <span class="op">{</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Memory version tracking</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>        Value <span class="op">*</span>current_version<span class="op">;</span></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>        Instruction <span class="op">**</span>def_chain<span class="op">;</span></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>        <span class="dt">size_t</span> def_count<span class="op">;</span></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> memory<span class="op">;</span></span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Alias information</span></span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>    AliasAnalysis <span class="op">*</span>alias<span class="op">;</span></span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> MemorySSA<span class="op">;</span></span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> build_memory_ssa<span class="op">(</span>SSAConstructor <span class="op">*</span>ssa<span class="op">)</span> <span class="op">{</span></span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a>    MemorySSA mem_ssa <span class="op">=</span> <span class="op">{</span><span class="dv">0</span><span class="op">};</span></span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a>    mem_ssa<span class="op">.</span>alias <span class="op">=</span> create_alias_analysis<span class="op">(</span>ssa<span class="op">-&gt;</span>cfg<span class="op">);</span></span>
<span id="cb62-16"><a href="#cb62-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb62-17"><a href="#cb62-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Insert memory -nodes</span></span>
<span id="cb62-18"><a href="#cb62-18" aria-hidden="true" tabindex="-1"></a>    insert_memory_phi_nodes<span class="op">(</span>ssa<span class="op">,</span> <span class="op">&amp;</span>mem_ssa<span class="op">);</span></span>
<span id="cb62-19"><a href="#cb62-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb62-20"><a href="#cb62-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Rename memory operations</span></span>
<span id="cb62-21"><a href="#cb62-21" aria-hidden="true" tabindex="-1"></a>    rename_memory_operations<span class="op">(</span>ssa<span class="op">,</span> <span class="op">&amp;</span>mem_ssa<span class="op">);</span></span>
<span id="cb62-22"><a href="#cb62-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb62-23"><a href="#cb62-23" aria-hidden="true" tabindex="-1"></a>    free_alias_analysis<span class="op">(</span>mem_ssa<span class="op">.</span>alias<span class="op">);</span></span>
<span id="cb62-24"><a href="#cb62-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb62-25"><a href="#cb62-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-26"><a href="#cb62-26" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> insert_memory_phi_nodes<span class="op">(</span>SSAConstructor <span class="op">*</span>ssa<span class="op">,</span> MemorySSA <span class="op">*</span>mem_ssa<span class="op">)</span> <span class="op">{</span></span>
<span id="cb62-27"><a href="#cb62-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Collect blocks with memory definitions (stores)</span></span>
<span id="cb62-28"><a href="#cb62-28" aria-hidden="true" tabindex="-1"></a>    BlockSet <span class="op">*</span>mem_defs <span class="op">=</span> blockset_new<span class="op">(</span>ssa<span class="op">-&gt;</span>cfg<span class="op">-&gt;</span>block_count<span class="op">);</span></span>
<span id="cb62-29"><a href="#cb62-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb62-30"><a href="#cb62-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> ssa<span class="op">-&gt;</span>cfg<span class="op">-&gt;</span>block_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb62-31"><a href="#cb62-31" aria-hidden="true" tabindex="-1"></a>        BasicBlock <span class="op">*</span>block <span class="op">=</span> ssa<span class="op">-&gt;</span>cfg<span class="op">-&gt;</span>blocks<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb62-32"><a href="#cb62-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span>Instruction <span class="op">*</span>inst <span class="op">=</span> block<span class="op">-&gt;</span>first<span class="op">;</span> inst<span class="op">;</span> inst <span class="op">=</span> inst<span class="op">-&gt;</span>next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb62-33"><a href="#cb62-33" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>is_memory_def<span class="op">(</span>inst<span class="op">))</span> <span class="op">{</span></span>
<span id="cb62-34"><a href="#cb62-34" aria-hidden="true" tabindex="-1"></a>                blockset_add<span class="op">(</span>mem_defs<span class="op">,</span> block<span class="op">-&gt;</span>id<span class="op">);</span></span>
<span id="cb62-35"><a href="#cb62-35" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb62-36"><a href="#cb62-36" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb62-37"><a href="#cb62-37" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb62-38"><a href="#cb62-38" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb62-39"><a href="#cb62-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb62-40"><a href="#cb62-40" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Insert -nodes at dominance frontiers</span></span>
<span id="cb62-41"><a href="#cb62-41" aria-hidden="true" tabindex="-1"></a>    BlockSet <span class="op">*</span>worklist <span class="op">=</span> blockset_copy<span class="op">(</span>mem_defs<span class="op">);</span></span>
<span id="cb62-42"><a href="#cb62-42" aria-hidden="true" tabindex="-1"></a>    BlockSet <span class="op">*</span>has_phi <span class="op">=</span> blockset_new<span class="op">(</span>ssa<span class="op">-&gt;</span>cfg<span class="op">-&gt;</span>block_count<span class="op">);</span></span>
<span id="cb62-43"><a href="#cb62-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb62-44"><a href="#cb62-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(!</span>blockset_empty<span class="op">(</span>worklist<span class="op">))</span> <span class="op">{</span></span>
<span id="cb62-45"><a href="#cb62-45" aria-hidden="true" tabindex="-1"></a>        BasicBlock <span class="op">*</span>block <span class="op">=</span> blockset_pop<span class="op">(</span>worklist<span class="op">);</span></span>
<span id="cb62-46"><a href="#cb62-46" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb62-47"><a href="#cb62-47" aria-hidden="true" tabindex="-1"></a>        BitSetIterator it <span class="op">=</span> bitset_iterator<span class="op">(</span>block<span class="op">-&gt;</span>df<span class="op">);</span></span>
<span id="cb62-48"><a href="#cb62-48" aria-hidden="true" tabindex="-1"></a>        <span class="dt">size_t</span> df_block_id<span class="op">;</span></span>
<span id="cb62-49"><a href="#cb62-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> <span class="op">(</span>bitset_next<span class="op">(&amp;</span>it<span class="op">,</span> <span class="op">&amp;</span>df_block_id<span class="op">))</span> <span class="op">{</span></span>
<span id="cb62-50"><a href="#cb62-50" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(!</span>blockset_contains<span class="op">(</span>has_phi<span class="op">,</span> df_block_id<span class="op">))</span> <span class="op">{</span></span>
<span id="cb62-51"><a href="#cb62-51" aria-hidden="true" tabindex="-1"></a>                BasicBlock <span class="op">*</span>df_block <span class="op">=</span> ssa<span class="op">-&gt;</span>cfg<span class="op">-&gt;</span>blocks<span class="op">[</span>df_block_id<span class="op">];</span></span>
<span id="cb62-52"><a href="#cb62-52" aria-hidden="true" tabindex="-1"></a>                insert_memory_phi<span class="op">(</span>ssa<span class="op">,</span> df_block<span class="op">);</span></span>
<span id="cb62-53"><a href="#cb62-53" aria-hidden="true" tabindex="-1"></a>                blockset_add<span class="op">(</span>has_phi<span class="op">,</span> df_block_id<span class="op">);</span></span>
<span id="cb62-54"><a href="#cb62-54" aria-hidden="true" tabindex="-1"></a>                blockset_add<span class="op">(</span>worklist<span class="op">,</span> df_block_id<span class="op">);</span></span>
<span id="cb62-55"><a href="#cb62-55" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb62-56"><a href="#cb62-56" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb62-57"><a href="#cb62-57" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb62-58"><a href="#cb62-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb62-59"><a href="#cb62-59" aria-hidden="true" tabindex="-1"></a>    blockset_free<span class="op">(</span>mem_defs<span class="op">);</span></span>
<span id="cb62-60"><a href="#cb62-60" aria-hidden="true" tabindex="-1"></a>    blockset_free<span class="op">(</span>worklist<span class="op">);</span></span>
<span id="cb62-61"><a href="#cb62-61" aria-hidden="true" tabindex="-1"></a>    blockset_free<span class="op">(</span>has_phi<span class="op">);</span></span>
<span id="cb62-62"><a href="#cb62-62" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb62-63"><a href="#cb62-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-64"><a href="#cb62-64" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">bool</span> is_memory_def<span class="op">(</span>Instruction <span class="op">*</span>inst<span class="op">)</span> <span class="op">{</span></span>
<span id="cb62-65"><a href="#cb62-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> <span class="op">(</span>inst<span class="op">-&gt;</span>kind<span class="op">)</span> <span class="op">{</span></span>
<span id="cb62-66"><a href="#cb62-66" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> INST_STORE<span class="op">:</span></span>
<span id="cb62-67"><a href="#cb62-67" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> INST_STORE_FIELD<span class="op">:</span></span>
<span id="cb62-68"><a href="#cb62-68" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> INST_STORE_ELEMENT<span class="op">:</span></span>
<span id="cb62-69"><a href="#cb62-69" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> INST_CALL<span class="op">:</span>  <span class="co">// Conservatively assume calls modify memory</span></span>
<span id="cb62-70"><a href="#cb62-70" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb62-71"><a href="#cb62-71" aria-hidden="true" tabindex="-1"></a>        <span class="cf">default</span><span class="op">:</span></span>
<span id="cb62-72"><a href="#cb62-72" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb62-73"><a href="#cb62-73" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb62-74"><a href="#cb62-74" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb62-75"><a href="#cb62-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-76"><a href="#cb62-76" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> insert_memory_phi<span class="op">(</span>SSAConstructor <span class="op">*</span>ssa<span class="op">,</span> BasicBlock <span class="op">*</span>block<span class="op">)</span> <span class="op">{</span></span>
<span id="cb62-77"><a href="#cb62-77" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Create memory -node</span></span>
<span id="cb62-78"><a href="#cb62-78" aria-hidden="true" tabindex="-1"></a>    Instruction <span class="op">*</span>phi <span class="op">=</span> calloc<span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>Instruction<span class="op">));</span></span>
<span id="cb62-79"><a href="#cb62-79" aria-hidden="true" tabindex="-1"></a>    phi<span class="op">-&gt;</span>kind <span class="op">=</span> INST_MEMORY_PHI<span class="op">;</span></span>
<span id="cb62-80"><a href="#cb62-80" aria-hidden="true" tabindex="-1"></a>    phi<span class="op">-&gt;</span>block <span class="op">=</span> block<span class="op">;</span></span>
<span id="cb62-81"><a href="#cb62-81" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb62-82"><a href="#cb62-82" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Create result representing new memory state</span></span>
<span id="cb62-83"><a href="#cb62-83" aria-hidden="true" tabindex="-1"></a>    phi<span class="op">-&gt;</span>result <span class="op">=</span> calloc<span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>Value<span class="op">));</span></span>
<span id="cb62-84"><a href="#cb62-84" aria-hidden="true" tabindex="-1"></a>    phi<span class="op">-&gt;</span>result<span class="op">-&gt;</span>kind <span class="op">=</span> VALUE_MEMORY<span class="op">;</span></span>
<span id="cb62-85"><a href="#cb62-85" aria-hidden="true" tabindex="-1"></a>    phi<span class="op">-&gt;</span>result<span class="op">-&gt;</span>type <span class="op">=</span> get_memory_type<span class="op">();</span></span>
<span id="cb62-86"><a href="#cb62-86" aria-hidden="true" tabindex="-1"></a>    phi<span class="op">-&gt;</span>result<span class="op">-&gt;</span>def <span class="op">=</span> phi<span class="op">;</span></span>
<span id="cb62-87"><a href="#cb62-87" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb62-88"><a href="#cb62-88" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Initialize incoming arrays</span></span>
<span id="cb62-89"><a href="#cb62-89" aria-hidden="true" tabindex="-1"></a>    phi<span class="op">-&gt;</span>data<span class="op">.</span>phi<span class="op">.</span>incoming_count <span class="op">=</span> block<span class="op">-&gt;</span>predecessor_count<span class="op">;</span></span>
<span id="cb62-90"><a href="#cb62-90" aria-hidden="true" tabindex="-1"></a>    phi<span class="op">-&gt;</span>data<span class="op">.</span>phi<span class="op">.</span>incoming_values <span class="op">=</span> calloc<span class="op">(</span>block<span class="op">-&gt;</span>predecessor_count<span class="op">,</span></span>
<span id="cb62-91"><a href="#cb62-91" aria-hidden="true" tabindex="-1"></a>                                          <span class="kw">sizeof</span><span class="op">(</span>Value<span class="op">*));</span></span>
<span id="cb62-92"><a href="#cb62-92" aria-hidden="true" tabindex="-1"></a>    phi<span class="op">-&gt;</span>data<span class="op">.</span>phi<span class="op">.</span>incoming_blocks <span class="op">=</span> calloc<span class="op">(</span>block<span class="op">-&gt;</span>predecessor_count<span class="op">,</span></span>
<span id="cb62-93"><a href="#cb62-93" aria-hidden="true" tabindex="-1"></a>                                          <span class="kw">sizeof</span><span class="op">(</span>BasicBlock<span class="op">*));</span></span>
<span id="cb62-94"><a href="#cb62-94" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb62-95"><a href="#cb62-95" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> block<span class="op">-&gt;</span>predecessor_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb62-96"><a href="#cb62-96" aria-hidden="true" tabindex="-1"></a>        phi<span class="op">-&gt;</span>data<span class="op">.</span>phi<span class="op">.</span>incoming_blocks<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> block<span class="op">-&gt;</span>predecessors<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb62-97"><a href="#cb62-97" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb62-98"><a href="#cb62-98" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb62-99"><a href="#cb62-99" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Insert after regular -nodes</span></span>
<span id="cb62-100"><a href="#cb62-100" aria-hidden="true" tabindex="-1"></a>    Instruction <span class="op">*</span>insert_after <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb62-101"><a href="#cb62-101" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>Instruction <span class="op">*</span>inst <span class="op">=</span> block<span class="op">-&gt;</span>first<span class="op">;</span> inst<span class="op">;</span> inst <span class="op">=</span> inst<span class="op">-&gt;</span>next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb62-102"><a href="#cb62-102" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>inst<span class="op">-&gt;</span>kind <span class="op">!=</span> INST_PHI<span class="op">)</span> <span class="cf">break</span><span class="op">;</span></span>
<span id="cb62-103"><a href="#cb62-103" aria-hidden="true" tabindex="-1"></a>        insert_after <span class="op">=</span> inst<span class="op">;</span></span>
<span id="cb62-104"><a href="#cb62-104" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb62-105"><a href="#cb62-105" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb62-106"><a href="#cb62-106" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>insert_after<span class="op">)</span> <span class="op">{</span></span>
<span id="cb62-107"><a href="#cb62-107" aria-hidden="true" tabindex="-1"></a>        phi<span class="op">-&gt;</span>next <span class="op">=</span> insert_after<span class="op">-&gt;</span>next<span class="op">;</span></span>
<span id="cb62-108"><a href="#cb62-108" aria-hidden="true" tabindex="-1"></a>        phi<span class="op">-&gt;</span>prev <span class="op">=</span> insert_after<span class="op">;</span></span>
<span id="cb62-109"><a href="#cb62-109" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>insert_after<span class="op">-&gt;</span>next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb62-110"><a href="#cb62-110" aria-hidden="true" tabindex="-1"></a>            insert_after<span class="op">-&gt;</span>next<span class="op">-&gt;</span>prev <span class="op">=</span> phi<span class="op">;</span></span>
<span id="cb62-111"><a href="#cb62-111" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb62-112"><a href="#cb62-112" aria-hidden="true" tabindex="-1"></a>            block<span class="op">-&gt;</span>last <span class="op">=</span> phi<span class="op">;</span></span>
<span id="cb62-113"><a href="#cb62-113" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb62-114"><a href="#cb62-114" aria-hidden="true" tabindex="-1"></a>        insert_after<span class="op">-&gt;</span>next <span class="op">=</span> phi<span class="op">;</span></span>
<span id="cb62-115"><a href="#cb62-115" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb62-116"><a href="#cb62-116" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Insert at beginning</span></span>
<span id="cb62-117"><a href="#cb62-117" aria-hidden="true" tabindex="-1"></a>        phi<span class="op">-&gt;</span>next <span class="op">=</span> block<span class="op">-&gt;</span>first<span class="op">;</span></span>
<span id="cb62-118"><a href="#cb62-118" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>block<span class="op">-&gt;</span>first<span class="op">)</span> <span class="op">{</span></span>
<span id="cb62-119"><a href="#cb62-119" aria-hidden="true" tabindex="-1"></a>            block<span class="op">-&gt;</span>first<span class="op">-&gt;</span>prev <span class="op">=</span> phi<span class="op">;</span></span>
<span id="cb62-120"><a href="#cb62-120" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb62-121"><a href="#cb62-121" aria-hidden="true" tabindex="-1"></a>        block<span class="op">-&gt;</span>first <span class="op">=</span> phi<span class="op">;</span></span>
<span id="cb62-122"><a href="#cb62-122" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(!</span>block<span class="op">-&gt;</span>last<span class="op">)</span> <span class="op">{</span></span>
<span id="cb62-123"><a href="#cb62-123" aria-hidden="true" tabindex="-1"></a>            block<span class="op">-&gt;</span>last <span class="op">=</span> phi<span class="op">;</span></span>
<span id="cb62-124"><a href="#cb62-124" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb62-125"><a href="#cb62-125" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb62-126"><a href="#cb62-126" aria-hidden="true" tabindex="-1"></a>    block<span class="op">-&gt;</span>instruction_count<span class="op">++;</span></span>
<span id="cb62-127"><a href="#cb62-127" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>5.7 SSA Destruction</h2>
<p>For code generation, SSA form must eventually be deconstructed:</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> SSADestructor <span class="op">{</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>    CFG <span class="op">*</span>cfg<span class="op">;</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Copy instructions to insert</span></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>        BasicBlock <span class="op">*</span>block<span class="op">;</span></span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>        Value <span class="op">*</span>src<span class="op">;</span></span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>        Value <span class="op">*</span>dest<span class="op">;</span></span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="op">*</span>copies<span class="op">;</span></span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> copy_count<span class="op">;</span></span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> copy_capacity<span class="op">;</span></span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> SSADestructor<span class="op">;</span></span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> destruct_ssa<span class="op">(</span>CFG <span class="op">*</span>cfg<span class="op">)</span> <span class="op">{</span></span>
<span id="cb63-15"><a href="#cb63-15" aria-hidden="true" tabindex="-1"></a>    SSADestructor destructor <span class="op">=</span> <span class="op">{</span><span class="dv">0</span><span class="op">};</span></span>
<span id="cb63-16"><a href="#cb63-16" aria-hidden="true" tabindex="-1"></a>    destructor<span class="op">.</span>cfg <span class="op">=</span> cfg<span class="op">;</span></span>
<span id="cb63-17"><a href="#cb63-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-18"><a href="#cb63-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Replace -nodes with copies</span></span>
<span id="cb63-19"><a href="#cb63-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> cfg<span class="op">-&gt;</span>block_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb63-20"><a href="#cb63-20" aria-hidden="true" tabindex="-1"></a>        replace_phi_nodes<span class="op">(&amp;</span>destructor<span class="op">,</span> cfg<span class="op">-&gt;</span>blocks<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb63-21"><a href="#cb63-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb63-22"><a href="#cb63-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-23"><a href="#cb63-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Insert copy instructions</span></span>
<span id="cb63-24"><a href="#cb63-24" aria-hidden="true" tabindex="-1"></a>    insert_copies<span class="op">(&amp;</span>destructor<span class="op">);</span></span>
<span id="cb63-25"><a href="#cb63-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-26"><a href="#cb63-26" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Coalesce copies where possible</span></span>
<span id="cb63-27"><a href="#cb63-27" aria-hidden="true" tabindex="-1"></a>    coalesce_copies<span class="op">(&amp;</span>destructor<span class="op">);</span></span>
<span id="cb63-28"><a href="#cb63-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-29"><a href="#cb63-29" aria-hidden="true" tabindex="-1"></a>    free<span class="op">(</span>destructor<span class="op">.</span>copies<span class="op">);</span></span>
<span id="cb63-30"><a href="#cb63-30" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb63-31"><a href="#cb63-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-32"><a href="#cb63-32" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> replace_phi_nodes<span class="op">(</span>SSADestructor <span class="op">*</span>dest<span class="op">,</span> BasicBlock <span class="op">*</span>block<span class="op">)</span> <span class="op">{</span></span>
<span id="cb63-33"><a href="#cb63-33" aria-hidden="true" tabindex="-1"></a>    Instruction <span class="op">*</span>inst <span class="op">=</span> block<span class="op">-&gt;</span>first<span class="op">;</span></span>
<span id="cb63-34"><a href="#cb63-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span>inst <span class="op">&amp;&amp;</span> inst<span class="op">-&gt;</span>kind <span class="op">==</span> INST_PHI<span class="op">)</span> <span class="op">{</span></span>
<span id="cb63-35"><a href="#cb63-35" aria-hidden="true" tabindex="-1"></a>        Instruction <span class="op">*</span>next <span class="op">=</span> inst<span class="op">-&gt;</span>next<span class="op">;</span></span>
<span id="cb63-36"><a href="#cb63-36" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb63-37"><a href="#cb63-37" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Schedule copies from predecessors</span></span>
<span id="cb63-38"><a href="#cb63-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> inst<span class="op">-&gt;</span>data<span class="op">.</span>phi<span class="op">.</span>incoming_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb63-39"><a href="#cb63-39" aria-hidden="true" tabindex="-1"></a>            BasicBlock <span class="op">*</span>pred <span class="op">=</span> inst<span class="op">-&gt;</span>data<span class="op">.</span>phi<span class="op">.</span>incoming_blocks<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb63-40"><a href="#cb63-40" aria-hidden="true" tabindex="-1"></a>            Value <span class="op">*</span>src <span class="op">=</span> inst<span class="op">-&gt;</span>data<span class="op">.</span>phi<span class="op">.</span>incoming_values<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb63-41"><a href="#cb63-41" aria-hidden="true" tabindex="-1"></a>            Value <span class="op">*</span>dst <span class="op">=</span> inst<span class="op">-&gt;</span>result<span class="op">;</span></span>
<span id="cb63-42"><a href="#cb63-42" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb63-43"><a href="#cb63-43" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>src <span class="op">!=</span> dst<span class="op">)</span> <span class="op">{</span>  <span class="co">// Avoid self-copies</span></span>
<span id="cb63-44"><a href="#cb63-44" aria-hidden="true" tabindex="-1"></a>                add_copy<span class="op">(</span>dest<span class="op">,</span> pred<span class="op">,</span> src<span class="op">,</span> dst<span class="op">);</span></span>
<span id="cb63-45"><a href="#cb63-45" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb63-46"><a href="#cb63-46" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb63-47"><a href="#cb63-47" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb63-48"><a href="#cb63-48" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Remove -node</span></span>
<span id="cb63-49"><a href="#cb63-49" aria-hidden="true" tabindex="-1"></a>        remove_instruction<span class="op">(</span>inst<span class="op">);</span></span>
<span id="cb63-50"><a href="#cb63-50" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb63-51"><a href="#cb63-51" aria-hidden="true" tabindex="-1"></a>        inst <span class="op">=</span> next<span class="op">;</span></span>
<span id="cb63-52"><a href="#cb63-52" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb63-53"><a href="#cb63-53" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb63-54"><a href="#cb63-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-55"><a href="#cb63-55" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> add_copy<span class="op">(</span>SSADestructor <span class="op">*</span>dest<span class="op">,</span> BasicBlock <span class="op">*</span>block<span class="op">,</span></span>
<span id="cb63-56"><a href="#cb63-56" aria-hidden="true" tabindex="-1"></a>                    Value <span class="op">*</span>src<span class="op">,</span> Value <span class="op">*</span>dest_val<span class="op">)</span> <span class="op">{</span></span>
<span id="cb63-57"><a href="#cb63-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>dest<span class="op">-&gt;</span>copy_count <span class="op">&gt;=</span> dest<span class="op">-&gt;</span>copy_capacity<span class="op">)</span> <span class="op">{</span></span>
<span id="cb63-58"><a href="#cb63-58" aria-hidden="true" tabindex="-1"></a>        dest<span class="op">-&gt;</span>copy_capacity <span class="op">=</span> dest<span class="op">-&gt;</span>copy_capacity <span class="op">*</span> <span class="dv">2</span> <span class="op">+</span> <span class="dv">16</span><span class="op">;</span></span>
<span id="cb63-59"><a href="#cb63-59" aria-hidden="true" tabindex="-1"></a>        dest<span class="op">-&gt;</span>copies <span class="op">=</span> realloc<span class="op">(</span>dest<span class="op">-&gt;</span>copies<span class="op">,</span></span>
<span id="cb63-60"><a href="#cb63-60" aria-hidden="true" tabindex="-1"></a>            dest<span class="op">-&gt;</span>copy_capacity <span class="op">*</span> <span class="kw">sizeof</span><span class="op">(</span>dest<span class="op">-&gt;</span>copies<span class="op">[</span><span class="dv">0</span><span class="op">]));</span></span>
<span id="cb63-61"><a href="#cb63-61" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb63-62"><a href="#cb63-62" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-63"><a href="#cb63-63" aria-hidden="true" tabindex="-1"></a>    dest<span class="op">-&gt;</span>copies<span class="op">[</span>dest<span class="op">-&gt;</span>copy_count<span class="op">].</span>block <span class="op">=</span> block<span class="op">;</span></span>
<span id="cb63-64"><a href="#cb63-64" aria-hidden="true" tabindex="-1"></a>    dest<span class="op">-&gt;</span>copies<span class="op">[</span>dest<span class="op">-&gt;</span>copy_count<span class="op">].</span>src <span class="op">=</span> src<span class="op">;</span></span>
<span id="cb63-65"><a href="#cb63-65" aria-hidden="true" tabindex="-1"></a>    dest<span class="op">-&gt;</span>copies<span class="op">[</span>dest<span class="op">-&gt;</span>copy_count<span class="op">].</span>dest <span class="op">=</span> dest_val<span class="op">;</span></span>
<span id="cb63-66"><a href="#cb63-66" aria-hidden="true" tabindex="-1"></a>    dest<span class="op">-&gt;</span>copy_count<span class="op">++;</span></span>
<span id="cb63-67"><a href="#cb63-67" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb63-68"><a href="#cb63-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-69"><a href="#cb63-69" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> insert_copies<span class="op">(</span>SSADestructor <span class="op">*</span>dest<span class="op">)</span> <span class="op">{</span></span>
<span id="cb63-70"><a href="#cb63-70" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Group copies by block</span></span>
<span id="cb63-71"><a href="#cb63-71" aria-hidden="true" tabindex="-1"></a>    qsort<span class="op">(</span>dest<span class="op">-&gt;</span>copies<span class="op">,</span> dest<span class="op">-&gt;</span>copy_count<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>dest<span class="op">-&gt;</span>copies<span class="op">[</span><span class="dv">0</span><span class="op">]),</span></span>
<span id="cb63-72"><a href="#cb63-72" aria-hidden="true" tabindex="-1"></a>          compare_copies_by_block<span class="op">);</span></span>
<span id="cb63-73"><a href="#cb63-73" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-74"><a href="#cb63-74" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Insert parallel copies at end of each predecessor</span></span>
<span id="cb63-75"><a href="#cb63-75" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb63-76"><a href="#cb63-76" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span>i <span class="op">&lt;</span> dest<span class="op">-&gt;</span>copy_count<span class="op">)</span> <span class="op">{</span></span>
<span id="cb63-77"><a href="#cb63-77" aria-hidden="true" tabindex="-1"></a>        BasicBlock <span class="op">*</span>block <span class="op">=</span> dest<span class="op">-&gt;</span>copies<span class="op">[</span>i<span class="op">].</span>block<span class="op">;</span></span>
<span id="cb63-78"><a href="#cb63-78" aria-hidden="true" tabindex="-1"></a>        <span class="dt">size_t</span> start <span class="op">=</span> i<span class="op">;</span></span>
<span id="cb63-79"><a href="#cb63-79" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb63-80"><a href="#cb63-80" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Find all copies for this block</span></span>
<span id="cb63-81"><a href="#cb63-81" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> <span class="op">(</span>i <span class="op">&lt;</span> dest<span class="op">-&gt;</span>copy_count <span class="op">&amp;&amp;</span> dest<span class="op">-&gt;</span>copies<span class="op">[</span>i<span class="op">].</span>block <span class="op">==</span> block<span class="op">)</span> <span class="op">{</span></span>
<span id="cb63-82"><a href="#cb63-82" aria-hidden="true" tabindex="-1"></a>            i<span class="op">++;</span></span>
<span id="cb63-83"><a href="#cb63-83" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb63-84"><a href="#cb63-84" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb63-85"><a href="#cb63-85" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Insert parallel copy</span></span>
<span id="cb63-86"><a href="#cb63-86" aria-hidden="true" tabindex="-1"></a>        insert_parallel_copy<span class="op">(</span>block<span class="op">,</span> <span class="op">&amp;</span>dest<span class="op">-&gt;</span>copies<span class="op">[</span>start<span class="op">],</span> i <span class="op">-</span> start<span class="op">);</span></span>
<span id="cb63-87"><a href="#cb63-87" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb63-88"><a href="#cb63-88" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb63-89"><a href="#cb63-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-90"><a href="#cb63-90" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> insert_parallel_copy<span class="op">(</span>BasicBlock <span class="op">*</span>block<span class="op">,</span> </span>
<span id="cb63-91"><a href="#cb63-91" aria-hidden="true" tabindex="-1"></a>                               <span class="kw">struct</span> <span class="op">{</span> BasicBlock <span class="op">*</span>block<span class="op">;</span> Value <span class="op">*</span>src<span class="op">;</span> Value <span class="op">*</span>dest<span class="op">;</span> <span class="op">}</span> <span class="op">*</span>copies<span class="op">,</span></span>
<span id="cb63-92"><a href="#cb63-92" aria-hidden="true" tabindex="-1"></a>                               <span class="dt">size_t</span> count<span class="op">)</span> <span class="op">{</span></span>
<span id="cb63-93"><a href="#cb63-93" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Handle simple cases</span></span>
<span id="cb63-94"><a href="#cb63-94" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>count <span class="op">==</span> <span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb63-95"><a href="#cb63-95" aria-hidden="true" tabindex="-1"></a>        emit_copy_before_terminator<span class="op">(</span>block<span class="op">,</span> copies<span class="op">[</span><span class="dv">0</span><span class="op">].</span>src<span class="op">,</span> copies<span class="op">[</span><span class="dv">0</span><span class="op">].</span>dest<span class="op">);</span></span>
<span id="cb63-96"><a href="#cb63-96" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span><span class="op">;</span></span>
<span id="cb63-97"><a href="#cb63-97" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb63-98"><a href="#cb63-98" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-99"><a href="#cb63-99" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Detect cycles in parallel assignment</span></span>
<span id="cb63-100"><a href="#cb63-100" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> <span class="op">*</span>visited <span class="op">=</span> calloc<span class="op">(</span>count<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span><span class="dt">bool</span><span class="op">));</span></span>
<span id="cb63-101"><a href="#cb63-101" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> <span class="op">*</span>in_cycle <span class="op">=</span> calloc<span class="op">(</span>count<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span><span class="dt">bool</span><span class="op">));</span></span>
<span id="cb63-102"><a href="#cb63-102" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-103"><a href="#cb63-103" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb63-104"><a href="#cb63-104" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(!</span>visited<span class="op">[</span>i<span class="op">])</span> <span class="op">{</span></span>
<span id="cb63-105"><a href="#cb63-105" aria-hidden="true" tabindex="-1"></a>            detect_copy_cycle<span class="op">(</span>copies<span class="op">,</span> count<span class="op">,</span> i<span class="op">,</span> visited<span class="op">,</span> in_cycle<span class="op">);</span></span>
<span id="cb63-106"><a href="#cb63-106" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb63-107"><a href="#cb63-107" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb63-108"><a href="#cb63-108" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-109"><a href="#cb63-109" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Insert copies, handling cycles</span></span>
<span id="cb63-110"><a href="#cb63-110" aria-hidden="true" tabindex="-1"></a>    Value <span class="op">*</span>temp <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb63-111"><a href="#cb63-111" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb63-112"><a href="#cb63-112" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>in_cycle<span class="op">[</span>i<span class="op">]</span> <span class="op">&amp;&amp;</span> <span class="op">!</span>temp<span class="op">)</span> <span class="op">{</span></span>
<span id="cb63-113"><a href="#cb63-113" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Break cycle with temporary</span></span>
<span id="cb63-114"><a href="#cb63-114" aria-hidden="true" tabindex="-1"></a>            temp <span class="op">=</span> create_temp_value<span class="op">(</span>copies<span class="op">[</span>i<span class="op">].</span>src<span class="op">-&gt;</span>type<span class="op">);</span></span>
<span id="cb63-115"><a href="#cb63-115" aria-hidden="true" tabindex="-1"></a>            emit_copy_before_terminator<span class="op">(</span>block<span class="op">,</span> copies<span class="op">[</span>i<span class="op">].</span>src<span class="op">,</span> temp<span class="op">);</span></span>
<span id="cb63-116"><a href="#cb63-116" aria-hidden="true" tabindex="-1"></a>            copies<span class="op">[</span>i<span class="op">].</span>src <span class="op">=</span> temp<span class="op">;</span></span>
<span id="cb63-117"><a href="#cb63-117" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb63-118"><a href="#cb63-118" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb63-119"><a href="#cb63-119" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-120"><a href="#cb63-120" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Now insert all copies</span></span>
<span id="cb63-121"><a href="#cb63-121" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb63-122"><a href="#cb63-122" aria-hidden="true" tabindex="-1"></a>        emit_copy_before_terminator<span class="op">(</span>block<span class="op">,</span> copies<span class="op">[</span>i<span class="op">].</span>src<span class="op">,</span> copies<span class="op">[</span>i<span class="op">].</span>dest<span class="op">);</span></span>
<span id="cb63-123"><a href="#cb63-123" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb63-124"><a href="#cb63-124" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-125"><a href="#cb63-125" aria-hidden="true" tabindex="-1"></a>    free<span class="op">(</span>visited<span class="op">);</span></span>
<span id="cb63-126"><a href="#cb63-126" aria-hidden="true" tabindex="-1"></a>    free<span class="op">(</span>in_cycle<span class="op">);</span></span>
<span id="cb63-127"><a href="#cb63-127" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>5.8 SSA Validation</h2>
<p>After construction, we validate the SSA properties:</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> SSAValidator <span class="op">{</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>    CFG <span class="op">*</span>cfg<span class="op">;</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> has_errors<span class="op">;</span></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>    ErrorList <span class="op">*</span>errors<span class="op">;</span></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> SSAValidator<span class="op">;</span></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> validate_ssa<span class="op">(</span>CFG <span class="op">*</span>cfg<span class="op">)</span> <span class="op">{</span></span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>    SSAValidator validator <span class="op">=</span> <span class="op">{</span><span class="dv">0</span><span class="op">};</span></span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>    validator<span class="op">.</span>cfg <span class="op">=</span> cfg<span class="op">;</span></span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>    validator<span class="op">.</span>errors <span class="op">=</span> create_error_list<span class="op">();</span></span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check each block</span></span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> cfg<span class="op">-&gt;</span>block_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a>        validate_block_ssa<span class="op">(&amp;</span>validator<span class="op">,</span> cfg<span class="op">-&gt;</span>blocks<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb64-15"><a href="#cb64-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb64-16"><a href="#cb64-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb64-17"><a href="#cb64-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check dominance properties</span></span>
<span id="cb64-18"><a href="#cb64-18" aria-hidden="true" tabindex="-1"></a>    validate_dominance_properties<span class="op">(&amp;</span>validator<span class="op">);</span></span>
<span id="cb64-19"><a href="#cb64-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb64-20"><a href="#cb64-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>validator<span class="op">.</span>has_errors<span class="op">)</span> <span class="op">{</span></span>
<span id="cb64-21"><a href="#cb64-21" aria-hidden="true" tabindex="-1"></a>        print_error_list<span class="op">(</span>validator<span class="op">.</span>errors<span class="op">);</span></span>
<span id="cb64-22"><a href="#cb64-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb64-23"><a href="#cb64-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb64-24"><a href="#cb64-24" aria-hidden="true" tabindex="-1"></a>    free_error_list<span class="op">(</span>validator<span class="op">.</span>errors<span class="op">);</span></span>
<span id="cb64-25"><a href="#cb64-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">!</span>validator<span class="op">.</span>has_errors<span class="op">;</span></span>
<span id="cb64-26"><a href="#cb64-26" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb64-27"><a href="#cb64-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-28"><a href="#cb64-28" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> validate_block_ssa<span class="op">(</span>SSAValidator <span class="op">*</span>val<span class="op">,</span> BasicBlock <span class="op">*</span>block<span class="op">)</span> <span class="op">{</span></span>
<span id="cb64-29"><a href="#cb64-29" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check -nodes are at beginning</span></span>
<span id="cb64-30"><a href="#cb64-30" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> seen_non_phi <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb64-31"><a href="#cb64-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>Instruction <span class="op">*</span>inst <span class="op">=</span> block<span class="op">-&gt;</span>first<span class="op">;</span> inst<span class="op">;</span> inst <span class="op">=</span> inst<span class="op">-&gt;</span>next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb64-32"><a href="#cb64-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>inst<span class="op">-&gt;</span>kind <span class="op">==</span> INST_PHI<span class="op">)</span> <span class="op">{</span></span>
<span id="cb64-33"><a href="#cb64-33" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>seen_non_phi<span class="op">)</span> <span class="op">{</span></span>
<span id="cb64-34"><a href="#cb64-34" aria-hidden="true" tabindex="-1"></a>                add_error<span class="op">(</span>val<span class="op">,</span> inst<span class="op">,</span> <span class="st">&quot;-node not at beginning of block&quot;</span><span class="op">);</span></span>
<span id="cb64-35"><a href="#cb64-35" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb64-36"><a href="#cb64-36" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb64-37"><a href="#cb64-37" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Check -node operands</span></span>
<span id="cb64-38"><a href="#cb64-38" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>inst<span class="op">-&gt;</span>data<span class="op">.</span>phi<span class="op">.</span>incoming_count <span class="op">!=</span> block<span class="op">-&gt;</span>predecessor_count<span class="op">)</span> <span class="op">{</span></span>
<span id="cb64-39"><a href="#cb64-39" aria-hidden="true" tabindex="-1"></a>                add_error<span class="op">(</span>val<span class="op">,</span> inst<span class="op">,</span> <span class="st">&quot;-node operand count mismatch&quot;</span><span class="op">);</span></span>
<span id="cb64-40"><a href="#cb64-40" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb64-41"><a href="#cb64-41" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb64-42"><a href="#cb64-42" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> inst<span class="op">-&gt;</span>data<span class="op">.</span>phi<span class="op">.</span>incoming_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb64-43"><a href="#cb64-43" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(!</span>inst<span class="op">-&gt;</span>data<span class="op">.</span>phi<span class="op">.</span>incoming_values<span class="op">[</span>i<span class="op">])</span> <span class="op">{</span></span>
<span id="cb64-44"><a href="#cb64-44" aria-hidden="true" tabindex="-1"></a>                    add_error<span class="op">(</span>val<span class="op">,</span> inst<span class="op">,</span> <span class="st">&quot;-node missing operand&quot;</span><span class="op">);</span></span>
<span id="cb64-45"><a href="#cb64-45" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb64-46"><a href="#cb64-46" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb64-47"><a href="#cb64-47" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb64-48"><a href="#cb64-48" aria-hidden="true" tabindex="-1"></a>            seen_non_phi <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb64-49"><a href="#cb64-49" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb64-50"><a href="#cb64-50" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb64-51"><a href="#cb64-51" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Check single definition</span></span>
<span id="cb64-52"><a href="#cb64-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>inst<span class="op">-&gt;</span>result<span class="op">)</span> <span class="op">{</span></span>
<span id="cb64-53"><a href="#cb64-53" aria-hidden="true" tabindex="-1"></a>            validate_single_definition<span class="op">(</span>val<span class="op">,</span> inst<span class="op">-&gt;</span>result<span class="op">);</span></span>
<span id="cb64-54"><a href="#cb64-54" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb64-55"><a href="#cb64-55" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb64-56"><a href="#cb64-56" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Check uses are dominated by definitions</span></span>
<span id="cb64-57"><a href="#cb64-57" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> inst<span class="op">-&gt;</span>operand_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb64-58"><a href="#cb64-58" aria-hidden="true" tabindex="-1"></a>            validate_use_dominance<span class="op">(</span>val<span class="op">,</span> inst<span class="op">,</span> inst<span class="op">-&gt;</span>operands<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb64-59"><a href="#cb64-59" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb64-60"><a href="#cb64-60" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb64-61"><a href="#cb64-61" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb64-62"><a href="#cb64-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-63"><a href="#cb64-63" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> validate_single_definition<span class="op">(</span>SSAValidator <span class="op">*</span>val<span class="op">,</span> Value <span class="op">*</span>value<span class="op">)</span> <span class="op">{</span></span>
<span id="cb64-64"><a href="#cb64-64" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>value<span class="op">-&gt;</span>kind <span class="op">!=</span> VALUE_TEMP<span class="op">)</span> <span class="cf">return</span><span class="op">;</span></span>
<span id="cb64-65"><a href="#cb64-65" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb64-66"><a href="#cb64-66" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Count definitions</span></span>
<span id="cb64-67"><a href="#cb64-67" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> def_count <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb64-68"><a href="#cb64-68" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> val<span class="op">-&gt;</span>cfg<span class="op">-&gt;</span>block_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb64-69"><a href="#cb64-69" aria-hidden="true" tabindex="-1"></a>        BasicBlock <span class="op">*</span>block <span class="op">=</span> val<span class="op">-&gt;</span>cfg<span class="op">-&gt;</span>blocks<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb64-70"><a href="#cb64-70" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span>Instruction <span class="op">*</span>inst <span class="op">=</span> block<span class="op">-&gt;</span>first<span class="op">;</span> inst<span class="op">;</span> inst <span class="op">=</span> inst<span class="op">-&gt;</span>next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb64-71"><a href="#cb64-71" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>inst<span class="op">-&gt;</span>result <span class="op">==</span> value<span class="op">)</span> <span class="op">{</span></span>
<span id="cb64-72"><a href="#cb64-72" aria-hidden="true" tabindex="-1"></a>                def_count<span class="op">++;</span></span>
<span id="cb64-73"><a href="#cb64-73" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb64-74"><a href="#cb64-74" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb64-75"><a href="#cb64-75" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb64-76"><a href="#cb64-76" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb64-77"><a href="#cb64-77" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>def_count <span class="op">!=</span> <span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb64-78"><a href="#cb64-78" aria-hidden="true" tabindex="-1"></a>        add_error<span class="op">(</span>val<span class="op">,</span> value<span class="op">-&gt;</span>def<span class="op">,</span> <span class="st">&quot;Value has </span><span class="sc">%zu</span><span class="st"> definitions&quot;</span><span class="op">,</span> def_count<span class="op">);</span></span>
<span id="cb64-79"><a href="#cb64-79" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb64-80"><a href="#cb64-80" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb64-81"><a href="#cb64-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-82"><a href="#cb64-82" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> validate_use_dominance<span class="op">(</span>SSAValidator <span class="op">*</span>val<span class="op">,</span> Instruction <span class="op">*</span>use<span class="op">,</span></span>
<span id="cb64-83"><a href="#cb64-83" aria-hidden="true" tabindex="-1"></a>                                 Value <span class="op">*</span>value<span class="op">)</span> <span class="op">{</span></span>
<span id="cb64-84"><a href="#cb64-84" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>value<span class="op">-&gt;</span>def<span class="op">)</span> <span class="cf">return</span><span class="op">;</span>  <span class="co">// Parameters, constants, etc.</span></span>
<span id="cb64-85"><a href="#cb64-85" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb64-86"><a href="#cb64-86" aria-hidden="true" tabindex="-1"></a>    BasicBlock <span class="op">*</span>def_block <span class="op">=</span> value<span class="op">-&gt;</span>def<span class="op">-&gt;</span>block<span class="op">;</span></span>
<span id="cb64-87"><a href="#cb64-87" aria-hidden="true" tabindex="-1"></a>    BasicBlock <span class="op">*</span>use_block <span class="op">=</span> use<span class="op">-&gt;</span>block<span class="op">;</span></span>
<span id="cb64-88"><a href="#cb64-88" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb64-89"><a href="#cb64-89" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Special case: -node uses come from predecessors</span></span>
<span id="cb64-90"><a href="#cb64-90" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>use<span class="op">-&gt;</span>kind <span class="op">==</span> INST_PHI<span class="op">)</span> <span class="op">{</span></span>
<span id="cb64-91"><a href="#cb64-91" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Find which predecessor this value comes from</span></span>
<span id="cb64-92"><a href="#cb64-92" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> use<span class="op">-&gt;</span>data<span class="op">.</span>phi<span class="op">.</span>incoming_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb64-93"><a href="#cb64-93" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>use<span class="op">-&gt;</span>data<span class="op">.</span>phi<span class="op">.</span>incoming_values<span class="op">[</span>i<span class="op">]</span> <span class="op">==</span> value<span class="op">)</span> <span class="op">{</span></span>
<span id="cb64-94"><a href="#cb64-94" aria-hidden="true" tabindex="-1"></a>                use_block <span class="op">=</span> use<span class="op">-&gt;</span>data<span class="op">.</span>phi<span class="op">.</span>incoming_blocks<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb64-95"><a href="#cb64-95" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb64-96"><a href="#cb64-96" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb64-97"><a href="#cb64-97" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb64-98"><a href="#cb64-98" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb64-99"><a href="#cb64-99" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb64-100"><a href="#cb64-100" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check dominance</span></span>
<span id="cb64-101"><a href="#cb64-101" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>dominates<span class="op">(</span>def_block<span class="op">,</span> use_block<span class="op">))</span> <span class="op">{</span></span>
<span id="cb64-102"><a href="#cb64-102" aria-hidden="true" tabindex="-1"></a>        add_error<span class="op">(</span>val<span class="op">,</span> use<span class="op">,</span> <span class="st">&quot;Use not dominated by definition&quot;</span><span class="op">);</span></span>
<span id="cb64-103"><a href="#cb64-103" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb64-104"><a href="#cb64-104" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>5.9 SSA Optimizations</h2>
<p>Once in SSA form, several optimizations become straightforward:</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> optimize_ssa<span class="op">(</span>CFG <span class="op">*</span>cfg<span class="op">)</span> <span class="op">{</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> changed<span class="op">;</span></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">do</span> <span class="op">{</span></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>        changed <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Dead code elimination</span></span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>        changed <span class="op">|=</span> eliminate_dead_code<span class="op">(</span>cfg<span class="op">);</span></span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Constant propagation</span></span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a>        changed <span class="op">|=</span> propagate_constants<span class="op">(</span>cfg<span class="op">);</span></span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Copy propagation</span></span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a>        changed <span class="op">|=</span> propagate_copies<span class="op">(</span>cfg<span class="op">);</span></span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb65-15"><a href="#cb65-15" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Common subexpression elimination</span></span>
<span id="cb65-16"><a href="#cb65-16" aria-hidden="true" tabindex="-1"></a>        changed <span class="op">|=</span> eliminate_common_subexpressions<span class="op">(</span>cfg<span class="op">);</span></span>
<span id="cb65-17"><a href="#cb65-17" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb65-18"><a href="#cb65-18" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Strength reduction</span></span>
<span id="cb65-19"><a href="#cb65-19" aria-hidden="true" tabindex="-1"></a>        changed <span class="op">|=</span> reduce_strength<span class="op">(</span>cfg<span class="op">);</span></span>
<span id="cb65-20"><a href="#cb65-20" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb65-21"><a href="#cb65-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">while</span> <span class="op">(</span>changed<span class="op">);</span></span>
<span id="cb65-22"><a href="#cb65-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb65-23"><a href="#cb65-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-24"><a href="#cb65-24" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">bool</span> eliminate_dead_code<span class="op">(</span>CFG <span class="op">*</span>cfg<span class="op">)</span> <span class="op">{</span></span>
<span id="cb65-25"><a href="#cb65-25" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> changed <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb65-26"><a href="#cb65-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-27"><a href="#cb65-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Mark live values</span></span>
<span id="cb65-28"><a href="#cb65-28" aria-hidden="true" tabindex="-1"></a>    BitSet <span class="op">*</span>live <span class="op">=</span> bitset_new<span class="op">(</span>cfg<span class="op">-&gt;</span>next_value_id<span class="op">);</span></span>
<span id="cb65-29"><a href="#cb65-29" aria-hidden="true" tabindex="-1"></a>    mark_live_values<span class="op">(</span>cfg<span class="op">,</span> live<span class="op">);</span></span>
<span id="cb65-30"><a href="#cb65-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-31"><a href="#cb65-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Remove dead instructions</span></span>
<span id="cb65-32"><a href="#cb65-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> cfg<span class="op">-&gt;</span>block_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb65-33"><a href="#cb65-33" aria-hidden="true" tabindex="-1"></a>        BasicBlock <span class="op">*</span>block <span class="op">=</span> cfg<span class="op">-&gt;</span>blocks<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb65-34"><a href="#cb65-34" aria-hidden="true" tabindex="-1"></a>        Instruction <span class="op">*</span>inst <span class="op">=</span> block<span class="op">-&gt;</span>first<span class="op">;</span></span>
<span id="cb65-35"><a href="#cb65-35" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb65-36"><a href="#cb65-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> <span class="op">(</span>inst<span class="op">)</span> <span class="op">{</span></span>
<span id="cb65-37"><a href="#cb65-37" aria-hidden="true" tabindex="-1"></a>            Instruction <span class="op">*</span>next <span class="op">=</span> inst<span class="op">-&gt;</span>next<span class="op">;</span></span>
<span id="cb65-38"><a href="#cb65-38" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb65-39"><a href="#cb65-39" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>inst<span class="op">-&gt;</span>result <span class="op">&amp;&amp;</span> <span class="op">!</span>bitset_test<span class="op">(</span>live<span class="op">,</span> inst<span class="op">-&gt;</span>result<span class="op">-&gt;</span>id<span class="op">)</span> <span class="op">&amp;&amp;</span></span>
<span id="cb65-40"><a href="#cb65-40" aria-hidden="true" tabindex="-1"></a>                <span class="op">!</span>has_side_effects<span class="op">(</span>inst<span class="op">))</span> <span class="op">{</span></span>
<span id="cb65-41"><a href="#cb65-41" aria-hidden="true" tabindex="-1"></a>                remove_instruction<span class="op">(</span>inst<span class="op">);</span></span>
<span id="cb65-42"><a href="#cb65-42" aria-hidden="true" tabindex="-1"></a>                changed <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb65-43"><a href="#cb65-43" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb65-44"><a href="#cb65-44" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb65-45"><a href="#cb65-45" aria-hidden="true" tabindex="-1"></a>            inst <span class="op">=</span> next<span class="op">;</span></span>
<span id="cb65-46"><a href="#cb65-46" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb65-47"><a href="#cb65-47" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb65-48"><a href="#cb65-48" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-49"><a href="#cb65-49" aria-hidden="true" tabindex="-1"></a>    bitset_free<span class="op">(</span>live<span class="op">);</span></span>
<span id="cb65-50"><a href="#cb65-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> changed<span class="op">;</span></span>
<span id="cb65-51"><a href="#cb65-51" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb65-52"><a href="#cb65-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-53"><a href="#cb65-53" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">bool</span> propagate_constants<span class="op">(</span>CFG <span class="op">*</span>cfg<span class="op">)</span> <span class="op">{</span></span>
<span id="cb65-54"><a href="#cb65-54" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> changed <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb65-55"><a href="#cb65-55" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-56"><a href="#cb65-56" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Build constant map</span></span>
<span id="cb65-57"><a href="#cb65-57" aria-hidden="true" tabindex="-1"></a>    ValueMap <span class="op">*</span>constants <span class="op">=</span> valuemap_new<span class="op">();</span></span>
<span id="cb65-58"><a href="#cb65-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-59"><a href="#cb65-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> cfg<span class="op">-&gt;</span>block_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb65-60"><a href="#cb65-60" aria-hidden="true" tabindex="-1"></a>        BasicBlock <span class="op">*</span>block <span class="op">=</span> cfg<span class="op">-&gt;</span>blocks<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb65-61"><a href="#cb65-61" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb65-62"><a href="#cb65-62" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span>Instruction <span class="op">*</span>inst <span class="op">=</span> block<span class="op">-&gt;</span>first<span class="op">;</span> inst<span class="op">;</span> inst <span class="op">=</span> inst<span class="op">-&gt;</span>next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb65-63"><a href="#cb65-63" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>is_constant_instruction<span class="op">(</span>inst<span class="op">))</span> <span class="op">{</span></span>
<span id="cb65-64"><a href="#cb65-64" aria-hidden="true" tabindex="-1"></a>                valuemap_put<span class="op">(</span>constants<span class="op">,</span> inst<span class="op">-&gt;</span>result<span class="op">,</span> </span>
<span id="cb65-65"><a href="#cb65-65" aria-hidden="true" tabindex="-1"></a>                           evaluate_constant<span class="op">(</span>inst<span class="op">));</span></span>
<span id="cb65-66"><a href="#cb65-66" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb65-67"><a href="#cb65-67" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb65-68"><a href="#cb65-68" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Replace uses with constants</span></span>
<span id="cb65-69"><a href="#cb65-69" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> inst<span class="op">-&gt;</span>operand_count<span class="op">;</span> j<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb65-70"><a href="#cb65-70" aria-hidden="true" tabindex="-1"></a>                Value <span class="op">*</span>const_val <span class="op">=</span> valuemap_get<span class="op">(</span>constants<span class="op">,</span> inst<span class="op">-&gt;</span>operands<span class="op">[</span>j<span class="op">]);</span></span>
<span id="cb65-71"><a href="#cb65-71" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span>const_val<span class="op">)</span> <span class="op">{</span></span>
<span id="cb65-72"><a href="#cb65-72" aria-hidden="true" tabindex="-1"></a>                    inst<span class="op">-&gt;</span>operands<span class="op">[</span>j<span class="op">]</span> <span class="op">=</span> const_val<span class="op">;</span></span>
<span id="cb65-73"><a href="#cb65-73" aria-hidden="true" tabindex="-1"></a>                    changed <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb65-74"><a href="#cb65-74" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb65-75"><a href="#cb65-75" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb65-76"><a href="#cb65-76" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb65-77"><a href="#cb65-77" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Fold constant expressions</span></span>
<span id="cb65-78"><a href="#cb65-78" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>all_operands_constant<span class="op">(</span>inst<span class="op">))</span> <span class="op">{</span></span>
<span id="cb65-79"><a href="#cb65-79" aria-hidden="true" tabindex="-1"></a>                Value <span class="op">*</span>result <span class="op">=</span> fold_constant_expression<span class="op">(</span>inst<span class="op">);</span></span>
<span id="cb65-80"><a href="#cb65-80" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span>result<span class="op">)</span> <span class="op">{</span></span>
<span id="cb65-81"><a href="#cb65-81" aria-hidden="true" tabindex="-1"></a>                    replace_instruction_with_value<span class="op">(</span>inst<span class="op">,</span> result<span class="op">);</span></span>
<span id="cb65-82"><a href="#cb65-82" aria-hidden="true" tabindex="-1"></a>                    valuemap_put<span class="op">(</span>constants<span class="op">,</span> inst<span class="op">-&gt;</span>result<span class="op">,</span> result<span class="op">);</span></span>
<span id="cb65-83"><a href="#cb65-83" aria-hidden="true" tabindex="-1"></a>                    changed <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb65-84"><a href="#cb65-84" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb65-85"><a href="#cb65-85" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb65-86"><a href="#cb65-86" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb65-87"><a href="#cb65-87" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb65-88"><a href="#cb65-88" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-89"><a href="#cb65-89" aria-hidden="true" tabindex="-1"></a>    valuemap_free<span class="op">(</span>constants<span class="op">);</span></span>
<span id="cb65-90"><a href="#cb65-90" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> changed<span class="op">;</span></span>
<span id="cb65-91"><a href="#cb65-91" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>5.10 Summary</h2>
<p>This chapter detailed Diyrbal&#39;s SSA form generation, following the
classic Cytron et al. algorithm. The key components are:</p>
<ol type="1">
<li><strong>Variable Collection</strong>: Identifying all variables that
need SSA form</li>
<li><strong>-Node Insertion</strong>: Placing -nodes at dominance
frontiers</li>
<li><strong>Variable Renaming</strong>: Assigning unique names through
dominator tree traversal</li>
<li><strong>Memory SSA</strong>: Extending SSA to handle memory
operations</li>
<li><strong>SSA Destruction</strong>: Converting back to conventional
form for code generation</li>
<li><strong>Validation</strong>: Ensuring SSA properties are
maintained</li>
<li><strong>Optimizations</strong>: Leveraging SSA form for powerful
transformations</li>
</ol>
<p>The SSA form serves as the foundation for most of Diyrbal&#39;s
optimizations and analyses. The next chapter will explore the type
inference system that operates on this SSA representation.</p>
<h1>Chapter 6: Interpretable SSA Design</h1>
<h2>6.1 Introduction</h2>
<p>Traditional SSA form, while excellent for optimization, presents
challenges for direct interpretation. -nodes lack operational
semantics, and the simultaneous assignment assumption doesn&#39;t map to
sequential execution. This chapter presents Interpretable SSA (ISSA)
form, a variant designed for efficient interpretation while maintaining
SSA&#39;s analytical benefits.</p>
<p>Drawing inspiration from the VM-SSA paper in our references, ISSA
makes three key contributions:</p>
<ol type="1">
<li><strong>Executable -nodes</strong> with well-defined operational
semantics</li>
<li><strong>Memory SSA</strong> with directly interpretable array
operations</li>
<li><strong>Efficient value representation</strong> optimized for
interpretation</li>
</ol>
<h2>6.2 Design Principles</h2>
<p>ISSA follows several core principles:</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Core ISSA design principles encoded in the IR structure</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">enum</span> ISSADesignPrinciple <span class="op">{</span></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>    ISSA_SELF_CONTAINED<span class="op">,</span>      <span class="co">// Each instruction has complete semantics</span></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>    ISSA_NO_SIDE_EFFECTS<span class="op">,</span>     <span class="co">// -nodes are pure operations</span></span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>    ISSA_DIRECT_EXECUTABLE<span class="op">,</span>   <span class="co">// No lowering needed for interpretation</span></span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>    ISSA_MEMORY_EXPLICIT<span class="op">,</span>     <span class="co">// All memory operations in SSA form</span></span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>    ISSA_TYPE_SAFE            <span class="co">// Type information preserved at runtime</span></span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> ISSADesignPrinciple<span class="op">;</span></span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> ISSAInstruction <span class="op">{</span></span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a>    InstructionKind kind<span class="op">;</span></span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Self-contained execution context</span></span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true" tabindex="-1"></a>        Value <span class="op">**</span>inputs<span class="op">;</span></span>
<span id="cb66-16"><a href="#cb66-16" aria-hidden="true" tabindex="-1"></a>        <span class="dt">size_t</span> input_count<span class="op">;</span></span>
<span id="cb66-17"><a href="#cb66-17" aria-hidden="true" tabindex="-1"></a>        Value <span class="op">*</span>output<span class="op">;</span></span>
<span id="cb66-18"><a href="#cb66-18" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb66-19"><a href="#cb66-19" aria-hidden="true" tabindex="-1"></a>        <span class="co">// For -nodes: which input to select</span></span>
<span id="cb66-20"><a href="#cb66-20" aria-hidden="true" tabindex="-1"></a>        <span class="dt">size_t</span> selected_input<span class="op">;</span></span>
<span id="cb66-21"><a href="#cb66-21" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb66-22"><a href="#cb66-22" aria-hidden="true" tabindex="-1"></a>        <span class="co">// For memory operations: memory version</span></span>
<span id="cb66-23"><a href="#cb66-23" aria-hidden="true" tabindex="-1"></a>        Value <span class="op">*</span>memory_in<span class="op">;</span></span>
<span id="cb66-24"><a href="#cb66-24" aria-hidden="true" tabindex="-1"></a>        Value <span class="op">*</span>memory_out<span class="op">;</span></span>
<span id="cb66-25"><a href="#cb66-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> exec<span class="op">;</span></span>
<span id="cb66-26"><a href="#cb66-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-27"><a href="#cb66-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Type information for interpretation</span></span>
<span id="cb66-28"><a href="#cb66-28" aria-hidden="true" tabindex="-1"></a>    Type <span class="op">*</span>type<span class="op">;</span></span>
<span id="cb66-29"><a href="#cb66-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-30"><a href="#cb66-30" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Direct execution function pointer</span></span>
<span id="cb66-31"><a href="#cb66-31" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">(*</span>execute<span class="op">)(</span><span class="kw">struct</span> ISSAInstruction <span class="op">*</span>inst<span class="op">,</span> ExecutionContext <span class="op">*</span>ctx<span class="op">);</span></span>
<span id="cb66-32"><a href="#cb66-32" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> ISSAInstruction<span class="op">;</span></span></code></pre></div>
<h2>6.3 Executable -Nodes</h2>
<p>The key innovation is making -nodes directly executable:</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> PhiNode <span class="op">{</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>    ISSAInstruction base<span class="op">;</span></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Incoming edges and values</span></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>        BasicBlock <span class="op">*</span>block<span class="op">;</span></span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>        Value <span class="op">*</span>value<span class="op">;</span></span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>        <span class="dt">size_t</span> block_id<span class="op">;</span>  <span class="co">// For fast lookup during execution</span></span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="op">*</span>inputs<span class="op">;</span></span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> input_count<span class="op">;</span></span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Runtime selector</span></span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> <span class="op">(*</span>selector<span class="op">)(</span><span class="kw">struct</span> PhiNode <span class="op">*</span>phi<span class="op">,</span> ExecutionContext <span class="op">*</span>ctx<span class="op">);</span></span>
<span id="cb67-14"><a href="#cb67-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> PhiNode<span class="op">;</span></span>
<span id="cb67-15"><a href="#cb67-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-16"><a href="#cb67-16" aria-hidden="true" tabindex="-1"></a><span class="co">// -node execution is simply selecting the right input</span></span>
<span id="cb67-17"><a href="#cb67-17" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> execute_phi<span class="op">(</span>ISSAInstruction <span class="op">*</span>inst<span class="op">,</span> ExecutionContext <span class="op">*</span>ctx<span class="op">)</span> <span class="op">{</span></span>
<span id="cb67-18"><a href="#cb67-18" aria-hidden="true" tabindex="-1"></a>    PhiNode <span class="op">*</span>phi <span class="op">=</span> <span class="op">(</span>PhiNode<span class="op">*)</span>inst<span class="op">;</span></span>
<span id="cb67-19"><a href="#cb67-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb67-20"><a href="#cb67-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Determine which predecessor we came from</span></span>
<span id="cb67-21"><a href="#cb67-21" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> selected <span class="op">=</span> phi<span class="op">-&gt;</span>selector<span class="op">(</span>phi<span class="op">,</span> ctx<span class="op">);</span></span>
<span id="cb67-22"><a href="#cb67-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb67-23"><a href="#cb67-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">// -node execution is just copying the selected value</span></span>
<span id="cb67-24"><a href="#cb67-24" aria-hidden="true" tabindex="-1"></a>    copy_value<span class="op">(</span>inst<span class="op">-&gt;</span>exec<span class="op">.</span>output<span class="op">,</span> phi<span class="op">-&gt;</span>inputs<span class="op">[</span>selected<span class="op">].</span>value<span class="op">);</span></span>
<span id="cb67-25"><a href="#cb67-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb67-26"><a href="#cb67-26" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Update execution statistics</span></span>
<span id="cb67-27"><a href="#cb67-27" aria-hidden="true" tabindex="-1"></a>    ctx<span class="op">-&gt;</span>stats<span class="op">.</span>phi_executed<span class="op">++;</span></span>
<span id="cb67-28"><a href="#cb67-28" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb67-29"><a href="#cb67-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-30"><a href="#cb67-30" aria-hidden="true" tabindex="-1"></a><span class="co">// Fast predecessor lookup using block IDs</span></span>
<span id="cb67-31"><a href="#cb67-31" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">size_t</span> select_phi_input<span class="op">(</span>PhiNode <span class="op">*</span>phi<span class="op">,</span> ExecutionContext <span class="op">*</span>ctx<span class="op">)</span> <span class="op">{</span></span>
<span id="cb67-32"><a href="#cb67-32" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> last_block_id <span class="op">=</span> ctx<span class="op">-&gt;</span>last_block_id<span class="op">;</span></span>
<span id="cb67-33"><a href="#cb67-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb67-34"><a href="#cb67-34" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Common case: binary search for small -nodes</span></span>
<span id="cb67-35"><a href="#cb67-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>phi<span class="op">-&gt;</span>input_count <span class="op">&lt;=</span> <span class="dv">4</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb67-36"><a href="#cb67-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> phi<span class="op">-&gt;</span>input_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb67-37"><a href="#cb67-37" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>phi<span class="op">-&gt;</span>inputs<span class="op">[</span>i<span class="op">].</span>block_id <span class="op">==</span> last_block_id<span class="op">)</span> <span class="op">{</span></span>
<span id="cb67-38"><a href="#cb67-38" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> i<span class="op">;</span></span>
<span id="cb67-39"><a href="#cb67-39" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb67-40"><a href="#cb67-40" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb67-41"><a href="#cb67-41" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb67-42"><a href="#cb67-42" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Use hash table for large -nodes</span></span>
<span id="cb67-43"><a href="#cb67-43" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> phi_input_table_lookup<span class="op">(</span>phi<span class="op">,</span> last_block_id<span class="op">);</span></span>
<span id="cb67-44"><a href="#cb67-44" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb67-45"><a href="#cb67-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb67-46"><a href="#cb67-46" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Should never happen in well-formed SSA</span></span>
<span id="cb67-47"><a href="#cb67-47" aria-hidden="true" tabindex="-1"></a>    panic<span class="op">(</span><span class="st">&quot;-node input not found for block </span><span class="sc">%zu</span><span class="st">&quot;</span><span class="op">,</span> last_block_id<span class="op">);</span></span>
<span id="cb67-48"><a href="#cb67-48" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>6.4 Value Representation</h2>
<p>ISSA uses a tagged value representation optimized for
interpretation:</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Tagged value representation for efficient interpretation</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> ISSAValue <span class="op">{</span></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>    ValueKind kind<span class="op">;</span></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">union</span> <span class="op">{</span></span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Immediate values (no allocation)</span></span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int64_t</span> int_val<span class="op">;</span></span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>        <span class="dt">double</span> float_val<span class="op">;</span></span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>        <span class="dt">bool</span> bool_val<span class="op">;</span></span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Heap-allocated values</span></span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a>            <span class="dt">void</span> <span class="op">*</span>ptr<span class="op">;</span></span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a>            <span class="dt">size_t</span> size<span class="op">;</span></span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true" tabindex="-1"></a>            TypeInfo <span class="op">*</span>type<span class="op">;</span></span>
<span id="cb68-16"><a href="#cb68-16" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> heap<span class="op">;</span></span>
<span id="cb68-17"><a href="#cb68-17" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb68-18"><a href="#cb68-18" aria-hidden="true" tabindex="-1"></a>        <span class="co">// SSA temporaries</span></span>
<span id="cb68-19"><a href="#cb68-19" aria-hidden="true" tabindex="-1"></a>        <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb68-20"><a href="#cb68-20" aria-hidden="true" tabindex="-1"></a>            <span class="dt">uint32_t</span> version<span class="op">;</span></span>
<span id="cb68-21"><a href="#cb68-21" aria-hidden="true" tabindex="-1"></a>            <span class="dt">uint32_t</span> var_id<span class="op">;</span></span>
<span id="cb68-22"><a href="#cb68-22" aria-hidden="true" tabindex="-1"></a>            ISSAInstruction <span class="op">*</span>def<span class="op">;</span></span>
<span id="cb68-23"><a href="#cb68-23" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> ssa<span class="op">;</span></span>
<span id="cb68-24"><a href="#cb68-24" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb68-25"><a href="#cb68-25" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Memory version</span></span>
<span id="cb68-26"><a href="#cb68-26" aria-hidden="true" tabindex="-1"></a>        <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb68-27"><a href="#cb68-27" aria-hidden="true" tabindex="-1"></a>            <span class="dt">uint64_t</span> version<span class="op">;</span></span>
<span id="cb68-28"><a href="#cb68-28" aria-hidden="true" tabindex="-1"></a>            MemoryState <span class="op">*</span>state<span class="op">;</span></span>
<span id="cb68-29"><a href="#cb68-29" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> memory<span class="op">;</span></span>
<span id="cb68-30"><a href="#cb68-30" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb68-31"><a href="#cb68-31" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Array values (for memory SSA)</span></span>
<span id="cb68-32"><a href="#cb68-32" aria-hidden="true" tabindex="-1"></a>        <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb68-33"><a href="#cb68-33" aria-hidden="true" tabindex="-1"></a>            ISSAValue <span class="op">*</span>elements<span class="op">;</span></span>
<span id="cb68-34"><a href="#cb68-34" aria-hidden="true" tabindex="-1"></a>            <span class="dt">size_t</span> length<span class="op">;</span></span>
<span id="cb68-35"><a href="#cb68-35" aria-hidden="true" tabindex="-1"></a>            <span class="dt">size_t</span> capacity<span class="op">;</span></span>
<span id="cb68-36"><a href="#cb68-36" aria-hidden="true" tabindex="-1"></a>            Type <span class="op">*</span>elem_type<span class="op">;</span></span>
<span id="cb68-37"><a href="#cb68-37" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> array<span class="op">;</span></span>
<span id="cb68-38"><a href="#cb68-38" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> data<span class="op">;</span></span>
<span id="cb68-39"><a href="#cb68-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-40"><a href="#cb68-40" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Reference counting for memory management</span></span>
<span id="cb68-41"><a href="#cb68-41" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> ref_count<span class="op">;</span></span>
<span id="cb68-42"><a href="#cb68-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-43"><a href="#cb68-43" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Type tag for runtime type checking</span></span>
<span id="cb68-44"><a href="#cb68-44" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint16_t</span> type_tag<span class="op">;</span></span>
<span id="cb68-45"><a href="#cb68-45" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> ISSAValue<span class="op">;</span></span>
<span id="cb68-46"><a href="#cb68-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-47"><a href="#cb68-47" aria-hidden="true" tabindex="-1"></a><span class="co">// Efficient value operations</span></span>
<span id="cb68-48"><a href="#cb68-48" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="kw">inline</span> <span class="dt">void</span> retain_value<span class="op">(</span>ISSAValue <span class="op">*</span>val<span class="op">)</span> <span class="op">{</span></span>
<span id="cb68-49"><a href="#cb68-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>val <span class="op">&amp;&amp;</span> is_heap_allocated<span class="op">(</span>val<span class="op">))</span> <span class="op">{</span></span>
<span id="cb68-50"><a href="#cb68-50" aria-hidden="true" tabindex="-1"></a>        val<span class="op">-&gt;</span>ref_count<span class="op">++;</span></span>
<span id="cb68-51"><a href="#cb68-51" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb68-52"><a href="#cb68-52" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb68-53"><a href="#cb68-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-54"><a href="#cb68-54" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="kw">inline</span> <span class="dt">void</span> release_value<span class="op">(</span>ISSAValue <span class="op">*</span>val<span class="op">)</span> <span class="op">{</span></span>
<span id="cb68-55"><a href="#cb68-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>val <span class="op">&amp;&amp;</span> is_heap_allocated<span class="op">(</span>val<span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="op">--</span>val<span class="op">-&gt;</span>ref_count <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb68-56"><a href="#cb68-56" aria-hidden="true" tabindex="-1"></a>        free_value<span class="op">(</span>val<span class="op">);</span></span>
<span id="cb68-57"><a href="#cb68-57" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb68-58"><a href="#cb68-58" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb68-59"><a href="#cb68-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-60"><a href="#cb68-60" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="kw">inline</span> <span class="dt">bool</span> is_heap_allocated<span class="op">(</span>ISSAValue <span class="op">*</span>val<span class="op">)</span> <span class="op">{</span></span>
<span id="cb68-61"><a href="#cb68-61" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> <span class="op">(</span>val<span class="op">-&gt;</span>kind<span class="op">)</span> <span class="op">{</span></span>
<span id="cb68-62"><a href="#cb68-62" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> VALUE_STRING<span class="op">:</span></span>
<span id="cb68-63"><a href="#cb68-63" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> VALUE_ARRAY<span class="op">:</span></span>
<span id="cb68-64"><a href="#cb68-64" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> VALUE_STRUCT<span class="op">:</span></span>
<span id="cb68-65"><a href="#cb68-65" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> VALUE_CLOSURE<span class="op">:</span></span>
<span id="cb68-66"><a href="#cb68-66" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb68-67"><a href="#cb68-67" aria-hidden="true" tabindex="-1"></a>        <span class="cf">default</span><span class="op">:</span></span>
<span id="cb68-68"><a href="#cb68-68" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb68-69"><a href="#cb68-69" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb68-70"><a href="#cb68-70" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>6.5 Memory SSA in ISSA</h2>
<p>ISSA extends SSA to memory operations with directly interpretable
semantics:</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Memory SSA instructions</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">enum</span> MemorySSAOp <span class="op">{</span></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>    MEM_PHI<span class="op">,</span>          <span class="co">// Memory -node</span></span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>    MEM_LOAD<span class="op">,</span>         <span class="co">// Load with memory version</span></span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>    MEM_STORE<span class="op">,</span>        <span class="co">// Store producing new memory version</span></span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>    MEM_ARRAY_GET<span class="op">,</span>    <span class="co">// Array access in SSA form</span></span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>    MEM_ARRAY_SET<span class="op">,</span>    <span class="co">// Array update in SSA form</span></span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> MemorySSAOp<span class="op">;</span></span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> MemoryPhi <span class="op">{</span></span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a>    ISSAInstruction base<span class="op">;</span></span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Memory versions from predecessors</span></span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true" tabindex="-1"></a>    ISSAValue <span class="op">**</span>memory_inputs<span class="op">;</span></span>
<span id="cb69-15"><a href="#cb69-15" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> input_count<span class="op">;</span></span>
<span id="cb69-16"><a href="#cb69-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb69-17"><a href="#cb69-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Resulting memory version</span></span>
<span id="cb69-18"><a href="#cb69-18" aria-hidden="true" tabindex="-1"></a>    ISSAValue <span class="op">*</span>memory_out<span class="op">;</span></span>
<span id="cb69-19"><a href="#cb69-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> MemoryPhi<span class="op">;</span></span>
<span id="cb69-20"><a href="#cb69-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-21"><a href="#cb69-21" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> ArrayOperation <span class="op">{</span></span>
<span id="cb69-22"><a href="#cb69-22" aria-hidden="true" tabindex="-1"></a>    ISSAInstruction base<span class="op">;</span></span>
<span id="cb69-23"><a href="#cb69-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb69-24"><a href="#cb69-24" aria-hidden="true" tabindex="-1"></a>    ISSAValue <span class="op">*</span>array_in<span class="op">;</span></span>
<span id="cb69-25"><a href="#cb69-25" aria-hidden="true" tabindex="-1"></a>    ISSAValue <span class="op">*</span>index<span class="op">;</span></span>
<span id="cb69-26"><a href="#cb69-26" aria-hidden="true" tabindex="-1"></a>    ISSAValue <span class="op">*</span>value<span class="op">;</span>  <span class="co">// For SET operations</span></span>
<span id="cb69-27"><a href="#cb69-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb69-28"><a href="#cb69-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Result (new array version for SET, element for GET)</span></span>
<span id="cb69-29"><a href="#cb69-29" aria-hidden="true" tabindex="-1"></a>    ISSAValue <span class="op">*</span>result<span class="op">;</span></span>
<span id="cb69-30"><a href="#cb69-30" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> ArrayOperation<span class="op">;</span></span>
<span id="cb69-31"><a href="#cb69-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-32"><a href="#cb69-32" aria-hidden="true" tabindex="-1"></a><span class="co">// Direct execution of array operations</span></span>
<span id="cb69-33"><a href="#cb69-33" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> execute_array_get<span class="op">(</span>ISSAInstruction <span class="op">*</span>inst<span class="op">,</span> ExecutionContext <span class="op">*</span>ctx<span class="op">)</span> <span class="op">{</span></span>
<span id="cb69-34"><a href="#cb69-34" aria-hidden="true" tabindex="-1"></a>    ArrayOperation <span class="op">*</span>op <span class="op">=</span> <span class="op">(</span>ArrayOperation<span class="op">*)</span>inst<span class="op">;</span></span>
<span id="cb69-35"><a href="#cb69-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb69-36"><a href="#cb69-36" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> idx <span class="op">=</span> value_to_size<span class="op">(</span>op<span class="op">-&gt;</span>index<span class="op">);</span></span>
<span id="cb69-37"><a href="#cb69-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>idx <span class="op">&gt;=</span> op<span class="op">-&gt;</span>array_in<span class="op">-&gt;</span>data<span class="op">.</span>array<span class="op">.</span>length<span class="op">)</span> <span class="op">{</span></span>
<span id="cb69-38"><a href="#cb69-38" aria-hidden="true" tabindex="-1"></a>        runtime_error<span class="op">(</span>ctx<span class="op">,</span> <span class="st">&quot;Array index out of bounds&quot;</span><span class="op">);</span></span>
<span id="cb69-39"><a href="#cb69-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span><span class="op">;</span></span>
<span id="cb69-40"><a href="#cb69-40" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb69-41"><a href="#cb69-41" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb69-42"><a href="#cb69-42" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Direct access - no copying needed in SSA form</span></span>
<span id="cb69-43"><a href="#cb69-43" aria-hidden="true" tabindex="-1"></a>    op<span class="op">-&gt;</span>result <span class="op">=</span> <span class="op">&amp;</span>op<span class="op">-&gt;</span>array_in<span class="op">-&gt;</span>data<span class="op">.</span>array<span class="op">.</span>elements<span class="op">[</span>idx<span class="op">];</span></span>
<span id="cb69-44"><a href="#cb69-44" aria-hidden="true" tabindex="-1"></a>    retain_value<span class="op">(</span>op<span class="op">-&gt;</span>result<span class="op">);</span></span>
<span id="cb69-45"><a href="#cb69-45" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb69-46"><a href="#cb69-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-47"><a href="#cb69-47" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> execute_array_set<span class="op">(</span>ISSAInstruction <span class="op">*</span>inst<span class="op">,</span> ExecutionContext <span class="op">*</span>ctx<span class="op">)</span> <span class="op">{</span></span>
<span id="cb69-48"><a href="#cb69-48" aria-hidden="true" tabindex="-1"></a>    ArrayOperation <span class="op">*</span>op <span class="op">=</span> <span class="op">(</span>ArrayOperation<span class="op">*)</span>inst<span class="op">;</span></span>
<span id="cb69-49"><a href="#cb69-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb69-50"><a href="#cb69-50" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> idx <span class="op">=</span> value_to_size<span class="op">(</span>op<span class="op">-&gt;</span>index<span class="op">);</span></span>
<span id="cb69-51"><a href="#cb69-51" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> len <span class="op">=</span> op<span class="op">-&gt;</span>array_in<span class="op">-&gt;</span>data<span class="op">.</span>array<span class="op">.</span>length<span class="op">;</span></span>
<span id="cb69-52"><a href="#cb69-52" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb69-53"><a href="#cb69-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>idx <span class="op">&gt;=</span> len<span class="op">)</span> <span class="op">{</span></span>
<span id="cb69-54"><a href="#cb69-54" aria-hidden="true" tabindex="-1"></a>        runtime_error<span class="op">(</span>ctx<span class="op">,</span> <span class="st">&quot;Array index out of bounds&quot;</span><span class="op">);</span></span>
<span id="cb69-55"><a href="#cb69-55" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span><span class="op">;</span></span>
<span id="cb69-56"><a href="#cb69-56" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb69-57"><a href="#cb69-57" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb69-58"><a href="#cb69-58" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Create new array version (functional update)</span></span>
<span id="cb69-59"><a href="#cb69-59" aria-hidden="true" tabindex="-1"></a>    ISSAValue <span class="op">*</span>new_array <span class="op">=</span> allocate_array<span class="op">(</span>len<span class="op">,</span> </span>
<span id="cb69-60"><a href="#cb69-60" aria-hidden="true" tabindex="-1"></a>                                         op<span class="op">-&gt;</span>array_in<span class="op">-&gt;</span>data<span class="op">.</span>array<span class="op">.</span>elem_type<span class="op">);</span></span>
<span id="cb69-61"><a href="#cb69-61" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb69-62"><a href="#cb69-62" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Copy all elements</span></span>
<span id="cb69-63"><a href="#cb69-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> len<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb69-64"><a href="#cb69-64" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>i <span class="op">==</span> idx<span class="op">)</span> <span class="op">{</span></span>
<span id="cb69-65"><a href="#cb69-65" aria-hidden="true" tabindex="-1"></a>            new_array<span class="op">-&gt;</span>data<span class="op">.</span>array<span class="op">.</span>elements<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> <span class="op">*</span>op<span class="op">-&gt;</span>value<span class="op">;</span></span>
<span id="cb69-66"><a href="#cb69-66" aria-hidden="true" tabindex="-1"></a>            retain_value<span class="op">(</span>op<span class="op">-&gt;</span>value<span class="op">);</span></span>
<span id="cb69-67"><a href="#cb69-67" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb69-68"><a href="#cb69-68" aria-hidden="true" tabindex="-1"></a>            new_array<span class="op">-&gt;</span>data<span class="op">.</span>array<span class="op">.</span>elements<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> </span>
<span id="cb69-69"><a href="#cb69-69" aria-hidden="true" tabindex="-1"></a>                op<span class="op">-&gt;</span>array_in<span class="op">-&gt;</span>data<span class="op">.</span>array<span class="op">.</span>elements<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb69-70"><a href="#cb69-70" aria-hidden="true" tabindex="-1"></a>            retain_value<span class="op">(&amp;</span>op<span class="op">-&gt;</span>array_in<span class="op">-&gt;</span>data<span class="op">.</span>array<span class="op">.</span>elements<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb69-71"><a href="#cb69-71" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb69-72"><a href="#cb69-72" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb69-73"><a href="#cb69-73" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb69-74"><a href="#cb69-74" aria-hidden="true" tabindex="-1"></a>    op<span class="op">-&gt;</span>result <span class="op">=</span> new_array<span class="op">;</span></span>
<span id="cb69-75"><a href="#cb69-75" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>6.6 Instruction Execution Architecture</h2>
<p>ISSA uses direct threading for efficient interpretation:</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> ExecutionContext <span class="op">{</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Current execution state</span></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>    BasicBlock <span class="op">*</span>current_block<span class="op">;</span></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>    ISSAInstruction <span class="op">*</span>current_inst<span class="op">;</span></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> last_block_id<span class="op">;</span></span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Value storage</span></span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>    ISSAValue <span class="op">*</span>locals<span class="op">;</span></span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> local_count<span class="op">;</span></span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Memory state</span></span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a>    MemoryState <span class="op">*</span>memory<span class="op">;</span></span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Call stack</span></span>
<span id="cb70-15"><a href="#cb70-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> CallFrame <span class="op">{</span></span>
<span id="cb70-16"><a href="#cb70-16" aria-hidden="true" tabindex="-1"></a>        Function <span class="op">*</span>function<span class="op">;</span></span>
<span id="cb70-17"><a href="#cb70-17" aria-hidden="true" tabindex="-1"></a>        ISSAValue <span class="op">*</span>return_value<span class="op">;</span></span>
<span id="cb70-18"><a href="#cb70-18" aria-hidden="true" tabindex="-1"></a>        BasicBlock <span class="op">*</span>return_block<span class="op">;</span></span>
<span id="cb70-19"><a href="#cb70-19" aria-hidden="true" tabindex="-1"></a>        ISSAInstruction <span class="op">*</span>return_inst<span class="op">;</span></span>
<span id="cb70-20"><a href="#cb70-20" aria-hidden="true" tabindex="-1"></a>        ISSAValue <span class="op">*</span>saved_locals<span class="op">;</span></span>
<span id="cb70-21"><a href="#cb70-21" aria-hidden="true" tabindex="-1"></a>        <span class="dt">size_t</span> saved_local_count<span class="op">;</span></span>
<span id="cb70-22"><a href="#cb70-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="op">*</span>call_stack<span class="op">;</span></span>
<span id="cb70-23"><a href="#cb70-23" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> call_depth<span class="op">;</span></span>
<span id="cb70-24"><a href="#cb70-24" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> max_call_depth<span class="op">;</span></span>
<span id="cb70-25"><a href="#cb70-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-26"><a href="#cb70-26" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Execution statistics</span></span>
<span id="cb70-27"><a href="#cb70-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb70-28"><a href="#cb70-28" aria-hidden="true" tabindex="-1"></a>        <span class="dt">size_t</span> instructions_executed<span class="op">;</span></span>
<span id="cb70-29"><a href="#cb70-29" aria-hidden="true" tabindex="-1"></a>        <span class="dt">size_t</span> phi_executed<span class="op">;</span></span>
<span id="cb70-30"><a href="#cb70-30" aria-hidden="true" tabindex="-1"></a>        <span class="dt">size_t</span> memory_ops<span class="op">;</span></span>
<span id="cb70-31"><a href="#cb70-31" aria-hidden="true" tabindex="-1"></a>        <span class="dt">size_t</span> array_ops<span class="op">;</span></span>
<span id="cb70-32"><a href="#cb70-32" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> stats<span class="op">;</span></span>
<span id="cb70-33"><a href="#cb70-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-34"><a href="#cb70-34" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Error handling</span></span>
<span id="cb70-35"><a href="#cb70-35" aria-hidden="true" tabindex="-1"></a>    jmp_buf error_handler<span class="op">;</span></span>
<span id="cb70-36"><a href="#cb70-36" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> error_message<span class="op">[</span><span class="dv">256</span><span class="op">];</span></span>
<span id="cb70-37"><a href="#cb70-37" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> ExecutionContext<span class="op">;</span></span>
<span id="cb70-38"><a href="#cb70-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-39"><a href="#cb70-39" aria-hidden="true" tabindex="-1"></a><span class="co">// Main interpreter loop using direct threading</span></span>
<span id="cb70-40"><a href="#cb70-40" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> interpret_issa<span class="op">(</span>Function <span class="op">*</span>entry<span class="op">,</span> ExecutionContext <span class="op">*</span>ctx<span class="op">)</span> <span class="op">{</span></span>
<span id="cb70-41"><a href="#cb70-41" aria-hidden="true" tabindex="-1"></a>    ctx<span class="op">-&gt;</span>current_block <span class="op">=</span> entry<span class="op">-&gt;</span>cfg<span class="op">-&gt;</span>entry<span class="op">;</span></span>
<span id="cb70-42"><a href="#cb70-42" aria-hidden="true" tabindex="-1"></a>    ctx<span class="op">-&gt;</span>current_inst <span class="op">=</span> ctx<span class="op">-&gt;</span>current_block<span class="op">-&gt;</span>first<span class="op">;</span></span>
<span id="cb70-43"><a href="#cb70-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-44"><a href="#cb70-44" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Set up error handling</span></span>
<span id="cb70-45"><a href="#cb70-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>setjmp<span class="op">(</span>ctx<span class="op">-&gt;</span>error_handler<span class="op">)</span> <span class="op">!=</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb70-46"><a href="#cb70-46" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Error occurred</span></span>
<span id="cb70-47"><a href="#cb70-47" aria-hidden="true" tabindex="-1"></a>        fprintf<span class="op">(</span>stderr<span class="op">,</span> <span class="st">&quot;Runtime error: </span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span> ctx<span class="op">-&gt;</span>error_message<span class="op">);</span></span>
<span id="cb70-48"><a href="#cb70-48" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span><span class="op">;</span></span>
<span id="cb70-49"><a href="#cb70-49" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb70-50"><a href="#cb70-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-51"><a href="#cb70-51" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Direct-threaded interpreter loop</span></span>
<span id="cb70-52"><a href="#cb70-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span>ctx<span class="op">-&gt;</span>current_inst<span class="op">)</span> <span class="op">{</span></span>
<span id="cb70-53"><a href="#cb70-53" aria-hidden="true" tabindex="-1"></a>        ISSAInstruction <span class="op">*</span>inst <span class="op">=</span> ctx<span class="op">-&gt;</span>current_inst<span class="op">;</span></span>
<span id="cb70-54"><a href="#cb70-54" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb70-55"><a href="#cb70-55" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Execute instruction through function pointer</span></span>
<span id="cb70-56"><a href="#cb70-56" aria-hidden="true" tabindex="-1"></a>        inst<span class="op">-&gt;</span>execute<span class="op">(</span>inst<span class="op">,</span> ctx<span class="op">);</span></span>
<span id="cb70-57"><a href="#cb70-57" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb70-58"><a href="#cb70-58" aria-hidden="true" tabindex="-1"></a>        ctx<span class="op">-&gt;</span>stats<span class="op">.</span>instructions_executed<span class="op">++;</span></span>
<span id="cb70-59"><a href="#cb70-59" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb70-60"><a href="#cb70-60" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Move to next instruction</span></span>
<span id="cb70-61"><a href="#cb70-61" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>inst<span class="op">-&gt;</span>kind <span class="op">==</span> INST_BR <span class="op">||</span> inst<span class="op">-&gt;</span>kind <span class="op">==</span> INST_BR_COND <span class="op">||</span></span>
<span id="cb70-62"><a href="#cb70-62" aria-hidden="true" tabindex="-1"></a>            inst<span class="op">-&gt;</span>kind <span class="op">==</span> INST_RET<span class="op">)</span> <span class="op">{</span></span>
<span id="cb70-63"><a href="#cb70-63" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Control flow handled by instruction</span></span>
<span id="cb70-64"><a href="#cb70-64" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb70-65"><a href="#cb70-65" aria-hidden="true" tabindex="-1"></a>            ctx<span class="op">-&gt;</span>current_inst <span class="op">=</span> inst<span class="op">-&gt;</span>base<span class="op">.</span>next<span class="op">;</span></span>
<span id="cb70-66"><a href="#cb70-66" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb70-67"><a href="#cb70-67" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb70-68"><a href="#cb70-68" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb70-69"><a href="#cb70-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-70"><a href="#cb70-70" aria-hidden="true" tabindex="-1"></a><span class="co">// Optimized instruction dispatch table</span></span>
<span id="cb70-71"><a href="#cb70-71" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> InstructionExecutor instruction_table<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb70-72"><a href="#cb70-72" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>INST_PHI<span class="op">]</span> <span class="op">=</span> execute_phi<span class="op">,</span></span>
<span id="cb70-73"><a href="#cb70-73" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>INST_ADD<span class="op">]</span> <span class="op">=</span> execute_arithmetic<span class="op">,</span></span>
<span id="cb70-74"><a href="#cb70-74" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>INST_SUB<span class="op">]</span> <span class="op">=</span> execute_arithmetic<span class="op">,</span></span>
<span id="cb70-75"><a href="#cb70-75" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>INST_MUL<span class="op">]</span> <span class="op">=</span> execute_arithmetic<span class="op">,</span></span>
<span id="cb70-76"><a href="#cb70-76" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>INST_DIV<span class="op">]</span> <span class="op">=</span> execute_arithmetic<span class="op">,</span></span>
<span id="cb70-77"><a href="#cb70-77" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>INST_LOAD<span class="op">]</span> <span class="op">=</span> execute_load<span class="op">,</span></span>
<span id="cb70-78"><a href="#cb70-78" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>INST_STORE<span class="op">]</span> <span class="op">=</span> execute_store<span class="op">,</span></span>
<span id="cb70-79"><a href="#cb70-79" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>INST_BR<span class="op">]</span> <span class="op">=</span> execute_branch<span class="op">,</span></span>
<span id="cb70-80"><a href="#cb70-80" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>INST_BR_COND<span class="op">]</span> <span class="op">=</span> execute_conditional_branch<span class="op">,</span></span>
<span id="cb70-81"><a href="#cb70-81" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>INST_CALL<span class="op">]</span> <span class="op">=</span> execute_call<span class="op">,</span></span>
<span id="cb70-82"><a href="#cb70-82" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>INST_RET<span class="op">]</span> <span class="op">=</span> execute_return<span class="op">,</span></span>
<span id="cb70-83"><a href="#cb70-83" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>MEM_PHI<span class="op">]</span> <span class="op">=</span> execute_memory_phi<span class="op">,</span></span>
<span id="cb70-84"><a href="#cb70-84" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>MEM_ARRAY_GET<span class="op">]</span> <span class="op">=</span> execute_array_get<span class="op">,</span></span>
<span id="cb70-85"><a href="#cb70-85" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>MEM_ARRAY_SET<span class="op">]</span> <span class="op">=</span> execute_array_set<span class="op">,</span></span>
<span id="cb70-86"><a href="#cb70-86" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<h2>6.7 Control Flow Handling</h2>
<p>ISSA handles control flow explicitly to support -node execution:</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> execute_branch<span class="op">(</span>ISSAInstruction <span class="op">*</span>inst<span class="op">,</span> ExecutionContext <span class="op">*</span>ctx<span class="op">)</span> <span class="op">{</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>    BranchInst <span class="op">*</span>br <span class="op">=</span> <span class="op">(</span>BranchInst<span class="op">*)</span>inst<span class="op">;</span></span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Record current block for -node resolution</span></span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>    ctx<span class="op">-&gt;</span>last_block_id <span class="op">=</span> ctx<span class="op">-&gt;</span>current_block<span class="op">-&gt;</span>id<span class="op">;</span></span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Jump to target</span></span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a>    ctx<span class="op">-&gt;</span>current_block <span class="op">=</span> br<span class="op">-&gt;</span>target<span class="op">;</span></span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a>    ctx<span class="op">-&gt;</span>current_inst <span class="op">=</span> br<span class="op">-&gt;</span>target<span class="op">-&gt;</span>first<span class="op">;</span></span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> execute_conditional_branch<span class="op">(</span>ISSAInstruction <span class="op">*</span>inst<span class="op">,</span> </span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a>                                     ExecutionContext <span class="op">*</span>ctx<span class="op">)</span> <span class="op">{</span></span>
<span id="cb71-14"><a href="#cb71-14" aria-hidden="true" tabindex="-1"></a>    CondBranchInst <span class="op">*</span>br <span class="op">=</span> <span class="op">(</span>CondBranchInst<span class="op">*)</span>inst<span class="op">;</span></span>
<span id="cb71-15"><a href="#cb71-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb71-16"><a href="#cb71-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> condition <span class="op">=</span> value_to_bool<span class="op">(</span>br<span class="op">-&gt;</span>condition<span class="op">);</span></span>
<span id="cb71-17"><a href="#cb71-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb71-18"><a href="#cb71-18" aria-hidden="true" tabindex="-1"></a>    ctx<span class="op">-&gt;</span>last_block_id <span class="op">=</span> ctx<span class="op">-&gt;</span>current_block<span class="op">-&gt;</span>id<span class="op">;</span></span>
<span id="cb71-19"><a href="#cb71-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb71-20"><a href="#cb71-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>condition<span class="op">)</span> <span class="op">{</span></span>
<span id="cb71-21"><a href="#cb71-21" aria-hidden="true" tabindex="-1"></a>        ctx<span class="op">-&gt;</span>current_block <span class="op">=</span> br<span class="op">-&gt;</span>true_target<span class="op">;</span></span>
<span id="cb71-22"><a href="#cb71-22" aria-hidden="true" tabindex="-1"></a>        ctx<span class="op">-&gt;</span>current_inst <span class="op">=</span> br<span class="op">-&gt;</span>true_target<span class="op">-&gt;</span>first<span class="op">;</span></span>
<span id="cb71-23"><a href="#cb71-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb71-24"><a href="#cb71-24" aria-hidden="true" tabindex="-1"></a>        ctx<span class="op">-&gt;</span>current_block <span class="op">=</span> br<span class="op">-&gt;</span>false_target<span class="op">;</span></span>
<span id="cb71-25"><a href="#cb71-25" aria-hidden="true" tabindex="-1"></a>        ctx<span class="op">-&gt;</span>current_inst <span class="op">=</span> br<span class="op">-&gt;</span>false_target<span class="op">-&gt;</span>first<span class="op">;</span></span>
<span id="cb71-26"><a href="#cb71-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb71-27"><a href="#cb71-27" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb71-28"><a href="#cb71-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-29"><a href="#cb71-29" aria-hidden="true" tabindex="-1"></a><span class="co">// Special handling for -nodes at block entry</span></span>
<span id="cb71-30"><a href="#cb71-30" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> enter_block<span class="op">(</span>ExecutionContext <span class="op">*</span>ctx<span class="op">,</span> BasicBlock <span class="op">*</span>block<span class="op">)</span> <span class="op">{</span></span>
<span id="cb71-31"><a href="#cb71-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Execute all -nodes at block entry</span></span>
<span id="cb71-32"><a href="#cb71-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>ISSAInstruction <span class="op">*</span>inst <span class="op">=</span> block<span class="op">-&gt;</span>first<span class="op">;</span> </span>
<span id="cb71-33"><a href="#cb71-33" aria-hidden="true" tabindex="-1"></a>         inst <span class="op">&amp;&amp;</span> inst<span class="op">-&gt;</span>kind <span class="op">==</span> INST_PHI<span class="op">;</span> </span>
<span id="cb71-34"><a href="#cb71-34" aria-hidden="true" tabindex="-1"></a>         inst <span class="op">=</span> inst<span class="op">-&gt;</span>base<span class="op">.</span>next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb71-35"><a href="#cb71-35" aria-hidden="true" tabindex="-1"></a>        inst<span class="op">-&gt;</span>execute<span class="op">(</span>inst<span class="op">,</span> ctx<span class="op">);</span></span>
<span id="cb71-36"><a href="#cb71-36" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb71-37"><a href="#cb71-37" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>6.8 Optimization for Interpretation</h2>
<p>ISSA includes several optimizations specifically for
interpretation:</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Instruction fusion for common patterns</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> FusedInstruction <span class="op">{</span></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>    ISSAInstruction base<span class="op">;</span></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Fused operation (e.g., LOAD + ADD + STORE)</span></span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>    ISSAInstruction <span class="op">**</span>fused_ops<span class="op">;</span></span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> op_count<span class="op">;</span></span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> FusedInstruction<span class="op">;</span></span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> optimize_for_interpretation<span class="op">(</span>Function <span class="op">*</span>func<span class="op">)</span> <span class="op">{</span></span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Instruction fusion</span></span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a>    fuse_common_patterns<span class="op">(</span>func<span class="op">);</span></span>
<span id="cb72-13"><a href="#cb72-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb72-14"><a href="#cb72-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// -node specialization</span></span>
<span id="cb72-15"><a href="#cb72-15" aria-hidden="true" tabindex="-1"></a>    specialize_phi_nodes<span class="op">(</span>func<span class="op">);</span></span>
<span id="cb72-16"><a href="#cb72-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb72-17"><a href="#cb72-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Memory operation coalescing</span></span>
<span id="cb72-18"><a href="#cb72-18" aria-hidden="true" tabindex="-1"></a>    coalesce_memory_ops<span class="op">(</span>func<span class="op">);</span></span>
<span id="cb72-19"><a href="#cb72-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb72-20"><a href="#cb72-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Inline small functions</span></span>
<span id="cb72-21"><a href="#cb72-21" aria-hidden="true" tabindex="-1"></a>    inline_small_functions<span class="op">(</span>func<span class="op">);</span></span>
<span id="cb72-22"><a href="#cb72-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb72-23"><a href="#cb72-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-24"><a href="#cb72-24" aria-hidden="true" tabindex="-1"></a><span class="co">// Specialize -nodes for common cases</span></span>
<span id="cb72-25"><a href="#cb72-25" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> specialize_phi_nodes<span class="op">(</span>Function <span class="op">*</span>func<span class="op">)</span> <span class="op">{</span></span>
<span id="cb72-26"><a href="#cb72-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> func<span class="op">-&gt;</span>cfg<span class="op">-&gt;</span>block_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb72-27"><a href="#cb72-27" aria-hidden="true" tabindex="-1"></a>        BasicBlock <span class="op">*</span>block <span class="op">=</span> func<span class="op">-&gt;</span>cfg<span class="op">-&gt;</span>blocks<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb72-28"><a href="#cb72-28" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb72-29"><a href="#cb72-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span>ISSAInstruction <span class="op">*</span>inst <span class="op">=</span> block<span class="op">-&gt;</span>first<span class="op">;</span> inst<span class="op">;</span> inst <span class="op">=</span> inst<span class="op">-&gt;</span>next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb72-30"><a href="#cb72-30" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>inst<span class="op">-&gt;</span>kind <span class="op">==</span> INST_PHI<span class="op">)</span> <span class="op">{</span></span>
<span id="cb72-31"><a href="#cb72-31" aria-hidden="true" tabindex="-1"></a>                PhiNode <span class="op">*</span>phi <span class="op">=</span> <span class="op">(</span>PhiNode<span class="op">*)</span>inst<span class="op">;</span></span>
<span id="cb72-32"><a href="#cb72-32" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb72-33"><a href="#cb72-33" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span>phi<span class="op">-&gt;</span>input_count <span class="op">==</span> <span class="dv">2</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb72-34"><a href="#cb72-34" aria-hidden="true" tabindex="-1"></a>                    <span class="co">// Binary -node - use specialized executor</span></span>
<span id="cb72-35"><a href="#cb72-35" aria-hidden="true" tabindex="-1"></a>                    inst<span class="op">-&gt;</span>execute <span class="op">=</span> execute_binary_phi<span class="op">;</span></span>
<span id="cb72-36"><a href="#cb72-36" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>all_inputs_same_value<span class="op">(</span>phi<span class="op">))</span> <span class="op">{</span></span>
<span id="cb72-37"><a href="#cb72-37" aria-hidden="true" tabindex="-1"></a>                    <span class="co">// Degenerate -node - replace with copy</span></span>
<span id="cb72-38"><a href="#cb72-38" aria-hidden="true" tabindex="-1"></a>                    replace_with_copy<span class="op">(</span>inst<span class="op">,</span> phi<span class="op">-&gt;</span>inputs<span class="op">[</span><span class="dv">0</span><span class="op">].</span>value<span class="op">);</span></span>
<span id="cb72-39"><a href="#cb72-39" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb72-40"><a href="#cb72-40" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb72-41"><a href="#cb72-41" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb72-42"><a href="#cb72-42" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb72-43"><a href="#cb72-43" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb72-44"><a href="#cb72-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-45"><a href="#cb72-45" aria-hidden="true" tabindex="-1"></a><span class="co">// Optimized binary -node execution</span></span>
<span id="cb72-46"><a href="#cb72-46" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> execute_binary_phi<span class="op">(</span>ISSAInstruction <span class="op">*</span>inst<span class="op">,</span> ExecutionContext <span class="op">*</span>ctx<span class="op">)</span> <span class="op">{</span></span>
<span id="cb72-47"><a href="#cb72-47" aria-hidden="true" tabindex="-1"></a>    PhiNode <span class="op">*</span>phi <span class="op">=</span> <span class="op">(</span>PhiNode<span class="op">*)</span>inst<span class="op">;</span></span>
<span id="cb72-48"><a href="#cb72-48" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb72-49"><a href="#cb72-49" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Fast path for binary -nodes</span></span>
<span id="cb72-50"><a href="#cb72-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>ctx<span class="op">-&gt;</span>last_block_id <span class="op">==</span> phi<span class="op">-&gt;</span>inputs<span class="op">[</span><span class="dv">0</span><span class="op">].</span>block_id<span class="op">)</span> <span class="op">{</span></span>
<span id="cb72-51"><a href="#cb72-51" aria-hidden="true" tabindex="-1"></a>        copy_value<span class="op">(</span>inst<span class="op">-&gt;</span>exec<span class="op">.</span>output<span class="op">,</span> phi<span class="op">-&gt;</span>inputs<span class="op">[</span><span class="dv">0</span><span class="op">].</span>value<span class="op">);</span></span>
<span id="cb72-52"><a href="#cb72-52" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb72-53"><a href="#cb72-53" aria-hidden="true" tabindex="-1"></a>        copy_value<span class="op">(</span>inst<span class="op">-&gt;</span>exec<span class="op">.</span>output<span class="op">,</span> phi<span class="op">-&gt;</span>inputs<span class="op">[</span><span class="dv">1</span><span class="op">].</span>value<span class="op">);</span></span>
<span id="cb72-54"><a href="#cb72-54" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb72-55"><a href="#cb72-55" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb72-56"><a href="#cb72-56" aria-hidden="true" tabindex="-1"></a>    ctx<span class="op">-&gt;</span>stats<span class="op">.</span>phi_executed<span class="op">++;</span></span>
<span id="cb72-57"><a href="#cb72-57" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>6.9 Type Safety in ISSA</h2>
<p>ISSA maintains type safety during interpretation:</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> TypeInfo <span class="op">{</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>    TypeKind kind<span class="op">;</span></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> size<span class="op">;</span></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> alignment<span class="op">;</span></span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// For compound types</span></span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">union</span> <span class="op">{</span></span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a>            TypeInfo <span class="op">*</span>element_type<span class="op">;</span></span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a>            <span class="dt">size_t</span> length<span class="op">;</span></span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> array<span class="op">;</span></span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true" tabindex="-1"></a>            TypeInfo <span class="op">**</span>field_types<span class="op">;</span></span>
<span id="cb73-15"><a href="#cb73-15" aria-hidden="true" tabindex="-1"></a>            <span class="dt">char</span> <span class="op">**</span>field_names<span class="op">;</span></span>
<span id="cb73-16"><a href="#cb73-16" aria-hidden="true" tabindex="-1"></a>            <span class="dt">size_t</span> field_count<span class="op">;</span></span>
<span id="cb73-17"><a href="#cb73-17" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> struct_type<span class="op">;</span></span>
<span id="cb73-18"><a href="#cb73-18" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb73-19"><a href="#cb73-19" aria-hidden="true" tabindex="-1"></a>        <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb73-20"><a href="#cb73-20" aria-hidden="true" tabindex="-1"></a>            TypeInfo <span class="op">*</span>return_type<span class="op">;</span></span>
<span id="cb73-21"><a href="#cb73-21" aria-hidden="true" tabindex="-1"></a>            TypeInfo <span class="op">**</span>param_types<span class="op">;</span></span>
<span id="cb73-22"><a href="#cb73-22" aria-hidden="true" tabindex="-1"></a>            <span class="dt">size_t</span> param_count<span class="op">;</span></span>
<span id="cb73-23"><a href="#cb73-23" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> function<span class="op">;</span></span>
<span id="cb73-24"><a href="#cb73-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> data<span class="op">;</span></span>
<span id="cb73-25"><a href="#cb73-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-26"><a href="#cb73-26" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Runtime type checking</span></span>
<span id="cb73-27"><a href="#cb73-27" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> <span class="op">(*</span>check_value<span class="op">)(</span>ISSAValue <span class="op">*</span>val<span class="op">,</span> TypeInfo <span class="op">*</span>expected<span class="op">);</span></span>
<span id="cb73-28"><a href="#cb73-28" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> TypeInfo<span class="op">;</span></span>
<span id="cb73-29"><a href="#cb73-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-30"><a href="#cb73-30" aria-hidden="true" tabindex="-1"></a><span class="co">// Type-checked operations</span></span>
<span id="cb73-31"><a href="#cb73-31" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> execute_typed_operation<span class="op">(</span>ISSAInstruction <span class="op">*</span>inst<span class="op">,</span> </span>
<span id="cb73-32"><a href="#cb73-32" aria-hidden="true" tabindex="-1"></a>                                  ExecutionContext <span class="op">*</span>ctx<span class="op">)</span> <span class="op">{</span></span>
<span id="cb73-33"><a href="#cb73-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Verify input types</span></span>
<span id="cb73-34"><a href="#cb73-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> inst<span class="op">-&gt;</span>exec<span class="op">.</span>input_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb73-35"><a href="#cb73-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(!</span>check_value_type<span class="op">(</span>inst<span class="op">-&gt;</span>exec<span class="op">.</span>inputs<span class="op">[</span>i<span class="op">],</span> </span>
<span id="cb73-36"><a href="#cb73-36" aria-hidden="true" tabindex="-1"></a>                            inst<span class="op">-&gt;</span>type<span class="op">-&gt;</span>data<span class="op">.</span>function<span class="op">.</span>param_types<span class="op">[</span>i<span class="op">]))</span> <span class="op">{</span></span>
<span id="cb73-37"><a href="#cb73-37" aria-hidden="true" tabindex="-1"></a>            runtime_error<span class="op">(</span>ctx<span class="op">,</span> <span class="st">&quot;Type mismatch in operation </span><span class="sc">%s</span><span class="st">&quot;</span><span class="op">,</span> </span>
<span id="cb73-38"><a href="#cb73-38" aria-hidden="true" tabindex="-1"></a>                         instruction_name<span class="op">(</span>inst<span class="op">-&gt;</span>kind<span class="op">));</span></span>
<span id="cb73-39"><a href="#cb73-39" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span><span class="op">;</span></span>
<span id="cb73-40"><a href="#cb73-40" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb73-41"><a href="#cb73-41" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb73-42"><a href="#cb73-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-43"><a href="#cb73-43" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Execute operation</span></span>
<span id="cb73-44"><a href="#cb73-44" aria-hidden="true" tabindex="-1"></a>    inst<span class="op">-&gt;</span>execute<span class="op">(</span>inst<span class="op">,</span> ctx<span class="op">);</span></span>
<span id="cb73-45"><a href="#cb73-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-46"><a href="#cb73-46" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Verify output type</span></span>
<span id="cb73-47"><a href="#cb73-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>check_value_type<span class="op">(</span>inst<span class="op">-&gt;</span>exec<span class="op">.</span>output<span class="op">,</span> </span>
<span id="cb73-48"><a href="#cb73-48" aria-hidden="true" tabindex="-1"></a>                        inst<span class="op">-&gt;</span>type<span class="op">-&gt;</span>data<span class="op">.</span>function<span class="op">.</span>return_type<span class="op">))</span> <span class="op">{</span></span>
<span id="cb73-49"><a href="#cb73-49" aria-hidden="true" tabindex="-1"></a>        runtime_error<span class="op">(</span>ctx<span class="op">,</span> <span class="st">&quot;Invalid output type from </span><span class="sc">%s</span><span class="st">&quot;</span><span class="op">,</span> </span>
<span id="cb73-50"><a href="#cb73-50" aria-hidden="true" tabindex="-1"></a>                     instruction_name<span class="op">(</span>inst<span class="op">-&gt;</span>kind<span class="op">));</span></span>
<span id="cb73-51"><a href="#cb73-51" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb73-52"><a href="#cb73-52" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>6.10 ISSA Construction Algorithm</h2>
<p>Converting standard SSA to ISSA:</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> ISSABuilder <span class="op">{</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>    CFG <span class="op">*</span>input_cfg<span class="op">;</span></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>    Function <span class="op">*</span>output_func<span class="op">;</span></span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Mapping from SSA values to ISSA values</span></span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>    ValueMap <span class="op">*</span>value_map<span class="op">;</span></span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Memory version tracking</span></span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a>    ISSAValue <span class="op">*</span>current_memory<span class="op">;</span></span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Statistics</span></span>
<span id="cb74-12"><a href="#cb74-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> instructions_converted<span class="op">;</span></span>
<span id="cb74-13"><a href="#cb74-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> phi_nodes_converted<span class="op">;</span></span>
<span id="cb74-14"><a href="#cb74-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> memory_phis_inserted<span class="op">;</span></span>
<span id="cb74-15"><a href="#cb74-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> ISSABuilder<span class="op">;</span></span>
<span id="cb74-16"><a href="#cb74-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-17"><a href="#cb74-17" aria-hidden="true" tabindex="-1"></a>Function<span class="op">*</span> build_issa<span class="op">(</span>CFG <span class="op">*</span>cfg<span class="op">)</span> <span class="op">{</span></span>
<span id="cb74-18"><a href="#cb74-18" aria-hidden="true" tabindex="-1"></a>    ISSABuilder builder <span class="op">=</span> <span class="op">{</span><span class="dv">0</span><span class="op">};</span></span>
<span id="cb74-19"><a href="#cb74-19" aria-hidden="true" tabindex="-1"></a>    builder<span class="op">.</span>input_cfg <span class="op">=</span> cfg<span class="op">;</span></span>
<span id="cb74-20"><a href="#cb74-20" aria-hidden="true" tabindex="-1"></a>    builder<span class="op">.</span>value_map <span class="op">=</span> valuemap_new<span class="op">();</span></span>
<span id="cb74-21"><a href="#cb74-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-22"><a href="#cb74-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Create function</span></span>
<span id="cb74-23"><a href="#cb74-23" aria-hidden="true" tabindex="-1"></a>    builder<span class="op">.</span>output_func <span class="op">=</span> create_issa_function<span class="op">(</span>cfg<span class="op">-&gt;</span>function<span class="op">);</span></span>
<span id="cb74-24"><a href="#cb74-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-25"><a href="#cb74-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Convert basic blocks</span></span>
<span id="cb74-26"><a href="#cb74-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> cfg<span class="op">-&gt;</span>block_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb74-27"><a href="#cb74-27" aria-hidden="true" tabindex="-1"></a>        convert_block<span class="op">(&amp;</span>builder<span class="op">,</span> cfg<span class="op">-&gt;</span>blocks<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb74-28"><a href="#cb74-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb74-29"><a href="#cb74-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-30"><a href="#cb74-30" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Set up -node selectors</span></span>
<span id="cb74-31"><a href="#cb74-31" aria-hidden="true" tabindex="-1"></a>    setup_phi_selectors<span class="op">(&amp;</span>builder<span class="op">);</span></span>
<span id="cb74-32"><a href="#cb74-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-33"><a href="#cb74-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Optimize for interpretation</span></span>
<span id="cb74-34"><a href="#cb74-34" aria-hidden="true" tabindex="-1"></a>    optimize_for_interpretation<span class="op">(</span>builder<span class="op">.</span>output_func<span class="op">);</span></span>
<span id="cb74-35"><a href="#cb74-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-36"><a href="#cb74-36" aria-hidden="true" tabindex="-1"></a>    valuemap_free<span class="op">(</span>builder<span class="op">.</span>value_map<span class="op">);</span></span>
<span id="cb74-37"><a href="#cb74-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> builder<span class="op">.</span>output_func<span class="op">;</span></span>
<span id="cb74-38"><a href="#cb74-38" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb74-39"><a href="#cb74-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-40"><a href="#cb74-40" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> convert_block<span class="op">(</span>ISSABuilder <span class="op">*</span>builder<span class="op">,</span> BasicBlock <span class="op">*</span>block<span class="op">)</span> <span class="op">{</span></span>
<span id="cb74-41"><a href="#cb74-41" aria-hidden="true" tabindex="-1"></a>    BasicBlock <span class="op">*</span>issa_block <span class="op">=</span> create_issa_block<span class="op">(</span>block<span class="op">);</span></span>
<span id="cb74-42"><a href="#cb74-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-43"><a href="#cb74-43" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Convert -nodes first</span></span>
<span id="cb74-44"><a href="#cb74-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>Instruction <span class="op">*</span>inst <span class="op">=</span> block<span class="op">-&gt;</span>first<span class="op">;</span> </span>
<span id="cb74-45"><a href="#cb74-45" aria-hidden="true" tabindex="-1"></a>         inst <span class="op">&amp;&amp;</span> inst<span class="op">-&gt;</span>kind <span class="op">==</span> INST_PHI<span class="op">;</span> </span>
<span id="cb74-46"><a href="#cb74-46" aria-hidden="true" tabindex="-1"></a>         inst <span class="op">=</span> inst<span class="op">-&gt;</span>next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb74-47"><a href="#cb74-47" aria-hidden="true" tabindex="-1"></a>        ISSAInstruction <span class="op">*</span>issa_phi <span class="op">=</span> convert_phi_node<span class="op">(</span>builder<span class="op">,</span> inst<span class="op">);</span></span>
<span id="cb74-48"><a href="#cb74-48" aria-hidden="true" tabindex="-1"></a>        append_instruction<span class="op">(</span>issa_block<span class="op">,</span> issa_phi<span class="op">);</span></span>
<span id="cb74-49"><a href="#cb74-49" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb74-50"><a href="#cb74-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-51"><a href="#cb74-51" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Convert other instructions</span></span>
<span id="cb74-52"><a href="#cb74-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>Instruction <span class="op">*</span>inst <span class="op">=</span> block<span class="op">-&gt;</span>first<span class="op">;</span> inst<span class="op">;</span> inst <span class="op">=</span> inst<span class="op">-&gt;</span>next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb74-53"><a href="#cb74-53" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>inst<span class="op">-&gt;</span>kind <span class="op">==</span> INST_PHI<span class="op">)</span> <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb74-54"><a href="#cb74-54" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb74-55"><a href="#cb74-55" aria-hidden="true" tabindex="-1"></a>        ISSAInstruction <span class="op">*</span>issa_inst <span class="op">=</span> convert_instruction<span class="op">(</span>builder<span class="op">,</span> inst<span class="op">);</span></span>
<span id="cb74-56"><a href="#cb74-56" aria-hidden="true" tabindex="-1"></a>        append_instruction<span class="op">(</span>issa_block<span class="op">,</span> issa_inst<span class="op">);</span></span>
<span id="cb74-57"><a href="#cb74-57" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb74-58"><a href="#cb74-58" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb74-59"><a href="#cb74-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-60"><a href="#cb74-60" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> ISSAInstruction<span class="op">*</span> convert_phi_node<span class="op">(</span>ISSABuilder <span class="op">*</span>builder<span class="op">,</span> </span>
<span id="cb74-61"><a href="#cb74-61" aria-hidden="true" tabindex="-1"></a>                                       Instruction <span class="op">*</span>phi<span class="op">)</span> <span class="op">{</span></span>
<span id="cb74-62"><a href="#cb74-62" aria-hidden="true" tabindex="-1"></a>    PhiNode <span class="op">*</span>issa_phi <span class="op">=</span> calloc<span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>PhiNode<span class="op">));</span></span>
<span id="cb74-63"><a href="#cb74-63" aria-hidden="true" tabindex="-1"></a>    issa_phi<span class="op">-&gt;</span>base<span class="op">.</span>kind <span class="op">=</span> INST_PHI<span class="op">;</span></span>
<span id="cb74-64"><a href="#cb74-64" aria-hidden="true" tabindex="-1"></a>    issa_phi<span class="op">-&gt;</span>base<span class="op">.</span>execute <span class="op">=</span> execute_phi<span class="op">;</span></span>
<span id="cb74-65"><a href="#cb74-65" aria-hidden="true" tabindex="-1"></a>    issa_phi<span class="op">-&gt;</span>selector <span class="op">=</span> select_phi_input<span class="op">;</span></span>
<span id="cb74-66"><a href="#cb74-66" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-67"><a href="#cb74-67" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Convert inputs</span></span>
<span id="cb74-68"><a href="#cb74-68" aria-hidden="true" tabindex="-1"></a>    issa_phi<span class="op">-&gt;</span>input_count <span class="op">=</span> phi<span class="op">-&gt;</span>data<span class="op">.</span>phi<span class="op">.</span>incoming_count<span class="op">;</span></span>
<span id="cb74-69"><a href="#cb74-69" aria-hidden="true" tabindex="-1"></a>    issa_phi<span class="op">-&gt;</span>inputs <span class="op">=</span> calloc<span class="op">(</span>issa_phi<span class="op">-&gt;</span>input_count<span class="op">,</span> </span>
<span id="cb74-70"><a href="#cb74-70" aria-hidden="true" tabindex="-1"></a>                            <span class="kw">sizeof</span><span class="op">(</span>issa_phi<span class="op">-&gt;</span>inputs<span class="op">[</span><span class="dv">0</span><span class="op">]));</span></span>
<span id="cb74-71"><a href="#cb74-71" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-72"><a href="#cb74-72" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> issa_phi<span class="op">-&gt;</span>input_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb74-73"><a href="#cb74-73" aria-hidden="true" tabindex="-1"></a>        issa_phi<span class="op">-&gt;</span>inputs<span class="op">[</span>i<span class="op">].</span>block <span class="op">=</span> phi<span class="op">-&gt;</span>data<span class="op">.</span>phi<span class="op">.</span>incoming_blocks<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb74-74"><a href="#cb74-74" aria-hidden="true" tabindex="-1"></a>        issa_phi<span class="op">-&gt;</span>inputs<span class="op">[</span>i<span class="op">].</span>block_id <span class="op">=</span> phi<span class="op">-&gt;</span>data<span class="op">.</span>phi<span class="op">.</span>incoming_blocks<span class="op">[</span>i<span class="op">]-&gt;</span>id<span class="op">;</span></span>
<span id="cb74-75"><a href="#cb74-75" aria-hidden="true" tabindex="-1"></a>        issa_phi<span class="op">-&gt;</span>inputs<span class="op">[</span>i<span class="op">].</span>value <span class="op">=</span> convert_value<span class="op">(</span>builder<span class="op">,</span> </span>
<span id="cb74-76"><a href="#cb74-76" aria-hidden="true" tabindex="-1"></a>            phi<span class="op">-&gt;</span>data<span class="op">.</span>phi<span class="op">.</span>incoming_values<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb74-77"><a href="#cb74-77" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb74-78"><a href="#cb74-78" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-79"><a href="#cb74-79" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Create output value</span></span>
<span id="cb74-80"><a href="#cb74-80" aria-hidden="true" tabindex="-1"></a>    issa_phi<span class="op">-&gt;</span>base<span class="op">.</span>exec<span class="op">.</span>output <span class="op">=</span> create_issa_value<span class="op">(</span>phi<span class="op">-&gt;</span>result<span class="op">-&gt;</span>type<span class="op">);</span></span>
<span id="cb74-81"><a href="#cb74-81" aria-hidden="true" tabindex="-1"></a>    valuemap_put<span class="op">(</span>builder<span class="op">-&gt;</span>value_map<span class="op">,</span> phi<span class="op">-&gt;</span>result<span class="op">,</span> issa_phi<span class="op">-&gt;</span>base<span class="op">.</span>exec<span class="op">.</span>output<span class="op">);</span></span>
<span id="cb74-82"><a href="#cb74-82" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-83"><a href="#cb74-83" aria-hidden="true" tabindex="-1"></a>    builder<span class="op">-&gt;</span>phi_nodes_converted<span class="op">++;</span></span>
<span id="cb74-84"><a href="#cb74-84" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">&amp;</span>issa_phi<span class="op">-&gt;</span>base<span class="op">;</span></span>
<span id="cb74-85"><a href="#cb74-85" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>6.11 Performance Characteristics</h2>
<p>ISSA&#39;s design yields specific performance characteristics:</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Performance monitoring</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> ISSAPerformance <span class="op">{</span></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Instruction execution counts</span></span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint64_t</span> <span class="op">*</span>instruction_counts<span class="op">;</span></span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Hot path detection</span></span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> HotPath <span class="op">{</span></span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a>        BasicBlock <span class="op">**</span>blocks<span class="op">;</span></span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a>        <span class="dt">size_t</span> length<span class="op">;</span></span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint64_t</span> execution_count<span class="op">;</span></span>
<span id="cb75-11"><a href="#cb75-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="op">*</span>hot_paths<span class="op">;</span></span>
<span id="cb75-12"><a href="#cb75-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> hot_path_count<span class="op">;</span></span>
<span id="cb75-13"><a href="#cb75-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb75-14"><a href="#cb75-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// -node execution patterns</span></span>
<span id="cb75-15"><a href="#cb75-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb75-16"><a href="#cb75-16" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint64_t</span> binary_phi<span class="op">;</span></span>
<span id="cb75-17"><a href="#cb75-17" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint64_t</span> multi_phi<span class="op">;</span></span>
<span id="cb75-18"><a href="#cb75-18" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint64_t</span> memory_phi<span class="op">;</span></span>
<span id="cb75-19"><a href="#cb75-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> phi_stats<span class="op">;</span></span>
<span id="cb75-20"><a href="#cb75-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb75-21"><a href="#cb75-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Cache behavior</span></span>
<span id="cb75-22"><a href="#cb75-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb75-23"><a href="#cb75-23" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint64_t</span> value_cache_hits<span class="op">;</span></span>
<span id="cb75-24"><a href="#cb75-24" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint64_t</span> value_cache_misses<span class="op">;</span></span>
<span id="cb75-25"><a href="#cb75-25" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint64_t</span> instruction_cache_hits<span class="op">;</span></span>
<span id="cb75-26"><a href="#cb75-26" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint64_t</span> instruction_cache_misses<span class="op">;</span></span>
<span id="cb75-27"><a href="#cb75-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> cache_stats<span class="op">;</span></span>
<span id="cb75-28"><a href="#cb75-28" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> ISSAPerformance<span class="op">;</span></span>
<span id="cb75-29"><a href="#cb75-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-30"><a href="#cb75-30" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> profile_issa_execution<span class="op">(</span>ExecutionContext <span class="op">*</span>ctx<span class="op">,</span> ISSAPerformance <span class="op">*</span>perf<span class="op">)</span> <span class="op">{</span></span>
<span id="cb75-31"><a href="#cb75-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Instrument execution</span></span>
<span id="cb75-32"><a href="#cb75-32" aria-hidden="true" tabindex="-1"></a>    ctx<span class="op">-&gt;</span>profiling_enabled <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb75-33"><a href="#cb75-33" aria-hidden="true" tabindex="-1"></a>    ctx<span class="op">-&gt;</span>performance <span class="op">=</span> perf<span class="op">;</span></span>
<span id="cb75-34"><a href="#cb75-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb75-35"><a href="#cb75-35" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Track hot paths</span></span>
<span id="cb75-36"><a href="#cb75-36" aria-hidden="true" tabindex="-1"></a>    track_execution_paths<span class="op">(</span>ctx<span class="op">);</span></span>
<span id="cb75-37"><a href="#cb75-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb75-38"><a href="#cb75-38" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Monitor -node patterns</span></span>
<span id="cb75-39"><a href="#cb75-39" aria-hidden="true" tabindex="-1"></a>    analyze_phi_patterns<span class="op">(</span>ctx<span class="op">);</span></span>
<span id="cb75-40"><a href="#cb75-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb75-41"><a href="#cb75-41" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Measure cache effectiveness</span></span>
<span id="cb75-42"><a href="#cb75-42" aria-hidden="true" tabindex="-1"></a>    measure_cache_behavior<span class="op">(</span>ctx<span class="op">);</span></span>
<span id="cb75-43"><a href="#cb75-43" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb75-44"><a href="#cb75-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-45"><a href="#cb75-45" aria-hidden="true" tabindex="-1"></a><span class="co">// Adaptive optimization based on profiling</span></span>
<span id="cb75-46"><a href="#cb75-46" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> adaptive_optimize_issa<span class="op">(</span>Function <span class="op">*</span>func<span class="op">,</span> ISSAPerformance <span class="op">*</span>perf<span class="op">)</span> <span class="op">{</span></span>
<span id="cb75-47"><a href="#cb75-47" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Specialize hot -nodes</span></span>
<span id="cb75-48"><a href="#cb75-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> func<span class="op">-&gt;</span>cfg<span class="op">-&gt;</span>block_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb75-49"><a href="#cb75-49" aria-hidden="true" tabindex="-1"></a>        BasicBlock <span class="op">*</span>block <span class="op">=</span> func<span class="op">-&gt;</span>cfg<span class="op">-&gt;</span>blocks<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb75-50"><a href="#cb75-50" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>is_hot_block<span class="op">(</span>block<span class="op">,</span> perf<span class="op">))</span> <span class="op">{</span></span>
<span id="cb75-51"><a href="#cb75-51" aria-hidden="true" tabindex="-1"></a>            specialize_hot_phi_nodes<span class="op">(</span>block<span class="op">,</span> perf<span class="op">);</span></span>
<span id="cb75-52"><a href="#cb75-52" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb75-53"><a href="#cb75-53" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb75-54"><a href="#cb75-54" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb75-55"><a href="#cb75-55" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Inline hot paths</span></span>
<span id="cb75-56"><a href="#cb75-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> perf<span class="op">-&gt;</span>hot_path_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb75-57"><a href="#cb75-57" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>perf<span class="op">-&gt;</span>hot_paths<span class="op">[</span>i<span class="op">].</span>execution_count <span class="op">&gt;</span> HOT_PATH_THRESHOLD<span class="op">)</span> <span class="op">{</span></span>
<span id="cb75-58"><a href="#cb75-58" aria-hidden="true" tabindex="-1"></a>            inline_hot_path<span class="op">(&amp;</span>perf<span class="op">-&gt;</span>hot_paths<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb75-59"><a href="#cb75-59" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb75-60"><a href="#cb75-60" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb75-61"><a href="#cb75-61" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>6.12 Comparison with Traditional SSA</h2>
<p>ISSA differs from traditional SSA in several ways:</p>
<p>| Aspect | Traditional SSA | ISSA |
|--------|----------------|------| | -nodes | Abstract merge |
Executable selection | | Memory | Not in SSA | Full memory SSA | |
Arrays | Indirect access | Functional updates | | Interpretation |
Requires lowering | Direct execution | | Type safety | Compile-time only
| Runtime + compile-time |</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Example: Traditional SSA vs ISSA for array access</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a><span class="co">// Traditional SSA:</span></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a><span class="co">//   %ptr = getelementptr %array, %index</span></span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a><span class="co">//   %val = load %ptr</span></span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a><span class="co">//</span></span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a><span class="co">// ISSA:</span></span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a><span class="co">//   %val = array.get %array, %index</span></span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a><span class="co">// Example: -node execution</span></span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Traditional SSA (requires resolution):</span></span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a><span class="co">//   %x = phi [%a, %bb1], [%b, %bb2]</span></span>
<span id="cb76-12"><a href="#cb76-12" aria-hidden="true" tabindex="-1"></a><span class="co">//</span></span>
<span id="cb76-13"><a href="#cb76-13" aria-hidden="true" tabindex="-1"></a><span class="co">// ISSA (direct execution):</span></span>
<span id="cb76-14"><a href="#cb76-14" aria-hidden="true" tabindex="-1"></a><span class="co">//   %x = phi [%a, %bb1], [%b, %bb2]  ; selector: last_block_id</span></span></code></pre></div>
<h2>6.13 Summary</h2>
<p>Interpretable SSA (ISSA) form extends traditional SSA with directly
executable semantics. Key innovations include:</p>
<ol type="1">
<li><strong>Executable -nodes</strong> that select inputs based on
control flow</li>
<li><strong>Memory SSA</strong> with functional array operations</li>
<li><strong>Tagged values</strong> optimized for interpretation</li>
<li><strong>Direct threading</strong> for efficient instruction
dispatch</li>
<li><strong>Type safety</strong> maintained at runtime</li>
<li><strong>Performance optimizations</strong> specific to
interpretation</li>
</ol>
<p>ISSA enables Diyrbal to combine the analytical power of SSA form with
efficient interpretation, avoiding the overhead of lowering SSA for
execution. This design is particularly effective for JIT compilation
scenarios where interpretation performance matters.</p>
<p>The next chapter will explore how type inference operates on this
ISSA representation.</p>
<h1>Chapter 7: SSA-Based Optimizations</h1>
<h2>7.1 Introduction</h2>
<p>SSA form enables powerful optimizations by making data flow explicit
and providing unique naming for values. This chapter explores the
optimization pipeline in Diyrbal, focusing on SSA-specific
transformations that leverage the properties of both traditional SSA and
our Interpretable SSA (ISSA) form.</p>
<p>The optimization framework operates in multiple phases:</p>
<ol type="1">
<li><strong>Early optimizations</strong> on initial SSA
construction</li>
<li><strong>Core SSA optimizations</strong> leveraging SSA
properties</li>
<li><strong>ISSA-specific optimizations</strong> for interpretation
efficiency</li>
<li><strong>Late optimizations</strong> before code generation</li>
</ol>
<h2>7.2 Optimization Framework Architecture</h2>
<div class="sourceCode" id="cb77"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> OptimizationPass <span class="op">{</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>name<span class="op">;</span></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>    OptimizationLevel min_level<span class="op">;</span></span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Pass execution function</span></span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> <span class="op">(*</span>execute<span class="op">)(</span>Function <span class="op">*</span>func<span class="op">,</span> OptimizationContext <span class="op">*</span>ctx<span class="op">);</span></span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Dependencies and ordering</span></span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">const</span> <span class="dt">char</span> <span class="op">**</span>requires<span class="op">;</span></span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">const</span> <span class="dt">char</span> <span class="op">**</span>invalidates<span class="op">;</span></span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb77-12"><a href="#cb77-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Pass-specific configuration</span></span>
<span id="cb77-13"><a href="#cb77-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span>config<span class="op">;</span></span>
<span id="cb77-14"><a href="#cb77-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb77-15"><a href="#cb77-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Statistics</span></span>
<span id="cb77-16"><a href="#cb77-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb77-17"><a href="#cb77-17" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint64_t</span> invocations<span class="op">;</span></span>
<span id="cb77-18"><a href="#cb77-18" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint64_t</span> transformations<span class="op">;</span></span>
<span id="cb77-19"><a href="#cb77-19" aria-hidden="true" tabindex="-1"></a>        <span class="dt">double</span> total_time<span class="op">;</span></span>
<span id="cb77-20"><a href="#cb77-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> stats<span class="op">;</span></span>
<span id="cb77-21"><a href="#cb77-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> OptimizationPass<span class="op">;</span></span>
<span id="cb77-22"><a href="#cb77-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-23"><a href="#cb77-23" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> OptimizationPipeline <span class="op">{</span></span>
<span id="cb77-24"><a href="#cb77-24" aria-hidden="true" tabindex="-1"></a>    OptimizationPass <span class="op">**</span>passes<span class="op">;</span></span>
<span id="cb77-25"><a href="#cb77-25" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> pass_count<span class="op">;</span></span>
<span id="cb77-26"><a href="#cb77-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb77-27"><a href="#cb77-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Global optimization context</span></span>
<span id="cb77-28"><a href="#cb77-28" aria-hidden="true" tabindex="-1"></a>    OptimizationContext <span class="op">*</span>ctx<span class="op">;</span></span>
<span id="cb77-29"><a href="#cb77-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb77-30"><a href="#cb77-30" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Pass manager state</span></span>
<span id="cb77-31"><a href="#cb77-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb77-32"><a href="#cb77-32" aria-hidden="true" tabindex="-1"></a>        <span class="dt">bool</span> <span class="op">*</span>completed<span class="op">;</span></span>
<span id="cb77-33"><a href="#cb77-33" aria-hidden="true" tabindex="-1"></a>        <span class="dt">bool</span> <span class="op">*</span>invalidated<span class="op">;</span></span>
<span id="cb77-34"><a href="#cb77-34" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> pass_state<span class="op">;</span></span>
<span id="cb77-35"><a href="#cb77-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb77-36"><a href="#cb77-36" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Optimization levels</span></span>
<span id="cb77-37"><a href="#cb77-37" aria-hidden="true" tabindex="-1"></a>    OptimizationLevel level<span class="op">;</span></span>
<span id="cb77-38"><a href="#cb77-38" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> OptimizationPipeline<span class="op">;</span></span>
<span id="cb77-39"><a href="#cb77-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-40"><a href="#cb77-40" aria-hidden="true" tabindex="-1"></a><span class="co">// Main optimization driver</span></span>
<span id="cb77-41"><a href="#cb77-41" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> optimize_ssa_function<span class="op">(</span>Function <span class="op">*</span>func<span class="op">,</span> OptimizationLevel level<span class="op">)</span> <span class="op">{</span></span>
<span id="cb77-42"><a href="#cb77-42" aria-hidden="true" tabindex="-1"></a>    OptimizationPipeline pipeline <span class="op">=</span> <span class="op">{</span><span class="dv">0</span><span class="op">};</span></span>
<span id="cb77-43"><a href="#cb77-43" aria-hidden="true" tabindex="-1"></a>    pipeline<span class="op">.</span>level <span class="op">=</span> level<span class="op">;</span></span>
<span id="cb77-44"><a href="#cb77-44" aria-hidden="true" tabindex="-1"></a>    pipeline<span class="op">.</span>ctx <span class="op">=</span> create_optimization_context<span class="op">(</span>func<span class="op">);</span></span>
<span id="cb77-45"><a href="#cb77-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb77-46"><a href="#cb77-46" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Register optimization passes</span></span>
<span id="cb77-47"><a href="#cb77-47" aria-hidden="true" tabindex="-1"></a>    register_early_passes<span class="op">(&amp;</span>pipeline<span class="op">);</span></span>
<span id="cb77-48"><a href="#cb77-48" aria-hidden="true" tabindex="-1"></a>    register_core_ssa_passes<span class="op">(&amp;</span>pipeline<span class="op">);</span></span>
<span id="cb77-49"><a href="#cb77-49" aria-hidden="true" tabindex="-1"></a>    register_issa_passes<span class="op">(&amp;</span>pipeline<span class="op">);</span></span>
<span id="cb77-50"><a href="#cb77-50" aria-hidden="true" tabindex="-1"></a>    register_late_passes<span class="op">(&amp;</span>pipeline<span class="op">);</span></span>
<span id="cb77-51"><a href="#cb77-51" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb77-52"><a href="#cb77-52" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Run passes to fixpoint</span></span>
<span id="cb77-53"><a href="#cb77-53" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> changed <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb77-54"><a href="#cb77-54" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> iteration <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb77-55"><a href="#cb77-55" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb77-56"><a href="#cb77-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span>changed <span class="op">&amp;&amp;</span> iteration <span class="op">&lt;</span> MAX_OPT_ITERATIONS<span class="op">)</span> <span class="op">{</span></span>
<span id="cb77-57"><a href="#cb77-57" aria-hidden="true" tabindex="-1"></a>        changed <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb77-58"><a href="#cb77-58" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb77-59"><a href="#cb77-59" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> pipeline<span class="op">.</span>pass_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb77-60"><a href="#cb77-60" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>should_run_pass<span class="op">(&amp;</span>pipeline<span class="op">,</span> i<span class="op">))</span> <span class="op">{</span></span>
<span id="cb77-61"><a href="#cb77-61" aria-hidden="true" tabindex="-1"></a>                <span class="dt">bool</span> pass_changed <span class="op">=</span> run_optimization_pass<span class="op">(&amp;</span>pipeline<span class="op">,</span> i<span class="op">,</span> func<span class="op">);</span></span>
<span id="cb77-62"><a href="#cb77-62" aria-hidden="true" tabindex="-1"></a>                changed <span class="op">|=</span> pass_changed<span class="op">;</span></span>
<span id="cb77-63"><a href="#cb77-63" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb77-64"><a href="#cb77-64" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span>pass_changed<span class="op">)</span> <span class="op">{</span></span>
<span id="cb77-65"><a href="#cb77-65" aria-hidden="true" tabindex="-1"></a>                    invalidate_dependent_passes<span class="op">(&amp;</span>pipeline<span class="op">,</span> i<span class="op">);</span></span>
<span id="cb77-66"><a href="#cb77-66" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb77-67"><a href="#cb77-67" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb77-68"><a href="#cb77-68" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb77-69"><a href="#cb77-69" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb77-70"><a href="#cb77-70" aria-hidden="true" tabindex="-1"></a>        iteration<span class="op">++;</span></span>
<span id="cb77-71"><a href="#cb77-71" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb77-72"><a href="#cb77-72" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb77-73"><a href="#cb77-73" aria-hidden="true" tabindex="-1"></a>    cleanup_optimization_context<span class="op">(</span>pipeline<span class="op">.</span>ctx<span class="op">);</span></span>
<span id="cb77-74"><a href="#cb77-74" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>7.3 Dead Code Elimination</h2>
<p>SSA form makes dead code elimination particularly effective:</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> DCEContext <span class="op">{</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>    BitSet <span class="op">*</span>live_values<span class="op">;</span></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>    BitSet <span class="op">*</span>live_instructions<span class="op">;</span></span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>    WorkList <span class="op">*</span>worklist<span class="op">;</span></span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Statistics</span></span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> dead_instructions<span class="op">;</span></span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> dead_phi_nodes<span class="op">;</span></span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> dead_memory_ops<span class="op">;</span></span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> DCEContext<span class="op">;</span></span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-12"><a href="#cb78-12" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> dead_code_elimination<span class="op">(</span>Function <span class="op">*</span>func<span class="op">,</span> OptimizationContext <span class="op">*</span>ctx<span class="op">)</span> <span class="op">{</span></span>
<span id="cb78-13"><a href="#cb78-13" aria-hidden="true" tabindex="-1"></a>    DCEContext dce <span class="op">=</span> <span class="op">{</span><span class="dv">0</span><span class="op">};</span></span>
<span id="cb78-14"><a href="#cb78-14" aria-hidden="true" tabindex="-1"></a>    dce<span class="op">.</span>live_values <span class="op">=</span> bitset_create<span class="op">(</span>func<span class="op">-&gt;</span>value_count<span class="op">);</span></span>
<span id="cb78-15"><a href="#cb78-15" aria-hidden="true" tabindex="-1"></a>    dce<span class="op">.</span>live_instructions <span class="op">=</span> bitset_create<span class="op">(</span>func<span class="op">-&gt;</span>instruction_count<span class="op">);</span></span>
<span id="cb78-16"><a href="#cb78-16" aria-hidden="true" tabindex="-1"></a>    dce<span class="op">.</span>worklist <span class="op">=</span> worklist_create<span class="op">();</span></span>
<span id="cb78-17"><a href="#cb78-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb78-18"><a href="#cb78-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Mark initially live instructions</span></span>
<span id="cb78-19"><a href="#cb78-19" aria-hidden="true" tabindex="-1"></a>    mark_essential_instructions<span class="op">(</span>func<span class="op">,</span> <span class="op">&amp;</span>dce<span class="op">);</span></span>
<span id="cb78-20"><a href="#cb78-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb78-21"><a href="#cb78-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Propagate liveness</span></span>
<span id="cb78-22"><a href="#cb78-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(!</span>worklist_empty<span class="op">(</span>dce<span class="op">.</span>worklist<span class="op">))</span> <span class="op">{</span></span>
<span id="cb78-23"><a href="#cb78-23" aria-hidden="true" tabindex="-1"></a>        Instruction <span class="op">*</span>inst <span class="op">=</span> worklist_pop<span class="op">(</span>dce<span class="op">.</span>worklist<span class="op">);</span></span>
<span id="cb78-24"><a href="#cb78-24" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb78-25"><a href="#cb78-25" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Mark instruction as live</span></span>
<span id="cb78-26"><a href="#cb78-26" aria-hidden="true" tabindex="-1"></a>        bitset_set<span class="op">(</span>dce<span class="op">.</span>live_instructions<span class="op">,</span> inst<span class="op">-&gt;</span>id<span class="op">);</span></span>
<span id="cb78-27"><a href="#cb78-27" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb78-28"><a href="#cb78-28" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Mark all operands as live</span></span>
<span id="cb78-29"><a href="#cb78-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> inst<span class="op">-&gt;</span>operand_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb78-30"><a href="#cb78-30" aria-hidden="true" tabindex="-1"></a>            Value <span class="op">*</span>operand <span class="op">=</span> inst<span class="op">-&gt;</span>operands<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb78-31"><a href="#cb78-31" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb78-32"><a href="#cb78-32" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(!</span>bitset_test<span class="op">(</span>dce<span class="op">.</span>live_values<span class="op">,</span> operand<span class="op">-&gt;</span>id<span class="op">))</span> <span class="op">{</span></span>
<span id="cb78-33"><a href="#cb78-33" aria-hidden="true" tabindex="-1"></a>                bitset_set<span class="op">(</span>dce<span class="op">.</span>live_values<span class="op">,</span> operand<span class="op">-&gt;</span>id<span class="op">);</span></span>
<span id="cb78-34"><a href="#cb78-34" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb78-35"><a href="#cb78-35" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Add defining instruction to worklist</span></span>
<span id="cb78-36"><a href="#cb78-36" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span>operand<span class="op">-&gt;</span>def_instruction<span class="op">)</span> <span class="op">{</span></span>
<span id="cb78-37"><a href="#cb78-37" aria-hidden="true" tabindex="-1"></a>                    worklist_push<span class="op">(</span>dce<span class="op">.</span>worklist<span class="op">,</span> operand<span class="op">-&gt;</span>def_instruction<span class="op">);</span></span>
<span id="cb78-38"><a href="#cb78-38" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb78-39"><a href="#cb78-39" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb78-40"><a href="#cb78-40" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb78-41"><a href="#cb78-41" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb78-42"><a href="#cb78-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb78-43"><a href="#cb78-43" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Remove dead instructions</span></span>
<span id="cb78-44"><a href="#cb78-44" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> changed <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb78-45"><a href="#cb78-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>BasicBlock <span class="op">*</span>block <span class="op">=</span> func<span class="op">-&gt;</span>cfg<span class="op">-&gt;</span>entry<span class="op">;</span> block<span class="op">;</span> block <span class="op">=</span> block<span class="op">-&gt;</span>next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb78-46"><a href="#cb78-46" aria-hidden="true" tabindex="-1"></a>        Instruction <span class="op">*</span>inst <span class="op">=</span> block<span class="op">-&gt;</span>first<span class="op">;</span></span>
<span id="cb78-47"><a href="#cb78-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> <span class="op">(</span>inst<span class="op">)</span> <span class="op">{</span></span>
<span id="cb78-48"><a href="#cb78-48" aria-hidden="true" tabindex="-1"></a>            Instruction <span class="op">*</span>next <span class="op">=</span> inst<span class="op">-&gt;</span>next<span class="op">;</span></span>
<span id="cb78-49"><a href="#cb78-49" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb78-50"><a href="#cb78-50" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(!</span>bitset_test<span class="op">(</span>dce<span class="op">.</span>live_instructions<span class="op">,</span> inst<span class="op">-&gt;</span>id<span class="op">))</span> <span class="op">{</span></span>
<span id="cb78-51"><a href="#cb78-51" aria-hidden="true" tabindex="-1"></a>                remove_instruction<span class="op">(</span>block<span class="op">,</span> inst<span class="op">);</span></span>
<span id="cb78-52"><a href="#cb78-52" aria-hidden="true" tabindex="-1"></a>                dce<span class="op">.</span>dead_instructions<span class="op">++;</span></span>
<span id="cb78-53"><a href="#cb78-53" aria-hidden="true" tabindex="-1"></a>                changed <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb78-54"><a href="#cb78-54" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb78-55"><a href="#cb78-55" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span>inst<span class="op">-&gt;</span>kind <span class="op">==</span> INST_PHI<span class="op">)</span> <span class="op">{</span></span>
<span id="cb78-56"><a href="#cb78-56" aria-hidden="true" tabindex="-1"></a>                    dce<span class="op">.</span>dead_phi_nodes<span class="op">++;</span></span>
<span id="cb78-57"><a href="#cb78-57" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb78-58"><a href="#cb78-58" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb78-59"><a href="#cb78-59" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb78-60"><a href="#cb78-60" aria-hidden="true" tabindex="-1"></a>            inst <span class="op">=</span> next<span class="op">;</span></span>
<span id="cb78-61"><a href="#cb78-61" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb78-62"><a href="#cb78-62" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb78-63"><a href="#cb78-63" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb78-64"><a href="#cb78-64" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Clean up empty blocks</span></span>
<span id="cb78-65"><a href="#cb78-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>changed<span class="op">)</span> <span class="op">{</span></span>
<span id="cb78-66"><a href="#cb78-66" aria-hidden="true" tabindex="-1"></a>        remove_empty_blocks<span class="op">(</span>func<span class="op">-&gt;</span>cfg<span class="op">);</span></span>
<span id="cb78-67"><a href="#cb78-67" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb78-68"><a href="#cb78-68" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb78-69"><a href="#cb78-69" aria-hidden="true" tabindex="-1"></a>    bitset_destroy<span class="op">(</span>dce<span class="op">.</span>live_values<span class="op">);</span></span>
<span id="cb78-70"><a href="#cb78-70" aria-hidden="true" tabindex="-1"></a>    bitset_destroy<span class="op">(</span>dce<span class="op">.</span>live_instructions<span class="op">);</span></span>
<span id="cb78-71"><a href="#cb78-71" aria-hidden="true" tabindex="-1"></a>    worklist_destroy<span class="op">(</span>dce<span class="op">.</span>worklist<span class="op">);</span></span>
<span id="cb78-72"><a href="#cb78-72" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb78-73"><a href="#cb78-73" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> changed<span class="op">;</span></span>
<span id="cb78-74"><a href="#cb78-74" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb78-75"><a href="#cb78-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-76"><a href="#cb78-76" aria-hidden="true" tabindex="-1"></a><span class="co">// Essential instructions that are always live</span></span>
<span id="cb78-77"><a href="#cb78-77" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> mark_essential_instructions<span class="op">(</span>Function <span class="op">*</span>func<span class="op">,</span> DCEContext <span class="op">*</span>dce<span class="op">)</span> <span class="op">{</span></span>
<span id="cb78-78"><a href="#cb78-78" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>BasicBlock <span class="op">*</span>block <span class="op">=</span> func<span class="op">-&gt;</span>cfg<span class="op">-&gt;</span>entry<span class="op">;</span> block<span class="op">;</span> block <span class="op">=</span> block<span class="op">-&gt;</span>next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb78-79"><a href="#cb78-79" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span>Instruction <span class="op">*</span>inst <span class="op">=</span> block<span class="op">-&gt;</span>first<span class="op">;</span> inst<span class="op">;</span> inst <span class="op">=</span> inst<span class="op">-&gt;</span>next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb78-80"><a href="#cb78-80" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>is_essential_instruction<span class="op">(</span>inst<span class="op">))</span> <span class="op">{</span></span>
<span id="cb78-81"><a href="#cb78-81" aria-hidden="true" tabindex="-1"></a>                worklist_push<span class="op">(</span>dce<span class="op">-&gt;</span>worklist<span class="op">,</span> inst<span class="op">);</span></span>
<span id="cb78-82"><a href="#cb78-82" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb78-83"><a href="#cb78-83" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb78-84"><a href="#cb78-84" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb78-85"><a href="#cb78-85" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb78-86"><a href="#cb78-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-87"><a href="#cb78-87" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">bool</span> is_essential_instruction<span class="op">(</span>Instruction <span class="op">*</span>inst<span class="op">)</span> <span class="op">{</span></span>
<span id="cb78-88"><a href="#cb78-88" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> <span class="op">(</span>inst<span class="op">-&gt;</span>kind<span class="op">)</span> <span class="op">{</span></span>
<span id="cb78-89"><a href="#cb78-89" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> INST_RET<span class="op">:</span></span>
<span id="cb78-90"><a href="#cb78-90" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> INST_BR<span class="op">:</span></span>
<span id="cb78-91"><a href="#cb78-91" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> INST_BR_COND<span class="op">:</span></span>
<span id="cb78-92"><a href="#cb78-92" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> INST_STORE<span class="op">:</span></span>
<span id="cb78-93"><a href="#cb78-93" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> INST_CALL<span class="op">:</span>  <span class="co">// Assuming calls have side effects</span></span>
<span id="cb78-94"><a href="#cb78-94" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb78-95"><a href="#cb78-95" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb78-96"><a href="#cb78-96" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> MEM_STORE<span class="op">:</span></span>
<span id="cb78-97"><a href="#cb78-97" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> MEM_ARRAY_SET<span class="op">:</span></span>
<span id="cb78-98"><a href="#cb78-98" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span>  <span class="co">// Memory operations are essential</span></span>
<span id="cb78-99"><a href="#cb78-99" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb78-100"><a href="#cb78-100" aria-hidden="true" tabindex="-1"></a>        <span class="cf">default</span><span class="op">:</span></span>
<span id="cb78-101"><a href="#cb78-101" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb78-102"><a href="#cb78-102" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb78-103"><a href="#cb78-103" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>7.4 Constant Propagation and Folding</h2>
<p>SSA&#39;s unique naming enables efficient constant propagation:</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> ConstantPropContext <span class="op">{</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Lattice values for each SSA value</span></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>    LatticeValue <span class="op">*</span>values<span class="op">;</span></span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> value_count<span class="op">;</span></span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// SSA edges worklist</span></span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>    WorkList <span class="op">*</span>ssa_edges<span class="op">;</span></span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// CFG edges worklist</span></span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true" tabindex="-1"></a>    WorkList <span class="op">*</span>cfg_edges<span class="op">;</span></span>
<span id="cb79-11"><a href="#cb79-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb79-12"><a href="#cb79-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Executable blocks</span></span>
<span id="cb79-13"><a href="#cb79-13" aria-hidden="true" tabindex="-1"></a>    BitSet <span class="op">*</span>executable_blocks<span class="op">;</span></span>
<span id="cb79-14"><a href="#cb79-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb79-15"><a href="#cb79-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Statistics</span></span>
<span id="cb79-16"><a href="#cb79-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> constants_propagated<span class="op">;</span></span>
<span id="cb79-17"><a href="#cb79-17" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> instructions_folded<span class="op">;</span></span>
<span id="cb79-18"><a href="#cb79-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> ConstantPropContext<span class="op">;</span></span>
<span id="cb79-19"><a href="#cb79-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-20"><a href="#cb79-20" aria-hidden="true" tabindex="-1"></a><span class="co">// Sparse Conditional Constant Propagation (SCCP)</span></span>
<span id="cb79-21"><a href="#cb79-21" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> sparse_conditional_constant_propagation<span class="op">(</span>Function <span class="op">*</span>func<span class="op">,</span> </span>
<span id="cb79-22"><a href="#cb79-22" aria-hidden="true" tabindex="-1"></a>                                            OptimizationContext <span class="op">*</span>ctx<span class="op">)</span> <span class="op">{</span></span>
<span id="cb79-23"><a href="#cb79-23" aria-hidden="true" tabindex="-1"></a>    ConstantPropContext sccp <span class="op">=</span> <span class="op">{</span><span class="dv">0</span><span class="op">};</span></span>
<span id="cb79-24"><a href="#cb79-24" aria-hidden="true" tabindex="-1"></a>    sccp<span class="op">.</span>values <span class="op">=</span> calloc<span class="op">(</span>func<span class="op">-&gt;</span>value_count<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>LatticeValue<span class="op">));</span></span>
<span id="cb79-25"><a href="#cb79-25" aria-hidden="true" tabindex="-1"></a>    sccp<span class="op">.</span>ssa_edges <span class="op">=</span> worklist_create<span class="op">();</span></span>
<span id="cb79-26"><a href="#cb79-26" aria-hidden="true" tabindex="-1"></a>    sccp<span class="op">.</span>cfg_edges <span class="op">=</span> worklist_create<span class="op">();</span></span>
<span id="cb79-27"><a href="#cb79-27" aria-hidden="true" tabindex="-1"></a>    sccp<span class="op">.</span>executable_blocks <span class="op">=</span> bitset_create<span class="op">(</span>func<span class="op">-&gt;</span>cfg<span class="op">-&gt;</span>block_count<span class="op">);</span></span>
<span id="cb79-28"><a href="#cb79-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb79-29"><a href="#cb79-29" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Initialize all values to TOP</span></span>
<span id="cb79-30"><a href="#cb79-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> func<span class="op">-&gt;</span>value_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb79-31"><a href="#cb79-31" aria-hidden="true" tabindex="-1"></a>        sccp<span class="op">.</span>values<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> LATTICE_TOP<span class="op">;</span></span>
<span id="cb79-32"><a href="#cb79-32" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb79-33"><a href="#cb79-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb79-34"><a href="#cb79-34" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Initialize function arguments</span></span>
<span id="cb79-35"><a href="#cb79-35" aria-hidden="true" tabindex="-1"></a>    initialize_arguments<span class="op">(&amp;</span>sccp<span class="op">,</span> func<span class="op">);</span></span>
<span id="cb79-36"><a href="#cb79-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb79-37"><a href="#cb79-37" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Mark entry block as executable</span></span>
<span id="cb79-38"><a href="#cb79-38" aria-hidden="true" tabindex="-1"></a>    worklist_push<span class="op">(</span>sccp<span class="op">.</span>cfg_edges<span class="op">,</span> func<span class="op">-&gt;</span>cfg<span class="op">-&gt;</span>entry<span class="op">);</span></span>
<span id="cb79-39"><a href="#cb79-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb79-40"><a href="#cb79-40" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Main SCCP algorithm</span></span>
<span id="cb79-41"><a href="#cb79-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(!</span>worklist_empty<span class="op">(</span>sccp<span class="op">.</span>cfg_edges<span class="op">)</span> <span class="op">||</span> <span class="op">!</span>worklist_empty<span class="op">(</span>sccp<span class="op">.</span>ssa_edges<span class="op">))</span> <span class="op">{</span></span>
<span id="cb79-42"><a href="#cb79-42" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Process CFG edges</span></span>
<span id="cb79-43"><a href="#cb79-43" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> <span class="op">(!</span>worklist_empty<span class="op">(</span>sccp<span class="op">.</span>cfg_edges<span class="op">))</span> <span class="op">{</span></span>
<span id="cb79-44"><a href="#cb79-44" aria-hidden="true" tabindex="-1"></a>            BasicBlock <span class="op">*</span>block <span class="op">=</span> worklist_pop<span class="op">(</span>sccp<span class="op">.</span>cfg_edges<span class="op">);</span></span>
<span id="cb79-45"><a href="#cb79-45" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb79-46"><a href="#cb79-46" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(!</span>bitset_test_and_set<span class="op">(</span>sccp<span class="op">.</span>executable_blocks<span class="op">,</span> block<span class="op">-&gt;</span>id<span class="op">))</span> <span class="op">{</span></span>
<span id="cb79-47"><a href="#cb79-47" aria-hidden="true" tabindex="-1"></a>                visit_block<span class="op">(&amp;</span>sccp<span class="op">,</span> block<span class="op">);</span></span>
<span id="cb79-48"><a href="#cb79-48" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb79-49"><a href="#cb79-49" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb79-50"><a href="#cb79-50" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb79-51"><a href="#cb79-51" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Process SSA edges</span></span>
<span id="cb79-52"><a href="#cb79-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> <span class="op">(!</span>worklist_empty<span class="op">(</span>sccp<span class="op">.</span>ssa_edges<span class="op">))</span> <span class="op">{</span></span>
<span id="cb79-53"><a href="#cb79-53" aria-hidden="true" tabindex="-1"></a>            Value <span class="op">*</span>value <span class="op">=</span> worklist_pop<span class="op">(</span>sccp<span class="op">.</span>ssa_edges<span class="op">);</span></span>
<span id="cb79-54"><a href="#cb79-54" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb79-55"><a href="#cb79-55" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> <span class="op">(</span>Use <span class="op">*</span>use <span class="op">=</span> value<span class="op">-&gt;</span>use_list<span class="op">;</span> use<span class="op">;</span> use <span class="op">=</span> use<span class="op">-&gt;</span>next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb79-56"><a href="#cb79-56" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span>bitset_test<span class="op">(</span>sccp<span class="op">.</span>executable_blocks<span class="op">,</span> </span>
<span id="cb79-57"><a href="#cb79-57" aria-hidden="true" tabindex="-1"></a>                               use<span class="op">-&gt;</span>instruction<span class="op">-&gt;</span>block<span class="op">-&gt;</span>id<span class="op">))</span> <span class="op">{</span></span>
<span id="cb79-58"><a href="#cb79-58" aria-hidden="true" tabindex="-1"></a>                    visit_instruction<span class="op">(&amp;</span>sccp<span class="op">,</span> use<span class="op">-&gt;</span>instruction<span class="op">);</span></span>
<span id="cb79-59"><a href="#cb79-59" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb79-60"><a href="#cb79-60" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb79-61"><a href="#cb79-61" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb79-62"><a href="#cb79-62" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb79-63"><a href="#cb79-63" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb79-64"><a href="#cb79-64" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Replace constants and fold instructions</span></span>
<span id="cb79-65"><a href="#cb79-65" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> changed <span class="op">=</span> apply_constant_propagation<span class="op">(</span>func<span class="op">,</span> <span class="op">&amp;</span>sccp<span class="op">);</span></span>
<span id="cb79-66"><a href="#cb79-66" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb79-67"><a href="#cb79-67" aria-hidden="true" tabindex="-1"></a>    cleanup_sccp_context<span class="op">(&amp;</span>sccp<span class="op">);</span></span>
<span id="cb79-68"><a href="#cb79-68" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> changed<span class="op">;</span></span>
<span id="cb79-69"><a href="#cb79-69" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb79-70"><a href="#cb79-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-71"><a href="#cb79-71" aria-hidden="true" tabindex="-1"></a><span class="co">// Lattice meet operation</span></span>
<span id="cb79-72"><a href="#cb79-72" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> LatticeValue lattice_meet<span class="op">(</span>LatticeValue a<span class="op">,</span> LatticeValue b<span class="op">)</span> <span class="op">{</span></span>
<span id="cb79-73"><a href="#cb79-73" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>a<span class="op">.</span>kind <span class="op">==</span> LATTICE_TOP<span class="op">)</span> <span class="cf">return</span> b<span class="op">;</span></span>
<span id="cb79-74"><a href="#cb79-74" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>b<span class="op">.</span>kind <span class="op">==</span> LATTICE_TOP<span class="op">)</span> <span class="cf">return</span> a<span class="op">;</span></span>
<span id="cb79-75"><a href="#cb79-75" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>a<span class="op">.</span>kind <span class="op">==</span> LATTICE_BOTTOM <span class="op">||</span> b<span class="op">.</span>kind <span class="op">==</span> LATTICE_BOTTOM<span class="op">)</span> <span class="op">{</span></span>
<span id="cb79-76"><a href="#cb79-76" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="op">(</span>LatticeValue<span class="op">){.</span>kind <span class="op">=</span> LATTICE_BOTTOM<span class="op">};</span></span>
<span id="cb79-77"><a href="#cb79-77" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb79-78"><a href="#cb79-78" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb79-79"><a href="#cb79-79" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Both are constants</span></span>
<span id="cb79-80"><a href="#cb79-80" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>values_equal<span class="op">(&amp;</span>a<span class="op">.</span>constant<span class="op">,</span> <span class="op">&amp;</span>b<span class="op">.</span>constant<span class="op">))</span> <span class="op">{</span></span>
<span id="cb79-81"><a href="#cb79-81" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> a<span class="op">;</span></span>
<span id="cb79-82"><a href="#cb79-82" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb79-83"><a href="#cb79-83" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb79-84"><a href="#cb79-84" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">(</span>LatticeValue<span class="op">){.</span>kind <span class="op">=</span> LATTICE_BOTTOM<span class="op">};</span></span>
<span id="cb79-85"><a href="#cb79-85" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb79-86"><a href="#cb79-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-87"><a href="#cb79-87" aria-hidden="true" tabindex="-1"></a><span class="co">// Visit -node with SCCP</span></span>
<span id="cb79-88"><a href="#cb79-88" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> visit_phi<span class="op">(</span>ConstantPropContext <span class="op">*</span>sccp<span class="op">,</span> PhiNode <span class="op">*</span>phi<span class="op">)</span> <span class="op">{</span></span>
<span id="cb79-89"><a href="#cb79-89" aria-hidden="true" tabindex="-1"></a>    LatticeValue result <span class="op">=</span> LATTICE_TOP<span class="op">;</span></span>
<span id="cb79-90"><a href="#cb79-90" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb79-91"><a href="#cb79-91" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Only consider executable predecessors</span></span>
<span id="cb79-92"><a href="#cb79-92" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> phi<span class="op">-&gt;</span>incoming_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb79-93"><a href="#cb79-93" aria-hidden="true" tabindex="-1"></a>        BasicBlock <span class="op">*</span>pred <span class="op">=</span> phi<span class="op">-&gt;</span>incoming_blocks<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb79-94"><a href="#cb79-94" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb79-95"><a href="#cb79-95" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>bitset_test<span class="op">(</span>sccp<span class="op">-&gt;</span>executable_blocks<span class="op">,</span> pred<span class="op">-&gt;</span>id<span class="op">))</span> <span class="op">{</span></span>
<span id="cb79-96"><a href="#cb79-96" aria-hidden="true" tabindex="-1"></a>            Value <span class="op">*</span>input <span class="op">=</span> phi<span class="op">-&gt;</span>incoming_values<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb79-97"><a href="#cb79-97" aria-hidden="true" tabindex="-1"></a>            LatticeValue input_val <span class="op">=</span> sccp<span class="op">-&gt;</span>values<span class="op">[</span>input<span class="op">-&gt;</span>id<span class="op">];</span></span>
<span id="cb79-98"><a href="#cb79-98" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb79-99"><a href="#cb79-99" aria-hidden="true" tabindex="-1"></a>            result <span class="op">=</span> lattice_meet<span class="op">(</span>result<span class="op">,</span> input_val<span class="op">);</span></span>
<span id="cb79-100"><a href="#cb79-100" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb79-101"><a href="#cb79-101" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>result<span class="op">.</span>kind <span class="op">==</span> LATTICE_BOTTOM<span class="op">)</span> <span class="op">{</span></span>
<span id="cb79-102"><a href="#cb79-102" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span>  <span class="co">// No need to continue</span></span>
<span id="cb79-103"><a href="#cb79-103" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb79-104"><a href="#cb79-104" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb79-105"><a href="#cb79-105" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb79-106"><a href="#cb79-106" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb79-107"><a href="#cb79-107" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Update -node result</span></span>
<span id="cb79-108"><a href="#cb79-108" aria-hidden="true" tabindex="-1"></a>    update_value<span class="op">(</span>sccp<span class="op">,</span> phi<span class="op">-&gt;</span>result<span class="op">,</span> result<span class="op">);</span></span>
<span id="cb79-109"><a href="#cb79-109" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb79-110"><a href="#cb79-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-111"><a href="#cb79-111" aria-hidden="true" tabindex="-1"></a><span class="co">// Constant folding for arithmetic operations</span></span>
<span id="cb79-112"><a href="#cb79-112" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> visit_arithmetic<span class="op">(</span>ConstantPropContext <span class="op">*</span>sccp<span class="op">,</span> Instruction <span class="op">*</span>inst<span class="op">)</span> <span class="op">{</span></span>
<span id="cb79-113"><a href="#cb79-113" aria-hidden="true" tabindex="-1"></a>    Value <span class="op">*</span>left <span class="op">=</span> inst<span class="op">-&gt;</span>operands<span class="op">[</span><span class="dv">0</span><span class="op">];</span></span>
<span id="cb79-114"><a href="#cb79-114" aria-hidden="true" tabindex="-1"></a>    Value <span class="op">*</span>right <span class="op">=</span> inst<span class="op">-&gt;</span>operands<span class="op">[</span><span class="dv">1</span><span class="op">];</span></span>
<span id="cb79-115"><a href="#cb79-115" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb79-116"><a href="#cb79-116" aria-hidden="true" tabindex="-1"></a>    LatticeValue left_val <span class="op">=</span> sccp<span class="op">-&gt;</span>values<span class="op">[</span>left<span class="op">-&gt;</span>id<span class="op">];</span></span>
<span id="cb79-117"><a href="#cb79-117" aria-hidden="true" tabindex="-1"></a>    LatticeValue right_val <span class="op">=</span> sccp<span class="op">-&gt;</span>values<span class="op">[</span>right<span class="op">-&gt;</span>id<span class="op">];</span></span>
<span id="cb79-118"><a href="#cb79-118" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb79-119"><a href="#cb79-119" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>left_val<span class="op">.</span>kind <span class="op">==</span> LATTICE_CONSTANT <span class="op">&amp;&amp;</span> </span>
<span id="cb79-120"><a href="#cb79-120" aria-hidden="true" tabindex="-1"></a>        right_val<span class="op">.</span>kind <span class="op">==</span> LATTICE_CONSTANT<span class="op">)</span> <span class="op">{</span></span>
<span id="cb79-121"><a href="#cb79-121" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Fold the operation</span></span>
<span id="cb79-122"><a href="#cb79-122" aria-hidden="true" tabindex="-1"></a>        Value folded <span class="op">=</span> fold_arithmetic_op<span class="op">(</span>inst<span class="op">-&gt;</span>kind<span class="op">,</span> </span>
<span id="cb79-123"><a href="#cb79-123" aria-hidden="true" tabindex="-1"></a>                                        <span class="op">&amp;</span>left_val<span class="op">.</span>constant<span class="op">,</span> </span>
<span id="cb79-124"><a href="#cb79-124" aria-hidden="true" tabindex="-1"></a>                                        <span class="op">&amp;</span>right_val<span class="op">.</span>constant<span class="op">);</span></span>
<span id="cb79-125"><a href="#cb79-125" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb79-126"><a href="#cb79-126" aria-hidden="true" tabindex="-1"></a>        update_value<span class="op">(</span>sccp<span class="op">,</span> inst<span class="op">-&gt;</span>result<span class="op">,</span> </span>
<span id="cb79-127"><a href="#cb79-127" aria-hidden="true" tabindex="-1"></a>                    <span class="op">(</span>LatticeValue<span class="op">){</span></span>
<span id="cb79-128"><a href="#cb79-128" aria-hidden="true" tabindex="-1"></a>                        <span class="op">.</span>kind <span class="op">=</span> LATTICE_CONSTANT<span class="op">,</span></span>
<span id="cb79-129"><a href="#cb79-129" aria-hidden="true" tabindex="-1"></a>                        <span class="op">.</span>constant <span class="op">=</span> folded</span>
<span id="cb79-130"><a href="#cb79-130" aria-hidden="true" tabindex="-1"></a>                    <span class="op">});</span></span>
<span id="cb79-131"><a href="#cb79-131" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb79-132"><a href="#cb79-132" aria-hidden="true" tabindex="-1"></a>        sccp<span class="op">-&gt;</span>instructions_folded<span class="op">++;</span></span>
<span id="cb79-133"><a href="#cb79-133" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>left_val<span class="op">.</span>kind <span class="op">==</span> LATTICE_BOTTOM <span class="op">||</span> </span>
<span id="cb79-134"><a href="#cb79-134" aria-hidden="true" tabindex="-1"></a>               right_val<span class="op">.</span>kind <span class="op">==</span> LATTICE_BOTTOM<span class="op">)</span> <span class="op">{</span></span>
<span id="cb79-135"><a href="#cb79-135" aria-hidden="true" tabindex="-1"></a>        update_value<span class="op">(</span>sccp<span class="op">,</span> inst<span class="op">-&gt;</span>result<span class="op">,</span> LATTICE_BOTTOM<span class="op">);</span></span>
<span id="cb79-136"><a href="#cb79-136" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb79-137"><a href="#cb79-137" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>7.5 Global Value Numbering</h2>
<p>SSA form enables efficient global value numbering:</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> GVNContext <span class="op">{</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Value number assignments</span></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>    HashMap <span class="op">*</span>value_numbers<span class="op">;</span></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> next_number<span class="op">;</span></span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Congruence classes</span></span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> CongruenceClass <span class="op">{</span></span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint32_t</span> number<span class="op">;</span></span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a>        Value <span class="op">**</span>values<span class="op">;</span></span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a>        <span class="dt">size_t</span> value_count<span class="op">;</span></span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a>        <span class="dt">size_t</span> capacity<span class="op">;</span></span>
<span id="cb80-12"><a href="#cb80-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="op">*</span>classes<span class="op">;</span></span>
<span id="cb80-13"><a href="#cb80-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> class_count<span class="op">;</span></span>
<span id="cb80-14"><a href="#cb80-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb80-15"><a href="#cb80-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Expression hash table</span></span>
<span id="cb80-16"><a href="#cb80-16" aria-hidden="true" tabindex="-1"></a>    HashMap <span class="op">*</span>expressions<span class="op">;</span></span>
<span id="cb80-17"><a href="#cb80-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb80-18"><a href="#cb80-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Statistics</span></span>
<span id="cb80-19"><a href="#cb80-19" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> redundancies_eliminated<span class="op">;</span></span>
<span id="cb80-20"><a href="#cb80-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> GVNContext<span class="op">;</span></span>
<span id="cb80-21"><a href="#cb80-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-22"><a href="#cb80-22" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> global_value_numbering<span class="op">(</span>Function <span class="op">*</span>func<span class="op">,</span> OptimizationContext <span class="op">*</span>ctx<span class="op">)</span> <span class="op">{</span></span>
<span id="cb80-23"><a href="#cb80-23" aria-hidden="true" tabindex="-1"></a>    GVNContext gvn <span class="op">=</span> <span class="op">{</span><span class="dv">0</span><span class="op">};</span></span>
<span id="cb80-24"><a href="#cb80-24" aria-hidden="true" tabindex="-1"></a>    gvn<span class="op">.</span>value_numbers <span class="op">=</span> hashmap_create<span class="op">();</span></span>
<span id="cb80-25"><a href="#cb80-25" aria-hidden="true" tabindex="-1"></a>    gvn<span class="op">.</span>expressions <span class="op">=</span> hashmap_create<span class="op">();</span></span>
<span id="cb80-26"><a href="#cb80-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb80-27"><a href="#cb80-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Process blocks in RPO for better results</span></span>
<span id="cb80-28"><a href="#cb80-28" aria-hidden="true" tabindex="-1"></a>    BasicBlock <span class="op">**</span>rpo <span class="op">=</span> compute_reverse_postorder<span class="op">(</span>func<span class="op">-&gt;</span>cfg<span class="op">);</span></span>
<span id="cb80-29"><a href="#cb80-29" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> block_count <span class="op">=</span> func<span class="op">-&gt;</span>cfg<span class="op">-&gt;</span>block_count<span class="op">;</span></span>
<span id="cb80-30"><a href="#cb80-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb80-31"><a href="#cb80-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Initial pass: assign value numbers</span></span>
<span id="cb80-32"><a href="#cb80-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> block_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb80-33"><a href="#cb80-33" aria-hidden="true" tabindex="-1"></a>        process_block_gvn<span class="op">(&amp;</span>gvn<span class="op">,</span> rpo<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb80-34"><a href="#cb80-34" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb80-35"><a href="#cb80-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb80-36"><a href="#cb80-36" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Eliminate redundancies</span></span>
<span id="cb80-37"><a href="#cb80-37" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> changed <span class="op">=</span> eliminate_redundancies<span class="op">(&amp;</span>gvn<span class="op">,</span> func<span class="op">);</span></span>
<span id="cb80-38"><a href="#cb80-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb80-39"><a href="#cb80-39" aria-hidden="true" tabindex="-1"></a>    free<span class="op">(</span>rpo<span class="op">);</span></span>
<span id="cb80-40"><a href="#cb80-40" aria-hidden="true" tabindex="-1"></a>    cleanup_gvn_context<span class="op">(&amp;</span>gvn<span class="op">);</span></span>
<span id="cb80-41"><a href="#cb80-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> changed<span class="op">;</span></span>
<span id="cb80-42"><a href="#cb80-42" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb80-43"><a href="#cb80-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-44"><a href="#cb80-44" aria-hidden="true" tabindex="-1"></a><span class="co">// Process instruction for GVN</span></span>
<span id="cb80-45"><a href="#cb80-45" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> process_instruction_gvn<span class="op">(</span>GVNContext <span class="op">*</span>gvn<span class="op">,</span> Instruction <span class="op">*</span>inst<span class="op">)</span> <span class="op">{</span></span>
<span id="cb80-46"><a href="#cb80-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> <span class="op">(</span>inst<span class="op">-&gt;</span>kind<span class="op">)</span> <span class="op">{</span></span>
<span id="cb80-47"><a href="#cb80-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> INST_ADD<span class="op">:</span></span>
<span id="cb80-48"><a href="#cb80-48" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> INST_SUB<span class="op">:</span></span>
<span id="cb80-49"><a href="#cb80-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> INST_MUL<span class="op">:</span></span>
<span id="cb80-50"><a href="#cb80-50" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> INST_DIV<span class="op">:</span></span>
<span id="cb80-51"><a href="#cb80-51" aria-hidden="true" tabindex="-1"></a>            process_arithmetic_gvn<span class="op">(</span>gvn<span class="op">,</span> inst<span class="op">);</span></span>
<span id="cb80-52"><a href="#cb80-52" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span><span class="op">;</span></span>
<span id="cb80-53"><a href="#cb80-53" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb80-54"><a href="#cb80-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> INST_PHI<span class="op">:</span></span>
<span id="cb80-55"><a href="#cb80-55" aria-hidden="true" tabindex="-1"></a>            process_phi_gvn<span class="op">(</span>gvn<span class="op">,</span> inst<span class="op">);</span></span>
<span id="cb80-56"><a href="#cb80-56" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span><span class="op">;</span></span>
<span id="cb80-57"><a href="#cb80-57" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb80-58"><a href="#cb80-58" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> INST_LOAD<span class="op">:</span></span>
<span id="cb80-59"><a href="#cb80-59" aria-hidden="true" tabindex="-1"></a>            process_load_gvn<span class="op">(</span>gvn<span class="op">,</span> inst<span class="op">);</span></span>
<span id="cb80-60"><a href="#cb80-60" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span><span class="op">;</span></span>
<span id="cb80-61"><a href="#cb80-61" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb80-62"><a href="#cb80-62" aria-hidden="true" tabindex="-1"></a>        <span class="cf">default</span><span class="op">:</span></span>
<span id="cb80-63"><a href="#cb80-63" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Assign unique value number</span></span>
<span id="cb80-64"><a href="#cb80-64" aria-hidden="true" tabindex="-1"></a>            assign_value_number<span class="op">(</span>gvn<span class="op">,</span> inst<span class="op">-&gt;</span>result<span class="op">,</span> gvn<span class="op">-&gt;</span>next_number<span class="op">++);</span></span>
<span id="cb80-65"><a href="#cb80-65" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb80-66"><a href="#cb80-66" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb80-67"><a href="#cb80-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-68"><a href="#cb80-68" aria-hidden="true" tabindex="-1"></a><span class="co">// Handle commutative operations</span></span>
<span id="cb80-69"><a href="#cb80-69" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> process_arithmetic_gvn<span class="op">(</span>GVNContext <span class="op">*</span>gvn<span class="op">,</span> Instruction <span class="op">*</span>inst<span class="op">)</span> <span class="op">{</span></span>
<span id="cb80-70"><a href="#cb80-70" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> left_vn <span class="op">=</span> get_value_number<span class="op">(</span>gvn<span class="op">,</span> inst<span class="op">-&gt;</span>operands<span class="op">[</span><span class="dv">0</span><span class="op">]);</span></span>
<span id="cb80-71"><a href="#cb80-71" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> right_vn <span class="op">=</span> get_value_number<span class="op">(</span>gvn<span class="op">,</span> inst<span class="op">-&gt;</span>operands<span class="op">[</span><span class="dv">1</span><span class="op">]);</span></span>
<span id="cb80-72"><a href="#cb80-72" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb80-73"><a href="#cb80-73" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Normalize commutative operations</span></span>
<span id="cb80-74"><a href="#cb80-74" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>is_commutative<span class="op">(</span>inst<span class="op">-&gt;</span>kind<span class="op">)</span> <span class="op">&amp;&amp;</span> left_vn <span class="op">&gt;</span> right_vn<span class="op">)</span> <span class="op">{</span></span>
<span id="cb80-75"><a href="#cb80-75" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint32_t</span> temp <span class="op">=</span> left_vn<span class="op">;</span></span>
<span id="cb80-76"><a href="#cb80-76" aria-hidden="true" tabindex="-1"></a>        left_vn <span class="op">=</span> right_vn<span class="op">;</span></span>
<span id="cb80-77"><a href="#cb80-77" aria-hidden="true" tabindex="-1"></a>        right_vn <span class="op">=</span> temp<span class="op">;</span></span>
<span id="cb80-78"><a href="#cb80-78" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb80-79"><a href="#cb80-79" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb80-80"><a href="#cb80-80" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Create expression hash</span></span>
<span id="cb80-81"><a href="#cb80-81" aria-hidden="true" tabindex="-1"></a>    Expression expr <span class="op">=</span> <span class="op">{</span></span>
<span id="cb80-82"><a href="#cb80-82" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>opcode <span class="op">=</span> inst<span class="op">-&gt;</span>kind<span class="op">,</span></span>
<span id="cb80-83"><a href="#cb80-83" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>operands <span class="op">=</span> <span class="op">{</span>left_vn<span class="op">,</span> right_vn<span class="op">},</span></span>
<span id="cb80-84"><a href="#cb80-84" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>operand_count <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb80-85"><a href="#cb80-85" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb80-86"><a href="#cb80-86" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb80-87"><a href="#cb80-87" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check if expression already exists</span></span>
<span id="cb80-88"><a href="#cb80-88" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> <span class="op">*</span>existing_vn <span class="op">=</span> hashmap_get<span class="op">(</span>gvn<span class="op">-&gt;</span>expressions<span class="op">,</span> <span class="op">&amp;</span>expr<span class="op">);</span></span>
<span id="cb80-89"><a href="#cb80-89" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb80-90"><a href="#cb80-90" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>existing_vn<span class="op">)</span> <span class="op">{</span></span>
<span id="cb80-91"><a href="#cb80-91" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Reuse existing value number</span></span>
<span id="cb80-92"><a href="#cb80-92" aria-hidden="true" tabindex="-1"></a>        assign_value_number<span class="op">(</span>gvn<span class="op">,</span> inst<span class="op">-&gt;</span>result<span class="op">,</span> <span class="op">*</span>existing_vn<span class="op">);</span></span>
<span id="cb80-93"><a href="#cb80-93" aria-hidden="true" tabindex="-1"></a>        add_to_congruence_class<span class="op">(</span>gvn<span class="op">,</span> <span class="op">*</span>existing_vn<span class="op">,</span> inst<span class="op">-&gt;</span>result<span class="op">);</span></span>
<span id="cb80-94"><a href="#cb80-94" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb80-95"><a href="#cb80-95" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Create new value number</span></span>
<span id="cb80-96"><a href="#cb80-96" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint32_t</span> new_vn <span class="op">=</span> gvn<span class="op">-&gt;</span>next_number<span class="op">++;</span></span>
<span id="cb80-97"><a href="#cb80-97" aria-hidden="true" tabindex="-1"></a>        assign_value_number<span class="op">(</span>gvn<span class="op">,</span> inst<span class="op">-&gt;</span>result<span class="op">,</span> new_vn<span class="op">);</span></span>
<span id="cb80-98"><a href="#cb80-98" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb80-99"><a href="#cb80-99" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Remember this expression</span></span>
<span id="cb80-100"><a href="#cb80-100" aria-hidden="true" tabindex="-1"></a>        hashmap_put<span class="op">(</span>gvn<span class="op">-&gt;</span>expressions<span class="op">,</span> <span class="op">&amp;</span>expr<span class="op">,</span> <span class="op">&amp;</span>new_vn<span class="op">);</span></span>
<span id="cb80-101"><a href="#cb80-101" aria-hidden="true" tabindex="-1"></a>        create_congruence_class<span class="op">(</span>gvn<span class="op">,</span> new_vn<span class="op">,</span> inst<span class="op">-&gt;</span>result<span class="op">);</span></span>
<span id="cb80-102"><a href="#cb80-102" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb80-103"><a href="#cb80-103" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb80-104"><a href="#cb80-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-105"><a href="#cb80-105" aria-hidden="true" tabindex="-1"></a><span class="co">// Load-store optimization with GVN</span></span>
<span id="cb80-106"><a href="#cb80-106" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> process_load_gvn<span class="op">(</span>GVNContext <span class="op">*</span>gvn<span class="op">,</span> Instruction <span class="op">*</span>inst<span class="op">)</span> <span class="op">{</span></span>
<span id="cb80-107"><a href="#cb80-107" aria-hidden="true" tabindex="-1"></a>    LoadInst <span class="op">*</span>load <span class="op">=</span> <span class="op">(</span>LoadInst<span class="op">*)</span>inst<span class="op">;</span></span>
<span id="cb80-108"><a href="#cb80-108" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb80-109"><a href="#cb80-109" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Find available loads to the same address</span></span>
<span id="cb80-110"><a href="#cb80-110" aria-hidden="true" tabindex="-1"></a>    AvailableLoad <span class="op">*</span>avail <span class="op">=</span> find_available_load<span class="op">(</span>gvn<span class="op">,</span> load<span class="op">-&gt;</span>address<span class="op">,</span> </span>
<span id="cb80-111"><a href="#cb80-111" aria-hidden="true" tabindex="-1"></a>                                              load<span class="op">-&gt;</span>memory_version<span class="op">);</span></span>
<span id="cb80-112"><a href="#cb80-112" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb80-113"><a href="#cb80-113" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>avail <span class="op">&amp;&amp;</span> <span class="op">!</span>may_alias<span class="op">(</span>load<span class="op">,</span> avail<span class="op">))</span> <span class="op">{</span></span>
<span id="cb80-114"><a href="#cb80-114" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Reuse previous load</span></span>
<span id="cb80-115"><a href="#cb80-115" aria-hidden="true" tabindex="-1"></a>        assign_value_number<span class="op">(</span>gvn<span class="op">,</span> inst<span class="op">-&gt;</span>result<span class="op">,</span> </span>
<span id="cb80-116"><a href="#cb80-116" aria-hidden="true" tabindex="-1"></a>                          get_value_number<span class="op">(</span>gvn<span class="op">,</span> avail<span class="op">-&gt;</span>value<span class="op">));</span></span>
<span id="cb80-117"><a href="#cb80-117" aria-hidden="true" tabindex="-1"></a>        gvn<span class="op">-&gt;</span>redundancies_eliminated<span class="op">++;</span></span>
<span id="cb80-118"><a href="#cb80-118" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb80-119"><a href="#cb80-119" aria-hidden="true" tabindex="-1"></a>        <span class="co">// New load</span></span>
<span id="cb80-120"><a href="#cb80-120" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint32_t</span> new_vn <span class="op">=</span> gvn<span class="op">-&gt;</span>next_number<span class="op">++;</span></span>
<span id="cb80-121"><a href="#cb80-121" aria-hidden="true" tabindex="-1"></a>        assign_value_number<span class="op">(</span>gvn<span class="op">,</span> inst<span class="op">-&gt;</span>result<span class="op">,</span> new_vn<span class="op">);</span></span>
<span id="cb80-122"><a href="#cb80-122" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb80-123"><a href="#cb80-123" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Record as available</span></span>
<span id="cb80-124"><a href="#cb80-124" aria-hidden="true" tabindex="-1"></a>        record_available_load<span class="op">(</span>gvn<span class="op">,</span> load<span class="op">);</span></span>
<span id="cb80-125"><a href="#cb80-125" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb80-126"><a href="#cb80-126" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>7.6 Loop Optimizations in SSA</h2>
<p>SSA form simplifies many loop optimizations:</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> LoopInfo <span class="op">{</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>    BasicBlock <span class="op">*</span>header<span class="op">;</span></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>    BasicBlock <span class="op">*</span>preheader<span class="op">;</span></span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>    BasicBlock <span class="op">**</span>blocks<span class="op">;</span></span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> block_count<span class="op">;</span></span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Loop exits</span></span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> LoopExit <span class="op">{</span></span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a>        BasicBlock <span class="op">*</span>exiting_block<span class="op">;</span></span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a>        BasicBlock <span class="op">*</span>exit_block<span class="op">;</span></span>
<span id="cb81-11"><a href="#cb81-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="op">*</span>exits<span class="op">;</span></span>
<span id="cb81-12"><a href="#cb81-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> exit_count<span class="op">;</span></span>
<span id="cb81-13"><a href="#cb81-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb81-14"><a href="#cb81-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Nested loops</span></span>
<span id="cb81-15"><a href="#cb81-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> LoopInfo <span class="op">*</span>parent<span class="op">;</span></span>
<span id="cb81-16"><a href="#cb81-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> LoopInfo <span class="op">**</span>children<span class="op">;</span></span>
<span id="cb81-17"><a href="#cb81-17" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> child_count<span class="op">;</span></span>
<span id="cb81-18"><a href="#cb81-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb81-19"><a href="#cb81-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Loop properties</span></span>
<span id="cb81-20"><a href="#cb81-20" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> is_natural<span class="op">;</span></span>
<span id="cb81-21"><a href="#cb81-21" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> is_reducible<span class="op">;</span></span>
<span id="cb81-22"><a href="#cb81-22" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> has_single_exit<span class="op">;</span></span>
<span id="cb81-23"><a href="#cb81-23" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> LoopInfo<span class="op">;</span></span>
<span id="cb81-24"><a href="#cb81-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-25"><a href="#cb81-25" aria-hidden="true" tabindex="-1"></a><span class="co">// Loop-Invariant Code Motion (LICM)</span></span>
<span id="cb81-26"><a href="#cb81-26" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> loop_invariant_code_motion<span class="op">(</span>Function <span class="op">*</span>func<span class="op">,</span> OptimizationContext <span class="op">*</span>ctx<span class="op">)</span> <span class="op">{</span></span>
<span id="cb81-27"><a href="#cb81-27" aria-hidden="true" tabindex="-1"></a>    LoopInfo <span class="op">**</span>loops <span class="op">=</span> identify_loops<span class="op">(</span>func<span class="op">-&gt;</span>cfg<span class="op">);</span></span>
<span id="cb81-28"><a href="#cb81-28" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> loop_count <span class="op">=</span> count_loops<span class="op">(</span>loops<span class="op">);</span></span>
<span id="cb81-29"><a href="#cb81-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb81-30"><a href="#cb81-30" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> changed <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb81-31"><a href="#cb81-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb81-32"><a href="#cb81-32" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Process loops from innermost to outermost</span></span>
<span id="cb81-33"><a href="#cb81-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> loop_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb81-34"><a href="#cb81-34" aria-hidden="true" tabindex="-1"></a>        LoopInfo <span class="op">*</span>loop <span class="op">=</span> loops<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb81-35"><a href="#cb81-35" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb81-36"><a href="#cb81-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(!</span>loop<span class="op">-&gt;</span>parent <span class="op">||</span> all_children_processed<span class="op">(</span>loop<span class="op">))</span> <span class="op">{</span></span>
<span id="cb81-37"><a href="#cb81-37" aria-hidden="true" tabindex="-1"></a>            changed <span class="op">|=</span> hoist_loop_invariants<span class="op">(</span>loop<span class="op">,</span> func<span class="op">);</span></span>
<span id="cb81-38"><a href="#cb81-38" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb81-39"><a href="#cb81-39" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb81-40"><a href="#cb81-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb81-41"><a href="#cb81-41" aria-hidden="true" tabindex="-1"></a>    free_loop_info<span class="op">(</span>loops<span class="op">);</span></span>
<span id="cb81-42"><a href="#cb81-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> changed<span class="op">;</span></span>
<span id="cb81-43"><a href="#cb81-43" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb81-44"><a href="#cb81-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-45"><a href="#cb81-45" aria-hidden="true" tabindex="-1"></a><span class="co">// Identify loop-invariant instructions</span></span>
<span id="cb81-46"><a href="#cb81-46" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">bool</span> hoist_loop_invariants<span class="op">(</span>LoopInfo <span class="op">*</span>loop<span class="op">,</span> Function <span class="op">*</span>func<span class="op">)</span> <span class="op">{</span></span>
<span id="cb81-47"><a href="#cb81-47" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> changed <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb81-48"><a href="#cb81-48" aria-hidden="true" tabindex="-1"></a>    BitSet <span class="op">*</span>invariant <span class="op">=</span> bitset_create<span class="op">(</span>func<span class="op">-&gt;</span>instruction_count<span class="op">);</span></span>
<span id="cb81-49"><a href="#cb81-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb81-50"><a href="#cb81-50" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Find loop-invariant instructions</span></span>
<span id="cb81-51"><a href="#cb81-51" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> found_new <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb81-52"><a href="#cb81-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span>found_new<span class="op">)</span> <span class="op">{</span></span>
<span id="cb81-53"><a href="#cb81-53" aria-hidden="true" tabindex="-1"></a>        found_new <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb81-54"><a href="#cb81-54" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb81-55"><a href="#cb81-55" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> loop<span class="op">-&gt;</span>block_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb81-56"><a href="#cb81-56" aria-hidden="true" tabindex="-1"></a>            BasicBlock <span class="op">*</span>block <span class="op">=</span> loop<span class="op">-&gt;</span>blocks<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb81-57"><a href="#cb81-57" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb81-58"><a href="#cb81-58" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> <span class="op">(</span>Instruction <span class="op">*</span>inst <span class="op">=</span> block<span class="op">-&gt;</span>first<span class="op">;</span> inst<span class="op">;</span> inst <span class="op">=</span> inst<span class="op">-&gt;</span>next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb81-59"><a href="#cb81-59" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(!</span>bitset_test<span class="op">(</span>invariant<span class="op">,</span> inst<span class="op">-&gt;</span>id<span class="op">)</span> <span class="op">&amp;&amp;</span> </span>
<span id="cb81-60"><a href="#cb81-60" aria-hidden="true" tabindex="-1"></a>                    is_loop_invariant<span class="op">(</span>inst<span class="op">,</span> loop<span class="op">,</span> invariant<span class="op">))</span> <span class="op">{</span></span>
<span id="cb81-61"><a href="#cb81-61" aria-hidden="true" tabindex="-1"></a>                    bitset_set<span class="op">(</span>invariant<span class="op">,</span> inst<span class="op">-&gt;</span>id<span class="op">);</span></span>
<span id="cb81-62"><a href="#cb81-62" aria-hidden="true" tabindex="-1"></a>                    found_new <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb81-63"><a href="#cb81-63" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb81-64"><a href="#cb81-64" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb81-65"><a href="#cb81-65" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb81-66"><a href="#cb81-66" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb81-67"><a href="#cb81-67" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb81-68"><a href="#cb81-68" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Hoist invariant instructions</span></span>
<span id="cb81-69"><a href="#cb81-69" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> loop<span class="op">-&gt;</span>block_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb81-70"><a href="#cb81-70" aria-hidden="true" tabindex="-1"></a>        BasicBlock <span class="op">*</span>block <span class="op">=</span> loop<span class="op">-&gt;</span>blocks<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb81-71"><a href="#cb81-71" aria-hidden="true" tabindex="-1"></a>        Instruction <span class="op">*</span>inst <span class="op">=</span> block<span class="op">-&gt;</span>first<span class="op">;</span></span>
<span id="cb81-72"><a href="#cb81-72" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb81-73"><a href="#cb81-73" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> <span class="op">(</span>inst<span class="op">)</span> <span class="op">{</span></span>
<span id="cb81-74"><a href="#cb81-74" aria-hidden="true" tabindex="-1"></a>            Instruction <span class="op">*</span>next <span class="op">=</span> inst<span class="op">-&gt;</span>next<span class="op">;</span></span>
<span id="cb81-75"><a href="#cb81-75" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb81-76"><a href="#cb81-76" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>bitset_test<span class="op">(</span>invariant<span class="op">,</span> inst<span class="op">-&gt;</span>id<span class="op">)</span> <span class="op">&amp;&amp;</span> </span>
<span id="cb81-77"><a href="#cb81-77" aria-hidden="true" tabindex="-1"></a>                safe_to_hoist<span class="op">(</span>inst<span class="op">,</span> loop<span class="op">))</span> <span class="op">{</span></span>
<span id="cb81-78"><a href="#cb81-78" aria-hidden="true" tabindex="-1"></a>                hoist_instruction<span class="op">(</span>inst<span class="op">,</span> loop<span class="op">-&gt;</span>preheader<span class="op">);</span></span>
<span id="cb81-79"><a href="#cb81-79" aria-hidden="true" tabindex="-1"></a>                changed <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb81-80"><a href="#cb81-80" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb81-81"><a href="#cb81-81" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb81-82"><a href="#cb81-82" aria-hidden="true" tabindex="-1"></a>            inst <span class="op">=</span> next<span class="op">;</span></span>
<span id="cb81-83"><a href="#cb81-83" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb81-84"><a href="#cb81-84" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb81-85"><a href="#cb81-85" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb81-86"><a href="#cb81-86" aria-hidden="true" tabindex="-1"></a>    bitset_destroy<span class="op">(</span>invariant<span class="op">);</span></span>
<span id="cb81-87"><a href="#cb81-87" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> changed<span class="op">;</span></span>
<span id="cb81-88"><a href="#cb81-88" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb81-89"><a href="#cb81-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-90"><a href="#cb81-90" aria-hidden="true" tabindex="-1"></a><span class="co">// Loop strength reduction</span></span>
<span id="cb81-91"><a href="#cb81-91" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> InductionVariable <span class="op">{</span></span>
<span id="cb81-92"><a href="#cb81-92" aria-hidden="true" tabindex="-1"></a>    PhiNode <span class="op">*</span>phi<span class="op">;</span></span>
<span id="cb81-93"><a href="#cb81-93" aria-hidden="true" tabindex="-1"></a>    Value <span class="op">*</span>initial_value<span class="op">;</span></span>
<span id="cb81-94"><a href="#cb81-94" aria-hidden="true" tabindex="-1"></a>    Value <span class="op">*</span>increment<span class="op">;</span></span>
<span id="cb81-95"><a href="#cb81-95" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb81-96"><a href="#cb81-96" aria-hidden="true" tabindex="-1"></a>    <span class="kw">enum</span> <span class="op">{</span></span>
<span id="cb81-97"><a href="#cb81-97" aria-hidden="true" tabindex="-1"></a>        IV_BASIC<span class="op">,</span></span>
<span id="cb81-98"><a href="#cb81-98" aria-hidden="true" tabindex="-1"></a>        IV_DERIVED</span>
<span id="cb81-99"><a href="#cb81-99" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> kind<span class="op">;</span></span>
<span id="cb81-100"><a href="#cb81-100" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb81-101"><a href="#cb81-101" aria-hidden="true" tabindex="-1"></a>    <span class="co">// For derived IVs</span></span>
<span id="cb81-102"><a href="#cb81-102" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> InductionVariable <span class="op">*</span>base<span class="op">;</span></span>
<span id="cb81-103"><a href="#cb81-103" aria-hidden="true" tabindex="-1"></a>    Value <span class="op">*</span>scale<span class="op">;</span></span>
<span id="cb81-104"><a href="#cb81-104" aria-hidden="true" tabindex="-1"></a>    Value <span class="op">*</span>offset<span class="op">;</span></span>
<span id="cb81-105"><a href="#cb81-105" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> InductionVariable<span class="op">;</span></span>
<span id="cb81-106"><a href="#cb81-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-107"><a href="#cb81-107" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">bool</span> strength_reduce_loop<span class="op">(</span>LoopInfo <span class="op">*</span>loop<span class="op">,</span> Function <span class="op">*</span>func<span class="op">)</span> <span class="op">{</span></span>
<span id="cb81-108"><a href="#cb81-108" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Find induction variables</span></span>
<span id="cb81-109"><a href="#cb81-109" aria-hidden="true" tabindex="-1"></a>    InductionVariable <span class="op">**</span>ivs <span class="op">=</span> find_induction_variables<span class="op">(</span>loop<span class="op">);</span></span>
<span id="cb81-110"><a href="#cb81-110" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> iv_count <span class="op">=</span> count_induction_variables<span class="op">(</span>ivs<span class="op">);</span></span>
<span id="cb81-111"><a href="#cb81-111" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb81-112"><a href="#cb81-112" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> changed <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb81-113"><a href="#cb81-113" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb81-114"><a href="#cb81-114" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Replace expensive operations on IVs</span></span>
<span id="cb81-115"><a href="#cb81-115" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> iv_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb81-116"><a href="#cb81-116" aria-hidden="true" tabindex="-1"></a>        InductionVariable <span class="op">*</span>iv <span class="op">=</span> ivs<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb81-117"><a href="#cb81-117" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb81-118"><a href="#cb81-118" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Find uses of this IV</span></span>
<span id="cb81-119"><a href="#cb81-119" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span>Use <span class="op">*</span>use <span class="op">=</span> iv<span class="op">-&gt;</span>phi<span class="op">-&gt;</span>result<span class="op">-&gt;</span>use_list<span class="op">;</span> use<span class="op">;</span> use <span class="op">=</span> use<span class="op">-&gt;</span>next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb81-120"><a href="#cb81-120" aria-hidden="true" tabindex="-1"></a>            Instruction <span class="op">*</span>user <span class="op">=</span> use<span class="op">-&gt;</span>instruction<span class="op">;</span></span>
<span id="cb81-121"><a href="#cb81-121" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb81-122"><a href="#cb81-122" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>user<span class="op">-&gt;</span>kind <span class="op">==</span> INST_MUL <span class="op">&amp;&amp;</span> is_loop_invariant_value<span class="op">(</span></span>
<span id="cb81-123"><a href="#cb81-123" aria-hidden="true" tabindex="-1"></a>                    get_other_operand<span class="op">(</span>user<span class="op">,</span> iv<span class="op">-&gt;</span>phi<span class="op">-&gt;</span>result<span class="op">),</span> loop<span class="op">))</span> <span class="op">{</span></span>
<span id="cb81-124"><a href="#cb81-124" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Replace multiplication with addition</span></span>
<span id="cb81-125"><a href="#cb81-125" aria-hidden="true" tabindex="-1"></a>                changed <span class="op">|=</span> replace_mul_with_add<span class="op">(</span>user<span class="op">,</span> iv<span class="op">,</span> loop<span class="op">);</span></span>
<span id="cb81-126"><a href="#cb81-126" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb81-127"><a href="#cb81-127" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb81-128"><a href="#cb81-128" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb81-129"><a href="#cb81-129" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb81-130"><a href="#cb81-130" aria-hidden="true" tabindex="-1"></a>    free_induction_variables<span class="op">(</span>ivs<span class="op">);</span></span>
<span id="cb81-131"><a href="#cb81-131" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> changed<span class="op">;</span></span>
<span id="cb81-132"><a href="#cb81-132" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>7.7 Memory SSA Optimizations</h2>
<p>Memory SSA enables precise memory optimizations:</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> MemorySSAOptContext <span class="op">{</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Alias analysis results</span></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>    AliasAnalysis <span class="op">*</span>alias_analysis<span class="op">;</span></span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Memory version tracking</span></span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>    HashMap <span class="op">*</span>memory_versions<span class="op">;</span></span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Dead stores</span></span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a>    WorkList <span class="op">*</span>dead_stores<span class="op">;</span></span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb82-11"><a href="#cb82-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Statistics</span></span>
<span id="cb82-12"><a href="#cb82-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> dead_stores_eliminated<span class="op">;</span></span>
<span id="cb82-13"><a href="#cb82-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> redundant_loads_eliminated<span class="op">;</span></span>
<span id="cb82-14"><a href="#cb82-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> stores_forwarded<span class="op">;</span></span>
<span id="cb82-15"><a href="#cb82-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> MemorySSAOptContext<span class="op">;</span></span>
<span id="cb82-16"><a href="#cb82-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-17"><a href="#cb82-17" aria-hidden="true" tabindex="-1"></a><span class="co">// Dead Store Elimination with Memory SSA</span></span>
<span id="cb82-18"><a href="#cb82-18" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> dead_store_elimination_mssa<span class="op">(</span>Function <span class="op">*</span>func<span class="op">,</span> OptimizationContext <span class="op">*</span>ctx<span class="op">)</span> <span class="op">{</span></span>
<span id="cb82-19"><a href="#cb82-19" aria-hidden="true" tabindex="-1"></a>    MemorySSAOptContext mssa_ctx <span class="op">=</span> <span class="op">{</span><span class="dv">0</span><span class="op">};</span></span>
<span id="cb82-20"><a href="#cb82-20" aria-hidden="true" tabindex="-1"></a>    mssa_ctx<span class="op">.</span>alias_analysis <span class="op">=</span> ctx<span class="op">-&gt;</span>alias_analysis<span class="op">;</span></span>
<span id="cb82-21"><a href="#cb82-21" aria-hidden="true" tabindex="-1"></a>    mssa_ctx<span class="op">.</span>dead_stores <span class="op">=</span> worklist_create<span class="op">();</span></span>
<span id="cb82-22"><a href="#cb82-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb82-23"><a href="#cb82-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Find potentially dead stores</span></span>
<span id="cb82-24"><a href="#cb82-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>BasicBlock <span class="op">*</span>block <span class="op">=</span> func<span class="op">-&gt;</span>cfg<span class="op">-&gt;</span>entry<span class="op">;</span> block<span class="op">;</span> block <span class="op">=</span> block<span class="op">-&gt;</span>next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb82-25"><a href="#cb82-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span>Instruction <span class="op">*</span>inst <span class="op">=</span> block<span class="op">-&gt;</span>first<span class="op">;</span> inst<span class="op">;</span> inst <span class="op">=</span> inst<span class="op">-&gt;</span>next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb82-26"><a href="#cb82-26" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>inst<span class="op">-&gt;</span>kind <span class="op">==</span> MEM_STORE<span class="op">)</span> <span class="op">{</span></span>
<span id="cb82-27"><a href="#cb82-27" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span>is_dead_store<span class="op">(&amp;</span>mssa_ctx<span class="op">,</span> inst<span class="op">))</span> <span class="op">{</span></span>
<span id="cb82-28"><a href="#cb82-28" aria-hidden="true" tabindex="-1"></a>                    worklist_push<span class="op">(</span>mssa_ctx<span class="op">.</span>dead_stores<span class="op">,</span> inst<span class="op">);</span></span>
<span id="cb82-29"><a href="#cb82-29" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb82-30"><a href="#cb82-30" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb82-31"><a href="#cb82-31" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb82-32"><a href="#cb82-32" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb82-33"><a href="#cb82-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb82-34"><a href="#cb82-34" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Eliminate dead stores</span></span>
<span id="cb82-35"><a href="#cb82-35" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> changed <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb82-36"><a href="#cb82-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(!</span>worklist_empty<span class="op">(</span>mssa_ctx<span class="op">.</span>dead_stores<span class="op">))</span> <span class="op">{</span></span>
<span id="cb82-37"><a href="#cb82-37" aria-hidden="true" tabindex="-1"></a>        Instruction <span class="op">*</span>store <span class="op">=</span> worklist_pop<span class="op">(</span>mssa_ctx<span class="op">.</span>dead_stores<span class="op">);</span></span>
<span id="cb82-38"><a href="#cb82-38" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb82-39"><a href="#cb82-39" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Verify store is still dead</span></span>
<span id="cb82-40"><a href="#cb82-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>is_dead_store<span class="op">(&amp;</span>mssa_ctx<span class="op">,</span> store<span class="op">))</span> <span class="op">{</span></span>
<span id="cb82-41"><a href="#cb82-41" aria-hidden="true" tabindex="-1"></a>            remove_instruction<span class="op">(</span>store<span class="op">-&gt;</span>block<span class="op">,</span> store<span class="op">);</span></span>
<span id="cb82-42"><a href="#cb82-42" aria-hidden="true" tabindex="-1"></a>            mssa_ctx<span class="op">.</span>dead_stores_eliminated<span class="op">++;</span></span>
<span id="cb82-43"><a href="#cb82-43" aria-hidden="true" tabindex="-1"></a>            changed <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb82-44"><a href="#cb82-44" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb82-45"><a href="#cb82-45" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Check if this enables more dead stores</span></span>
<span id="cb82-46"><a href="#cb82-46" aria-hidden="true" tabindex="-1"></a>            check_new_dead_stores<span class="op">(&amp;</span>mssa_ctx<span class="op">,</span> store<span class="op">);</span></span>
<span id="cb82-47"><a href="#cb82-47" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb82-48"><a href="#cb82-48" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb82-49"><a href="#cb82-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb82-50"><a href="#cb82-50" aria-hidden="true" tabindex="-1"></a>    cleanup_mssa_context<span class="op">(&amp;</span>mssa_ctx<span class="op">);</span></span>
<span id="cb82-51"><a href="#cb82-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> changed<span class="op">;</span></span>
<span id="cb82-52"><a href="#cb82-52" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb82-53"><a href="#cb82-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-54"><a href="#cb82-54" aria-hidden="true" tabindex="-1"></a><span class="co">// Check if a store is dead</span></span>
<span id="cb82-55"><a href="#cb82-55" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">bool</span> is_dead_store<span class="op">(</span>MemorySSAOptContext <span class="op">*</span>ctx<span class="op">,</span> Instruction <span class="op">*</span>store<span class="op">)</span> <span class="op">{</span></span>
<span id="cb82-56"><a href="#cb82-56" aria-hidden="true" tabindex="-1"></a>    MemStoreInst <span class="op">*</span>mem_store <span class="op">=</span> <span class="op">(</span>MemStoreInst<span class="op">*)</span>store<span class="op">;</span></span>
<span id="cb82-57"><a href="#cb82-57" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb82-58"><a href="#cb82-58" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check all uses of the memory version produced by this store</span></span>
<span id="cb82-59"><a href="#cb82-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>Use <span class="op">*</span>use <span class="op">=</span> mem_store<span class="op">-&gt;</span>memory_out<span class="op">-&gt;</span>use_list<span class="op">;</span> use<span class="op">;</span> use <span class="op">=</span> use<span class="op">-&gt;</span>next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb82-60"><a href="#cb82-60" aria-hidden="true" tabindex="-1"></a>        Instruction <span class="op">*</span>user <span class="op">=</span> use<span class="op">-&gt;</span>instruction<span class="op">;</span></span>
<span id="cb82-61"><a href="#cb82-61" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb82-62"><a href="#cb82-62" aria-hidden="true" tabindex="-1"></a>        <span class="cf">switch</span> <span class="op">(</span>user<span class="op">-&gt;</span>kind<span class="op">)</span> <span class="op">{</span></span>
<span id="cb82-63"><a href="#cb82-63" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> MEM_LOAD<span class="op">:</span> <span class="op">{</span></span>
<span id="cb82-64"><a href="#cb82-64" aria-hidden="true" tabindex="-1"></a>                MemLoadInst <span class="op">*</span>load <span class="op">=</span> <span class="op">(</span>MemLoadInst<span class="op">*)</span>user<span class="op">;</span></span>
<span id="cb82-65"><a href="#cb82-65" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span>may_alias<span class="op">(</span>mem_store<span class="op">-&gt;</span>address<span class="op">,</span> load<span class="op">-&gt;</span>address<span class="op">,</span> </span>
<span id="cb82-66"><a href="#cb82-66" aria-hidden="true" tabindex="-1"></a>                             ctx<span class="op">-&gt;</span>alias_analysis<span class="op">))</span> <span class="op">{</span></span>
<span id="cb82-67"><a href="#cb82-67" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span>  <span class="co">// Load may read this store</span></span>
<span id="cb82-68"><a href="#cb82-68" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb82-69"><a href="#cb82-69" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb82-70"><a href="#cb82-70" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb82-71"><a href="#cb82-71" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb82-72"><a href="#cb82-72" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> MEM_STORE<span class="op">:</span> <span class="op">{</span></span>
<span id="cb82-73"><a href="#cb82-73" aria-hidden="true" tabindex="-1"></a>                MemStoreInst <span class="op">*</span>other_store <span class="op">=</span> <span class="op">(</span>MemStoreInst<span class="op">*)</span>user<span class="op">;</span></span>
<span id="cb82-74"><a href="#cb82-74" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(!</span>must_alias<span class="op">(</span>mem_store<span class="op">-&gt;</span>address<span class="op">,</span> other_store<span class="op">-&gt;</span>address<span class="op">,</span></span>
<span id="cb82-75"><a href="#cb82-75" aria-hidden="true" tabindex="-1"></a>                               ctx<span class="op">-&gt;</span>alias_analysis<span class="op">))</span> <span class="op">{</span></span>
<span id="cb82-76"><a href="#cb82-76" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span>  <span class="co">// Different location</span></span>
<span id="cb82-77"><a href="#cb82-77" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb82-78"><a href="#cb82-78" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Same location - this might kill our store</span></span>
<span id="cb82-79"><a href="#cb82-79" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb82-80"><a href="#cb82-80" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb82-81"><a href="#cb82-81" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb82-82"><a href="#cb82-82" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> MEM_PHI<span class="op">:</span></span>
<span id="cb82-83"><a href="#cb82-83" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Memory  uses are OK</span></span>
<span id="cb82-84"><a href="#cb82-84" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb82-85"><a href="#cb82-85" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb82-86"><a href="#cb82-86" aria-hidden="true" tabindex="-1"></a>            <span class="cf">default</span><span class="op">:</span></span>
<span id="cb82-87"><a href="#cb82-87" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span>  <span class="co">// Conservative</span></span>
<span id="cb82-88"><a href="#cb82-88" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb82-89"><a href="#cb82-89" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb82-90"><a href="#cb82-90" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb82-91"><a href="#cb82-91" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb82-92"><a href="#cb82-92" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb82-93"><a href="#cb82-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-94"><a href="#cb82-94" aria-hidden="true" tabindex="-1"></a><span class="co">// Partial Redundancy Elimination for Memory Operations</span></span>
<span id="cb82-95"><a href="#cb82-95" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> memory_pre<span class="op">(</span>Function <span class="op">*</span>func<span class="op">,</span> OptimizationContext <span class="op">*</span>ctx<span class="op">)</span> <span class="op">{</span></span>
<span id="cb82-96"><a href="#cb82-96" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Compute anticipability of loads</span></span>
<span id="cb82-97"><a href="#cb82-97" aria-hidden="true" tabindex="-1"></a>    BitSet <span class="op">**</span>anticipated <span class="op">=</span> compute_anticipated_loads<span class="op">(</span>func<span class="op">);</span></span>
<span id="cb82-98"><a href="#cb82-98" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb82-99"><a href="#cb82-99" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Compute availability</span></span>
<span id="cb82-100"><a href="#cb82-100" aria-hidden="true" tabindex="-1"></a>    BitSet <span class="op">**</span>available <span class="op">=</span> compute_available_loads<span class="op">(</span>func<span class="op">);</span></span>
<span id="cb82-101"><a href="#cb82-101" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb82-102"><a href="#cb82-102" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Insert loads at optimal positions</span></span>
<span id="cb82-103"><a href="#cb82-103" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> changed <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb82-104"><a href="#cb82-104" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb82-105"><a href="#cb82-105" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>BasicBlock <span class="op">*</span>block <span class="op">=</span> func<span class="op">-&gt;</span>cfg<span class="op">-&gt;</span>entry<span class="op">;</span> block<span class="op">;</span> block <span class="op">=</span> block<span class="op">-&gt;</span>next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb82-106"><a href="#cb82-106" aria-hidden="true" tabindex="-1"></a>        BitSet <span class="op">*</span>ant_in <span class="op">=</span> anticipated<span class="op">[</span>block<span class="op">-&gt;</span>id<span class="op">];</span></span>
<span id="cb82-107"><a href="#cb82-107" aria-hidden="true" tabindex="-1"></a>        BitSet <span class="op">*</span>avail_in <span class="op">=</span> available<span class="op">[</span>block<span class="op">-&gt;</span>id<span class="op">];</span></span>
<span id="cb82-108"><a href="#cb82-108" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb82-109"><a href="#cb82-109" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Find partially redundant loads</span></span>
<span id="cb82-110"><a href="#cb82-110" aria-hidden="true" tabindex="-1"></a>        bitset_for_each_set<span class="op">(</span>ant_in<span class="op">,</span> load_id<span class="op">)</span> <span class="op">{</span></span>
<span id="cb82-111"><a href="#cb82-111" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(!</span>bitset_test<span class="op">(</span>avail_in<span class="op">,</span> load_id<span class="op">))</span> <span class="op">{</span></span>
<span id="cb82-112"><a href="#cb82-112" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Load is anticipated but not available</span></span>
<span id="cb82-113"><a href="#cb82-113" aria-hidden="true" tabindex="-1"></a>                Instruction <span class="op">*</span>load <span class="op">=</span> get_instruction_by_id<span class="op">(</span>func<span class="op">,</span> load_id<span class="op">);</span></span>
<span id="cb82-114"><a href="#cb82-114" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb82-115"><a href="#cb82-115" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span>profitable_to_hoist<span class="op">(</span>load<span class="op">,</span> block<span class="op">))</span> <span class="op">{</span></span>
<span id="cb82-116"><a href="#cb82-116" aria-hidden="true" tabindex="-1"></a>                    insert_load_on_edges<span class="op">(</span>load<span class="op">,</span> block<span class="op">);</span></span>
<span id="cb82-117"><a href="#cb82-117" aria-hidden="true" tabindex="-1"></a>                    changed <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb82-118"><a href="#cb82-118" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb82-119"><a href="#cb82-119" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb82-120"><a href="#cb82-120" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb82-121"><a href="#cb82-121" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb82-122"><a href="#cb82-122" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb82-123"><a href="#cb82-123" aria-hidden="true" tabindex="-1"></a>    free_bitset_array<span class="op">(</span>anticipated<span class="op">);</span></span>
<span id="cb82-124"><a href="#cb82-124" aria-hidden="true" tabindex="-1"></a>    free_bitset_array<span class="op">(</span>available<span class="op">);</span></span>
<span id="cb82-125"><a href="#cb82-125" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> changed<span class="op">;</span></span>
<span id="cb82-126"><a href="#cb82-126" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>7.8 ISSA-Specific Optimizations</h2>
<p>Optimizations targeting our Interpretable SSA form:</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="co">// -node chain collapsing</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> collapse_phi_chains<span class="op">(</span>Function <span class="op">*</span>func<span class="op">,</span> OptimizationContext <span class="op">*</span>ctx<span class="op">)</span> <span class="op">{</span></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> changed <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>BasicBlock <span class="op">*</span>block <span class="op">=</span> func<span class="op">-&gt;</span>cfg<span class="op">-&gt;</span>entry<span class="op">;</span> block<span class="op">;</span> block <span class="op">=</span> block<span class="op">-&gt;</span>next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span>Instruction <span class="op">*</span>inst <span class="op">=</span> block<span class="op">-&gt;</span>first<span class="op">;</span> </span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a>             inst <span class="op">&amp;&amp;</span> inst<span class="op">-&gt;</span>kind <span class="op">==</span> INST_PHI<span class="op">;</span> </span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a>             inst <span class="op">=</span> inst<span class="op">-&gt;</span>next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a>            PhiNode <span class="op">*</span>phi <span class="op">=</span> <span class="op">(</span>PhiNode<span class="op">*)</span>inst<span class="op">;</span></span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb83-11"><a href="#cb83-11" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Check if all inputs are -nodes</span></span>
<span id="cb83-12"><a href="#cb83-12" aria-hidden="true" tabindex="-1"></a>            <span class="dt">bool</span> all_phi_inputs <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb83-13"><a href="#cb83-13" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> phi<span class="op">-&gt;</span>incoming_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb83-14"><a href="#cb83-14" aria-hidden="true" tabindex="-1"></a>                Value <span class="op">*</span>input <span class="op">=</span> phi<span class="op">-&gt;</span>incoming_values<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb83-15"><a href="#cb83-15" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(!</span>input<span class="op">-&gt;</span>def_instruction <span class="op">||</span> </span>
<span id="cb83-16"><a href="#cb83-16" aria-hidden="true" tabindex="-1"></a>                    input<span class="op">-&gt;</span>def_instruction<span class="op">-&gt;</span>kind <span class="op">!=</span> INST_PHI<span class="op">)</span> <span class="op">{</span></span>
<span id="cb83-17"><a href="#cb83-17" aria-hidden="true" tabindex="-1"></a>                    all_phi_inputs <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb83-18"><a href="#cb83-18" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">break</span><span class="op">;</span></span>
<span id="cb83-19"><a href="#cb83-19" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb83-20"><a href="#cb83-20" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb83-21"><a href="#cb83-21" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb83-22"><a href="#cb83-22" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>all_phi_inputs<span class="op">)</span> <span class="op">{</span></span>
<span id="cb83-23"><a href="#cb83-23" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Attempt to bypass intermediate -nodes</span></span>
<span id="cb83-24"><a href="#cb83-24" aria-hidden="true" tabindex="-1"></a>                changed <span class="op">|=</span> bypass_phi_chain<span class="op">(</span>phi<span class="op">);</span></span>
<span id="cb83-25"><a href="#cb83-25" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb83-26"><a href="#cb83-26" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb83-27"><a href="#cb83-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb83-28"><a href="#cb83-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb83-29"><a href="#cb83-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> changed<span class="op">;</span></span>
<span id="cb83-30"><a href="#cb83-30" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb83-31"><a href="#cb83-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-32"><a href="#cb83-32" aria-hidden="true" tabindex="-1"></a><span class="co">// Specialize hot interpreter paths</span></span>
<span id="cb83-33"><a href="#cb83-33" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> specialize_hot_paths<span class="op">(</span>Function <span class="op">*</span>func<span class="op">,</span> OptimizationContext <span class="op">*</span>ctx<span class="op">)</span> <span class="op">{</span></span>
<span id="cb83-34"><a href="#cb83-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>ctx<span class="op">-&gt;</span>profile_data<span class="op">)</span> <span class="op">{</span></span>
<span id="cb83-35"><a href="#cb83-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb83-36"><a href="#cb83-36" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb83-37"><a href="#cb83-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb83-38"><a href="#cb83-38" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> changed <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb83-39"><a href="#cb83-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb83-40"><a href="#cb83-40" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Find hot edges in the CFG</span></span>
<span id="cb83-41"><a href="#cb83-41" aria-hidden="true" tabindex="-1"></a>    HotEdge <span class="op">*</span>hot_edges <span class="op">=</span> find_hot_edges<span class="op">(</span>func<span class="op">-&gt;</span>cfg<span class="op">,</span> ctx<span class="op">-&gt;</span>profile_data<span class="op">);</span></span>
<span id="cb83-42"><a href="#cb83-42" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> edge_count <span class="op">=</span> count_hot_edges<span class="op">(</span>hot_edges<span class="op">);</span></span>
<span id="cb83-43"><a href="#cb83-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb83-44"><a href="#cb83-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> edge_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb83-45"><a href="#cb83-45" aria-hidden="true" tabindex="-1"></a>        HotEdge <span class="op">*</span>edge <span class="op">=</span> <span class="op">&amp;</span>hot_edges<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb83-46"><a href="#cb83-46" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb83-47"><a href="#cb83-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>edge<span class="op">-&gt;</span>execution_count <span class="op">&gt;</span> HOT_EDGE_THRESHOLD<span class="op">)</span> <span class="op">{</span></span>
<span id="cb83-48"><a href="#cb83-48" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Clone and specialize the target block</span></span>
<span id="cb83-49"><a href="#cb83-49" aria-hidden="true" tabindex="-1"></a>            BasicBlock <span class="op">*</span>specialized <span class="op">=</span> clone_block<span class="op">(</span>edge<span class="op">-&gt;</span>target<span class="op">);</span></span>
<span id="cb83-50"><a href="#cb83-50" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb83-51"><a href="#cb83-51" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Optimize for the specific predecessor</span></span>
<span id="cb83-52"><a href="#cb83-52" aria-hidden="true" tabindex="-1"></a>            optimize_for_predecessor<span class="op">(</span>specialized<span class="op">,</span> edge<span class="op">-&gt;</span>source<span class="op">);</span></span>
<span id="cb83-53"><a href="#cb83-53" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb83-54"><a href="#cb83-54" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Redirect edge to specialized version</span></span>
<span id="cb83-55"><a href="#cb83-55" aria-hidden="true" tabindex="-1"></a>            redirect_edge<span class="op">(</span>edge<span class="op">-&gt;</span>source<span class="op">,</span> edge<span class="op">-&gt;</span>target<span class="op">,</span> specialized<span class="op">);</span></span>
<span id="cb83-56"><a href="#cb83-56" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb83-57"><a href="#cb83-57" aria-hidden="true" tabindex="-1"></a>            changed <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb83-58"><a href="#cb83-58" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb83-59"><a href="#cb83-59" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb83-60"><a href="#cb83-60" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb83-61"><a href="#cb83-61" aria-hidden="true" tabindex="-1"></a>    free<span class="op">(</span>hot_edges<span class="op">);</span></span>
<span id="cb83-62"><a href="#cb83-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> changed<span class="op">;</span></span>
<span id="cb83-63"><a href="#cb83-63" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb83-64"><a href="#cb83-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-65"><a href="#cb83-65" aria-hidden="true" tabindex="-1"></a><span class="co">// Instruction fusion for interpretation</span></span>
<span id="cb83-66"><a href="#cb83-66" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> fuse_instructions<span class="op">(</span>Function <span class="op">*</span>func<span class="op">,</span> OptimizationContext <span class="op">*</span>ctx<span class="op">)</span> <span class="op">{</span></span>
<span id="cb83-67"><a href="#cb83-67" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> changed <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb83-68"><a href="#cb83-68" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb83-69"><a href="#cb83-69" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>BasicBlock <span class="op">*</span>block <span class="op">=</span> func<span class="op">-&gt;</span>cfg<span class="op">-&gt;</span>entry<span class="op">;</span> block<span class="op">;</span> block <span class="op">=</span> block<span class="op">-&gt;</span>next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb83-70"><a href="#cb83-70" aria-hidden="true" tabindex="-1"></a>        Instruction <span class="op">*</span>inst <span class="op">=</span> block<span class="op">-&gt;</span>first<span class="op">;</span></span>
<span id="cb83-71"><a href="#cb83-71" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb83-72"><a href="#cb83-72" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> <span class="op">(</span>inst <span class="op">&amp;&amp;</span> inst<span class="op">-&gt;</span>next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb83-73"><a href="#cb83-73" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Look for fuseable patterns</span></span>
<span id="cb83-74"><a href="#cb83-74" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>can_fuse<span class="op">(</span>inst<span class="op">,</span> inst<span class="op">-&gt;</span>next<span class="op">))</span> <span class="op">{</span></span>
<span id="cb83-75"><a href="#cb83-75" aria-hidden="true" tabindex="-1"></a>                Instruction <span class="op">*</span>fused <span class="op">=</span> create_fused_instruction<span class="op">(</span>inst<span class="op">,</span> inst<span class="op">-&gt;</span>next<span class="op">);</span></span>
<span id="cb83-76"><a href="#cb83-76" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb83-77"><a href="#cb83-77" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Replace original instructions</span></span>
<span id="cb83-78"><a href="#cb83-78" aria-hidden="true" tabindex="-1"></a>                replace_instructions<span class="op">(</span>block<span class="op">,</span> inst<span class="op">,</span> inst<span class="op">-&gt;</span>next<span class="op">,</span> fused<span class="op">);</span></span>
<span id="cb83-79"><a href="#cb83-79" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb83-80"><a href="#cb83-80" aria-hidden="true" tabindex="-1"></a>                changed <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb83-81"><a href="#cb83-81" aria-hidden="true" tabindex="-1"></a>                inst <span class="op">=</span> fused<span class="op">-&gt;</span>next<span class="op">;</span></span>
<span id="cb83-82"><a href="#cb83-82" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb83-83"><a href="#cb83-83" aria-hidden="true" tabindex="-1"></a>                inst <span class="op">=</span> inst<span class="op">-&gt;</span>next<span class="op">;</span></span>
<span id="cb83-84"><a href="#cb83-84" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb83-85"><a href="#cb83-85" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb83-86"><a href="#cb83-86" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb83-87"><a href="#cb83-87" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb83-88"><a href="#cb83-88" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> changed<span class="op">;</span></span>
<span id="cb83-89"><a href="#cb83-89" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb83-90"><a href="#cb83-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-91"><a href="#cb83-91" aria-hidden="true" tabindex="-1"></a><span class="co">// Common fuseable patterns</span></span>
<span id="cb83-92"><a href="#cb83-92" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">bool</span> can_fuse<span class="op">(</span>Instruction <span class="op">*</span>first<span class="op">,</span> Instruction <span class="op">*</span>second<span class="op">)</span> <span class="op">{</span></span>
<span id="cb83-93"><a href="#cb83-93" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Load + arithmetic + store</span></span>
<span id="cb83-94"><a href="#cb83-94" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>first<span class="op">-&gt;</span>kind <span class="op">==</span> MEM_LOAD <span class="op">&amp;&amp;</span> </span>
<span id="cb83-95"><a href="#cb83-95" aria-hidden="true" tabindex="-1"></a>        is_arithmetic<span class="op">(</span>second<span class="op">-&gt;</span>kind<span class="op">)</span> <span class="op">&amp;&amp;</span></span>
<span id="cb83-96"><a href="#cb83-96" aria-hidden="true" tabindex="-1"></a>        second<span class="op">-&gt;</span>next <span class="op">&amp;&amp;</span> second<span class="op">-&gt;</span>next<span class="op">-&gt;</span>kind <span class="op">==</span> MEM_STORE<span class="op">)</span> <span class="op">{</span></span>
<span id="cb83-97"><a href="#cb83-97" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb83-98"><a href="#cb83-98" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Check if they form a read-modify-write pattern</span></span>
<span id="cb83-99"><a href="#cb83-99" aria-hidden="true" tabindex="-1"></a>        MemLoadInst <span class="op">*</span>load <span class="op">=</span> <span class="op">(</span>MemLoadInst<span class="op">*)</span>first<span class="op">;</span></span>
<span id="cb83-100"><a href="#cb83-100" aria-hidden="true" tabindex="-1"></a>        MemStoreInst <span class="op">*</span>store <span class="op">=</span> <span class="op">(</span>MemStoreInst<span class="op">*)</span>second<span class="op">-&gt;</span>next<span class="op">;</span></span>
<span id="cb83-101"><a href="#cb83-101" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb83-102"><a href="#cb83-102" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> same_address<span class="op">(</span>load<span class="op">-&gt;</span>address<span class="op">,</span> store<span class="op">-&gt;</span>address<span class="op">)</span> <span class="op">&amp;&amp;</span></span>
<span id="cb83-103"><a href="#cb83-103" aria-hidden="true" tabindex="-1"></a>               single_use<span class="op">(</span>first<span class="op">-&gt;</span>result<span class="op">)</span> <span class="op">&amp;&amp;</span></span>
<span id="cb83-104"><a href="#cb83-104" aria-hidden="true" tabindex="-1"></a>               single_use<span class="op">(</span>second<span class="op">-&gt;</span>result<span class="op">);</span></span>
<span id="cb83-105"><a href="#cb83-105" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb83-106"><a href="#cb83-106" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb83-107"><a href="#cb83-107" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Comparison + conditional branch</span></span>
<span id="cb83-108"><a href="#cb83-108" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>is_comparison<span class="op">(</span>first<span class="op">-&gt;</span>kind<span class="op">)</span> <span class="op">&amp;&amp;</span> second<span class="op">-&gt;</span>kind <span class="op">==</span> INST_BR_COND<span class="op">)</span> <span class="op">{</span></span>
<span id="cb83-109"><a href="#cb83-109" aria-hidden="true" tabindex="-1"></a>        CondBranchInst <span class="op">*</span>br <span class="op">=</span> <span class="op">(</span>CondBranchInst<span class="op">*)</span>second<span class="op">;</span></span>
<span id="cb83-110"><a href="#cb83-110" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> br<span class="op">-&gt;</span>condition <span class="op">==</span> first<span class="op">-&gt;</span>result <span class="op">&amp;&amp;</span> single_use<span class="op">(</span>first<span class="op">-&gt;</span>result<span class="op">);</span></span>
<span id="cb83-111"><a href="#cb83-111" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb83-112"><a href="#cb83-112" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb83-113"><a href="#cb83-113" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb83-114"><a href="#cb83-114" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>7.9 Profile-Guided Optimizations</h2>
<p>Using runtime profiling data to guide SSA optimizations:</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> ProfileData <span class="op">{</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Block execution counts</span></span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint64_t</span> <span class="op">*</span>block_counts<span class="op">;</span></span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Edge execution counts  </span></span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a>    HashMap <span class="op">*</span>edge_counts<span class="op">;</span></span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Value profiles</span></span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> ValueProfile <span class="op">{</span></span>
<span id="cb84-10"><a href="#cb84-10" aria-hidden="true" tabindex="-1"></a>        Value <span class="op">*</span>value<span class="op">;</span></span>
<span id="cb84-11"><a href="#cb84-11" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb84-12"><a href="#cb84-12" aria-hidden="true" tabindex="-1"></a>        <span class="co">// For integers: common values</span></span>
<span id="cb84-13"><a href="#cb84-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb84-14"><a href="#cb84-14" aria-hidden="true" tabindex="-1"></a>            <span class="dt">int64_t</span> value<span class="op">;</span></span>
<span id="cb84-15"><a href="#cb84-15" aria-hidden="true" tabindex="-1"></a>            <span class="dt">uint64_t</span> count<span class="op">;</span></span>
<span id="cb84-16"><a href="#cb84-16" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="op">*</span>common_values<span class="op">;</span></span>
<span id="cb84-17"><a href="#cb84-17" aria-hidden="true" tabindex="-1"></a>        <span class="dt">size_t</span> common_count<span class="op">;</span></span>
<span id="cb84-18"><a href="#cb84-18" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb84-19"><a href="#cb84-19" aria-hidden="true" tabindex="-1"></a>        <span class="co">// For pointers: null check results</span></span>
<span id="cb84-20"><a href="#cb84-20" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint64_t</span> null_count<span class="op">;</span></span>
<span id="cb84-21"><a href="#cb84-21" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint64_t</span> non_null_count<span class="op">;</span></span>
<span id="cb84-22"><a href="#cb84-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="op">*</span>value_profiles<span class="op">;</span></span>
<span id="cb84-23"><a href="#cb84-23" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> value_profile_count<span class="op">;</span></span>
<span id="cb84-24"><a href="#cb84-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> ProfileData<span class="op">;</span></span>
<span id="cb84-25"><a href="#cb84-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-26"><a href="#cb84-26" aria-hidden="true" tabindex="-1"></a><span class="co">// Profile-guided code layout</span></span>
<span id="cb84-27"><a href="#cb84-27" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> optimize_code_layout<span class="op">(</span>Function <span class="op">*</span>func<span class="op">,</span> OptimizationContext <span class="op">*</span>ctx<span class="op">)</span> <span class="op">{</span></span>
<span id="cb84-28"><a href="#cb84-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>ctx<span class="op">-&gt;</span>profile_data<span class="op">)</span> <span class="op">{</span></span>
<span id="cb84-29"><a href="#cb84-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb84-30"><a href="#cb84-30" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb84-31"><a href="#cb84-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb84-32"><a href="#cb84-32" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Build block chains based on edge profiles</span></span>
<span id="cb84-33"><a href="#cb84-33" aria-hidden="true" tabindex="-1"></a>    BlockChain <span class="op">**</span>chains <span class="op">=</span> build_block_chains<span class="op">(</span>func<span class="op">-&gt;</span>cfg<span class="op">,</span> ctx<span class="op">-&gt;</span>profile_data<span class="op">);</span></span>
<span id="cb84-34"><a href="#cb84-34" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> chain_count <span class="op">=</span> count_chains<span class="op">(</span>chains<span class="op">);</span></span>
<span id="cb84-35"><a href="#cb84-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb84-36"><a href="#cb84-36" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Merge chains to minimize taken branches</span></span>
<span id="cb84-37"><a href="#cb84-37" aria-hidden="true" tabindex="-1"></a>    BlockChain <span class="op">*</span>final_chain <span class="op">=</span> merge_chains<span class="op">(</span>chains<span class="op">,</span> chain_count<span class="op">,</span> </span>
<span id="cb84-38"><a href="#cb84-38" aria-hidden="true" tabindex="-1"></a>                                          ctx<span class="op">-&gt;</span>profile_data<span class="op">);</span></span>
<span id="cb84-39"><a href="#cb84-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb84-40"><a href="#cb84-40" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Reorder blocks according to final chain</span></span>
<span id="cb84-41"><a href="#cb84-41" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> changed <span class="op">=</span> reorder_blocks<span class="op">(</span>func<span class="op">-&gt;</span>cfg<span class="op">,</span> final_chain<span class="op">);</span></span>
<span id="cb84-42"><a href="#cb84-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb84-43"><a href="#cb84-43" aria-hidden="true" tabindex="-1"></a>    free_block_chains<span class="op">(</span>chains<span class="op">);</span></span>
<span id="cb84-44"><a href="#cb84-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> changed<span class="op">;</span></span>
<span id="cb84-45"><a href="#cb84-45" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb84-46"><a href="#cb84-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-47"><a href="#cb84-47" aria-hidden="true" tabindex="-1"></a><span class="co">// Value specialization based on profiles</span></span>
<span id="cb84-48"><a href="#cb84-48" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> specialize_values<span class="op">(</span>Function <span class="op">*</span>func<span class="op">,</span> OptimizationContext <span class="op">*</span>ctx<span class="op">)</span> <span class="op">{</span></span>
<span id="cb84-49"><a href="#cb84-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>ctx<span class="op">-&gt;</span>profile_data<span class="op">)</span> <span class="op">{</span></span>
<span id="cb84-50"><a href="#cb84-50" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb84-51"><a href="#cb84-51" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb84-52"><a href="#cb84-52" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb84-53"><a href="#cb84-53" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> changed <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb84-54"><a href="#cb84-54" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb84-55"><a href="#cb84-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> ctx<span class="op">-&gt;</span>profile_data<span class="op">-&gt;</span>value_profile_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb84-56"><a href="#cb84-56" aria-hidden="true" tabindex="-1"></a>        ValueProfile <span class="op">*</span>profile <span class="op">=</span> <span class="op">&amp;</span>ctx<span class="op">-&gt;</span>profile_data<span class="op">-&gt;</span>value_profiles<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb84-57"><a href="#cb84-57" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb84-58"><a href="#cb84-58" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>should_specialize_value<span class="op">(</span>profile<span class="op">))</span> <span class="op">{</span></span>
<span id="cb84-59"><a href="#cb84-59" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Create specialized versions</span></span>
<span id="cb84-60"><a href="#cb84-60" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> profile<span class="op">-&gt;</span>common_count <span class="op">&amp;&amp;</span> </span>
<span id="cb84-61"><a href="#cb84-61" aria-hidden="true" tabindex="-1"></a>                              j <span class="op">&lt;</span> MAX_SPECIALIZATIONS<span class="op">;</span> j<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb84-62"><a href="#cb84-62" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span>profile<span class="op">-&gt;</span>common_values<span class="op">[</span>j<span class="op">].</span>count <span class="op">&gt;</span> </span>
<span id="cb84-63"><a href="#cb84-63" aria-hidden="true" tabindex="-1"></a>                    SPECIALIZATION_THRESHOLD<span class="op">)</span> <span class="op">{</span></span>
<span id="cb84-64"><a href="#cb84-64" aria-hidden="true" tabindex="-1"></a>                    create_specialized_path<span class="op">(</span>func<span class="op">,</span> profile<span class="op">-&gt;</span>value<span class="op">,</span></span>
<span id="cb84-65"><a href="#cb84-65" aria-hidden="true" tabindex="-1"></a>                                          profile<span class="op">-&gt;</span>common_values<span class="op">[</span>j<span class="op">].</span>value<span class="op">);</span></span>
<span id="cb84-66"><a href="#cb84-66" aria-hidden="true" tabindex="-1"></a>                    changed <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb84-67"><a href="#cb84-67" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb84-68"><a href="#cb84-68" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb84-69"><a href="#cb84-69" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb84-70"><a href="#cb84-70" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb84-71"><a href="#cb84-71" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb84-72"><a href="#cb84-72" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> changed<span class="op">;</span></span>
<span id="cb84-73"><a href="#cb84-73" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>7.10 Optimization Pipeline Configuration</h2>
<p>Configurable optimization pipeline for different scenarios:</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Optimization pipeline templates</span></span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> OptimizationPass O1_passes<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">{.</span>name <span class="op">=</span> <span class="st">&quot;dce&quot;</span><span class="op">,</span> <span class="op">.</span>execute <span class="op">=</span> dead_code_elimination<span class="op">},</span></span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">{.</span>name <span class="op">=</span> <span class="st">&quot;constant-prop&quot;</span><span class="op">,</span> <span class="op">.</span>execute <span class="op">=</span> sparse_conditional_constant_propagation<span class="op">},</span></span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">{.</span>name <span class="op">=</span> <span class="st">&quot;gvn&quot;</span><span class="op">,</span> <span class="op">.</span>execute <span class="op">=</span> global_value_numbering<span class="op">},</span></span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">{.</span>name <span class="op">=</span> <span class="st">&quot;simplify-cfg&quot;</span><span class="op">,</span> <span class="op">.</span>execute <span class="op">=</span> simplify_control_flow<span class="op">},</span></span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-9"><a href="#cb85-9" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> OptimizationPass O2_passes<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb85-10"><a href="#cb85-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// All O1 passes plus:</span></span>
<span id="cb85-11"><a href="#cb85-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">{.</span>name <span class="op">=</span> <span class="st">&quot;licm&quot;</span><span class="op">,</span> <span class="op">.</span>execute <span class="op">=</span> loop_invariant_code_motion<span class="op">},</span></span>
<span id="cb85-12"><a href="#cb85-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">{.</span>name <span class="op">=</span> <span class="st">&quot;strength-reduce&quot;</span><span class="op">,</span> <span class="op">.</span>execute <span class="op">=</span> strength_reduce_loops<span class="op">},</span></span>
<span id="cb85-13"><a href="#cb85-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">{.</span>name <span class="op">=</span> <span class="st">&quot;dse-mssa&quot;</span><span class="op">,</span> <span class="op">.</span>execute <span class="op">=</span> dead_store_elimination_mssa<span class="op">},</span></span>
<span id="cb85-14"><a href="#cb85-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">{.</span>name <span class="op">=</span> <span class="st">&quot;memory-pre&quot;</span><span class="op">,</span> <span class="op">.</span>execute <span class="op">=</span> memory_pre<span class="op">},</span></span>
<span id="cb85-15"><a href="#cb85-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">{.</span>name <span class="op">=</span> <span class="st">&quot;inline&quot;</span><span class="op">,</span> <span class="op">.</span>execute <span class="op">=</span> inline_functions<span class="op">},</span></span>
<span id="cb85-16"><a href="#cb85-16" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb85-17"><a href="#cb85-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-18"><a href="#cb85-18" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> OptimizationPass O3_passes<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb85-19"><a href="#cb85-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">// All O2 passes plus:</span></span>
<span id="cb85-20"><a href="#cb85-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">{.</span>name <span class="op">=</span> <span class="st">&quot;aggressive-dce&quot;</span><span class="op">,</span> <span class="op">.</span>execute <span class="op">=</span> aggressive_dead_code_elimination<span class="op">},</span></span>
<span id="cb85-21"><a href="#cb85-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">{.</span>name <span class="op">=</span> <span class="st">&quot;loop-unroll&quot;</span><span class="op">,</span> <span class="op">.</span>execute <span class="op">=</span> unroll_loops<span class="op">},</span></span>
<span id="cb85-22"><a href="#cb85-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">{.</span>name <span class="op">=</span> <span class="st">&quot;vectorize&quot;</span><span class="op">,</span> <span class="op">.</span>execute <span class="op">=</span> vectorize_loops<span class="op">},</span></span>
<span id="cb85-23"><a href="#cb85-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">{.</span>name <span class="op">=</span> <span class="st">&quot;specialize-hot&quot;</span><span class="op">,</span> <span class="op">.</span>execute <span class="op">=</span> specialize_hot_paths<span class="op">},</span></span>
<span id="cb85-24"><a href="#cb85-24" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb85-25"><a href="#cb85-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-26"><a href="#cb85-26" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> OptimizationPass Os_passes<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb85-27"><a href="#cb85-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Size optimization</span></span>
<span id="cb85-28"><a href="#cb85-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">{.</span>name <span class="op">=</span> <span class="st">&quot;dce&quot;</span><span class="op">,</span> <span class="op">.</span>execute <span class="op">=</span> dead_code_elimination<span class="op">},</span></span>
<span id="cb85-29"><a href="#cb85-29" aria-hidden="true" tabindex="-1"></a>    <span class="op">{.</span>name <span class="op">=</span> <span class="st">&quot;constant-prop&quot;</span><span class="op">,</span> <span class="op">.</span>execute <span class="op">=</span> sparse_conditional_constant_propagation<span class="op">},</span></span>
<span id="cb85-30"><a href="#cb85-30" aria-hidden="true" tabindex="-1"></a>    <span class="op">{.</span>name <span class="op">=</span> <span class="st">&quot;merge-blocks&quot;</span><span class="op">,</span> <span class="op">.</span>execute <span class="op">=</span> merge_identical_blocks<span class="op">},</span></span>
<span id="cb85-31"><a href="#cb85-31" aria-hidden="true" tabindex="-1"></a>    <span class="op">{.</span>name <span class="op">=</span> <span class="st">&quot;outline&quot;</span><span class="op">,</span> <span class="op">.</span>execute <span class="op">=</span> outline_cold_code<span class="op">},</span></span>
<span id="cb85-32"><a href="#cb85-32" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb85-33"><a href="#cb85-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-34"><a href="#cb85-34" aria-hidden="true" tabindex="-1"></a><span class="co">// ISSA-specific optimization passes</span></span>
<span id="cb85-35"><a href="#cb85-35" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> OptimizationPass ISSA_passes<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb85-36"><a href="#cb85-36" aria-hidden="true" tabindex="-1"></a>    <span class="op">{.</span>name <span class="op">=</span> <span class="st">&quot;collapse-phi&quot;</span><span class="op">,</span> <span class="op">.</span>execute <span class="op">=</span> collapse_phi_chains<span class="op">},</span></span>
<span id="cb85-37"><a href="#cb85-37" aria-hidden="true" tabindex="-1"></a>    <span class="op">{.</span>name <span class="op">=</span> <span class="st">&quot;fuse-inst&quot;</span><span class="op">,</span> <span class="op">.</span>execute <span class="op">=</span> fuse_instructions<span class="op">},</span></span>
<span id="cb85-38"><a href="#cb85-38" aria-hidden="true" tabindex="-1"></a>    <span class="op">{.</span>name <span class="op">=</span> <span class="st">&quot;specialize-phi&quot;</span><span class="op">,</span> <span class="op">.</span>execute <span class="op">=</span> specialize_phi_nodes<span class="op">},</span></span>
<span id="cb85-39"><a href="#cb85-39" aria-hidden="true" tabindex="-1"></a>    <span class="op">{.</span>name <span class="op">=</span> <span class="st">&quot;optimize-memory-ssa&quot;</span><span class="op">,</span> <span class="op">.</span>execute <span class="op">=</span> optimize_memory_operations<span class="op">},</span></span>
<span id="cb85-40"><a href="#cb85-40" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<h2>7.11 Optimization Verification</h2>
<p>Ensuring optimizations preserve program semantics:</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> VerificationContext <span class="op">{</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>    Function <span class="op">*</span>original<span class="op">;</span></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>    Function <span class="op">*</span>optimized<span class="op">;</span></span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Verification results</span></span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> semantics_preserved<span class="op">;</span></span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> ssa_properties_valid<span class="op">;</span></span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> type_safety_maintained<span class="op">;</span></span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Error reporting</span></span>
<span id="cb86-11"><a href="#cb86-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> error_buffer<span class="op">[</span><span class="dv">1024</span><span class="op">];</span></span>
<span id="cb86-12"><a href="#cb86-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> VerificationContext<span class="op">;</span></span>
<span id="cb86-13"><a href="#cb86-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-14"><a href="#cb86-14" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> verify_optimization<span class="op">(</span>Function <span class="op">*</span>original<span class="op">,</span> Function <span class="op">*</span>optimized<span class="op">,</span></span>
<span id="cb86-15"><a href="#cb86-15" aria-hidden="true" tabindex="-1"></a>                        <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>pass_name<span class="op">)</span> <span class="op">{</span></span>
<span id="cb86-16"><a href="#cb86-16" aria-hidden="true" tabindex="-1"></a>    VerificationContext ctx <span class="op">=</span> <span class="op">{</span></span>
<span id="cb86-17"><a href="#cb86-17" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>original <span class="op">=</span> original<span class="op">,</span></span>
<span id="cb86-18"><a href="#cb86-18" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>optimized <span class="op">=</span> optimized</span>
<span id="cb86-19"><a href="#cb86-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb86-20"><a href="#cb86-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb86-21"><a href="#cb86-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Verify SSA properties</span></span>
<span id="cb86-22"><a href="#cb86-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>verify_ssa_form<span class="op">(</span>optimized<span class="op">))</span> <span class="op">{</span></span>
<span id="cb86-23"><a href="#cb86-23" aria-hidden="true" tabindex="-1"></a>        snprintf<span class="op">(</span>ctx<span class="op">.</span>error_buffer<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>ctx<span class="op">.</span>error_buffer<span class="op">),</span></span>
<span id="cb86-24"><a href="#cb86-24" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;Pass &#39;</span><span class="sc">%s</span><span class="st">&#39; broke SSA properties&quot;</span><span class="op">,</span> pass_name<span class="op">);</span></span>
<span id="cb86-25"><a href="#cb86-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb86-26"><a href="#cb86-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb86-27"><a href="#cb86-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb86-28"><a href="#cb86-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Verify dominance properties</span></span>
<span id="cb86-29"><a href="#cb86-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>verify_dominance<span class="op">(</span>optimized<span class="op">))</span> <span class="op">{</span></span>
<span id="cb86-30"><a href="#cb86-30" aria-hidden="true" tabindex="-1"></a>        snprintf<span class="op">(</span>ctx<span class="op">.</span>error_buffer<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>ctx<span class="op">.</span>error_buffer<span class="op">),</span></span>
<span id="cb86-31"><a href="#cb86-31" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;Pass &#39;</span><span class="sc">%s</span><span class="st">&#39; broke dominance properties&quot;</span><span class="op">,</span> pass_name<span class="op">);</span></span>
<span id="cb86-32"><a href="#cb86-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb86-33"><a href="#cb86-33" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb86-34"><a href="#cb86-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb86-35"><a href="#cb86-35" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Type checking</span></span>
<span id="cb86-36"><a href="#cb86-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>verify_types<span class="op">(</span>optimized<span class="op">))</span> <span class="op">{</span></span>
<span id="cb86-37"><a href="#cb86-37" aria-hidden="true" tabindex="-1"></a>        snprintf<span class="op">(</span>ctx<span class="op">.</span>error_buffer<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>ctx<span class="op">.</span>error_buffer<span class="op">),</span></span>
<span id="cb86-38"><a href="#cb86-38" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;Pass &#39;</span><span class="sc">%s</span><span class="st">&#39; introduced type errors&quot;</span><span class="op">,</span> pass_name<span class="op">);</span></span>
<span id="cb86-39"><a href="#cb86-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb86-40"><a href="#cb86-40" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb86-41"><a href="#cb86-41" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb86-42"><a href="#cb86-42" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Optional: semantic equivalence checking</span></span>
<span id="cb86-43"><a href="#cb86-43" aria-hidden="true" tabindex="-1"></a>    <span class="pp">#ifdef ENABLE_SEMANTIC_VERIFICATION</span></span>
<span id="cb86-44"><a href="#cb86-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>verify_semantic_equivalence<span class="op">(</span>original<span class="op">,</span> optimized<span class="op">))</span> <span class="op">{</span></span>
<span id="cb86-45"><a href="#cb86-45" aria-hidden="true" tabindex="-1"></a>        snprintf<span class="op">(</span>ctx<span class="op">.</span>error_buffer<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>ctx<span class="op">.</span>error_buffer<span class="op">),</span></span>
<span id="cb86-46"><a href="#cb86-46" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;Pass &#39;</span><span class="sc">%s</span><span class="st">&#39; changed program semantics&quot;</span><span class="op">,</span> pass_name<span class="op">);</span></span>
<span id="cb86-47"><a href="#cb86-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb86-48"><a href="#cb86-48" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb86-49"><a href="#cb86-49" aria-hidden="true" tabindex="-1"></a>    <span class="pp">#endif</span></span>
<span id="cb86-50"><a href="#cb86-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb86-51"><a href="#cb86-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb86-52"><a href="#cb86-52" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>7.12 Performance Monitoring</h2>
<p>Tracking optimization effectiveness:</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> OptimizationMetrics <span class="op">{</span></span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Per-pass metrics</span></span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> PassMetrics <span class="op">{</span></span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>        <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>name<span class="op">;</span></span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a>        <span class="dt">double</span> execution_time<span class="op">;</span></span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a>        <span class="dt">size_t</span> transformations<span class="op">;</span></span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a>        <span class="dt">size_t</span> instructions_before<span class="op">;</span></span>
<span id="cb87-8"><a href="#cb87-8" aria-hidden="true" tabindex="-1"></a>        <span class="dt">size_t</span> instructions_after<span class="op">;</span></span>
<span id="cb87-9"><a href="#cb87-9" aria-hidden="true" tabindex="-1"></a>        <span class="dt">size_t</span> blocks_before<span class="op">;</span></span>
<span id="cb87-10"><a href="#cb87-10" aria-hidden="true" tabindex="-1"></a>        <span class="dt">size_t</span> blocks_after<span class="op">;</span></span>
<span id="cb87-11"><a href="#cb87-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="op">*</span>pass_metrics<span class="op">;</span></span>
<span id="cb87-12"><a href="#cb87-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> pass_count<span class="op">;</span></span>
<span id="cb87-13"><a href="#cb87-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb87-14"><a href="#cb87-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Overall metrics</span></span>
<span id="cb87-15"><a href="#cb87-15" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> total_transformations<span class="op">;</span></span>
<span id="cb87-16"><a href="#cb87-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> total_optimization_time<span class="op">;</span></span>
<span id="cb87-17"><a href="#cb87-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb87-18"><a href="#cb87-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Code quality metrics</span></span>
<span id="cb87-19"><a href="#cb87-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb87-20"><a href="#cb87-20" aria-hidden="true" tabindex="-1"></a>        <span class="dt">size_t</span> static_instruction_count<span class="op">;</span></span>
<span id="cb87-21"><a href="#cb87-21" aria-hidden="true" tabindex="-1"></a>        <span class="dt">size_t</span> phi_nodes<span class="op">;</span></span>
<span id="cb87-22"><a href="#cb87-22" aria-hidden="true" tabindex="-1"></a>        <span class="dt">size_t</span> memory_operations<span class="op">;</span></span>
<span id="cb87-23"><a href="#cb87-23" aria-hidden="true" tabindex="-1"></a>        <span class="dt">size_t</span> branches<span class="op">;</span></span>
<span id="cb87-24"><a href="#cb87-24" aria-hidden="true" tabindex="-1"></a>        <span class="dt">double</span> average_block_size<span class="op">;</span></span>
<span id="cb87-25"><a href="#cb87-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> code_metrics<span class="op">;</span></span>
<span id="cb87-26"><a href="#cb87-26" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> OptimizationMetrics<span class="op">;</span></span>
<span id="cb87-27"><a href="#cb87-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-28"><a href="#cb87-28" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> collect_optimization_metrics<span class="op">(</span>Function <span class="op">*</span>func<span class="op">,</span> OptimizationMetrics <span class="op">*</span>metrics<span class="op">,</span></span>
<span id="cb87-29"><a href="#cb87-29" aria-hidden="true" tabindex="-1"></a>                                <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>pass_name<span class="op">,</span> <span class="dt">bool</span> before<span class="op">)</span> <span class="op">{</span></span>
<span id="cb87-30"><a href="#cb87-30" aria-hidden="true" tabindex="-1"></a>    PassMetrics <span class="op">*</span>pm <span class="op">=</span> find_or_create_pass_metrics<span class="op">(</span>metrics<span class="op">,</span> pass_name<span class="op">);</span></span>
<span id="cb87-31"><a href="#cb87-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb87-32"><a href="#cb87-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>before<span class="op">)</span> <span class="op">{</span></span>
<span id="cb87-33"><a href="#cb87-33" aria-hidden="true" tabindex="-1"></a>        pm<span class="op">-&gt;</span>instructions_before <span class="op">=</span> count_instructions<span class="op">(</span>func<span class="op">);</span></span>
<span id="cb87-34"><a href="#cb87-34" aria-hidden="true" tabindex="-1"></a>        pm<span class="op">-&gt;</span>blocks_before <span class="op">=</span> func<span class="op">-&gt;</span>cfg<span class="op">-&gt;</span>block_count<span class="op">;</span></span>
<span id="cb87-35"><a href="#cb87-35" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb87-36"><a href="#cb87-36" aria-hidden="true" tabindex="-1"></a>        pm<span class="op">-&gt;</span>instructions_after <span class="op">=</span> count_instructions<span class="op">(</span>func<span class="op">);</span></span>
<span id="cb87-37"><a href="#cb87-37" aria-hidden="true" tabindex="-1"></a>        pm<span class="op">-&gt;</span>blocks_after <span class="op">=</span> func<span class="op">-&gt;</span>cfg<span class="op">-&gt;</span>block_count<span class="op">;</span></span>
<span id="cb87-38"><a href="#cb87-38" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb87-39"><a href="#cb87-39" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Update code quality metrics</span></span>
<span id="cb87-40"><a href="#cb87-40" aria-hidden="true" tabindex="-1"></a>        update_code_metrics<span class="op">(</span>func<span class="op">,</span> <span class="op">&amp;</span>metrics<span class="op">-&gt;</span>code_metrics<span class="op">);</span></span>
<span id="cb87-41"><a href="#cb87-41" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb87-42"><a href="#cb87-42" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>7.13 Summary</h2>
<p>SSA-based optimizations in Diyrbal leverage the unique properties of
SSA form to enable powerful transformations:</p>
<ol type="1">
<li><strong>Dead Code Elimination</strong> - Precise liveness analysis
through def-use chains</li>
<li><strong>Constant Propagation</strong> - Sparse conditional constant
propagation</li>
<li><strong>Global Value Numbering</strong> - Eliminating redundant
computations</li>
<li><strong>Loop Optimizations</strong> - LICM, strength reduction, and
induction variable analysis</li>
<li><strong>Memory SSA Optimizations</strong> - Dead store elimination
and PRE for memory</li>
<li><strong>ISSA-Specific Optimizations</strong> - -node specialization
and instruction fusion</li>
<li><strong>Profile-Guided Optimizations</strong> - Using runtime data
to guide transformations</li>
</ol>
<p>The optimization framework is designed to be:</p>
<ul>
<li><strong>Modular</strong>: Each pass is independent and
composable</li>
<li><strong>Verifiable</strong>: Optimizations can be validated for
correctness</li>
<li><strong>Configurable</strong>: Different optimization levels for
different use cases</li>
<li><strong>Profile-aware</strong>: Can leverage runtime profiling
data</li>
<li><strong>ISSA-aware</strong>: Special optimizations for our
interpretable form</li>
</ul>
<p>These optimizations work together to produce efficient code while
maintaining the interpretability advantages of ISSA form. The next
chapter will explore type inference on this optimized SSA
representation. Based on the materials you&#39;ve provided and the context
from your previous Chapter 7 summary about the Diyrbal VM
implementation, I can create a conceptual outline of what Chapter 8 on
&quot;Concurrency and Coroutines&quot; might contain for such a VM implementation.
This draws inspiration from the concurrency concepts in Joe Armstrong&#39;s
thesis and VM implementation patterns from the other papers.</p>
<h1>Chapter 8: Concurrency and Coroutines</h1>
<h2>8.1 Introduction</h2>
<p>Building on the SSA optimizations from Chapter 7, this chapter
introduces Diyrbal&#39;s concurrency model, which combines lightweight
coroutines with message-passing concurrency. The design is influenced by
Erlang&#39;s actor model while maintaining compatibility with the ISSA
representation.</p>
<h2>8.2 Coroutine Architecture</h2>
<h3>8.2.1 Coroutine State Representation</h3>
<div class="sourceCode" id="cb88"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> Coroutine <span class="op">{</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>    CoroutineID id<span class="op">;</span></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>    CoroutineState state<span class="op">;</span>  <span class="co">// SUSPENDED, RUNNING, COMPLETED, FAILED</span></span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>    SSAFunction <span class="op">*</span>function<span class="op">;</span></span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a>    ValueStack <span class="op">*</span>stack<span class="op">;</span></span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a>    BasicBlock <span class="op">*</span>resume_block<span class="op">;</span></span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a>    Instruction <span class="op">*</span>resume_point<span class="op">;</span></span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a>    MemoryVersion <span class="op">*</span>memory_context<span class="op">;</span></span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true" tabindex="-1"></a>    MessageQueue <span class="op">*</span>mailbox<span class="op">;</span></span>
<span id="cb88-10"><a href="#cb88-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> Coroutine<span class="op">;</span></span></code></pre></div>
<h3>8.2.2 Yield Points in ISSA</h3>
<p>The ISSA representation is extended with yield instructions:</p>
<ul>
<li><code>INST_YIELD</code> - Cooperative yield with optional value</li>
<li><code>INST_AWAIT</code> - Yield until message/condition</li>
<li><code>INST_SPAWN</code> - Create new coroutine from SSA
function</li>
</ul>
<h2>8.3 Message Passing Primitives</h2>
<p>Following Erlang&#39;s philosophy of isolated processes:</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> Message <span class="op">{</span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>    Value payload<span class="op">;</span></span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>    CoroutineID sender<span class="op">;</span></span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>    MessageTag tag<span class="op">;</span></span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> Message <span class="op">*</span>next<span class="op">;</span></span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> Message<span class="op">;</span></span>
<span id="cb89-7"><a href="#cb89-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-8"><a href="#cb89-8" aria-hidden="true" tabindex="-1"></a><span class="co">// Core messaging instructions</span></span>
<span id="cb89-9"><a href="#cb89-9" aria-hidden="true" tabindex="-1"></a>INST_SEND    <span class="co">// Non-blocking send</span></span>
<span id="cb89-10"><a href="#cb89-10" aria-hidden="true" tabindex="-1"></a>INST_RECEIVE <span class="co">// Pattern-matching receive</span></span>
<span id="cb89-11"><a href="#cb89-11" aria-hidden="true" tabindex="-1"></a>INST_TIMEOUT <span class="co">// Receive with timeout</span></span></code></pre></div>
<h2>8.4 Scheduler Implementation</h2>
<h3>8.4.1 Work-Stealing Scheduler</h3>
<p>A multi-core aware scheduler using work-stealing queues:</p>
<ul>
<li>Per-thread run queues</li>
<li>Lock-free steal operations</li>
<li>Priority-based scheduling with fairness</li>
</ul>
<h3>8.4.2 Preemption Points</h3>
<p>Strategic placement of preemption checks:</p>
<ul>
<li>After N instructions (configurable)</li>
<li>At memory allocation points</li>
<li>At message send/receive operations</li>
</ul>
<h2>8.5 Memory Isolation</h2>
<h3>8.5.1 Per-Coroutine Heaps</h3>
<p>Each coroutine maintains isolated memory:</p>
<ul>
<li>Private heap allocation</li>
<li>Copy-on-message semantics</li>
<li>Independent garbage collection</li>
</ul>
<h3>8.5.2 Shared Nothing Architecture</h3>
<p>No shared mutable state between coroutines:</p>
<ul>
<li>All communication through messages</li>
<li>Immutable shared data structures</li>
<li>Reference counting for large binaries</li>
</ul>
<h2>8.6 Fault Tolerance Primitives</h2>
<h3>8.6.1 Link and Monitor</h3>
<p>Implementing Erlang-style process linking:</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> ProcessLink <span class="op">{</span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>    CoroutineID linked_process<span class="op">;</span></span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>    LinkType type<span class="op">;</span>  <span class="co">// LINK or MONITOR</span></span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> trap_exit<span class="op">;</span></span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> ProcessLink<span class="op">;</span></span></code></pre></div>
<h3>8.6.2 Supervision Trees</h3>
<p>Building fault-tolerant systems through supervision:</p>
<ul>
<li>Restart strategies (one-for-one, one-for-all)</li>
<li>Maximum restart frequency</li>
<li>Child specifications</li>
</ul>
<h2>8.7 Coroutine Optimizations</h2>
<h3>8.7.1 Tail Call Optimization for Message Loops</h3>
<p>Converting tail-recursive message handling into efficient loops.</p>
<h3>8.7.2 Message Queue Optimizations</h3>
<ul>
<li>Selective receive optimization</li>
<li>Message queue compaction</li>
<li>Priority message handling</li>
</ul>
<h2>8.8 Integration with SSA Optimizations</h2>
<h3>8.8.1 Cross-Coroutine Analysis</h3>
<p>Limited whole-program analysis respecting isolation:</p>
<ul>
<li>Message flow analysis</li>
<li>Deadlock detection</li>
<li>Resource usage profiling</li>
</ul>
<h3>8.8.2 Coroutine-Aware Inlining</h3>
<p>Selective inlining of small coroutines into their spawners when
provably safe.</p>
<h2>8.9 Debugging and Profiling Support</h2>
<h3>8.9.1 Coroutine Inspection</h3>
<p>Runtime facilities for debugging:</p>
<ul>
<li>Stack trace across yields</li>
<li>Message trace logging</li>
<li>State snapshots</li>
</ul>
<h3>8.9.2 Performance Monitoring</h3>
<ul>
<li>Per-coroutine CPU accounting</li>
<li>Message queue length monitoring</li>
<li>Scheduler fairness metrics</li>
</ul>
<h2>8.10 Native Integration</h2>
<h3>8.10.1 Foreign Function Interface (FFI)</h3>
<p>Safe FFI with coroutine awareness:</p>
<ul>
<li>Non-blocking I/O integration</li>
<li>Callback marshaling</li>
<li>Resource cleanup on coroutine termination</li>
</ul>
<h2>8.11 Verification</h2>
<p>Extending the verification framework from Chapter 7:</p>
<ul>
<li>Deadlock freedom analysis</li>
<li>Message ordering guarantees</li>
<li>Memory isolation verification</li>
</ul>
<h2>8.12 Performance Considerations</h2>
<p>Benchmarking results showing:</p>
<ul>
<li>Coroutine creation/destruction overhead</li>
<li>Message passing latency</li>
<li>Scaling characteristics on multi-core systems</li>
</ul>
<p>This chapter establishes Diyrbal&#39;s approach to concurrency, providing
the foundation for building scalable, fault-tolerant applications while
maintaining the optimization opportunities identified in previous
chapters.</p>
<hr />
<p>This outline synthesizes concepts from the Erlang concurrency model
described in Armstrong&#39;s thesis with the VM implementation patterns from
your other materials, creating a coherent chapter that would follow
naturally from the SSA optimizations described in Chapter 7. Based on
the context from your previous chapters about the Diyrbal VM
implementation with SSA optimizations and concurrency, here&#39;s Chapter 9
on Bytecode Emission:</p>
<h1>Chapter 9: Bytecode Emission</h1>
<h2>9.1 Introduction</h2>
<p>After SSA optimizations and concurrency transformations, Diyrbal
emits compact bytecode for efficient interpretation or JIT compilation.
This chapter describes the translation from optimized ISSA form to the
final bytecode representation, maintaining the semantic properties
established in previous phases.</p>
<h2>9.2 Bytecode Architecture</h2>
<h3>9.2.1 Instruction Format</h3>
<p>Diyrbal uses a variable-length encoding scheme:</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">enum</span> BytecodeFormat <span class="op">{</span></span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>    FMT_COMPACT<span class="op">,</span>    <span class="co">// 1 byte: opcode only</span></span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>    FMT_SINGLE<span class="op">,</span>     <span class="co">// 2 bytes: opcode + 1 operand</span></span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a>    FMT_DOUBLE<span class="op">,</span>     <span class="co">// 3 bytes: opcode + 2 operands</span></span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a>    FMT_EXTENDED<span class="op">,</span>   <span class="co">// 4+ bytes: opcode + extended operands</span></span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> BytecodeFormat<span class="op">;</span></span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> BytecodeInst <span class="op">{</span></span>
<span id="cb91-9"><a href="#cb91-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint8_t</span> opcode<span class="op">;</span></span>
<span id="cb91-10"><a href="#cb91-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">union</span> <span class="op">{</span></span>
<span id="cb91-11"><a href="#cb91-11" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint8_t</span> byte_operands<span class="op">[</span><span class="dv">3</span><span class="op">];</span></span>
<span id="cb91-12"><a href="#cb91-12" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint16_t</span> word_operand<span class="op">;</span></span>
<span id="cb91-13"><a href="#cb91-13" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint32_t</span> extended_operand<span class="op">;</span></span>
<span id="cb91-14"><a href="#cb91-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> operands<span class="op">;</span></span>
<span id="cb91-15"><a href="#cb91-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> BytecodeInst<span class="op">;</span></span></code></pre></div>
<h3>9.2.2 Opcode Categories</h3>
<ul>
<li><strong>Stack Operations</strong>: PUSH, POP, DUP, SWAP</li>
<li><strong>Arithmetic</strong>: ADD, SUB, MUL, DIV, MOD</li>
<li><strong>Memory</strong>: LOAD, STORE, NEW, ARRAY_GET, ARRAY_SET</li>
<li><strong>Control Flow</strong>: JMP, JMP_IF, CALL, RET, YIELD</li>
<li><strong>Concurrency</strong>: SPAWN, SEND, RECEIVE, LINK</li>
</ul>
<h2>9.3 SSA to Stack-Based Translation</h2>
<h3>9.3.1 Virtual Register Allocation</h3>
<p>Converting SSA&#39;s infinite registers to stack slots:</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> RegisterMap <span class="op">{</span></span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>    SSAValue <span class="op">*</span>ssa_value<span class="op">;</span></span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> stack_slot<span class="op">;</span></span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> is_spilled<span class="op">;</span></span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> last_use<span class="op">;</span></span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> RegisterMap<span class="op">;</span></span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> allocate_registers<span class="op">(</span>Function <span class="op">*</span>func<span class="op">,</span> RegisterMap <span class="op">**</span>map<span class="op">)</span> <span class="op">{</span></span>
<span id="cb92-9"><a href="#cb92-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Linear scan allocation with spilling</span></span>
<span id="cb92-10"><a href="#cb92-10" aria-hidden="true" tabindex="-1"></a>    compute_live_intervals<span class="op">(</span>func<span class="op">);</span></span>
<span id="cb92-11"><a href="#cb92-11" aria-hidden="true" tabindex="-1"></a>    assign_stack_slots<span class="op">(</span>func<span class="op">,</span> map<span class="op">);</span></span>
<span id="cb92-12"><a href="#cb92-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3>9.3.2 Phi Node Resolution</h3>
<p>Phi nodes are eliminated through strategic copies:</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> emit_phi_resolution<span class="op">(</span>BasicBlock <span class="op">*</span>block<span class="op">,</span> EmitContext <span class="op">*</span>ctx<span class="op">)</span> <span class="op">{</span></span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Insert moves at predecessor exits</span></span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>PhiNode <span class="op">*</span>phi <span class="op">=</span> block<span class="op">-&gt;</span>phis<span class="op">;</span> phi<span class="op">;</span> phi <span class="op">=</span> phi<span class="op">-&gt;</span>next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> phi<span class="op">-&gt;</span>num_operands<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a>            BasicBlock <span class="op">*</span>pred <span class="op">=</span> block<span class="op">-&gt;</span>predecessors<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a>            emit_move_at_block_end<span class="op">(</span>pred<span class="op">,</span> phi<span class="op">-&gt;</span>operands<span class="op">[</span>i<span class="op">],</span> </span>
<span id="cb93-7"><a href="#cb93-7" aria-hidden="true" tabindex="-1"></a>                                 phi<span class="op">-&gt;</span>result<span class="op">,</span> ctx<span class="op">);</span></span>
<span id="cb93-8"><a href="#cb93-8" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb93-9"><a href="#cb93-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb93-10"><a href="#cb93-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>9.4 Instruction Selection</h2>
<h3>9.4.1 Pattern Matching</h3>
<p>Using the instruction fusion results from Chapter 7:</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> Pattern <span class="op">{</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>    InstructionKind kinds<span class="op">[</span>MAX_PATTERN_SIZE<span class="op">];</span></span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> pattern_length<span class="op">;</span></span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>    BytecodeOp target_op<span class="op">;</span></span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> <span class="op">(*</span>emit_func<span class="op">)(</span>Pattern <span class="op">*</span>p<span class="op">,</span> Instruction <span class="op">*</span>start<span class="op">,</span> EmitContext <span class="op">*</span>ctx<span class="op">);</span></span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> Pattern<span class="op">;</span></span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a><span class="co">// Example: fused increment pattern</span></span>
<span id="cb94-9"><a href="#cb94-9" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> Pattern increment_pattern <span class="op">=</span> <span class="op">{</span></span>
<span id="cb94-10"><a href="#cb94-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>kinds <span class="op">=</span> <span class="op">{</span>MEM_LOAD<span class="op">,</span> INST_ADD_IMM<span class="op">,</span> MEM_STORE<span class="op">},</span></span>
<span id="cb94-11"><a href="#cb94-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>pattern_length <span class="op">=</span> <span class="dv">3</span><span class="op">,</span></span>
<span id="cb94-12"><a href="#cb94-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>target_op <span class="op">=</span> OP_INC_MEM<span class="op">,</span></span>
<span id="cb94-13"><a href="#cb94-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>emit_func <span class="op">=</span> emit_increment</span>
<span id="cb94-14"><a href="#cb94-14" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<h3>9.4.2 Addressing Mode Selection</h3>
<p>Choosing optimal addressing modes for memory operations:</p>
<ul>
<li>Direct (constant address)</li>
<li>Indirect (register)</li>
<li>Indexed (register + offset)</li>
<li>Scaled (register + register * scale)</li>
</ul>
<h2>9.5 Constant Pool Management</h2>
<h3>9.5.1 Constant Deduplication</h3>
<div class="sourceCode" id="cb95"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> ConstantPool <span class="op">{</span></span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>    Value <span class="op">*</span>constants<span class="op">;</span></span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> count<span class="op">;</span></span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> capacity<span class="op">;</span></span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a>    HashMap <span class="op">*</span>value_to_index<span class="op">;</span></span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> ConstantPool<span class="op">;</span></span>
<span id="cb95-7"><a href="#cb95-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-8"><a href="#cb95-8" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">uint16_t</span> emit_constant<span class="op">(</span>Value val<span class="op">,</span> ConstantPool <span class="op">*</span>pool<span class="op">)</span> <span class="op">{</span></span>
<span id="cb95-9"><a href="#cb95-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint16_t</span> existing <span class="op">=</span> lookup_constant<span class="op">(</span>pool<span class="op">,</span> val<span class="op">);</span></span>
<span id="cb95-10"><a href="#cb95-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>existing <span class="op">!=</span> CONSTANT_NOT_FOUND<span class="op">)</span> <span class="cf">return</span> existing<span class="op">;</span></span>
<span id="cb95-11"><a href="#cb95-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> add_constant<span class="op">(</span>pool<span class="op">,</span> val<span class="op">);</span></span>
<span id="cb95-12"><a href="#cb95-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3>9.5.2 String Interning</h3>
<p>All string constants are interned for fast comparison and reduced
memory usage.</p>
<h2>9.6 Control Flow Encoding</h2>
<h3>9.6.1 Jump Target Resolution</h3>
<p>Two-pass approach for forward jumps:</p>
<div class="sourceCode" id="cb96"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> JumpPatch <span class="op">{</span></span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> instruction_offset<span class="op">;</span></span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>    BasicBlock <span class="op">*</span>target_block<span class="op">;</span></span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a>    JumpType type<span class="op">;</span>  <span class="co">// ABSOLUTE or RELATIVE</span></span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> JumpPatch<span class="op">;</span></span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> resolve_jumps<span class="op">(</span>BytecodeBuffer <span class="op">*</span>buf<span class="op">,</span> JumpPatch <span class="op">*</span>patches<span class="op">)</span> <span class="op">{</span></span>
<span id="cb96-8"><a href="#cb96-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>JumpPatch <span class="op">*</span>p <span class="op">=</span> patches<span class="op">;</span> p<span class="op">;</span> p <span class="op">=</span> p<span class="op">-&gt;</span>next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb96-9"><a href="#cb96-9" aria-hidden="true" tabindex="-1"></a>        <span class="dt">size_t</span> target_offset <span class="op">=</span> p<span class="op">-&gt;</span>target_block<span class="op">-&gt;</span>bytecode_offset<span class="op">;</span></span>
<span id="cb96-10"><a href="#cb96-10" aria-hidden="true" tabindex="-1"></a>        patch_jump_target<span class="op">(</span>buf<span class="op">,</span> p<span class="op">-&gt;</span>instruction_offset<span class="op">,</span> target_offset<span class="op">);</span></span>
<span id="cb96-11"><a href="#cb96-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb96-12"><a href="#cb96-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3>9.6.2 Exception Table Generation</h3>
<p>Mapping bytecode ranges to exception handlers:</p>
<div class="sourceCode" id="cb97"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> ExceptionEntry <span class="op">{</span></span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> start_offset<span class="op">;</span></span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> end_offset<span class="op">;</span></span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> handler_offset<span class="op">;</span></span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint16_t</span> exception_type<span class="op">;</span></span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> ExceptionEntry<span class="op">;</span></span></code></pre></div>
<h2>9.7 Debug Information</h2>
<h3>9.7.1 Source Mapping</h3>
<p>Preserving source location information:</p>
<div class="sourceCode" id="cb98"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> SourceMap <span class="op">{</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> bytecode_offset<span class="op">;</span></span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> source_line<span class="op">;</span></span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> source_column<span class="op">;</span></span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint16_t</span> file_index<span class="op">;</span></span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> SourceMap<span class="op">;</span></span></code></pre></div>
<h3>9.7.2 Variable Name Preservation</h3>
<p>Optional debug table for local variable names and scopes.</p>
<h2>9.8 Optimization During Emission</h2>
<h3>9.8.1 Peephole Optimization</h3>
<p>Final optimization pass during emission:</p>
<ul>
<li>Dead store elimination after spilling</li>
<li>Redundant load elimination</li>
<li>Jump threading for fall-through blocks</li>
</ul>
<h3>9.8.2 Compact Encoding Selection</h3>
<p>Choosing the smallest instruction encoding:</p>
<div class="sourceCode" id="cb99"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> emit_load_constant<span class="op">(</span><span class="dt">uint16_t</span> const_idx<span class="op">,</span> EmitContext <span class="op">*</span>ctx<span class="op">)</span> <span class="op">{</span></span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>const_idx <span class="op">&lt;</span> <span class="dv">256</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a>        emit_byte<span class="op">(</span>OP_LOAD_CONST_BYTE<span class="op">,</span> ctx<span class="op">);</span></span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a>        emit_byte<span class="op">(</span>const_idx<span class="op">,</span> ctx<span class="op">);</span></span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a>        emit_byte<span class="op">(</span>OP_LOAD_CONST_WORD<span class="op">,</span> ctx<span class="op">);</span></span>
<span id="cb99-7"><a href="#cb99-7" aria-hidden="true" tabindex="-1"></a>        emit_word<span class="op">(</span>const_idx<span class="op">,</span> ctx<span class="op">);</span></span>
<span id="cb99-8"><a href="#cb99-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb99-9"><a href="#cb99-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>9.9 Bytecode Verification</h2>
<h3>9.9.1 Stack Balance Verification</h3>
<p>Ensuring stack depth is consistent across control flow:</p>
<div class="sourceCode" id="cb100"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">bool</span> verify_stack_balance<span class="op">(</span>BytecodeFunction <span class="op">*</span>func<span class="op">)</span> <span class="op">{</span></span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> <span class="op">*</span>stack_depths <span class="op">=</span> compute_stack_depths<span class="op">(</span>func<span class="op">);</span></span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> verify_consistent_depths<span class="op">(</span>func<span class="op">,</span> stack_depths<span class="op">);</span></span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3>9.9.2 Type Safety Verification</h3>
<p>Lightweight bytecode verification for type safety.</p>
<h2>9.10 Serialization Format</h2>
<h3>9.10.1 Module Structure</h3>
<div class="sourceCode" id="cb101"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> BytecodeModule <span class="op">{</span></span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> magic<span class="op">;</span>        <span class="co">// &quot;DYRB&quot;</span></span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> version<span class="op">;</span></span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a>    ConstantPool constants<span class="op">;</span></span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a>    FunctionTable functions<span class="op">;</span></span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a>    TypeTable types<span class="op">;</span></span>
<span id="cb101-7"><a href="#cb101-7" aria-hidden="true" tabindex="-1"></a>    DebugInfo debug<span class="op">;</span></span>
<span id="cb101-8"><a href="#cb101-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> BytecodeModule<span class="op">;</span></span></code></pre></div>
<h3>9.10.2 Compression</h3>
<p>Optional zlib compression for deployment.</p>
<h2>9.11 Performance Considerations</h2>
<h3>9.11.1 Instruction Cache Optimization</h3>
<ul>
<li>Hot/cold code separation</li>
<li>Basic block alignment</li>
<li>Jump table optimization</li>
</ul>
<h3>9.11.2 Interpreter Dispatch Optimization</h3>
<p>Generated specialized dispatch code for common instruction
sequences.</p>
<h2>9.12 Integration with JIT</h2>
<p>Bytecode designed for efficient JIT compilation:</p>
<ul>
<li>Type annotations preserved</li>
<li>Profile counters embedded</li>
<li>Deoptimization points marked</li>
</ul>
<p>This chapter completes the compilation pipeline, transforming
optimized SSA into efficient bytecode ready for interpretation or
further compilation. The next chapter will cover the runtime system that
executes this bytecode. Based on the progression from bytecode emission
in Chapter 9 and the VM implementation context from your materials,
here&#39;s Chapter 10 on Indirect Threaded Code Implementation:</p>
<h1>Chapter 10: Indirect Threaded Code Implementation</h1>
<h2>10.1 Introduction</h2>
<p>Building on the bytecode format from Chapter 9, this chapter presents
Diyrbal&#39;s indirect threaded code interpretera high-performance
execution engine that eliminates interpreter dispatch overhead through
computed goto and threading techniques.</p>
<h2>10.2 Threading Models Overview</h2>
<h3>10.2.1 Interpretation Techniques Comparison</h3>
<ul>
<li><strong>Switch Dispatch</strong>: Traditional, portable, but
slow</li>
<li><strong>Direct Threading</strong>: Fast, requires compiler
support</li>
<li><strong>Indirect Threading</strong>: Balance of performance and
flexibility</li>
<li><strong>Subroutine Threading</strong>: Best for JIT integration</li>
</ul>
<h3>10.2.2 Why Indirect Threading</h3>
<p>Diyrbal uses indirect threading for:</p>
<ul>
<li>Efficient instruction dispatch</li>
<li>Easy bytecode patching for optimization</li>
<li>Seamless integration with profiling</li>
<li>Platform independence with fallback options</li>
</ul>
<h2>10.3 Core Threading Architecture</h2>
<h3>10.3.1 Opcode Handler Table</h3>
<div class="sourceCode" id="cb102"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="dt">void</span> <span class="op">(*</span>OpcodeHandler<span class="op">)(</span>VMState <span class="op">*</span>vm<span class="op">);</span></span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Handler table indexed by opcode</span></span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> OpcodeHandler handlers<span class="op">[</span><span class="dv">256</span><span class="op">]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>OP_NOP<span class="op">]</span>         <span class="op">=</span> op_nop<span class="op">,</span></span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>OP_LOAD_CONST<span class="op">]</span>  <span class="op">=</span> op_load_const<span class="op">,</span></span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>OP_ADD<span class="op">]</span>         <span class="op">=</span> op_add<span class="op">,</span></span>
<span id="cb102-8"><a href="#cb102-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>OP_SUB<span class="op">]</span>         <span class="op">=</span> op_sub<span class="op">,</span></span>
<span id="cb102-9"><a href="#cb102-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ... all 256 entries</span></span>
<span id="cb102-10"><a href="#cb102-10" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb102-11"><a href="#cb102-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-12"><a href="#cb102-12" aria-hidden="true" tabindex="-1"></a><span class="co">// Threaded code representation</span></span>
<span id="cb102-13"><a href="#cb102-13" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> ThreadedCode <span class="op">{</span></span>
<span id="cb102-14"><a href="#cb102-14" aria-hidden="true" tabindex="-1"></a>    OpcodeHandler <span class="op">*</span>handlers<span class="op">;</span></span>
<span id="cb102-15"><a href="#cb102-15" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> length<span class="op">;</span></span>
<span id="cb102-16"><a href="#cb102-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint8_t</span> <span class="op">*</span>operands<span class="op">;</span></span>
<span id="cb102-17"><a href="#cb102-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> ThreadedCode<span class="op">;</span></span></code></pre></div>
<h3>10.3.2 Threading Transformation</h3>
<div class="sourceCode" id="cb103"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> ThreadedCode<span class="op">*</span> thread_bytecode<span class="op">(</span>BytecodeFunction <span class="op">*</span>func<span class="op">)</span> <span class="op">{</span></span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>    ThreadedCode <span class="op">*</span>tc <span class="op">=</span> allocate_threaded_code<span class="op">(</span>func<span class="op">-&gt;</span>length<span class="op">);</span></span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> func<span class="op">-&gt;</span>length<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint8_t</span> opcode <span class="op">=</span> func<span class="op">-&gt;</span>code<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb103-6"><a href="#cb103-6" aria-hidden="true" tabindex="-1"></a>        tc<span class="op">-&gt;</span>handlers<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> handlers<span class="op">[</span>opcode<span class="op">];</span></span>
<span id="cb103-7"><a href="#cb103-7" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Copy operands based on instruction format</span></span>
<span id="cb103-8"><a href="#cb103-8" aria-hidden="true" tabindex="-1"></a>        copy_instruction_operands<span class="op">(</span>tc<span class="op">,</span> func<span class="op">,</span> i<span class="op">);</span></span>
<span id="cb103-9"><a href="#cb103-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb103-10"><a href="#cb103-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb103-11"><a href="#cb103-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tc<span class="op">;</span></span>
<span id="cb103-12"><a href="#cb103-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>10.4 Dispatch Mechanisms</h2>
<h3>10.4.1 Portable Indirect Threading</h3>
<div class="sourceCode" id="cb104"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#define DISPATCH</span><span class="op">()</span><span class="pp"> </span><span class="cf">goto</span><span class="pp"> </span><span class="op">**(</span><span class="pp">vm</span><span class="op">-&gt;</span><span class="pp">pc</span><span class="op">++)</span></span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#define NEXT</span><span class="op">()</span><span class="pp">     DISPATCH</span><span class="op">()</span></span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> execute_threaded<span class="op">(</span>VMState <span class="op">*</span>vm<span class="op">,</span> ThreadedCode <span class="op">*</span>tc<span class="op">)</span> <span class="op">{</span></span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>    vm<span class="op">-&gt;</span>pc <span class="op">=</span> tc<span class="op">-&gt;</span>handlers<span class="op">;</span></span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a>    DISPATCH<span class="op">();</span></span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb104-8"><a href="#cb104-8" aria-hidden="true" tabindex="-1"></a>op_nop<span class="op">:</span></span>
<span id="cb104-9"><a href="#cb104-9" aria-hidden="true" tabindex="-1"></a>    NEXT<span class="op">();</span></span>
<span id="cb104-10"><a href="#cb104-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb104-11"><a href="#cb104-11" aria-hidden="true" tabindex="-1"></a>op_load_const<span class="op">:</span></span>
<span id="cb104-12"><a href="#cb104-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb104-13"><a href="#cb104-13" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint16_t</span> idx <span class="op">=</span> read_u16<span class="op">(</span>vm<span class="op">-&gt;</span>operands<span class="op">);</span></span>
<span id="cb104-14"><a href="#cb104-14" aria-hidden="true" tabindex="-1"></a>        push<span class="op">(</span>vm<span class="op">,</span> vm<span class="op">-&gt;</span>constants<span class="op">[</span>idx<span class="op">]);</span></span>
<span id="cb104-15"><a href="#cb104-15" aria-hidden="true" tabindex="-1"></a>        NEXT<span class="op">();</span></span>
<span id="cb104-16"><a href="#cb104-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb104-17"><a href="#cb104-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb104-18"><a href="#cb104-18" aria-hidden="true" tabindex="-1"></a>op_add<span class="op">:</span></span>
<span id="cb104-19"><a href="#cb104-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb104-20"><a href="#cb104-20" aria-hidden="true" tabindex="-1"></a>        Value b <span class="op">=</span> pop<span class="op">(</span>vm<span class="op">);</span></span>
<span id="cb104-21"><a href="#cb104-21" aria-hidden="true" tabindex="-1"></a>        Value a <span class="op">=</span> pop<span class="op">(</span>vm<span class="op">);</span></span>
<span id="cb104-22"><a href="#cb104-22" aria-hidden="true" tabindex="-1"></a>        push<span class="op">(</span>vm<span class="op">,</span> value_add<span class="op">(</span>a<span class="op">,</span> b<span class="op">));</span></span>
<span id="cb104-23"><a href="#cb104-23" aria-hidden="true" tabindex="-1"></a>        NEXT<span class="op">();</span></span>
<span id="cb104-24"><a href="#cb104-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb104-25"><a href="#cb104-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ... other handlers</span></span>
<span id="cb104-26"><a href="#cb104-26" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3>10.4.2 Fallback Switch Implementation</h3>
<p>For compilers without computed goto:</p>
<div class="sourceCode" id="cb105"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> execute_switch_fallback<span class="op">(</span>VMState <span class="op">*</span>vm<span class="op">,</span> ThreadedCode <span class="op">*</span>tc<span class="op">)</span> <span class="op">{</span></span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span>vm<span class="op">-&gt;</span>pc <span class="op">&lt;</span> tc<span class="op">-&gt;</span>handlers <span class="op">+</span> tc<span class="op">-&gt;</span>length<span class="op">)</span> <span class="op">{</span></span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>        OpcodeHandler handler <span class="op">=</span> <span class="op">*</span>vm<span class="op">-&gt;</span>pc<span class="op">++;</span></span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Map handler address back to opcode for switch</span></span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint8_t</span> opcode <span class="op">=</span> handler_to_opcode<span class="op">(</span>handler<span class="op">);</span></span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb105-8"><a href="#cb105-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">switch</span> <span class="op">(</span>opcode<span class="op">)</span> <span class="op">{</span></span>
<span id="cb105-9"><a href="#cb105-9" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> OP_NOP<span class="op">:</span> <span class="cf">break</span><span class="op">;</span></span>
<span id="cb105-10"><a href="#cb105-10" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> OP_LOAD_CONST<span class="op">:</span> <span class="co">/* ... */</span> <span class="cf">break</span><span class="op">;</span></span>
<span id="cb105-11"><a href="#cb105-11" aria-hidden="true" tabindex="-1"></a>            <span class="co">// ...</span></span>
<span id="cb105-12"><a href="#cb105-12" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb105-13"><a href="#cb105-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb105-14"><a href="#cb105-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>10.5 Stack Management</h2>
<h3>10.5.1 Hybrid Stack Implementation</h3>
<div class="sourceCode" id="cb106"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> VMStack <span class="op">{</span></span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>    Value <span class="op">*</span>base<span class="op">;</span></span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>    Value <span class="op">*</span>top<span class="op">;</span></span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a>    Value <span class="op">*</span>end<span class="op">;</span></span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Fast access to top elements</span></span>
<span id="cb106-7"><a href="#cb106-7" aria-hidden="true" tabindex="-1"></a>    Value cache<span class="op">[</span>STACK_CACHE_SIZE<span class="op">];</span></span>
<span id="cb106-8"><a href="#cb106-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> cache_depth<span class="op">;</span></span>
<span id="cb106-9"><a href="#cb106-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> VMStack<span class="op">;</span></span>
<span id="cb106-10"><a href="#cb106-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-11"><a href="#cb106-11" aria-hidden="true" tabindex="-1"></a><span class="co">// Macros for common operations</span></span>
<span id="cb106-12"><a href="#cb106-12" aria-hidden="true" tabindex="-1"></a><span class="pp">#define PUSH</span><span class="op">(</span><span class="pp">v</span><span class="op">)</span><span class="pp"> </span><span class="op">(</span><span class="pp">vm</span><span class="op">-&gt;</span><span class="pp">stack</span><span class="op">.</span><span class="pp">top </span><span class="op">&lt;</span><span class="pp"> vm</span><span class="op">-&gt;</span><span class="pp">stack</span><span class="op">.</span><span class="pp">end </span><span class="op">?</span><span class="pp"> </span><span class="op">\</span></span>
<span id="cb106-13"><a href="#cb106-13" aria-hidden="true" tabindex="-1"></a><span class="pp">                </span><span class="op">(*</span><span class="pp">vm</span><span class="op">-&gt;</span><span class="pp">stack</span><span class="op">.</span><span class="pp">top</span><span class="op">++</span><span class="pp"> </span><span class="op">=</span><span class="pp"> </span><span class="op">(</span><span class="pp">v</span><span class="op">))</span><span class="pp"> </span><span class="op">:</span><span class="pp"> </span><span class="op">\</span></span>
<span id="cb106-14"><a href="#cb106-14" aria-hidden="true" tabindex="-1"></a><span class="pp">                stack_overflow</span><span class="op">(</span><span class="pp">vm</span><span class="op">))</span></span>
<span id="cb106-15"><a href="#cb106-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-16"><a href="#cb106-16" aria-hidden="true" tabindex="-1"></a><span class="pp">#define POP</span><span class="op">()</span><span class="pp">   </span><span class="op">(</span><span class="pp">vm</span><span class="op">-&gt;</span><span class="pp">stack</span><span class="op">.</span><span class="pp">top </span><span class="op">&gt;</span><span class="pp"> vm</span><span class="op">-&gt;</span><span class="pp">stack</span><span class="op">.</span><span class="pp">base </span><span class="op">?</span><span class="pp"> </span><span class="op">\</span></span>
<span id="cb106-17"><a href="#cb106-17" aria-hidden="true" tabindex="-1"></a><span class="pp">                </span><span class="op">(*--</span><span class="pp">vm</span><span class="op">-&gt;</span><span class="pp">stack</span><span class="op">.</span><span class="pp">top</span><span class="op">)</span><span class="pp"> </span><span class="op">:</span><span class="pp"> </span><span class="op">\</span></span>
<span id="cb106-18"><a href="#cb106-18" aria-hidden="true" tabindex="-1"></a><span class="pp">                stack_underflow</span><span class="op">(</span><span class="pp">vm</span><span class="op">))</span></span></code></pre></div>
<h3>10.5.2 Stack Caching Strategy</h3>
<p>Keep frequently accessed values in registers:</p>
<div class="sourceCode" id="cb107"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#define CACHED_TOS    </span><span class="op">(</span><span class="pp">vm</span><span class="op">-&gt;</span><span class="pp">stack</span><span class="op">.</span><span class="pp">cache</span><span class="op">[</span><span class="dv">0</span><span class="op">])</span></span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#define CACHED_TOS1   </span><span class="op">(</span><span class="pp">vm</span><span class="op">-&gt;</span><span class="pp">stack</span><span class="op">.</span><span class="pp">cache</span><span class="op">[</span><span class="dv">1</span><span class="op">])</span></span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#define SYNC_STACK</span><span class="op">()</span><span class="pp">  sync_cache_to_stack</span><span class="op">(</span><span class="pp">vm</span><span class="op">)</span></span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#define LOAD_CACHE</span><span class="op">()</span><span class="pp">  load_stack_to_cache</span><span class="op">(</span><span class="pp">vm</span><span class="op">)</span></span></code></pre></div>
<h2>10.6 Operand Encoding Optimizations</h2>
<h3>10.6.1 Inline Operands</h3>
<p>Small operands embedded in the handler stream:</p>
<div class="sourceCode" id="cb108"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">union</span> <span class="op">{</span></span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>    OpcodeHandler handler<span class="op">;</span></span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">intptr_t</span> inline_operand<span class="op">;</span></span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> ThreadedWord<span class="op">;</span></span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a><span class="co">// Usage in handlers</span></span>
<span id="cb108-7"><a href="#cb108-7" aria-hidden="true" tabindex="-1"></a>op_push_int_inline<span class="op">:</span></span>
<span id="cb108-8"><a href="#cb108-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb108-9"><a href="#cb108-9" aria-hidden="true" tabindex="-1"></a>        <span class="dt">intptr_t</span> value <span class="op">=</span> <span class="op">(</span><span class="dt">intptr_t</span><span class="op">)*</span>vm<span class="op">-&gt;</span>pc<span class="op">++;</span></span>
<span id="cb108-10"><a href="#cb108-10" aria-hidden="true" tabindex="-1"></a>        push<span class="op">(</span>vm<span class="op">,</span> make_int_value<span class="op">(</span>value<span class="op">));</span></span>
<span id="cb108-11"><a href="#cb108-11" aria-hidden="true" tabindex="-1"></a>        NEXT<span class="op">();</span></span>
<span id="cb108-12"><a href="#cb108-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span></code></pre></div>
<h3>10.6.2 Operand Specialization</h3>
<p>Multiple handlers for common cases:</p>
<div class="sourceCode" id="cb109"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Specialized handlers for small constants</span></span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>op_load_const_0<span class="op">:</span> push<span class="op">(</span>vm<span class="op">,</span> vm<span class="op">-&gt;</span>constants<span class="op">[</span><span class="dv">0</span><span class="op">]);</span> NEXT<span class="op">();</span></span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>op_load_const_1<span class="op">:</span> push<span class="op">(</span>vm<span class="op">,</span> vm<span class="op">-&gt;</span>constants<span class="op">[</span><span class="dv">1</span><span class="op">]);</span> NEXT<span class="op">();</span></span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a>op_load_const_2<span class="op">:</span> push<span class="op">(</span>vm<span class="op">,</span> vm<span class="op">-&gt;</span>constants<span class="op">[</span><span class="dv">2</span><span class="op">]);</span> NEXT<span class="op">();</span></span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a><span class="co">// ... up to some threshold</span></span></code></pre></div>
<h2>10.7 Control Flow Implementation</h2>
<h3>10.7.1 Branch Threading</h3>
<p>Direct threading of branch targets:</p>
<div class="sourceCode" id="cb110"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>op_jump<span class="op">:</span></span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a>        <span class="dt">ptrdiff_t</span> offset <span class="op">=</span> read_i32<span class="op">(</span>vm<span class="op">-&gt;</span>operands<span class="op">);</span></span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a>        vm<span class="op">-&gt;</span>pc <span class="op">+=</span> offset<span class="op">;</span>  <span class="co">// Already contains handler addresses</span></span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a>        DISPATCH<span class="op">();</span></span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb110-7"><a href="#cb110-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-8"><a href="#cb110-8" aria-hidden="true" tabindex="-1"></a>op_jump_if_true<span class="op">:</span></span>
<span id="cb110-9"><a href="#cb110-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb110-10"><a href="#cb110-10" aria-hidden="true" tabindex="-1"></a>        Value cond <span class="op">=</span> POP<span class="op">();</span></span>
<span id="cb110-11"><a href="#cb110-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>is_truthy<span class="op">(</span>cond<span class="op">))</span> <span class="op">{</span></span>
<span id="cb110-12"><a href="#cb110-12" aria-hidden="true" tabindex="-1"></a>            <span class="dt">ptrdiff_t</span> offset <span class="op">=</span> read_i32<span class="op">(</span>vm<span class="op">-&gt;</span>operands<span class="op">);</span></span>
<span id="cb110-13"><a href="#cb110-13" aria-hidden="true" tabindex="-1"></a>            vm<span class="op">-&gt;</span>pc <span class="op">+=</span> offset<span class="op">;</span></span>
<span id="cb110-14"><a href="#cb110-14" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb110-15"><a href="#cb110-15" aria-hidden="true" tabindex="-1"></a>            vm<span class="op">-&gt;</span>operands <span class="op">+=</span> <span class="dv">4</span><span class="op">;</span>  <span class="co">// Skip offset</span></span>
<span id="cb110-16"><a href="#cb110-16" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb110-17"><a href="#cb110-17" aria-hidden="true" tabindex="-1"></a>        DISPATCH<span class="op">();</span></span>
<span id="cb110-18"><a href="#cb110-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span></code></pre></div>
<h3>10.7.2 Call Threading</h3>
<p>Efficient function calls:</p>
<div class="sourceCode" id="cb111"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> CallFrame <span class="op">{</span></span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a>    ThreadedCode <span class="op">*</span>code<span class="op">;</span></span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a>    OpcodeHandler <span class="op">*</span>return_pc<span class="op">;</span></span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a>    Value <span class="op">*</span>locals<span class="op">;</span></span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> local_count<span class="op">;</span></span>
<span id="cb111-6"><a href="#cb111-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> CallFrame<span class="op">;</span></span>
<span id="cb111-7"><a href="#cb111-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-8"><a href="#cb111-8" aria-hidden="true" tabindex="-1"></a>op_call<span class="op">:</span></span>
<span id="cb111-9"><a href="#cb111-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb111-10"><a href="#cb111-10" aria-hidden="true" tabindex="-1"></a>        Function <span class="op">*</span>func <span class="op">=</span> <span class="op">(</span>Function<span class="op">*)</span>POP<span class="op">().</span>ptr<span class="op">;</span></span>
<span id="cb111-11"><a href="#cb111-11" aria-hidden="true" tabindex="-1"></a>        push_call_frame<span class="op">(</span>vm<span class="op">,</span> func<span class="op">);</span></span>
<span id="cb111-12"><a href="#cb111-12" aria-hidden="true" tabindex="-1"></a>        vm<span class="op">-&gt;</span>pc <span class="op">=</span> func<span class="op">-&gt;</span>threaded_code<span class="op">-&gt;</span>handlers<span class="op">;</span></span>
<span id="cb111-13"><a href="#cb111-13" aria-hidden="true" tabindex="-1"></a>        DISPATCH<span class="op">();</span></span>
<span id="cb111-14"><a href="#cb111-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span></code></pre></div>
<h2>10.8 Inline Caching</h2>
<h3>10.8.1 Monomorphic Inline Caches</h3>
<div class="sourceCode" id="cb112"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> InlineCache <span class="op">{</span></span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span>cached_value<span class="op">;</span></span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> guard<span class="op">;</span></span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> InlineCache<span class="op">;</span></span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-6"><a href="#cb112-6" aria-hidden="true" tabindex="-1"></a>op_get_field_cached<span class="op">:</span></span>
<span id="cb112-7"><a href="#cb112-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb112-8"><a href="#cb112-8" aria-hidden="true" tabindex="-1"></a>        Value obj <span class="op">=</span> POP<span class="op">();</span></span>
<span id="cb112-9"><a href="#cb112-9" aria-hidden="true" tabindex="-1"></a>        InlineCache <span class="op">*</span>cache <span class="op">=</span> <span class="op">(</span>InlineCache<span class="op">*)</span>vm<span class="op">-&gt;</span>operands<span class="op">;</span></span>
<span id="cb112-10"><a href="#cb112-10" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb112-11"><a href="#cb112-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>obj<span class="op">.</span>type <span class="op">==</span> cache<span class="op">-&gt;</span>guard<span class="op">)</span> <span class="op">{</span></span>
<span id="cb112-12"><a href="#cb112-12" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Fast path</span></span>
<span id="cb112-13"><a href="#cb112-13" aria-hidden="true" tabindex="-1"></a>            FieldOffset <span class="op">*</span>offset <span class="op">=</span> <span class="op">(</span>FieldOffset<span class="op">*)</span>cache<span class="op">-&gt;</span>cached_value<span class="op">;</span></span>
<span id="cb112-14"><a href="#cb112-14" aria-hidden="true" tabindex="-1"></a>            push<span class="op">(</span>vm<span class="op">,</span> get_field_fast<span class="op">(</span>obj<span class="op">,</span> offset<span class="op">));</span></span>
<span id="cb112-15"><a href="#cb112-15" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb112-16"><a href="#cb112-16" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Slow path with cache update</span></span>
<span id="cb112-17"><a href="#cb112-17" aria-hidden="true" tabindex="-1"></a>            update_field_cache<span class="op">(</span>vm<span class="op">,</span> cache<span class="op">,</span> obj<span class="op">);</span></span>
<span id="cb112-18"><a href="#cb112-18" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb112-19"><a href="#cb112-19" aria-hidden="true" tabindex="-1"></a>        vm<span class="op">-&gt;</span>operands <span class="op">+=</span> <span class="kw">sizeof</span><span class="op">(</span>InlineCache<span class="op">);</span></span>
<span id="cb112-20"><a href="#cb112-20" aria-hidden="true" tabindex="-1"></a>        NEXT<span class="op">();</span></span>
<span id="cb112-21"><a href="#cb112-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span></code></pre></div>
<h3>10.8.2 Polymorphic Inline Caches</h3>
<p>Supporting multiple cached types:</p>
<div class="sourceCode" id="cb113"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> PolymorphicCache <span class="op">{</span></span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint32_t</span> guard<span class="op">;</span></span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a>        <span class="dt">void</span> <span class="op">*</span>cached_value<span class="op">;</span></span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> entries<span class="op">[</span>PIC_SIZE<span class="op">];</span></span>
<span id="cb113-6"><a href="#cb113-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint8_t</span> count<span class="op">;</span></span>
<span id="cb113-7"><a href="#cb113-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> PolymorphicCache<span class="op">;</span></span></code></pre></div>
<h2>10.9 Profiling Integration</h2>
<h3>10.9.1 Counter Threading</h3>
<p>Embedded profiling counters:</p>
<div class="sourceCode" id="cb114"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>op_counted_loop_header<span class="op">:</span></span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint32_t</span> <span class="op">*</span>counter <span class="op">=</span> <span class="op">(</span><span class="dt">uint32_t</span><span class="op">*)</span>vm<span class="op">-&gt;</span>operands<span class="op">;</span></span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a>        <span class="op">(*</span>counter<span class="op">)++;</span></span>
<span id="cb114-5"><a href="#cb114-5" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb114-6"><a href="#cb114-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(*</span>counter <span class="op">&gt;</span> JIT_THRESHOLD<span class="op">)</span> <span class="op">{</span></span>
<span id="cb114-7"><a href="#cb114-7" aria-hidden="true" tabindex="-1"></a>            trigger_jit_compilation<span class="op">(</span>vm<span class="op">);</span></span>
<span id="cb114-8"><a href="#cb114-8" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb114-9"><a href="#cb114-9" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb114-10"><a href="#cb114-10" aria-hidden="true" tabindex="-1"></a>        vm<span class="op">-&gt;</span>operands <span class="op">+=</span> <span class="kw">sizeof</span><span class="op">(</span><span class="dt">uint32_t</span><span class="op">);</span></span>
<span id="cb114-11"><a href="#cb114-11" aria-hidden="true" tabindex="-1"></a>        NEXT<span class="op">();</span></span>
<span id="cb114-12"><a href="#cb114-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span></code></pre></div>
<h3>10.9.2 Type Profiling</h3>
<p>Collecting type information for optimization:</p>
<div class="sourceCode" id="cb115"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>op_binary_op_profiled<span class="op">:</span></span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a>        Value b <span class="op">=</span> POP<span class="op">();</span></span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a>        Value a <span class="op">=</span> POP<span class="op">();</span></span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a>        TypeProfile <span class="op">*</span>profile <span class="op">=</span> <span class="op">(</span>TypeProfile<span class="op">*)</span>vm<span class="op">-&gt;</span>operands<span class="op">;</span></span>
<span id="cb115-6"><a href="#cb115-6" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb115-7"><a href="#cb115-7" aria-hidden="true" tabindex="-1"></a>        update_type_profile<span class="op">(</span>profile<span class="op">,</span> a<span class="op">.</span>type<span class="op">,</span> b<span class="op">.</span>type<span class="op">);</span></span>
<span id="cb115-8"><a href="#cb115-8" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb115-9"><a href="#cb115-9" aria-hidden="true" tabindex="-1"></a>        Value result <span class="op">=</span> generic_binary_op<span class="op">(</span>a<span class="op">,</span> b<span class="op">);</span></span>
<span id="cb115-10"><a href="#cb115-10" aria-hidden="true" tabindex="-1"></a>        push<span class="op">(</span>vm<span class="op">,</span> result<span class="op">);</span></span>
<span id="cb115-11"><a href="#cb115-11" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb115-12"><a href="#cb115-12" aria-hidden="true" tabindex="-1"></a>        vm<span class="op">-&gt;</span>operands <span class="op">+=</span> <span class="kw">sizeof</span><span class="op">(</span>TypeProfile<span class="op">);</span></span>
<span id="cb115-13"><a href="#cb115-13" aria-hidden="true" tabindex="-1"></a>        NEXT<span class="op">();</span></span>
<span id="cb115-14"><a href="#cb115-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span></code></pre></div>
<h2>10.10 Superinstruction Formation</h2>
<h3>10.10.1 Static Superinstructions</h3>
<p>Common sequences combined at threading time:</p>
<div class="sourceCode" id="cb116"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Pattern: LOAD_LOCAL + GET_FIELD + STORE_LOCAL</span></span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>op_load_get_store<span class="op">:</span></span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint8_t</span> local_idx <span class="op">=</span> read_u8<span class="op">(</span>vm<span class="op">-&gt;</span>operands<span class="op">);</span></span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint16_t</span> field_idx <span class="op">=</span> read_u16<span class="op">(</span>vm<span class="op">-&gt;</span>operands<span class="op">);</span></span>
<span id="cb116-6"><a href="#cb116-6" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint8_t</span> store_idx <span class="op">=</span> read_u8<span class="op">(</span>vm<span class="op">-&gt;</span>operands<span class="op">);</span></span>
<span id="cb116-7"><a href="#cb116-7" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb116-8"><a href="#cb116-8" aria-hidden="true" tabindex="-1"></a>        Value obj <span class="op">=</span> vm<span class="op">-&gt;</span>locals<span class="op">[</span>local_idx<span class="op">];</span></span>
<span id="cb116-9"><a href="#cb116-9" aria-hidden="true" tabindex="-1"></a>        Value field <span class="op">=</span> get_field<span class="op">(</span>obj<span class="op">,</span> field_idx<span class="op">);</span></span>
<span id="cb116-10"><a href="#cb116-10" aria-hidden="true" tabindex="-1"></a>        vm<span class="op">-&gt;</span>locals<span class="op">[</span>store_idx<span class="op">]</span> <span class="op">=</span> field<span class="op">;</span></span>
<span id="cb116-11"><a href="#cb116-11" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb116-12"><a href="#cb116-12" aria-hidden="true" tabindex="-1"></a>        NEXT<span class="op">();</span></span>
<span id="cb116-13"><a href="#cb116-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span></code></pre></div>
<h3>10.10.2 Dynamic Superinstruction Discovery</h3>
<p>Runtime pattern detection and fusion.</p>
<h2>10.11 Memory and Cache Optimization</h2>
<h3>10.11.1 Handler Alignment</h3>
<div class="sourceCode" id="cb117"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Force alignment for better I-cache usage</span></span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#define HANDLER_ALIGN __attribute__</span><span class="op">((</span><span class="pp">aligned</span><span class="op">(</span><span class="dv">64</span><span class="op">)))</span></span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a>HANDLER_ALIGN</span>
<span id="cb117-5"><a href="#cb117-5" aria-hidden="true" tabindex="-1"></a>op_frequent_instruction<span class="op">:</span></span>
<span id="cb117-6"><a href="#cb117-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb117-7"><a href="#cb117-7" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Hot path code</span></span>
<span id="cb117-8"><a href="#cb117-8" aria-hidden="true" tabindex="-1"></a>        NEXT<span class="op">();</span></span>
<span id="cb117-9"><a href="#cb117-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span></code></pre></div>
<h3>10.11.2 Code Layout</h3>
<p>Grouping related handlers for locality.</p>
<h2>10.12 Performance Analysis</h2>
<h3>10.12.1 Benchmarking Results</h3>
<p>Comparing different threading techniques:</p>
<ul>
<li>Switch dispatch: 1.0x (baseline)</li>
<li>Indirect threading: 1.8-2.2x</li>
<li>Superinstructions: 2.5-3.0x</li>
<li>With inline caching: 3.5-4.5x</li>
</ul>
<h3>10.12.2 Platform-Specific Optimizations</h3>
<p>Leveraging CPU-specific features for maximum performance.</p>
<p>This chapter has presented a complete indirect threaded code
implementation, providing the execution engine for Diyrbal&#39;s bytecode.
The threading techniques, combined with inline caching and profiling,
create a solid foundation for high-performance interpretation and
seamless JIT integration. Based on the progression from indirect
threaded code in Chapter 10 and the VM implementation patterns from your
materials, here&#39;s Chapter 11 on the Virtual Machine Core:</p>
<h1>Chapter 11: Virtual Machine Core</h1>
<h2>11.1 Introduction</h2>
<p>This chapter presents the heart of the Diyrbal virtual machinethe
core runtime system that orchestrates bytecode execution, manages
runtime state, and provides essential services. Building on the
threading infrastructure from Chapter 10, we now examine the complete VM
architecture.</p>
<h2>11.2 VM State Architecture</h2>
<h3>11.2.1 Core VM Structure</h3>
<div class="sourceCode" id="cb118"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> VM <span class="op">{</span></span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Execution state</span></span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>    ThreadedCode <span class="op">**</span>code_cache<span class="op">;</span></span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>    CallFrame <span class="op">*</span>call_stack<span class="op">;</span></span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> call_depth<span class="op">;</span></span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> max_call_depth<span class="op">;</span></span>
<span id="cb118-7"><a href="#cb118-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb118-8"><a href="#cb118-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Memory management</span></span>
<span id="cb118-9"><a href="#cb118-9" aria-hidden="true" tabindex="-1"></a>    Heap <span class="op">*</span>heap<span class="op">;</span></span>
<span id="cb118-10"><a href="#cb118-10" aria-hidden="true" tabindex="-1"></a>    GarbageCollector <span class="op">*</span>gc<span class="op">;</span></span>
<span id="cb118-11"><a href="#cb118-11" aria-hidden="true" tabindex="-1"></a>    RootSet <span class="op">*</span>roots<span class="op">;</span></span>
<span id="cb118-12"><a href="#cb118-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb118-13"><a href="#cb118-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Type system</span></span>
<span id="cb118-14"><a href="#cb118-14" aria-hidden="true" tabindex="-1"></a>    TypeRegistry <span class="op">*</span>types<span class="op">;</span></span>
<span id="cb118-15"><a href="#cb118-15" aria-hidden="true" tabindex="-1"></a>    MethodCache <span class="op">*</span>method_cache<span class="op">;</span></span>
<span id="cb118-16"><a href="#cb118-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb118-17"><a href="#cb118-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Concurrency (from Chapter 8)</span></span>
<span id="cb118-18"><a href="#cb118-18" aria-hidden="true" tabindex="-1"></a>    CoroutineScheduler <span class="op">*</span>scheduler<span class="op">;</span></span>
<span id="cb118-19"><a href="#cb118-19" aria-hidden="true" tabindex="-1"></a>    Coroutine <span class="op">*</span>current_coroutine<span class="op">;</span></span>
<span id="cb118-20"><a href="#cb118-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb118-21"><a href="#cb118-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Global state</span></span>
<span id="cb118-22"><a href="#cb118-22" aria-hidden="true" tabindex="-1"></a>    GlobalTable <span class="op">*</span>globals<span class="op">;</span></span>
<span id="cb118-23"><a href="#cb118-23" aria-hidden="true" tabindex="-1"></a>    ModuleRegistry <span class="op">*</span>modules<span class="op">;</span></span>
<span id="cb118-24"><a href="#cb118-24" aria-hidden="true" tabindex="-1"></a>    SymbolTable <span class="op">*</span>symbols<span class="op">;</span></span>
<span id="cb118-25"><a href="#cb118-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb118-26"><a href="#cb118-26" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Diagnostics</span></span>
<span id="cb118-27"><a href="#cb118-27" aria-hidden="true" tabindex="-1"></a>    ErrorHandler <span class="op">*</span>error_handler<span class="op">;</span></span>
<span id="cb118-28"><a href="#cb118-28" aria-hidden="true" tabindex="-1"></a>    Profiler <span class="op">*</span>profiler<span class="op">;</span></span>
<span id="cb118-29"><a href="#cb118-29" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> VM<span class="op">;</span></span></code></pre></div>
<h3>11.2.2 Initialization Pipeline</h3>
<div class="sourceCode" id="cb119"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a>VM<span class="op">*</span> vm_create<span class="op">(</span>VMConfig <span class="op">*</span>config<span class="op">)</span> <span class="op">{</span></span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a>    VM <span class="op">*</span>vm <span class="op">=</span> allocate_vm<span class="op">();</span></span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Initialize subsystems in dependency order</span></span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a>    vm<span class="op">-&gt;</span>heap <span class="op">=</span> heap_create<span class="op">(</span>config<span class="op">-&gt;</span>heap_size<span class="op">);</span></span>
<span id="cb119-6"><a href="#cb119-6" aria-hidden="true" tabindex="-1"></a>    vm<span class="op">-&gt;</span>gc <span class="op">=</span> gc_create<span class="op">(</span>vm<span class="op">-&gt;</span>heap<span class="op">,</span> config<span class="op">-&gt;</span>gc_type<span class="op">);</span></span>
<span id="cb119-7"><a href="#cb119-7" aria-hidden="true" tabindex="-1"></a>    vm<span class="op">-&gt;</span>types <span class="op">=</span> type_registry_create<span class="op">();</span></span>
<span id="cb119-8"><a href="#cb119-8" aria-hidden="true" tabindex="-1"></a>    vm<span class="op">-&gt;</span>symbols <span class="op">=</span> symbol_table_create<span class="op">();</span></span>
<span id="cb119-9"><a href="#cb119-9" aria-hidden="true" tabindex="-1"></a>    vm<span class="op">-&gt;</span>globals <span class="op">=</span> global_table_create<span class="op">();</span></span>
<span id="cb119-10"><a href="#cb119-10" aria-hidden="true" tabindex="-1"></a>    vm<span class="op">-&gt;</span>method_cache <span class="op">=</span> method_cache_create<span class="op">(</span>config<span class="op">-&gt;</span>cache_size<span class="op">);</span></span>
<span id="cb119-11"><a href="#cb119-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb119-12"><a href="#cb119-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Threading and execution</span></span>
<span id="cb119-13"><a href="#cb119-13" aria-hidden="true" tabindex="-1"></a>    vm<span class="op">-&gt;</span>code_cache <span class="op">=</span> code_cache_create<span class="op">(</span>config<span class="op">-&gt;</span>code_cache_size<span class="op">);</span></span>
<span id="cb119-14"><a href="#cb119-14" aria-hidden="true" tabindex="-1"></a>    vm<span class="op">-&gt;</span>call_stack <span class="op">=</span> allocate_call_stack<span class="op">(</span>config<span class="op">-&gt;</span>stack_size<span class="op">);</span></span>
<span id="cb119-15"><a href="#cb119-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb119-16"><a href="#cb119-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Optional subsystems</span></span>
<span id="cb119-17"><a href="#cb119-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>config<span class="op">-&gt;</span>enable_profiling<span class="op">)</span> <span class="op">{</span></span>
<span id="cb119-18"><a href="#cb119-18" aria-hidden="true" tabindex="-1"></a>        vm<span class="op">-&gt;</span>profiler <span class="op">=</span> profiler_create<span class="op">();</span></span>
<span id="cb119-19"><a href="#cb119-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb119-20"><a href="#cb119-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb119-21"><a href="#cb119-21" aria-hidden="true" tabindex="-1"></a>    initialize_builtin_types<span class="op">(</span>vm<span class="op">);</span></span>
<span id="cb119-22"><a href="#cb119-22" aria-hidden="true" tabindex="-1"></a>    initialize_builtin_modules<span class="op">(</span>vm<span class="op">);</span></span>
<span id="cb119-23"><a href="#cb119-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb119-24"><a href="#cb119-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> vm<span class="op">;</span></span>
<span id="cb119-25"><a href="#cb119-25" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>11.3 Type System Implementation</h2>
<h3>11.3.1 Type Registry</h3>
<div class="sourceCode" id="cb120"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> TypeInfo <span class="op">{</span></span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>    TypeID id<span class="op">;</span></span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>name<span class="op">;</span></span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> instance_size<span class="op">;</span></span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a>    TypeFlags flags<span class="op">;</span></span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb120-7"><a href="#cb120-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Method table</span></span>
<span id="cb120-8"><a href="#cb120-8" aria-hidden="true" tabindex="-1"></a>    MethodTable <span class="op">*</span>methods<span class="op">;</span></span>
<span id="cb120-9"><a href="#cb120-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb120-10"><a href="#cb120-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Type hierarchy</span></span>
<span id="cb120-11"><a href="#cb120-11" aria-hidden="true" tabindex="-1"></a>    TypeID parent_type<span class="op">;</span></span>
<span id="cb120-12"><a href="#cb120-12" aria-hidden="true" tabindex="-1"></a>    TypeID <span class="op">*</span>interfaces<span class="op">;</span></span>
<span id="cb120-13"><a href="#cb120-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> interface_count<span class="op">;</span></span>
<span id="cb120-14"><a href="#cb120-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb120-15"><a href="#cb120-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Layout information</span></span>
<span id="cb120-16"><a href="#cb120-16" aria-hidden="true" tabindex="-1"></a>    FieldDescriptor <span class="op">*</span>fields<span class="op">;</span></span>
<span id="cb120-17"><a href="#cb120-17" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> field_count<span class="op">;</span></span>
<span id="cb120-18"><a href="#cb120-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> TypeInfo<span class="op">;</span></span>
<span id="cb120-19"><a href="#cb120-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-20"><a href="#cb120-20" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> TypeRegistry <span class="op">{</span></span>
<span id="cb120-21"><a href="#cb120-21" aria-hidden="true" tabindex="-1"></a>    TypeInfo <span class="op">**</span>types<span class="op">;</span></span>
<span id="cb120-22"><a href="#cb120-22" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> type_count<span class="op">;</span></span>
<span id="cb120-23"><a href="#cb120-23" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> type_capacity<span class="op">;</span></span>
<span id="cb120-24"><a href="#cb120-24" aria-hidden="true" tabindex="-1"></a>    HashMap <span class="op">*</span>name_to_type<span class="op">;</span></span>
<span id="cb120-25"><a href="#cb120-25" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> TypeRegistry<span class="op">;</span></span></code></pre></div>
<h3>11.3.2 Dynamic Type Creation</h3>
<div class="sourceCode" id="cb121"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a>TypeID vm_create_type<span class="op">(</span>VM <span class="op">*</span>vm<span class="op">,</span> TypeDescriptor <span class="op">*</span>desc<span class="op">)</span> <span class="op">{</span></span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a>    TypeInfo <span class="op">*</span>type <span class="op">=</span> allocate_type_info<span class="op">();</span></span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a>    type<span class="op">-&gt;</span>id <span class="op">=</span> vm<span class="op">-&gt;</span>types<span class="op">-&gt;</span>type_count<span class="op">++;</span></span>
<span id="cb121-5"><a href="#cb121-5" aria-hidden="true" tabindex="-1"></a>    type<span class="op">-&gt;</span>name <span class="op">=</span> intern_string<span class="op">(</span>vm<span class="op">-&gt;</span>symbols<span class="op">,</span> desc<span class="op">-&gt;</span>name<span class="op">);</span></span>
<span id="cb121-6"><a href="#cb121-6" aria-hidden="true" tabindex="-1"></a>    type<span class="op">-&gt;</span>instance_size <span class="op">=</span> compute_instance_size<span class="op">(</span>desc<span class="op">);</span></span>
<span id="cb121-7"><a href="#cb121-7" aria-hidden="true" tabindex="-1"></a>    type<span class="op">-&gt;</span>flags <span class="op">=</span> desc<span class="op">-&gt;</span>flags<span class="op">;</span></span>
<span id="cb121-8"><a href="#cb121-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb121-9"><a href="#cb121-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Set up inheritance</span></span>
<span id="cb121-10"><a href="#cb121-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>desc<span class="op">-&gt;</span>parent_name<span class="op">)</span> <span class="op">{</span></span>
<span id="cb121-11"><a href="#cb121-11" aria-hidden="true" tabindex="-1"></a>        type<span class="op">-&gt;</span>parent_type <span class="op">=</span> lookup_type<span class="op">(</span>vm<span class="op">,</span> desc<span class="op">-&gt;</span>parent_name<span class="op">);</span></span>
<span id="cb121-12"><a href="#cb121-12" aria-hidden="true" tabindex="-1"></a>        inherit_methods<span class="op">(</span>type<span class="op">,</span> vm<span class="op">-&gt;</span>types<span class="op">-&gt;</span>types<span class="op">[</span>type<span class="op">-&gt;</span>parent_type<span class="op">]);</span></span>
<span id="cb121-13"><a href="#cb121-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb121-14"><a href="#cb121-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb121-15"><a href="#cb121-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Register methods</span></span>
<span id="cb121-16"><a href="#cb121-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> desc<span class="op">-&gt;</span>method_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb121-17"><a href="#cb121-17" aria-hidden="true" tabindex="-1"></a>        register_method<span class="op">(</span>type<span class="op">,</span> <span class="op">&amp;</span>desc<span class="op">-&gt;</span>methods<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb121-18"><a href="#cb121-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb121-19"><a href="#cb121-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb121-20"><a href="#cb121-20" aria-hidden="true" tabindex="-1"></a>    register_type<span class="op">(</span>vm<span class="op">-&gt;</span>types<span class="op">,</span> type<span class="op">);</span></span>
<span id="cb121-21"><a href="#cb121-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> type<span class="op">-&gt;</span>id<span class="op">;</span></span>
<span id="cb121-22"><a href="#cb121-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>11.4 Method Dispatch</h2>
<h3>11.4.1 Virtual Method Table</h3>
<div class="sourceCode" id="cb122"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> MethodTable <span class="op">{</span></span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>    Method <span class="op">**</span>methods<span class="op">;</span></span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> method_count<span class="op">;</span></span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> <span class="op">*</span>selector_map<span class="op">;</span>  <span class="co">// Hash table for name -&gt; index</span></span>
<span id="cb122-5"><a href="#cb122-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> MethodTable<span class="op">;</span></span>
<span id="cb122-6"><a href="#cb122-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-7"><a href="#cb122-7" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> Method <span class="op">{</span></span>
<span id="cb122-8"><a href="#cb122-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>name<span class="op">;</span></span>
<span id="cb122-9"><a href="#cb122-9" aria-hidden="true" tabindex="-1"></a>    MethodType type<span class="op">;</span></span>
<span id="cb122-10"><a href="#cb122-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">union</span> <span class="op">{</span></span>
<span id="cb122-11"><a href="#cb122-11" aria-hidden="true" tabindex="-1"></a>        BytecodeFunction <span class="op">*</span>bytecode<span class="op">;</span></span>
<span id="cb122-12"><a href="#cb122-12" aria-hidden="true" tabindex="-1"></a>        NativeFunction native<span class="op">;</span></span>
<span id="cb122-13"><a href="#cb122-13" aria-hidden="true" tabindex="-1"></a>        JITFunction <span class="op">*</span>jitted<span class="op">;</span></span>
<span id="cb122-14"><a href="#cb122-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> impl<span class="op">;</span></span>
<span id="cb122-15"><a href="#cb122-15" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> flags<span class="op">;</span></span>
<span id="cb122-16"><a href="#cb122-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> Method<span class="op">;</span></span></code></pre></div>
<h3>11.4.2 Method Resolution</h3>
<div class="sourceCode" id="cb123"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a>Method<span class="op">*</span> vm_resolve_method<span class="op">(</span>VM <span class="op">*</span>vm<span class="op">,</span> TypeID type<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>name<span class="op">)</span> <span class="op">{</span></span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check method cache first</span></span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a>    MethodCacheEntry <span class="op">*</span>cached <span class="op">=</span> </span>
<span id="cb123-4"><a href="#cb123-4" aria-hidden="true" tabindex="-1"></a>        method_cache_lookup<span class="op">(</span>vm<span class="op">-&gt;</span>method_cache<span class="op">,</span> type<span class="op">,</span> name<span class="op">);</span></span>
<span id="cb123-5"><a href="#cb123-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>cached<span class="op">)</span> <span class="cf">return</span> cached<span class="op">-&gt;</span>method<span class="op">;</span></span>
<span id="cb123-6"><a href="#cb123-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb123-7"><a href="#cb123-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Walk type hierarchy</span></span>
<span id="cb123-8"><a href="#cb123-8" aria-hidden="true" tabindex="-1"></a>    TypeInfo <span class="op">*</span>current <span class="op">=</span> vm<span class="op">-&gt;</span>types<span class="op">-&gt;</span>types<span class="op">[</span>type<span class="op">];</span></span>
<span id="cb123-9"><a href="#cb123-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span>current<span class="op">)</span> <span class="op">{</span></span>
<span id="cb123-10"><a href="#cb123-10" aria-hidden="true" tabindex="-1"></a>        Method <span class="op">*</span>method <span class="op">=</span> lookup_method_in_type<span class="op">(</span>current<span class="op">,</span> name<span class="op">);</span></span>
<span id="cb123-11"><a href="#cb123-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>method<span class="op">)</span> <span class="op">{</span></span>
<span id="cb123-12"><a href="#cb123-12" aria-hidden="true" tabindex="-1"></a>            method_cache_insert<span class="op">(</span>vm<span class="op">-&gt;</span>method_cache<span class="op">,</span> type<span class="op">,</span> name<span class="op">,</span> method<span class="op">);</span></span>
<span id="cb123-13"><a href="#cb123-13" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> method<span class="op">;</span></span>
<span id="cb123-14"><a href="#cb123-14" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb123-15"><a href="#cb123-15" aria-hidden="true" tabindex="-1"></a>        current <span class="op">=</span> current<span class="op">-&gt;</span>parent_type <span class="op">?</span> </span>
<span id="cb123-16"><a href="#cb123-16" aria-hidden="true" tabindex="-1"></a>            vm<span class="op">-&gt;</span>types<span class="op">-&gt;</span>types<span class="op">[</span>current<span class="op">-&gt;</span>parent_type<span class="op">]</span> <span class="op">:</span> NULL<span class="op">;</span></span>
<span id="cb123-17"><a href="#cb123-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb123-18"><a href="#cb123-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb123-19"><a href="#cb123-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> NULL<span class="op">;</span>  <span class="co">// Method not found</span></span>
<span id="cb123-20"><a href="#cb123-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>11.5 Memory Management Integration</h2>
<h3>11.5.1 Allocation Fast Path</h3>
<div class="sourceCode" id="cb124"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a>Value vm_allocate_object<span class="op">(</span>VM <span class="op">*</span>vm<span class="op">,</span> TypeID type<span class="op">)</span> <span class="op">{</span></span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a>    TypeInfo <span class="op">*</span>type_info <span class="op">=</span> vm<span class="op">-&gt;</span>types<span class="op">-&gt;</span>types<span class="op">[</span>type<span class="op">];</span></span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> size <span class="op">=</span> type_info<span class="op">-&gt;</span>instance_size<span class="op">;</span></span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb124-5"><a href="#cb124-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Try bump allocation first</span></span>
<span id="cb124-6"><a href="#cb124-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span>ptr <span class="op">=</span> heap_alloc_fast<span class="op">(</span>vm<span class="op">-&gt;</span>heap<span class="op">,</span> size<span class="op">);</span></span>
<span id="cb124-7"><a href="#cb124-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>ptr<span class="op">)</span> <span class="op">{</span></span>
<span id="cb124-8"><a href="#cb124-8" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Trigger GC and retry</span></span>
<span id="cb124-9"><a href="#cb124-9" aria-hidden="true" tabindex="-1"></a>        vm_gc_collect<span class="op">(</span>vm<span class="op">);</span></span>
<span id="cb124-10"><a href="#cb124-10" aria-hidden="true" tabindex="-1"></a>        ptr <span class="op">=</span> heap_alloc_fast<span class="op">(</span>vm<span class="op">-&gt;</span>heap<span class="op">,</span> size<span class="op">);</span></span>
<span id="cb124-11"><a href="#cb124-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(!</span>ptr<span class="op">)</span> <span class="op">{</span></span>
<span id="cb124-12"><a href="#cb124-12" aria-hidden="true" tabindex="-1"></a>            vm_throw_oom<span class="op">(</span>vm<span class="op">);</span></span>
<span id="cb124-13"><a href="#cb124-13" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb124-14"><a href="#cb124-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb124-15"><a href="#cb124-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb124-16"><a href="#cb124-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Initialize object header</span></span>
<span id="cb124-17"><a href="#cb124-17" aria-hidden="true" tabindex="-1"></a>    ObjectHeader <span class="op">*</span>header <span class="op">=</span> <span class="op">(</span>ObjectHeader<span class="op">*)</span>ptr<span class="op">;</span></span>
<span id="cb124-18"><a href="#cb124-18" aria-hidden="true" tabindex="-1"></a>    header<span class="op">-&gt;</span>type_id <span class="op">=</span> type<span class="op">;</span></span>
<span id="cb124-19"><a href="#cb124-19" aria-hidden="true" tabindex="-1"></a>    header<span class="op">-&gt;</span>flags <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb124-20"><a href="#cb124-20" aria-hidden="true" tabindex="-1"></a>    header<span class="op">-&gt;</span>hash <span class="op">=</span> generate_hash<span class="op">();</span></span>
<span id="cb124-21"><a href="#cb124-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb124-22"><a href="#cb124-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Clear instance fields</span></span>
<span id="cb124-23"><a href="#cb124-23" aria-hidden="true" tabindex="-1"></a>    memset<span class="op">(</span>ptr <span class="op">+</span> <span class="kw">sizeof</span><span class="op">(</span>ObjectHeader<span class="op">),</span> <span class="dv">0</span><span class="op">,</span> </span>
<span id="cb124-24"><a href="#cb124-24" aria-hidden="true" tabindex="-1"></a>           size <span class="op">-</span> <span class="kw">sizeof</span><span class="op">(</span>ObjectHeader<span class="op">));</span></span>
<span id="cb124-25"><a href="#cb124-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb124-26"><a href="#cb124-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> make_object_value<span class="op">(</span>ptr<span class="op">);</span></span>
<span id="cb124-27"><a href="#cb124-27" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3>11.5.2 GC Integration</h3>
<div class="sourceCode" id="cb125"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> vm_gc_collect<span class="op">(</span>VM <span class="op">*</span>vm<span class="op">)</span> <span class="op">{</span></span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a>    GCStats stats <span class="op">=</span> <span class="op">{</span><span class="dv">0</span><span class="op">};</span></span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb125-4"><a href="#cb125-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Pause all coroutines</span></span>
<span id="cb125-5"><a href="#cb125-5" aria-hidden="true" tabindex="-1"></a>    scheduler_pause_all<span class="op">(</span>vm<span class="op">-&gt;</span>scheduler<span class="op">);</span></span>
<span id="cb125-6"><a href="#cb125-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb125-7"><a href="#cb125-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Mark roots</span></span>
<span id="cb125-8"><a href="#cb125-8" aria-hidden="true" tabindex="-1"></a>    mark_vm_roots<span class="op">(</span>vm<span class="op">,</span> vm<span class="op">-&gt;</span>gc<span class="op">);</span></span>
<span id="cb125-9"><a href="#cb125-9" aria-hidden="true" tabindex="-1"></a>    mark_coroutine_roots<span class="op">(</span>vm<span class="op">-&gt;</span>scheduler<span class="op">,</span> vm<span class="op">-&gt;</span>gc<span class="op">);</span></span>
<span id="cb125-10"><a href="#cb125-10" aria-hidden="true" tabindex="-1"></a>    mark_global_roots<span class="op">(</span>vm<span class="op">-&gt;</span>globals<span class="op">,</span> vm<span class="op">-&gt;</span>gc<span class="op">);</span></span>
<span id="cb125-11"><a href="#cb125-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb125-12"><a href="#cb125-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Perform collection</span></span>
<span id="cb125-13"><a href="#cb125-13" aria-hidden="true" tabindex="-1"></a>    gc_collect<span class="op">(</span>vm<span class="op">-&gt;</span>gc<span class="op">,</span> <span class="op">&amp;</span>stats<span class="op">);</span></span>
<span id="cb125-14"><a href="#cb125-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb125-15"><a href="#cb125-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Update allocator</span></span>
<span id="cb125-16"><a href="#cb125-16" aria-hidden="true" tabindex="-1"></a>    heap_update_after_gc<span class="op">(</span>vm<span class="op">-&gt;</span>heap<span class="op">,</span> <span class="op">&amp;</span>stats<span class="op">);</span></span>
<span id="cb125-17"><a href="#cb125-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb125-18"><a href="#cb125-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Resume execution</span></span>
<span id="cb125-19"><a href="#cb125-19" aria-hidden="true" tabindex="-1"></a>    scheduler_resume_all<span class="op">(</span>vm<span class="op">-&gt;</span>scheduler<span class="op">);</span></span>
<span id="cb125-20"><a href="#cb125-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb125-21"><a href="#cb125-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Profile GC pause</span></span>
<span id="cb125-22"><a href="#cb125-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>vm<span class="op">-&gt;</span>profiler<span class="op">)</span> <span class="op">{</span></span>
<span id="cb125-23"><a href="#cb125-23" aria-hidden="true" tabindex="-1"></a>        profiler_record_gc<span class="op">(</span>vm<span class="op">-&gt;</span>profiler<span class="op">,</span> <span class="op">&amp;</span>stats<span class="op">);</span></span>
<span id="cb125-24"><a href="#cb125-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb125-25"><a href="#cb125-25" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>11.6 Exception Handling</h2>
<h3>11.6.1 Exception State</h3>
<div class="sourceCode" id="cb126"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> ExceptionHandler <span class="op">{</span></span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a>    jmp_buf <span class="op">*</span>handler_stack<span class="op">;</span></span>
<span id="cb126-3"><a href="#cb126-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> handler_depth<span class="op">;</span></span>
<span id="cb126-4"><a href="#cb126-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb126-5"><a href="#cb126-5" aria-hidden="true" tabindex="-1"></a>    Value current_exception<span class="op">;</span></span>
<span id="cb126-6"><a href="#cb126-6" aria-hidden="true" tabindex="-1"></a>    CallInternal server error</span>
<span id="cb126-7"><a href="#cb126-7" aria-hidden="true" tabindex="-1"></a>Got it  here is a full<span class="op">,</span> structured <span class="op">**</span>Chapter #<span class="dv">11</span><span class="op">:</span> Virtual Machine Core<span class="op">**</span> <span class="cf">for</span> the Diyrbal Implementation Bible<span class="op">,</span> continuing cleanly from Chapter <span class="dv">10</span><span class="op">,</span> and integrating concepts from your SSA<span class="op">,</span> bytecode<span class="op">,</span> threading<span class="op">,</span> GC<span class="op">,</span> and concurrency context<span class="op">.</span></span>
<span id="cb126-8"><a href="#cb126-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-9"><a href="#cb126-9" aria-hidden="true" tabindex="-1"></a><span class="op">---</span></span>
<span id="cb126-10"><a href="#cb126-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-11"><a href="#cb126-11" aria-hidden="true" tabindex="-1"></a><span class="pp"># </span><span class="er">**Chapter 11: Virtual Machine Core**</span></span>
<span id="cb126-12"><a href="#cb126-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-13"><a href="#cb126-13" aria-hidden="true" tabindex="-1"></a><span class="pp">#</span><span class="er"># **11.1 Introduction**</span></span>
<span id="cb126-14"><a href="#cb126-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-15"><a href="#cb126-15" aria-hidden="true" tabindex="-1"></a>This chapter describes the central heart of Diyrbal  the <span class="op">**</span>Virtual Machine Core<span class="op">**</span>  where all execution<span class="op">,</span> state management<span class="op">,</span> and system services converge<span class="op">.</span>  </span>
<span id="cb126-16"><a href="#cb126-16" aria-hidden="true" tabindex="-1"></a>Building on the bytecode emission <span class="op">(</span>Ch<span class="fl">.9</span><span class="op">)</span> and indirect threaded code execution engine <span class="op">(</span>Ch<span class="fl">.10</span><span class="op">),</span> we show how the VM ties together<span class="op">:</span></span>
<span id="cb126-17"><a href="#cb126-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-18"><a href="#cb126-18" aria-hidden="true" tabindex="-1"></a><span class="op">-</span> <span class="op">**</span>Execution State Management<span class="op">**</span> <span class="op">(</span>call stack<span class="op">,</span> PC<span class="op">,</span> threaded code pointers<span class="op">)</span></span>
<span id="cb126-19"><a href="#cb126-19" aria-hidden="true" tabindex="-1"></a><span class="op">-</span> <span class="op">**</span>Memory Management<span class="op">**</span> <span class="op">(</span>heap<span class="op">,</span> GC integration<span class="op">)</span></span>
<span id="cb126-20"><a href="#cb126-20" aria-hidden="true" tabindex="-1"></a><span class="op">-</span> <span class="op">**</span>Type System <span class="op">&amp;</span> Method Dispatch<span class="op">**</span></span>
<span id="cb126-21"><a href="#cb126-21" aria-hidden="true" tabindex="-1"></a><span class="op">-</span> <span class="op">**</span>Coroutine Scheduling <span class="op">&amp;</span> Concurrency<span class="op">**</span></span>
<span id="cb126-22"><a href="#cb126-22" aria-hidden="true" tabindex="-1"></a><span class="op">-</span> <span class="op">**</span>Exception Handling<span class="op">**</span></span>
<span id="cb126-23"><a href="#cb126-23" aria-hidden="true" tabindex="-1"></a><span class="op">-</span> <span class="op">**</span>Runtime Services<span class="op">**</span> <span class="op">(</span>profiling<span class="op">,</span> instrumentation<span class="op">,</span> introspection<span class="op">)</span></span>
<span id="cb126-24"><a href="#cb126-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-25"><a href="#cb126-25" aria-hidden="true" tabindex="-1"></a>The goal is not just to run bytecode<span class="op">,</span> but to provide a <span class="op">*</span>robust and extensible runtime platform<span class="op">*</span> <span class="cf">for</span> high<span class="op">-</span>performance and safe program execution<span class="op">.</span></span>
<span id="cb126-26"><a href="#cb126-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-27"><a href="#cb126-27" aria-hidden="true" tabindex="-1"></a><span class="op">---</span></span>
<span id="cb126-28"><a href="#cb126-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-29"><a href="#cb126-29" aria-hidden="true" tabindex="-1"></a><span class="pp">#</span><span class="er"># **11.2 Architecture of the VM Core**</span></span>
<span id="cb126-30"><a href="#cb126-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-31"><a href="#cb126-31" aria-hidden="true" tabindex="-1"></a><span class="pp">#</span><span class="er">## **11.2.1 VM State Structure**</span></span>
<span id="cb126-32"><a href="#cb126-32" aria-hidden="true" tabindex="-1"></a>At runtime<span class="op">,</span> a single `VM` <span class="kw">struct</span> holds <span class="op">*</span>all<span class="op">*</span> operational state<span class="op">:</span></span>
<span id="cb126-33"><a href="#cb126-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-34"><a href="#cb126-34" aria-hidden="true" tabindex="-1"></a>```c</span>
<span id="cb126-35"><a href="#cb126-35" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> VM <span class="op">{</span></span>
<span id="cb126-36"><a href="#cb126-36" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Execution state</span></span>
<span id="cb126-37"><a href="#cb126-37" aria-hidden="true" tabindex="-1"></a>    ThreadedCode <span class="op">**</span>code_cache<span class="op">;</span></span>
<span id="cb126-38"><a href="#cb126-38" aria-hidden="true" tabindex="-1"></a>    CallFrame <span class="op">*</span>call_stack<span class="op">;</span></span>
<span id="cb126-39"><a href="#cb126-39" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> call_depth<span class="op">;</span></span>
<span id="cb126-40"><a href="#cb126-40" aria-hidden="true" tabindex="-1"></a>    ProgramCounter pc<span class="op">;</span></span>
<span id="cb126-41"><a href="#cb126-41" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb126-42"><a href="#cb126-42" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Memory management</span></span>
<span id="cb126-43"><a href="#cb126-43" aria-hidden="true" tabindex="-1"></a>    Heap <span class="op">*</span>heap<span class="op">;</span></span>
<span id="cb126-44"><a href="#cb126-44" aria-hidden="true" tabindex="-1"></a>    GarbageCollector <span class="op">*</span>gc<span class="op">;</span></span>
<span id="cb126-45"><a href="#cb126-45" aria-hidden="true" tabindex="-1"></a>    RootSet <span class="op">*</span>roots<span class="op">;</span></span>
<span id="cb126-46"><a href="#cb126-46" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb126-47"><a href="#cb126-47" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Type system</span></span>
<span id="cb126-48"><a href="#cb126-48" aria-hidden="true" tabindex="-1"></a>    TypeRegistry <span class="op">*</span>types<span class="op">;</span></span>
<span id="cb126-49"><a href="#cb126-49" aria-hidden="true" tabindex="-1"></a>    MethodCache <span class="op">*</span>method_cache<span class="op">;</span></span>
<span id="cb126-50"><a href="#cb126-50" aria-hidden="true" tabindex="-1"></a>    SymbolTable <span class="op">*</span>symbols<span class="op">;</span></span>
<span id="cb126-51"><a href="#cb126-51" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb126-52"><a href="#cb126-52" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Concurrency</span></span>
<span id="cb126-53"><a href="#cb126-53" aria-hidden="true" tabindex="-1"></a>    CoroutineScheduler <span class="op">*</span>scheduler<span class="op">;</span></span>
<span id="cb126-54"><a href="#cb126-54" aria-hidden="true" tabindex="-1"></a>    Coroutine <span class="op">*</span>current_coroutine<span class="op">;</span></span>
<span id="cb126-55"><a href="#cb126-55" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb126-56"><a href="#cb126-56" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Globals &amp; modules</span></span>
<span id="cb126-57"><a href="#cb126-57" aria-hidden="true" tabindex="-1"></a>    GlobalTable <span class="op">*</span>globals<span class="op">;</span></span>
<span id="cb126-58"><a href="#cb126-58" aria-hidden="true" tabindex="-1"></a>    ModuleRegistry <span class="op">*</span>modules<span class="op">;</span></span>
<span id="cb126-59"><a href="#cb126-59" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb126-60"><a href="#cb126-60" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Diagnostics</span></span>
<span id="cb126-61"><a href="#cb126-61" aria-hidden="true" tabindex="-1"></a>    ErrorHandler <span class="op">*</span>error_handler<span class="op">;</span></span>
<span id="cb126-62"><a href="#cb126-62" aria-hidden="true" tabindex="-1"></a>    Profiler <span class="op">*</span>profiler<span class="op">;</span></span>
<span id="cb126-63"><a href="#cb126-63" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> VM<span class="op">;</span></span></code></pre></div>
<hr />
<h3><strong>11.2.2 Initialization Pipeline</strong></h3>
<p>VM initialization proceeds in dependency order:</p>
<div class="sourceCode" id="cb127"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a>VM<span class="op">*</span> vm_create<span class="op">(</span>VMConfig <span class="op">*</span>config<span class="op">)</span> <span class="op">{</span></span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a>    VM <span class="op">*</span>vm <span class="op">=</span> allocate_vm<span class="op">();</span></span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-4"><a href="#cb127-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Memory first</span></span>
<span id="cb127-5"><a href="#cb127-5" aria-hidden="true" tabindex="-1"></a>    vm<span class="op">-&gt;</span>heap <span class="op">=</span> heap_create<span class="op">(</span>config<span class="op">-&gt;</span>heap_size<span class="op">);</span></span>
<span id="cb127-6"><a href="#cb127-6" aria-hidden="true" tabindex="-1"></a>    vm<span class="op">-&gt;</span>gc   <span class="op">=</span> gc_create<span class="op">(</span>vm<span class="op">-&gt;</span>heap<span class="op">,</span> config<span class="op">-&gt;</span>gc_type<span class="op">);</span></span>
<span id="cb127-7"><a href="#cb127-7" aria-hidden="true" tabindex="-1"></a>    vm<span class="op">-&gt;</span>roots <span class="op">=</span> rootset_create<span class="op">();</span></span>
<span id="cb127-8"><a href="#cb127-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-9"><a href="#cb127-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Type system</span></span>
<span id="cb127-10"><a href="#cb127-10" aria-hidden="true" tabindex="-1"></a>    vm<span class="op">-&gt;</span>types   <span class="op">=</span> type_registry_create<span class="op">();</span></span>
<span id="cb127-11"><a href="#cb127-11" aria-hidden="true" tabindex="-1"></a>    vm<span class="op">-&gt;</span>symbols <span class="op">=</span> symbol_table_create<span class="op">();</span></span>
<span id="cb127-12"><a href="#cb127-12" aria-hidden="true" tabindex="-1"></a>    vm<span class="op">-&gt;</span>globals <span class="op">=</span> global_table_create<span class="op">();</span></span>
<span id="cb127-13"><a href="#cb127-13" aria-hidden="true" tabindex="-1"></a>    vm<span class="op">-&gt;</span>method_cache <span class="op">=</span> method_cache_create<span class="op">(</span>config<span class="op">-&gt;</span>cache_size<span class="op">);</span></span>
<span id="cb127-14"><a href="#cb127-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-15"><a href="#cb127-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Execution machinery</span></span>
<span id="cb127-16"><a href="#cb127-16" aria-hidden="true" tabindex="-1"></a>    vm<span class="op">-&gt;</span>code_cache <span class="op">=</span> code_cache_create<span class="op">(</span>config<span class="op">-&gt;</span>code_cache_size<span class="op">);</span></span>
<span id="cb127-17"><a href="#cb127-17" aria-hidden="true" tabindex="-1"></a>    vm<span class="op">-&gt;</span>call_stack <span class="op">=</span> allocate_call_stack<span class="op">(</span>config<span class="op">-&gt;</span>stack_size<span class="op">);</span></span>
<span id="cb127-18"><a href="#cb127-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-19"><a href="#cb127-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Optional subsystems</span></span>
<span id="cb127-20"><a href="#cb127-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>config<span class="op">-&gt;</span>enable_profiling<span class="op">)</span></span>
<span id="cb127-21"><a href="#cb127-21" aria-hidden="true" tabindex="-1"></a>        vm<span class="op">-&gt;</span>profiler <span class="op">=</span> profiler_create<span class="op">();</span></span>
<span id="cb127-22"><a href="#cb127-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-23"><a href="#cb127-23" aria-hidden="true" tabindex="-1"></a>    initialize_builtin_types<span class="op">(</span>vm<span class="op">);</span></span>
<span id="cb127-24"><a href="#cb127-24" aria-hidden="true" tabindex="-1"></a>    initialize_builtin_modules<span class="op">(</span>vm<span class="op">);</span></span>
<span id="cb127-25"><a href="#cb127-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-26"><a href="#cb127-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> vm<span class="op">;</span></span>
<span id="cb127-27"><a href="#cb127-27" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h2><strong>11.3 Type System &amp; Method Dispatch</strong></h2>
<h3><strong>11.3.1 Type Registry</strong></h3>
<div class="sourceCode" id="cb128"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> TypeInfo <span class="op">{</span></span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a>    TypeID id<span class="op">;</span></span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>name<span class="op">;</span></span>
<span id="cb128-4"><a href="#cb128-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> instance_size<span class="op">;</span></span>
<span id="cb128-5"><a href="#cb128-5" aria-hidden="true" tabindex="-1"></a>    MethodTable <span class="op">*</span>methods<span class="op">;</span></span>
<span id="cb128-6"><a href="#cb128-6" aria-hidden="true" tabindex="-1"></a>    TypeID parent_type<span class="op">;</span></span>
<span id="cb128-7"><a href="#cb128-7" aria-hidden="true" tabindex="-1"></a>    TypeID <span class="op">*</span>interfaces<span class="op">;</span></span>
<span id="cb128-8"><a href="#cb128-8" aria-hidden="true" tabindex="-1"></a>    FieldDescriptor <span class="op">*</span>fields<span class="op">;</span></span>
<span id="cb128-9"><a href="#cb128-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> TypeInfo<span class="op">;</span></span></code></pre></div>
<p>The <strong>TypeRegistry</strong> maps type names to
<code>TypeInfo</code> objects and supports dynamic type creation at
runtime.</p>
<hr />
<h3><strong>11.3.2 Method Resolution</strong></h3>
<p>Diyrbal uses a <strong>virtual method table (VMT)</strong> with
caching:</p>
<div class="sourceCode" id="cb129"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a>Method<span class="op">*</span> vm_resolve_method<span class="op">(</span>VM <span class="op">*</span>vm<span class="op">,</span> TypeID type<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>name<span class="op">)</span> <span class="op">{</span></span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a>    MethodCacheEntry <span class="op">*</span>cached <span class="op">=</span> </span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a>        method_cache_lookup<span class="op">(</span>vm<span class="op">-&gt;</span>method_cache<span class="op">,</span> type<span class="op">,</span> name<span class="op">);</span></span>
<span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>cached<span class="op">)</span> <span class="cf">return</span> cached<span class="op">-&gt;</span>method<span class="op">;</span></span>
<span id="cb129-5"><a href="#cb129-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-6"><a href="#cb129-6" aria-hidden="true" tabindex="-1"></a>    TypeInfo <span class="op">*</span>current <span class="op">=</span> vm<span class="op">-&gt;</span>types<span class="op">-&gt;</span>types<span class="op">[</span>type<span class="op">];</span></span>
<span id="cb129-7"><a href="#cb129-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span>current<span class="op">)</span> <span class="op">{</span></span>
<span id="cb129-8"><a href="#cb129-8" aria-hidden="true" tabindex="-1"></a>        Method <span class="op">*</span>method <span class="op">=</span> lookup_method_in_type<span class="op">(</span>current<span class="op">,</span> name<span class="op">);</span></span>
<span id="cb129-9"><a href="#cb129-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>method<span class="op">)</span> <span class="op">{</span></span>
<span id="cb129-10"><a href="#cb129-10" aria-hidden="true" tabindex="-1"></a>            method_cache_insert<span class="op">(</span>vm<span class="op">-&gt;</span>method_cache<span class="op">,</span> type<span class="op">,</span> name<span class="op">,</span> method<span class="op">);</span></span>
<span id="cb129-11"><a href="#cb129-11" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> method<span class="op">;</span></span>
<span id="cb129-12"><a href="#cb129-12" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb129-13"><a href="#cb129-13" aria-hidden="true" tabindex="-1"></a>        current <span class="op">=</span> current<span class="op">-&gt;</span>parent_type <span class="op">?</span> </span>
<span id="cb129-14"><a href="#cb129-14" aria-hidden="true" tabindex="-1"></a>            vm<span class="op">-&gt;</span>types<span class="op">-&gt;</span>types<span class="op">[</span>current<span class="op">-&gt;</span>parent_type<span class="op">]</span> <span class="op">:</span> NULL<span class="op">;</span></span>
<span id="cb129-15"><a href="#cb129-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb129-16"><a href="#cb129-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> NULL<span class="op">;</span></span>
<span id="cb129-17"><a href="#cb129-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h2><strong>11.4 Memory Management Integration</strong></h2>
<h3><strong>11.4.1 Fast Path Allocation</strong></h3>
<div class="sourceCode" id="cb130"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a>Value vm_allocate_object<span class="op">(</span>VM <span class="op">*</span>vm<span class="op">,</span> TypeID type<span class="op">)</span> <span class="op">{</span></span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a>    TypeInfo <span class="op">*</span>info <span class="op">=</span> vm<span class="op">-&gt;</span>types<span class="op">-&gt;</span>types<span class="op">[</span>type<span class="op">];</span></span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span>mem <span class="op">=</span> heap_alloc_fast<span class="op">(</span>vm<span class="op">-&gt;</span>heap<span class="op">,</span> info<span class="op">-&gt;</span>instance_size<span class="op">);</span></span>
<span id="cb130-4"><a href="#cb130-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-5"><a href="#cb130-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>mem<span class="op">)</span> <span class="op">{</span></span>
<span id="cb130-6"><a href="#cb130-6" aria-hidden="true" tabindex="-1"></a>        vm_gc_collect<span class="op">(</span>vm<span class="op">);</span></span>
<span id="cb130-7"><a href="#cb130-7" aria-hidden="true" tabindex="-1"></a>        mem <span class="op">=</span> heap_alloc_fast<span class="op">(</span>vm<span class="op">-&gt;</span>heap<span class="op">,</span> info<span class="op">-&gt;</span>instance_size<span class="op">);</span></span>
<span id="cb130-8"><a href="#cb130-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(!</span>mem<span class="op">)</span> vm_throw_oom<span class="op">(</span>vm<span class="op">);</span></span>
<span id="cb130-9"><a href="#cb130-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb130-10"><a href="#cb130-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-11"><a href="#cb130-11" aria-hidden="true" tabindex="-1"></a>    ObjectHeader <span class="op">*</span>header <span class="op">=</span> mem<span class="op">;</span></span>
<span id="cb130-12"><a href="#cb130-12" aria-hidden="true" tabindex="-1"></a>    header<span class="op">-&gt;</span>type_id <span class="op">=</span> type<span class="op">;</span></span>
<span id="cb130-13"><a href="#cb130-13" aria-hidden="true" tabindex="-1"></a>    memset<span class="op">(</span>mem <span class="op">+</span> <span class="kw">sizeof</span><span class="op">(</span>ObjectHeader<span class="op">),</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb130-14"><a href="#cb130-14" aria-hidden="true" tabindex="-1"></a>           info<span class="op">-&gt;</span>instance_size <span class="op">-</span> <span class="kw">sizeof</span><span class="op">(</span>ObjectHeader<span class="op">));</span></span>
<span id="cb130-15"><a href="#cb130-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-16"><a href="#cb130-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> make_object_value<span class="op">(</span>mem<span class="op">);</span></span>
<span id="cb130-17"><a href="#cb130-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h3><strong>11.4.2 GC Cycle Integration</strong></h3>
<div class="sourceCode" id="cb131"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> vm_gc_collect<span class="op">(</span>VM <span class="op">*</span>vm<span class="op">)</span> <span class="op">{</span></span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a>    scheduler_pause_all<span class="op">(</span>vm<span class="op">-&gt;</span>scheduler<span class="op">);</span></span>
<span id="cb131-3"><a href="#cb131-3" aria-hidden="true" tabindex="-1"></a>    mark_vm_roots<span class="op">(</span>vm<span class="op">,</span> vm<span class="op">-&gt;</span>gc<span class="op">);</span></span>
<span id="cb131-4"><a href="#cb131-4" aria-hidden="true" tabindex="-1"></a>    gc_collect<span class="op">(</span>vm<span class="op">-&gt;</span>gc<span class="op">);</span></span>
<span id="cb131-5"><a href="#cb131-5" aria-hidden="true" tabindex="-1"></a>    scheduler_resume_all<span class="op">(</span>vm<span class="op">-&gt;</span>scheduler<span class="op">);</span></span>
<span id="cb131-6"><a href="#cb131-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-7"><a href="#cb131-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>vm<span class="op">-&gt;</span>profiler<span class="op">)</span></span>
<span id="cb131-8"><a href="#cb131-8" aria-hidden="true" tabindex="-1"></a>        profiler_record_gc<span class="op">(</span>vm<span class="op">-&gt;</span>profiler<span class="op">);</span></span>
<span id="cb131-9"><a href="#cb131-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>GC is fully integrated with coroutine scheduling to ensure <em>safe
concurrent execution</em>.</p>
<hr />
<h2><strong>11.5 Coroutine and Concurrency Control</strong></h2>
<h3><strong>11.5.1 Scheduler Integration</strong></h3>
<p>From Ch.8, each coroutine has an independent stack and state.<br />
The VM core offers hooks for:</p>
<ul>
<li>Creation (<code>vm_create_coroutine</code>)</li>
<li>Suspension / resumption (<code>scheduler_pause_all</code>,
<code>scheduler_resume_all</code>)</li>
<li>Dead coroutine cleanup</li>
<li>Fairness policies &amp; priority-based scheduling</li>
</ul>
<hr />
<h2><strong>11.6 Exception Handling</strong></h2>
<h3><strong>11.6.1 Exception State</strong></h3>
<div class="sourceCode" id="cb132"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> ExceptionHandler <span class="op">{</span></span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a>    jmp_buf buf<span class="op">;</span></span>
<span id="cb132-3"><a href="#cb132-3" aria-hidden="true" tabindex="-1"></a>    Value current_exception<span class="op">;</span></span>
<span id="cb132-4"><a href="#cb132-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> ExceptionHandler<span class="op">;</span></span>
<span id="cb132-5"><a href="#cb132-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-6"><a href="#cb132-6" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> vm_throw<span class="op">(</span>VM <span class="op">*</span>vm<span class="op">,</span> Value exception<span class="op">)</span> <span class="op">{</span></span>
<span id="cb132-7"><a href="#cb132-7" aria-hidden="true" tabindex="-1"></a>    vm<span class="op">-&gt;</span>current_handler<span class="op">-&gt;</span>current_exception <span class="op">=</span> exception<span class="op">;</span></span>
<span id="cb132-8"><a href="#cb132-8" aria-hidden="true" tabindex="-1"></a>    longjmp<span class="op">(</span>vm<span class="op">-&gt;</span>current_handler<span class="op">-&gt;</span>buf<span class="op">,</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb132-9"><a href="#cb132-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<ul>
<li><strong>Throw</strong>: sets exception value and jumps to
handler.</li>
<li><strong>Catch</strong>: wraps execution in <code>setjmp</code>
guard.</li>
</ul>
<hr />
<h2><strong>11.7 Execution Loop</strong></h2>
<p>The <strong>inner interpreter loop</strong> ties together all
components:</p>
<div class="sourceCode" id="cb133"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> vm_execute<span class="op">(</span>VM <span class="op">*</span>vm<span class="op">,</span> ThreadedCode <span class="op">*</span>tc<span class="op">)</span> <span class="op">{</span></span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a>    vm<span class="op">-&gt;</span>pc <span class="op">=</span> tc<span class="op">-&gt;</span>handlers<span class="op">;</span></span>
<span id="cb133-3"><a href="#cb133-3" aria-hidden="true" tabindex="-1"></a>    DISPATCH<span class="op">();</span></span>
<span id="cb133-4"><a href="#cb133-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-5"><a href="#cb133-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Handlers generated by Ch.10</span></span>
<span id="cb133-6"><a href="#cb133-6" aria-hidden="true" tabindex="-1"></a>op_add<span class="op">:</span></span>
<span id="cb133-7"><a href="#cb133-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb133-8"><a href="#cb133-8" aria-hidden="true" tabindex="-1"></a>        Value b <span class="op">=</span> POP<span class="op">();</span></span>
<span id="cb133-9"><a href="#cb133-9" aria-hidden="true" tabindex="-1"></a>        Value a <span class="op">=</span> POP<span class="op">();</span></span>
<span id="cb133-10"><a href="#cb133-10" aria-hidden="true" tabindex="-1"></a>        PUSH<span class="op">(</span>value_add<span class="op">(</span>a<span class="op">,</span> b<span class="op">));</span></span>
<span id="cb133-11"><a href="#cb133-11" aria-hidden="true" tabindex="-1"></a>        NEXT<span class="op">();</span></span>
<span id="cb133-12"><a href="#cb133-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb133-13"><a href="#cb133-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-14"><a href="#cb133-14" aria-hidden="true" tabindex="-1"></a>op_call<span class="op">:</span></span>
<span id="cb133-15"><a href="#cb133-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb133-16"><a href="#cb133-16" aria-hidden="true" tabindex="-1"></a>        Method <span class="op">*</span>m <span class="op">=</span> vm_resolve_method<span class="op">(</span>vm<span class="op">,</span> POP<span class="op">().</span>type_id<span class="op">,</span> POP<span class="op">().</span>str<span class="op">);</span></span>
<span id="cb133-17"><a href="#cb133-17" aria-hidden="true" tabindex="-1"></a>        push_call_frame<span class="op">(</span>vm<span class="op">,</span> m<span class="op">);</span></span>
<span id="cb133-18"><a href="#cb133-18" aria-hidden="true" tabindex="-1"></a>        vm<span class="op">-&gt;</span>pc <span class="op">=</span> m<span class="op">-&gt;</span>impl<span class="op">.</span>bytecode<span class="op">-&gt;</span>handlers<span class="op">;</span></span>
<span id="cb133-19"><a href="#cb133-19" aria-hidden="true" tabindex="-1"></a>        NEXT<span class="op">();</span></span>
<span id="cb133-20"><a href="#cb133-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb133-21"><a href="#cb133-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h2><strong>11.8 Profiling and Introspection</strong></h2>
<p>From <em>efficient-trace-jit.pdf</em>, profiling is integrated into
the VM core:</p>
<ul>
<li><strong>Low-overhead sampling</strong> using hardware timers</li>
<li>Per-instruction counters in threaded code for <strong>hot path
detection</strong></li>
<li>Stack fragment capture for async profiling</li>
</ul>
<hr />
<h2><strong>11.9 Error Recovery and Safety Checks</strong></h2>
<ul>
<li><strong>Stack overflow</strong> detection in <code>PUSH</code></li>
<li><strong>Heap sanity check</strong> before each allocation</li>
<li><strong>Invalid bytecode panic</strong></li>
<li><strong>Dominance and SSA validity check</strong> for JIT
stages</li>
</ul>
<hr />
<h2><strong>11.10 Summary</strong></h2>
<p>The Virtual Machine Core brings together:</p>
<ol type="1">
<li><strong>Execution state</strong></li>
<li><strong>Type system and method dispatch</strong></li>
<li><strong>Memory management with GC integration</strong></li>
<li><strong>Concurrency via coroutine scheduler</strong></li>
<li><strong>Robust exception handling</strong></li>
<li><strong>Safe and fast interpreter loop</strong></li>
<li><strong>Profiling hooks for adaptive optimization</strong></li>
</ol>
<p>With the VM core complete, Diyrbal now has a <strong>stable runtime
foundation</strong> for SSA execution, indirect threading, concurrency,
and future JIT integration.</p>
<hr />
<p>If you&#39;d like, I can follow this with <strong>Chapter #12: JIT
Compilation Integration</strong>, where this VM core is extended to
dynamically generate machine code using hot path profiling data from the
interpreter. That chapter would tie profiling in Ch.11 directly to
trace-based JIT approaches seen in <code>efficient-trace-jit.pdf</code>.
Would you like me to proceed with that? Based on the VM core from
Chapter 11 and the memory management patterns from your materials,
here&#39;s Chapter 12 on Memory Architecture:</p>
<h1>Chapter 12: Memory Architecture</h1>
<h2>12.1 Introduction</h2>
<p>This chapter details Diyrbal&#39;s memory architecture, which provides
the foundation for efficient object allocation, garbage collection, and
memory-safe execution. We examine heap organization, object layout,
memory barriers, and the integration with the garbage collector
introduced in Chapter 3.</p>
<h2>12.2 Memory Layout Overview</h2>
<h3>12.2.1 Address Space Organization</h3>
<div class="sourceCode" id="cb134"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> MemoryLayout <span class="op">{</span></span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Code segment - executable memory</span></span>
<span id="cb134-3"><a href="#cb134-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span>code_start<span class="op">;</span></span>
<span id="cb134-4"><a href="#cb134-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span>code_end<span class="op">;</span></span>
<span id="cb134-5"><a href="#cb134-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb134-6"><a href="#cb134-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Heap segments</span></span>
<span id="cb134-7"><a href="#cb134-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span>heap_start<span class="op">;</span></span>
<span id="cb134-8"><a href="#cb134-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span>heap_end<span class="op">;</span></span>
<span id="cb134-9"><a href="#cb134-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span>heap_current<span class="op">;</span></span>
<span id="cb134-10"><a href="#cb134-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb134-11"><a href="#cb134-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Stack segments (per coroutine)</span></span>
<span id="cb134-12"><a href="#cb134-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span>stack_region_start<span class="op">;</span></span>
<span id="cb134-13"><a href="#cb134-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span>stack_region_end<span class="op">;</span></span>
<span id="cb134-14"><a href="#cb134-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb134-15"><a href="#cb134-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Large object space</span></span>
<span id="cb134-16"><a href="#cb134-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span>large_object_start<span class="op">;</span></span>
<span id="cb134-17"><a href="#cb134-17" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span>large_object_end<span class="op">;</span></span>
<span id="cb134-18"><a href="#cb134-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb134-19"><a href="#cb134-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Memory-mapped regions</span></span>
<span id="cb134-20"><a href="#cb134-20" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span>mmap_region_start<span class="op">;</span></span>
<span id="cb134-21"><a href="#cb134-21" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span>mmap_region_end<span class="op">;</span></span>
<span id="cb134-22"><a href="#cb134-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> MemoryLayout<span class="op">;</span></span></code></pre></div>
<h3>12.2.2 Segment Management</h3>
<div class="sourceCode" id="cb135"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> MemoryLayout<span class="op">*</span> init_memory_layout<span class="op">(</span><span class="dt">size_t</span> heap_size<span class="op">)</span> <span class="op">{</span></span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a>    MemoryLayout <span class="op">*</span>layout <span class="op">=</span> mmap_aligned<span class="op">(</span>NULL<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>MemoryLayout<span class="op">),</span> </span>
<span id="cb135-3"><a href="#cb135-3" aria-hidden="true" tabindex="-1"></a>                                       PAGE_SIZE<span class="op">,</span> PROT_READ <span class="op">|</span> PROT_WRITE<span class="op">);</span></span>
<span id="cb135-4"><a href="#cb135-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb135-5"><a href="#cb135-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Reserve virtual address space</span></span>
<span id="cb135-6"><a href="#cb135-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> total_reservation <span class="op">=</span> heap_size <span class="op">+</span> STACK_REGION_SIZE <span class="op">+</span> </span>
<span id="cb135-7"><a href="#cb135-7" aria-hidden="true" tabindex="-1"></a>                              LARGE_OBJECT_SIZE <span class="op">+</span> CODE_CACHE_SIZE<span class="op">;</span></span>
<span id="cb135-8"><a href="#cb135-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb135-9"><a href="#cb135-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span>base <span class="op">=</span> mmap_aligned<span class="op">(</span>NULL<span class="op">,</span> total_reservation<span class="op">,</span> </span>
<span id="cb135-10"><a href="#cb135-10" aria-hidden="true" tabindex="-1"></a>                             REGION_ALIGNMENT<span class="op">,</span> PROT_NONE<span class="op">);</span></span>
<span id="cb135-11"><a href="#cb135-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb135-12"><a href="#cb135-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Carve out segments</span></span>
<span id="cb135-13"><a href="#cb135-13" aria-hidden="true" tabindex="-1"></a>    layout<span class="op">-&gt;</span>heap_start <span class="op">=</span> base<span class="op">;</span></span>
<span id="cb135-14"><a href="#cb135-14" aria-hidden="true" tabindex="-1"></a>    layout<span class="op">-&gt;</span>heap_end <span class="op">=</span> base <span class="op">+</span> heap_size<span class="op">;</span></span>
<span id="cb135-15"><a href="#cb135-15" aria-hidden="true" tabindex="-1"></a>    layout<span class="op">-&gt;</span>stack_region_start <span class="op">=</span> layout<span class="op">-&gt;</span>heap_end<span class="op">;</span></span>
<span id="cb135-16"><a href="#cb135-16" aria-hidden="true" tabindex="-1"></a>    layout<span class="op">-&gt;</span>stack_region_end <span class="op">=</span> layout<span class="op">-&gt;</span>stack_region_start <span class="op">+</span> STACK_REGION_SIZE<span class="op">;</span></span>
<span id="cb135-17"><a href="#cb135-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ... other segments</span></span>
<span id="cb135-18"><a href="#cb135-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb135-19"><a href="#cb135-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> layout<span class="op">;</span></span>
<span id="cb135-20"><a href="#cb135-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>12.3 Heap Organization</h2>
<h3>12.3.1 Generational Structure</h3>
<p>Drawing from the GC Handbook concepts:</p>
<div class="sourceCode" id="cb136"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> Heap <span class="op">{</span></span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Young generation (nursery)</span></span>
<span id="cb136-3"><a href="#cb136-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb136-4"><a href="#cb136-4" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint8_t</span> <span class="op">*</span>start<span class="op">;</span></span>
<span id="cb136-5"><a href="#cb136-5" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint8_t</span> <span class="op">*</span>end<span class="op">;</span></span>
<span id="cb136-6"><a href="#cb136-6" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint8_t</span> <span class="op">*</span>alloc_ptr<span class="op">;</span></span>
<span id="cb136-7"><a href="#cb136-7" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint8_t</span> <span class="op">*</span>survivor_start<span class="op">;</span></span>
<span id="cb136-8"><a href="#cb136-8" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint8_t</span> <span class="op">*</span>survivor_end<span class="op">;</span></span>
<span id="cb136-9"><a href="#cb136-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> nursery<span class="op">;</span></span>
<span id="cb136-10"><a href="#cb136-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb136-11"><a href="#cb136-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Old generation</span></span>
<span id="cb136-12"><a href="#cb136-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb136-13"><a href="#cb136-13" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint8_t</span> <span class="op">*</span>start<span class="op">;</span></span>
<span id="cb136-14"><a href="#cb136-14" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint8_t</span> <span class="op">*</span>end<span class="op">;</span></span>
<span id="cb136-15"><a href="#cb136-15" aria-hidden="true" tabindex="-1"></a>        FreeList <span class="op">*</span>free_lists<span class="op">[</span>SIZE_CLASS_COUNT<span class="op">];</span></span>
<span id="cb136-16"><a href="#cb136-16" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint8_t</span> <span class="op">*</span>alloc_ptr<span class="op">;</span></span>
<span id="cb136-17"><a href="#cb136-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> old_gen<span class="op">;</span></span>
<span id="cb136-18"><a href="#cb136-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb136-19"><a href="#cb136-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Metadata</span></span>
<span id="cb136-20"><a href="#cb136-20" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> bytes_allocated<span class="op">;</span></span>
<span id="cb136-21"><a href="#cb136-21" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> bytes_since_gc<span class="op">;</span></span>
<span id="cb136-22"><a href="#cb136-22" aria-hidden="true" tabindex="-1"></a>    AllocationProfile <span class="op">*</span>profile<span class="op">;</span></span>
<span id="cb136-23"><a href="#cb136-23" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> Heap<span class="op">;</span></span></code></pre></div>
<h3>12.3.2 Allocation Regions</h3>
<div class="sourceCode" id="cb137"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> AllocationRegion <span class="op">{</span></span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint8_t</span> <span class="op">*</span>start<span class="op">;</span></span>
<span id="cb137-3"><a href="#cb137-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint8_t</span> <span class="op">*</span>current<span class="op">;</span></span>
<span id="cb137-4"><a href="#cb137-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint8_t</span> <span class="op">*</span>end<span class="op">;</span></span>
<span id="cb137-5"><a href="#cb137-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> size_class<span class="op">;</span></span>
<span id="cb137-6"><a href="#cb137-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> AllocationRegion <span class="op">*</span>next<span class="op">;</span></span>
<span id="cb137-7"><a href="#cb137-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> AllocationRegion<span class="op">;</span></span>
<span id="cb137-8"><a href="#cb137-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-9"><a href="#cb137-9" aria-hidden="true" tabindex="-1"></a><span class="co">// Thread-local allocation buffers</span></span>
<span id="cb137-10"><a href="#cb137-10" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> TLAB <span class="op">{</span></span>
<span id="cb137-11"><a href="#cb137-11" aria-hidden="true" tabindex="-1"></a>    AllocationRegion <span class="op">*</span>current_region<span class="op">;</span></span>
<span id="cb137-12"><a href="#cb137-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> refill_waste<span class="op">;</span></span>
<span id="cb137-13"><a href="#cb137-13" aria-hidden="true" tabindex="-1"></a>    Thread <span class="op">*</span>owner<span class="op">;</span></span>
<span id="cb137-14"><a href="#cb137-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> TLAB<span class="op">;</span></span></code></pre></div>
<h2>12.4 Object Layout</h2>
<h3>12.4.1 Object Header Design</h3>
<div class="sourceCode" id="cb138"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> ObjectHeader <span class="op">{</span></span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">union</span> <span class="op">{</span></span>
<span id="cb138-3"><a href="#cb138-3" aria-hidden="true" tabindex="-1"></a>        <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb138-4"><a href="#cb138-4" aria-hidden="true" tabindex="-1"></a>            <span class="dt">uint32_t</span> type_id <span class="op">:</span> <span class="dv">16</span><span class="op">;</span></span>
<span id="cb138-5"><a href="#cb138-5" aria-hidden="true" tabindex="-1"></a>            <span class="dt">uint32_t</span> flags <span class="op">:</span> <span class="dv">8</span><span class="op">;</span></span>
<span id="cb138-6"><a href="#cb138-6" aria-hidden="true" tabindex="-1"></a>            <span class="dt">uint32_t</span> age <span class="op">:</span> <span class="dv">4</span><span class="op">;</span></span>
<span id="cb138-7"><a href="#cb138-7" aria-hidden="true" tabindex="-1"></a>            <span class="dt">uint32_t</span> marked <span class="op">:</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb138-8"><a href="#cb138-8" aria-hidden="true" tabindex="-1"></a>            <span class="dt">uint32_t</span> forwarded <span class="op">:</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb138-9"><a href="#cb138-9" aria-hidden="true" tabindex="-1"></a>            <span class="dt">uint32_t</span> pinned <span class="op">:</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb138-10"><a href="#cb138-10" aria-hidden="true" tabindex="-1"></a>            <span class="dt">uint32_t</span> has_finalizer <span class="op">:</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb138-11"><a href="#cb138-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> bits<span class="op">;</span></span>
<span id="cb138-12"><a href="#cb138-12" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint32_t</span> raw<span class="op">;</span></span>
<span id="cb138-13"><a href="#cb138-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> header<span class="op">;</span></span>
<span id="cb138-14"><a href="#cb138-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb138-15"><a href="#cb138-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">union</span> <span class="op">{</span></span>
<span id="cb138-16"><a href="#cb138-16" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint32_t</span> hash<span class="op">;</span></span>
<span id="cb138-17"><a href="#cb138-17" aria-hidden="true" tabindex="-1"></a>        <span class="dt">void</span> <span class="op">*</span>forwarding_ptr<span class="op">;</span>  <span class="co">// During GC</span></span>
<span id="cb138-18"><a href="#cb138-18" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint32_t</span> array_length<span class="op">;</span> <span class="co">// For arrays</span></span>
<span id="cb138-19"><a href="#cb138-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> aux<span class="op">;</span></span>
<span id="cb138-20"><a href="#cb138-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> ObjectHeader<span class="op">;</span></span>
<span id="cb138-21"><a href="#cb138-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-22"><a href="#cb138-22" aria-hidden="true" tabindex="-1"></a><span class="pp">#define OBJECT_HEADER_SIZE </span><span class="kw">sizeof</span><span class="op">(</span><span class="pp">ObjectHeader</span><span class="op">)</span></span></code></pre></div>
<h3>12.4.2 Type-Specific Layouts</h3>
<div class="sourceCode" id="cb139"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Fixed object layout</span></span>
<span id="cb139-2"><a href="#cb139-2" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb139-3"><a href="#cb139-3" aria-hidden="true" tabindex="-1"></a>    ObjectHeader header<span class="op">;</span></span>
<span id="cb139-4"><a href="#cb139-4" aria-hidden="true" tabindex="-1"></a>    Value fields<span class="op">[];</span>  <span class="co">// Inline fields</span></span>
<span id="cb139-5"><a href="#cb139-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> FixedObject<span class="op">;</span></span>
<span id="cb139-6"><a href="#cb139-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-7"><a href="#cb139-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Array layout</span></span>
<span id="cb139-8"><a href="#cb139-8" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb139-9"><a href="#cb139-9" aria-hidden="true" tabindex="-1"></a>    ObjectHeader header<span class="op">;</span></span>
<span id="cb139-10"><a href="#cb139-10" aria-hidden="true" tabindex="-1"></a>    Value elements<span class="op">[];</span>  <span class="co">// Variable length</span></span>
<span id="cb139-11"><a href="#cb139-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> ArrayObject<span class="op">;</span></span>
<span id="cb139-12"><a href="#cb139-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-13"><a href="#cb139-13" aria-hidden="true" tabindex="-1"></a><span class="co">// String layout (optimized)</span></span>
<span id="cb139-14"><a href="#cb139-14" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb139-15"><a href="#cb139-15" aria-hidden="true" tabindex="-1"></a>    ObjectHeader header<span class="op">;</span></span>
<span id="cb139-16"><a href="#cb139-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> length<span class="op">;</span></span>
<span id="cb139-17"><a href="#cb139-17" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> hash_cache<span class="op">;</span></span>
<span id="cb139-18"><a href="#cb139-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">union</span> <span class="op">{</span></span>
<span id="cb139-19"><a href="#cb139-19" aria-hidden="true" tabindex="-1"></a>        <span class="dt">char</span> inline_chars<span class="op">[</span><span class="dv">24</span><span class="op">];</span>  <span class="co">// Small string optimization</span></span>
<span id="cb139-20"><a href="#cb139-20" aria-hidden="true" tabindex="-1"></a>        <span class="dt">char</span> <span class="op">*</span>external_chars<span class="op">;</span>   <span class="co">// Large strings</span></span>
<span id="cb139-21"><a href="#cb139-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> data<span class="op">;</span></span>
<span id="cb139-22"><a href="#cb139-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> StringObject<span class="op">;</span></span></code></pre></div>
<h2>12.5 Allocation Fast Paths</h2>
<h3>12.5.1 Bump Pointer Allocation</h3>
<div class="sourceCode" id="cb140"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="kw">inline</span> <span class="dt">void</span><span class="op">*</span> alloc_nursery_fast<span class="op">(</span>Heap <span class="op">*</span>heap<span class="op">,</span> <span class="dt">size_t</span> size<span class="op">)</span> <span class="op">{</span></span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check TLAB first</span></span>
<span id="cb140-3"><a href="#cb140-3" aria-hidden="true" tabindex="-1"></a>    TLAB <span class="op">*</span>tlab <span class="op">=</span> get_thread_tlab<span class="op">();</span></span>
<span id="cb140-4"><a href="#cb140-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint8_t</span> <span class="op">*</span>new_ptr <span class="op">=</span> tlab<span class="op">-&gt;</span>current_region<span class="op">-&gt;</span>current <span class="op">+</span> size<span class="op">;</span></span>
<span id="cb140-5"><a href="#cb140-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb140-6"><a href="#cb140-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>likely<span class="op">(</span>new_ptr <span class="op">&lt;=</span> tlab<span class="op">-&gt;</span>current_region<span class="op">-&gt;</span>end<span class="op">))</span> <span class="op">{</span></span>
<span id="cb140-7"><a href="#cb140-7" aria-hidden="true" tabindex="-1"></a>        <span class="dt">void</span> <span class="op">*</span>result <span class="op">=</span> tlab<span class="op">-&gt;</span>current_region<span class="op">-&gt;</span>current<span class="op">;</span></span>
<span id="cb140-8"><a href="#cb140-8" aria-hidden="true" tabindex="-1"></a>        tlab<span class="op">-&gt;</span>current_region<span class="op">-&gt;</span>current <span class="op">=</span> new_ptr<span class="op">;</span></span>
<span id="cb140-9"><a href="#cb140-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> result<span class="op">;</span></span>
<span id="cb140-10"><a href="#cb140-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb140-11"><a href="#cb140-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb140-12"><a href="#cb140-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Slow path - refill TLAB</span></span>
<span id="cb140-13"><a href="#cb140-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> alloc_nursery_slow<span class="op">(</span>heap<span class="op">,</span> size<span class="op">);</span></span>
<span id="cb140-14"><a href="#cb140-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3>12.5.2 Size Class Allocation</h3>
<div class="sourceCode" id="cb141"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Segregated free lists for old generation</span></span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span><span class="op">*</span> alloc_old_gen<span class="op">(</span>Heap <span class="op">*</span>heap<span class="op">,</span> <span class="dt">size_t</span> size<span class="op">)</span> <span class="op">{</span></span>
<span id="cb141-3"><a href="#cb141-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> size_class <span class="op">=</span> size_to_class<span class="op">(</span>size<span class="op">);</span></span>
<span id="cb141-4"><a href="#cb141-4" aria-hidden="true" tabindex="-1"></a>    FreeList <span class="op">*</span>list <span class="op">=</span> heap<span class="op">-&gt;</span>old_gen<span class="op">.</span>free_lists<span class="op">[</span>size_class<span class="op">];</span></span>
<span id="cb141-5"><a href="#cb141-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb141-6"><a href="#cb141-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>list<span class="op">-&gt;</span>head<span class="op">)</span> <span class="op">{</span></span>
<span id="cb141-7"><a href="#cb141-7" aria-hidden="true" tabindex="-1"></a>        FreeBlock <span class="op">*</span>block <span class="op">=</span> list<span class="op">-&gt;</span>head<span class="op">;</span></span>
<span id="cb141-8"><a href="#cb141-8" aria-hidden="true" tabindex="-1"></a>        list<span class="op">-&gt;</span>head <span class="op">=</span> block<span class="op">-&gt;</span>next<span class="op">;</span></span>
<span id="cb141-9"><a href="#cb141-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> block<span class="op">;</span></span>
<span id="cb141-10"><a href="#cb141-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb141-11"><a href="#cb141-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb141-12"><a href="#cb141-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Allocate new region for this size class</span></span>
<span id="cb141-13"><a href="#cb141-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> alloc_new_region<span class="op">(</span>heap<span class="op">,</span> size_class<span class="op">);</span></span>
<span id="cb141-14"><a href="#cb141-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>12.6 Memory Barriers and Consistency</h2>
<h3>12.6.1 Write Barriers</h3>
<p>For generational GC:</p>
<div class="sourceCode" id="cb142"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="kw">inline</span> <span class="dt">void</span> write_barrier<span class="op">(</span><span class="dt">void</span> <span class="op">*</span>obj<span class="op">,</span> <span class="dt">void</span> <span class="op">**</span>field<span class="op">,</span> <span class="dt">void</span> <span class="op">*</span>new_value<span class="op">)</span> <span class="op">{</span></span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">*</span>field <span class="op">=</span> new_value<span class="op">;</span></span>
<span id="cb142-3"><a href="#cb142-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb142-4"><a href="#cb142-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Card marking for generational GC</span></span>
<span id="cb142-5"><a href="#cb142-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>is_old_gen<span class="op">(</span>obj<span class="op">)</span> <span class="op">&amp;&amp;</span> is_young_gen<span class="op">(</span>new_value<span class="op">))</span> <span class="op">{</span></span>
<span id="cb142-6"><a href="#cb142-6" aria-hidden="true" tabindex="-1"></a>        mark_card<span class="op">(</span>obj<span class="op">);</span></span>
<span id="cb142-7"><a href="#cb142-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb142-8"><a href="#cb142-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb142-9"><a href="#cb142-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// SATB barrier for concurrent GC</span></span>
<span id="cb142-10"><a href="#cb142-10" aria-hidden="true" tabindex="-1"></a>    <span class="pp">#ifdef CONCURRENT_GC</span></span>
<span id="cb142-11"><a href="#cb142-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>gc_is_marking<span class="op">()</span> <span class="op">&amp;&amp;</span> <span class="op">*</span>field <span class="op">!=</span> NULL<span class="op">)</span> <span class="op">{</span></span>
<span id="cb142-12"><a href="#cb142-12" aria-hidden="true" tabindex="-1"></a>        satb_enqueue<span class="op">(*</span>field<span class="op">);</span></span>
<span id="cb142-13"><a href="#cb142-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb142-14"><a href="#cb142-14" aria-hidden="true" tabindex="-1"></a>    <span class="pp">#endif</span></span>
<span id="cb142-15"><a href="#cb142-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3>12.6.2 Card Table</h3>
<div class="sourceCode" id="cb143"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> CardTable <span class="op">{</span></span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint8_t</span> <span class="op">*</span>cards<span class="op">;</span></span>
<span id="cb143-3"><a href="#cb143-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> card_shift<span class="op">;</span>  <span class="co">// log2(card_size)</span></span>
<span id="cb143-4"><a href="#cb143-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uintptr_t</span> heap_base<span class="op">;</span></span>
<span id="cb143-5"><a href="#cb143-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> CardTable<span class="op">;</span></span>
<span id="cb143-6"><a href="#cb143-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-7"><a href="#cb143-7" aria-hidden="true" tabindex="-1"></a><span class="pp">#define CARD_CLEAN </span><span class="dv">0</span></span>
<span id="cb143-8"><a href="#cb143-8" aria-hidden="true" tabindex="-1"></a><span class="pp">#define CARD_DIRTY </span><span class="dv">1</span></span>
<span id="cb143-9"><a href="#cb143-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-10"><a href="#cb143-10" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="kw">inline</span> <span class="dt">void</span> mark_card<span class="op">(</span><span class="dt">void</span> <span class="op">*</span>obj<span class="op">)</span> <span class="op">{</span></span>
<span id="cb143-11"><a href="#cb143-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> card_index <span class="op">=</span> <span class="op">((</span><span class="dt">uintptr_t</span><span class="op">)</span>obj <span class="op">-</span> card_table<span class="op">.</span>heap_base<span class="op">)</span> </span>
<span id="cb143-12"><a href="#cb143-12" aria-hidden="true" tabindex="-1"></a>                        <span class="op">&gt;&gt;</span> card_table<span class="op">.</span>card_shift<span class="op">;</span></span>
<span id="cb143-13"><a href="#cb143-13" aria-hidden="true" tabindex="-1"></a>    card_table<span class="op">.</span>cards<span class="op">[</span>card_index<span class="op">]</span> <span class="op">=</span> CARD_DIRTY<span class="op">;</span></span>
<span id="cb143-14"><a href="#cb143-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>12.7 Large Object Management</h2>
<h3>12.7.1 Large Object Space</h3>
<div class="sourceCode" id="cb144"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> LargeObject <span class="op">{</span></span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> LargeObject <span class="op">*</span>next<span class="op">;</span></span>
<span id="cb144-3"><a href="#cb144-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> LargeObject <span class="op">*</span>prev<span class="op">;</span></span>
<span id="cb144-4"><a href="#cb144-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> size<span class="op">;</span></span>
<span id="cb144-5"><a href="#cb144-5" aria-hidden="true" tabindex="-1"></a>    ObjectHeader header<span class="op">;</span></span>
<span id="cb144-6"><a href="#cb144-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Object data follows</span></span>
<span id="cb144-7"><a href="#cb144-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> LargeObject<span class="op">;</span></span>
<span id="cb144-8"><a href="#cb144-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-9"><a href="#cb144-9" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span><span class="op">*</span> alloc_large_object<span class="op">(</span>Heap <span class="op">*</span>heap<span class="op">,</span> <span class="dt">size_t</span> size<span class="op">)</span> <span class="op">{</span></span>
<span id="cb144-10"><a href="#cb144-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> total_size <span class="op">=</span> size <span class="op">+</span> <span class="kw">sizeof</span><span class="op">(</span>LargeObject<span class="op">);</span></span>
<span id="cb144-11"><a href="#cb144-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb144-12"><a href="#cb144-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Direct mmap for very large objects</span></span>
<span id="cb144-13"><a href="#cb144-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>total_size <span class="op">&gt;</span> LARGE_OBJECT_MMAP_THRESHOLD<span class="op">)</span> <span class="op">{</span></span>
<span id="cb144-14"><a href="#cb144-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> mmap_large_object<span class="op">(</span>total_size<span class="op">);</span></span>
<span id="cb144-15"><a href="#cb144-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb144-16"><a href="#cb144-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb144-17"><a href="#cb144-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Use large object free list</span></span>
<span id="cb144-18"><a href="#cb144-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> alloc_from_large_space<span class="op">(</span>heap<span class="op">,</span> total_size<span class="op">);</span></span>
<span id="cb144-19"><a href="#cb144-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>12.8 Memory Profiling and Statistics</h2>
<h3>12.8.1 Allocation Profiling</h3>
<div class="sourceCode" id="cb145"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> AllocationSite <span class="op">{</span></span>
<span id="cb145-2"><a href="#cb145-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span>pc<span class="op">;</span>  <span class="co">// Allocation site PC</span></span>
<span id="cb145-3"><a href="#cb145-3" aria-hidden="true" tabindex="-1"></a>    TypeID type<span class="op">;</span></span>
<span id="cb145-4"><a href="#cb145-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> count<span class="op">;</span></span>
<span id="cb145-5"><a href="#cb145-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> bytes<span class="op">;</span></span>
<span id="cb145-6"><a href="#cb145-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> live_count<span class="op">;</span></span>
<span id="cb145-7"><a href="#cb145-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> live_bytes<span class="op">;</span></span>
<span id="cb145-8"><a href="#cb145-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> AllocationSite<span class="op">;</span></span>
<span id="cb145-9"><a href="#cb145-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-10"><a href="#cb145-10" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> AllocationProfile <span class="op">{</span></span>
<span id="cb145-11"><a href="#cb145-11" aria-hidden="true" tabindex="-1"></a>    HashMap <span class="op">*</span>sites<span class="op">;</span>  <span class="co">// PC -&gt; AllocationSite</span></span>
<span id="cb145-12"><a href="#cb145-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> total_allocated<span class="op">;</span></span>
<span id="cb145-13"><a href="#cb145-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> total_freed<span class="op">;</span></span>
<span id="cb145-14"><a href="#cb145-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> peak_usage<span class="op">;</span></span>
<span id="cb145-15"><a href="#cb145-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> AllocationProfile<span class="op">;</span></span></code></pre></div>
<h3>12.8.2 Memory Pressure Monitoring</h3>
<div class="sourceCode" id="cb146"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> MemoryMonitor <span class="op">{</span></span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> heap_used<span class="op">;</span></span>
<span id="cb146-3"><a href="#cb146-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> heap_capacity<span class="op">;</span></span>
<span id="cb146-4"><a href="#cb146-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> gc_threshold<span class="op">;</span></span>
<span id="cb146-5"><a href="#cb146-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb146-6"><a href="#cb146-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Allocation rate tracking</span></span>
<span id="cb146-7"><a href="#cb146-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> alloc_rate_window<span class="op">[</span>RATE_WINDOW_SIZE<span class="op">];</span></span>
<span id="cb146-8"><a href="#cb146-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> current_window<span class="op">;</span></span>
<span id="cb146-9"><a href="#cb146-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb146-10"><a href="#cb146-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Pressure indicators</span></span>
<span id="cb146-11"><a href="#cb146-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> low_memory<span class="op">;</span></span>
<span id="cb146-12"><a href="#cb146-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> allocation_stall<span class="op">;</span></span>
<span id="cb146-13"><a href="#cb146-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> MemoryMonitor<span class="op">;</span></span>
<span id="cb146-14"><a href="#cb146-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-15"><a href="#cb146-15" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">bool</span> should_trigger_gc<span class="op">(</span>MemoryMonitor <span class="op">*</span>monitor<span class="op">)</span> <span class="op">{</span></span>
<span id="cb146-16"><a href="#cb146-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> monitor<span class="op">-&gt;</span>heap_used <span class="op">&gt;</span> monitor<span class="op">-&gt;</span>gc_threshold <span class="op">||</span></span>
<span id="cb146-17"><a href="#cb146-17" aria-hidden="true" tabindex="-1"></a>           monitor<span class="op">-&gt;</span>low_memory <span class="op">||</span></span>
<span id="cb146-18"><a href="#cb146-18" aria-hidden="true" tabindex="-1"></a>           allocation_rate_excessive<span class="op">(</span>monitor<span class="op">);</span></span>
<span id="cb146-19"><a href="#cb146-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>12.9 Native Memory Integration</h2>
<h3>12.9.1 Foreign Memory Management</h3>
<div class="sourceCode" id="cb147"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> ForeignMemory <span class="op">{</span></span>
<span id="cb147-2"><a href="#cb147-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span>ptr<span class="op">;</span></span>
<span id="cb147-3"><a href="#cb147-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> size<span class="op">;</span></span>
<span id="cb147-4"><a href="#cb147-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">(*</span>finalizer<span class="op">)(</span><span class="dt">void</span> <span class="op">*);</span></span>
<span id="cb147-5"><a href="#cb147-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> ForeignMemory <span class="op">*</span>next<span class="op">;</span></span>
<span id="cb147-6"><a href="#cb147-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> ForeignMemory<span class="op">;</span></span>
<span id="cb147-7"><a href="#cb147-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-8"><a href="#cb147-8" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> ForeignMemory<span class="op">*</span> register_foreign_memory<span class="op">(</span>VM <span class="op">*</span>vm<span class="op">,</span> <span class="dt">void</span> <span class="op">*</span>ptr<span class="op">,</span> </span>
<span id="cb147-9"><a href="#cb147-9" aria-hidden="true" tabindex="-1"></a>                                            <span class="dt">size_t</span> size<span class="op">,</span> </span>
<span id="cb147-10"><a href="#cb147-10" aria-hidden="true" tabindex="-1"></a>                                            <span class="dt">void</span> <span class="op">(*</span>finalizer<span class="op">)(</span><span class="dt">void</span><span class="op">*))</span> <span class="op">{</span></span>
<span id="cb147-11"><a href="#cb147-11" aria-hidden="true" tabindex="-1"></a>    ForeignMemory <span class="op">*</span>fm <span class="op">=</span> allocate_foreign_descriptor<span class="op">();</span></span>
<span id="cb147-12"><a href="#cb147-12" aria-hidden="true" tabindex="-1"></a>    fm<span class="op">-&gt;</span>ptr <span class="op">=</span> ptr<span class="op">;</span></span>
<span id="cb147-13"><a href="#cb147-13" aria-hidden="true" tabindex="-1"></a>    fm<span class="op">-&gt;</span>size <span class="op">=</span> size<span class="op">;</span></span>
<span id="cb147-14"><a href="#cb147-14" aria-hidden="true" tabindex="-1"></a>    fm<span class="op">-&gt;</span>finalizer <span class="op">=</span> finalizer<span class="op">;</span></span>
<span id="cb147-15"><a href="#cb147-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb147-16"><a href="#cb147-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Track for GC pressure</span></span>
<span id="cb147-17"><a href="#cb147-17" aria-hidden="true" tabindex="-1"></a>    vm<span class="op">-&gt;</span>heap<span class="op">-&gt;</span>foreign_bytes <span class="op">+=</span> size<span class="op">;</span></span>
<span id="cb147-18"><a href="#cb147-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb147-19"><a href="#cb147-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> fm<span class="op">;</span></span>
<span id="cb147-20"><a href="#cb147-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>12.10 Memory Safety Features</h2>
<h3>12.10.1 Bounds Checking</h3>
<div class="sourceCode" id="cb148"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="kw">inline</span> <span class="dt">void</span> check_array_bounds<span class="op">(</span>ArrayObject <span class="op">*</span>arr<span class="op">,</span> <span class="dt">size_t</span> index<span class="op">)</span> <span class="op">{</span></span>
<span id="cb148-2"><a href="#cb148-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>unlikely<span class="op">(</span>index <span class="op">&gt;=</span> arr<span class="op">-&gt;</span>header<span class="op">.</span>aux<span class="op">.</span>array_length<span class="op">))</span> <span class="op">{</span></span>
<span id="cb148-3"><a href="#cb148-3" aria-hidden="true" tabindex="-1"></a>        throw_array_bounds_exception<span class="op">(</span>index<span class="op">,</span> arr<span class="op">-&gt;</span>header<span class="op">.</span>aux<span class="op">.</span>array_length<span class="op">);</span></span>
<span id="cb148-4"><a href="#cb148-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb148-5"><a href="#cb148-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb148-6"><a href="#cb148-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-7"><a href="#cb148-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Compiler can optimize away in safe contexts</span></span>
<span id="cb148-8"><a href="#cb148-8" aria-hidden="true" tabindex="-1"></a><span class="pp">#define ARRAY_GET</span><span class="op">(</span><span class="pp">arr</span><span class="op">,</span><span class="pp"> idx</span><span class="op">)</span><span class="pp"> </span><span class="op">({</span><span class="pp"> </span><span class="op">\</span></span>
<span id="cb148-9"><a href="#cb148-9" aria-hidden="true" tabindex="-1"></a><span class="pp">    check_array_bounds</span><span class="op">(</span><span class="pp">arr</span><span class="op">,</span><span class="pp"> idx</span><span class="op">);</span><span class="pp"> </span><span class="op">\</span></span>
<span id="cb148-10"><a href="#cb148-10" aria-hidden="true" tabindex="-1"></a><span class="pp">    arr</span><span class="op">-&gt;</span><span class="pp">elements</span><span class="op">[</span><span class="pp">idx</span><span class="op">];</span><span class="pp"> </span><span class="op">\</span></span>
<span id="cb148-11"><a href="#cb148-11" aria-hidden="true" tabindex="-1"></a><span class="op">})</span></span></code></pre></div>
<h3>12.10.2 Use-After-Free Detection</h3>
<p>In debug builds:</p>
<div class="sourceCode" id="cb149"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> debug_poison_memory<span class="op">(</span><span class="dt">void</span> <span class="op">*</span>ptr<span class="op">,</span> <span class="dt">size_t</span> size<span class="op">)</span> <span class="op">{</span></span>
<span id="cb149-2"><a href="#cb149-2" aria-hidden="true" tabindex="-1"></a>    memset<span class="op">(</span>ptr<span class="op">,</span> POISON_BYTE<span class="op">,</span> size<span class="op">);</span></span>
<span id="cb149-3"><a href="#cb149-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb149-4"><a href="#cb149-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Add to quarantine list</span></span>
<span id="cb149-5"><a href="#cb149-5" aria-hidden="true" tabindex="-1"></a>    quarantine_add<span class="op">(</span>ptr<span class="op">,</span> size<span class="op">);</span></span>
<span id="cb149-6"><a href="#cb149-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>12.11 NUMA and Cache Optimization</h2>
<h3>12.11.1 NUMA-Aware Allocation</h3>
<div class="sourceCode" id="cb150"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> NumaNode <span class="op">{</span></span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> node_id<span class="op">;</span></span>
<span id="cb150-3"><a href="#cb150-3" aria-hidden="true" tabindex="-1"></a>    Heap <span class="op">*</span>local_heap<span class="op">;</span></span>
<span id="cb150-4"><a href="#cb150-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> local_allocations<span class="op">;</span></span>
<span id="cb150-5"><a href="#cb150-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> remote_allocations<span class="op">;</span></span>
<span id="cb150-6"><a href="#cb150-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> NumaNode<span class="op">;</span></span>
<span id="cb150-7"><a href="#cb150-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-8"><a href="#cb150-8" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span><span class="op">*</span> alloc_numa_aware<span class="op">(</span><span class="dt">size_t</span> size<span class="op">)</span> <span class="op">{</span></span>
<span id="cb150-9"><a href="#cb150-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> current_node <span class="op">=</span> get_current_numa_node<span class="op">();</span></span>
<span id="cb150-10"><a href="#cb150-10" aria-hidden="true" tabindex="-1"></a>    NumaNode <span class="op">*</span>node <span class="op">=</span> <span class="op">&amp;</span>numa_nodes<span class="op">[</span>current_node<span class="op">];</span></span>
<span id="cb150-11"><a href="#cb150-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb150-12"><a href="#cb150-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span>result <span class="op">=</span> alloc_from_heap<span class="op">(</span>node<span class="op">-&gt;</span>local_heap<span class="op">,</span> size<span class="op">);</span></span>
<span id="cb150-13"><a href="#cb150-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>result<span class="op">)</span> <span class="op">{</span></span>
<span id="cb150-14"><a href="#cb150-14" aria-hidden="true" tabindex="-1"></a>        node<span class="op">-&gt;</span>local_allocations<span class="op">++;</span></span>
<span id="cb150-15"><a href="#cb150-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb150-16"><a href="#cb150-16" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Fallback to remote allocation</span></span>
<span id="cb150-17"><a href="#cb150-17" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> alloc_from_any_node<span class="op">(</span>size<span class="op">);</span></span>
<span id="cb150-18"><a href="#cb150-18" aria-hidden="true" tabindex="-1"></a>        node<span class="op">-&gt;</span>remote_allocations<span class="op">++;</span></span>
<span id="cb150-19"><a href="#cb150-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb150-20"><a href="#cb150-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb150-21"><a href="#cb150-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result<span class="op">;</span></span>
<span id="cb150-22"><a href="#cb150-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>12.12 Performance Considerations</h2>
<h3>12.12.1 Allocation Benchmarks</h3>
<p>Typical allocation rates achieved:</p>
<ul>
<li>Nursery allocation: 10-50 cycles per object</li>
<li>TLAB allocation: 15-30 cycles with refill amortized</li>
<li>Large object allocation: 200-1000 cycles</li>
</ul>
<h3>12.12.2 Memory Bandwidth Optimization</h3>
<ul>
<li>Cache-line alignment for hot objects</li>
<li>Prefetching in allocation paths</li>
<li>Minimizing write barrier overhead</li>
</ul>
<h2>12.13 Summary</h2>
<p>This chapter has presented Diyrbal&#39;s comprehensive memory
architecture, from low-level heap organization to high-level allocation
APIs. The design emphasizes:</p>
<ol type="1">
<li><strong>Fast allocation paths</strong> with TLAB and bump-pointer
allocation</li>
<li><strong>Generational organization</strong> for efficient GC</li>
<li><strong>Flexible object layouts</strong> with header
optimization</li>
<li><strong>Memory safety</strong> through bounds checking and
poisoning</li>
<li><strong>Profiling integration</strong> for optimization
feedback</li>
</ol>
<p>The memory system provides the foundation for safe, efficient
execution while maintaining compatibility with advanced GC algorithms
and concurrent execution. Next, Chapter 13 will explore how this memory
architecture enables sophisticated garbage collection strategies. Based
on the memory architecture from Chapter 12 and drawing from the GC
concepts in your materials, here&#39;s Chapter 13 on the Mark-and-Compact
Garbage Collector:</p>
<h1>Chapter 13: Mark-and-Compact Garbage Collector</h1>
<h2>13.1 Introduction</h2>
<p>This chapter presents Diyrbal&#39;s mark-and-compact garbage collector,
which addresses fragmentation in the old generation while maintaining
spatial locality. Building on the memory architecture from Chapter 12,
we implement a collector that combines the non-copying nature of
mark-sweep with the fragmentation elimination of copying collectors.</p>
<h2>13.2 Design Overview</h2>
<h3>13.2.1 Collector Architecture</h3>
<div class="sourceCode" id="cb151"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> CompactingCollector <span class="op">{</span></span>
<span id="cb151-2"><a href="#cb151-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Marking state</span></span>
<span id="cb151-3"><a href="#cb151-3" aria-hidden="true" tabindex="-1"></a>    MarkStack <span class="op">*</span>mark_stack<span class="op">;</span></span>
<span id="cb151-4"><a href="#cb151-4" aria-hidden="true" tabindex="-1"></a>    MarkBitmap <span class="op">*</span>mark_bits<span class="op">;</span></span>
<span id="cb151-5"><a href="#cb151-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb151-6"><a href="#cb151-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Compaction state</span></span>
<span id="cb151-7"><a href="#cb151-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint8_t</span> <span class="op">*</span>compact_pointer<span class="op">;</span></span>
<span id="cb151-8"><a href="#cb151-8" aria-hidden="true" tabindex="-1"></a>    ForwardingTable <span class="op">*</span>forwarding<span class="op">;</span></span>
<span id="cb151-9"><a href="#cb151-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb151-10"><a href="#cb151-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Statistics</span></span>
<span id="cb151-11"><a href="#cb151-11" aria-hidden="true" tabindex="-1"></a>    GCStats stats<span class="op">;</span></span>
<span id="cb151-12"><a href="#cb151-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> fragmentation_before<span class="op">;</span></span>
<span id="cb151-13"><a href="#cb151-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> fragmentation_after<span class="op">;</span></span>
<span id="cb151-14"><a href="#cb151-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> CompactingCollector<span class="op">;</span></span></code></pre></div>
<h3>13.2.2 Collection Phases</h3>
<p>The collector operates in four distinct phases:</p>
<ol type="1">
<li><strong>Mark phase</strong>: Trace reachable objects</li>
<li><strong>Compute forwarding addresses</strong>: Calculate new
locations</li>
<li><strong>Update references</strong>: Fix all pointers</li>
<li><strong>Compact</strong>: Move objects to new locations</li>
</ol>
<h2>13.3 Marking Phase</h2>
<h3>13.3.1 Mark Bitmap</h3>
<div class="sourceCode" id="cb152"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> MarkBitmap <span class="op">{</span></span>
<span id="cb152-2"><a href="#cb152-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint64_t</span> <span class="op">*</span>bits<span class="op">;</span></span>
<span id="cb152-3"><a href="#cb152-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> size_in_words<span class="op">;</span></span>
<span id="cb152-4"><a href="#cb152-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uintptr_t</span> heap_base<span class="op">;</span></span>
<span id="cb152-5"><a href="#cb152-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> heap_size<span class="op">;</span></span>
<span id="cb152-6"><a href="#cb152-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> MarkBitmap<span class="op">;</span></span>
<span id="cb152-7"><a href="#cb152-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-8"><a href="#cb152-8" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="kw">inline</span> <span class="dt">void</span> mark_object<span class="op">(</span>MarkBitmap <span class="op">*</span>bitmap<span class="op">,</span> <span class="dt">void</span> <span class="op">*</span>obj<span class="op">)</span> <span class="op">{</span></span>
<span id="cb152-9"><a href="#cb152-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> offset <span class="op">=</span> <span class="op">(</span><span class="dt">uintptr_t</span><span class="op">)</span>obj <span class="op">-</span> bitmap<span class="op">-&gt;</span>heap_base<span class="op">;</span></span>
<span id="cb152-10"><a href="#cb152-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> word_idx <span class="op">=</span> offset <span class="op">/</span> <span class="op">(</span><span class="dv">64</span> <span class="op">*</span> GRANULE_SIZE<span class="op">);</span></span>
<span id="cb152-11"><a href="#cb152-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> bit_idx <span class="op">=</span> <span class="op">(</span>offset <span class="op">/</span> GRANULE_SIZE<span class="op">)</span> <span class="op">%</span> <span class="dv">64</span><span class="op">;</span></span>
<span id="cb152-12"><a href="#cb152-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb152-13"><a href="#cb152-13" aria-hidden="true" tabindex="-1"></a>    bitmap<span class="op">-&gt;</span>bits<span class="op">[</span>word_idx<span class="op">]</span> <span class="op">|=</span> <span class="op">(</span><span class="dv">1</span><span class="bu">ULL</span> <span class="op">&lt;&lt;</span> bit_idx<span class="op">);</span></span>
<span id="cb152-14"><a href="#cb152-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb152-15"><a href="#cb152-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-16"><a href="#cb152-16" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="kw">inline</span> <span class="dt">bool</span> is_marked<span class="op">(</span>MarkBitmap <span class="op">*</span>bitmap<span class="op">,</span> <span class="dt">void</span> <span class="op">*</span>obj<span class="op">)</span> <span class="op">{</span></span>
<span id="cb152-17"><a href="#cb152-17" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> offset <span class="op">=</span> <span class="op">(</span><span class="dt">uintptr_t</span><span class="op">)</span>obj <span class="op">-</span> bitmap<span class="op">-&gt;</span>heap_base<span class="op">;</span></span>
<span id="cb152-18"><a href="#cb152-18" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> word_idx <span class="op">=</span> offset <span class="op">/</span> <span class="op">(</span><span class="dv">64</span> <span class="op">*</span> GRANULE_SIZE<span class="op">);</span></span>
<span id="cb152-19"><a href="#cb152-19" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> bit_idx <span class="op">=</span> <span class="op">(</span>offset <span class="op">/</span> GRANULE_SIZE<span class="op">)</span> <span class="op">%</span> <span class="dv">64</span><span class="op">;</span></span>
<span id="cb152-20"><a href="#cb152-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb152-21"><a href="#cb152-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> bitmap<span class="op">-&gt;</span>bits<span class="op">[</span>word_idx<span class="op">]</span> <span class="op">&amp;</span> <span class="op">(</span><span class="dv">1</span><span class="bu">ULL</span> <span class="op">&lt;&lt;</span> bit_idx<span class="op">);</span></span>
<span id="cb152-22"><a href="#cb152-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3>13.3.2 Tricolor Marking</h3>
<div class="sourceCode" id="cb153"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> mark_from_roots<span class="op">(</span>CompactingCollector <span class="op">*</span>gc<span class="op">,</span> VM <span class="op">*</span>vm<span class="op">)</span> <span class="op">{</span></span>
<span id="cb153-2"><a href="#cb153-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Initialize mark stack with roots</span></span>
<span id="cb153-3"><a href="#cb153-3" aria-hidden="true" tabindex="-1"></a>    mark_vm_roots<span class="op">(</span>vm<span class="op">,</span> gc<span class="op">);</span></span>
<span id="cb153-4"><a href="#cb153-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb153-5"><a href="#cb153-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Process mark stack</span></span>
<span id="cb153-6"><a href="#cb153-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(!</span>mark_stack_empty<span class="op">(</span>gc<span class="op">-&gt;</span>mark_stack<span class="op">))</span> <span class="op">{</span></span>
<span id="cb153-7"><a href="#cb153-7" aria-hidden="true" tabindex="-1"></a>        ObjectHeader <span class="op">*</span>obj <span class="op">=</span> mark_stack_pop<span class="op">(</span>gc<span class="op">-&gt;</span>mark_stack<span class="op">);</span></span>
<span id="cb153-8"><a href="#cb153-8" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb153-9"><a href="#cb153-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>is_marked<span class="op">(</span>gc<span class="op">-&gt;</span>mark_bits<span class="op">,</span> obj<span class="op">))</span></span>
<span id="cb153-10"><a href="#cb153-10" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb153-11"><a href="#cb153-11" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb153-12"><a href="#cb153-12" aria-hidden="true" tabindex="-1"></a>        mark_object<span class="op">(</span>gc<span class="op">-&gt;</span>mark_bits<span class="op">,</span> obj<span class="op">);</span></span>
<span id="cb153-13"><a href="#cb153-13" aria-hidden="true" tabindex="-1"></a>        gc<span class="op">-&gt;</span>stats<span class="op">.</span>marked_objects<span class="op">++;</span></span>
<span id="cb153-14"><a href="#cb153-14" aria-hidden="true" tabindex="-1"></a>        gc<span class="op">-&gt;</span>stats<span class="op">.</span>marked_bytes <span class="op">+=</span> object_size<span class="op">(</span>obj<span class="op">);</span></span>
<span id="cb153-15"><a href="#cb153-15" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb153-16"><a href="#cb153-16" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Scan object fields</span></span>
<span id="cb153-17"><a href="#cb153-17" aria-hidden="true" tabindex="-1"></a>        scan_object<span class="op">(</span>gc<span class="op">,</span> obj<span class="op">);</span></span>
<span id="cb153-18"><a href="#cb153-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb153-19"><a href="#cb153-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb153-20"><a href="#cb153-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-21"><a href="#cb153-21" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> scan_object<span class="op">(</span>CompactingCollector <span class="op">*</span>gc<span class="op">,</span> ObjectHeader <span class="op">*</span>obj<span class="op">)</span> <span class="op">{</span></span>
<span id="cb153-22"><a href="#cb153-22" aria-hidden="true" tabindex="-1"></a>    TypeInfo <span class="op">*</span>type <span class="op">=</span> get_type_info<span class="op">(</span>obj<span class="op">-&gt;</span>header<span class="op">.</span>bits<span class="op">.</span>type_id<span class="op">);</span></span>
<span id="cb153-23"><a href="#cb153-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb153-24"><a href="#cb153-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>type<span class="op">-&gt;</span>flags <span class="op">&amp;</span> TYPE_ARRAY<span class="op">)</span> <span class="op">{</span></span>
<span id="cb153-25"><a href="#cb153-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>type<span class="op">-&gt;</span>element_type <span class="op">==</span> TYPE_REFERENCE<span class="op">)</span> <span class="op">{</span></span>
<span id="cb153-26"><a href="#cb153-26" aria-hidden="true" tabindex="-1"></a>            ArrayObject <span class="op">*</span>arr <span class="op">=</span> <span class="op">(</span>ArrayObject<span class="op">*)</span>obj<span class="op">;</span></span>
<span id="cb153-27"><a href="#cb153-27" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> arr<span class="op">-&gt;</span>header<span class="op">.</span>aux<span class="op">.</span>array_length<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb153-28"><a href="#cb153-28" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span>arr<span class="op">-&gt;</span>elements<span class="op">[</span>i<span class="op">].</span>type <span class="op">==</span> VALUE_OBJECT<span class="op">)</span> <span class="op">{</span></span>
<span id="cb153-29"><a href="#cb153-29" aria-hidden="true" tabindex="-1"></a>                    mark_stack_push<span class="op">(</span>gc<span class="op">-&gt;</span>mark_stack<span class="op">,</span> arr<span class="op">-&gt;</span>elements<span class="op">[</span>i<span class="op">].</span>obj<span class="op">);</span></span>
<span id="cb153-30"><a href="#cb153-30" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb153-31"><a href="#cb153-31" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb153-32"><a href="#cb153-32" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb153-33"><a href="#cb153-33" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb153-34"><a href="#cb153-34" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Fixed object - scan fields using type descriptor</span></span>
<span id="cb153-35"><a href="#cb153-35" aria-hidden="true" tabindex="-1"></a>        FixedObject <span class="op">*</span>fixed <span class="op">=</span> <span class="op">(</span>FixedObject<span class="op">*)</span>obj<span class="op">;</span></span>
<span id="cb153-36"><a href="#cb153-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> type<span class="op">-&gt;</span>field_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb153-37"><a href="#cb153-37" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>type<span class="op">-&gt;</span>fields<span class="op">[</span>i<span class="op">].</span>is_reference<span class="op">)</span> <span class="op">{</span></span>
<span id="cb153-38"><a href="#cb153-38" aria-hidden="true" tabindex="-1"></a>                Value <span class="op">*</span>field <span class="op">=</span> <span class="op">&amp;</span>fixed<span class="op">-&gt;</span>fields<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb153-39"><a href="#cb153-39" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span>field<span class="op">-&gt;</span>type <span class="op">==</span> VALUE_OBJECT <span class="op">&amp;&amp;</span> field<span class="op">-&gt;</span>obj<span class="op">)</span> <span class="op">{</span></span>
<span id="cb153-40"><a href="#cb153-40" aria-hidden="true" tabindex="-1"></a>                    mark_stack_push<span class="op">(</span>gc<span class="op">-&gt;</span>mark_stack<span class="op">,</span> field<span class="op">-&gt;</span>obj<span class="op">);</span></span>
<span id="cb153-41"><a href="#cb153-41" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb153-42"><a href="#cb153-42" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb153-43"><a href="#cb153-43" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb153-44"><a href="#cb153-44" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb153-45"><a href="#cb153-45" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>13.4 Compaction Algorithm</h2>
<h3>13.4.1 Two-Finger Compaction</h3>
<div class="sourceCode" id="cb154"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> compute_forwarding_addresses<span class="op">(</span>CompactingCollector <span class="op">*</span>gc<span class="op">,</span> Heap <span class="op">*</span>heap<span class="op">)</span> <span class="op">{</span></span>
<span id="cb154-2"><a href="#cb154-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint8_t</span> <span class="op">*</span>free <span class="op">=</span> heap<span class="op">-&gt;</span>old_gen<span class="op">.</span>start<span class="op">;</span></span>
<span id="cb154-3"><a href="#cb154-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint8_t</span> <span class="op">*</span>scan <span class="op">=</span> heap<span class="op">-&gt;</span>old_gen<span class="op">.</span>start<span class="op">;</span></span>
<span id="cb154-4"><a href="#cb154-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb154-5"><a href="#cb154-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// First pass: compute new addresses</span></span>
<span id="cb154-6"><a href="#cb154-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span>scan <span class="op">&lt;</span> heap<span class="op">-&gt;</span>old_gen<span class="op">.</span>alloc_ptr<span class="op">)</span> <span class="op">{</span></span>
<span id="cb154-7"><a href="#cb154-7" aria-hidden="true" tabindex="-1"></a>        ObjectHeader <span class="op">*</span>obj <span class="op">=</span> <span class="op">(</span>ObjectHeader<span class="op">*)</span>scan<span class="op">;</span></span>
<span id="cb154-8"><a href="#cb154-8" aria-hidden="true" tabindex="-1"></a>        <span class="dt">size_t</span> obj_size <span class="op">=</span> object_size<span class="op">(</span>obj<span class="op">);</span></span>
<span id="cb154-9"><a href="#cb154-9" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb154-10"><a href="#cb154-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>is_marked<span class="op">(</span>gc<span class="op">-&gt;</span>mark_bits<span class="op">,</span> obj<span class="op">))</span> <span class="op">{</span></span>
<span id="cb154-11"><a href="#cb154-11" aria-hidden="true" tabindex="-1"></a>            <span class="co">// This object will move to &#39;free&#39;</span></span>
<span id="cb154-12"><a href="#cb154-12" aria-hidden="true" tabindex="-1"></a>            set_forwarding_address<span class="op">(</span>gc<span class="op">-&gt;</span>forwarding<span class="op">,</span> obj<span class="op">,</span> free<span class="op">);</span></span>
<span id="cb154-13"><a href="#cb154-13" aria-hidden="true" tabindex="-1"></a>            free <span class="op">+=</span> obj_size<span class="op">;</span></span>
<span id="cb154-14"><a href="#cb154-14" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb154-15"><a href="#cb154-15" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb154-16"><a href="#cb154-16" aria-hidden="true" tabindex="-1"></a>        scan <span class="op">+=</span> obj_size<span class="op">;</span></span>
<span id="cb154-17"><a href="#cb154-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb154-18"><a href="#cb154-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb154-19"><a href="#cb154-19" aria-hidden="true" tabindex="-1"></a>    gc<span class="op">-&gt;</span>compact_pointer <span class="op">=</span> free<span class="op">;</span></span>
<span id="cb154-20"><a href="#cb154-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3>13.4.2 Forwarding Table</h3>
<div class="sourceCode" id="cb155"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> ForwardingTable <span class="op">{</span></span>
<span id="cb155-2"><a href="#cb155-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Use a hash table for sparse forwarding</span></span>
<span id="cb155-3"><a href="#cb155-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> ForwardingEntry <span class="op">{</span></span>
<span id="cb155-4"><a href="#cb155-4" aria-hidden="true" tabindex="-1"></a>        <span class="dt">void</span> <span class="op">*</span>from<span class="op">;</span></span>
<span id="cb155-5"><a href="#cb155-5" aria-hidden="true" tabindex="-1"></a>        <span class="dt">void</span> <span class="op">*</span>to<span class="op">;</span></span>
<span id="cb155-6"><a href="#cb155-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">struct</span> ForwardingEntry <span class="op">*</span>next<span class="op">;</span></span>
<span id="cb155-7"><a href="#cb155-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="op">**</span>buckets<span class="op">;</span></span>
<span id="cb155-8"><a href="#cb155-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> bucket_count<span class="op">;</span></span>
<span id="cb155-9"><a href="#cb155-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> ForwardingTable<span class="op">;</span></span>
<span id="cb155-10"><a href="#cb155-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-11"><a href="#cb155-11" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> set_forwarding_address<span class="op">(</span>ForwardingTable <span class="op">*</span>table<span class="op">,</span> </span>
<span id="cb155-12"><a href="#cb155-12" aria-hidden="true" tabindex="-1"></a>                                 <span class="dt">void</span> <span class="op">*</span>from<span class="op">,</span> <span class="dt">void</span> <span class="op">*</span>to<span class="op">)</span> <span class="op">{</span></span>
<span id="cb155-13"><a href="#cb155-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> hash <span class="op">=</span> hash_ptr<span class="op">(</span>from<span class="op">)</span> <span class="op">%</span> table<span class="op">-&gt;</span>bucket_count<span class="op">;</span></span>
<span id="cb155-14"><a href="#cb155-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb155-15"><a href="#cb155-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> ForwardingEntry <span class="op">*</span>entry <span class="op">=</span> allocate_entry<span class="op">();</span></span>
<span id="cb155-16"><a href="#cb155-16" aria-hidden="true" tabindex="-1"></a>    entry<span class="op">-&gt;</span>from <span class="op">=</span> from<span class="op">;</span></span>
<span id="cb155-17"><a href="#cb155-17" aria-hidden="true" tabindex="-1"></a>    entry<span class="op">-&gt;</span>to <span class="op">=</span> to<span class="op">;</span></span>
<span id="cb155-18"><a href="#cb155-18" aria-hidden="true" tabindex="-1"></a>    entry<span class="op">-&gt;</span>next <span class="op">=</span> table<span class="op">-&gt;</span>buckets<span class="op">[</span>hash<span class="op">];</span></span>
<span id="cb155-19"><a href="#cb155-19" aria-hidden="true" tabindex="-1"></a>    table<span class="op">-&gt;</span>buckets<span class="op">[</span>hash<span class="op">]</span> <span class="op">=</span> entry<span class="op">;</span></span>
<span id="cb155-20"><a href="#cb155-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb155-21"><a href="#cb155-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-22"><a href="#cb155-22" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span><span class="op">*</span> get_forwarding_address<span class="op">(</span>ForwardingTable <span class="op">*</span>table<span class="op">,</span> <span class="dt">void</span> <span class="op">*</span>from<span class="op">)</span> <span class="op">{</span></span>
<span id="cb155-23"><a href="#cb155-23" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> hash <span class="op">=</span> hash_ptr<span class="op">(</span>from<span class="op">)</span> <span class="op">%</span> table<span class="op">-&gt;</span>bucket_count<span class="op">;</span></span>
<span id="cb155-24"><a href="#cb155-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb155-25"><a href="#cb155-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="kw">struct</span> ForwardingEntry <span class="op">*</span>e <span class="op">=</span> table<span class="op">-&gt;</span>buckets<span class="op">[</span>hash<span class="op">];</span> e<span class="op">;</span> e <span class="op">=</span> e<span class="op">-&gt;</span>next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb155-26"><a href="#cb155-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>e<span class="op">-&gt;</span>from <span class="op">==</span> from<span class="op">)</span></span>
<span id="cb155-27"><a href="#cb155-27" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> e<span class="op">-&gt;</span>to<span class="op">;</span></span>
<span id="cb155-28"><a href="#cb155-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb155-29"><a href="#cb155-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> from<span class="op">;</span> <span class="co">// Not forwarded</span></span>
<span id="cb155-30"><a href="#cb155-30" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>13.5 Reference Update Phase</h2>
<h3>13.5.1 Updating Pointers</h3>
<div class="sourceCode" id="cb156"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> update_references<span class="op">(</span>CompactingCollector <span class="op">*</span>gc<span class="op">,</span> VM <span class="op">*</span>vm<span class="op">)</span> <span class="op">{</span></span>
<span id="cb156-2"><a href="#cb156-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Update roots</span></span>
<span id="cb156-3"><a href="#cb156-3" aria-hidden="true" tabindex="-1"></a>    update_root_references<span class="op">(</span>gc<span class="op">,</span> vm<span class="op">);</span></span>
<span id="cb156-4"><a href="#cb156-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb156-5"><a href="#cb156-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Update heap references</span></span>
<span id="cb156-6"><a href="#cb156-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint8_t</span> <span class="op">*</span>scan <span class="op">=</span> vm<span class="op">-&gt;</span>heap<span class="op">-&gt;</span>old_gen<span class="op">.</span>start<span class="op">;</span></span>
<span id="cb156-7"><a href="#cb156-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span>scan <span class="op">&lt;</span> vm<span class="op">-&gt;</span>heap<span class="op">-&gt;</span>old_gen<span class="op">.</span>alloc_ptr<span class="op">)</span> <span class="op">{</span></span>
<span id="cb156-8"><a href="#cb156-8" aria-hidden="true" tabindex="-1"></a>        ObjectHeader <span class="op">*</span>obj <span class="op">=</span> <span class="op">(</span>ObjectHeader<span class="op">*)</span>scan<span class="op">;</span></span>
<span id="cb156-9"><a href="#cb156-9" aria-hidden="true" tabindex="-1"></a>        <span class="dt">size_t</span> obj_size <span class="op">=</span> object_size<span class="op">(</span>obj<span class="op">);</span></span>
<span id="cb156-10"><a href="#cb156-10" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb156-11"><a href="#cb156-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>is_marked<span class="op">(</span>gc<span class="op">-&gt;</span>mark_bits<span class="op">,</span> obj<span class="op">))</span> <span class="op">{</span></span>
<span id="cb156-12"><a href="#cb156-12" aria-hidden="true" tabindex="-1"></a>            update_object_references<span class="op">(</span>gc<span class="op">,</span> obj<span class="op">);</span></span>
<span id="cb156-13"><a href="#cb156-13" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb156-14"><a href="#cb156-14" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb156-15"><a href="#cb156-15" aria-hidden="true" tabindex="-1"></a>        scan <span class="op">+=</span> obj_size<span class="op">;</span></span>
<span id="cb156-16"><a href="#cb156-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb156-17"><a href="#cb156-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb156-18"><a href="#cb156-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-19"><a href="#cb156-19" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> update_object_references<span class="op">(</span>CompactingCollector <span class="op">*</span>gc<span class="op">,</span> </span>
<span id="cb156-20"><a href="#cb156-20" aria-hidden="true" tabindex="-1"></a>                                   ObjectHeader <span class="op">*</span>obj<span class="op">)</span> <span class="op">{</span></span>
<span id="cb156-21"><a href="#cb156-21" aria-hidden="true" tabindex="-1"></a>    TypeInfo <span class="op">*</span>type <span class="op">=</span> get_type_info<span class="op">(</span>obj<span class="op">-&gt;</span>header<span class="op">.</span>bits<span class="op">.</span>type_id<span class="op">);</span></span>
<span id="cb156-22"><a href="#cb156-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb156-23"><a href="#cb156-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>type<span class="op">-&gt;</span>flags <span class="op">&amp;</span> TYPE_ARRAY<span class="op">)</span> <span class="op">{</span></span>
<span id="cb156-24"><a href="#cb156-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>type<span class="op">-&gt;</span>element_type <span class="op">==</span> TYPE_REFERENCE<span class="op">)</span> <span class="op">{</span></span>
<span id="cb156-25"><a href="#cb156-25" aria-hidden="true" tabindex="-1"></a>            ArrayObject <span class="op">*</span>arr <span class="op">=</span> <span class="op">(</span>ArrayObject<span class="op">*)</span>obj<span class="op">;</span></span>
<span id="cb156-26"><a href="#cb156-26" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> arr<span class="op">-&gt;</span>header<span class="op">.</span>aux<span class="op">.</span>array_length<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb156-27"><a href="#cb156-27" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span>arr<span class="op">-&gt;</span>elements<span class="op">[</span>i<span class="op">].</span>type <span class="op">==</span> VALUE_OBJECT<span class="op">)</span> <span class="op">{</span></span>
<span id="cb156-28"><a href="#cb156-28" aria-hidden="true" tabindex="-1"></a>                    arr<span class="op">-&gt;</span>elements<span class="op">[</span>i<span class="op">].</span>obj <span class="op">=</span> </span>
<span id="cb156-29"><a href="#cb156-29" aria-hidden="true" tabindex="-1"></a>                        get_forwarding_address<span class="op">(</span>gc<span class="op">-&gt;</span>forwarding<span class="op">,</span> </span>
<span id="cb156-30"><a href="#cb156-30" aria-hidden="true" tabindex="-1"></a>                                             arr<span class="op">-&gt;</span>elements<span class="op">[</span>i<span class="op">].</span>obj<span class="op">);</span></span>
<span id="cb156-31"><a href="#cb156-31" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb156-32"><a href="#cb156-32" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb156-33"><a href="#cb156-33" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb156-34"><a href="#cb156-34" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb156-35"><a href="#cb156-35" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Update fixed object fields</span></span>
<span id="cb156-36"><a href="#cb156-36" aria-hidden="true" tabindex="-1"></a>        FixedObject <span class="op">*</span>fixed <span class="op">=</span> <span class="op">(</span>FixedObject<span class="op">*)</span>obj<span class="op">;</span></span>
<span id="cb156-37"><a href="#cb156-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> type<span class="op">-&gt;</span>field_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb156-38"><a href="#cb156-38" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>type<span class="op">-&gt;</span>fields<span class="op">[</span>i<span class="op">].</span>is_reference<span class="op">)</span> <span class="op">{</span></span>
<span id="cb156-39"><a href="#cb156-39" aria-hidden="true" tabindex="-1"></a>                Value <span class="op">*</span>field <span class="op">=</span> <span class="op">&amp;</span>fixed<span class="op">-&gt;</span>fields<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb156-40"><a href="#cb156-40" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span>field<span class="op">-&gt;</span>type <span class="op">==</span> VALUE_OBJECT <span class="op">&amp;&amp;</span> field<span class="op">-&gt;</span>obj<span class="op">)</span> <span class="op">{</span></span>
<span id="cb156-41"><a href="#cb156-41" aria-hidden="true" tabindex="-1"></a>                    field<span class="op">-&gt;</span>obj <span class="op">=</span> </span>
<span id="cb156-42"><a href="#cb156-42" aria-hidden="true" tabindex="-1"></a>                        get_forwarding_address<span class="op">(</span>gc<span class="op">-&gt;</span>forwarding<span class="op">,</span> field<span class="op">-&gt;</span>obj<span class="op">);</span></span>
<span id="cb156-43"><a href="#cb156-43" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb156-44"><a href="#cb156-44" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb156-45"><a href="#cb156-45" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb156-46"><a href="#cb156-46" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb156-47"><a href="#cb156-47" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>13.6 Object Movement Phase</h2>
<h3>13.6.1 Compact Memory</h3>
<div class="sourceCode" id="cb157"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb157-1"><a href="#cb157-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> compact_heap<span class="op">(</span>CompactingCollector <span class="op">*</span>gc<span class="op">,</span> Heap <span class="op">*</span>heap<span class="op">)</span> <span class="op">{</span></span>
<span id="cb157-2"><a href="#cb157-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint8_t</span> <span class="op">*</span>scan <span class="op">=</span> heap<span class="op">-&gt;</span>old_gen<span class="op">.</span>start<span class="op">;</span></span>
<span id="cb157-3"><a href="#cb157-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb157-4"><a href="#cb157-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span>scan <span class="op">&lt;</span> heap<span class="op">-&gt;</span>old_gen<span class="op">.</span>alloc_ptr<span class="op">)</span> <span class="op">{</span></span>
<span id="cb157-5"><a href="#cb157-5" aria-hidden="true" tabindex="-1"></a>        ObjectHeader <span class="op">*</span>obj <span class="op">=</span> <span class="op">(</span>ObjectHeader<span class="op">*)</span>scan<span class="op">;</span></span>
<span id="cb157-6"><a href="#cb157-6" aria-hidden="true" tabindex="-1"></a>        <span class="dt">size_t</span> obj_size <span class="op">=</span> object_size<span class="op">(</span>obj<span class="op">);</span></span>
<span id="cb157-7"><a href="#cb157-7" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb157-8"><a href="#cb157-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>is_marked<span class="op">(</span>gc<span class="op">-&gt;</span>mark_bits<span class="op">,</span> obj<span class="op">))</span> <span class="op">{</span></span>
<span id="cb157-9"><a href="#cb157-9" aria-hidden="true" tabindex="-1"></a>            <span class="dt">void</span> <span class="op">*</span>new_addr <span class="op">=</span> get_forwarding_address<span class="op">(</span>gc<span class="op">-&gt;</span>forwarding<span class="op">,</span> obj<span class="op">);</span></span>
<span id="cb157-10"><a href="#cb157-10" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb157-11"><a href="#cb157-11" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>new_addr <span class="op">!=</span> obj<span class="op">)</span> <span class="op">{</span></span>
<span id="cb157-12"><a href="#cb157-12" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Move object</span></span>
<span id="cb157-13"><a href="#cb157-13" aria-hidden="true" tabindex="-1"></a>                memmove<span class="op">(</span>new_addr<span class="op">,</span> obj<span class="op">,</span> obj_size<span class="op">);</span></span>
<span id="cb157-14"><a href="#cb157-14" aria-hidden="true" tabindex="-1"></a>                gc<span class="op">-&gt;</span>stats<span class="op">.</span>moved_objects<span class="op">++;</span></span>
<span id="cb157-15"><a href="#cb157-15" aria-hidden="true" tabindex="-1"></a>                gc<span class="op">-&gt;</span>stats<span class="op">.</span>moved_bytes <span class="op">+=</span> obj_size<span class="op">;</span></span>
<span id="cb157-16"><a href="#cb157-16" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb157-17"><a href="#cb157-17" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb157-18"><a href="#cb157-18" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb157-19"><a href="#cb157-19" aria-hidden="true" tabindex="-1"></a>        scan <span class="op">+=</span> obj_size<span class="op">;</span></span>
<span id="cb157-20"><a href="#cb157-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb157-21"><a href="#cb157-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb157-22"><a href="#cb157-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Update heap allocation pointer</span></span>
<span id="cb157-23"><a href="#cb157-23" aria-hidden="true" tabindex="-1"></a>    heap<span class="op">-&gt;</span>old_gen<span class="op">.</span>alloc_ptr <span class="op">=</span> gc<span class="op">-&gt;</span>compact_pointer<span class="op">;</span></span>
<span id="cb157-24"><a href="#cb157-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>13.7 Optimizations</h2>
<h3>13.7.1 Threaded Compaction</h3>
<p>For better performance on objects with many pointers:</p>
<div class="sourceCode" id="cb158"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> threaded_compact<span class="op">(</span>CompactingCollector <span class="op">*</span>gc<span class="op">,</span> Heap <span class="op">*</span>heap<span class="op">)</span> <span class="op">{</span></span>
<span id="cb158-2"><a href="#cb158-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// First pass: thread objects through their first field</span></span>
<span id="cb158-3"><a href="#cb158-3" aria-hidden="true" tabindex="-1"></a>    thread_objects<span class="op">(</span>gc<span class="op">,</span> heap<span class="op">);</span></span>
<span id="cb158-4"><a href="#cb158-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb158-5"><a href="#cb158-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Second pass: update pointers</span></span>
<span id="cb158-6"><a href="#cb158-6" aria-hidden="true" tabindex="-1"></a>    update_threaded_references<span class="op">(</span>gc<span class="op">,</span> heap<span class="op">);</span></span>
<span id="cb158-7"><a href="#cb158-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb158-8"><a href="#cb158-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Third pass: move objects</span></span>
<span id="cb158-9"><a href="#cb158-9" aria-hidden="true" tabindex="-1"></a>    move_threaded_objects<span class="op">(</span>gc<span class="op">,</span> heap<span class="op">);</span></span>
<span id="cb158-10"><a href="#cb158-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb158-11"><a href="#cb158-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-12"><a href="#cb158-12" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> thread_objects<span class="op">(</span>CompactingCollector <span class="op">*</span>gc<span class="op">,</span> Heap <span class="op">*</span>heap<span class="op">)</span> <span class="op">{</span></span>
<span id="cb158-13"><a href="#cb158-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint8_t</span> <span class="op">*</span>free <span class="op">=</span> heap<span class="op">-&gt;</span>old_gen<span class="op">.</span>start<span class="op">;</span></span>
<span id="cb158-14"><a href="#cb158-14" aria-hidden="true" tabindex="-1"></a>    ObjectHeader <span class="op">*</span>prev <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb158-15"><a href="#cb158-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb158-16"><a href="#cb158-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">uint8_t</span> <span class="op">*</span>scan <span class="op">=</span> heap<span class="op">-&gt;</span>old_gen<span class="op">.</span>start<span class="op">;</span> </span>
<span id="cb158-17"><a href="#cb158-17" aria-hidden="true" tabindex="-1"></a>         scan <span class="op">&lt;</span> heap<span class="op">-&gt;</span>old_gen<span class="op">.</span>alloc_ptr<span class="op">;)</span> <span class="op">{</span></span>
<span id="cb158-18"><a href="#cb158-18" aria-hidden="true" tabindex="-1"></a>        ObjectHeader <span class="op">*</span>obj <span class="op">=</span> <span class="op">(</span>ObjectHeader<span class="op">*)</span>scan<span class="op">;</span></span>
<span id="cb158-19"><a href="#cb158-19" aria-hidden="true" tabindex="-1"></a>        <span class="dt">size_t</span> size <span class="op">=</span> object_size<span class="op">(</span>obj<span class="op">);</span></span>
<span id="cb158-20"><a href="#cb158-20" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb158-21"><a href="#cb158-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>is_marked<span class="op">(</span>gc<span class="op">-&gt;</span>mark_bits<span class="op">,</span> obj<span class="op">))</span> <span class="op">{</span></span>
<span id="cb158-22"><a href="#cb158-22" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>prev<span class="op">)</span> <span class="op">{</span></span>
<span id="cb158-23"><a href="#cb158-23" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Thread through first field</span></span>
<span id="cb158-24"><a href="#cb158-24" aria-hidden="true" tabindex="-1"></a>                <span class="op">*(</span><span class="dt">void</span><span class="op">**)</span>prev <span class="op">=</span> obj<span class="op">;</span></span>
<span id="cb158-25"><a href="#cb158-25" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb158-26"><a href="#cb158-26" aria-hidden="true" tabindex="-1"></a>            set_forwarding_address<span class="op">(</span>gc<span class="op">-&gt;</span>forwarding<span class="op">,</span> obj<span class="op">,</span> free<span class="op">);</span></span>
<span id="cb158-27"><a href="#cb158-27" aria-hidden="true" tabindex="-1"></a>            prev <span class="op">=</span> obj<span class="op">;</span></span>
<span id="cb158-28"><a href="#cb158-28" aria-hidden="true" tabindex="-1"></a>            free <span class="op">+=</span> size<span class="op">;</span></span>
<span id="cb158-29"><a href="#cb158-29" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb158-30"><a href="#cb158-30" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb158-31"><a href="#cb158-31" aria-hidden="true" tabindex="-1"></a>        scan <span class="op">+=</span> size<span class="op">;</span></span>
<span id="cb158-32"><a href="#cb158-32" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb158-33"><a href="#cb158-33" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3>13.7.2 Sliding Compaction</h3>
<p>For minimal auxiliary space:</p>
<div class="sourceCode" id="cb159"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb159-1"><a href="#cb159-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> sliding_compact<span class="op">(</span>CompactingCollector <span class="op">*</span>gc<span class="op">,</span> Heap <span class="op">*</span>heap<span class="op">)</span> <span class="op">{</span></span>
<span id="cb159-2"><a href="#cb159-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Compute break table</span></span>
<span id="cb159-3"><a href="#cb159-3" aria-hidden="true" tabindex="-1"></a>    BreakTable <span class="op">*</span>breaks <span class="op">=</span> compute_break_table<span class="op">(</span>gc<span class="op">,</span> heap<span class="op">);</span></span>
<span id="cb159-4"><a href="#cb159-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb159-5"><a href="#cb159-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Update references using break table</span></span>
<span id="cb159-6"><a href="#cb159-6" aria-hidden="true" tabindex="-1"></a>    update_with_breaks<span class="op">(</span>gc<span class="op">,</span> heap<span class="op">,</span> breaks<span class="op">);</span></span>
<span id="cb159-7"><a href="#cb159-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb159-8"><a href="#cb159-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Slide objects</span></span>
<span id="cb159-9"><a href="#cb159-9" aria-hidden="true" tabindex="-1"></a>    slide_objects<span class="op">(</span>gc<span class="op">,</span> heap<span class="op">,</span> breaks<span class="op">);</span></span>
<span id="cb159-10"><a href="#cb159-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>13.8 Large Object Handling</h2>
<h3>13.8.1 Non-Moving Large Objects</h3>
<div class="sourceCode" id="cb160"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">bool</span> should_move_large_object<span class="op">(</span>LargeObject <span class="op">*</span>obj<span class="op">,</span> GCStats <span class="op">*</span>stats<span class="op">)</span> <span class="op">{</span></span>
<span id="cb160-2"><a href="#cb160-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Don&#39;t move very large objects</span></span>
<span id="cb160-3"><a href="#cb160-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>obj<span class="op">-&gt;</span>size <span class="op">&gt;</span> LARGE_OBJECT_MOVE_THRESHOLD<span class="op">)</span></span>
<span id="cb160-4"><a href="#cb160-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb160-5"><a href="#cb160-5" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb160-6"><a href="#cb160-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Don&#39;t move if fragmentation is low</span></span>
<span id="cb160-7"><a href="#cb160-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>stats<span class="op">-&gt;</span>fragmentation_ratio <span class="op">&lt;</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span id="cb160-8"><a href="#cb160-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb160-9"><a href="#cb160-9" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb160-10"><a href="#cb160-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb160-11"><a href="#cb160-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb160-12"><a href="#cb160-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-13"><a href="#cb160-13" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> compact_large_objects<span class="op">(</span>CompactingCollector <span class="op">*</span>gc<span class="op">,</span> Heap <span class="op">*</span>heap<span class="op">)</span> <span class="op">{</span></span>
<span id="cb160-14"><a href="#cb160-14" aria-hidden="true" tabindex="-1"></a>    LargeObject <span class="op">*</span>current <span class="op">=</span> heap<span class="op">-&gt;</span>large_objects<span class="op">;</span></span>
<span id="cb160-15"><a href="#cb160-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb160-16"><a href="#cb160-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span>current<span class="op">)</span> <span class="op">{</span></span>
<span id="cb160-17"><a href="#cb160-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>is_marked<span class="op">(</span>gc<span class="op">-&gt;</span>mark_bits<span class="op">,</span> <span class="op">&amp;</span>current<span class="op">-&gt;</span>header<span class="op">)</span> <span class="op">&amp;&amp;</span></span>
<span id="cb160-18"><a href="#cb160-18" aria-hidden="true" tabindex="-1"></a>            should_move_large_object<span class="op">(</span>current<span class="op">,</span> <span class="op">&amp;</span>gc<span class="op">-&gt;</span>stats<span class="op">))</span> <span class="op">{</span></span>
<span id="cb160-19"><a href="#cb160-19" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Add to compaction set</span></span>
<span id="cb160-20"><a href="#cb160-20" aria-hidden="true" tabindex="-1"></a>            add_to_compaction_set<span class="op">(</span>gc<span class="op">,</span> current<span class="op">);</span></span>
<span id="cb160-21"><a href="#cb160-21" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb160-22"><a href="#cb160-22" aria-hidden="true" tabindex="-1"></a>        current <span class="op">=</span> current<span class="op">-&gt;</span>next<span class="op">;</span></span>
<span id="cb160-23"><a href="#cb160-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb160-24"><a href="#cb160-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>13.9 Concurrent Compaction Support</h2>
<h3>13.9.1 Read Barrier for Concurrent Compaction</h3>
<div class="sourceCode" id="cb161"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb161-1"><a href="#cb161-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="kw">inline</span> <span class="dt">void</span><span class="op">*</span> read_barrier<span class="op">(</span><span class="dt">void</span> <span class="op">*</span>ref<span class="op">)</span> <span class="op">{</span></span>
<span id="cb161-2"><a href="#cb161-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>in_forwarding_phase<span class="op">()</span> <span class="op">&amp;&amp;</span> is_forwarded<span class="op">(</span>ref<span class="op">))</span> <span class="op">{</span></span>
<span id="cb161-3"><a href="#cb161-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> get_forwarding_pointer<span class="op">(</span>ref<span class="op">);</span></span>
<span id="cb161-4"><a href="#cb161-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb161-5"><a href="#cb161-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ref<span class="op">;</span></span>
<span id="cb161-6"><a href="#cb161-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb161-7"><a href="#cb161-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-8"><a href="#cb161-8" aria-hidden="true" tabindex="-1"></a><span class="co">// Compiler inserts read barriers</span></span>
<span id="cb161-9"><a href="#cb161-9" aria-hidden="true" tabindex="-1"></a><span class="pp">#define LOAD_FIELD</span><span class="op">(</span><span class="pp">obj</span><span class="op">,</span><span class="pp"> field</span><span class="op">)</span><span class="pp"> </span><span class="op">\</span></span>
<span id="cb161-10"><a href="#cb161-10" aria-hidden="true" tabindex="-1"></a><span class="pp">    read_barrier</span><span class="op">((</span><span class="pp">obj</span><span class="op">)-&gt;</span><span class="pp">field</span><span class="op">)</span></span></code></pre></div>
<h3>13.9.2 Incremental Compaction</h3>
<div class="sourceCode" id="cb162"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> incremental_compact_step<span class="op">(</span>CompactingCollector <span class="op">*</span>gc<span class="op">,</span> </span>
<span id="cb162-2"><a href="#cb162-2" aria-hidden="true" tabindex="-1"></a>                                   <span class="dt">size_t</span> work_units<span class="op">)</span> <span class="op">{</span></span>
<span id="cb162-3"><a href="#cb162-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> units_done <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb162-4"><a href="#cb162-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb162-5"><a href="#cb162-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span>units_done <span class="op">&lt;</span> work_units <span class="op">&amp;&amp;</span> gc<span class="op">-&gt;</span>current_block <span class="op">&lt;</span> gc<span class="op">-&gt;</span>end_block<span class="op">)</span> <span class="op">{</span></span>
<span id="cb162-6"><a href="#cb162-6" aria-hidden="true" tabindex="-1"></a>        CompactionBlock <span class="op">*</span>block <span class="op">=</span> <span class="op">&amp;</span>gc<span class="op">-&gt;</span>blocks<span class="op">[</span>gc<span class="op">-&gt;</span>current_block<span class="op">];</span></span>
<span id="cb162-7"><a href="#cb162-7" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb162-8"><a href="#cb162-8" aria-hidden="true" tabindex="-1"></a>        compact_block<span class="op">(</span>gc<span class="op">,</span> block<span class="op">);</span></span>
<span id="cb162-9"><a href="#cb162-9" aria-hidden="true" tabindex="-1"></a>        update_block_references<span class="op">(</span>gc<span class="op">,</span> block<span class="op">);</span></span>
<span id="cb162-10"><a href="#cb162-10" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb162-11"><a href="#cb162-11" aria-hidden="true" tabindex="-1"></a>        units_done <span class="op">+=</span> block<span class="op">-&gt;</span>size <span class="op">/</span> WORK_UNIT_SIZE<span class="op">;</span></span>
<span id="cb162-12"><a href="#cb162-12" aria-hidden="true" tabindex="-1"></a>        gc<span class="op">-&gt;</span>current_block<span class="op">++;</span></span>
<span id="cb162-13"><a href="#cb162-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb162-14"><a href="#cb162-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>13.10 Performance Analysis</h2>
<h3>13.10.1 Fragmentation Metrics</h3>
<div class="sourceCode" id="cb163"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> FragmentationStats <span class="op">{</span></span>
<span id="cb163-2"><a href="#cb163-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> total_free_bytes<span class="op">;</span></span>
<span id="cb163-3"><a href="#cb163-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> largest_free_block<span class="op">;</span></span>
<span id="cb163-4"><a href="#cb163-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> free_block_count<span class="op">;</span></span>
<span id="cb163-5"><a href="#cb163-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> fragmentation_ratio<span class="op">;</span></span>
<span id="cb163-6"><a href="#cb163-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> FragmentationStats<span class="op">;</span></span>
<span id="cb163-7"><a href="#cb163-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-8"><a href="#cb163-8" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> measure_fragmentation<span class="op">(</span>Heap <span class="op">*</span>heap<span class="op">,</span> FragmentationStats <span class="op">*</span>stats<span class="op">)</span> <span class="op">{</span></span>
<span id="cb163-9"><a href="#cb163-9" aria-hidden="true" tabindex="-1"></a>    stats<span class="op">-&gt;</span>total_free_bytes <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb163-10"><a href="#cb163-10" aria-hidden="true" tabindex="-1"></a>    stats<span class="op">-&gt;</span>largest_free_block <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb163-11"><a href="#cb163-11" aria-hidden="true" tabindex="-1"></a>    stats<span class="op">-&gt;</span>free_block_count <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb163-12"><a href="#cb163-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb163-13"><a href="#cb163-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint8_t</span> <span class="op">*</span>scan <span class="op">=</span> heap<span class="op">-&gt;</span>old_gen<span class="op">.</span>start<span class="op">;</span></span>
<span id="cb163-14"><a href="#cb163-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span>scan <span class="op">&lt;</span> heap<span class="op">-&gt;</span>old_gen<span class="op">.</span>alloc_ptr<span class="op">)</span> <span class="op">{</span></span>
<span id="cb163-15"><a href="#cb163-15" aria-hidden="true" tabindex="-1"></a>        ObjectHeader <span class="op">*</span>obj <span class="op">=</span> <span class="op">(</span>ObjectHeader<span class="op">*)</span>scan<span class="op">;</span></span>
<span id="cb163-16"><a href="#cb163-16" aria-hidden="true" tabindex="-1"></a>        <span class="dt">size_t</span> size <span class="op">=</span> object_size<span class="op">(</span>obj<span class="op">);</span></span>
<span id="cb163-17"><a href="#cb163-17" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb163-18"><a href="#cb163-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(!</span>is_marked<span class="op">(</span>gc<span class="op">-&gt;</span>mark_bits<span class="op">,</span> obj<span class="op">))</span> <span class="op">{</span></span>
<span id="cb163-19"><a href="#cb163-19" aria-hidden="true" tabindex="-1"></a>            stats<span class="op">-&gt;</span>total_free_bytes <span class="op">+=</span> size<span class="op">;</span></span>
<span id="cb163-20"><a href="#cb163-20" aria-hidden="true" tabindex="-1"></a>            stats<span class="op">-&gt;</span>free_block_count<span class="op">++;</span></span>
<span id="cb163-21"><a href="#cb163-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>size <span class="op">&gt;</span> stats<span class="op">-&gt;</span>largest_free_block<span class="op">)</span> <span class="op">{</span></span>
<span id="cb163-22"><a href="#cb163-22" aria-hidden="true" tabindex="-1"></a>                stats<span class="op">-&gt;</span>largest_free_block <span class="op">=</span> size<span class="op">;</span></span>
<span id="cb163-23"><a href="#cb163-23" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb163-24"><a href="#cb163-24" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb163-25"><a href="#cb163-25" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb163-26"><a href="#cb163-26" aria-hidden="true" tabindex="-1"></a>        scan <span class="op">+=</span> size<span class="op">;</span></span>
<span id="cb163-27"><a href="#cb163-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb163-28"><a href="#cb163-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb163-29"><a href="#cb163-29" aria-hidden="true" tabindex="-1"></a>    stats<span class="op">-&gt;</span>fragmentation_ratio <span class="op">=</span> <span class="fl">1.0</span> <span class="op">-</span> </span>
<span id="cb163-30"><a href="#cb163-30" aria-hidden="true" tabindex="-1"></a>        <span class="op">((</span><span class="dt">double</span><span class="op">)</span>stats<span class="op">-&gt;</span>largest_free_block <span class="op">/</span> stats<span class="op">-&gt;</span>total_free_bytes<span class="op">);</span></span>
<span id="cb163-31"><a href="#cb163-31" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>13.11 Integration with VM</h2>
<h3>13.11.1 GC Triggers</h3>
<div class="sourceCode" id="cb164"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">bool</span> should_compact<span class="op">(</span>VM <span class="op">*</span>vm<span class="op">)</span> <span class="op">{</span></span>
<span id="cb164-2"><a href="#cb164-2" aria-hidden="true" tabindex="-1"></a>    Heap <span class="op">*</span>heap <span class="op">=</span> vm<span class="op">-&gt;</span>heap<span class="op">;</span></span>
<span id="cb164-3"><a href="#cb164-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb164-4"><a href="#cb164-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Compact if fragmentation exceeds threshold</span></span>
<span id="cb164-5"><a href="#cb164-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>heap<span class="op">-&gt;</span>fragmentation_ratio <span class="op">&gt;</span> FRAGMENTATION_THRESHOLD<span class="op">)</span></span>
<span id="cb164-6"><a href="#cb164-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb164-7"><a href="#cb164-7" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb164-8"><a href="#cb164-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Compact if allocation failures after mark-sweep</span></span>
<span id="cb164-9"><a href="#cb164-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>heap<span class="op">-&gt;</span>allocation_failures <span class="op">&gt;</span> ALLOCATION_FAILURE_THRESHOLD<span class="op">)</span></span>
<span id="cb164-10"><a href="#cb164-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb164-11"><a href="#cb164-11" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb164-12"><a href="#cb164-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Compact periodically</span></span>
<span id="cb164-13"><a href="#cb164-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>heap<span class="op">-&gt;</span>collections_since_compaction <span class="op">&gt;</span> COMPACTION_PERIOD<span class="op">)</span></span>
<span id="cb164-14"><a href="#cb164-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb164-15"><a href="#cb164-15" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb164-16"><a href="#cb164-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb164-17"><a href="#cb164-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3>13.11.2 Safe Points</h3>
<div class="sourceCode" id="cb165"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> vm_gc_safepoint<span class="op">(</span>VM <span class="op">*</span>vm<span class="op">)</span> <span class="op">{</span></span>
<span id="cb165-2"><a href="#cb165-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>vm<span class="op">-&gt;</span>gc_requested<span class="op">)</span> <span class="op">{</span></span>
<span id="cb165-3"><a href="#cb165-3" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Save registers</span></span>
<span id="cb165-4"><a href="#cb165-4" aria-hidden="true" tabindex="-1"></a>        save_thread_state<span class="op">(</span>vm<span class="op">-&gt;</span>current_coroutine<span class="op">);</span></span>
<span id="cb165-5"><a href="#cb165-5" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb165-6"><a href="#cb165-6" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Perform collection</span></span>
<span id="cb165-7"><a href="#cb165-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>should_compact<span class="op">(</span>vm<span class="op">))</span> <span class="op">{</span></span>
<span id="cb165-8"><a href="#cb165-8" aria-hidden="true" tabindex="-1"></a>            mark_and_compact<span class="op">(</span>vm<span class="op">-&gt;</span>gc<span class="op">,</span> vm<span class="op">);</span></span>
<span id="cb165-9"><a href="#cb165-9" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb165-10"><a href="#cb165-10" aria-hidden="true" tabindex="-1"></a>            mark_and_sweep<span class="op">(</span>vm<span class="op">-&gt;</span>gc<span class="op">,</span> vm<span class="op">);</span></span>
<span id="cb165-11"><a href="#cb165-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb165-12"><a href="#cb165-12" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb165-13"><a href="#cb165-13" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Resume execution</span></span>
<span id="cb165-14"><a href="#cb165-14" aria-hidden="true" tabindex="-1"></a>        restore_thread_state<span class="op">(</span>vm<span class="op">-&gt;</span>current_coroutine<span class="op">);</span></span>
<span id="cb165-15"><a href="#cb165-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb165-16"><a href="#cb165-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>13.12 Summary</h2>
<p>This chapter presented Diyrbal&#39;s mark-and-compact collector, which
provides:</p>
<ol type="1">
<li><strong>Fragmentation elimination</strong> through object
movement</li>
<li><strong>Spatial locality</strong> improvement via compaction</li>
<li><strong>Multiple algorithms</strong> (two-finger, threaded,
sliding)</li>
<li><strong>Large object</strong> special handling</li>
<li><strong>Incremental operation</strong> support</li>
<li><strong>Performance monitoring</strong> and adaptive triggers</li>
</ol>
<p>The collector integrates seamlessly with the memory architecture from
Chapter 12 and provides the foundation for efficient long-lived object
management. Next, Chapter 14 will explore concurrent and parallel
collection techniques that build upon this infrastructure. Based on the
trace compilation concepts from your materials and building on previous
chapters, here&#39;s Chapter 14 on Trace Detection and Recording:</p>
<h1>Chapter 14: Trace Detection and Recording</h1>
<h2>14.1 Introduction</h2>
<p>This chapter details Diyrbal&#39;s trace-based JIT compilation system,
focusing on hot trace detection and efficient recording mechanisms.
Building on the profiling infrastructure from earlier chapters, we
implement a system that identifies frequently executed code paths and
captures their runtime behavior for optimization.</p>
<h2>14.2 Trace Architecture Overview</h2>
<h3>14.2.1 Core Components</h3>
<div class="sourceCode" id="cb166"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb166-1"><a href="#cb166-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> TraceSystem <span class="op">{</span></span>
<span id="cb166-2"><a href="#cb166-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Detection</span></span>
<span id="cb166-3"><a href="#cb166-3" aria-hidden="true" tabindex="-1"></a>    HotspotDetector <span class="op">*</span>detector<span class="op">;</span></span>
<span id="cb166-4"><a href="#cb166-4" aria-hidden="true" tabindex="-1"></a>    LoopTable <span class="op">*</span>loop_headers<span class="op">;</span></span>
<span id="cb166-5"><a href="#cb166-5" aria-hidden="true" tabindex="-1"></a>    TraceCache <span class="op">*</span>trace_cache<span class="op">;</span></span>
<span id="cb166-6"><a href="#cb166-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb166-7"><a href="#cb166-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Recording</span></span>
<span id="cb166-8"><a href="#cb166-8" aria-hidden="true" tabindex="-1"></a>    TraceRecorder <span class="op">*</span>recorder<span class="op">;</span></span>
<span id="cb166-9"><a href="#cb166-9" aria-hidden="true" tabindex="-1"></a>    TraceBuffer <span class="op">*</span>buffer<span class="op">;</span></span>
<span id="cb166-10"><a href="#cb166-10" aria-hidden="true" tabindex="-1"></a>    GuardTable <span class="op">*</span>guards<span class="op">;</span></span>
<span id="cb166-11"><a href="#cb166-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb166-12"><a href="#cb166-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Statistics</span></span>
<span id="cb166-13"><a href="#cb166-13" aria-hidden="true" tabindex="-1"></a>    TraceStats stats<span class="op">;</span></span>
<span id="cb166-14"><a href="#cb166-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> max_trace_length<span class="op">;</span></span>
<span id="cb166-15"><a href="#cb166-15" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> max_recording_depth<span class="op">;</span></span>
<span id="cb166-16"><a href="#cb166-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> TraceSystem<span class="op">;</span></span>
<span id="cb166-17"><a href="#cb166-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-18"><a href="#cb166-18" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> Trace <span class="op">{</span></span>
<span id="cb166-19"><a href="#cb166-19" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> id<span class="op">;</span></span>
<span id="cb166-20"><a href="#cb166-20" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span>entry_pc<span class="op">;</span></span>
<span id="cb166-21"><a href="#cb166-21" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span>compiled_code<span class="op">;</span></span>
<span id="cb166-22"><a href="#cb166-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb166-23"><a href="#cb166-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Trace structure</span></span>
<span id="cb166-24"><a href="#cb166-24" aria-hidden="true" tabindex="-1"></a>    TraceInstruction <span class="op">*</span>instructions<span class="op">;</span></span>
<span id="cb166-25"><a href="#cb166-25" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> length<span class="op">;</span></span>
<span id="cb166-26"><a href="#cb166-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb166-27"><a href="#cb166-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Guards and assumptions</span></span>
<span id="cb166-28"><a href="#cb166-28" aria-hidden="true" tabindex="-1"></a>    GuardList <span class="op">*</span>guards<span class="op">;</span></span>
<span id="cb166-29"><a href="#cb166-29" aria-hidden="true" tabindex="-1"></a>    TypeProfile <span class="op">*</span>type_profile<span class="op">;</span></span>
<span id="cb166-30"><a href="#cb166-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb166-31"><a href="#cb166-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Execution statistics</span></span>
<span id="cb166-32"><a href="#cb166-32" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint64_t</span> execution_count<span class="op">;</span></span>
<span id="cb166-33"><a href="#cb166-33" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint64_t</span> exit_count<span class="op">[</span>MAX_SIDE_EXITS<span class="op">];</span></span>
<span id="cb166-34"><a href="#cb166-34" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> Trace<span class="op">;</span></span></code></pre></div>
<h2>14.3 Hotspot Detection</h2>
<h3>14.3.1 Loop Header Detection</h3>
<p>Drawing from the efficient trace compilation concepts:</p>
<div class="sourceCode" id="cb167"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb167-1"><a href="#cb167-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> LoopHeader <span class="op">{</span></span>
<span id="cb167-2"><a href="#cb167-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span>pc<span class="op">;</span></span>
<span id="cb167-3"><a href="#cb167-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> execution_count<span class="op">;</span></span>
<span id="cb167-4"><a href="#cb167-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> threshold<span class="op">;</span></span>
<span id="cb167-5"><a href="#cb167-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> recording<span class="op">;</span></span>
<span id="cb167-6"><a href="#cb167-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> LoopHeader <span class="op">*</span>next<span class="op">;</span></span>
<span id="cb167-7"><a href="#cb167-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> LoopHeader<span class="op">;</span></span>
<span id="cb167-8"><a href="#cb167-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-9"><a href="#cb167-9" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> detect_loop_header<span class="op">(</span>VM <span class="op">*</span>vm<span class="op">,</span> <span class="dt">void</span> <span class="op">*</span>pc<span class="op">)</span> <span class="op">{</span></span>
<span id="cb167-10"><a href="#cb167-10" aria-hidden="true" tabindex="-1"></a>    LoopHeader <span class="op">*</span>header <span class="op">=</span> lookup_loop_header<span class="op">(</span>vm<span class="op">-&gt;</span>trace_system<span class="op">-&gt;</span>loop_headers<span class="op">,</span> pc<span class="op">);</span></span>
<span id="cb167-11"><a href="#cb167-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb167-12"><a href="#cb167-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>header<span class="op">)</span> <span class="op">{</span></span>
<span id="cb167-13"><a href="#cb167-13" aria-hidden="true" tabindex="-1"></a>        <span class="co">// First backward branch to this location</span></span>
<span id="cb167-14"><a href="#cb167-14" aria-hidden="true" tabindex="-1"></a>        header <span class="op">=</span> create_loop_header<span class="op">(</span>pc<span class="op">);</span></span>
<span id="cb167-15"><a href="#cb167-15" aria-hidden="true" tabindex="-1"></a>        header<span class="op">-&gt;</span>threshold <span class="op">=</span> INITIAL_TRACE_THRESHOLD<span class="op">;</span></span>
<span id="cb167-16"><a href="#cb167-16" aria-hidden="true" tabindex="-1"></a>        insert_loop_header<span class="op">(</span>vm<span class="op">-&gt;</span>trace_system<span class="op">-&gt;</span>loop_headers<span class="op">,</span> header<span class="op">);</span></span>
<span id="cb167-17"><a href="#cb167-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb167-18"><a href="#cb167-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb167-19"><a href="#cb167-19" aria-hidden="true" tabindex="-1"></a>    header<span class="op">-&gt;</span>execution_count<span class="op">++;</span></span>
<span id="cb167-20"><a href="#cb167-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb167-21"><a href="#cb167-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>header<span class="op">-&gt;</span>execution_count <span class="op">&gt;=</span> header<span class="op">-&gt;</span>threshold <span class="op">&amp;&amp;</span> <span class="op">!</span>header<span class="op">-&gt;</span>recording<span class="op">)</span> <span class="op">{</span></span>
<span id="cb167-22"><a href="#cb167-22" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Start trace recording</span></span>
<span id="cb167-23"><a href="#cb167-23" aria-hidden="true" tabindex="-1"></a>        start_trace_recording<span class="op">(</span>vm<span class="op">,</span> pc<span class="op">);</span></span>
<span id="cb167-24"><a href="#cb167-24" aria-hidden="true" tabindex="-1"></a>        header<span class="op">-&gt;</span>recording <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb167-25"><a href="#cb167-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb167-26"><a href="#cb167-26" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3>14.3.2 Adaptive Thresholds</h3>
<div class="sourceCode" id="cb168"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb168-1"><a href="#cb168-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> adjust_trace_threshold<span class="op">(</span>LoopHeader <span class="op">*</span>header<span class="op">,</span> TraceExitReason reason<span class="op">)</span> <span class="op">{</span></span>
<span id="cb168-2"><a href="#cb168-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> <span class="op">(</span>reason<span class="op">)</span> <span class="op">{</span></span>
<span id="cb168-3"><a href="#cb168-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> EXIT_TRACE_COMPLETED<span class="op">:</span></span>
<span id="cb168-4"><a href="#cb168-4" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Successful trace - lower threshold for related traces</span></span>
<span id="cb168-5"><a href="#cb168-5" aria-hidden="true" tabindex="-1"></a>        header<span class="op">-&gt;</span>threshold <span class="op">=</span> max<span class="op">(</span>header<span class="op">-&gt;</span>threshold <span class="op">/</span> <span class="dv">2</span><span class="op">,</span> MIN_THRESHOLD<span class="op">);</span></span>
<span id="cb168-6"><a href="#cb168-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb168-7"><a href="#cb168-7" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb168-8"><a href="#cb168-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> EXIT_TRACE_ABORTED<span class="op">:</span></span>
<span id="cb168-9"><a href="#cb168-9" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Failed trace - increase threshold</span></span>
<span id="cb168-10"><a href="#cb168-10" aria-hidden="true" tabindex="-1"></a>        header<span class="op">-&gt;</span>threshold <span class="op">=</span> min<span class="op">(</span>header<span class="op">-&gt;</span>threshold <span class="op">*</span> <span class="dv">2</span><span class="op">,</span> MAX_THRESHOLD<span class="op">);</span></span>
<span id="cb168-11"><a href="#cb168-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb168-12"><a href="#cb168-12" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb168-13"><a href="#cb168-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> EXIT_NESTED_TRACE<span class="op">:</span></span>
<span id="cb168-14"><a href="#cb168-14" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Nested trace detected - adjust moderately</span></span>
<span id="cb168-15"><a href="#cb168-15" aria-hidden="true" tabindex="-1"></a>        header<span class="op">-&gt;</span>threshold <span class="op">=</span> <span class="op">(</span>header<span class="op">-&gt;</span>threshold <span class="op">*</span> <span class="dv">3</span><span class="op">)</span> <span class="op">/</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb168-16"><a href="#cb168-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb168-17"><a href="#cb168-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb168-18"><a href="#cb168-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>14.4 Trace Recording</h2>
<h3>14.4.1 Recording State</h3>
<div class="sourceCode" id="cb169"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb169-1"><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> TraceRecorder <span class="op">{</span></span>
<span id="cb169-2"><a href="#cb169-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Recording state</span></span>
<span id="cb169-3"><a href="#cb169-3" aria-hidden="true" tabindex="-1"></a>    RecorderState state<span class="op">;</span></span>
<span id="cb169-4"><a href="#cb169-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span>anchor_pc<span class="op">;</span>  <span class="co">// Loop header</span></span>
<span id="cb169-5"><a href="#cb169-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb169-6"><a href="#cb169-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Instruction buffer</span></span>
<span id="cb169-7"><a href="#cb169-7" aria-hidden="true" tabindex="-1"></a>    TraceInstruction <span class="op">*</span>buffer<span class="op">;</span></span>
<span id="cb169-8"><a href="#cb169-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> buffer_size<span class="op">;</span></span>
<span id="cb169-9"><a href="#cb169-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> current_index<span class="op">;</span></span>
<span id="cb169-10"><a href="#cb169-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb169-11"><a href="#cb169-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Value tracking</span></span>
<span id="cb169-12"><a href="#cb169-12" aria-hidden="true" tabindex="-1"></a>    HashMap <span class="op">*</span>value_map<span class="op">;</span>  <span class="co">// SSA value -&gt; recorded value</span></span>
<span id="cb169-13"><a href="#cb169-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> next_value_id<span class="op">;</span></span>
<span id="cb169-14"><a href="#cb169-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb169-15"><a href="#cb169-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Guard collection</span></span>
<span id="cb169-16"><a href="#cb169-16" aria-hidden="true" tabindex="-1"></a>    GuardList <span class="op">*</span>guards<span class="op">;</span></span>
<span id="cb169-17"><a href="#cb169-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb169-18"><a href="#cb169-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Nested trace handling</span></span>
<span id="cb169-19"><a href="#cb169-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> TraceRecorder <span class="op">*</span>parent<span class="op">;</span></span>
<span id="cb169-20"><a href="#cb169-20" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> nesting_depth<span class="op">;</span></span>
<span id="cb169-21"><a href="#cb169-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> TraceRecorder<span class="op">;</span></span>
<span id="cb169-22"><a href="#cb169-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-23"><a href="#cb169-23" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">enum</span> <span class="op">{</span></span>
<span id="cb169-24"><a href="#cb169-24" aria-hidden="true" tabindex="-1"></a>    RECORDER_IDLE<span class="op">,</span></span>
<span id="cb169-25"><a href="#cb169-25" aria-hidden="true" tabindex="-1"></a>    RECORDER_RECORDING<span class="op">,</span></span>
<span id="cb169-26"><a href="#cb169-26" aria-hidden="true" tabindex="-1"></a>    RECORDER_ABORTED<span class="op">,</span></span>
<span id="cb169-27"><a href="#cb169-27" aria-hidden="true" tabindex="-1"></a>    RECORDER_COMPLETED</span>
<span id="cb169-28"><a href="#cb169-28" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> RecorderState<span class="op">;</span></span></code></pre></div>
<h3>14.4.2 Instruction Recording</h3>
<div class="sourceCode" id="cb170"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb170-1"><a href="#cb170-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> record_instruction<span class="op">(</span>TraceRecorder <span class="op">*</span>recorder<span class="op">,</span> </span>
<span id="cb170-2"><a href="#cb170-2" aria-hidden="true" tabindex="-1"></a>                              VMInstruction <span class="op">*</span>inst<span class="op">,</span></span>
<span id="cb170-3"><a href="#cb170-3" aria-hidden="true" tabindex="-1"></a>                              ExecutionContext <span class="op">*</span>ctx<span class="op">)</span> <span class="op">{</span></span>
<span id="cb170-4"><a href="#cb170-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>recorder<span class="op">-&gt;</span>current_index <span class="op">&gt;=</span> recorder<span class="op">-&gt;</span>buffer_size<span class="op">)</span> <span class="op">{</span></span>
<span id="cb170-5"><a href="#cb170-5" aria-hidden="true" tabindex="-1"></a>        abort_recording<span class="op">(</span>recorder<span class="op">,</span> TRACE_TOO_LONG<span class="op">);</span></span>
<span id="cb170-6"><a href="#cb170-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span><span class="op">;</span></span>
<span id="cb170-7"><a href="#cb170-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb170-8"><a href="#cb170-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb170-9"><a href="#cb170-9" aria-hidden="true" tabindex="-1"></a>    TraceInstruction <span class="op">*</span>trace_inst <span class="op">=</span> <span class="op">&amp;</span>recorder<span class="op">-&gt;</span>buffer<span class="op">[</span>recorder<span class="op">-&gt;</span>current_index<span class="op">++];</span></span>
<span id="cb170-10"><a href="#cb170-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb170-11"><a href="#cb170-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Record instruction</span></span>
<span id="cb170-12"><a href="#cb170-12" aria-hidden="true" tabindex="-1"></a>    trace_inst<span class="op">-&gt;</span>opcode <span class="op">=</span> inst<span class="op">-&gt;</span>opcode<span class="op">;</span></span>
<span id="cb170-13"><a href="#cb170-13" aria-hidden="true" tabindex="-1"></a>    trace_inst<span class="op">-&gt;</span>pc <span class="op">=</span> inst<span class="op">-&gt;</span>pc<span class="op">;</span></span>
<span id="cb170-14"><a href="#cb170-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb170-15"><a href="#cb170-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Record operand values and types</span></span>
<span id="cb170-16"><a href="#cb170-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> inst<span class="op">-&gt;</span>num_operands<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb170-17"><a href="#cb170-17" aria-hidden="true" tabindex="-1"></a>        Value <span class="op">*</span>val <span class="op">=</span> <span class="op">&amp;</span>ctx<span class="op">-&gt;</span>stack<span class="op">[</span>ctx<span class="op">-&gt;</span>sp <span class="op">-</span> inst<span class="op">-&gt;</span>num_operands <span class="op">+</span> i<span class="op">];</span></span>
<span id="cb170-18"><a href="#cb170-18" aria-hidden="true" tabindex="-1"></a>        trace_inst<span class="op">-&gt;</span>operands<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> record_value<span class="op">(</span>recorder<span class="op">,</span> val<span class="op">);</span></span>
<span id="cb170-19"><a href="#cb170-19" aria-hidden="true" tabindex="-1"></a>        trace_inst<span class="op">-&gt;</span>operand_types<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> val<span class="op">-&gt;</span>type<span class="op">;</span></span>
<span id="cb170-20"><a href="#cb170-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb170-21"><a href="#cb170-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb170-22"><a href="#cb170-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Add type guards if needed</span></span>
<span id="cb170-23"><a href="#cb170-23" aria-hidden="true" tabindex="-1"></a>    add_type_guards<span class="op">(</span>recorder<span class="op">,</span> trace_inst<span class="op">,</span> ctx<span class="op">);</span></span>
<span id="cb170-24"><a href="#cb170-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb170-25"><a href="#cb170-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb170-26"><a href="#cb170-26" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> TraceValue record_value<span class="op">(</span>TraceRecorder <span class="op">*</span>recorder<span class="op">,</span> Value <span class="op">*</span>val<span class="op">)</span> <span class="op">{</span></span>
<span id="cb170-27"><a href="#cb170-27" aria-hidden="true" tabindex="-1"></a>    TraceValue tv<span class="op">;</span></span>
<span id="cb170-28"><a href="#cb170-28" aria-hidden="true" tabindex="-1"></a>    tv<span class="op">.</span>id <span class="op">=</span> recorder<span class="op">-&gt;</span>next_value_id<span class="op">++;</span></span>
<span id="cb170-29"><a href="#cb170-29" aria-hidden="true" tabindex="-1"></a>    tv<span class="op">.</span>type <span class="op">=</span> val<span class="op">-&gt;</span>type<span class="op">;</span></span>
<span id="cb170-30"><a href="#cb170-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb170-31"><a href="#cb170-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>val<span class="op">-&gt;</span>type <span class="op">==</span> VALUE_INT<span class="op">)</span> <span class="op">{</span></span>
<span id="cb170-32"><a href="#cb170-32" aria-hidden="true" tabindex="-1"></a>        tv<span class="op">.</span>constant <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb170-33"><a href="#cb170-33" aria-hidden="true" tabindex="-1"></a>        tv<span class="op">.</span>int_value <span class="op">=</span> val<span class="op">-&gt;</span>int_value<span class="op">;</span></span>
<span id="cb170-34"><a href="#cb170-34" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>val<span class="op">-&gt;</span>type <span class="op">==</span> VALUE_OBJECT<span class="op">)</span> <span class="op">{</span></span>
<span id="cb170-35"><a href="#cb170-35" aria-hidden="true" tabindex="-1"></a>        tv<span class="op">.</span>constant <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb170-36"><a href="#cb170-36" aria-hidden="true" tabindex="-1"></a>        tv<span class="op">.</span>object_type <span class="op">=</span> get_object_type<span class="op">(</span>val<span class="op">-&gt;</span>obj<span class="op">);</span></span>
<span id="cb170-37"><a href="#cb170-37" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Record object shape for optimization</span></span>
<span id="cb170-38"><a href="#cb170-38" aria-hidden="true" tabindex="-1"></a>        tv<span class="op">.</span>shape_id <span class="op">=</span> get_object_shape<span class="op">(</span>val<span class="op">-&gt;</span>obj<span class="op">);</span></span>
<span id="cb170-39"><a href="#cb170-39" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb170-40"><a href="#cb170-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb170-41"><a href="#cb170-41" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Track value in SSA form</span></span>
<span id="cb170-42"><a href="#cb170-42" aria-hidden="true" tabindex="-1"></a>    hash_map_insert<span class="op">(</span>recorder<span class="op">-&gt;</span>value_map<span class="op">,</span> val<span class="op">,</span> tv<span class="op">);</span></span>
<span id="cb170-43"><a href="#cb170-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb170-44"><a href="#cb170-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tv<span class="op">;</span></span>
<span id="cb170-45"><a href="#cb170-45" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>14.5 Control Flow Recording</h2>
<h3>14.5.1 Branch Recording</h3>
<div class="sourceCode" id="cb171"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb171-1"><a href="#cb171-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> record_branch<span class="op">(</span>TraceRecorder <span class="op">*</span>recorder<span class="op">,</span> </span>
<span id="cb171-2"><a href="#cb171-2" aria-hidden="true" tabindex="-1"></a>                         BranchInstruction <span class="op">*</span>branch<span class="op">,</span></span>
<span id="cb171-3"><a href="#cb171-3" aria-hidden="true" tabindex="-1"></a>                         <span class="dt">bool</span> taken<span class="op">)</span> <span class="op">{</span></span>
<span id="cb171-4"><a href="#cb171-4" aria-hidden="true" tabindex="-1"></a>    TraceInstruction <span class="op">*</span>trace_inst <span class="op">=</span> allocate_trace_instruction<span class="op">(</span>recorder<span class="op">);</span></span>
<span id="cb171-5"><a href="#cb171-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb171-6"><a href="#cb171-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>taken <span class="op">&amp;&amp;</span> branch<span class="op">-&gt;</span>target <span class="op">==</span> recorder<span class="op">-&gt;</span>anchor_pc<span class="op">)</span> <span class="op">{</span></span>
<span id="cb171-7"><a href="#cb171-7" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Loop closing branch</span></span>
<span id="cb171-8"><a href="#cb171-8" aria-hidden="true" tabindex="-1"></a>        complete_trace_recording<span class="op">(</span>recorder<span class="op">);</span></span>
<span id="cb171-9"><a href="#cb171-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span><span class="op">;</span></span>
<span id="cb171-10"><a href="#cb171-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb171-11"><a href="#cb171-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb171-12"><a href="#cb171-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Record as guard</span></span>
<span id="cb171-13"><a href="#cb171-13" aria-hidden="true" tabindex="-1"></a>    Guard <span class="op">*</span>guard <span class="op">=</span> create_branch_guard<span class="op">(</span>branch<span class="op">,</span> taken<span class="op">);</span></span>
<span id="cb171-14"><a href="#cb171-14" aria-hidden="true" tabindex="-1"></a>    add_guard<span class="op">(</span>recorder<span class="op">-&gt;</span>guards<span class="op">,</span> guard<span class="op">);</span></span>
<span id="cb171-15"><a href="#cb171-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb171-16"><a href="#cb171-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Record branch for trace</span></span>
<span id="cb171-17"><a href="#cb171-17" aria-hidden="true" tabindex="-1"></a>    trace_inst<span class="op">-&gt;</span>opcode <span class="op">=</span> taken <span class="op">?</span> OP_GUARD_TRUE <span class="op">:</span> OP_GUARD_FALSE<span class="op">;</span></span>
<span id="cb171-18"><a href="#cb171-18" aria-hidden="true" tabindex="-1"></a>    trace_inst<span class="op">-&gt;</span>guard_id <span class="op">=</span> guard<span class="op">-&gt;</span>id<span class="op">;</span></span>
<span id="cb171-19"><a href="#cb171-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3>14.5.2 Call Recording</h3>
<div class="sourceCode" id="cb172"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb172-1"><a href="#cb172-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> record_call<span class="op">(</span>TraceRecorder <span class="op">*</span>recorder<span class="op">,</span></span>
<span id="cb172-2"><a href="#cb172-2" aria-hidden="true" tabindex="-1"></a>                       CallInstruction <span class="op">*</span>call<span class="op">,</span></span>
<span id="cb172-3"><a href="#cb172-3" aria-hidden="true" tabindex="-1"></a>                       Method <span class="op">*</span>target<span class="op">)</span> <span class="op">{</span></span>
<span id="cb172-4"><a href="#cb172-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check for recursive calls</span></span>
<span id="cb172-5"><a href="#cb172-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>is_recursive_call<span class="op">(</span>recorder<span class="op">,</span> target<span class="op">))</span> <span class="op">{</span></span>
<span id="cb172-6"><a href="#cb172-6" aria-hidden="true" tabindex="-1"></a>        abort_recording<span class="op">(</span>recorder<span class="op">,</span> RECURSIVE_CALL<span class="op">);</span></span>
<span id="cb172-7"><a href="#cb172-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span><span class="op">;</span></span>
<span id="cb172-8"><a href="#cb172-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb172-9"><a href="#cb172-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb172-10"><a href="#cb172-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Decide on inlining</span></span>
<span id="cb172-11"><a href="#cb172-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>should_inline_in_trace<span class="op">(</span>target<span class="op">))</span> <span class="op">{</span></span>
<span id="cb172-12"><a href="#cb172-12" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Record entry guard</span></span>
<span id="cb172-13"><a href="#cb172-13" aria-hidden="true" tabindex="-1"></a>        Guard <span class="op">*</span>guard <span class="op">=</span> create_method_guard<span class="op">(</span>call<span class="op">-&gt;</span>receiver_type<span class="op">,</span> target<span class="op">);</span></span>
<span id="cb172-14"><a href="#cb172-14" aria-hidden="true" tabindex="-1"></a>        add_guard<span class="op">(</span>recorder<span class="op">-&gt;</span>guards<span class="op">,</span> guard<span class="op">);</span></span>
<span id="cb172-15"><a href="#cb172-15" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb172-16"><a href="#cb172-16" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Continue recording into called method</span></span>
<span id="cb172-17"><a href="#cb172-17" aria-hidden="true" tabindex="-1"></a>        recorder<span class="op">-&gt;</span>inline_depth<span class="op">++;</span></span>
<span id="cb172-18"><a href="#cb172-18" aria-hidden="true" tabindex="-1"></a>        record_inline_entry<span class="op">(</span>recorder<span class="op">,</span> target<span class="op">);</span></span>
<span id="cb172-19"><a href="#cb172-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb172-20"><a href="#cb172-20" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Record as call</span></span>
<span id="cb172-21"><a href="#cb172-21" aria-hidden="true" tabindex="-1"></a>        record_trace_call<span class="op">(</span>recorder<span class="op">,</span> call<span class="op">,</span> target<span class="op">);</span></span>
<span id="cb172-22"><a href="#cb172-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb172-23"><a href="#cb172-23" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb172-24"><a href="#cb172-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-25"><a href="#cb172-25" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">bool</span> should_inline_in_trace<span class="op">(</span>Method <span class="op">*</span>method<span class="op">)</span> <span class="op">{</span></span>
<span id="cb172-26"><a href="#cb172-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> method<span class="op">-&gt;</span>bytecode_size <span class="op">&lt;</span> TRACE_INLINE_THRESHOLD <span class="op">&amp;&amp;</span></span>
<span id="cb172-27"><a href="#cb172-27" aria-hidden="true" tabindex="-1"></a>           <span class="op">!</span>method<span class="op">-&gt;</span>has_loops <span class="op">&amp;&amp;</span></span>
<span id="cb172-28"><a href="#cb172-28" aria-hidden="true" tabindex="-1"></a>           method<span class="op">-&gt;</span>is_leaf<span class="op">;</span></span>
<span id="cb172-29"><a href="#cb172-29" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>14.6 Guard Management</h2>
<h3>14.6.1 Guard Types</h3>
<div class="sourceCode" id="cb173"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb173-1"><a href="#cb173-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">enum</span> <span class="op">{</span></span>
<span id="cb173-2"><a href="#cb173-2" aria-hidden="true" tabindex="-1"></a>    GUARD_TYPE<span class="op">,</span>      <span class="co">// Type check</span></span>
<span id="cb173-3"><a href="#cb173-3" aria-hidden="true" tabindex="-1"></a>    GUARD_CLASS<span class="op">,</span>     <span class="co">// Exact class check</span></span>
<span id="cb173-4"><a href="#cb173-4" aria-hidden="true" tabindex="-1"></a>    GUARD_SHAPE<span class="op">,</span>     <span class="co">// Object shape/layout</span></span>
<span id="cb173-5"><a href="#cb173-5" aria-hidden="true" tabindex="-1"></a>    GUARD_OVERFLOW<span class="op">,</span>  <span class="co">// Arithmetic overflow</span></span>
<span id="cb173-6"><a href="#cb173-6" aria-hidden="true" tabindex="-1"></a>    GUARD_BOUNDS<span class="op">,</span>    <span class="co">// Array bounds</span></span>
<span id="cb173-7"><a href="#cb173-7" aria-hidden="true" tabindex="-1"></a>    GUARD_NULL<span class="op">,</span>      <span class="co">// Null check</span></span>
<span id="cb173-8"><a href="#cb173-8" aria-hidden="true" tabindex="-1"></a>    GUARD_VALUE      <span class="co">// Constant value</span></span>
<span id="cb173-9"><a href="#cb173-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> GuardType<span class="op">;</span></span>
<span id="cb173-10"><a href="#cb173-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-11"><a href="#cb173-11" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> Guard <span class="op">{</span></span>
<span id="cb173-12"><a href="#cb173-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> id<span class="op">;</span></span>
<span id="cb173-13"><a href="#cb173-13" aria-hidden="true" tabindex="-1"></a>    GuardType type<span class="op">;</span></span>
<span id="cb173-14"><a href="#cb173-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb173-15"><a href="#cb173-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">union</span> <span class="op">{</span></span>
<span id="cb173-16"><a href="#cb173-16" aria-hidden="true" tabindex="-1"></a>        <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb173-17"><a href="#cb173-17" aria-hidden="true" tabindex="-1"></a>            <span class="dt">uint32_t</span> value_id<span class="op">;</span></span>
<span id="cb173-18"><a href="#cb173-18" aria-hidden="true" tabindex="-1"></a>            TypeID expected_type<span class="op">;</span></span>
<span id="cb173-19"><a href="#cb173-19" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> type_guard<span class="op">;</span></span>
<span id="cb173-20"><a href="#cb173-20" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb173-21"><a href="#cb173-21" aria-hidden="true" tabindex="-1"></a>        <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb173-22"><a href="#cb173-22" aria-hidden="true" tabindex="-1"></a>            <span class="dt">uint32_t</span> value_id<span class="op">;</span></span>
<span id="cb173-23"><a href="#cb173-23" aria-hidden="true" tabindex="-1"></a>            <span class="dt">int64_t</span> expected_value<span class="op">;</span></span>
<span id="cb173-24"><a href="#cb173-24" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> value_guard<span class="op">;</span></span>
<span id="cb173-25"><a href="#cb173-25" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb173-26"><a href="#cb173-26" aria-hidden="true" tabindex="-1"></a>        <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb173-27"><a href="#cb173-27" aria-hidden="true" tabindex="-1"></a>            <span class="dt">uint32_t</span> array_id<span class="op">;</span></span>
<span id="cb173-28"><a href="#cb173-28" aria-hidden="true" tabindex="-1"></a>            <span class="dt">uint32_t</span> index_id<span class="op">;</span></span>
<span id="cb173-29"><a href="#cb173-29" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> bounds_guard<span class="op">;</span></span>
<span id="cb173-30"><a href="#cb173-30" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> data<span class="op">;</span></span>
<span id="cb173-31"><a href="#cb173-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb173-32"><a href="#cb173-32" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span>fallback_pc<span class="op">;</span>  <span class="co">// Side exit target</span></span>
<span id="cb173-33"><a href="#cb173-33" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> failure_count<span class="op">;</span></span>
<span id="cb173-34"><a href="#cb173-34" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> Guard<span class="op">;</span></span></code></pre></div>
<h3>14.6.2 Guard Optimization</h3>
<div class="sourceCode" id="cb174"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb174-1"><a href="#cb174-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> optimize_guards<span class="op">(</span>TraceRecorder <span class="op">*</span>recorder<span class="op">)</span> <span class="op">{</span></span>
<span id="cb174-2"><a href="#cb174-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Remove redundant guards</span></span>
<span id="cb174-3"><a href="#cb174-3" aria-hidden="true" tabindex="-1"></a>    eliminate_redundant_guards<span class="op">(</span>recorder<span class="op">-&gt;</span>guards<span class="op">);</span></span>
<span id="cb174-4"><a href="#cb174-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb174-5"><a href="#cb174-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Hoist guards where beneficial</span></span>
<span id="cb174-6"><a href="#cb174-6" aria-hidden="true" tabindex="-1"></a>    hoist_loop_invariant_guards<span class="op">(</span>recorder<span class="op">);</span></span>
<span id="cb174-7"><a href="#cb174-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb174-8"><a href="#cb174-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Strengthen guards based on profiling</span></span>
<span id="cb174-9"><a href="#cb174-9" aria-hidden="true" tabindex="-1"></a>    strengthen_guards_from_profile<span class="op">(</span>recorder<span class="op">);</span></span>
<span id="cb174-10"><a href="#cb174-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb174-11"><a href="#cb174-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-12"><a href="#cb174-12" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> eliminate_redundant_guards<span class="op">(</span>GuardList <span class="op">*</span>guards<span class="op">)</span> <span class="op">{</span></span>
<span id="cb174-13"><a href="#cb174-13" aria-hidden="true" tabindex="-1"></a>    HashMap <span class="op">*</span>known_types <span class="op">=</span> hash_map_create<span class="op">();</span></span>
<span id="cb174-14"><a href="#cb174-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb174-15"><a href="#cb174-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>Guard <span class="op">*</span>g <span class="op">=</span> guards<span class="op">-&gt;</span>head<span class="op">;</span> g<span class="op">;</span> g <span class="op">=</span> g<span class="op">-&gt;</span>next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb174-16"><a href="#cb174-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>g<span class="op">-&gt;</span>type <span class="op">==</span> GUARD_TYPE<span class="op">)</span> <span class="op">{</span></span>
<span id="cb174-17"><a href="#cb174-17" aria-hidden="true" tabindex="-1"></a>            TypeID <span class="op">*</span>known <span class="op">=</span> hash_map_get<span class="op">(</span>known_types<span class="op">,</span> g<span class="op">-&gt;</span>data<span class="op">.</span>type_guard<span class="op">.</span>value_id<span class="op">);</span></span>
<span id="cb174-18"><a href="#cb174-18" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>known <span class="op">&amp;&amp;</span> <span class="op">*</span>known <span class="op">==</span> g<span class="op">-&gt;</span>data<span class="op">.</span>type_guard<span class="op">.</span>expected_type<span class="op">)</span> <span class="op">{</span></span>
<span id="cb174-19"><a href="#cb174-19" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Guard is redundant</span></span>
<span id="cb174-20"><a href="#cb174-20" aria-hidden="true" tabindex="-1"></a>                mark_guard_eliminated<span class="op">(</span>g<span class="op">);</span></span>
<span id="cb174-21"><a href="#cb174-21" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb174-22"><a href="#cb174-22" aria-hidden="true" tabindex="-1"></a>                hash_map_insert<span class="op">(</span>known_types<span class="op">,</span> </span>
<span id="cb174-23"><a href="#cb174-23" aria-hidden="true" tabindex="-1"></a>                              g<span class="op">-&gt;</span>data<span class="op">.</span>type_guard<span class="op">.</span>value_id<span class="op">,</span></span>
<span id="cb174-24"><a href="#cb174-24" aria-hidden="true" tabindex="-1"></a>                              g<span class="op">-&gt;</span>data<span class="op">.</span>type_guard<span class="op">.</span>expected_type<span class="op">);</span></span>
<span id="cb174-25"><a href="#cb174-25" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb174-26"><a href="#cb174-26" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb174-27"><a href="#cb174-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb174-28"><a href="#cb174-28" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>14.7 Side Exit Handling</h2>
<h3>14.7.1 Side Exit Recording</h3>
<div class="sourceCode" id="cb175"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb175-1"><a href="#cb175-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> SideExit <span class="op">{</span></span>
<span id="cb175-2"><a href="#cb175-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> guard_id<span class="op">;</span></span>
<span id="cb175-3"><a href="#cb175-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span>native_pc<span class="op">;</span>  <span class="co">// Location in compiled code</span></span>
<span id="cb175-4"><a href="#cb175-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span>bytecode_pc<span class="op">;</span>  <span class="co">// Resume point</span></span>
<span id="cb175-5"><a href="#cb175-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb175-6"><a href="#cb175-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Deoptimization info</span></span>
<span id="cb175-7"><a href="#cb175-7" aria-hidden="true" tabindex="-1"></a>    FrameState <span class="op">*</span>frame_state<span class="op">;</span></span>
<span id="cb175-8"><a href="#cb175-8" aria-hidden="true" tabindex="-1"></a>    ValueLocation <span class="op">*</span>live_values<span class="op">;</span></span>
<span id="cb175-9"><a href="#cb175-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb175-10"><a href="#cb175-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Statistics</span></span>
<span id="cb175-11"><a href="#cb175-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint64_t</span> taken_count<span class="op">;</span></span>
<span id="cb175-12"><a href="#cb175-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> compilation_triggered<span class="op">;</span></span>
<span id="cb175-13"><a href="#cb175-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> SideExit<span class="op">;</span></span>
<span id="cb175-14"><a href="#cb175-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-15"><a href="#cb175-15" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> record_side_exit<span class="op">(</span>TraceRecorder <span class="op">*</span>recorder<span class="op">,</span> Guard <span class="op">*</span>guard<span class="op">)</span> <span class="op">{</span></span>
<span id="cb175-16"><a href="#cb175-16" aria-hidden="true" tabindex="-1"></a>    SideExit <span class="op">*</span>exit <span class="op">=</span> allocate_side_exit<span class="op">();</span></span>
<span id="cb175-17"><a href="#cb175-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb175-18"><a href="#cb175-18" aria-hidden="true" tabindex="-1"></a>    exit<span class="op">-&gt;</span>guard_id <span class="op">=</span> guard<span class="op">-&gt;</span>id<span class="op">;</span></span>
<span id="cb175-19"><a href="#cb175-19" aria-hidden="true" tabindex="-1"></a>    exit<span class="op">-&gt;</span>bytecode_pc <span class="op">=</span> guard<span class="op">-&gt;</span>fallback_pc<span class="op">;</span></span>
<span id="cb175-20"><a href="#cb175-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb175-21"><a href="#cb175-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Capture frame state for deoptimization</span></span>
<span id="cb175-22"><a href="#cb175-22" aria-hidden="true" tabindex="-1"></a>    exit<span class="op">-&gt;</span>frame_state <span class="op">=</span> capture_frame_state<span class="op">(</span>recorder<span class="op">);</span></span>
<span id="cb175-23"><a href="#cb175-23" aria-hidden="true" tabindex="-1"></a>    exit<span class="op">-&gt;</span>live_values <span class="op">=</span> capture_live_values<span class="op">(</span>recorder<span class="op">);</span></span>
<span id="cb175-24"><a href="#cb175-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb175-25"><a href="#cb175-25" aria-hidden="true" tabindex="-1"></a>    add_side_exit<span class="op">(</span>recorder<span class="op">-&gt;</span>current_trace<span class="op">,</span> exit<span class="op">);</span></span>
<span id="cb175-26"><a href="#cb175-26" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3>14.7.2 Exit Frequency Tracking</h3>
<div class="sourceCode" id="cb176"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb176-1"><a href="#cb176-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> handle_side_exit<span class="op">(</span>VM <span class="op">*</span>vm<span class="op">,</span> SideExit <span class="op">*</span>exit<span class="op">)</span> <span class="op">{</span></span>
<span id="cb176-2"><a href="#cb176-2" aria-hidden="true" tabindex="-1"></a>    exit<span class="op">-&gt;</span>taken_count<span class="op">++;</span></span>
<span id="cb176-3"><a href="#cb176-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb176-4"><a href="#cb176-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>exit<span class="op">-&gt;</span>taken_count <span class="op">&gt;</span> SIDE_EXIT_THRESHOLD <span class="op">&amp;&amp;</span> </span>
<span id="cb176-5"><a href="#cb176-5" aria-hidden="true" tabindex="-1"></a>        <span class="op">!</span>exit<span class="op">-&gt;</span>compilation_triggered<span class="op">)</span> <span class="op">{</span></span>
<span id="cb176-6"><a href="#cb176-6" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Trigger trace extension or new trace</span></span>
<span id="cb176-7"><a href="#cb176-7" aria-hidden="true" tabindex="-1"></a>        trigger_trace_from_side_exit<span class="op">(</span>vm<span class="op">,</span> exit<span class="op">);</span></span>
<span id="cb176-8"><a href="#cb176-8" aria-hidden="true" tabindex="-1"></a>        exit<span class="op">-&gt;</span>compilation_triggered <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb176-9"><a href="#cb176-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb176-10"><a href="#cb176-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb176-11"><a href="#cb176-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Deoptimize and resume interpretation</span></span>
<span id="cb176-12"><a href="#cb176-12" aria-hidden="true" tabindex="-1"></a>    deoptimize_from_exit<span class="op">(</span>vm<span class="op">,</span> exit<span class="op">);</span></span>
<span id="cb176-13"><a href="#cb176-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>14.8 Trace Completion</h2>
<h3>14.8.1 Trace Validation</h3>
<div class="sourceCode" id="cb177"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb177-1"><a href="#cb177-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">bool</span> validate_recorded_trace<span class="op">(</span>TraceRecorder <span class="op">*</span>recorder<span class="op">)</span> <span class="op">{</span></span>
<span id="cb177-2"><a href="#cb177-2" aria-hidden="true" tabindex="-1"></a>    Trace <span class="op">*</span>trace <span class="op">=</span> build_trace<span class="op">(</span>recorder<span class="op">);</span></span>
<span id="cb177-3"><a href="#cb177-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb177-4"><a href="#cb177-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check trace properties</span></span>
<span id="cb177-5"><a href="#cb177-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>trace<span class="op">-&gt;</span>length <span class="op">&lt;</span> MIN_TRACE_LENGTH<span class="op">)</span> <span class="op">{</span></span>
<span id="cb177-6"><a href="#cb177-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span>  <span class="co">// Too short</span></span>
<span id="cb177-7"><a href="#cb177-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb177-8"><a href="#cb177-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb177-9"><a href="#cb177-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>trace<span class="op">-&gt;</span>length <span class="op">&gt;</span> MAX_TRACE_LENGTH<span class="op">)</span> <span class="op">{</span></span>
<span id="cb177-10"><a href="#cb177-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span>  <span class="co">// Too long</span></span>
<span id="cb177-11"><a href="#cb177-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb177-12"><a href="#cb177-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb177-13"><a href="#cb177-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Verify trace forms a loop</span></span>
<span id="cb177-14"><a href="#cb177-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>forms_loop<span class="op">(</span>trace<span class="op">))</span> <span class="op">{</span></span>
<span id="cb177-15"><a href="#cb177-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb177-16"><a href="#cb177-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb177-17"><a href="#cb177-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb177-18"><a href="#cb177-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check guard complexity</span></span>
<span id="cb177-19"><a href="#cb177-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>count_guards<span class="op">(</span>trace<span class="op">)</span> <span class="op">&gt;</span> MAX_GUARDS_PER_TRACE<span class="op">)</span> <span class="op">{</span></span>
<span id="cb177-20"><a href="#cb177-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span>  <span class="co">// Too many guards</span></span>
<span id="cb177-21"><a href="#cb177-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb177-22"><a href="#cb177-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb177-23"><a href="#cb177-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb177-24"><a href="#cb177-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3>14.8.2 Trace Finalization</h3>
<div class="sourceCode" id="cb178"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb178-1"><a href="#cb178-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> Trace<span class="op">*</span> finalize_trace<span class="op">(</span>TraceRecorder <span class="op">*</span>recorder<span class="op">)</span> <span class="op">{</span></span>
<span id="cb178-2"><a href="#cb178-2" aria-hidden="true" tabindex="-1"></a>    Trace <span class="op">*</span>trace <span class="op">=</span> allocate_trace<span class="op">();</span></span>
<span id="cb178-3"><a href="#cb178-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb178-4"><a href="#cb178-4" aria-hidden="true" tabindex="-1"></a>    trace<span class="op">-&gt;</span>id <span class="op">=</span> next_trace_id<span class="op">();</span></span>
<span id="cb178-5"><a href="#cb178-5" aria-hidden="true" tabindex="-1"></a>    trace<span class="op">-&gt;</span>entry_pc <span class="op">=</span> recorder<span class="op">-&gt;</span>anchor_pc<span class="op">;</span></span>
<span id="cb178-6"><a href="#cb178-6" aria-hidden="true" tabindex="-1"></a>    trace<span class="op">-&gt;</span>length <span class="op">=</span> recorder<span class="op">-&gt;</span>current_index<span class="op">;</span></span>
<span id="cb178-7"><a href="#cb178-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb178-8"><a href="#cb178-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Copy recorded instructions</span></span>
<span id="cb178-9"><a href="#cb178-9" aria-hidden="true" tabindex="-1"></a>    trace<span class="op">-&gt;</span>instructions <span class="op">=</span> copy_trace_buffer<span class="op">(</span>recorder<span class="op">-&gt;</span>buffer<span class="op">,</span> </span>
<span id="cb178-10"><a href="#cb178-10" aria-hidden="true" tabindex="-1"></a>                                           recorder<span class="op">-&gt;</span>current_index<span class="op">);</span></span>
<span id="cb178-11"><a href="#cb178-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb178-12"><a href="#cb178-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Optimize guards</span></span>
<span id="cb178-13"><a href="#cb178-13" aria-hidden="true" tabindex="-1"></a>    optimize_guards<span class="op">(</span>recorder<span class="op">);</span></span>
<span id="cb178-14"><a href="#cb178-14" aria-hidden="true" tabindex="-1"></a>    trace<span class="op">-&gt;</span>guards <span class="op">=</span> recorder<span class="op">-&gt;</span>guards<span class="op">;</span></span>
<span id="cb178-15"><a href="#cb178-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb178-16"><a href="#cb178-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Build type profile</span></span>
<span id="cb178-17"><a href="#cb178-17" aria-hidden="true" tabindex="-1"></a>    trace<span class="op">-&gt;</span>type_profile <span class="op">=</span> build_type_profile<span class="op">(</span>recorder<span class="op">);</span></span>
<span id="cb178-18"><a href="#cb178-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb178-19"><a href="#cb178-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Register trace</span></span>
<span id="cb178-20"><a href="#cb178-20" aria-hidden="true" tabindex="-1"></a>    register_trace<span class="op">(</span>vm<span class="op">-&gt;</span>trace_system<span class="op">-&gt;</span>trace_cache<span class="op">,</span> trace<span class="op">);</span></span>
<span id="cb178-21"><a href="#cb178-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb178-22"><a href="#cb178-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> trace<span class="op">;</span></span>
<span id="cb178-23"><a href="#cb178-23" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>14.9 Trace Cache Management</h2>
<h3>14.9.1 Trace Cache Structure</h3>
<div class="sourceCode" id="cb179"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb179-1"><a href="#cb179-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> TraceCache <span class="op">{</span></span>
<span id="cb179-2"><a href="#cb179-2" aria-hidden="true" tabindex="-1"></a>    HashMap <span class="op">*</span>pc_to_trace<span class="op">;</span>  <span class="co">// PC -&gt; Trace mapping</span></span>
<span id="cb179-3"><a href="#cb179-3" aria-hidden="true" tabindex="-1"></a>    Trace <span class="op">**</span>traces<span class="op">;</span>        <span class="co">// All traces</span></span>
<span id="cb179-4"><a href="#cb179-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> trace_count<span class="op">;</span></span>
<span id="cb179-5"><a href="#cb179-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> max_traces<span class="op">;</span></span>
<span id="cb179-6"><a href="#cb179-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb179-7"><a href="#cb179-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Eviction policy</span></span>
<span id="cb179-8"><a href="#cb179-8" aria-hidden="true" tabindex="-1"></a>    EvictionPolicy policy<span class="op">;</span></span>
<span id="cb179-9"><a href="#cb179-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> total_size<span class="op">;</span></span>
<span id="cb179-10"><a href="#cb179-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> max_size<span class="op">;</span></span>
<span id="cb179-11"><a href="#cb179-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> TraceCache<span class="op">;</span></span>
<span id="cb179-12"><a href="#cb179-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-13"><a href="#cb179-13" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> manage_trace_cache<span class="op">(</span>TraceCache <span class="op">*</span>cache<span class="op">)</span> <span class="op">{</span></span>
<span id="cb179-14"><a href="#cb179-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>cache<span class="op">-&gt;</span>total_size <span class="op">&gt;</span> cache<span class="op">-&gt;</span>max_size<span class="op">)</span> <span class="op">{</span></span>
<span id="cb179-15"><a href="#cb179-15" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Evict cold traces</span></span>
<span id="cb179-16"><a href="#cb179-16" aria-hidden="true" tabindex="-1"></a>        evict_cold_traces<span class="op">(</span>cache<span class="op">);</span></span>
<span id="cb179-17"><a href="#cb179-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb179-18"><a href="#cb179-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb179-19"><a href="#cb179-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>cache<span class="op">-&gt;</span>trace_count <span class="op">&gt;</span> cache<span class="op">-&gt;</span>max_traces<span class="op">)</span> <span class="op">{</span></span>
<span id="cb179-20"><a href="#cb179-20" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Evict least recently used</span></span>
<span id="cb179-21"><a href="#cb179-21" aria-hidden="true" tabindex="-1"></a>        evict_lru_traces<span class="op">(</span>cache<span class="op">);</span></span>
<span id="cb179-22"><a href="#cb179-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb179-23"><a href="#cb179-23" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>14.10 Nested and Linked Traces</h2>
<h3>14.10.1 Nested Trace Detection</h3>
<div class="sourceCode" id="cb180"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb180-1"><a href="#cb180-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> handle_nested_loop<span class="op">(</span>TraceRecorder <span class="op">*</span>recorder<span class="op">,</span> <span class="dt">void</span> <span class="op">*</span>inner_pc<span class="op">)</span> <span class="op">{</span></span>
<span id="cb180-2"><a href="#cb180-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>recorder<span class="op">-&gt;</span>nesting_depth <span class="op">&gt;=</span> MAX_NESTING_DEPTH<span class="op">)</span> <span class="op">{</span></span>
<span id="cb180-3"><a href="#cb180-3" aria-hidden="true" tabindex="-1"></a>        abort_recording<span class="op">(</span>recorder<span class="op">,</span> NESTING_TOO_DEEP<span class="op">);</span></span>
<span id="cb180-4"><a href="#cb180-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span><span class="op">;</span></span>
<span id="cb180-5"><a href="#cb180-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb180-6"><a href="#cb180-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb180-7"><a href="#cb180-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check if inner loop has a trace</span></span>
<span id="cb180-8"><a href="#cb180-8" aria-hidden="true" tabindex="-1"></a>    Trace <span class="op">*</span>inner_trace <span class="op">=</span> lookup_trace<span class="op">(</span>vm<span class="op">-&gt;</span>trace_system<span class="op">-&gt;</span>trace_cache<span class="op">,</span> inner_pc<span class="op">);</span></span>
<span id="cb180-9"><a href="#cb180-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb180-10"><a href="#cb180-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>inner_trace<span class="op">)</span> <span class="op">{</span></span>
<span id="cb180-11"><a href="#cb180-11" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Link to existing trace</span></span>
<span id="cb180-12"><a href="#cb180-12" aria-hidden="true" tabindex="-1"></a>        record_trace_call_instruction<span class="op">(</span>recorder<span class="op">,</span> inner_trace<span class="op">);</span></span>
<span id="cb180-13"><a href="#cb180-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb180-14"><a href="#cb180-14" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Continue recording through inner loop</span></span>
<span id="cb180-15"><a href="#cb180-15" aria-hidden="true" tabindex="-1"></a>        recorder<span class="op">-&gt;</span>nesting_depth<span class="op">++;</span></span>
<span id="cb180-16"><a href="#cb180-16" aria-hidden="true" tabindex="-1"></a>        mark_nested_region<span class="op">(</span>recorder<span class="op">,</span> inner_pc<span class="op">);</span></span>
<span id="cb180-17"><a href="#cb180-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb180-18"><a href="#cb180-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3>14.10.2 Trace Linking</h3>
<div class="sourceCode" id="cb181"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb181-1"><a href="#cb181-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> TraceLink <span class="op">{</span></span>
<span id="cb181-2"><a href="#cb181-2" aria-hidden="true" tabindex="-1"></a>    Trace <span class="op">*</span>from_trace<span class="op">;</span></span>
<span id="cb181-3"><a href="#cb181-3" aria-hidden="true" tabindex="-1"></a>    Trace <span class="op">*</span>to_trace<span class="op">;</span></span>
<span id="cb181-4"><a href="#cb181-4" aria-hidden="true" tabindex="-1"></a>    SideExit <span class="op">*</span>exit_point<span class="op">;</span></span>
<span id="cb181-5"><a href="#cb181-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint64_t</span> transition_count<span class="op">;</span></span>
<span id="cb181-6"><a href="#cb181-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> TraceLink<span class="op">;</span></span>
<span id="cb181-7"><a href="#cb181-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-8"><a href="#cb181-8" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> link_traces<span class="op">(</span>VM <span class="op">*</span>vm<span class="op">,</span> Trace <span class="op">*</span>from<span class="op">,</span> SideExit <span class="op">*</span>exit<span class="op">)</span> <span class="op">{</span></span>
<span id="cb181-9"><a href="#cb181-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span>target_pc <span class="op">=</span> exit<span class="op">-&gt;</span>bytecode_pc<span class="op">;</span></span>
<span id="cb181-10"><a href="#cb181-10" aria-hidden="true" tabindex="-1"></a>    Trace <span class="op">*</span>to <span class="op">=</span> lookup_trace<span class="op">(</span>vm<span class="op">-&gt;</span>trace_system<span class="op">-&gt;</span>trace_cache<span class="op">,</span> target_pc<span class="op">);</span></span>
<span id="cb181-11"><a href="#cb181-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb181-12"><a href="#cb181-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>to <span class="op">&amp;&amp;</span> is_compatible_trace_transition<span class="op">(</span>from<span class="op">,</span> to<span class="op">,</span> exit<span class="op">))</span> <span class="op">{</span></span>
<span id="cb181-13"><a href="#cb181-13" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Create direct link</span></span>
<span id="cb181-14"><a href="#cb181-14" aria-hidden="true" tabindex="-1"></a>        patch_exit_to_trace<span class="op">(</span>exit<span class="op">,</span> to<span class="op">);</span></span>
<span id="cb181-15"><a href="#cb181-15" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb181-16"><a href="#cb181-16" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Track link for profiling</span></span>
<span id="cb181-17"><a href="#cb181-17" aria-hidden="true" tabindex="-1"></a>        record_trace_link<span class="op">(</span>from<span class="op">,</span> to<span class="op">,</span> exit<span class="op">);</span></span>
<span id="cb181-18"><a href="#cb181-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb181-19"><a href="#cb181-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>14.11 Performance Monitoring</h2>
<h3>14.11.1 Trace Statistics</h3>
<div class="sourceCode" id="cb182"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb182-1"><a href="#cb182-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> TraceStats <span class="op">{</span></span>
<span id="cb182-2"><a href="#cb182-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Recording statistics</span></span>
<span id="cb182-3"><a href="#cb182-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint64_t</span> traces_recorded<span class="op">;</span></span>
<span id="cb182-4"><a href="#cb182-4" aria-hidden="true" tabindex="-1"></a><span class="pp"># </span><span class="er">Chapter 15: Trace Optimization and Peephole Optimization</span></span>
<span id="cb182-5"><a href="#cb182-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-6"><a href="#cb182-6" aria-hidden="true" tabindex="-1"></a><span class="pp">#</span><span class="er"># 15.1 Introduction</span></span>
<span id="cb182-7"><a href="#cb182-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-8"><a href="#cb182-8" aria-hidden="true" tabindex="-1"></a>This chapter details Diyrbal<span class="ch">&#39;s</span><span class="er"> trace optimization pipeline, focusing on specialized optimizations for linear trace code and efficient peephole optimization patterns. Building on the recorded traces from Chapter 14, we implement both high-level trace optimizations and low-level peephole transformations.</span></span>
<span id="cb182-9"><a href="#cb182-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-10"><a href="#cb182-10" aria-hidden="true" tabindex="-1"></a><span class="pp">#</span><span class="er"># 15.2 Trace Optimization Architecture</span></span>
<span id="cb182-11"><a href="#cb182-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-12"><a href="#cb182-12" aria-hidden="true" tabindex="-1"></a><span class="pp">#</span><span class="er">## 15.2.1 Optimization Pipeline</span></span>
<span id="cb182-13"><a href="#cb182-13" aria-hidden="true" tabindex="-1"></a>```c</span>
<span id="cb182-14"><a href="#cb182-14" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> TraceOptimizer <span class="op">{</span></span>
<span id="cb182-15"><a href="#cb182-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Optimization passes</span></span>
<span id="cb182-16"><a href="#cb182-16" aria-hidden="true" tabindex="-1"></a>    OptimizationPass <span class="op">*</span>passes<span class="op">;</span></span>
<span id="cb182-17"><a href="#cb182-17" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> num_passes<span class="op">;</span></span>
<span id="cb182-18"><a href="#cb182-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb182-19"><a href="#cb182-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Analysis data</span></span>
<span id="cb182-20"><a href="#cb182-20" aria-hidden="true" tabindex="-1"></a>    TraceDataflow <span class="op">*</span>dataflow<span class="op">;</span></span>
<span id="cb182-21"><a href="#cb182-21" aria-hidden="true" tabindex="-1"></a>    AliasAnalysis <span class="op">*</span>alias_info<span class="op">;</span></span>
<span id="cb182-22"><a href="#cb182-22" aria-hidden="true" tabindex="-1"></a>    TypeLattice <span class="op">*</span>type_info<span class="op">;</span></span>
<span id="cb182-23"><a href="#cb182-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb182-24"><a href="#cb182-24" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Peephole patterns</span></span>
<span id="cb182-25"><a href="#cb182-25" aria-hidden="true" tabindex="-1"></a>    PeepholePatternDB <span class="op">*</span>patterns<span class="op">;</span></span>
<span id="cb182-26"><a href="#cb182-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb182-27"><a href="#cb182-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Statistics</span></span>
<span id="cb182-28"><a href="#cb182-28" aria-hidden="true" tabindex="-1"></a>    OptimizationStats stats<span class="op">;</span></span>
<span id="cb182-29"><a href="#cb182-29" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> TraceOptimizer<span class="op">;</span></span>
<span id="cb182-30"><a href="#cb182-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-31"><a href="#cb182-31" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> OptimizationPass <span class="op">{</span></span>
<span id="cb182-32"><a href="#cb182-32" aria-hidden="true" tabindex="-1"></a>    <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>name<span class="op">;</span></span>
<span id="cb182-33"><a href="#cb182-33" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> <span class="op">(*</span>optimize<span class="op">)(</span>Trace <span class="op">*</span>trace<span class="op">,</span> TraceDataflow <span class="op">*</span>df<span class="op">);</span></span>
<span id="cb182-34"><a href="#cb182-34" aria-hidden="true" tabindex="-1"></a>    PassFlags flags<span class="op">;</span></span>
<span id="cb182-35"><a href="#cb182-35" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> iterations<span class="op">;</span></span>
<span id="cb182-36"><a href="#cb182-36" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> OptimizationPass<span class="op">;</span></span></code></pre></div>
<h3>15.2.2 Trace IR Extensions</h3>
<div class="sourceCode" id="cb183"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb183-1"><a href="#cb183-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> TraceInstruction <span class="op">{</span></span>
<span id="cb183-2"><a href="#cb183-2" aria-hidden="true" tabindex="-1"></a>    Opcode opcode<span class="op">;</span></span>
<span id="cb183-3"><a href="#cb183-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> dest<span class="op">;</span></span>
<span id="cb183-4"><a href="#cb183-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> operands<span class="op">[</span>MAX_OPERANDS<span class="op">];</span></span>
<span id="cb183-5"><a href="#cb183-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb183-6"><a href="#cb183-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Trace-specific metadata</span></span>
<span id="cb183-7"><a href="#cb183-7" aria-hidden="true" tabindex="-1"></a>    GuardInfo <span class="op">*</span>guard<span class="op">;</span></span>
<span id="cb183-8"><a href="#cb183-8" aria-hidden="true" tabindex="-1"></a>    ProfileData <span class="op">*</span>profile<span class="op">;</span></span>
<span id="cb183-9"><a href="#cb183-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb183-10"><a href="#cb183-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Optimization annotations</span></span>
<span id="cb183-11"><a href="#cb183-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> flags<span class="op">;</span></span>
<span id="cb183-12"><a href="#cb183-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span>optimization_data<span class="op">;</span></span>
<span id="cb183-13"><a href="#cb183-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> TraceInstruction<span class="op">;</span></span>
<span id="cb183-14"><a href="#cb183-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-15"><a href="#cb183-15" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">enum</span> <span class="op">{</span></span>
<span id="cb183-16"><a href="#cb183-16" aria-hidden="true" tabindex="-1"></a>    INST_DEAD <span class="op">=</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb183-17"><a href="#cb183-17" aria-hidden="true" tabindex="-1"></a>    INST_INVARIANT <span class="op">=</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb183-18"><a href="#cb183-18" aria-hidden="true" tabindex="-1"></a>    INST_REDUNDANT <span class="op">=</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="dv">2</span><span class="op">,</span></span>
<span id="cb183-19"><a href="#cb183-19" aria-hidden="true" tabindex="-1"></a>    INST_GUARD_ELIMINATED <span class="op">=</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="dv">3</span><span class="op">,</span></span>
<span id="cb183-20"><a href="#cb183-20" aria-hidden="true" tabindex="-1"></a>    INST_PEEPHOLE_MATCHED <span class="op">=</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="dv">4</span></span>
<span id="cb183-21"><a href="#cb183-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> InstructionFlags<span class="op">;</span></span></code></pre></div>
<h2>15.3 Guard Optimization</h2>
<h3>15.3.1 Guard Elimination</h3>
<div class="sourceCode" id="cb184"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb184-1"><a href="#cb184-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">bool</span> eliminate_redundant_guards<span class="op">(</span>Trace <span class="op">*</span>trace<span class="op">,</span> TraceDataflow <span class="op">*</span>df<span class="op">)</span> <span class="op">{</span></span>
<span id="cb184-2"><a href="#cb184-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> changed <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb184-3"><a href="#cb184-3" aria-hidden="true" tabindex="-1"></a>    GuardState <span class="op">*</span>state <span class="op">=</span> create_guard_state<span class="op">();</span></span>
<span id="cb184-4"><a href="#cb184-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb184-5"><a href="#cb184-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> trace<span class="op">-&gt;</span>length<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb184-6"><a href="#cb184-6" aria-hidden="true" tabindex="-1"></a>        TraceInstruction <span class="op">*</span>inst <span class="op">=</span> <span class="op">&amp;</span>trace<span class="op">-&gt;</span>instructions<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb184-7"><a href="#cb184-7" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb184-8"><a href="#cb184-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>is_guard_instruction<span class="op">(</span>inst<span class="op">))</span> <span class="op">{</span></span>
<span id="cb184-9"><a href="#cb184-9" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>is_guard_redundant<span class="op">(</span>inst<span class="op">,</span> state<span class="op">))</span> <span class="op">{</span></span>
<span id="cb184-10"><a href="#cb184-10" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Convert to no-op</span></span>
<span id="cb184-11"><a href="#cb184-11" aria-hidden="true" tabindex="-1"></a>                inst<span class="op">-&gt;</span>opcode <span class="op">=</span> OP_NOP<span class="op">;</span></span>
<span id="cb184-12"><a href="#cb184-12" aria-hidden="true" tabindex="-1"></a>                inst<span class="op">-&gt;</span>flags <span class="op">|=</span> INST_GUARD_ELIMINATED<span class="op">;</span></span>
<span id="cb184-13"><a href="#cb184-13" aria-hidden="true" tabindex="-1"></a>                changed <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb184-14"><a href="#cb184-14" aria-hidden="true" tabindex="-1"></a>                trace<span class="op">-&gt;</span>stats<span class="op">.</span>guards_eliminated<span class="op">++;</span></span>
<span id="cb184-15"><a href="#cb184-15" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb184-16"><a href="#cb184-16" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Update state</span></span>
<span id="cb184-17"><a href="#cb184-17" aria-hidden="true" tabindex="-1"></a>                update_guard_state<span class="op">(</span>state<span class="op">,</span> inst<span class="op">);</span></span>
<span id="cb184-18"><a href="#cb184-18" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb184-19"><a href="#cb184-19" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb184-20"><a href="#cb184-20" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Update state based on instruction effects</span></span>
<span id="cb184-21"><a href="#cb184-21" aria-hidden="true" tabindex="-1"></a>            apply_instruction_effects<span class="op">(</span>state<span class="op">,</span> inst<span class="op">);</span></span>
<span id="cb184-22"><a href="#cb184-22" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb184-23"><a href="#cb184-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb184-24"><a href="#cb184-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb184-25"><a href="#cb184-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> changed<span class="op">;</span></span>
<span id="cb184-26"><a href="#cb184-26" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb184-27"><a href="#cb184-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-28"><a href="#cb184-28" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">bool</span> is_guard_redundant<span class="op">(</span>TraceInstruction <span class="op">*</span>guard<span class="op">,</span> GuardState <span class="op">*</span>state<span class="op">)</span> <span class="op">{</span></span>
<span id="cb184-29"><a href="#cb184-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> <span class="op">(</span>guard<span class="op">-&gt;</span>opcode<span class="op">)</span> <span class="op">{</span></span>
<span id="cb184-30"><a href="#cb184-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> OP_GUARD_TYPE<span class="op">:</span></span>
<span id="cb184-31"><a href="#cb184-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> state<span class="op">-&gt;</span>known_types<span class="op">[</span>guard<span class="op">-&gt;</span>operands<span class="op">[</span><span class="dv">0</span><span class="op">]]</span> <span class="op">==</span> </span>
<span id="cb184-32"><a href="#cb184-32" aria-hidden="true" tabindex="-1"></a>               guard<span class="op">-&gt;</span>guard<span class="op">-&gt;</span>expected_type<span class="op">;</span></span>
<span id="cb184-33"><a href="#cb184-33" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb184-34"><a href="#cb184-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> OP_GUARD_BOUNDS<span class="op">:</span></span>
<span id="cb184-35"><a href="#cb184-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> is_bounds_check_redundant<span class="op">(</span>guard<span class="op">,</span> state<span class="op">);</span></span>
<span id="cb184-36"><a href="#cb184-36" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb184-37"><a href="#cb184-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> OP_GUARD_NULL<span class="op">:</span></span>
<span id="cb184-38"><a href="#cb184-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> state<span class="op">-&gt;</span>non_null_values<span class="op">[</span>guard<span class="op">-&gt;</span>operands<span class="op">[</span><span class="dv">0</span><span class="op">]];</span></span>
<span id="cb184-39"><a href="#cb184-39" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb184-40"><a href="#cb184-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">default</span><span class="op">:</span></span>
<span id="cb184-41"><a href="#cb184-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb184-42"><a href="#cb184-42" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb184-43"><a href="#cb184-43" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3>15.3.2 Guard Strengthening</h3>
<div class="sourceCode" id="cb185"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb185-1"><a href="#cb185-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> strengthen_guards<span class="op">(</span>Trace <span class="op">*</span>trace<span class="op">)</span> <span class="op">{</span></span>
<span id="cb185-2"><a href="#cb185-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> trace<span class="op">-&gt;</span>length<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb185-3"><a href="#cb185-3" aria-hidden="true" tabindex="-1"></a>        TraceInstruction <span class="op">*</span>inst <span class="op">=</span> <span class="op">&amp;</span>trace<span class="op">-&gt;</span>instructions<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb185-4"><a href="#cb185-4" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb185-5"><a href="#cb185-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>is_type_guard<span class="op">(</span>inst<span class="op">)</span> <span class="op">&amp;&amp;</span> inst<span class="op">-&gt;</span>profile<span class="op">)</span> <span class="op">{</span></span>
<span id="cb185-6"><a href="#cb185-6" aria-hidden="true" tabindex="-1"></a>            TypeProfile <span class="op">*</span>prof <span class="op">=</span> inst<span class="op">-&gt;</span>profile<span class="op">-&gt;</span>type_profile<span class="op">;</span></span>
<span id="cb185-7"><a href="#cb185-7" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb185-8"><a href="#cb185-8" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>prof<span class="op">-&gt;</span>monomorphic_ratio <span class="op">&gt;</span> MONOMORPHIC_THRESHOLD<span class="op">)</span> <span class="op">{</span></span>
<span id="cb185-9"><a href="#cb185-9" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Strengthen to exact type check</span></span>
<span id="cb185-10"><a href="#cb185-10" aria-hidden="true" tabindex="-1"></a>                strengthen_to_class_guard<span class="op">(</span>inst<span class="op">,</span> prof<span class="op">-&gt;</span>dominant_type<span class="op">);</span></span>
<span id="cb185-11"><a href="#cb185-11" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb185-12"><a href="#cb185-12" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb185-13"><a href="#cb185-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb185-14"><a href="#cb185-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>15.4 Allocation Sinking</h2>
<h3>15.4.1 Escape Analysis</h3>
<div class="sourceCode" id="cb186"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb186-1"><a href="#cb186-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> EscapeInfo <span class="op">{</span></span>
<span id="cb186-2"><a href="#cb186-2" aria-hidden="true" tabindex="-1"></a>    BitVector <span class="op">*</span>escaping_values<span class="op">;</span></span>
<span id="cb186-3"><a href="#cb186-3" aria-hidden="true" tabindex="-1"></a>    HashMap <span class="op">*</span>allocation_sites<span class="op">;</span></span>
<span id="cb186-4"><a href="#cb186-4" aria-hidden="true" tabindex="-1"></a>    BitVector <span class="op">*</span>scalar_replaceable<span class="op">;</span></span>
<span id="cb186-5"><a href="#cb186-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> EscapeInfo<span class="op">;</span></span>
<span id="cb186-6"><a href="#cb186-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-7"><a href="#cb186-7" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> EscapeInfo<span class="op">*</span> analyze_escapes<span class="op">(</span>Trace <span class="op">*</span>trace<span class="op">)</span> <span class="op">{</span></span>
<span id="cb186-8"><a href="#cb186-8" aria-hidden="true" tabindex="-1"></a>    EscapeInfo <span class="op">*</span>info <span class="op">=</span> create_escape_info<span class="op">(</span>trace<span class="op">);</span></span>
<span id="cb186-9"><a href="#cb186-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb186-10"><a href="#cb186-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Find allocations</span></span>
<span id="cb186-11"><a href="#cb186-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> trace<span class="op">-&gt;</span>length<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb186-12"><a href="#cb186-12" aria-hidden="true" tabindex="-1"></a>        TraceInstruction <span class="op">*</span>inst <span class="op">=</span> <span class="op">&amp;</span>trace<span class="op">-&gt;</span>instructions<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb186-13"><a href="#cb186-13" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb186-14"><a href="#cb186-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>is_allocation<span class="op">(</span>inst<span class="op">))</span> <span class="op">{</span></span>
<span id="cb186-15"><a href="#cb186-15" aria-hidden="true" tabindex="-1"></a>            mark_allocation<span class="op">(</span>info<span class="op">,</span> i<span class="op">,</span> inst<span class="op">-&gt;</span>dest<span class="op">);</span></span>
<span id="cb186-16"><a href="#cb186-16" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb186-17"><a href="#cb186-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb186-18"><a href="#cb186-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb186-19"><a href="#cb186-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Analyze uses</span></span>
<span id="cb186-20"><a href="#cb186-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> trace<span class="op">-&gt;</span>length<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb186-21"><a href="#cb186-21" aria-hidden="true" tabindex="-1"></a>        TraceInstruction <span class="op">*</span>inst <span class="op">=</span> <span class="op">&amp;</span>trace<span class="op">-&gt;</span>instructions<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb186-22"><a href="#cb186-22" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb186-23"><a href="#cb186-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> get_operand_count<span class="op">(</span>inst<span class="op">);</span> j<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb186-24"><a href="#cb186-24" aria-hidden="true" tabindex="-1"></a>            <span class="dt">uint32_t</span> operand <span class="op">=</span> inst<span class="op">-&gt;</span>operands<span class="op">[</span>j<span class="op">];</span></span>
<span id="cb186-25"><a href="#cb186-25" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb186-26"><a href="#cb186-26" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>is_allocation_result<span class="op">(</span>info<span class="op">,</span> operand<span class="op">))</span> <span class="op">{</span></span>
<span id="cb186-27"><a href="#cb186-27" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span>causes_escape<span class="op">(</span>inst<span class="op">,</span> j<span class="op">))</span> <span class="op">{</span></span>
<span id="cb186-28"><a href="#cb186-28" aria-hidden="true" tabindex="-1"></a>                    mark_escaping<span class="op">(</span>info<span class="op">,</span> operand<span class="op">);</span></span>
<span id="cb186-29"><a href="#cb186-29" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb186-30"><a href="#cb186-30" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb186-31"><a href="#cb186-31" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb186-32"><a href="#cb186-32" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb186-33"><a href="#cb186-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb186-34"><a href="#cb186-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> info<span class="op">;</span></span>
<span id="cb186-35"><a href="#cb186-35" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3>15.4.2 Allocation Sinking Transformation</h3>
<div class="sourceCode" id="cb187"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb187-1"><a href="#cb187-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">bool</span> sink_allocations<span class="op">(</span>Trace <span class="op">*</span>trace<span class="op">,</span> EscapeInfo <span class="op">*</span>escape_info<span class="op">)</span> <span class="op">{</span></span>
<span id="cb187-2"><a href="#cb187-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> changed <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb187-3"><a href="#cb187-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb187-4"><a href="#cb187-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> trace<span class="op">-&gt;</span>length<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb187-5"><a href="#cb187-5" aria-hidden="true" tabindex="-1"></a>        TraceInstruction <span class="op">*</span>inst <span class="op">=</span> <span class="op">&amp;</span>trace<span class="op">-&gt;</span>instructions<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb187-6"><a href="#cb187-6" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb187-7"><a href="#cb187-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>is_allocation<span class="op">(</span>inst<span class="op">)</span> <span class="op">&amp;&amp;</span> </span>
<span id="cb187-8"><a href="#cb187-8" aria-hidden="true" tabindex="-1"></a>            <span class="op">!</span>is_escaping<span class="op">(</span>escape_info<span class="op">,</span> inst<span class="op">-&gt;</span>dest<span class="op">))</span> <span class="op">{</span></span>
<span id="cb187-9"><a href="#cb187-9" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Move allocation to side exits</span></span>
<span id="cb187-10"><a href="#cb187-10" aria-hidden="true" tabindex="-1"></a>            changed <span class="op">|=</span> sink_allocation_to_exits<span class="op">(</span>trace<span class="op">,</span> i<span class="op">,</span> inst<span class="op">);</span></span>
<span id="cb187-11"><a href="#cb187-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb187-12"><a href="#cb187-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb187-13"><a href="#cb187-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb187-14"><a href="#cb187-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> changed<span class="op">;</span></span>
<span id="cb187-15"><a href="#cb187-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb187-16"><a href="#cb187-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb187-17"><a href="#cb187-17" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">bool</span> sink_allocation_to_exits<span class="op">(</span>Trace <span class="op">*</span>trace<span class="op">,</span> <span class="dt">size_t</span> alloc_idx<span class="op">,</span> </span>
<span id="cb187-18"><a href="#cb187-18" aria-hidden="true" tabindex="-1"></a>                                    TraceInstruction <span class="op">*</span>alloc<span class="op">)</span> <span class="op">{</span></span>
<span id="cb187-19"><a href="#cb187-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Find all side exits</span></span>
<span id="cb187-20"><a href="#cb187-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>SideExit <span class="op">*</span>exit <span class="op">=</span> trace<span class="op">-&gt;</span>side_exits<span class="op">;</span> exit<span class="op">;</span> exit <span class="op">=</span> exit<span class="op">-&gt;</span>next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb187-21"><a href="#cb187-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>is_value_live_at_exit<span class="op">(</span>alloc<span class="op">-&gt;</span>dest<span class="op">,</span> exit<span class="op">))</span> <span class="op">{</span></span>
<span id="cb187-22"><a href="#cb187-22" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Add allocation to exit&#39;s deoptimization info</span></span>
<span id="cb187-23"><a href="#cb187-23" aria-hidden="true" tabindex="-1"></a>            add_deferred_allocation<span class="op">(</span>exit<span class="op">,</span> alloc<span class="op">);</span></span>
<span id="cb187-24"><a href="#cb187-24" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb187-25"><a href="#cb187-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb187-26"><a href="#cb187-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb187-27"><a href="#cb187-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Remove from trace</span></span>
<span id="cb187-28"><a href="#cb187-28" aria-hidden="true" tabindex="-1"></a>    alloc<span class="op">-&gt;</span>opcode <span class="op">=</span> OP_NOP<span class="op">;</span></span>
<span id="cb187-29"><a href="#cb187-29" aria-hidden="true" tabindex="-1"></a>    alloc<span class="op">-&gt;</span>flags <span class="op">|=</span> INST_DEAD<span class="op">;</span></span>
<span id="cb187-30"><a href="#cb187-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb187-31"><a href="#cb187-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb187-32"><a href="#cb187-32" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>15.5 Loop-Invariant Code Motion (LICM)</h2>
<h3>15.5.1 Invariant Detection</h3>
<div class="sourceCode" id="cb188"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb188-1"><a href="#cb188-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> BitVector<span class="op">*</span> find_loop_invariants<span class="op">(</span>Trace <span class="op">*</span>trace<span class="op">)</span> <span class="op">{</span></span>
<span id="cb188-2"><a href="#cb188-2" aria-hidden="true" tabindex="-1"></a>    BitVector <span class="op">*</span>invariant <span class="op">=</span> bit_vector_create<span class="op">(</span>trace<span class="op">-&gt;</span>length<span class="op">);</span></span>
<span id="cb188-3"><a href="#cb188-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> changed <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb188-4"><a href="#cb188-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb188-5"><a href="#cb188-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Initialize with potentially invariant instructions</span></span>
<span id="cb188-6"><a href="#cb188-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> trace<span class="op">-&gt;</span>length<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb188-7"><a href="#cb188-7" aria-hidden="true" tabindex="-1"></a>        TraceInstruction <span class="op">*</span>inst <span class="op">=</span> <span class="op">&amp;</span>trace<span class="op">-&gt;</span>instructions<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb188-8"><a href="#cb188-8" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb188-9"><a href="#cb188-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(!</span>has_side_effects<span class="op">(</span>inst<span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="op">!</span>is_guard<span class="op">(</span>inst<span class="op">))</span> <span class="op">{</span></span>
<span id="cb188-10"><a href="#cb188-10" aria-hidden="true" tabindex="-1"></a>            bit_vector_set<span class="op">(</span>invariant<span class="op">,</span> i<span class="op">);</span></span>
<span id="cb188-11"><a href="#cb188-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb188-12"><a href="#cb188-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb188-13"><a href="#cb188-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb188-14"><a href="#cb188-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Fixed-point iteration</span></span>
<span id="cb188-15"><a href="#cb188-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span>changed<span class="op">)</span> <span class="op">{</span></span>
<span id="cb188-16"><a href="#cb188-16" aria-hidden="true" tabindex="-1"></a>        changed <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb188-17"><a href="#cb188-17" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb188-18"><a href="#cb188-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> trace<span class="op">-&gt;</span>length<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb188-19"><a href="#cb188-19" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(!</span>bit_vector_get<span class="op">(</span>invariant<span class="op">,</span> i<span class="op">))</span> <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb188-20"><a href="#cb188-20" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb188-21"><a href="#cb188-21" aria-hidden="true" tabindex="-1"></a>            TraceInstruction <span class="op">*</span>inst <span class="op">=</span> <span class="op">&amp;</span>trace<span class="op">-&gt;</span>instructions<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb188-22"><a href="#cb188-22" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb188-23"><a href="#cb188-23" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Check if operands are invariant</span></span>
<span id="cb188-24"><a href="#cb188-24" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> get_operand_count<span class="op">(</span>inst<span class="op">);</span> j<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb188-25"><a href="#cb188-25" aria-hidden="true" tabindex="-1"></a>                <span class="dt">uint32_t</span> operand <span class="op">=</span> inst<span class="op">-&gt;</span>operands<span class="op">[</span>j<span class="op">];</span></span>
<span id="cb188-26"><a href="#cb188-26" aria-hidden="true" tabindex="-1"></a>                <span class="dt">size_t</span> def_idx <span class="op">=</span> find_definition<span class="op">(</span>trace<span class="op">,</span> operand<span class="op">);</span></span>
<span id="cb188-27"><a href="#cb188-27" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb188-28"><a href="#cb188-28" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span>def_idx <span class="op">&lt;</span> trace<span class="op">-&gt;</span>length <span class="op">&amp;&amp;</span> </span>
<span id="cb188-29"><a href="#cb188-29" aria-hidden="true" tabindex="-1"></a>                    <span class="op">!</span>bit_vector_get<span class="op">(</span>invariant<span class="op">,</span> def_idx<span class="op">))</span> <span class="op">{</span></span>
<span id="cb188-30"><a href="#cb188-30" aria-hidden="true" tabindex="-1"></a>                    bit_vector_clear<span class="op">(</span>invariant<span class="op">,</span> i<span class="op">);</span></span>
<span id="cb188-31"><a href="#cb188-31" aria-hidden="true" tabindex="-1"></a>                    changed <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb188-32"><a href="#cb188-32" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">break</span><span class="op">;</span></span>
<span id="cb188-33"><a href="#cb188-33" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb188-34"><a href="#cb188-34" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb188-35"><a href="#cb188-35" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb188-36"><a href="#cb188-36" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb188-37"><a href="#cb188-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb188-38"><a href="#cb188-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> invariant<span class="op">;</span></span>
<span id="cb188-39"><a href="#cb188-39" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3>15.5.2 Code Motion</h3>
<div class="sourceCode" id="cb189"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb189-1"><a href="#cb189-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">bool</span> hoist_invariants<span class="op">(</span>Trace <span class="op">*</span>trace<span class="op">,</span> BitVector <span class="op">*</span>invariants<span class="op">)</span> <span class="op">{</span></span>
<span id="cb189-2"><a href="#cb189-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> changed <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb189-3"><a href="#cb189-3" aria-hidden="true" tabindex="-1"></a>    TraceInstruction <span class="op">*</span>preheader <span class="op">=</span> create_preheader<span class="op">(</span>trace<span class="op">);</span></span>
<span id="cb189-4"><a href="#cb189-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb189-5"><a href="#cb189-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> trace<span class="op">-&gt;</span>length<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb189-6"><a href="#cb189-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(!</span>bit_vector_get<span class="op">(</span>invariants<span class="op">,</span> i<span class="op">))</span> <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb189-7"><a href="#cb189-7" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb189-8"><a href="#cb189-8" aria-hidden="true" tabindex="-1"></a>        TraceInstruction <span class="op">*</span>inst <span class="op">=</span> <span class="op">&amp;</span>trace<span class="op">-&gt;</span>instructions<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb189-9"><a href="#cb189-9" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb189-10"><a href="#cb189-10" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Check if safe to hoist</span></span>
<span id="cb189-11"><a href="#cb189-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>can_hoist_instruction<span class="op">(</span>inst<span class="op">,</span> trace<span class="op">))</span> <span class="op">{</span></span>
<span id="cb189-12"><a href="#cb189-12" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Move to preheader</span></span>
<span id="cb189-13"><a href="#cb189-13" aria-hidden="true" tabindex="-1"></a>            copy_instruction<span class="op">(</span>preheader<span class="op">,</span> inst<span class="op">);</span></span>
<span id="cb189-14"><a href="#cb189-14" aria-hidden="true" tabindex="-1"></a>            inst<span class="op">-&gt;</span>opcode <span class="op">=</span> OP_NOP<span class="op">;</span></span>
<span id="cb189-15"><a href="#cb189-15" aria-hidden="true" tabindex="-1"></a>            inst<span class="op">-&gt;</span>flags <span class="op">|=</span> INST_DEAD<span class="op">;</span></span>
<span id="cb189-16"><a href="#cb189-16" aria-hidden="true" tabindex="-1"></a>            changed <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb189-17"><a href="#cb189-17" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb189-18"><a href="#cb189-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb189-19"><a href="#cb189-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb189-20"><a href="#cb189-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> changed<span class="op">;</span></span>
<span id="cb189-21"><a href="#cb189-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>15.6 Peephole Optimization</h2>
<h3>15.6.1 Pattern Database</h3>
<div class="sourceCode" id="cb190"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb190-1"><a href="#cb190-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> PeepholePattern <span class="op">{</span></span>
<span id="cb190-2"><a href="#cb190-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>name<span class="op">;</span></span>
<span id="cb190-3"><a href="#cb190-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> length<span class="op">;</span></span>
<span id="cb190-4"><a href="#cb190-4" aria-hidden="true" tabindex="-1"></a>    PatternMatcher matcher<span class="op">;</span></span>
<span id="cb190-5"><a href="#cb190-5" aria-hidden="true" tabindex="-1"></a>    PatternTransformer transformer<span class="op">;</span></span>
<span id="cb190-6"><a href="#cb190-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> benefit<span class="op">;</span>  <span class="co">// Estimated cycles saved</span></span>
<span id="cb190-7"><a href="#cb190-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> PeepholePattern<span class="op">;</span></span>
<span id="cb190-8"><a href="#cb190-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-9"><a href="#cb190-9" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="dt">bool</span> <span class="op">(*</span>PatternMatcher<span class="op">)(</span>TraceInstruction <span class="op">*</span>window<span class="op">,</span> <span class="dt">size_t</span> len<span class="op">);</span></span>
<span id="cb190-10"><a href="#cb190-10" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="dt">void</span> <span class="op">(*</span>PatternTransformer<span class="op">)(</span>TraceInstruction <span class="op">*</span>window<span class="op">,</span> <span class="dt">size_t</span> len<span class="op">);</span></span>
<span id="cb190-11"><a href="#cb190-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-12"><a href="#cb190-12" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> PeepholePattern patterns<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb190-13"><a href="#cb190-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Algebraic simplifications</span></span>
<span id="cb190-14"><a href="#cb190-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb190-15"><a href="#cb190-15" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>name <span class="op">=</span> <span class="st">&quot;add_zero_elimination&quot;</span><span class="op">,</span></span>
<span id="cb190-16"><a href="#cb190-16" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>length <span class="op">=</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb190-17"><a href="#cb190-17" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>matcher <span class="op">=</span> match_add_zero<span class="op">,</span></span>
<span id="cb190-18"><a href="#cb190-18" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>transformer <span class="op">=</span> eliminate_add_zero<span class="op">,</span></span>
<span id="cb190-19"><a href="#cb190-19" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>benefit <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb190-20"><a href="#cb190-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">},</span></span>
<span id="cb190-21"><a href="#cb190-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb190-22"><a href="#cb190-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Strength reduction</span></span>
<span id="cb190-23"><a href="#cb190-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb190-24"><a href="#cb190-24" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>name <span class="op">=</span> <span class="st">&quot;multiply_by_power_of_two&quot;</span><span class="op">,</span></span>
<span id="cb190-25"><a href="#cb190-25" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>length <span class="op">=</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb190-26"><a href="#cb190-26" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>matcher <span class="op">=</span> match_mul_power_of_two<span class="op">,</span></span>
<span id="cb190-27"><a href="#cb190-27" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>transformer <span class="op">=</span> transform_mul_to_shift<span class="op">,</span></span>
<span id="cb190-28"><a href="#cb190-28" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>benefit <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb190-29"><a href="#cb190-29" aria-hidden="true" tabindex="-1"></a>    <span class="op">},</span></span>
<span id="cb190-30"><a href="#cb190-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb190-31"><a href="#cb190-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Load/store optimizations</span></span>
<span id="cb190-32"><a href="#cb190-32" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb190-33"><a href="#cb190-33" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>name <span class="op">=</span> <span class="st">&quot;redundant_load_elimination&quot;</span><span class="op">,</span></span>
<span id="cb190-34"><a href="#cb190-34" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>length <span class="op">=</span> <span class="dv">2</span><span class="op">,</span></span>
<span id="cb190-35"><a href="#cb190-35" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>matcher <span class="op">=</span> match_redundant_load<span class="op">,</span></span>
<span id="cb190-36"><a href="#cb190-36" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>transformer <span class="op">=</span> eliminate_redundant_load<span class="op">,</span></span>
<span id="cb190-37"><a href="#cb190-37" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>benefit <span class="op">=</span> <span class="dv">4</span></span>
<span id="cb190-38"><a href="#cb190-38" aria-hidden="true" tabindex="-1"></a>    <span class="op">},</span></span>
<span id="cb190-39"><a href="#cb190-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb190-40"><a href="#cb190-40" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Guard combinations</span></span>
<span id="cb190-41"><a href="#cb190-41" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb190-42"><a href="#cb190-42" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>name <span class="op">=</span> <span class="st">&quot;combine_type_guards&quot;</span><span class="op">,</span></span>
<span id="cb190-43"><a href="#cb190-43" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>length <span class="op">=</span> <span class="dv">2</span><span class="op">,</span></span>
<span id="cb190-44"><a href="#cb190-44" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>matcher <span class="op">=</span> match_compatible_guards<span class="op">,</span></span>
<span id="cb190-45"><a href="#cb190-45" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>transformer <span class="op">=</span> combine_guards<span class="op">,</span></span>
<span id="cb190-46"><a href="#cb190-46" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>benefit <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb190-47"><a href="#cb190-47" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb190-48"><a href="#cb190-48" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<h3>15.6.2 Pattern Matching Engine</h3>
<div class="sourceCode" id="cb191"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb191-1"><a href="#cb191-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">bool</span> apply_peephole_optimizations<span class="op">(</span>Trace <span class="op">*</span>trace<span class="op">)</span> <span class="op">{</span></span>
<span id="cb191-2"><a href="#cb191-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> changed <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb191-3"><a href="#cb191-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> window_max <span class="op">=</span> <span class="dv">4</span><span class="op">;</span>  <span class="co">// Maximum pattern length</span></span>
<span id="cb191-4"><a href="#cb191-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb191-5"><a href="#cb191-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> trace<span class="op">-&gt;</span>length<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb191-6"><a href="#cb191-6" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Skip dead instructions</span></span>
<span id="cb191-7"><a href="#cb191-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>trace<span class="op">-&gt;</span>instructions<span class="op">[</span>i<span class="op">].</span>flags <span class="op">&amp;</span> INST_DEAD<span class="op">)</span> <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb191-8"><a href="#cb191-8" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb191-9"><a href="#cb191-9" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Try each pattern</span></span>
<span id="cb191-10"><a href="#cb191-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> p <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> p <span class="op">&lt;</span> ARRAY_SIZE<span class="op">(</span>patterns<span class="op">);</span> p<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb191-11"><a href="#cb191-11" aria-hidden="true" tabindex="-1"></a>            PeepholePattern <span class="op">*</span>pattern <span class="op">=</span> <span class="op">&amp;</span>patterns<span class="op">[</span>p<span class="op">];</span></span>
<span id="cb191-12"><a href="#cb191-12" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb191-13"><a href="#cb191-13" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>i <span class="op">+</span> pattern<span class="op">-&gt;</span>length <span class="op">&lt;=</span> trace<span class="op">-&gt;</span>length<span class="op">)</span> <span class="op">{</span></span>
<span id="cb191-14"><a href="#cb191-14" aria-hidden="true" tabindex="-1"></a>                TraceInstruction <span class="op">*</span>window <span class="op">=</span> <span class="op">&amp;</span>trace<span class="op">-&gt;</span>instructions<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb191-15"><a href="#cb191-15" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb191-16"><a href="#cb191-16" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span>pattern<span class="op">-&gt;</span>matcher<span class="op">(</span>window<span class="op">,</span> pattern<span class="op">-&gt;</span>length<span class="op">))</span> <span class="op">{</span></span>
<span id="cb191-17"><a href="#cb191-17" aria-hidden="true" tabindex="-1"></a>                    pattern<span class="op">-&gt;</span>transformer<span class="op">(</span>window<span class="op">,</span> pattern<span class="op">-&gt;</span>length<span class="op">);</span></span>
<span id="cb191-18"><a href="#cb191-18" aria-hidden="true" tabindex="-1"></a>                    trace<span class="op">-&gt;</span>stats<span class="op">.</span>peephole_matches<span class="op">++;</span></span>
<span id="cb191-19"><a href="#cb191-19" aria-hidden="true" tabindex="-1"></a>                    changed <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb191-20"><a href="#cb191-20" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb191-21"><a href="#cb191-21" aria-hidden="true" tabindex="-1"></a>                    <span class="co">// Mark as transformed</span></span>
<span id="cb191-22"><a href="#cb191-22" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> pattern<span class="op">-&gt;</span>length<span class="op">;</span> j<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb191-23"><a href="#cb191-23" aria-hidden="true" tabindex="-1"></a>                        window<span class="op">[</span>j<span class="op">].</span>flags <span class="op">|=</span> INST_PEEPHOLE_MATCHED<span class="op">;</span></span>
<span id="cb191-24"><a href="#cb191-24" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span></span>
<span id="cb191-25"><a href="#cb191-25" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb191-26"><a href="#cb191-26" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">break</span><span class="op">;</span>  <span class="co">// Try next position</span></span>
<span id="cb191-27"><a href="#cb191-27" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb191-28"><a href="#cb191-28" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb191-29"><a href="#cb191-29" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb191-30"><a href="#cb191-30" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb191-31"><a href="#cb191-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb191-32"><a href="#cb191-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> changed<span class="op">;</span></span>
<span id="cb191-33"><a href="#cb191-33" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3>15.6.3 Common Peephole Patterns</h3>
<div class="sourceCode" id="cb192"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb192-1"><a href="#cb192-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Pattern: x + 0 -&gt; x</span></span>
<span id="cb192-2"><a href="#cb192-2" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">bool</span> match_add_zero<span class="op">(</span>TraceInstruction <span class="op">*</span>window<span class="op">,</span> <span class="dt">size_t</span> len<span class="op">)</span> <span class="op">{</span></span>
<span id="cb192-3"><a href="#cb192-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> window<span class="op">[</span><span class="dv">0</span><span class="op">].</span>opcode <span class="op">==</span> OP_ADD <span class="op">&amp;&amp;</span></span>
<span id="cb192-4"><a href="#cb192-4" aria-hidden="true" tabindex="-1"></a>           is_constant<span class="op">(</span>window<span class="op">,</span> window<span class="op">[</span><span class="dv">0</span><span class="op">].</span>operands<span class="op">[</span><span class="dv">1</span><span class="op">])</span> <span class="op">&amp;&amp;</span></span>
<span id="cb192-5"><a href="#cb192-5" aria-hidden="true" tabindex="-1"></a>           get_constant_value<span class="op">(</span>window<span class="op">,</span> window<span class="op">[</span><span class="dv">0</span><span class="op">].</span>operands<span class="op">[</span><span class="dv">1</span><span class="op">])</span> <span class="op">==</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb192-6"><a href="#cb192-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb192-7"><a href="#cb192-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb192-8"><a href="#cb192-8" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> eliminate_add_zero<span class="op">(</span>TraceInstruction <span class="op">*</span>window<span class="op">,</span> <span class="dt">size_t</span> len<span class="op">)</span> <span class="op">{</span></span>
<span id="cb192-9"><a href="#cb192-9" aria-hidden="true" tabindex="-1"></a>    window<span class="op">[</span><span class="dv">0</span><span class="op">].</span>opcode <span class="op">=</span> OP_MOVE<span class="op">;</span></span>
<span id="cb192-10"><a href="#cb192-10" aria-hidden="true" tabindex="-1"></a>    window<span class="op">[</span><span class="dv">0</span><span class="op">].</span>operands<span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="op">=</span> UNUSED_OPERAND<span class="op">;</span></span>
<span id="cb192-11"><a href="#cb192-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb192-12"><a href="#cb192-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb192-13"><a href="#cb192-13" aria-hidden="true" tabindex="-1"></a><span class="co">// Pattern: x * 2^n -&gt; x &lt;&lt; n</span></span>
<span id="cb192-14"><a href="#cb192-14" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">bool</span> match_mul_power_of_two<span class="op">(</span>TraceInstruction <span class="op">*</span>window<span class="op">,</span> <span class="dt">size_t</span> len<span class="op">)</span> <span class="op">{</span></span>
<span id="cb192-15"><a href="#cb192-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>window<span class="op">[</span><span class="dv">0</span><span class="op">].</span>opcode <span class="op">!=</span> OP_MUL<span class="op">)</span> <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb192-16"><a href="#cb192-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb192-17"><a href="#cb192-17" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int64_t</span> value <span class="op">=</span> get_constant_value<span class="op">(</span>window<span class="op">,</span> window<span class="op">[</span><span class="dv">0</span><span class="op">].</span>operands<span class="op">[</span><span class="dv">1</span><span class="op">]);</span></span>
<span id="cb192-18"><a href="#cb192-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> is_power_of_two<span class="op">(</span>value<span class="op">);</span></span>
<span id="cb192-19"><a href="#cb192-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb192-20"><a href="#cb192-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb192-21"><a href="#cb192-21" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> transform_mul_to_shift<span class="op">(</span>TraceInstruction <span class="op">*</span>window<span class="op">,</span> <span class="dt">size_t</span> len<span class="op">)</span> <span class="op">{</span></span>
<span id="cb192-22"><a href="#cb192-22" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int64_t</span> value <span class="op">=</span> get_constant_value<span class="op">(</span>window<span class="op">,</span> window<span class="op">[</span><span class="dv">0</span><span class="op">].</span>operands<span class="op">[</span><span class="dv">1</span><span class="op">]);</span></span>
<span id="cb192-23"><a href="#cb192-23" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> shift <span class="op">=</span> count_trailing_zeros<span class="op">(</span>value<span class="op">);</span></span>
<span id="cb192-24"><a href="#cb192-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb192-25"><a href="#cb192-25" aria-hidden="true" tabindex="-1"></a>    window<span class="op">[</span><span class="dv">0</span><span class="op">].</span>opcode <span class="op">=</span> OP_SHL<span class="op">;</span></span>
<span id="cb192-26"><a href="#cb192-26" aria-hidden="true" tabindex="-1"></a>    set_constant_value<span class="op">(</span>window<span class="op">,</span> window<span class="op">[</span><span class="dv">0</span><span class="op">].</span>operands<span class="op">[</span><span class="dv">1</span><span class="op">],</span> shift<span class="op">);</span></span>
<span id="cb192-27"><a href="#cb192-27" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb192-28"><a href="#cb192-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb192-29"><a href="#cb192-29" aria-hidden="true" tabindex="-1"></a><span class="co">// Pattern: store x; load x -&gt; store x; move x</span></span>
<span id="cb192-30"><a href="#cb192-30" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">bool</span> match_redundant_load<span class="op">(</span>TraceInstruction <span class="op">*</span>window<span class="op">,</span> <span class="dt">size_t</span> len<span class="op">)</span> <span class="op">{</span></span>
<span id="cb192-31"><a href="#cb192-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> window<span class="op">[</span><span class="dv">0</span><span class="op">].</span>opcode <span class="op">==</span> OP_STORE <span class="op">&amp;&amp;</span></span>
<span id="cb192-32"><a href="#cb192-32" aria-hidden="true" tabindex="-1"></a>           window<span class="op">[</span><span class="dv">1</span><span class="op">].</span>opcode <span class="op">==</span> OP_LOAD <span class="op">&amp;&amp;</span></span>
<span id="cb192-33"><a href="#cb192-33" aria-hidden="true" tabindex="-1"></a>           same_memory_location<span class="op">(</span>window<span class="op">[</span><span class="dv">0</span><span class="op">],</span> window<span class="op">[</span><span class="dv">1</span><span class="op">])</span> <span class="op">&amp;&amp;</span></span>
<span id="cb192-34"><a href="#cb192-34" aria-hidden="true" tabindex="-1"></a>           <span class="op">!</span>may_alias<span class="op">(</span>window<span class="op">[</span><span class="dv">0</span><span class="op">],</span> window<span class="op">[</span><span class="dv">1</span><span class="op">]);</span></span>
<span id="cb192-35"><a href="#cb192-35" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb192-36"><a href="#cb192-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb192-37"><a href="#cb192-37" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> eliminate_redundant_load<span class="op">(</span>TraceInstruction <span class="op">*</span>window<span class="op">,</span> <span class="dt">size_t</span> len<span class="op">)</span> <span class="op">{</span></span>
<span id="cb192-38"><a href="#cb192-38" aria-hidden="true" tabindex="-1"></a>    window<span class="op">[</span><span class="dv">1</span><span class="op">].</span>opcode <span class="op">=</span> OP_MOVE<span class="op">;</span></span>
<span id="cb192-39"><a href="#cb192-39" aria-hidden="true" tabindex="-1"></a>    window<span class="op">[</span><span class="dv">1</span><span class="op">].</span>operands<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> window<span class="op">[</span><span class="dv">0</span><span class="op">].</span>operands<span class="op">[</span><span class="dv">0</span><span class="op">];</span>  <span class="co">// Value that was stored</span></span>
<span id="cb192-40"><a href="#cb192-40" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>15.7 Instruction Combining</h2>
<h3>15.7.1 Arithmetic Combining</h3>
<div class="sourceCode" id="cb193"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb193-1"><a href="#cb193-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">bool</span> combine_arithmetic<span class="op">(</span>Trace <span class="op">*</span>trace<span class="op">)</span> <span class="op">{</span></span>
<span id="cb193-2"><a href="#cb193-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> changed <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb193-3"><a href="#cb193-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb193-4"><a href="#cb193-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> trace<span class="op">-&gt;</span>length <span class="op">-</span> <span class="dv">1</span><span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb193-5"><a href="#cb193-5" aria-hidden="true" tabindex="-1"></a>        TraceInstruction <span class="op">*</span>inst1 <span class="op">=</span> <span class="op">&amp;</span>trace<span class="op">-&gt;</span>instructions<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb193-6"><a href="#cb193-6" aria-hidden="true" tabindex="-1"></a>        TraceInstruction <span class="op">*</span>inst2 <span class="op">=</span> <span class="op">&amp;</span>trace<span class="op">-&gt;</span>instructions<span class="op">[</span>i <span class="op">+</span> <span class="dv">1</span><span class="op">];</span></span>
<span id="cb193-7"><a href="#cb193-7" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb193-8"><a href="#cb193-8" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Pattern: (x + a) + b -&gt; x + (a + b)</span></span>
<span id="cb193-9"><a href="#cb193-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>inst1<span class="op">-&gt;</span>opcode <span class="op">==</span> OP_ADD <span class="op">&amp;&amp;</span> inst2<span class="op">-&gt;</span>opcode <span class="op">==</span> OP_ADD <span class="op">&amp;&amp;</span></span>
<span id="cb193-10"><a href="#cb193-10" aria-hidden="true" tabindex="-1"></a>            inst2<span class="op">-&gt;</span>operands<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">==</span> inst1<span class="op">-&gt;</span>dest <span class="op">&amp;&amp;</span></span>
<span id="cb193-11"><a href="#cb193-11" aria-hidden="true" tabindex="-1"></a>            is_constant<span class="op">(</span>trace<span class="op">,</span> inst1<span class="op">-&gt;</span>operands<span class="op">[</span><span class="dv">1</span><span class="op">])</span> <span class="op">&amp;&amp;</span></span>
<span id="cb193-12"><a href="#cb193-12" aria-hidden="true" tabindex="-1"></a>            is_constant<span class="op">(</span>trace<span class="op">,</span> inst2<span class="op">-&gt;</span>operands<span class="op">[</span><span class="dv">1</span><span class="op">]))</span> <span class="op">{</span></span>
<span id="cb193-13"><a href="#cb193-13" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb193-14"><a href="#cb193-14" aria-hidden="true" tabindex="-1"></a>            <span class="dt">int64_t</span> a <span class="op">=</span> get_constant_value<span class="op">(</span>trace<span class="op">,</span> inst1<span class="op">-&gt;</span>operands<span class="op">[</span><span class="dv">1</span><span class="op">]);</span></span>
<span id="cb193-15"><a href="#cb193-15" aria-hidden="true" tabindex="-1"></a>            <span class="dt">int64_t</span> b <span class="op">=</span> get_constant_value<span class="op">(</span>trace<span class="op">,</span> inst2<span class="op">-&gt;</span>operands<span class="op">[</span><span class="dv">1</span><span class="op">]);</span></span>
<span id="cb193-16"><a href="#cb193-16" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb193-17"><a href="#cb193-17" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Combine into single add</span></span>
<span id="cb193-18"><a href="#cb193-18" aria-hidden="true" tabindex="-1"></a>            inst2<span class="op">-&gt;</span>operands<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> inst1<span class="op">-&gt;</span>operands<span class="op">[</span><span class="dv">0</span><span class="op">];</span></span>
<span id="cb193-19"><a href="#cb193-19" aria-hidden="true" tabindex="-1"></a>            set_constant_value<span class="op">(</span>trace<span class="op">,</span> inst2<span class="op">-&gt;</span>operands<span class="op">[</span><span class="dv">1</span><span class="op">],</span> a <span class="op">+</span> b<span class="op">);</span></span>
<span id="cb193-20"><a href="#cb193-20" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb193-21"><a href="#cb193-21" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Eliminate first instruction</span></span>
<span id="cb193-22"><a href="#cb193-22" aria-hidden="true" tabindex="-1"></a>            inst1<span class="op">-&gt;</span>opcode <span class="op">=</span> OP_NOP<span class="op">;</span></span>
<span id="cb193-23"><a href="#cb193-23" aria-hidden="true" tabindex="-1"></a>            inst1<span class="op">-&gt;</span>flags <span class="op">|=</span> INST_DEAD<span class="op">;</span></span>
<span id="cb193-24"><a href="#cb193-24" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb193-25"><a href="#cb193-25" aria-hidden="true" tabindex="-1"></a>            changed <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb193-26"><a href="#cb193-26" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb193-27"><a href="#cb193-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb193-28"><a href="#cb193-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb193-29"><a href="#cb193-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> changed<span class="op">;</span></span>
<span id="cb193-30"><a href="#cb193-30" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3>15.7.2 Memory Operation Combining</h3>
<div class="sourceCode" id="cb194"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb194-1"><a href="#cb194-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">bool</span> combine_memory_operations<span class="op">(</span>Trace <span class="op">*</span>trace<span class="op">)</span> <span class="op">{</span></span>
<span id="cb194-2"><a href="#cb194-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> changed <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb194-3"><a href="#cb194-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb194-4"><a href="#cb194-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> trace<span class="op">-&gt;</span>length <span class="op">-</span> <span class="dv">1</span><span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb194-5"><a href="#cb194-5" aria-hidden="true" tabindex="-1"></a>        TraceInstruction <span class="op">*</span>inst1 <span class="op">=</span> <span class="op">&amp;</span>trace<span class="op">-&gt;</span>instructions<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb194-6"><a href="#cb194-6" aria-hidden="true" tabindex="-1"></a>        TraceInstruction <span class="op">*</span>inst2 <span class="op">=</span> <span class="op">&amp;</span>trace<span class="op">-&gt;</span>instructions<span class="op">[</span>i <span class="op">+</span> <span class="dv">1</span><span class="op">];</span></span>
<span id="cb194-7"><a href="#cb194-7" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb194-8"><a href="#cb194-8" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Pattern: narrow loads/stores to wider operations</span></span>
<span id="cb194-9"><a href="#cb194-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>are_adjacent_memory_ops<span class="op">(</span>inst1<span class="op">,</span> inst2<span class="op">))</span> <span class="op">{</span></span>
<span id="cb194-10"><a href="#cb194-10" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>can_combine_to_wider_op<span class="op">(</span>inst1<span class="op">,</span> inst2<span class="op">))</span> <span class="op">{</span></span>
<span id="cb194-11"><a href="#cb194-11" aria-hidden="true" tabindex="-1"></a>                combine_memory_ops<span class="op">(</span>inst1<span class="op">,</span> inst2<span class="op">);</span></span>
<span id="cb194-12"><a href="#cb194-12" aria-hidden="true" tabindex="-1"></a>                changed <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb194-13"><a href="#cb194-13" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb194-14"><a href="#cb194-14" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb194-15"><a href="#cb194-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb194-16"><a href="#cb194-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb194-17"><a href="#cb194-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> changed<span class="op">;</span></span>
<span id="cb194-18"><a href="#cb194-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>15.8 Trace-Specific Optimizations</h2>
<h3>15.8.1 Guard Motion</h3>
<div class="sourceCode" id="cb195"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb195-1"><a href="#cb195-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">bool</span> optimize_guard_placement<span class="op">(</span>Trace <span class="op">*</span>trace<span class="op">)</span> <span class="op">{</span></span>
<span id="cb195-2"><a href="#cb195-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> changed <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb195-3"><a href="#cb195-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb195-4"><a href="#cb195-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Move guards as early as possible</span></span>
<span id="cb195-5"><a href="#cb195-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> trace<span class="op">-&gt;</span>length <span class="op">-</span> <span class="dv">1</span><span class="op">;</span> i <span class="op">&gt;</span> <span class="dv">0</span><span class="op">;</span> i<span class="op">--)</span> <span class="op">{</span></span>
<span id="cb195-6"><a href="#cb195-6" aria-hidden="true" tabindex="-1"></a>        TraceInstruction <span class="op">*</span>guard <span class="op">=</span> <span class="op">&amp;</span>trace<span class="op">-&gt;</span>instructions<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb195-7"><a href="#cb195-7" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb195-8"><a href="#cb195-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(!</span>is_guard_instruction<span class="op">(</span>guard<span class="op">))</span> <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb195-9"><a href="#cb195-9" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb195-10"><a href="#cb195-10" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Find earliest safe position</span></span>
<span id="cb195-11"><a href="#cb195-11" aria-hidden="true" tabindex="-1"></a>        <span class="dt">size_t</span> earliest <span class="op">=</span> find_earliest_position<span class="op">(</span>trace<span class="op">,</span> guard<span class="op">,</span> i<span class="op">);</span></span>
<span id="cb195-12"><a href="#cb195-12" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb195-13"><a href="#cb195-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>earliest <span class="op">&lt;</span> i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb195-14"><a href="#cb195-14" aria-hidden="true" tabindex="-1"></a>            move_instruction<span class="op">(</span>trace<span class="op">,</span> i<span class="op">,</span> earliest<span class="op">);</span></span>
<span id="cb195-15"><a href="#cb195-15" aria-hidden="true" tabindex="-1"></a>            changed <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb195-16"><a href="#cb195-16" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb195-17"><a href="#cb195-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb195-18"><a href="#cb195-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb195-19"><a href="#cb195-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> changed<span class="op">;</span></span>
<span id="cb195-20"><a href="#cb195-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3>15.8.2 Exit Stub Optimization</h3>
<div class="sourceCode" id="cb196"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb196-1"><a href="#cb196-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> optimize_side_exits<span class="op">(</span>Trace <span class="op">*</span>trace<span class="op">)</span> <span class="op">{</span></span>
<span id="cb196-2"><a href="#cb196-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>SideExit <span class="op">*</span>exit <span class="op">=</span> trace<span class="op">-&gt;</span>side_exits<span class="op">;</span> exit<span class="op">;</span> exit <span class="op">=</span> exit<span class="op">-&gt;</span>next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb196-3"><a href="#cb196-3" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Minimize live state at exits</span></span>
<span id="cb196-4"><a href="#cb196-4" aria-hidden="true" tabindex="-1"></a>        minimize_exit_state<span class="op">(</span>trace<span class="op">,</span> exit<span class="op">);</span></span>
<span id="cb196-5"><a href="#cb196-5" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb196-6"><a href="#cb196-6" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Create specialized exit stubs for hot exits</span></span>
<span id="cb196-7"><a href="#cb196-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>exit<span class="op">-&gt;</span>taken_count <span class="op">&gt;</span> HOT_EXIT_THRESHOLD<span class="op">)</span> <span class="op">{</span></span>
<span id="cb196-8"><a href="#cb196-8" aria-hidden="true" tabindex="-1"></a>            create_specialized_exit_stub<span class="op">(</span>trace<span class="op">,</span> exit<span class="op">);</span></span>
<span id="cb196-9"><a href="#cb196-9" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb196-10"><a href="#cb196-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb196-11"><a href="#cb196-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>15.9 Optimization Driver</h2>
<h3>15.9.1 Pass Management</h3>
<div class="sourceCode" id="cb197"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb197-1"><a href="#cb197-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> OptimizationPass optimization_passes<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb197-2"><a href="#cb197-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Early optimizations</span></span>
<span id="cb197-3"><a href="#cb197-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span> <span class="st">&quot;guard_elimination&quot;</span><span class="op">,</span> eliminate_redundant_guards<span class="op">,</span> PASS_REPEAT<span class="op">,</span> <span class="dv">0</span> <span class="op">},</span></span>
<span id="cb197-4"><a href="#cb197-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span> <span class="st">&quot;dead_code_elimination&quot;</span><span class="op">,</span> eliminate_dead_code<span class="op">,</span> PASS_REPEAT<span class="op">,</span> <span class="dv">0</span> <span class="op">},</span></span>
<span id="cb197-5"><a href="#cb197-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb197-6"><a href="#cb197-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Mid-level optimizations</span></span>
<span id="cb197-7"><a href="#cb197-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span> <span class="st">&quot;licm&quot;</span><span class="op">,</span> hoist_invariants<span class="op">,</span> PASS_ONCE<span class="op">,</span> <span class="dv">0</span> <span class="op">},</span></span>
<span id="cb197-8"><a href="#cb197-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span> <span class="st">&quot;allocation_sinking&quot;</span><span class="op">,</span> sink_allocations<span class="op">,</span> PASS_ONCE<span class="op">,</span> <span class="dv">0</span> <span class="op">},</span></span>
<span id="cb197-9"><a href="#cb197-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb197-10"><a href="#cb197-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Late optimizations</span></span>
<span id="cb197-11"><a href="#cb197-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span> <span class="st">&quot;peephole&quot;</span><span class="op">,</span> apply_peephole_optimizations<span class="op">,</span> PASS_REPEAT<span class="op">,</span> <span class="dv">0</span> <span class="op">},</span></span>
<span id="cb197-12"><a href="#cb197-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span> <span class="st">&quot;instruction_combining&quot;</span><span class="op">,</span> combine_instructions<span class="op">,</span> PASS_REPEAT<span class="op">,</span> <span class="dv">0</span> <span class="op">},</span></span>
<span id="cb197-13"><a href="#cb197-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb197-14"><a href="#cb197-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Final cleanup</span></span>
<span id="cb197-15"><a href="#cb197-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span> <span class="st">&quot;final_dce&quot;</span><span class="op">,</span> eliminate_dead_code<span class="op">,</span> PASS_ONCE<span class="op">,</span> <span class="dv">0</span> <span class="op">}</span></span>
<span id="cb197-16"><a href="#cb197-16" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb197-17"><a href="#cb197-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb197-18"><a href="#cb197-18" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> optimize_trace<span class="op">(</span>Trace <span class="op">*</span>trace<span class="op">)</span> <span class="op">{</span></span>
<span id="cb197-19"><a href="#cb197-19" aria-hidden="true" tabindex="-1"></a>    TraceOptimizer <span class="op">*</span>optimizer <span class="op">=</span> create_trace_optimizer<span class="op">();</span></span>
<span id="cb197-20"><a href="#cb197-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb197-21"><a href="#cb197-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Run optimization passes</span></span>
<span id="cb197-22"><a href="#cb197-22" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> changed <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb197-23"><a href="#cb197-23" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> iteration <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb197-24"><a href="#cb197-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb197-25"><a href="#cb197-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span>changed <span class="op">&amp;&amp;</span> iteration <span class="op">&lt;</span> MAX_OPT_ITERATIONS<span class="op">)</span> <span class="op">{</span></span>
<span id="cb197-26"><a href="#cb197-26" aria-hidden="true" tabindex="-1"></a>        changed <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb197-27"><a href="#cb197-27" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb197-28"><a href="#cb197-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> ARRAY_SIZE<span class="op">(</span>optimization_passes<span class="op">);</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb197-29"><a href="#cb197-29" aria-hidden="true" tabindex="-1"></a>            OptimizationPass <span class="op">*</span>pass <span class="op">=</span> <span class="op">&amp;</span>optimization_passes<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb197-30"><a href="#cb197-30" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb197-31"><a href="#cb197-31" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>pass<span class="op">-&gt;</span>flags <span class="op">&amp;</span> PASS_REPEAT <span class="op">||</span> pass<span class="op">-&gt;</span>iterations <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb197-32"><a href="#cb197-32" aria-hidden="true" tabindex="-1"></a>                <span class="dt">bool</span> pass_changed <span class="op">=</span> pass<span class="op">-&gt;</span>optimize<span class="op">(</span>trace<span class="op">,</span> optimizer<span class="op">-&gt;</span>dataflow<span class="op">);</span></span>
<span id="cb197-33"><a href="#cb197-33" aria-hidden="true" tabindex="-1"></a>                changed <span class="op">|=</span> pass_changed<span class="op">;</span></span>
<span id="cb197-34"><a href="#cb197-34" aria-hidden="true" tabindex="-1"></a>                pass<span class="op">-&gt;</span>iterations<span class="op">++;</span></span>
<span id="cb197-35"><a href="#cb197-35" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb197-36"><a href="#cb197-36" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span>pass_changed<span class="op">)</span> <span class="op">{</span></span>
<span id="cb197-37"><a href="#cb197-37" aria-hidden="true" tabindex="-1"></a>                    update_dataflow_info<span class="op">(</span>optimizer<span class="op">-&gt;</span>dataflow<span class="op">,</span> trace<span class="op">);</span></span>
<span id="cb197-38"><a href="#cb197-38" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb197-39"><a href="#cb197-39" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb197-40"><a href="#cb197-40" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb197-41"><a href="#cb197-41" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb197-42"><a href="#cb197-42" aria-hidden="true" tabindex="-1"></a>        iteration<span class="op">++;</span></span>
<span id="cb197-43"><a href="#cb197-43" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb197-44"><a href="#cb197-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb197-45"><a href="#cb197-45" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Final verification</span></span>
<span id="cb197-46"><a href="#cb197-46" aria-hidden="true" tabindex="-1"></a>    verify_trace_consistency<span class="op">(</span>trace<span class="op">);</span></span>
<span id="cb197-47"><a href="#cb197-47" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>15.10 Performance Monitoring</h2>
<h3>15.10.1 Optimization Statistics</h3>
<div class="sourceCode" id="cb198"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb198-1"><a href="#cb198-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> OptimizationStats <span class="op">{</span></span>
<span id="cb198-2"><a href="#cb198-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Guard optimizations</span></span>
<span id="cb198-3"><a href="#cb198-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint64_t</span> guards_eliminated<span class="op">;</span></span>
<span id="cb198-4"><a href="#cb198-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint64_t</span> guards_strengthened<span class="op">;</span></span>
<span id="cb198-5"><a href="#cb198-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint64_t</span> guards_combined<span class="op">;</span></span>
<span id="cb198-6"><a href="#cb198-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb198-7"><a href="#cb198-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Code motion</span></span>
<span id="cb198-8"><a href="#cb198-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint64_t</span> invariants_hoisted<span class="op">;</span></span>
<span id="cb198-9"><a href="#cb198-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint64_t</span> allocations_sunk<span class="op">;</span></span>
<span id="cb198-10"><a href="#cb198-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb198-11"><a href="#cb198-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Peephole</span></span>
<span id="cb198-12"><a href="#cb198-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint64_t</span> peephole_matches<span class="op">;</span></span>
<span id="cb198-13"><a href="#cb198-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint64_t</span> instructions_combined<span class="op">;</span></span>
<span id="cb198-14"><a href="#cb198-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb198-15"><a href="#cb198-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Overall impact</span></span>
<span id="cb198-16"><a href="#cb198-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint64_t</span> instructions_before<span class="op">;</span></span>
<span id="cb198-17"><a href="#cb198-17" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint64_t</span> instructions_after<span class="op">;</span></span>
<span id="cb198-18"><a href="#cb198-18" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint64_t</span> estimated_cycles_saved<span class="op">;</span></span>
<span id="cb198-19"><a href="#cb198-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> OptimizationStats<span class="op">;</span></span>
<span id="cb198-20"><a href="#cb198-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb198-21"><a href="#cb198-21" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> report_optimization_stats<span class="op">(</span>Trace <span class="op">*</span>trace<span class="op">)</span> <span class="op">{</span></span>
<span id="cb198-22"><a href="#cb198-22" aria-hidden="true" tabindex="-1"></a>    OptimizationStats <span class="op">*</span>stats <span class="op">=</span> <span class="op">&amp;</span>trace<span class="op">-&gt;</span>optimizer<span class="op">-&gt;</span>stats<span class="op">;</span></span>
<span id="cb198-23"><a href="#cb198-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb198-24"><a href="#cb198-24" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> reduction <span class="op">=</span> <span class="fl">100.0</span> <span class="op">*</span> <span class="op">(</span>stats<span class="op">-&gt;</span>instructions_before <span class="op">-</span> </span>
<span id="cb198-25"><a href="#cb198-25" aria-hidden="true" tabindex="-1"></a>                               stats<span class="op">-&gt;</span>instructions_after<span class="op">)</span> <span class="op">/</span> </span>
<span id="cb198-26"><a href="#cb198-26" aria-hidden="true" tabindex="-1"></a>                               stats<span class="op">-&gt;</span>instructions_before<span class="op">;</span></span>
<span id="cb198-27"><a href="#cb198-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb198-28"><a href="#cb198-28" aria-hidden="true" tabindex="-1"></a>    trace_log<span class="op">(</span><span class="st">&quot;Trace </span><span class="sc">%u</span><span class="st"> optimization: </span><span class="sc">%zu</span><span class="st"> -&gt; </span><span class="sc">%zu</span><span class="st"> instructions (</span><span class="sc">%.1f%%</span><span class="st"> reduction)&quot;</span><span class="op">,</span></span>
<span id="cb198-29"><a href="#cb198-29" aria-hidden="true" tabindex="-1"></a>              trace<span class="op">-&gt;</span>id<span class="op">,</span></span>
<span id="cb198-30"><a href="#cb198-30" aria-hidden="true" tabindex="-1"></a>              stats<span class="op">-&gt;</span>instructions_before<span class="op">,</span></span>
<span id="cb198-31"><a href="#cb198-31" aria-hidden="true" tabindex="-1"></a>              stats<span class="op">-&gt;</span>instructions_after<span class="op">,</span></span>
<span id="cb198-32"><a href="#cb198-32" aria-hidden="true" tabindex="-1"></a>              reduction<span class="op">);</span></span>
<span id="cb198-33"><a href="#cb198-33" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>This chapter sets up the foundation for Chapter 16, which will cover
the native code generation from these optimized traces.</p>
<h1>Chapter 16: Native Code Generation</h1>
<h2>16.1 Introduction</h2>
<p>This chapter details Diyrbal&#39;s native code generation system,
transforming optimized traces into efficient machine code. We implement
multi-architecture support with sophisticated register allocation,
instruction selection, and target-specific optimizations.</p>
<h2>16.2 Code Generation Architecture</h2>
<h3>16.2.1 Core Components</h3>
<div class="sourceCode" id="cb199"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb199-1"><a href="#cb199-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> CodeGenerator <span class="op">{</span></span>
<span id="cb199-2"><a href="#cb199-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Target architecture</span></span>
<span id="cb199-3"><a href="#cb199-3" aria-hidden="true" tabindex="-1"></a>    TargetArch arch<span class="op">;</span></span>
<span id="cb199-4"><a href="#cb199-4" aria-hidden="true" tabindex="-1"></a>    TargetInfo <span class="op">*</span>target_info<span class="op">;</span></span>
<span id="cb199-5"><a href="#cb199-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb199-6"><a href="#cb199-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Code emission</span></span>
<span id="cb199-7"><a href="#cb199-7" aria-hidden="true" tabindex="-1"></a>    CodeBuffer <span class="op">*</span>code_buffer<span class="op">;</span></span>
<span id="cb199-8"><a href="#cb199-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint8_t</span> <span class="op">*</span>code_ptr<span class="op">;</span></span>
<span id="cb199-9"><a href="#cb199-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> code_size<span class="op">;</span></span>
<span id="cb199-10"><a href="#cb199-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb199-11"><a href="#cb199-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Register allocation</span></span>
<span id="cb199-12"><a href="#cb199-12" aria-hidden="true" tabindex="-1"></a>    RegisterAllocator <span class="op">*</span>reg_alloc<span class="op">;</span></span>
<span id="cb199-13"><a href="#cb199-13" aria-hidden="true" tabindex="-1"></a>    RegisterFile <span class="op">*</span>reg_file<span class="op">;</span></span>
<span id="cb199-14"><a href="#cb199-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb199-15"><a href="#cb199-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Instruction selection</span></span>
<span id="cb199-16"><a href="#cb199-16" aria-hidden="true" tabindex="-1"></a>    InstructionSelector <span class="op">*</span>selector<span class="op">;</span></span>
<span id="cb199-17"><a href="#cb199-17" aria-hidden="true" tabindex="-1"></a>    PatternMatcher <span class="op">*</span>matcher<span class="op">;</span></span>
<span id="cb199-18"><a href="#cb199-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb199-19"><a href="#cb199-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Relocations and patching</span></span>
<span id="cb199-20"><a href="#cb199-20" aria-hidden="true" tabindex="-1"></a>    RelocationList <span class="op">*</span>relocations<span class="op">;</span></span>
<span id="cb199-21"><a href="#cb199-21" aria-hidden="true" tabindex="-1"></a>    PatchPointList <span class="op">*</span>patch_points<span class="op">;</span></span>
<span id="cb199-22"><a href="#cb199-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb199-23"><a href="#cb199-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Debug info</span></span>
<span id="cb199-24"><a href="#cb199-24" aria-hidden="true" tabindex="-1"></a>    DebugInfoBuilder <span class="op">*</span>debug_info<span class="op">;</span></span>
<span id="cb199-25"><a href="#cb199-25" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> CodeGenerator<span class="op">;</span></span>
<span id="cb199-26"><a href="#cb199-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb199-27"><a href="#cb199-27" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">enum</span> <span class="op">{</span></span>
<span id="cb199-28"><a href="#cb199-28" aria-hidden="true" tabindex="-1"></a>    ARCH_X86_64<span class="op">,</span></span>
<span id="cb199-29"><a href="#cb199-29" aria-hidden="true" tabindex="-1"></a>    ARCH_AARCH64<span class="op">,</span></span>
<span id="cb199-30"><a href="#cb199-30" aria-hidden="true" tabindex="-1"></a>    ARCH_RISCV64</span>
<span id="cb199-31"><a href="#cb199-31" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> TargetArch<span class="op">;</span></span></code></pre></div>
<h3>16.2.2 Code Buffer Management</h3>
<div class="sourceCode" id="cb200"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb200-1"><a href="#cb200-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> CodeBuffer <span class="op">{</span></span>
<span id="cb200-2"><a href="#cb200-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint8_t</span> <span class="op">*</span>buffer<span class="op">;</span></span>
<span id="cb200-3"><a href="#cb200-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> capacity<span class="op">;</span></span>
<span id="cb200-4"><a href="#cb200-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> position<span class="op">;</span></span>
<span id="cb200-5"><a href="#cb200-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb200-6"><a href="#cb200-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Sections</span></span>
<span id="cb200-7"><a href="#cb200-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> prologue_offset<span class="op">;</span></span>
<span id="cb200-8"><a href="#cb200-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> body_offset<span class="op">;</span></span>
<span id="cb200-9"><a href="#cb200-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> epilogue_offset<span class="op">;</span></span>
<span id="cb200-10"><a href="#cb200-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> stub_offset<span class="op">;</span></span>
<span id="cb200-11"><a href="#cb200-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb200-12"><a href="#cb200-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Alignment tracking</span></span>
<span id="cb200-13"><a href="#cb200-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> alignment<span class="op">;</span></span>
<span id="cb200-14"><a href="#cb200-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint8_t</span> nop_fill<span class="op">[</span><span class="dv">16</span><span class="op">];</span></span>
<span id="cb200-15"><a href="#cb200-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> CodeBuffer<span class="op">;</span></span>
<span id="cb200-16"><a href="#cb200-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb200-17"><a href="#cb200-17" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> emit_bytes<span class="op">(</span>CodeBuffer <span class="op">*</span>buf<span class="op">,</span> <span class="dt">const</span> <span class="dt">uint8_t</span> <span class="op">*</span>bytes<span class="op">,</span> <span class="dt">size_t</span> len<span class="op">)</span> <span class="op">{</span></span>
<span id="cb200-18"><a href="#cb200-18" aria-hidden="true" tabindex="-1"></a>    ensure_capacity<span class="op">(</span>buf<span class="op">,</span> len<span class="op">);</span></span>
<span id="cb200-19"><a href="#cb200-19" aria-hidden="true" tabindex="-1"></a>    memcpy<span class="op">(</span>buf<span class="op">-&gt;</span>buffer <span class="op">+</span> buf<span class="op">-&gt;</span>position<span class="op">,</span> bytes<span class="op">,</span> len<span class="op">);</span></span>
<span id="cb200-20"><a href="#cb200-20" aria-hidden="true" tabindex="-1"></a>    buf<span class="op">-&gt;</span>position <span class="op">+=</span> len<span class="op">;</span></span>
<span id="cb200-21"><a href="#cb200-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb200-22"><a href="#cb200-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb200-23"><a href="#cb200-23" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> align_code<span class="op">(</span>CodeBuffer <span class="op">*</span>buf<span class="op">,</span> <span class="dt">size_t</span> alignment<span class="op">)</span> <span class="op">{</span></span>
<span id="cb200-24"><a href="#cb200-24" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> current <span class="op">=</span> buf<span class="op">-&gt;</span>position<span class="op">;</span></span>
<span id="cb200-25"><a href="#cb200-25" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> aligned <span class="op">=</span> ALIGN_UP<span class="op">(</span>current<span class="op">,</span> alignment<span class="op">);</span></span>
<span id="cb200-26"><a href="#cb200-26" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> padding <span class="op">=</span> aligned <span class="op">-</span> current<span class="op">;</span></span>
<span id="cb200-27"><a href="#cb200-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb200-28"><a href="#cb200-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>padding <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb200-29"><a href="#cb200-29" aria-hidden="true" tabindex="-1"></a>        emit_nop_sequence<span class="op">(</span>buf<span class="op">,</span> padding<span class="op">);</span></span>
<span id="cb200-30"><a href="#cb200-30" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb200-31"><a href="#cb200-31" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>16.3 Register Allocation</h2>
<h3>16.3.1 Linear Scan Allocator</h3>
<div class="sourceCode" id="cb201"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb201-1"><a href="#cb201-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> LiveInterval <span class="op">{</span></span>
<span id="cb201-2"><a href="#cb201-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> vreg<span class="op">;</span>      <span class="co">// Virtual register</span></span>
<span id="cb201-3"><a href="#cb201-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> start<span class="op">;</span>       <span class="co">// Start position</span></span>
<span id="cb201-4"><a href="#cb201-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> end<span class="op">;</span>         <span class="co">// End position</span></span>
<span id="cb201-5"><a href="#cb201-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb201-6"><a href="#cb201-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Physical register assignment</span></span>
<span id="cb201-7"><a href="#cb201-7" aria-hidden="true" tabindex="-1"></a>    Register assigned<span class="op">;</span></span>
<span id="cb201-8"><a href="#cb201-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> spilled<span class="op">;</span></span>
<span id="cb201-9"><a href="#cb201-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int32_t</span> spill_slot<span class="op">;</span></span>
<span id="cb201-10"><a href="#cb201-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb201-11"><a href="#cb201-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Use positions for splitting</span></span>
<span id="cb201-12"><a href="#cb201-12" aria-hidden="true" tabindex="-1"></a>    UsePositionList <span class="op">*</span>use_positions<span class="op">;</span></span>
<span id="cb201-13"><a href="#cb201-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> LiveInterval <span class="op">*</span>next<span class="op">;</span></span>
<span id="cb201-14"><a href="#cb201-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> LiveInterval<span class="op">;</span></span>
<span id="cb201-15"><a href="#cb201-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb201-16"><a href="#cb201-16" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> allocate_registers<span class="op">(</span>CodeGenerator <span class="op">*</span>gen<span class="op">,</span> Trace <span class="op">*</span>trace<span class="op">)</span> <span class="op">{</span></span>
<span id="cb201-17"><a href="#cb201-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Build live intervals</span></span>
<span id="cb201-18"><a href="#cb201-18" aria-hidden="true" tabindex="-1"></a>    LiveInterval <span class="op">*</span>intervals <span class="op">=</span> build_live_intervals<span class="op">(</span>trace<span class="op">);</span></span>
<span id="cb201-19"><a href="#cb201-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb201-20"><a href="#cb201-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Sort by start position</span></span>
<span id="cb201-21"><a href="#cb201-21" aria-hidden="true" tabindex="-1"></a>    sort_intervals_by_start<span class="op">(</span>intervals<span class="op">);</span></span>
<span id="cb201-22"><a href="#cb201-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb201-23"><a href="#cb201-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Linear scan allocation</span></span>
<span id="cb201-24"><a href="#cb201-24" aria-hidden="true" tabindex="-1"></a>    RegisterSet available <span class="op">=</span> gen<span class="op">-&gt;</span>reg_file<span class="op">-&gt;</span>allocatable<span class="op">;</span></span>
<span id="cb201-25"><a href="#cb201-25" aria-hidden="true" tabindex="-1"></a>    LiveInterval <span class="op">*</span>active <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb201-26"><a href="#cb201-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb201-27"><a href="#cb201-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>LiveInterval <span class="op">*</span>current <span class="op">=</span> intervals<span class="op">;</span> current<span class="op">;</span> current <span class="op">=</span> current<span class="op">-&gt;</span>next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb201-28"><a href="#cb201-28" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Expire old intervals</span></span>
<span id="cb201-29"><a href="#cb201-29" aria-hidden="true" tabindex="-1"></a>        expire_old_intervals<span class="op">(&amp;</span>active<span class="op">,</span> current<span class="op">-&gt;</span>start<span class="op">,</span> <span class="op">&amp;</span>available<span class="op">);</span></span>
<span id="cb201-30"><a href="#cb201-30" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb201-31"><a href="#cb201-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>has_available_register<span class="op">(</span>available<span class="op">))</span> <span class="op">{</span></span>
<span id="cb201-32"><a href="#cb201-32" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Allocate register</span></span>
<span id="cb201-33"><a href="#cb201-33" aria-hidden="true" tabindex="-1"></a>            Register reg <span class="op">=</span> allocate_register<span class="op">(&amp;</span>available<span class="op">,</span> current<span class="op">);</span></span>
<span id="cb201-34"><a href="#cb201-34" aria-hidden="true" tabindex="-1"></a>            current<span class="op">-&gt;</span>assigned <span class="op">=</span> reg<span class="op">;</span></span>
<span id="cb201-35"><a href="#cb201-35" aria-hidden="true" tabindex="-1"></a>            add_to_active<span class="op">(&amp;</span>active<span class="op">,</span> current<span class="op">);</span></span>
<span id="cb201-36"><a href="#cb201-36" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb201-37"><a href="#cb201-37" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Spill</span></span>
<span id="cb201-38"><a href="#cb201-38" aria-hidden="true" tabindex="-1"></a>            spill_at_interval<span class="op">(</span>gen<span class="op">,</span> current<span class="op">,</span> active<span class="op">);</span></span>
<span id="cb201-39"><a href="#cb201-39" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb201-40"><a href="#cb201-40" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb201-41"><a href="#cb201-41" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3>16.3.2 Spilling and Reloading</h3>
<div class="sourceCode" id="cb202"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb202-1"><a href="#cb202-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> SpillSlot <span class="op">{</span></span>
<span id="cb202-2"><a href="#cb202-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int32_t</span> offset<span class="op">;</span>     <span class="co">// Offset from frame pointer</span></span>
<span id="cb202-3"><a href="#cb202-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> size<span class="op">;</span>        <span class="co">// Slot size</span></span>
<span id="cb202-4"><a href="#cb202-4" aria-hidden="true" tabindex="-1"></a>    ValueType type<span class="op">;</span>     <span class="co">// Type of spilled value</span></span>
<span id="cb202-5"><a href="#cb202-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> SpillSlot<span class="op">;</span></span>
<span id="cb202-6"><a href="#cb202-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb202-7"><a href="#cb202-7" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> spill_at_interval<span class="op">(</span>CodeGenerator <span class="op">*</span>gen<span class="op">,</span> </span>
<span id="cb202-8"><a href="#cb202-8" aria-hidden="true" tabindex="-1"></a>                              LiveInterval <span class="op">*</span>current<span class="op">,</span></span>
<span id="cb202-9"><a href="#cb202-9" aria-hidden="true" tabindex="-1"></a>                              LiveInterval <span class="op">*</span>active<span class="op">)</span> <span class="op">{</span></span>
<span id="cb202-10"><a href="#cb202-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Find best candidate to spill</span></span>
<span id="cb202-11"><a href="#cb202-11" aria-hidden="true" tabindex="-1"></a>    LiveInterval <span class="op">*</span>spill <span class="op">=</span> find_spill_candidate<span class="op">(</span>active<span class="op">,</span> current<span class="op">);</span></span>
<span id="cb202-12"><a href="#cb202-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb202-13"><a href="#cb202-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>spill<span class="op">-&gt;</span>end <span class="op">&gt;</span> current<span class="op">-&gt;</span>end<span class="op">)</span> <span class="op">{</span></span>
<span id="cb202-14"><a href="#cb202-14" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Spill the other interval</span></span>
<span id="cb202-15"><a href="#cb202-15" aria-hidden="true" tabindex="-1"></a>        current<span class="op">-&gt;</span>assigned <span class="op">=</span> spill<span class="op">-&gt;</span>assigned<span class="op">;</span></span>
<span id="cb202-16"><a href="#cb202-16" aria-hidden="true" tabindex="-1"></a>        spill<span class="op">-&gt;</span>assigned <span class="op">=</span> REG_NONE<span class="op">;</span></span>
<span id="cb202-17"><a href="#cb202-17" aria-hidden="true" tabindex="-1"></a>        spill<span class="op">-&gt;</span>spilled <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb202-18"><a href="#cb202-18" aria-hidden="true" tabindex="-1"></a>        spill<span class="op">-&gt;</span>spill_slot <span class="op">=</span> allocate_spill_slot<span class="op">(</span>gen<span class="op">,</span> spill<span class="op">);</span></span>
<span id="cb202-19"><a href="#cb202-19" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb202-20"><a href="#cb202-20" aria-hidden="true" tabindex="-1"></a>        remove_from_active<span class="op">(&amp;</span>active<span class="op">,</span> spill<span class="op">);</span></span>
<span id="cb202-21"><a href="#cb202-21" aria-hidden="true" tabindex="-1"></a>        add_to_active<span class="op">(&amp;</span>active<span class="op">,</span> current<span class="op">);</span></span>
<span id="cb202-22"><a href="#cb202-22" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb202-23"><a href="#cb202-23" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Insert spill/reload code</span></span>
<span id="cb202-24"><a href="#cb202-24" aria-hidden="true" tabindex="-1"></a>        insert_spill_code<span class="op">(</span>gen<span class="op">,</span> spill<span class="op">);</span></span>
<span id="cb202-25"><a href="#cb202-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb202-26"><a href="#cb202-26" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Spill current</span></span>
<span id="cb202-27"><a href="#cb202-27" aria-hidden="true" tabindex="-1"></a>        current<span class="op">-&gt;</span>spilled <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb202-28"><a href="#cb202-28" aria-hidden="true" tabindex="-1"></a>        current<span class="op">-&gt;</span>spill_slot <span class="op">=</span> allocate_spill_slot<span class="op">(</span>gen<span class="op">,</span> current<span class="op">);</span></span>
<span id="cb202-29"><a href="#cb202-29" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb202-30"><a href="#cb202-30" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3>16.3.3 Register Classes</h3>
<div class="sourceCode" id="cb203"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb203-1"><a href="#cb203-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> RegisterClass <span class="op">{</span></span>
<span id="cb203-2"><a href="#cb203-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>name<span class="op">;</span></span>
<span id="cb203-3"><a href="#cb203-3" aria-hidden="true" tabindex="-1"></a>    RegisterSet members<span class="op">;</span></span>
<span id="cb203-4"><a href="#cb203-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> size<span class="op">;</span>           <span class="co">// Register size in bytes</span></span>
<span id="cb203-5"><a href="#cb203-5" aria-hidden="true" tabindex="-1"></a>    RegisterType type<span class="op">;</span>     <span class="co">// GPR, FPR, SIMD</span></span>
<span id="cb203-6"><a href="#cb203-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> RegisterClass<span class="op">;</span></span>
<span id="cb203-7"><a href="#cb203-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb203-8"><a href="#cb203-8" aria-hidden="true" tabindex="-1"></a><span class="co">// x86-64 register classes</span></span>
<span id="cb203-9"><a href="#cb203-9" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> RegisterClass x64_reg_classes<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb203-10"><a href="#cb203-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb203-11"><a href="#cb203-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>name <span class="op">=</span> <span class="st">&quot;gpr64&quot;</span><span class="op">,</span></span>
<span id="cb203-12"><a href="#cb203-12" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>members <span class="op">=</span> GPR64_MASK<span class="op">,</span></span>
<span id="cb203-13"><a href="#cb203-13" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>size <span class="op">=</span> <span class="dv">8</span><span class="op">,</span></span>
<span id="cb203-14"><a href="#cb203-14" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>type <span class="op">=</span> REG_TYPE_GPR</span>
<span id="cb203-15"><a href="#cb203-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">},</span></span>
<span id="cb203-16"><a href="#cb203-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb203-17"><a href="#cb203-17" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>name <span class="op">=</span> <span class="st">&quot;xmm&quot;</span><span class="op">,</span></span>
<span id="cb203-18"><a href="#cb203-18" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>members <span class="op">=</span> XMM_MASK<span class="op">,</span></span>
<span id="cb203-19"><a href="#cb203-19" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>size <span class="op">=</span> <span class="dv">16</span><span class="op">,</span></span>
<span id="cb203-20"><a href="#cb203-20" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>type <span class="op">=</span> REG_TYPE_SIMD</span>
<span id="cb203-21"><a href="#cb203-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb203-22"><a href="#cb203-22" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb203-23"><a href="#cb203-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb203-24"><a href="#cb203-24" aria-hidden="true" tabindex="-1"></a><span class="co">// AArch64 register classes</span></span>
<span id="cb203-25"><a href="#cb203-25" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> RegisterClass aarch64_reg_classes<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb203-26"><a href="#cb203-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb203-27"><a href="#cb203-27" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>name <span class="op">=</span> <span class="st">&quot;x_regs&quot;</span><span class="op">,</span></span>
<span id="cb203-28"><a href="#cb203-28" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>members <span class="op">=</span> X_REG_MASK<span class="op">,</span></span>
<span id="cb203-29"><a href="#cb203-29" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>size <span class="op">=</span> <span class="dv">8</span><span class="op">,</span></span>
<span id="cb203-30"><a href="#cb203-30" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>type <span class="op">=</span> REG_TYPE_GPR</span>
<span id="cb203-31"><a href="#cb203-31" aria-hidden="true" tabindex="-1"></a>    <span class="op">},</span></span>
<span id="cb203-32"><a href="#cb203-32" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb203-33"><a href="#cb203-33" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>name <span class="op">=</span> <span class="st">&quot;v_regs&quot;</span><span class="op">,</span></span>
<span id="cb203-34"><a href="#cb203-34" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>members <span class="op">=</span> V_REG_MASK<span class="op">,</span></span>
<span id="cb203-35"><a href="#cb203-35" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>size <span class="op">=</span> <span class="dv">16</span><span class="op">,</span></span>
<span id="cb203-36"><a href="#cb203-36" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>type <span class="op">=</span> REG_TYPE_SIMD</span>
<span id="cb203-37"><a href="#cb203-37" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb203-38"><a href="#cb203-38" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<h2>16.4 Instruction Selection</h2>
<h3>16.4.1 Pattern-Based Selection</h3>
<div class="sourceCode" id="cb204"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb204-1"><a href="#cb204-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> InstructionPattern <span class="op">{</span></span>
<span id="cb204-2"><a href="#cb204-2" aria-hidden="true" tabindex="-1"></a>    TraceOpcode trace_op<span class="op">;</span></span>
<span id="cb204-3"><a href="#cb204-3" aria-hidden="true" tabindex="-1"></a>    TargetInstruction target_inst<span class="op">;</span></span>
<span id="cb204-4"><a href="#cb204-4" aria-hidden="true" tabindex="-1"></a>    CostModel cost<span class="op">;</span></span>
<span id="cb204-5"><a href="#cb204-5" aria-hidden="true" tabindex="-1"></a>    PatternPredicate predicate<span class="op">;</span></span>
<span id="cb204-6"><a href="#cb204-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> InstructionPattern<span class="op">;</span></span>
<span id="cb204-7"><a href="#cb204-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb204-8"><a href="#cb204-8" aria-hidden="true" tabindex="-1"></a><span class="co">// x86-64 patterns</span></span>
<span id="cb204-9"><a href="#cb204-9" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> InstructionPattern x64_patterns<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb204-10"><a href="#cb204-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Simple arithmetic</span></span>
<span id="cb204-11"><a href="#cb204-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span> OP_ADD<span class="op">,</span> X64_ADD<span class="op">,</span> <span class="op">{</span> <span class="op">.</span>latency <span class="op">=</span> <span class="dv">1</span><span class="op">,</span> <span class="op">.</span>size <span class="op">=</span> <span class="dv">3</span> <span class="op">},</span> NULL <span class="op">},</span></span>
<span id="cb204-12"><a href="#cb204-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span> OP_SUB<span class="op">,</span> X64_SUB<span class="op">,</span> <span class="op">{</span> <span class="op">.</span>latency <span class="op">=</span> <span class="dv">1</span><span class="op">,</span> <span class="op">.</span>size <span class="op">=</span> <span class="dv">3</span> <span class="op">},</span> NULL <span class="op">},</span></span>
<span id="cb204-13"><a href="#cb204-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb204-14"><a href="#cb204-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Optimized patterns</span></span>
<span id="cb204-15"><a href="#cb204-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span> OP_ADD<span class="op">,</span> X64_LEA<span class="op">,</span> <span class="op">{</span> <span class="op">.</span>latency <span class="op">=</span> <span class="dv">1</span><span class="op">,</span> <span class="op">.</span>size <span class="op">=</span> <span class="dv">3</span> <span class="op">},</span> is_lea_candidate <span class="op">},</span></span>
<span id="cb204-16"><a href="#cb204-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span> OP_MUL<span class="op">,</span> X64_IMUL<span class="op">,</span> <span class="op">{</span> <span class="op">.</span>latency <span class="op">=</span> <span class="dv">3</span><span class="op">,</span> <span class="op">.</span>size <span class="op">=</span> <span class="dv">3</span> <span class="op">},</span> NULL <span class="op">},</span></span>
<span id="cb204-17"><a href="#cb204-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb204-18"><a href="#cb204-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Memory operations</span></span>
<span id="cb204-19"><a href="#cb204-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span> OP_LOAD<span class="op">,</span> X64_MOV<span class="op">,</span> <span class="op">{</span> <span class="op">.</span>latency <span class="op">=</span> <span class="dv">4</span><span class="op">,</span> <span class="op">.</span>size <span class="op">=</span> <span class="dv">3</span> <span class="op">},</span> NULL <span class="op">},</span></span>
<span id="cb204-20"><a href="#cb204-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span> OP_STORE<span class="op">,</span> X64_MOV<span class="op">,</span> <span class="op">{</span> <span class="op">.</span>latency <span class="op">=</span> <span class="dv">1</span><span class="op">,</span> <span class="op">.</span>size <span class="op">=</span> <span class="dv">3</span> <span class="op">},</span> NULL <span class="op">}</span></span>
<span id="cb204-21"><a href="#cb204-21" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb204-22"><a href="#cb204-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb204-23"><a href="#cb204-23" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> select_instructions<span class="op">(</span>CodeGenerator <span class="op">*</span>gen<span class="op">,</span> Trace <span class="op">*</span>trace<span class="op">)</span> <span class="op">{</span></span>
<span id="cb204-24"><a href="#cb204-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> trace<span class="op">-&gt;</span>length<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb204-25"><a href="#cb204-25" aria-hidden="true" tabindex="-1"></a>        TraceInstruction <span class="op">*</span>inst <span class="op">=</span> <span class="op">&amp;</span>trace<span class="op">-&gt;</span>instructions<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb204-26"><a href="#cb204-26" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb204-27"><a href="#cb204-27" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Find matching patterns</span></span>
<span id="cb204-28"><a href="#cb204-28" aria-hidden="true" tabindex="-1"></a>        InstructionPattern <span class="op">*</span>best <span class="op">=</span> find_best_pattern<span class="op">(</span>gen<span class="op">,</span> inst<span class="op">);</span></span>
<span id="cb204-29"><a href="#cb204-29" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb204-30"><a href="#cb204-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>best<span class="op">)</span> <span class="op">{</span></span>
<span id="cb204-31"><a href="#cb204-31" aria-hidden="true" tabindex="-1"></a>            emit_target_instruction<span class="op">(</span>gen<span class="op">,</span> best<span class="op">,</span> inst<span class="op">);</span></span>
<span id="cb204-32"><a href="#cb204-32" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb204-33"><a href="#cb204-33" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Fallback to generic emission</span></span>
<span id="cb204-34"><a href="#cb204-34" aria-hidden="true" tabindex="-1"></a>            emit_generic_instruction<span class="op">(</span>gen<span class="op">,</span> inst<span class="op">);</span></span>
<span id="cb204-35"><a href="#cb204-35" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb204-36"><a href="#cb204-36" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb204-37"><a href="#cb204-37" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3>16.4.2 Complex Pattern Matching</h3>
<div class="sourceCode" id="cb205"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb205-1"><a href="#cb205-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">bool</span> match_address_computation<span class="op">(</span>CodeGenerator <span class="op">*</span>gen<span class="op">,</span></span>
<span id="cb205-2"><a href="#cb205-2" aria-hidden="true" tabindex="-1"></a>                                     TraceInstruction <span class="op">*</span>inst<span class="op">,</span></span>
<span id="cb205-3"><a href="#cb205-3" aria-hidden="true" tabindex="-1"></a>                                     AddressMode <span class="op">*</span>mode<span class="op">)</span> <span class="op">{</span></span>
<span id="cb205-4"><a href="#cb205-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Pattern: base + index * scale + displacement</span></span>
<span id="cb205-5"><a href="#cb205-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>inst<span class="op">-&gt;</span>opcode <span class="op">==</span> OP_ADD<span class="op">)</span> <span class="op">{</span></span>
<span id="cb205-6"><a href="#cb205-6" aria-hidden="true" tabindex="-1"></a>        TraceInstruction <span class="op">*</span>left <span class="op">=</span> get_definition<span class="op">(</span>inst<span class="op">-&gt;</span>operands<span class="op">[</span><span class="dv">0</span><span class="op">]);</span></span>
<span id="cb205-7"><a href="#cb205-7" aria-hidden="true" tabindex="-1"></a>        TraceInstruction <span class="op">*</span>right <span class="op">=</span> get_definition<span class="op">(</span>inst<span class="op">-&gt;</span>operands<span class="op">[</span><span class="dv">1</span><span class="op">]);</span></span>
<span id="cb205-8"><a href="#cb205-8" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb205-9"><a href="#cb205-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>left <span class="op">&amp;&amp;</span> left<span class="op">-&gt;</span>opcode <span class="op">==</span> OP_MUL<span class="op">)</span> <span class="op">{</span></span>
<span id="cb205-10"><a href="#cb205-10" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Found index * scale</span></span>
<span id="cb205-11"><a href="#cb205-11" aria-hidden="true" tabindex="-1"></a>            mode<span class="op">-&gt;</span>base <span class="op">=</span> inst<span class="op">-&gt;</span>operands<span class="op">[</span><span class="dv">1</span><span class="op">];</span></span>
<span id="cb205-12"><a href="#cb205-12" aria-hidden="true" tabindex="-1"></a>            mode<span class="op">-&gt;</span>index <span class="op">=</span> left<span class="op">-&gt;</span>operands<span class="op">[</span><span class="dv">0</span><span class="op">];</span></span>
<span id="cb205-13"><a href="#cb205-13" aria-hidden="true" tabindex="-1"></a>            mode<span class="op">-&gt;</span>scale <span class="op">=</span> get_constant_value<span class="op">(</span>left<span class="op">-&gt;</span>operands<span class="op">[</span><span class="dv">1</span><span class="op">]);</span></span>
<span id="cb205-14"><a href="#cb205-14" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> is_valid_scale<span class="op">(</span>mode<span class="op">-&gt;</span>scale<span class="op">);</span></span>
<span id="cb205-15"><a href="#cb205-15" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb205-16"><a href="#cb205-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb205-17"><a href="#cb205-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb205-18"><a href="#cb205-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb205-19"><a href="#cb205-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>16.5 Target-Specific Code Emission</h2>
<h3>16.5.1 x86-64 Code Generation</h3>
<div class="sourceCode" id="cb206"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb206-1"><a href="#cb206-1" aria-hidden="true" tabindex="-1"></a><span class="co">// x86-64 specific emitters</span></span>
<span id="cb206-2"><a href="#cb206-2" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> emit_x64_add<span class="op">(</span>CodeGenerator <span class="op">*</span>gen<span class="op">,</span> </span>
<span id="cb206-3"><a href="#cb206-3" aria-hidden="true" tabindex="-1"></a>                         Register dest<span class="op">,</span> </span>
<span id="cb206-4"><a href="#cb206-4" aria-hidden="true" tabindex="-1"></a>                         Register src1<span class="op">,</span> </span>
<span id="cb206-5"><a href="#cb206-5" aria-hidden="true" tabindex="-1"></a>                         Register src2<span class="op">)</span> <span class="op">{</span></span>
<span id="cb206-6"><a href="#cb206-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint8_t</span> rex <span class="op">=</span> compute_rex<span class="op">(</span>dest<span class="op">,</span> src1<span class="op">,</span> src2<span class="op">);</span></span>
<span id="cb206-7"><a href="#cb206-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb206-8"><a href="#cb206-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>rex<span class="op">)</span> emit_byte<span class="op">(</span>gen<span class="op">,</span> rex<span class="op">);</span></span>
<span id="cb206-9"><a href="#cb206-9" aria-hidden="true" tabindex="-1"></a>    emit_byte<span class="op">(</span>gen<span class="op">,</span> <span class="bn">0x01</span><span class="op">);</span>  <span class="co">// ADD r/m64, r64</span></span>
<span id="cb206-10"><a href="#cb206-10" aria-hidden="true" tabindex="-1"></a>    emit_modrm<span class="op">(</span>gen<span class="op">,</span> dest<span class="op">,</span> src2<span class="op">);</span></span>
<span id="cb206-11"><a href="#cb206-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb206-12"><a href="#cb206-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb206-13"><a href="#cb206-13" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> emit_x64_load<span class="op">(</span>CodeGenerator <span class="op">*</span>gen<span class="op">,</span></span>
<span id="cb206-14"><a href="#cb206-14" aria-hidden="true" tabindex="-1"></a>                         Register dest<span class="op">,</span></span>
<span id="cb206-15"><a href="#cb206-15" aria-hidden="true" tabindex="-1"></a>                         Register base<span class="op">,</span></span>
<span id="cb206-16"><a href="#cb206-16" aria-hidden="true" tabindex="-1"></a>                         <span class="dt">int32_t</span> offset<span class="op">)</span> <span class="op">{</span></span>
<span id="cb206-17"><a href="#cb206-17" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint8_t</span> rex <span class="op">=</span> REX_W <span class="op">|</span> rex_r<span class="op">(</span>dest<span class="op">)</span> <span class="op">|</span> rex_b<span class="op">(</span>base<span class="op">);</span></span>
<span id="cb206-18"><a href="#cb206-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb206-19"><a href="#cb206-19" aria-hidden="true" tabindex="-1"></a>    emit_byte<span class="op">(</span>gen<span class="op">,</span> rex<span class="op">);</span></span>
<span id="cb206-20"><a href="#cb206-20" aria-hidden="true" tabindex="-1"></a>    emit_byte<span class="op">(</span>gen<span class="op">,</span> <span class="bn">0x8B</span><span class="op">);</span>  <span class="co">// MOV r64, m64</span></span>
<span id="cb206-21"><a href="#cb206-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb206-22"><a href="#cb206-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>offset <span class="op">==</span> <span class="dv">0</span> <span class="op">&amp;&amp;</span> base <span class="op">!=</span> RBP<span class="op">)</span> <span class="op">{</span></span>
<span id="cb206-23"><a href="#cb206-23" aria-hidden="true" tabindex="-1"></a>        emit_modrm<span class="op">(</span>gen<span class="op">,</span> dest<span class="op">,</span> base<span class="op">);</span></span>
<span id="cb206-24"><a href="#cb206-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>fits_in_byte<span class="op">(</span>offset<span class="op">))</span> <span class="op">{</span></span>
<span id="cb206-25"><a href="#cb206-25" aria-hidden="true" tabindex="-1"></a>        emit_modrm_sib<span class="op">(</span>gen<span class="op">,</span> MOD_DISP8<span class="op">,</span> dest<span class="op">,</span> base<span class="op">);</span></span>
<span id="cb206-26"><a href="#cb206-26" aria-hidden="true" tabindex="-1"></a>        emit_byte<span class="op">(</span>gen<span class="op">,</span> offset<span class="op">);</span></span>
<span id="cb206-27"><a href="#cb206-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb206-28"><a href="#cb206-28" aria-hidden="true" tabindex="-1"></a>        emit_modrm_sib<span class="op">(</span>gen<span class="op">,</span> MOD_DISP32<span class="op">,</span> dest<span class="op">,</span> base<span class="op">);</span></span>
<span id="cb206-29"><a href="#cb206-29" aria-hidden="true" tabindex="-1"></a>        emit_int32<span class="op">(</span>gen<span class="op">,</span> offset<span class="op">);</span></span>
<span id="cb206-30"><a href="#cb206-30" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb206-31"><a href="#cb206-31" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb206-32"><a href="#cb206-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb206-33"><a href="#cb206-33" aria-hidden="true" tabindex="-1"></a><span class="co">// Optimized instruction sequences</span></span>
<span id="cb206-34"><a href="#cb206-34" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> emit_x64_lea_complex<span class="op">(</span>CodeGenerator <span class="op">*</span>gen<span class="op">,</span></span>
<span id="cb206-35"><a href="#cb206-35" aria-hidden="true" tabindex="-1"></a>                                 Register dest<span class="op">,</span></span>
<span id="cb206-36"><a href="#cb206-36" aria-hidden="true" tabindex="-1"></a>                                 AddressMode <span class="op">*</span>addr<span class="op">)</span> <span class="op">{</span></span>
<span id="cb206-37"><a href="#cb206-37" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint8_t</span> rex <span class="op">=</span> REX_W <span class="op">|</span> rex_r<span class="op">(</span>dest<span class="op">);</span></span>
<span id="cb206-38"><a href="#cb206-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb206-39"><a href="#cb206-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>addr<span class="op">-&gt;</span>index <span class="op">!=</span> REG_NONE<span class="op">)</span> <span class="op">{</span></span>
<span id="cb206-40"><a href="#cb206-40" aria-hidden="true" tabindex="-1"></a>        rex <span class="op">|=</span> rex_x<span class="op">(</span>addr<span class="op">-&gt;</span>index<span class="op">);</span></span>
<span id="cb206-41"><a href="#cb206-41" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb206-42"><a href="#cb206-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>addr<span class="op">-&gt;</span>base <span class="op">!=</span> REG_NONE<span class="op">)</span> <span class="op">{</span></span>
<span id="cb206-43"><a href="#cb206-43" aria-hidden="true" tabindex="-1"></a>        rex <span class="op">|=</span> rex_b<span class="op">(</span>addr<span class="op">-&gt;</span>base<span class="op">);</span></span>
<span id="cb206-44"><a href="#cb206-44" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb206-45"><a href="#cb206-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb206-46"><a href="#cb206-46" aria-hidden="true" tabindex="-1"></a>    emit_byte<span class="op">(</span>gen<span class="op">,</span> rex<span class="op">);</span></span>
<span id="cb206-47"><a href="#cb206-47" aria-hidden="true" tabindex="-1"></a>    emit_byte<span class="op">(</span>gen<span class="op">,</span> <span class="bn">0x8D</span><span class="op">);</span>  <span class="co">// LEA r64, m</span></span>
<span id="cb206-48"><a href="#cb206-48" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb206-49"><a href="#cb206-49" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Emit complex addressing mode</span></span>
<span id="cb206-50"><a href="#cb206-50" aria-hidden="true" tabindex="-1"></a>    emit_sib<span class="op">(</span>gen<span class="op">,</span> addr<span class="op">-&gt;</span>scale<span class="op">,</span> addr<span class="op">-&gt;</span>index<span class="op">,</span> addr<span class="op">-&gt;</span>base<span class="op">);</span></span>
<span id="cb206-51"><a href="#cb206-51" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb206-52"><a href="#cb206-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>addr<span class="op">-&gt;</span>displacement <span class="op">!=</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb206-53"><a href="#cb206-53" aria-hidden="true" tabindex="-1"></a>        emit_int32<span class="op">(</span>gen<span class="op">,</span> addr<span class="op">-&gt;</span>displacement<span class="op">);</span></span>
<span id="cb206-54"><a href="#cb206-54" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb206-55"><a href="#cb206-55" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3>16.5.2 AArch64 Code Generation</h3>
<div class="sourceCode" id="cb207"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb207-1"><a href="#cb207-1" aria-hidden="true" tabindex="-1"></a><span class="co">// AArch64 specific emitters</span></span>
<span id="cb207-2"><a href="#cb207-2" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> emit_arm64_add<span class="op">(</span>CodeGenerator <span class="op">*</span>gen<span class="op">,</span></span>
<span id="cb207-3"><a href="#cb207-3" aria-hidden="true" tabindex="-1"></a>                           Register dest<span class="op">,</span></span>
<span id="cb207-4"><a href="#cb207-4" aria-hidden="true" tabindex="-1"></a>                           Register src1<span class="op">,</span></span>
<span id="cb207-5"><a href="#cb207-5" aria-hidden="true" tabindex="-1"></a>                           Register src2<span class="op">)</span> <span class="op">{</span></span>
<span id="cb207-6"><a href="#cb207-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> inst <span class="op">=</span> <span class="bn">0x8B000000</span><span class="op">;</span>  <span class="co">// ADD X&lt;d&gt;, X&lt;n&gt;, X&lt;m&gt;</span></span>
<span id="cb207-7"><a href="#cb207-7" aria-hidden="true" tabindex="-1"></a>    inst <span class="op">|=</span> <span class="op">(</span>dest <span class="op">&amp;</span> <span class="bn">0x1F</span><span class="op">);</span></span>
<span id="cb207-8"><a href="#cb207-8" aria-hidden="true" tabindex="-1"></a>    inst <span class="op">|=</span> <span class="op">((</span>src1 <span class="op">&amp;</span> <span class="bn">0x1F</span><span class="op">)</span> <span class="op">&lt;&lt;</span> <span class="dv">5</span><span class="op">);</span></span>
<span id="cb207-9"><a href="#cb207-9" aria-hidden="true" tabindex="-1"></a>    inst <span class="op">|=</span> <span class="op">((</span>src2 <span class="op">&amp;</span> <span class="bn">0x1F</span><span class="op">)</span> <span class="op">&lt;&lt;</span> <span class="dv">16</span><span class="op">);</span></span>
<span id="cb207-10"><a href="#cb207-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb207-11"><a href="#cb207-11" aria-hidden="true" tabindex="-1"></a>    emit_word<span class="op">(</span>gen<span class="op">,</span> inst<span class="op">);</span></span>
<span id="cb207-12"><a href="#cb207-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb207-13"><a href="#cb207-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb207-14"><a href="#cb207-14" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> emit_arm64_load<span class="op">(</span>CodeGenerator <span class="op">*</span>gen<span class="op">,</span></span>
<span id="cb207-15"><a href="#cb207-15" aria-hidden="true" tabindex="-1"></a>                            Register dest<span class="op">,</span></span>
<span id="cb207-16"><a href="#cb207-16" aria-hidden="true" tabindex="-1"></a>                            Register base<span class="op">,</span></span>
<span id="cb207-17"><a href="#cb207-17" aria-hidden="true" tabindex="-1"></a>                            <span class="dt">int32_t</span> offset<span class="op">)</span> <span class="op">{</span></span>
<span id="cb207-18"><a href="#cb207-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>offset <span class="op">&gt;=</span> <span class="op">-</span><span class="dv">256</span> <span class="op">&amp;&amp;</span> offset <span class="op">&lt;=</span> <span class="dv">255</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb207-19"><a href="#cb207-19" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Unscaled immediate</span></span>
<span id="cb207-20"><a href="#cb207-20" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint32_t</span> inst <span class="op">=</span> <span class="bn">0xF8400000</span><span class="op">;</span>  <span class="co">// LDUR X&lt;t&gt;, [X&lt;n&gt;, #imm]</span></span>
<span id="cb207-21"><a href="#cb207-21" aria-hidden="true" tabindex="-1"></a>        inst <span class="op">|=</span> <span class="op">(</span>dest <span class="op">&amp;</span> <span class="bn">0x1F</span><span class="op">);</span></span>
<span id="cb207-22"><a href="#cb207-22" aria-hidden="true" tabindex="-1"></a>        inst <span class="op">|=</span> <span class="op">((</span>base <span class="op">&amp;</span> <span class="bn">0x1F</span><span class="op">)</span> <span class="op">&lt;&lt;</span> <span class="dv">5</span><span class="op">);</span></span>
<span id="cb207-23"><a href="#cb207-23" aria-hidden="true" tabindex="-1"></a>        inst <span class="op">|=</span> <span class="op">((</span>offset <span class="op">&amp;</span> <span class="bn">0x1FF</span><span class="op">)</span> <span class="op">&lt;&lt;</span> <span class="dv">12</span><span class="op">);</span></span>
<span id="cb207-24"><a href="#cb207-24" aria-hidden="true" tabindex="-1"></a>        emit_word<span class="op">(</span>gen<span class="op">,</span> inst<span class="op">);</span></span>
<span id="cb207-25"><a href="#cb207-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb207-26"><a href="#cb207-26" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Load with register offset</span></span>
<span id="cb207-27"><a href="#cb207-27" aria-hidden="true" tabindex="-1"></a>        emit_arm64_add_immediate<span class="op">(</span>gen<span class="op">,</span> ARM64_TEMP_REG<span class="op">,</span> base<span class="op">,</span> offset<span class="op">);</span></span>
<span id="cb207-28"><a href="#cb207-28" aria-hidden="true" tabindex="-1"></a>        emit_arm64_load_indirect<span class="op">(</span>gen<span class="op">,</span> dest<span class="op">,</span> ARM64_TEMP_REG<span class="op">);</span></span>
<span id="cb207-29"><a href="#cb207-29" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb207-30"><a href="#cb207-30" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb207-31"><a href="#cb207-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb207-32"><a href="#cb207-32" aria-hidden="true" tabindex="-1"></a><span class="co">// Optimized sequences for AArch64</span></span>
<span id="cb207-33"><a href="#cb207-33" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> emit_arm64_madd<span class="op">(</span>CodeGenerator <span class="op">*</span>gen<span class="op">,</span></span>
<span id="cb207-34"><a href="#cb207-34" aria-hidden="true" tabindex="-1"></a>                            Register dest<span class="op">,</span></span>
<span id="cb207-35"><a href="#cb207-35" aria-hidden="true" tabindex="-1"></a>                            Register src1<span class="op">,</span></span>
<span id="cb207-36"><a href="#cb207-36" aria-hidden="true" tabindex="-1"></a>                            Register src2<span class="op">,</span></span>
<span id="cb207-37"><a href="#cb207-37" aria-hidden="true" tabindex="-1"></a>                            Register addend<span class="op">)</span> <span class="op">{</span></span>
<span id="cb207-38"><a href="#cb207-38" aria-hidden="true" tabindex="-1"></a>    <span class="co">// MADD: dest = src1 * src2 + addend</span></span>
<span id="cb207-39"><a href="#cb207-39" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> inst <span class="op">=</span> <span class="bn">0x9B000000</span><span class="op">;</span></span>
<span id="cb207-40"><a href="#cb207-40" aria-hidden="true" tabindex="-1"></a>    inst <span class="op">|=</span> <span class="op">(</span>dest <span class="op">&amp;</span> <span class="bn">0x1F</span><span class="op">);</span></span>
<span id="cb207-41"><a href="#cb207-41" aria-hidden="true" tabindex="-1"></a>    inst <span class="op">|=</span> <span class="op">((</span>src1 <span class="op">&amp;</span> <span class="bn">0x1F</span><span class="op">)</span> <span class="op">&lt;&lt;</span> <span class="dv">5</span><span class="op">);</span></span>
<span id="cb207-42"><a href="#cb207-42" aria-hidden="true" tabindex="-1"></a>    inst <span class="op">|=</span> <span class="op">((</span>addend <span class="op">&amp;</span> <span class="bn">0x1F</span><span class="op">)</span> <span class="op">&lt;&lt;</span> <span class="dv">10</span><span class="op">);</span></span>
<span id="cb207-43"><a href="#cb207-43" aria-hidden="true" tabindex="-1"></a>    inst <span class="op">|=</span> <span class="op">((</span>src2 <span class="op">&amp;</span> <span class="bn">0x1F</span><span class="op">)</span> <span class="op">&lt;&lt;</span> <span class="dv">16</span><span class="op">);</span></span>
<span id="cb207-44"><a href="#cb207-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb207-45"><a href="#cb207-45" aria-hidden="true" tabindex="-1"></a>    emit_word<span class="op">(</span>gen<span class="op">,</span> inst<span class="op">);</span></span>
<span id="cb207-46"><a href="#cb207-46" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>16.6 Guard and Side Exit Generation</h2>
<h3>16.6.1 Guard Code Generation</h3>
<div class="sourceCode" id="cb208"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb208-1"><a href="#cb208-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> emit_guard<span class="op">(</span>CodeGenerator <span class="op">*</span>gen<span class="op">,</span> Guard <span class="op">*</span>guard<span class="op">,</span> SideExit <span class="op">*</span>exit<span class="op">)</span> <span class="op">{</span></span>
<span id="cb208-2"><a href="#cb208-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> <span class="op">(</span>guard<span class="op">-&gt;</span>type<span class="op">)</span> <span class="op">{</span></span>
<span id="cb208-3"><a href="#cb208-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> GUARD_TYPE<span class="op">:</span></span>
<span id="cb208-4"><a href="#cb208-4" aria-hidden="true" tabindex="-1"></a>        emit_type_guard<span class="op">(</span>gen<span class="op">,</span> guard<span class="op">,</span> exit<span class="op">);</span></span>
<span id="cb208-5"><a href="#cb208-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb208-6"><a href="#cb208-6" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb208-7"><a href="#cb208-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> GUARD_BOUNDS<span class="op">:</span></span>
<span id="cb208-8"><a href="#cb208-8" aria-hidden="true" tabindex="-1"></a>        emit_bounds_guard<span class="op">(</span>gen<span class="op">,</span> guard<span class="op">,</span> exit<span class="op">);</span></span>
<span id="cb208-9"><a href="#cb208-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb208-10"><a href="#cb208-10" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb208-11"><a href="#cb208-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> GUARD_OVERFLOW<span class="op">:</span></span>
<span id="cb208-12"><a href="#cb208-12" aria-hidden="true" tabindex="-1"></a>        emit_overflow_guard<span class="op">(</span>gen<span class="op">,</span> guard<span class="op">,</span> exit<span class="op">);</span></span>
<span id="cb208-13"><a href="#cb208-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb208-14"><a href="#cb208-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb208-15"><a href="#cb208-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb208-16"><a href="#cb208-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb208-17"><a href="#cb208-17" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> emit_type_guard<span class="op">(</span>CodeGenerator <span class="op">*</span>gen<span class="op">,</span> Guard <span class="op">*</span>guard<span class="op">,</span> SideExit <span class="op">*</span>exit<span class="op">)</span> <span class="op">{</span></span>
<span id="cb208-18"><a href="#cb208-18" aria-hidden="true" tabindex="-1"></a>    Register obj_reg <span class="op">=</span> get_register<span class="op">(</span>gen<span class="op">,</span> guard<span class="op">-&gt;</span>data<span class="op">.</span>type_guard<span class="op">.</span>value_id<span class="op">);</span></span>
<span id="cb208-19"><a href="#cb208-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb208-20"><a href="#cb208-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>gen<span class="op">-&gt;</span>arch <span class="op">==</span> ARCH_X86_64<span class="op">)</span> <span class="op">{</span></span>
<span id="cb208-21"><a href="#cb208-21" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Load type field</span></span>
<span id="cb208-22"><a href="#cb208-22" aria-hidden="true" tabindex="-1"></a>        emit_x64_load<span class="op">(</span>gen<span class="op">,</span> TEMP_REG<span class="op">,</span> obj_reg<span class="op">,</span> OBJECT_TYPE_OFFSET<span class="op">);</span></span>
<span id="cb208-23"><a href="#cb208-23" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb208-24"><a href="#cb208-24" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Compare with expected type</span></span>
<span id="cb208-25"><a href="#cb208-25" aria-hidden="true" tabindex="-1"></a>        emit_x64_cmp_immediate<span class="op">(</span>gen<span class="op">,</span> TEMP_REG<span class="op">,</span> guard<span class="op">-&gt;</span>data<span class="op">.</span>type_guard<span class="op">.</span>expected_type<span class="op">);</span></span>
<span id="cb208-26"><a href="#cb208-26" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb208-27"><a href="#cb208-27" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Conditional jump to side exit</span></span>
<span id="cb208-28"><a href="#cb208-28" aria-hidden="true" tabindex="-1"></a>        emit_x64_jne<span class="op">(</span>gen<span class="op">,</span> <span class="dv">0</span><span class="op">);</span>  <span class="co">// Placeholder</span></span>
<span id="cb208-29"><a href="#cb208-29" aria-hidden="true" tabindex="-1"></a>        add_patch_point<span class="op">(</span>gen<span class="op">,</span> PATCH_GUARD_EXIT<span class="op">,</span> exit<span class="op">);</span></span>
<span id="cb208-30"><a href="#cb208-30" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>gen<span class="op">-&gt;</span>arch <span class="op">==</span> ARCH_AARCH64<span class="op">)</span> <span class="op">{</span></span>
<span id="cb208-31"><a href="#cb208-31" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Similar for ARM64</span></span>
<span id="cb208-32"><a href="#cb208-32" aria-hidden="true" tabindex="-1"></a>        emit_arm64_load<span class="op">(</span>gen<span class="op">,</span> ARM64_TEMP_REG<span class="op">,</span> obj_reg<span class="op">,</span> OBJECT_TYPE_OFFSET<span class="op">);</span></span>
<span id="cb208-33"><a href="#cb208-33" aria-hidden="true" tabindex="-1"></a>        emit_arm64_cmp_immediate<span class="op">(</span>gen<span class="op">,</span> ARM64_TEMP_REG<span class="op">,</span> </span>
<span id="cb208-34"><a href="#cb208-34" aria-hidden="true" tabindex="-1"></a>                                guard<span class="op">-&gt;</span>data<span class="op">.</span>type_guard<span class="op">.</span>expected_type<span class="op">);</span></span>
<span id="cb208-35"><a href="#cb208-35" aria-hidden="true" tabindex="-1"></a>        emit_arm64_bne<span class="op">(</span>gen<span class="op">,</span> <span class="dv">0</span><span class="op">);</span>  <span class="co">// Placeholder</span></span>
<span id="cb208-36"><a href="#cb208-36" aria-hidden="true" tabindex="-1"></a>        add_patch_point<span class="op">(</span>gen<span class="op">,</span> PATCH_GUARD_EXIT<span class="op">,</span> exit<span class="op">);</span></span>
<span id="cb208-37"><a href="#cb208-37" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb208-38"><a href="#cb208-38" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3>16.6.2 Side Exit Stubs</h3>
<div class="sourceCode" id="cb209"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb209-1"><a href="#cb209-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> generate_side_exit_stub<span class="op">(</span>CodeGenerator <span class="op">*</span>gen<span class="op">,</span> SideExit <span class="op">*</span>exit<span class="op">)</span> <span class="op">{</span></span>
<span id="cb209-2"><a href="#cb209-2" aria-hidden="true" tabindex="-1"></a>    exit<span class="op">-&gt;</span>stub_offset <span class="op">=</span> gen<span class="op">-&gt;</span>code_buffer<span class="op">-&gt;</span>position<span class="op">;</span></span>
<span id="cb209-3"><a href="#cb209-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb209-4"><a href="#cb209-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Save live registers</span></span>
<span id="cb209-5"><a href="#cb209-5" aria-hidden="true" tabindex="-1"></a>    emit_save_live_registers<span class="op">(</span>gen<span class="op">,</span> exit<span class="op">-&gt;</span>live_values<span class="op">);</span></span>
<span id="cb209-6"><a href="#cb209-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb209-7"><a href="#cb209-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Prepare deoptimization frame</span></span>
<span id="cb209-8"><a href="#cb209-8" aria-hidden="true" tabindex="-1"></a>    emit_prepare_deopt_frame<span class="op">(</span>gen<span class="op">,</span> exit<span class="op">-&gt;</span>frame_state<span class="op">);</span></span>
<span id="cb209-9"><a href="#cb209-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb209-10"><a href="#cb209-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Call deoptimization handler</span></span>
<span id="cb209-11"><a href="#cb209-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>gen<span class="op">-&gt;</span>arch <span class="op">==</span> ARCH_X86_64<span class="op">)</span> <span class="op">{</span></span>
<span id="cb209-12"><a href="#cb209-12" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Load exit ID</span></span>
<span id="cb209-13"><a href="#cb209-13" aria-hidden="true" tabindex="-1"></a>        emit_x64_mov_immediate<span class="op">(</span>gen<span class="op">,</span> RDI<span class="op">,</span> exit<span class="op">-&gt;</span>id<span class="op">);</span></span>
<span id="cb209-14"><a href="#cb209-14" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb209-15"><a href="#cb209-15" aria-hidden="true" tabindex="-1"></a>        <span class="co">//</span></span>
<span id="cb209-16"><a href="#cb209-16" aria-hidden="true" tabindex="-1"></a><span class="pp"># </span><span class="er">Chapter 17: Profiling and Instrumentation</span></span>
<span id="cb209-17"><a href="#cb209-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb209-18"><a href="#cb209-18" aria-hidden="true" tabindex="-1"></a><span class="pp">#</span><span class="er"># 17.1 Introduction</span></span>
<span id="cb209-19"><a href="#cb209-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb209-20"><a href="#cb209-20" aria-hidden="true" tabindex="-1"></a>This chapter covers Diyrbal<span class="ch">&#39;s</span><span class="er"> comprehensive profiling and instrumentation framework. We implement low-overhead profiling for hot spot detection, type feedback collection, and performance monitoring, along with a flexible instrumentation API for debugging and analysis.</span></span>
<span id="cb209-21"><a href="#cb209-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb209-22"><a href="#cb209-22" aria-hidden="true" tabindex="-1"></a><span class="pp">#</span><span class="er"># 17.2 Profiling Architecture</span></span>
<span id="cb209-23"><a href="#cb209-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb209-24"><a href="#cb209-24" aria-hidden="true" tabindex="-1"></a><span class="pp">#</span><span class="er">## 17.2.1 Core Components</span></span>
<span id="cb209-25"><a href="#cb209-25" aria-hidden="true" tabindex="-1"></a>```c</span>
<span id="cb209-26"><a href="#cb209-26" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> Profiler <span class="op">{</span></span>
<span id="cb209-27"><a href="#cb209-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Profile data storage</span></span>
<span id="cb209-28"><a href="#cb209-28" aria-hidden="true" tabindex="-1"></a>    ProfileDatabase <span class="op">*</span>database<span class="op">;</span></span>
<span id="cb209-29"><a href="#cb209-29" aria-hidden="true" tabindex="-1"></a>    TypeProfileTable <span class="op">*</span>type_profiles<span class="op">;</span></span>
<span id="cb209-30"><a href="#cb209-30" aria-hidden="true" tabindex="-1"></a>    EdgeProfileTable <span class="op">*</span>edge_profiles<span class="op">;</span></span>
<span id="cb209-31"><a href="#cb209-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb209-32"><a href="#cb209-32" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Sampling infrastructure</span></span>
<span id="cb209-33"><a href="#cb209-33" aria-hidden="true" tabindex="-1"></a>    SampleBuffer <span class="op">*</span>sample_buffer<span class="op">;</span></span>
<span id="cb209-34"><a href="#cb209-34" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> sample_interval<span class="op">;</span></span>
<span id="cb209-35"><a href="#cb209-35" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint64_t</span> sample_count<span class="op">;</span></span>
<span id="cb209-36"><a href="#cb209-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb209-37"><a href="#cb209-37" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Hot spot tracking</span></span>
<span id="cb209-38"><a href="#cb209-38" aria-hidden="true" tabindex="-1"></a>    HotMethodTable <span class="op">*</span>hot_methods<span class="op">;</span></span>
<span id="cb209-39"><a href="#cb209-39" aria-hidden="true" tabindex="-1"></a>    HotLoopTable <span class="op">*</span>hot_loops<span class="op">;</span></span>
<span id="cb209-40"><a href="#cb209-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb209-41"><a href="#cb209-41" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Instrumentation</span></span>
<span id="cb209-42"><a href="#cb209-42" aria-hidden="true" tabindex="-1"></a>    InstrumentationEngine <span class="op">*</span>instr_engine<span class="op">;</span></span>
<span id="cb209-43"><a href="#cb209-43" aria-hidden="true" tabindex="-1"></a>    CallbackRegistry <span class="op">*</span>callbacks<span class="op">;</span></span>
<span id="cb209-44"><a href="#cb209-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb209-45"><a href="#cb209-45" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Configuration</span></span>
<span id="cb209-46"><a href="#cb209-46" aria-hidden="true" tabindex="-1"></a>    ProfileConfig config<span class="op">;</span></span>
<span id="cb209-47"><a href="#cb209-47" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> enabled<span class="op">;</span></span>
<span id="cb209-48"><a href="#cb209-48" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> Profiler<span class="op">;</span></span>
<span id="cb209-49"><a href="#cb209-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb209-50"><a href="#cb209-50" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> ProfileDatabase <span class="op">{</span></span>
<span id="cb209-51"><a href="#cb209-51" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Method profiles</span></span>
<span id="cb209-52"><a href="#cb209-52" aria-hidden="true" tabindex="-1"></a>    MethodProfile <span class="op">**</span>method_profiles<span class="op">;</span></span>
<span id="cb209-53"><a href="#cb209-53" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> method_count<span class="op">;</span></span>
<span id="cb209-54"><a href="#cb209-54" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb209-55"><a href="#cb209-55" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Call site profiles  </span></span>
<span id="cb209-56"><a href="#cb209-56" aria-hidden="true" tabindex="-1"></a>    CallSiteProfile <span class="op">**</span>call_profiles<span class="op">;</span></span>
<span id="cb209-57"><a href="#cb209-57" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> call_count<span class="op">;</span></span>
<span id="cb209-58"><a href="#cb209-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb209-59"><a href="#cb209-59" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Memory management</span></span>
<span id="cb209-60"><a href="#cb209-60" aria-hidden="true" tabindex="-1"></a>    ProfileArena <span class="op">*</span>arena<span class="op">;</span></span>
<span id="cb209-61"><a href="#cb209-61" aria-hidden="true" tabindex="-1"></a>    SpinLock lock<span class="op">;</span></span>
<span id="cb209-62"><a href="#cb209-62" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> ProfileDatabase<span class="op">;</span></span></code></pre></div>
<h3>17.2.2 Profile Data Structures</h3>
<div class="sourceCode" id="cb210"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb210-1"><a href="#cb210-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> MethodProfile <span class="op">{</span></span>
<span id="cb210-2"><a href="#cb210-2" aria-hidden="true" tabindex="-1"></a>    MethodID method_id<span class="op">;</span></span>
<span id="cb210-3"><a href="#cb210-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint64_t</span> invocation_count<span class="op">;</span></span>
<span id="cb210-4"><a href="#cb210-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint64_t</span> total_cycles<span class="op">;</span></span>
<span id="cb210-5"><a href="#cb210-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint64_t</span> self_cycles<span class="op">;</span></span>
<span id="cb210-6"><a href="#cb210-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb210-7"><a href="#cb210-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Basic block execution counts</span></span>
<span id="cb210-8"><a href="#cb210-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint64_t</span> <span class="op">*</span>bb_counters<span class="op">;</span></span>
<span id="cb210-9"><a href="#cb210-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> bb_count<span class="op">;</span></span>
<span id="cb210-10"><a href="#cb210-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb210-11"><a href="#cb210-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Call site information</span></span>
<span id="cb210-12"><a href="#cb210-12" aria-hidden="true" tabindex="-1"></a>    CallSiteProfile <span class="op">*</span>call_sites<span class="op">;</span></span>
<span id="cb210-13"><a href="#cb210-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> call_site_count<span class="op">;</span></span>
<span id="cb210-14"><a href="#cb210-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb210-15"><a href="#cb210-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Type feedback</span></span>
<span id="cb210-16"><a href="#cb210-16" aria-hidden="true" tabindex="-1"></a>    TypeProfile <span class="op">*</span>type_feedback<span class="op">;</span></span>
<span id="cb210-17"><a href="#cb210-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb210-18"><a href="#cb210-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Deoptimization history</span></span>
<span id="cb210-19"><a href="#cb210-19" aria-hidden="true" tabindex="-1"></a>    DeoptRecord <span class="op">*</span>deopt_history<span class="op">;</span></span>
<span id="cb210-20"><a href="#cb210-20" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> deopt_count<span class="op">;</span></span>
<span id="cb210-21"><a href="#cb210-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> MethodProfile<span class="op">;</span></span>
<span id="cb210-22"><a href="#cb210-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb210-23"><a href="#cb210-23" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> TypeProfile <span class="op">{</span></span>
<span id="cb210-24"><a href="#cb210-24" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Receiver type distribution</span></span>
<span id="cb210-25"><a href="#cb210-25" aria-hidden="true" tabindex="-1"></a>    TypeDistribution receiver_types<span class="op">;</span></span>
<span id="cb210-26"><a href="#cb210-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb210-27"><a href="#cb210-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Parameter type distributions</span></span>
<span id="cb210-28"><a href="#cb210-28" aria-hidden="true" tabindex="-1"></a>    TypeDistribution <span class="op">*</span>param_types<span class="op">;</span></span>
<span id="cb210-29"><a href="#cb210-29" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> param_count<span class="op">;</span></span>
<span id="cb210-30"><a href="#cb210-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb210-31"><a href="#cb210-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Return type distribution</span></span>
<span id="cb210-32"><a href="#cb210-32" aria-hidden="true" tabindex="-1"></a>    TypeDistribution return_types<span class="op">;</span></span>
<span id="cb210-33"><a href="#cb210-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb210-34"><a href="#cb210-34" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Inline cache misses</span></span>
<span id="cb210-35"><a href="#cb210-35" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint64_t</span> ic_misses<span class="op">;</span></span>
<span id="cb210-36"><a href="#cb210-36" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint64_t</span> polymorphic_calls<span class="op">;</span></span>
<span id="cb210-37"><a href="#cb210-37" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> TypeProfile<span class="op">;</span></span></code></pre></div>
<h2>17.3 Lightweight Profiling</h2>
<h3>17.3.1 Interpreter Profiling</h3>
<div class="sourceCode" id="cb211"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb211-1"><a href="#cb211-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Bytecode dispatch with profiling</span></span>
<span id="cb211-2"><a href="#cb211-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#define DISPATCH_PROFILED</span><span class="op">()</span><span class="pp"> </span><span class="cf">do</span><span class="pp"> </span><span class="op">{</span><span class="pp"> </span><span class="op">\</span></span>
<span id="cb211-3"><a href="#cb211-3" aria-hidden="true" tabindex="-1"></a><span class="pp">    </span><span class="cf">if</span><span class="pp"> </span><span class="op">(</span>UNLIKELY<span class="op">(</span><span class="pp">vm</span><span class="op">-&gt;</span><span class="pp">profiler</span><span class="op">.</span><span class="pp">enabled</span><span class="op">))</span><span class="pp"> </span><span class="op">{</span><span class="pp"> </span><span class="op">\</span></span>
<span id="cb211-4"><a href="#cb211-4" aria-hidden="true" tabindex="-1"></a><span class="pp">        </span>update_bytecode_profile<span class="op">(</span><span class="pp">frame</span><span class="op">,</span><span class="pp"> pc</span><span class="op">);</span><span class="pp"> </span><span class="op">\</span></span>
<span id="cb211-5"><a href="#cb211-5" aria-hidden="true" tabindex="-1"></a><span class="pp">    </span><span class="op">}</span><span class="pp"> </span><span class="op">\</span></span>
<span id="cb211-6"><a href="#cb211-6" aria-hidden="true" tabindex="-1"></a><span class="pp">    </span><span class="cf">goto</span><span class="pp"> </span><span class="op">*</span><span class="pp">dispatch_table</span><span class="op">[*</span><span class="pp">pc</span><span class="op">];</span><span class="pp"> </span><span class="op">\</span></span>
<span id="cb211-7"><a href="#cb211-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span><span class="pp"> </span><span class="cf">while</span><span class="op">(</span><span class="dv">0</span><span class="op">)</span></span>
<span id="cb211-8"><a href="#cb211-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-9"><a href="#cb211-9" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> update_bytecode_profile<span class="op">(</span>Frame <span class="op">*</span>frame<span class="op">,</span> <span class="dt">uint8_t</span> <span class="op">*</span>pc<span class="op">)</span> <span class="op">{</span></span>
<span id="cb211-10"><a href="#cb211-10" aria-hidden="true" tabindex="-1"></a>    MethodProfile <span class="op">*</span>profile <span class="op">=</span> get_method_profile<span class="op">(</span>frame<span class="op">-&gt;</span>method<span class="op">);</span></span>
<span id="cb211-11"><a href="#cb211-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb211-12"><a href="#cb211-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Increment bytecode counter</span></span>
<span id="cb211-13"><a href="#cb211-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> offset <span class="op">=</span> pc <span class="op">-</span> frame<span class="op">-&gt;</span>method<span class="op">-&gt;</span>bytecode<span class="op">;</span></span>
<span id="cb211-14"><a href="#cb211-14" aria-hidden="true" tabindex="-1"></a>    atomic_increment<span class="op">(&amp;</span>profile<span class="op">-&gt;</span>bc_counters<span class="op">[</span>offset<span class="op">]);</span></span>
<span id="cb211-15"><a href="#cb211-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb211-16"><a href="#cb211-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Sample type information periodically</span></span>
<span id="cb211-17"><a href="#cb211-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">((</span>profile<span class="op">-&gt;</span>bc_counters<span class="op">[</span>offset<span class="op">]</span> <span class="op">&amp;</span> SAMPLE_MASK<span class="op">)</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb211-18"><a href="#cb211-18" aria-hidden="true" tabindex="-1"></a>        collect_type_sample<span class="op">(</span>profile<span class="op">,</span> frame<span class="op">,</span> pc<span class="op">);</span></span>
<span id="cb211-19"><a href="#cb211-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb211-20"><a href="#cb211-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb211-21"><a href="#cb211-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-22"><a href="#cb211-22" aria-hidden="true" tabindex="-1"></a><span class="co">// Optimized interpreter loop with minimal overhead</span></span>
<span id="cb211-23"><a href="#cb211-23" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> OP_CALL<span class="op">:</span> <span class="op">{</span></span>
<span id="cb211-24"><a href="#cb211-24" aria-hidden="true" tabindex="-1"></a>    Value callee <span class="op">=</span> POP<span class="op">();</span></span>
<span id="cb211-25"><a href="#cb211-25" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> arg_count <span class="op">=</span> READ_BYTE<span class="op">();</span></span>
<span id="cb211-26"><a href="#cb211-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb211-27"><a href="#cb211-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>LIKELY<span class="op">(!</span>vm<span class="op">-&gt;</span>profiler<span class="op">.</span>enabled<span class="op">))</span> <span class="op">{</span></span>
<span id="cb211-28"><a href="#cb211-28" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Fast path - no profiling</span></span>
<span id="cb211-29"><a href="#cb211-29" aria-hidden="true" tabindex="-1"></a>        call_value<span class="op">(</span>callee<span class="op">,</span> arg_count<span class="op">);</span></span>
<span id="cb211-30"><a href="#cb211-30" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb211-31"><a href="#cb211-31" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Profiling path</span></span>
<span id="cb211-32"><a href="#cb211-32" aria-hidden="true" tabindex="-1"></a>        profile_call_site<span class="op">(</span>frame<span class="op">,</span> pc<span class="op">,</span> callee<span class="op">);</span></span>
<span id="cb211-33"><a href="#cb211-33" aria-hidden="true" tabindex="-1"></a>        call_value<span class="op">(</span>callee<span class="op">,</span> arg_count<span class="op">);</span></span>
<span id="cb211-34"><a href="#cb211-34" aria-hidden="true" tabindex="-1"></a>        profile_call_return<span class="op">(</span>frame<span class="op">);</span></span>
<span id="cb211-35"><a href="#cb211-35" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb211-36"><a href="#cb211-36" aria-hidden="true" tabindex="-1"></a>    DISPATCH<span class="op">();</span></span>
<span id="cb211-37"><a href="#cb211-37" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3>17.3.2 Edge Profiling</h3>
<div class="sourceCode" id="cb212"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb212-1"><a href="#cb212-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> EdgeProfile <span class="op">{</span></span>
<span id="cb212-2"><a href="#cb212-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> from_pc<span class="op">;</span></span>
<span id="cb212-3"><a href="#cb212-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> to_pc<span class="op">;</span></span>
<span id="cb212-4"><a href="#cb212-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint64_t</span> count<span class="op">;</span></span>
<span id="cb212-5"><a href="#cb212-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> probability<span class="op">;</span>  <span class="co">// Cached probability</span></span>
<span id="cb212-6"><a href="#cb212-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> EdgeProfile<span class="op">;</span></span>
<span id="cb212-7"><a href="#cb212-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb212-8"><a href="#cb212-8" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> profile_branch<span class="op">(</span>Frame <span class="op">*</span>frame<span class="op">,</span> <span class="dt">uint32_t</span> from<span class="op">,</span> <span class="dt">uint32_t</span> to<span class="op">,</span> <span class="dt">bool</span> taken<span class="op">)</span> <span class="op">{</span></span>
<span id="cb212-9"><a href="#cb212-9" aria-hidden="true" tabindex="-1"></a>    EdgeProfile <span class="op">*</span>edge <span class="op">=</span> get_edge_profile<span class="op">(</span>frame<span class="op">-&gt;</span>method<span class="op">,</span> from<span class="op">,</span> to<span class="op">);</span></span>
<span id="cb212-10"><a href="#cb212-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb212-11"><a href="#cb212-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>taken<span class="op">)</span> <span class="op">{</span></span>
<span id="cb212-12"><a href="#cb212-12" aria-hidden="true" tabindex="-1"></a>        atomic_increment<span class="op">(&amp;</span>edge<span class="op">-&gt;</span>taken_count<span class="op">);</span></span>
<span id="cb212-13"><a href="#cb212-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb212-14"><a href="#cb212-14" aria-hidden="true" tabindex="-1"></a>        atomic_increment<span class="op">(&amp;</span>edge<span class="op">-&gt;</span>not_taken_count<span class="op">);</span></span>
<span id="cb212-15"><a href="#cb212-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb212-16"><a href="#cb212-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb212-17"><a href="#cb212-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Update probability estimate periodically</span></span>
<span id="cb212-18"><a href="#cb212-18" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint64_t</span> total <span class="op">=</span> edge<span class="op">-&gt;</span>taken_count <span class="op">+</span> edge<span class="op">-&gt;</span>not_taken_count<span class="op">;</span></span>
<span id="cb212-19"><a href="#cb212-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">((</span>total <span class="op">&amp;</span> PROBABILITY_UPDATE_MASK<span class="op">)</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb212-20"><a href="#cb212-20" aria-hidden="true" tabindex="-1"></a>        edge<span class="op">-&gt;</span>probability <span class="op">=</span> <span class="op">(</span><span class="dt">float</span><span class="op">)</span>edge<span class="op">-&gt;</span>taken_count <span class="op">/</span> total<span class="op">;</span></span>
<span id="cb212-21"><a href="#cb212-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb212-22"><a href="#cb212-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3>17.3.3 Type Profiling</h3>
<div class="sourceCode" id="cb213"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb213-1"><a href="#cb213-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> TypeDistribution <span class="op">{</span></span>
<span id="cb213-2"><a href="#cb213-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb213-3"><a href="#cb213-3" aria-hidden="true" tabindex="-1"></a>        TypeID type<span class="op">;</span></span>
<span id="cb213-4"><a href="#cb213-4" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint32_t</span> count<span class="op">;</span></span>
<span id="cb213-5"><a href="#cb213-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> entries<span class="op">[</span>MAX_PROFILE_TYPES<span class="op">];</span></span>
<span id="cb213-6"><a href="#cb213-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb213-7"><a href="#cb213-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> total_count<span class="op">;</span></span>
<span id="cb213-8"><a href="#cb213-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint8_t</span> num_types<span class="op">;</span></span>
<span id="cb213-9"><a href="#cb213-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> is_monomorphic<span class="op">;</span></span>
<span id="cb213-10"><a href="#cb213-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> is_megamorphic<span class="op">;</span></span>
<span id="cb213-11"><a href="#cb213-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> TypeDistribution<span class="op">;</span></span>
<span id="cb213-12"><a href="#cb213-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb213-13"><a href="#cb213-13" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> record_type_profile<span class="op">(</span>TypeProfile <span class="op">*</span>profile<span class="op">,</span> Value value<span class="op">)</span> <span class="op">{</span></span>
<span id="cb213-14"><a href="#cb213-14" aria-hidden="true" tabindex="-1"></a>    TypeID type <span class="op">=</span> get_value_type<span class="op">(</span>value<span class="op">);</span></span>
<span id="cb213-15"><a href="#cb213-15" aria-hidden="true" tabindex="-1"></a>    TypeDistribution <span class="op">*</span>dist <span class="op">=</span> <span class="op">&amp;</span>profile<span class="op">-&gt;</span>receiver_types<span class="op">;</span></span>
<span id="cb213-16"><a href="#cb213-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb213-17"><a href="#cb213-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Fast path for monomorphic case</span></span>
<span id="cb213-18"><a href="#cb213-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>dist<span class="op">-&gt;</span>is_monomorphic <span class="op">&amp;&amp;</span> dist<span class="op">-&gt;</span>entries<span class="op">[</span><span class="dv">0</span><span class="op">].</span>type <span class="op">==</span> type<span class="op">)</span> <span class="op">{</span></span>
<span id="cb213-19"><a href="#cb213-19" aria-hidden="true" tabindex="-1"></a>        atomic_increment<span class="op">(&amp;</span>dist<span class="op">-&gt;</span>entries<span class="op">[</span><span class="dv">0</span><span class="op">].</span>count<span class="op">);</span></span>
<span id="cb213-20"><a href="#cb213-20" aria-hidden="true" tabindex="-1"></a>        atomic_increment<span class="op">(&amp;</span>dist<span class="op">-&gt;</span>total_count<span class="op">);</span></span>
<span id="cb213-21"><a href="#cb213-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span><span class="op">;</span></span>
<span id="cb213-22"><a href="#cb213-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb213-23"><a href="#cb213-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb213-24"><a href="#cb213-24" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Search existing entries</span></span>
<span id="cb213-25"><a href="#cb213-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> dist<span class="op">-&gt;</span>num_types<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb213-26"><a href="#cb213-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>dist<span class="op">-&gt;</span>entries<span class="op">[</span>i<span class="op">].</span>type <span class="op">==</span> type<span class="op">)</span> <span class="op">{</span></span>
<span id="cb213-27"><a href="#cb213-27" aria-hidden="true" tabindex="-1"></a>            atomic_increment<span class="op">(&amp;</span>dist<span class="op">-&gt;</span>entries<span class="op">[</span>i<span class="op">].</span>count<span class="op">);</span></span>
<span id="cb213-28"><a href="#cb213-28" aria-hidden="true" tabindex="-1"></a>            atomic_increment<span class="op">(&amp;</span>dist<span class="op">-&gt;</span>total_count<span class="op">);</span></span>
<span id="cb213-29"><a href="#cb213-29" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span><span class="op">;</span></span>
<span id="cb213-30"><a href="#cb213-30" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb213-31"><a href="#cb213-31" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb213-32"><a href="#cb213-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb213-33"><a href="#cb213-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Add new type</span></span>
<span id="cb213-34"><a href="#cb213-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>dist<span class="op">-&gt;</span>num_types <span class="op">&lt;</span> MAX_PROFILE_TYPES<span class="op">)</span> <span class="op">{</span></span>
<span id="cb213-35"><a href="#cb213-35" aria-hidden="true" tabindex="-1"></a>        dist<span class="op">-&gt;</span>entries<span class="op">[</span>dist<span class="op">-&gt;</span>num_types<span class="op">].</span>type <span class="op">=</span> type<span class="op">;</span></span>
<span id="cb213-36"><a href="#cb213-36" aria-hidden="true" tabindex="-1"></a>        dist<span class="op">-&gt;</span>entries<span class="op">[</span>dist<span class="op">-&gt;</span>num_types<span class="op">].</span>count <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb213-37"><a href="#cb213-37" aria-hidden="true" tabindex="-1"></a>        dist<span class="op">-&gt;</span>num_types<span class="op">++;</span></span>
<span id="cb213-38"><a href="#cb213-38" aria-hidden="true" tabindex="-1"></a>        dist<span class="op">-&gt;</span>is_monomorphic <span class="op">=</span> <span class="op">(</span>dist<span class="op">-&gt;</span>num_types <span class="op">==</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb213-39"><a href="#cb213-39" aria-hidden="true" tabindex="-1"></a>        atomic_increment<span class="op">(&amp;</span>dist<span class="op">-&gt;</span>total_count<span class="op">);</span></span>
<span id="cb213-40"><a href="#cb213-40" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb213-41"><a href="#cb213-41" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Megamorphic</span></span>
<span id="cb213-42"><a href="#cb213-42" aria-hidden="true" tabindex="-1"></a>        dist<span class="op">-&gt;</span>is_megamorphic <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb213-43"><a href="#cb213-43" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb213-44"><a href="#cb213-44" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>17.4 Sampling Profiler</h2>
<h3>17.4.1 Timer-Based Sampling</h3>
<div class="sourceCode" id="cb214"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb214-1"><a href="#cb214-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> SampleBuffer <span class="op">{</span></span>
<span id="cb214-2"><a href="#cb214-2" aria-hidden="true" tabindex="-1"></a>    Sample <span class="op">*</span>samples<span class="op">;</span></span>
<span id="cb214-3"><a href="#cb214-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> capacity<span class="op">;</span></span>
<span id="cb214-4"><a href="#cb214-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> write_pos<span class="op">;</span></span>
<span id="cb214-5"><a href="#cb214-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> read_pos<span class="op">;</span></span>
<span id="cb214-6"><a href="#cb214-6" aria-hidden="true" tabindex="-1"></a>    SpinLock lock<span class="op">;</span></span>
<span id="cb214-7"><a href="#cb214-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> SampleBuffer<span class="op">;</span></span>
<span id="cb214-8"><a href="#cb214-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb214-9"><a href="#cb214-9" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> Sample <span class="op">{</span></span>
<span id="cb214-10"><a href="#cb214-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint64_t</span> timestamp<span class="op">;</span></span>
<span id="cb214-11"><a href="#cb214-11" aria-hidden="true" tabindex="-1"></a>    ThreadID thread_id<span class="op">;</span></span>
<span id="cb214-12"><a href="#cb214-12" aria-hidden="true" tabindex="-1"></a>    CallStack stack<span class="op">;</span></span>
<span id="cb214-13"><a href="#cb214-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb214-14"><a href="#cb214-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Additional context</span></span>
<span id="cb214-15"><a href="#cb214-15" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint64_t</span> cpu_cycles<span class="op">;</span></span>
<span id="cb214-16"><a href="#cb214-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> allocated_bytes<span class="op">;</span></span>
<span id="cb214-17"><a href="#cb214-17" aria-hidden="true" tabindex="-1"></a>    CacheStats cache_stats<span class="op">;</span></span>
<span id="cb214-18"><a href="#cb214-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> Sample<span class="op">;</span></span>
<span id="cb214-19"><a href="#cb214-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb214-20"><a href="#cb214-20" aria-hidden="true" tabindex="-1"></a><span class="co">// Signal handler for sampling</span></span>
<span id="cb214-21"><a href="#cb214-21" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> sampling_signal_handler<span class="op">(</span><span class="dt">int</span> sig<span class="op">,</span> siginfo_t <span class="op">*</span>info<span class="op">,</span> <span class="dt">void</span> <span class="op">*</span>context<span class="op">)</span> <span class="op">{</span></span>
<span id="cb214-22"><a href="#cb214-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>vm<span class="op">-&gt;</span>profiler<span class="op">.</span>enabled<span class="op">)</span> <span class="cf">return</span><span class="op">;</span></span>
<span id="cb214-23"><a href="#cb214-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb214-24"><a href="#cb214-24" aria-hidden="true" tabindex="-1"></a>    Thread <span class="op">*</span>thread <span class="op">=</span> get_current_thread<span class="op">();</span></span>
<span id="cb214-25"><a href="#cb214-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>thread <span class="op">||</span> thread<span class="op">-&gt;</span>in_gc<span class="op">)</span> <span class="cf">return</span><span class="op">;</span></span>
<span id="cb214-26"><a href="#cb214-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb214-27"><a href="#cb214-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Capture stack trace</span></span>
<span id="cb214-28"><a href="#cb214-28" aria-hidden="true" tabindex="-1"></a>    Sample sample<span class="op">;</span></span>
<span id="cb214-29"><a href="#cb214-29" aria-hidden="true" tabindex="-1"></a>    sample<span class="op">.</span>timestamp <span class="op">=</span> get_timestamp<span class="op">();</span></span>
<span id="cb214-30"><a href="#cb214-30" aria-hidden="true" tabindex="-1"></a>    sample<span class="op">.</span>thread_id <span class="op">=</span> thread<span class="op">-&gt;</span>id<span class="op">;</span></span>
<span id="cb214-31"><a href="#cb214-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb214-32"><a href="#cb214-32" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Walk stack quickly</span></span>
<span id="cb214-33"><a href="#cb214-33" aria-hidden="true" tabindex="-1"></a>    capture_stack_trace<span class="op">(&amp;</span>sample<span class="op">.</span>stack<span class="op">,</span> context<span class="op">);</span></span>
<span id="cb214-34"><a href="#cb214-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb214-35"><a href="#cb214-35" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Add CPU performance counters if available</span></span>
<span id="cb214-36"><a href="#cb214-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>vm<span class="op">-&gt;</span>profiler<span class="op">.</span>config<span class="op">.</span>collect_perf_counters<span class="op">)</span> <span class="op">{</span></span>
<span id="cb214-37"><a href="#cb214-37" aria-hidden="true" tabindex="-1"></a>        read_perf_counters<span class="op">(&amp;</span>sample<span class="op">);</span></span>
<span id="cb214-38"><a href="#cb214-38" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb214-39"><a href="#cb214-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb214-40"><a href="#cb214-40" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Add to buffer (lock-free if possible)</span></span>
<span id="cb214-41"><a href="#cb214-41" aria-hidden="true" tabindex="-1"></a>    add_sample_lockfree<span class="op">(&amp;</span>vm<span class="op">-&gt;</span>profiler<span class="op">.</span>sample_buffer<span class="op">,</span> <span class="op">&amp;</span>sample<span class="op">);</span></span>
<span id="cb214-42"><a href="#cb214-42" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb214-43"><a href="#cb214-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb214-44"><a href="#cb214-44" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> setup_sampling_timer<span class="op">(</span>Profiler <span class="op">*</span>profiler<span class="op">)</span> <span class="op">{</span></span>
<span id="cb214-45"><a href="#cb214-45" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> sigaction sa<span class="op">;</span></span>
<span id="cb214-46"><a href="#cb214-46" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> itimerval timer<span class="op">;</span></span>
<span id="cb214-47"><a href="#cb214-47" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb214-48"><a href="#cb214-48" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Setup signal handler</span></span>
<span id="cb214-49"><a href="#cb214-49" aria-hidden="true" tabindex="-1"></a>    memset<span class="op">(&amp;</span>sa<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>sa<span class="op">));</span></span>
<span id="cb214-50"><a href="#cb214-50" aria-hidden="true" tabindex="-1"></a>    sa<span class="op">.</span>sa_sigaction <span class="op">=</span> sampling_signal_handler<span class="op">;</span></span>
<span id="cb214-51"><a href="#cb214-51" aria-hidden="true" tabindex="-1"></a>    sa<span class="op">.</span>sa_flags <span class="op">=</span> SA_SIGINFO <span class="op">|</span> SA_RESTART<span class="op">;</span></span>
<span id="cb214-52"><a href="#cb214-52" aria-hidden="true" tabindex="-1"></a>    sigaction<span class="op">(</span>SIGPROF<span class="op">,</span> <span class="op">&amp;</span>sa<span class="op">,</span> NULL<span class="op">);</span></span>
<span id="cb214-53"><a href="#cb214-53" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb214-54"><a href="#cb214-54" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Setup interval timer</span></span>
<span id="cb214-55"><a href="#cb214-55" aria-hidden="true" tabindex="-1"></a>    timer<span class="op">.</span>it_interval<span class="op">.</span>tv_sec <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb214-56"><a href="#cb214-56" aria-hidden="true" tabindex="-1"></a>    timer<span class="op">.</span>it_interval<span class="op">.</span>tv_usec <span class="op">=</span> profiler<span class="op">-&gt;</span>sample_interval<span class="op">;</span></span>
<span id="cb214-57"><a href="#cb214-57" aria-hidden="true" tabindex="-1"></a>    timer<span class="op">.</span>it_value <span class="op">=</span> timer<span class="op">.</span>it_interval<span class="op">;</span></span>
<span id="cb214-58"><a href="#cb214-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb214-59"><a href="#cb214-59" aria-hidden="true" tabindex="-1"></a>    setitimer<span class="op">(</span>ITIMER_PROF<span class="op">,</span> <span class="op">&amp;</span>timer<span class="op">,</span> NULL<span class="op">);</span></span>
<span id="cb214-60"><a href="#cb214-60" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3>17.4.2 Stack Walking</h3>
<div class="sourceCode" id="cb215"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb215-1"><a href="#cb215-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> capture_stack_trace<span class="op">(</span>CallStack <span class="op">*</span>stack<span class="op">,</span> <span class="dt">void</span> <span class="op">*</span>context<span class="op">)</span> <span class="op">{</span></span>
<span id="cb215-2"><a href="#cb215-2" aria-hidden="true" tabindex="-1"></a>    ucontext_t <span class="op">*</span>ucontext <span class="op">=</span> <span class="op">(</span>ucontext_t <span class="op">*)</span>context<span class="op">;</span></span>
<span id="cb215-3"><a href="#cb215-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span>pc <span class="op">=</span> <span class="op">(</span><span class="dt">void</span> <span class="op">*)</span>ucontext<span class="op">-&gt;</span>uc_mcontext<span class="op">.</span>gregs<span class="op">[</span>REG_RIP<span class="op">];</span></span>
<span id="cb215-4"><a href="#cb215-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span>sp <span class="op">=</span> <span class="op">(</span><span class="dt">void</span> <span class="op">*)</span>ucontext<span class="op">-&gt;</span>uc_mcontext<span class="op">.</span>gregs<span class="op">[</span>REG_RSP<span class="op">];</span></span>
<span id="cb215-5"><a href="#cb215-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span>fp <span class="op">=</span> <span class="op">(</span><span class="dt">void</span> <span class="op">*)</span>ucontext<span class="op">-&gt;</span>uc_mcontext<span class="op">.</span>gregs<span class="op">[</span>REG_RBP<span class="op">];</span></span>
<span id="cb215-6"><a href="#cb215-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb215-7"><a href="#cb215-7" aria-hidden="true" tabindex="-1"></a>    stack<span class="op">-&gt;</span>depth <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb215-8"><a href="#cb215-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb215-9"><a href="#cb215-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Walk native and managed frames</span></span>
<span id="cb215-10"><a href="#cb215-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span>fp <span class="op">&amp;&amp;</span> stack<span class="op">-&gt;</span>depth <span class="op">&lt;</span> MAX_STACK_DEPTH<span class="op">)</span> <span class="op">{</span></span>
<span id="cb215-11"><a href="#cb215-11" aria-hidden="true" tabindex="-1"></a>        StackFrame <span class="op">*</span>frame <span class="op">=</span> <span class="op">&amp;</span>stack<span class="op">-&gt;</span>frames<span class="op">[</span>stack<span class="op">-&gt;</span>depth<span class="op">];</span></span>
<span id="cb215-12"><a href="#cb215-12" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb215-13"><a href="#cb215-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>is_managed_code<span class="op">(</span>pc<span class="op">))</span> <span class="op">{</span></span>
<span id="cb215-14"><a href="#cb215-14" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Decode managed frame</span></span>
<span id="cb215-15"><a href="#cb215-15" aria-hidden="true" tabindex="-1"></a>            ManagedFrame <span class="op">*</span>managed <span class="op">=</span> decode_managed_frame<span class="op">(</span>fp<span class="op">,</span> pc<span class="op">);</span></span>
<span id="cb215-16"><a href="#cb215-16" aria-hidden="true" tabindex="-1"></a>            frame<span class="op">-&gt;</span>type <span class="op">=</span> FRAME_MANAGED<span class="op">;</span></span>
<span id="cb215-17"><a href="#cb215-17" aria-hidden="true" tabindex="-1"></a>            frame<span class="op">-&gt;</span>method_id <span class="op">=</span> managed<span class="op">-&gt;</span>method<span class="op">-&gt;</span>id<span class="op">;</span></span>
<span id="cb215-18"><a href="#cb215-18" aria-hidden="true" tabindex="-1"></a>            frame<span class="op">-&gt;</span>pc_offset <span class="op">=</span> pc <span class="op">-</span> managed<span class="op">-&gt;</span>method<span class="op">-&gt;</span>code<span class="op">;</span></span>
<span id="cb215-19"><a href="#cb215-19" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>is_native_code<span class="op">(</span>pc<span class="op">))</span> <span class="op">{</span></span>
<span id="cb215-20"><a href="#cb215-20" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Native frame</span></span>
<span id="cb215-21"><a href="#cb215-21" aria-hidden="true" tabindex="-1"></a>            frame<span class="op">-&gt;</span>type <span class="op">=</span> FRAME_NATIVE<span class="op">;</span></span>
<span id="cb215-22"><a href="#cb215-22" aria-hidden="true" tabindex="-1"></a>            frame<span class="op">-&gt;</span>native_pc <span class="op">=</span> pc<span class="op">;</span></span>
<span id="cb215-23"><a href="#cb215-23" aria-hidden="true" tabindex="-1"></a>            frame<span class="op">-&gt;</span>symbol <span class="op">=</span> resolve_native_symbol<span class="op">(</span>pc<span class="op">);</span></span>
<span id="cb215-24"><a href="#cb215-24" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>is_jit_code<span class="op">(</span>pc<span class="op">))</span> <span class="op">{</span></span>
<span id="cb215-25"><a href="#cb215-25" aria-hidden="true" tabindex="-1"></a>            <span class="co">// JIT compiled frame</span></span>
<span id="cb215-26"><a href="#cb215-26" aria-hidden="true" tabindex="-1"></a>            frame<span class="op">-&gt;</span>type <span class="op">=</span> FRAME_JIT<span class="op">;</span></span>
<span id="cb215-27"><a href="#cb215-27" aria-hidden="true" tabindex="-1"></a>            frame<span class="op">-&gt;</span>trace_id <span class="op">=</span> find_trace_for_pc<span class="op">(</span>pc<span class="op">);</span></span>
<span id="cb215-28"><a href="#cb215-28" aria-hidden="true" tabindex="-1"></a>            frame<span class="op">-&gt;</span>pc_offset <span class="op">=</span> pc <span class="op">-</span> get_trace_code<span class="op">(</span>frame<span class="op">-&gt;</span>trace_id<span class="op">);</span></span>
<span id="cb215-29"><a href="#cb215-29" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb215-30"><a href="#cb215-30" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb215-31"><a href="#cb215-31" aria-hidden="true" tabindex="-1"></a>        stack<span class="op">-&gt;</span>depth<span class="op">++;</span></span>
<span id="cb215-32"><a href="#cb215-32" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb215-33"><a href="#cb215-33" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Move to next frame</span></span>
<span id="cb215-34"><a href="#cb215-34" aria-hidden="true" tabindex="-1"></a>        <span class="dt">void</span> <span class="op">*</span>next_fp <span class="op">=</span> <span class="op">*(</span><span class="dt">void</span> <span class="op">**)</span>fp<span class="op">;</span></span>
<span id="cb215-35"><a href="#cb215-35" aria-hidden="true" tabindex="-1"></a>        pc <span class="op">=</span> <span class="op">*((</span><span class="dt">void</span> <span class="op">**)</span>fp <span class="op">+</span> <span class="dv">1</span><span class="op">);</span>  <span class="co">// Return address</span></span>
<span id="cb215-36"><a href="#cb215-36" aria-hidden="true" tabindex="-1"></a>        fp <span class="op">=</span> next_fp<span class="op">;</span></span>
<span id="cb215-37"><a href="#cb215-37" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb215-38"><a href="#cb215-38" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>17.5 Instrumentation Framework</h2>
<h3>17.5.1 Instrumentation Points</h3>
<div class="sourceCode" id="cb216"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb216-1"><a href="#cb216-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">enum</span> <span class="op">{</span></span>
<span id="cb216-2"><a href="#cb216-2" aria-hidden="true" tabindex="-1"></a>    INSTR_METHOD_ENTER<span class="op">,</span></span>
<span id="cb216-3"><a href="#cb216-3" aria-hidden="true" tabindex="-1"></a>    INSTR_METHOD_EXIT<span class="op">,</span></span>
<span id="cb216-4"><a href="#cb216-4" aria-hidden="true" tabindex="-1"></a>    INSTR_BASIC_BLOCK<span class="op">,</span></span>
<span id="cb216-5"><a href="#cb216-5" aria-hidden="true" tabindex="-1"></a>    INSTR_ALLOCATION<span class="op">,</span></span>
<span id="cb216-6"><a href="#cb216-6" aria-hidden="true" tabindex="-1"></a>    INSTR_FIELD_ACCESS<span class="op">,</span></span>
<span id="cb216-7"><a href="#cb216-7" aria-hidden="true" tabindex="-1"></a>    INSTR_EXCEPTION<span class="op">,</span></span>
<span id="cb216-8"><a href="#cb216-8" aria-hidden="true" tabindex="-1"></a>    INSTR_GC_EVENT<span class="op">,</span></span>
<span id="cb216-9"><a href="#cb216-9" aria-hidden="true" tabindex="-1"></a>    INSTR_JIT_EVENT</span>
<span id="cb216-10"><a href="#cb216-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> InstrumentationPoint<span class="op">;</span></span>
<span id="cb216-11"><a href="#cb216-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb216-12"><a href="#cb216-12" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> InstrumentationCallback <span class="op">{</span></span>
<span id="cb216-13"><a href="#cb216-13" aria-hidden="true" tabindex="-1"></a>    InstrumentationPoint point<span class="op">;</span></span>
<span id="cb216-14"><a href="#cb216-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">(*</span>callback<span class="op">)(</span>InstrumentationContext <span class="op">*</span>ctx<span class="op">);</span></span>
<span id="cb216-15"><a href="#cb216-15" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span>user_data<span class="op">;</span></span>
<span id="cb216-16"><a href="#cb216-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> enabled<span class="op">;</span></span>
<span id="cb216-17"><a href="#cb216-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> InstrumentationCallback<span class="op">;</span></span>
<span id="cb216-18"><a href="#cb216-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb216-19"><a href="#cb216-19" aria-hidden="true" tabindex="-1"></a><span class="co">// Registration API</span></span>
<span id="cb216-20"><a href="#cb216-20" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> register_instrumentation<span class="op">(</span>InstrumentationPoint point<span class="op">,</span></span>
<span id="cb216-21"><a href="#cb216-21" aria-hidden="true" tabindex="-1"></a>                            <span class="dt">void</span> <span class="op">(*</span>callback<span class="op">)(</span>InstrumentationContext <span class="op">*),</span></span>
<span id="cb216-22"><a href="#cb216-22" aria-hidden="true" tabindex="-1"></a>                            <span class="dt">void</span> <span class="op">*</span>user_data<span class="op">)</span> <span class="op">{</span></span>
<span id="cb216-23"><a href="#cb216-23" aria-hidden="true" tabindex="-1"></a>    InstrumentationCallback <span class="op">*</span>cb <span class="op">=</span> allocate_callback<span class="op">();</span></span>
<span id="cb216-24"><a href="#cb216-24" aria-hidden="true" tabindex="-1"></a>    cb<span class="op">-&gt;</span>point <span class="op">=</span> point<span class="op">;</span></span>
<span id="cb216-25"><a href="#cb216-25" aria-hidden="true" tabindex="-1"></a>    cb<span class="op">-&gt;</span>callback <span class="op">=</span> callback<span class="op">;</span></span>
<span id="cb216-26"><a href="#cb216-26" aria-hidden="true" tabindex="-1"></a>    cb<span class="op">-&gt;</span>user_data <span class="op">=</span> user_data<span class="op">;</span></span>
<span id="cb216-27"><a href="#cb216-27" aria-hidden="true" tabindex="-1"></a>    cb<span class="op">-&gt;</span>enabled <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb216-28"><a href="#cb216-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb216-29"><a href="#cb216-29" aria-hidden="true" tabindex="-1"></a>    add_callback<span class="op">(&amp;</span>vm<span class="op">-&gt;</span>profiler<span class="op">.</span>callbacks<span class="op">,</span> cb<span class="op">);</span></span>
<span id="cb216-30"><a href="#cb216-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb216-31"><a href="#cb216-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Update code generation if needed</span></span>
<span id="cb216-32"><a href="#cb216-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>requires_code_update<span class="op">(</span>point<span class="op">))</span> <span class="op">{</span></span>
<span id="cb216-33"><a href="#cb216-33" aria-hidden="true" tabindex="-1"></a>        invalidate_affected_code<span class="op">(</span>point<span class="op">);</span></span>
<span id="cb216-34"><a href="#cb216-34" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb216-35"><a href="#cb216-35" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3>17.5.2 Dynamic Instrumentation</h3>
<div class="sourceCode" id="cb217"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb217-1"><a href="#cb217-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> InstrumentationEngine <span class="op">{</span></span>
<span id="cb217-2"><a href="#cb217-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Bytecode rewriting</span></span>
<span id="cb217-3"><a href="#cb217-3" aria-hidden="true" tabindex="-1"></a>    BytecodeRewriter <span class="op">*</span>rewriter<span class="op">;</span></span>
<span id="cb217-4"><a href="#cb217-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb217-5"><a href="#cb217-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// JIT instrumentation</span></span>
<span id="cb217-6"><a href="#cb217-6" aria-hidden="true" tabindex="-1"></a>    JITInstrumenter <span class="op">*</span>jit_instrumenter<span class="op">;</span></span>
<span id="cb217-7"><a href="#cb217-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb217-8"><a href="#cb217-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Patch points</span></span>
<span id="cb217-9"><a href="#cb217-9" aria-hidden="true" tabindex="-1"></a>    PatchPointTable <span class="op">*</span>patch_points<span class="op">;</span></span>
<span id="cb217-10"><a href="#cb217-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb217-11"><a href="#cb217-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Active instrumentation</span></span>
<span id="cb217-12"><a href="#cb217-12" aria-hidden="true" tabindex="-1"></a>    InstrumentationSet <span class="op">*</span>active<span class="op">;</span></span>
<span id="cb217-13"><a href="#cb217-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> InstrumentationEngine<span class="op">;</span></span>
<span id="cb217-14"><a href="#cb217-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb217-15"><a href="#cb217-15" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> instrument_method<span class="op">(</span>Method <span class="op">*</span>method<span class="op">,</span> InstrumentationSet <span class="op">*</span>instr<span class="op">)</span> <span class="op">{</span></span>
<span id="cb217-16"><a href="#cb217-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>instr<span class="op">-&gt;</span>method_entry<span class="op">)</span> <span class="op">{</span></span>
<span id="cb217-17"><a href="#cb217-17" aria-hidden="true" tabindex="-1"></a>        inject_method_entry_probe<span class="op">(</span>method<span class="op">);</span></span>
<span id="cb217-18"><a href="#cb217-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb217-19"><a href="#cb217-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb217-20"><a href="#cb217-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>instr<span class="op">-&gt;</span>basic_blocks<span class="op">)</span> <span class="op">{</span></span>
<span id="cb217-21"><a href="#cb217-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> method<span class="op">-&gt;</span>bb_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb217-22"><a href="#cb217-22" aria-hidden="true" tabindex="-1"></a>            inject_bb_probe<span class="op">(</span>method<span class="op">,</span> i<span class="op">);</span></span>
<span id="cb217-23"><a href="#cb217-23" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb217-24"><a href="#cb217-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb217-25"><a href="#cb217-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb217-26"><a href="#cb217-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>instr<span class="op">-&gt;</span>allocations<span class="op">)</span> <span class="op">{</span></span>
<span id="cb217-27"><a href="#cb217-27" aria-hidden="true" tabindex="-1"></a>        instrument_allocations<span class="op">(</span>method<span class="op">);</span></span>
<span id="cb217-28"><a href="#cb217-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb217-29"><a href="#cb217-29" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb217-30"><a href="#cb217-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb217-31"><a href="#cb217-31" aria-hidden="true" tabindex="-1"></a><span class="co">// Low-overhead probe implementation</span></span>
<span id="cb217-32"><a href="#cb217-32" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> inject_method_entry_probe<span class="op">(</span>Method <span class="op">*</span>method<span class="op">)</span> <span class="op">{</span></span>
<span id="cb217-33"><a href="#cb217-33" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint8_t</span> <span class="op">*</span>entry <span class="op">=</span> method<span class="op">-&gt;</span>bytecode<span class="op">;</span></span>
<span id="cb217-34"><a href="#cb217-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb217-35"><a href="#cb217-35" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Save original instruction</span></span>
<span id="cb217-36"><a href="#cb217-36" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint8_t</span> saved<span class="op">[</span>PROBE_SIZE<span class="op">];</span></span>
<span id="cb217-37"><a href="#cb217-37" aria-hidden="true" tabindex="-1"></a>    memcpy<span class="op">(</span>saved<span class="op">,</span> entry<span class="op">,</span> PROBE_SIZE<span class="op">);</span></span>
<span id="cb217-38"><a href="#cb217-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb217-39"><a href="#cb217-39" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Inject call to profiling stub</span></span>
<span id="cb217-40"><a href="#cb217-40" aria-hidden="true" tabindex="-1"></a>    entry<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> OP_PROFILE_ENTER<span class="op">;</span></span>
<span id="cb217-41"><a href="#cb217-41" aria-hidden="true" tabindex="-1"></a>    entry<span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="op">=</span> <span class="op">(</span>method<span class="op">-&gt;</span>id <span class="op">&gt;&gt;</span> <span class="dv">8</span><span class="op">)</span> <span class="op">&amp;</span> <span class="bn">0xFF</span><span class="op">;</span></span>
<span id="cb217-42"><a href="#cb217-42" aria-hidden="true" tabindex="-1"></a>    entry<span class="op">[</span><span class="dv">2</span><span class="op">]</span> <span class="op">=</span> method<span class="op">-&gt;</span>id <span class="op">&amp;</span> <span class="bn">0xFF</span><span class="op">;</span></span>
<span id="cb217-43"><a href="#cb217-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb217-44"><a href="#cb217-44" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Store patch info for removal</span></span>
<span id="cb217-45"><a href="#cb217-45" aria-hidden="true" tabindex="-1"></a>    store_patch_info<span class="op">(</span>method<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> saved<span class="op">,</span> PROBE_SIZE<span class="op">);</span></span>
<span id="cb217-46"><a href="#cb217-46" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3>17.5.3 Performance Counter Integration</h3>
<div class="sourceCode" id="cb218"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb218-1"><a href="#cb218-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> PerfCounters <span class="op">{</span></span>
<span id="cb218-2"><a href="#cb218-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> fd<span class="op">;</span>                  <span class="co">// perf_event file descriptor</span></span>
<span id="cb218-3"><a href="#cb218-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint64_t</span> <span class="op">*</span>mmap_page<span class="op">;</span>    <span class="co">// mmap&#39;d counter values</span></span>
<span id="cb218-4"><a href="#cb218-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb218-5"><a href="#cb218-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb218-6"><a href="#cb218-6" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint64_t</span> cycles<span class="op">;</span></span>
<span id="cb218-7"><a href="#cb218-7" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint64_t</span> instructions<span class="op">;</span></span>
<span id="cb218-8"><a href="#cb218-8" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint64_t</span> cache_misses<span class="op">;</span></span>
<span id="cb218-9"><a href="#cb218-9" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint64_t</span> branch_misses<span class="op">;</span></span>
<span id="cb218-10"><a href="#cb218-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> values<span class="op">;</span></span>
<span id="cb218-11"><a href="#cb218-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> PerfCounters<span class="op">;</span></span>
<span id="cb218-12"><a href="#cb218-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb218-13"><a href="#cb218-13" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> setup_perf_counters<span class="op">(</span>Thread <span class="op">*</span>thread<span class="op">)</span> <span class="op">{</span></span>
<span id="cb218-14"><a href="#cb218-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> perf_event_attr attr <span class="op">=</span> <span class="op">{</span></span>
<span id="cb218-15"><a href="#cb218-15" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>type <span class="op">=</span> PERF_TYPE_HARDWARE<span class="op">,</span></span>
<span id="cb218-16"><a href="#cb218-16" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>size <span class="op">=</span> <span class="kw">sizeof</span><span class="op">(</span>attr<span class="op">),</span></span>
<span id="cb218-17"><a href="#cb218-17" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>config <span class="op">=</span> PERF_COUNT_HW_CPU_CYCLES<span class="op">,</span></span>
<span id="cb218-18"><a href="#cb218-18" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>disabled <span class="op">=</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb218-19"><a href="#cb218-19" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>exclude_kernel <span class="op">=</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb218-20"><a href="#cb218-20" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>exclude_hv <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb218-21"><a href="#cb218-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb218-22"><a href="#cb218-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb218-23"><a href="#cb218-23" aria-hidden="true" tabindex="-1"></a>    thread<span class="op">-&gt;</span>perf<span class="op">.</span>fd <span class="op">=</span> syscall<span class="op">(</span>__NR_perf_event_open<span class="op">,</span> </span>
<span id="cb218-24"><a href="#cb218-24" aria-hidden="true" tabindex="-1"></a>                              <span class="op">&amp;</span>attr<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="op">-</span><span class="dv">1</span><span class="op">,</span> <span class="op">-</span><span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb218-25"><a href="#cb218-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb218-26"><a href="#cb218-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>thread<span class="op">-&gt;</span>perf<span class="op">.</span>fd <span class="op">&gt;=</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb218-27"><a href="#cb218-27" aria-hidden="true" tabindex="-1"></a>        thread<span class="op">-&gt;</span>perf<span class="op">.</span>mmap_page <span class="op">=</span> mmap<span class="op">(</span>NULL<span class="op">,</span> PAGE_SIZE<span class="op">,</span></span>
<span id="cb218-28"><a href="#cb218-28" aria-hidden="true" tabindex="-1"></a>                                      PROT_READ<span class="op">,</span> MAP_SHARED<span class="op">,</span></span>
<span id="cb218-29"><a href="#cb218-29" aria-hidden="true" tabindex="-1"></a>                                      thread<span class="op">-&gt;</span>perf<span class="op">.</span>fd<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb218-30"><a href="#cb218-30" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb218-31"><a href="#cb218-31" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Enable counters</span></span>
<span id="cb218-32"><a href="#cb218-32" aria-hidden="true" tabindex="-1"></a>        ioctl<span class="op">(</span>thread<span class="op">-&gt;</span>perf<span class="op">.</span>fd<span class="op">,</span> PERF_EVENT_IOC_ENABLE<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb218-33"><a href="#cb218-33" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb218-34"><a href="#cb218-34" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb218-35"><a href="#cb218-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb218-36"><a href="#cb218-36" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="kw">inline</span> <span class="dt">uint64_t</span> read_perf_counter<span class="op">(</span>Thread <span class="op">*</span>thread<span class="op">)</span> <span class="op">{</span></span>
<span id="cb218-37"><a href="#cb218-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>thread<span class="op">-&gt;</span>perf<span class="op">.</span>mmap_page<span class="op">)</span> <span class="op">{</span></span>
<span id="cb218-38"><a href="#cb218-38" aria-hidden="true" tabindex="-1"></a>        <span class="kw">struct</span> perf_event_mmap_page <span class="op">*</span>pc <span class="op">=</span> </span>
<span id="cb218-39"><a href="#cb218-39" aria-hidden="true" tabindex="-1"></a>            <span class="op">(</span><span class="kw">struct</span> perf_event_mmap_page <span class="op">*)</span>thread<span class="op">-&gt;</span>perf<span class="op">.</span>mmap_page<span class="op">;</span></span>
<span id="cb218-40"><a href="#cb218-40" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb218-41"><a href="#cb218-41" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint32_t</span> seq<span class="op">,</span> idx<span class="op">;</span></span>
<span id="cb218-42"><a href="#cb218-42" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint64_t</span> count<span class="op">;</span></span>
<span id="cb218-43"><a href="#cb218-43" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb218-44"><a href="#cb218-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">do</span> <span class="op">{</span></span>
<span id="cb218-45"><a href="#cb218-45" aria-hidden="true" tabindex="-1"></a>            seq <span class="op">=</span> pc<span class="op">-&gt;</span>lock<span class="op">;</span></span>
<span id="cb218-46"><a href="#cb218-46" aria-hidden="true" tabindex="-1"></a>            barrier<span class="op">();</span></span>
<span id="cb218-47"><a href="#cb218-47" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb218-48"><a href="#cb218-48" aria-hidden="true" tabindex="-1"></a>            idx <span class="op">=</span> pc<span class="op">-&gt;</span>index<span class="op">;</span></span>
<span id="cb218-49"><a href="#cb218-49" aria-hidden="true" tabindex="-1"></a>            count <span class="op">=</span> pc<span class="op">-&gt;</span>offset<span class="op">;</span></span>
<span id="cb218-50"><a href="#cb218-50" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb218-51"><a href="#cb218-51" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>idx<span class="op">)</span> <span class="op">{</span></span>
<span id="cb218-52"><a href="#cb218-52" aria-hidden="true" tabindex="-1"></a>                count <span class="op">+=</span> rdpmc<span class="op">(</span>idx <span class="op">-</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb218-53"><a href="#cb218-53" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb218-54"><a href="#cb218-54" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb218-55"><a href="#cb218-55" aria-hidden="true" tabindex="-1"></a>            barrier<span class="op">();</span></span>
<span id="cb218-56"><a href="#cb218-56" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">while</span> <span class="op">(</span>pc<span class="op">-&gt;</span>lock <span class="op">!=</span> seq<span class="op">);</span></span>
<span id="cb218-57"><a href="#cb218-57" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb218-58"><a href="#cb218-58" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> count<span class="op">;</span></span>
<span id="cb218-59"><a href="#cb218-59" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb218-60"><a href="#cb218-60" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb218-61"><a href="#cb218-61" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>17.6 Profile-Guided Optimization</h2>
<h3>17.6.1 Hot Spot Detection</h3>
<div class="sourceCode" id="cb219"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb219-1"><a href="#cb219-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> HotSpotDetector <span class="op">{</span></span>
<span id="cb219-2"><a href="#cb219-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Thresholds</span></span>
<span id="cb219-3"><a href="#cb219-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint64_t</span> method_threshold<span class="op">;</span></span>
<span id="cb219-4"><a href="#cb219-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint64_t</span> loop_threshold<span class="op">;</span></span>
<span id="cb219-5"><a href="#cb219-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint64_t</span> trace_threshold<span class="op">;</span></span>
<span id="cb219-6"><a href="#cb219-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb219-7"><a href="#cb219-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Decay for adaptive thresholds</span></span>
<span id="cb219-8"><a href="#cb219-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> decay_rate<span class="op">;</span></span>
<span id="cb219-9"><a href="#cb219-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint64_t</span> check_interval<span class="op">;</span></span>
<span id="cb219-10"><a href="#cb219-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb219-11"><a href="#cb219-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Hot spot queues</span></span>
<span id="cb219-12"><a href="#cb219-12" aria-hidden="true" tabindex="-1"></a>    PriorityQueue <span class="op">*</span>hot_methods<span class="op">;</span></span>
<span id="cb219-13"><a href="#cb219-13" aria-hidden="true" tabindex="-1"></a>    PriorityQueue <span class="op">*</span>hot_loops<span class="op">;</span></span>
<span id="cb219-14"><a href="#cb219-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> HotSpotDetector<span class="op">;</span></span>
<span id="cb219-15"><a href="#cb219-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb219-16"><a href="#cb219-16" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> detect_hot_spots<span class="op">(</span>Profiler <span class="op">*</span>profiler<span class="op">)</span> <span class="op">{</span></span>
<span id="cb219-17"><a href="#cb219-17" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint64_t</span> current_time <span class="op">=</span> get_timestamp<span class="op">();</span></span>
<span id="cb219-18"><a href="#cb219-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb219-19"><a href="#cb219-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check methods</span></span>
<span id="cb219-20"><a href="#cb219-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> profiler<span class="op">-&gt;</span>database<span class="op">-&gt;</span>method_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb219-21"><a href="#cb219-21" aria-hidden="true" tabindex="-1"></a>        MethodProfile <span class="op">*</span>profile <span class="op">=</span> profiler<span class="op">-&gt;</span>database<span class="op">-&gt;</span>method_profiles<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb219-22"><a href="#cb219-22" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb219-23"><a href="#cb219-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>profile<span class="op">-&gt;</span>invocation_count <span class="op">&gt;</span> profiler<span class="op">-&gt;</span>hot_spot_detector<span class="op">-&gt;</span>method_threshold<span class="op">)</span> <span class="op">{</span></span>
<span id="cb219-24"><a href="#cb219-24" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Calculate hotness score</span></span>
<span id="cb219-25"><a href="#cb219-25" aria-hidden="true" tabindex="-1"></a>            <span class="dt">float</span> score <span class="op">=</span> calculate_hotness_score<span class="op">(</span>profile<span class="op">);</span></span>
<span id="cb219-26"><a href="#cb219-26" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb219-27"><a href="#cb219-27" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Add to compilation queue</span></span>
<span id="cb219-28"><a href="#cb219-28" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>score <span class="op">&gt;</span> MIN_COMPILATION_SCORE<span class="op">)</span> <span class="op">{</span></span>
<span id="cb219-29"><a href="#cb219-29" aria-hidden="true" tabindex="-1"></a>                enqueue_for_compilation<span class="op">(</span>profile<span class="op">-&gt;</span>method_id<span class="op">,</span> score<span class="op">);</span></span>
<span id="cb219-30"><a href="#cb219-30" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb219-31"><a href="#cb219-31" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb219-32"><a href="#cb219-32" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb219-33"><a href="#cb219-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb219-34"><a href="#cb219-34" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Apply decay to thresholds</span></span>
<span id="cb219-35"><a href="#cb219-35" aria-hidden="true" tabindex="-1"></a>    apply_threshold_decay<span class="op">(</span>profiler<span class="op">-&gt;</span>hot_spot_detector<span class="op">,</span> current_time<span class="op">);</span></span>
<span id="cb219-36"><a href="#cb219-36" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb219-37"><a href="#cb219-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb219-38"><a href="#cb219-38" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">float</span> calculate_hotness_score<span class="op">(</span>MethodProfile <span class="op">*</span>profile<span class="op">)</span> <span class="op">{</span></span>
<span id="cb219-39"><a href="#cb219-39" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Combine multiple factors</span></span>
<span id="cb219-40"><a href="#cb219-40" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> invocation_score <span class="op">=</span> log<span class="op">(</span>profile<span class="op">-&gt;</span>invocation_count <span class="op">+</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb219-41"><a href="#cb219-41" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> time_score <span class="op">=</span> <span class="op">(</span><span class="dt">float</span><span class="op">)</span>profile<span class="op">-&gt;</span>self_cycles <span class="op">/</span> profile<span class="op">-&gt;</span>invocation_count<span class="op">;</span></span>
<span id="cb219-42"><a href="#cb219-42" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> stability_score <span class="op">=</span> calculate_stability<span class="op">(</span>profile<span class="op">);</span></span>
<span id="cb219-43"><a href="#cb219-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb219-44"><a href="#cb219-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> invocation_score <span class="op">*</span> time_score <span class="op">*</span> stability_score<span class="op">;</span></span>
<span id="cb219-45"><a href="#cb219-45" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3>17.6.2 Profile Data Analysis</h3>
<div class="sourceCode" id="cb220"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb220-1"><a href="#cb220-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> ProfileAnalyzer <span class="op">{</span></span>
<span id="cb220-2"><a href="#cb220-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Analysis results</span></span>
<span id="cb220-3"><a href="#cb220-3" aria-hidden="true" tabindex="-1"></a>    TypeSpecializationHints <span class="op">*</span>type_hints<span class="op">;</span></span>
<span id="cb220-4"><a href="#cb220-4" aria-hidden="true" tabindex="-1"></a>    InliningCandidates <span class="op">*</span>inline_candidates<span class="op">;</span></span>
<span id="cb220-5"><a href="#cb220-5" aria-hidden="true" tabindex="-1"></a>    BranchPredictionHints <span class="op">*</span>branch_hints<span class="op">;</span></span>
<span id="cb220-6"><a href="#cb220-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb220-7"><a href="#cb220-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Statistics</span></span>
<span id="cb220-8"><a href="#cb220-8" aria-hidden="true" tabindex="-1"></a>    ProfileStats stats<span class="op">;</span></span>
<span id="cb220-9"><a href="#cb220-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> ProfileAnalyzer<span class="op">;</span></span>
<span id="cb220-10"><a href="#cb220-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb220-11"><a href="#cb220-11" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> analyze_type_profiles<span class="op">(</span>ProfileAnalyzer <span class="op">*</span>analyzer<span class="op">,</span> </span>
<span id="cb220-12"><a href="#cb220-12" aria-hidden="true" tabindex="-1"></a>                                 TypeProfile <span class="op">*</span>profile<span class="op">)</span> <span class="op">{</span></span>
<span id="cb220-13"><a href="#cb220-13" aria-hidden="true" tabindex="-1"></a>    TypeDistribution <span class="op">*</span>dist <span class="op">=</span> <span class="op">&amp;</span>profile<span class="op">-&gt;</span>receiver_types<span class="op">;</span></span>
<span id="cb220-14"><a href="#cb220-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb220-15"><a href="#cb220-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>dist<span class="op">-&gt;</span>is_monomorphic<span class="op">)</span> <span class="op">{</span></span>
<span id="cb220-16"><a href="#cb220-16" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Generate monomorphic inline cache</span></span>
<span id="cb220-17"><a href="#cb220-17" aria-hidden="true" tabindex="-1"></a>        add_type_hint<span class="op">(</span>analyzer<span class="op">-&gt;</span>type_hints<span class="op">,</span> </span>
<span id="cb220-18"><a href="#cb220-18" aria-hidden="true" tabindex="-1"></a>                     HINT_MONOMORPHIC<span class="op">,</span></span>
<span id="cb220-19"><a href="#cb220-19" aria-hidden="true" tabindex="-1"></a>                     dist<span class="op">-&gt;</span>entries<span class="op">[</span><span class="dv">0</span><span class="op">].</span>type<span class="op">);</span></span>
<span id="cb220-20"><a href="#cb220-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>dist<span class="op">-&gt;</span>num_types <span class="op">&lt;=</span> POLYMORPHIC_THRESHOLD<span class="op">)</span> <span class="op">{</span></span>
<span id="cb220-21"><a href="#cb220-21" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Generate polymorphic inline cache</span></span>
<span id="cb220-22"><a href="#cb220-22" aria-hidden="true" tabindex="-1"></a>        TypeID common_types<span class="op">[</span>POLYMORPHIC_THRESHOLD<span class="op">];</span></span>
<span id="cb220-23"><a href="#cb220-23" aria-hidden="true" tabindex="-1"></a>        get_most_common_types<span class="op">(</span>dist<span class="op">,</span> common_types<span class="op">,</span> POLYMORPHIC_THRESHOLD<span class="op">);</span></span>
<span id="cb220-24"><a href="#cb220-24" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb220-25"><a href="#cb220-25" aria-hidden="true" tabindex="-1"></a>        add_polymorphic_hint<span class="op">(</span>analyzer<span class="op">-&gt;</span>type_hints<span class="op">,</span> </span>
<span id="cb220-26"><a href="#cb220-26" aria-hidden="true" tabindex="-1"></a>                            common_types<span class="op">,</span></span>
<span id="cb220-27"><a href="#cb220-27" aria-hidden="true" tabindex="-1"></a>                            dist<span class="op">-&gt;</span>num_types<span class="op">);</span></span>
<span id="cb220-28"><a href="#cb220-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb220-29"><a href="#cb220-29" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Megamorphic - use generic dispatch</span></span>
<span id="cb220-30"><a href="#cb220-30" aria-hidden="true" tabindex="-1"></a>        add_type_hint<span class="op">(</span>analyzer<span class="op">-&gt;</span>type_hints<span class="op">,</span> HINT_MEGAMORPHIC<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb220-31"><a href="#cb220-31" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb220-32"><a href="#cb220-32" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb220-33"><a href="#cb220-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb220-34"><a href="#cb220-34" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> identify_inlining_candidates<span class="op">(</span>ProfileAnalyzer <span class="op">*</span>analyzer<span class="op">,</span></span>
<span id="cb220-35"><a href="#cb220-35" aria-hidden="true" tabindex="-1"></a>                                       CallSiteProfile <span class="op">*</span>call_site<span class="op">)</span> <span class="op">{</span></span>
<span id="cb220-36"><a href="#cb220-36" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check if call site is hot enough</span></span>
<span id="cb220-37"><a href="#cb220-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>call_site<span class="op">-&gt;</span>call_count <span class="op">&lt;</span> INLINE_THRESHOLD<span class="op">)</span> <span class="cf">return</span><span class="op">;</span></span>
<span id="cb220-38"><a href="#cb220-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb220-39"><a href="#cb220-39" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check if target is small enough</span></span>
<span id="cb220-40"><a href="#cb220-40" aria-hidden="true" tabindex="-1"></a>    Method <span class="op">*</span>target <span class="op">=</span> get_method<span class="op">(</span>call_site<span class="op">-&gt;</span>target_id<span class="op">);</span></span>
<span id="cb220-41"><a href="#cb220-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>target<span class="op">-&gt;</span>bytecode_size <span class="op">&gt;</span> MAX_INLINE_SIZE<span class="op">)</span> <span class="cf">return</span><span class="op">;</span></span>
<span id="cb220-42"><a href="#cb220-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb220-43"><a href="#cb220-43" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check if monomorphic</span></span>
<span id="cb220-44"><a href="#cb220-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>call_site<span class="op">-&gt;</span>type_profile<span class="op">.</span>is_monomorphic<span class="op">)</span> <span class="op">{</span></span>
<span id="cb220-45"><a href="#cb220-45" aria-hidden="true" tabindex="-1"></a>        <span class="dt">float</span> benefit <span class="op">=</span> estimate_inlining_benefit<span class="op">(</span>call_site<span class="op">,</span> target<span class="op">);</span></span>
<span id="cb220-46"><a href="#cb220-46" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb220-47"><a href="#cb220-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>benefit <span class="op">&gt;</span> MIN_INLINE_BENEFIT<span class="op">)</span> <span class="op">{</span></span>
<span id="cb220-48"><a href="#cb220-48" aria-hidden="true" tabindex="-1"></a>            add_inline_candidate<span class="op">(</span>analyzer<span class="op">-&gt;</span>inline_candidates<span class="op">,</span></span>
<span id="cb220-49"><a href="#cb220-49" aria-hidden="true" tabindex="-1"></a>                               call_site<span class="op">,</span> target<span class="op">,</span> benefit<span class="op">);</span></span>
<span id="cb220-50"><a href="#cb220-50" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb220-51"><a href="#cb220-51" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb220-52"><a href="#cb220-52" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>17.7 Profile Data Management</h2>
<h3>17.7.1 Efficient Storage</h3>
<div class="sourceCode" id="cb221"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb221-1"><a href="#cb221-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> ProfileArena <span class="op">{</span></span>
<span id="cb221-2"><a href="#cb221-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint8_t</span> <span class="op">*</span>memory<span class="op">;</span></span>
<span id="cb221-3"><a href="#cb221-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> capacity<span class="op">;</span></span>
<span id="cb221-4"><a href="#cb221-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> used<span class="op">;</span></span>
<span id="cb221-5"><a href="#cb221-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb221-6"><a href="#cb221-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Segregated storage by type</span></span>
<span id="cb221-7"><a href="#cb221-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb221-8"><a href="#cb221-8" aria-hidden="true" tabindex="-1"></a>        <span class="dt">void</span> <span class="op">*</span>free_list<span class="op">;</span></span>
<span id="cb221-9"><a href="#cb221-9" aria-hidden="true" tabindex="-1"></a>        <span class="dt">size_t</span> size<span class="op">;</span></span>
<span id="cb221-10"><a href="#cb221-10" aria-hidden="true" tabindex="-1"></a>        <span class="dt">size_t</span> count<span class="op">;</span></span>
<span id="cb221-11"><a href="#cb221-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> pools<span class="op">[</span>PROFILE_TYPE_COUNT<span class="op">];</span></span>
<span id="cb221-12"><a href="#cb221-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> ProfileArena<span class="op">;</span></span>
<span id="cb221-13"><a href="#cb221-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb221-14"><a href="#cb221-14" aria-hidden="true" tabindex="-1"></a><span class="co">// Lock-free profile counter update</span></span>
<span id="cb221-15"><a href="#cb221-15" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="kw">inline</span> <span class="dt">void</span> increment_profile_counter<span class="op">(</span><span class="dt">uint64_t</span> <span class="op">*</span>counter<span class="op">)</span> <span class="op">{</span></span>
<span id="cb221-16"><a href="#cb221-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Use atomic increment for thread safety</span></span>
<span id="cb221-17"><a href="#cb221-17" aria-hidden="true" tabindex="-1"></a>    __atomic_add_fetch<span class="op">(</span>counter<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> __ATOMIC_RELAXED<span class="op">);</span></span>
<span id="cb221-18"><a href="#cb221-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb221-19"><a href="#cb221-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb221-20"><a href="#cb221-20" aria-hidden="true" tabindex="-1"></a><span class="co">// Compact profile storage</span></span>
<span id="cb221-21"><a href="#cb221-21" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> CompactMethodProfile <span class="op">{</span></span>
<span id="cb221-22"><a href="#cb221-22" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint16_t</span> method_id<span class="op">;</span></span>
<span id="cb221-23"><a href="#cb221-23" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint16_t</span> flags<span class="op">;</span></span>
<span id="cb221-24"><a href="#cb221-24" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> invocation_count<span class="op">;</span>  <span class="co">// Saturating counter</span></span>
<span id="cb221-25"><a href="#cb221-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb221-26"><a href="#cb221-26" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Variable-length data follows</span></span>
<span id="cb221-27"><a href="#cb221-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">// - Basic block counters (if present)</span></span>
<span id="cb221-28"><a href="#cb221-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">// - Type profile data (if present)</span></span>
<span id="cb221-29"><a href="#cb221-29" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> CompactMethodProfile<span class="op">;</span></span></code></pre></div>
<h3>17.7.2 Profile Serialization</h3>
<div class="sourceCode" id="cb222"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb222-1"><a href="#cb222-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> serialize_profiles<span class="op">(</span>Profiler <span class="op">*</span>profiler<span class="op">,</span> <span class="dt">FILE</span> <span class="op">*</span>file<span class="op">)</span> <span class="op">{</span></span>
<span id="cb222-2"><a href="#cb222-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Write header</span></span>
<span id="cb222-3"><a href="#cb222-3" aria-hidden="true" tabindex="-1"></a>    ProfileHeader header <span class="op">=</span> <span class="op">{</span></span>
<span id="cb222-4"><a href="#cb222-4" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>magic <span class="op">=</span> PROFILE_MAGIC<span class="op">,</span></span>
<span id="cb222-5"><a href="#cb222-5" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>version <span class="op">=</span> PROFILE_VERSION<span class="op">,</span></span>
<span id="cb222-6"><a href="#cb222-6" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>timestamp <span class="op">=</span> get_timestamp<span class="op">(),</span></span>
<span id="cb222-7"><a href="#cb222-7" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>method_count <span class="op">=</span> profiler<span class="op">-&gt;</span>database<span class="op">-&gt;</span>method_count</span>
<span id="cb222-8"><a href="#cb222-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb222-9"><a href="#cb222-9" aria-hidden="true" tabindex="-1"></a>    fwrite<span class="op">(&amp;</span>header<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>header<span class="op">),</span> <span class="dv">1</span><span class="op">,</span> file<span class="op">);</span></span>
<span id="cb222-10"><a href="#cb222-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb222-11"><a href="#cb222-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Write method profiles</span></span>
<span id="cb222-12"><a href="#cb222-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> header<span class="op">.</span>method_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb222-13"><a href="#cb222-13" aria-hidden="true" tabindex="-1"></a>        MethodProfile <span class="op">*</span>profile <span class="op">=</span> profiler<span class="op">-&gt;</span>database<span class="op">-&gt;</span>method_profiles<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb222-14"><a href="#cb222-14" aria-hidden="true" tabindex="-1"></a>        serialize_method_profile<span class="op">(</span>file<span class="op">,</span> profile<span class="op">);</span></span>
<span id="cb222-15"><a href="#cb222-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb222-16"><a href="#cb222-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb222-17"><a href="#cb222-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Write type profiles</span></span>
<span id="cb222-18"><a href="#cb222-18" aria-hidden="true" tabindex="-1"></a>    serialize_type_profiles<span class="op">(</span>file<span class="op">,</span> profiler<span class="op">-&gt;</span>type_profiles<span class="op">);</span></span>
<span id="cb222-19"><a href="#cb222-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb222-20"><a href="#cb222-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb222-21"><a href="#cb222-21" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> deserialize_profiles<span class="op">(</span>Profiler <span class="op">*</span>profiler<span class="op">,</span> <span class="dt">FILE</span> <span class="op">*</span>file<span class="op">)</span> <span class="op">{</span></span>
<span id="cb222-22"><a href="#cb222-22" aria-hidden="true" tabindex="-1"></a>    ProfileHeader header<span class="op">;</span></span>
<span id="cb222-23"><a href="#cb222-23" aria-hidden="true" tabindex="-1"></a>    fread<span class="op">(&amp;</span>header<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>header<span class="op">),</span> <span class="dv">1</span><span class="op">,</span> file<span class="op">);</span></span>
<span id="cb222-24"><a href="#cb222-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb222-25"><a href="#cb222-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>header<span class="op">.</span>magic <span class="op">!=</span> PROFILE_MAGIC <span class="op">||</span> </span>
<span id="cb222-26"><a href="#cb222-26" aria-hidden="true" tabindex="-1"></a>        header<span class="op">.</span>version <span class="op">!=</span> PROFILE_VERSION<span class="op">)</span> <span class="op">{</span></span>
<span id="cb222-27"><a href="#cb222-27" aria-hidden="true" tabindex="-1"></a>        error<span class="op">(</span><span class="st">&quot;Invalid profile format&quot;</span><span class="op">);</span></span>
<span id="cb222-28"><a href="#cb222-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span><span class="op">;</span></span>
<span id="cb222-29"><a href="#cb222-29" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb222-30"><a href="#cb222-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb222-31"><a href="#cb222-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Read and merge profiles</span></span>
<span id="cb222-32"><a href="#cb222-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> header<span class="op">.</span>method_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb222-33"><a href="#cb222-33" aria-hidden="true" tabindex="-1"></a>        MethodProfile <span class="op">*</span>profile <span class="op">=</span> deserialize_method_profile<span class="op">(</span>file<span class="op">);</span></span>
<span id="cb222-34"><a href="#cb222-34" aria-hidden="true" tabindex="-1"></a>        merge_method_profile<span class="op">(</span>profiler<span class="op">-&gt;</span>database<span class="op">,</span> profile<span class="op">);</span></span>
<span id="cb222-35"><a href="#cb222-35" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb222-36"><a href="#cb222-36" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>17.8 Debugging and Analysis Tools</h2>
<h3>17.8.1 Profile Visualization</h3>
<div class="sourceCode" id="cb223"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb223-1"><a href="#cb223-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> ProfileReport <span class="op">{</span></span>
<span id="cb223-2"><a href="#cb223-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Flat profile</span></span>
<span id="cb223-3"><a href="#cb223-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb223-4"><a href="#cb223-4" aria-hidden="true" tabindex="-1"></a>        MethodEntry <span class="op">*</span>entries<span class="op">;</span></span>
<span id="cb223-5"><a href="#cb223-5" aria-hidden="true" tabindex="-1"></a>        <span class="dt">size_t</span> count<span class="op">;</span></span>
<span id="cb223-6"><a href="#cb223-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> flat<span class="op">;</span></span>
<span id="cb223-7"><a href="#cb223-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb223-8"><a href="#cb223-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Call graph</span></span>
<span id="cb223-9"><a href="#cb223-9" aria-hidden="true" tabindex="-1"></a>    CallGraphNode <span class="op">*</span>call_graph<span class="op">;</span></span>
<span id="cb223-10"><a href="#cb223-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb223-11"><a href="#cb223-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Hot path analysis</span></span>
<span id="cb223-12"><a href="#cb223-12" aria-hidden="true" tabindex="-1"></a>    HotPath <span class="op">*</span>hot_paths<span class="op">;</span></span>
<span id="cb223-13"><a href="#cb223-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> hot_path_count<span class="op">;</span></span>
<span id="cb223-14"><a href="#cb223-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> ProfileReport<span class="op">;</span></span>
<span id="cb223-15"><a href="#cb223-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb223-16"><a href="#cb223-16" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> generate_flat_profile<span class="op">(</span>ProfileReport <span class="op">*</span>report<span class="op">,</span> </span>
<span id="cb223-17"><a href="#cb223-17" aria-hidden="true" tabindex="-1"></a>                                 ProfileDatabase <span class="op">*</span>db<span class="op">)</span> <span class="op">{</span></span>
<span id="cb223-18"><a href="#cb223-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Sort methods by self time</span></span>
<span id="cb223-19"><a href="#cb223-19" aria-hidden="true" tabindex="-1"></a>    qsort<span class="op">(</span>report<span class="op">-&gt;</span>flat<span class="op">.</span>entries<span class="op">,</span> report<span class="op">-&gt;</span>flat<span class="op">.</span>count<span class="op">,</span></span>
<span id="cb223-20"><a href="#cb223-20" aria-hidden="true" tabindex="-1"></a>          <span class="kw">sizeof</span><span class="op">(</span>MethodEntry<span class="op">),</span> compare_by_self_time<span class="op">);</span></span>
<span id="cb223-21"><a href="#cb223-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb223-22"><a href="#cb223-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Calculate percentages</span></span>
<span id="cb223-23"><a href="#cb223-23" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint64_t</span> total_time <span class="op">=</span> calculate_total_time<span class="op">(</span>db<span class="op">);</span></span>
<span id="cb223-24"><a href="#cb223-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb223-25"><a href="#cb223-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> report<span class="op">-&gt;</span>flat<span class="op">.</span>count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb223-26"><a href="#cb223-26" aria-hidden="true" tabindex="-1"></a>        MethodEntry <span class="op">*</span>entry <span class="op">=</span> <span class="op">&amp;</span>report<span class="op">-&gt;</span>flat<span class="op">.</span>entries<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb223-27"><a href="#cb223-27" aria-hidden="true" tabindex="-1"></a>        entry<span class="op">-&gt;</span>self_percent <span class="op">=</span> <span class="op">(</span><span class="fl">100.0</span> <span class="op">*</span> entry<span class="op">-&gt;</span>self_time<span class="op">)</span> <span class="op">/</span> total_time<span class="op">;</span></span>
<span id="cb223-28"><a href="#cb223-28" aria-hidden="true" tabindex="-1"></a>        entry<span class="op">-&gt;</span>cumulative_percent <span class="op">=</span> <span class="op">(</span><span class="fl">100.0</span> <span class="op">*</span> entry<span class="op">-&gt;</span>total_time<span class="op">)</span> <span class="op">/</span> total_time<span class="op">;</span></span>
<span id="cb223-29"><a href="#cb223-29" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb223-30"><a href="#cb223-30" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb223-31"><a href="#cb223-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb223-32"><a href="#cb223-32" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> export_flame_graph<span class="op">(</span>ProfileDatabase <span class="op">*</span>db<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>filename<span class="op">)</span> <span class="op">{</span></span>
<span id="cb223-33"><a href="#cb223-33" aria-hidden="true" tabindex="-1"></a>    <span class="dt">FILE</span> <span class="op">*</span>file <span class="op">=</span> fopen<span class="op">(</span>filename<span class="op">,</span> <span class="st">&quot;w&quot;</span><span class="op">);</span></span>
<span id="cb223-34"><a href="#cb223-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb223-35"><a href="#cb223-35" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Export in collapsed stack format</span></span>
<span id="cb223-36"><a href="#cb223-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> db<span class="op">-&gt;</span>sample_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb223-37"><a href="#cb223-37" aria-hidden="true" tabindex="-1"></a>        Sample <span class="op">*</span>sample <span class="op">=</span> <span class="op">&amp;</span>db<span class="op">-&gt;</span>samples<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb223-38"><a href="#cb223-38" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb223-39"><a href="#cb223-39" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Build stack string</span></span>
<span id="cb223-40"><a href="#cb223-40" aria-hidden="true" tabindex="-1"></a>        <span class="dt">char</span> stack_str<span class="op">[</span>MAX_STACK_STRING<span class="op">];</span></span>
<span id="cb223-41"><a href="#cb223-41" aria-hidden="true" tabindex="-1"></a>        build_stack_string<span class="op">(</span>sample<span class="op">-&gt;</span>stack<span class="op">,</span> stack_str<span class="op">);</span></span>
<span id="cb223-42"><a href="#cb223-42" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb223-43"><a href="#cb223-43" aria-hidden="true" tabindex="-1"></a>        fprintf<span class="op">(</span>file<span class="op">,</span> <span class="st">&quot;</span><span class="sc">%s</span><span class="st"> </span><span class="sc">%lu\n</span><span class="st">&quot;</span><span class="op">,</span> stack_str<span class="op">,</span> sample<span class="op">-&gt;</span>weight<span class="op">);</span></span>
<span id="cb223-44"><a href="#cb223-44" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb223-45"><a href="#cb223-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb223-46"><a href="#cb223-46" aria-hidden="true" tabindex="-1"></a>    fclose<span class="op">(</span>file<span class="op">);</span></span>
<span id="cb223-47"><a href="#cb223-47" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3>17.8.2 Performance Analysis API</h3>
<div class="sourceCode" id="cb224"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb224-1"><a href="#cb224-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Public API for performance analysis</span></span>
<span id="cb224-2"><a href="#cb224-2" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> PerformanceAPI <span class="op">{</span></span>
<span id="cb224-3"><a href="#cb224-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Start/stop profiling</span></span>
<span id="cb224-4"><a href="#cb224-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">(*</span>start_profiling<span class="op">)(</span>ProfileConfig <span class="op">*</span>config<span class="op">);</span></span>
<span id="cb224-5"><a href="#cb224-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">(*</span>stop_profiling<span class="op">)(</span><span class="dt">void</span><span class="op">);</span></span>
<span id="cb224-6"><a href="#cb224-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb224-7"><a href="#cb224-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Query profile data</span></span>
<span id="cb224-8"><a href="#cb224-8" aria-hidden="true" tabindex="-1"></a>    MethodProfile <span class="op">*(*</span>get_method_profile<span class="op">)(</span>MethodID id<span class="op">);</span></span>
<span id="cb224-9"><a href="#cb224-9" aria-hidden="true" tabindex="-1"></a>    TypeProfile <span class="op">*(*</span>get_type_profile<span class="op">)(</span>CallSiteID id<span class="op">);</span></span>
<span id="cb224-10"><a href="#cb224-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb224-11"><a href="#cb224-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Analysis functions</span></span>
<span id="cb224-12"><a href="#cb224-12" aria-hidden="true" tabindex="-1"></a>    HotMethod <span class="op">*(*</span>get_hot_methods<span class="op">)(</span><span class="dt">size_t</span> <span class="op">*</span>count<span class="op">);</span></span>
<span id="cb224-13"><a href="#cb224-13" aria-hidden="true" tabindex="-1"></a>    CallGraph <span class="op">*(*</span>build_call_graph<span class="op">)(</span><span class="dt">void</span><span class="op">);</span></span>
<span id="cb224-14"><a href="#cb224-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb224-15"><a href="#cb224-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Export functions</span></span>
<span id="cb224-16"><a href="#cb224-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">(*</span>export_profile<span class="op">)(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>filename<span class="op">,</span> ProfileFormat format<span class="op">);</span></span>
<span id="cb224-17"><a href="#cb224-17" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">(*</span>export_trace<span class="op">)(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>filename<span class="op">,</span> TraceFormat format<span class="op">);</span></span>
<span id="cb224-18"><a href="#cb224-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> PerformanceAPI<span class="op">;</span></span>
<span id="cb224-19"><a href="#cb224-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb224-20"><a href="#cb224-20" aria-hidden="true" tabindex="-1"></a><span class="co">// Example usage</span></span>
<span id="cb224-21"><a href="#cb224-21" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> analyze_application_performance<span class="op">(</span>VM <span class="op">*</span>vm<span class="op">)</span> <span class="op">{</span></span>
<span id="cb224-22"><a href="#cb224-22" aria-hidden="true" tabindex="-1"></a>    ProfileConfig config <span class="op">=</span> <span class="op">{</span></span>
<span id="cb224-23"><a href="#cb224-23" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>sample_interval <span class="op">=</span> <span class="dv">1000</span><span class="op">,</span>  <span class="co">// microseconds</span></span>
<span id="cb224-24"><a href="#cb224-24" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>collect_types <span class="op">=</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb224-25"><a href="#cb224-25" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>collect_branches <span class="op">=</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb224-26"><a href="#cb224-26" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>collect_perf_counters <span class="op">=</span> <span class="kw">true</span></span>
<span id="cb224-27"><a href="#cb224-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb224-28"><a href="#cb224-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb224-29"><a href="#cb224-29" aria-hidden="true" tabindex="-1"></a>    vm<span class="op">-&gt;</span>perf_api<span class="op">.</span>start_profiling<span class="op">(&amp;</span>config<span class="op">);</span></span>
<span id="cb224-30"><a href="#cb224-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb224-31"><a href="#cb224-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Run application...</span></span>
<span id="cb224-32"><a href="#cb224-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb224-33"><a href="#cb224-33" aria-hidden="true" tabindex="-1"></a>    vm<span class="op">-&gt;</span>perf_api<span class="op">.</span>stop_profiling<span class="op">();</span></span>
<span id="cb224-34"><a href="#cb224-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb224-35"><a href="#cb224-35" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Analyze results</span></span>
<span id="cb224-36"><a href="#cb224-36" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> hot_count<span class="op">;</span></span>
<span id="cb224-37"><a href="#cb224-37" aria-hidden="true" tabindex="-1"></a>    HotMethod <span class="op">*</span>hot_methods <span class="op">=</span> vm<span class="op">-&gt;</span>perf_api<span class="op">.</span>get_hot_methods<span class="op">(&amp;</span>hot_count<span class="op">);</span></span>
<span id="cb224-38"><a href="#cb224-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb224-39"><a href="#cb224-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> hot_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb224-40"><a href="#cb224-40" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">&quot;Hot method: </span><span class="sc">%s</span><span class="st"> - </span><span class="sc">%.2f%%</span><span class="st"> of time</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span></span>
<span id="cb224-41"><a href="#cb224-41" aria-hidden="true" tabindex="-1"></a>               hot_methods<span class="op">[</span>i<span class="op">].</span>name<span class="op">,</span></span>
<span id="cb224-42"><a href="#cb224-42" aria-hidden="true" tabindex="-1"></a>               hot_methods<span class="op">[</span>i<span class="op">].</span>percent_time<span class="op">);</span></span>
<span id="cb224-43"><a href="#cb224-43" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb224-44"><a href="#cb224-44" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h1>Chapter 18: Foreign Function Interface</h1>
<h2>18.1 Introduction</h2>
<p>This chapter details Diyrbal&#39;s Foreign Function Interface (FFI)
implementation, enabling seamless interoperability with native
libraries. Drawing from the uploaded FFI references, we implement a
comprehensive system supporting multiple calling conventions, automatic
memory management for foreign objects, and safe interaction between
managed and unmanaged code.</p>
<h2>18.2 FFI Architecture</h2>
<h3>18.2.1 Core Components</h3>
<div class="sourceCode" id="cb225"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb225-1"><a href="#cb225-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> FFIEngine <span class="op">{</span></span>
<span id="cb225-2"><a href="#cb225-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Type system bridge</span></span>
<span id="cb225-3"><a href="#cb225-3" aria-hidden="true" tabindex="-1"></a>    FFITypeRegistry <span class="op">*</span>type_registry<span class="op">;</span></span>
<span id="cb225-4"><a href="#cb225-4" aria-hidden="true" tabindex="-1"></a>    FFITypeMapper <span class="op">*</span>type_mapper<span class="op">;</span></span>
<span id="cb225-5"><a href="#cb225-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb225-6"><a href="#cb225-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Function management</span></span>
<span id="cb225-7"><a href="#cb225-7" aria-hidden="true" tabindex="-1"></a>    FFIFunctionTable <span class="op">*</span>functions<span class="op">;</span></span>
<span id="cb225-8"><a href="#cb225-8" aria-hidden="true" tabindex="-1"></a>    FFICallbackTable <span class="op">*</span>callbacks<span class="op">;</span></span>
<span id="cb225-9"><a href="#cb225-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb225-10"><a href="#cb225-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Library management</span></span>
<span id="cb225-11"><a href="#cb225-11" aria-hidden="true" tabindex="-1"></a>    DynamicLibraryTable <span class="op">*</span>libraries<span class="op">;</span></span>
<span id="cb225-12"><a href="#cb225-12" aria-hidden="true" tabindex="-1"></a>    SymbolResolver <span class="op">*</span>symbol_resolver<span class="op">;</span></span>
<span id="cb225-13"><a href="#cb225-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb225-14"><a href="#cb225-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Memory management</span></span>
<span id="cb225-15"><a href="#cb225-15" aria-hidden="true" tabindex="-1"></a>    FFIMemoryManager <span class="op">*</span>memory_manager<span class="op">;</span></span>
<span id="cb225-16"><a href="#cb225-16" aria-hidden="true" tabindex="-1"></a>    HandleTable <span class="op">*</span>handle_table<span class="op">;</span></span>
<span id="cb225-17"><a href="#cb225-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb225-18"><a href="#cb225-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Safety and validation</span></span>
<span id="cb225-19"><a href="#cb225-19" aria-hidden="true" tabindex="-1"></a>    FFIValidator <span class="op">*</span>validator<span class="op">;</span></span>
<span id="cb225-20"><a href="#cb225-20" aria-hidden="true" tabindex="-1"></a>    FFIMarshaller <span class="op">*</span>marshaller<span class="op">;</span></span>
<span id="cb225-21"><a href="#cb225-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> FFIEngine<span class="op">;</span></span>
<span id="cb225-22"><a href="#cb225-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb225-23"><a href="#cb225-23" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> FFIFunction <span class="op">{</span></span>
<span id="cb225-24"><a href="#cb225-24" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span>native_ptr<span class="op">;</span>           <span class="co">// Native function pointer</span></span>
<span id="cb225-25"><a href="#cb225-25" aria-hidden="true" tabindex="-1"></a>    FFISignature <span class="op">*</span>signature<span class="op">;</span>    <span class="co">// Type signature</span></span>
<span id="cb225-26"><a href="#cb225-26" aria-hidden="true" tabindex="-1"></a>    CallingConvention convention<span class="op">;</span></span>
<span id="cb225-27"><a href="#cb225-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb225-28"><a href="#cb225-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Metadata</span></span>
<span id="cb225-29"><a href="#cb225-29" aria-hidden="true" tabindex="-1"></a>    <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>name<span class="op">;</span></span>
<span id="cb225-30"><a href="#cb225-30" aria-hidden="true" tabindex="-1"></a>    <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>library<span class="op">;</span></span>
<span id="cb225-31"><a href="#cb225-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb225-32"><a href="#cb225-32" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Performance tracking</span></span>
<span id="cb225-33"><a href="#cb225-33" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint64_t</span> call_count<span class="op">;</span></span>
<span id="cb225-34"><a href="#cb225-34" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint64_t</span> total_time<span class="op">;</span></span>
<span id="cb225-35"><a href="#cb225-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb225-36"><a href="#cb225-36" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Safety flags</span></span>
<span id="cb225-37"><a href="#cb225-37" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> flags<span class="op">;</span>  <span class="co">// UNSAFE, NO_GC, PINNED_ARGS, etc.</span></span>
<span id="cb225-38"><a href="#cb225-38" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> FFIFunction<span class="op">;</span></span></code></pre></div>
<h3>18.2.2 Type System Bridge</h3>
<div class="sourceCode" id="cb226"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb226-1"><a href="#cb226-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> FFIType <span class="op">{</span></span>
<span id="cb226-2"><a href="#cb226-2" aria-hidden="true" tabindex="-1"></a>    FFITypeKind kind<span class="op">;</span></span>
<span id="cb226-3"><a href="#cb226-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> size<span class="op">;</span></span>
<span id="cb226-4"><a href="#cb226-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> alignment<span class="op">;</span></span>
<span id="cb226-5"><a href="#cb226-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb226-6"><a href="#cb226-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">union</span> <span class="op">{</span></span>
<span id="cb226-7"><a href="#cb226-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb226-8"><a href="#cb226-8" aria-hidden="true" tabindex="-1"></a>            FFIType <span class="op">*</span>element_type<span class="op">;</span></span>
<span id="cb226-9"><a href="#cb226-9" aria-hidden="true" tabindex="-1"></a>            <span class="dt">size_t</span> count<span class="op">;</span></span>
<span id="cb226-10"><a href="#cb226-10" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> array<span class="op">;</span></span>
<span id="cb226-11"><a href="#cb226-11" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb226-12"><a href="#cb226-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb226-13"><a href="#cb226-13" aria-hidden="true" tabindex="-1"></a>            FFIType <span class="op">**</span>field_types<span class="op">;</span></span>
<span id="cb226-14"><a href="#cb226-14" aria-hidden="true" tabindex="-1"></a>            <span class="dt">size_t</span> field_count<span class="op">;</span></span>
<span id="cb226-15"><a href="#cb226-15" aria-hidden="true" tabindex="-1"></a>            <span class="dt">size_t</span> <span class="op">*</span>field_offsets<span class="op">;</span></span>
<span id="cb226-16"><a href="#cb226-16" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> struct_type<span class="op">;</span></span>
<span id="cb226-17"><a href="#cb226-17" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb226-18"><a href="#cb226-18" aria-hidden="true" tabindex="-1"></a>        <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb226-19"><a href="#cb226-19" aria-hidden="true" tabindex="-1"></a>            FFIType <span class="op">*</span>return_type<span class="op">;</span></span>
<span id="cb226-20"><a href="#cb226-20" aria-hidden="true" tabindex="-1"></a>            FFIType <span class="op">**</span>param_types<span class="op">;</span></span>
<span id="cb226-21"><a href="#cb226-21" aria-hidden="true" tabindex="-1"></a>            <span class="dt">size_t</span> param_count<span class="op">;</span></span>
<span id="cb226-22"><a href="#cb226-22" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> function<span class="op">;</span></span>
<span id="cb226-23"><a href="#cb226-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> data<span class="op">;</span></span>
<span id="cb226-24"><a href="#cb226-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> FFIType<span class="op">;</span></span>
<span id="cb226-25"><a href="#cb226-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb226-26"><a href="#cb226-26" aria-hidden="true" tabindex="-1"></a><span class="co">// Predefined FFI types matching libffi</span></span>
<span id="cb226-27"><a href="#cb226-27" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> FFIType ffi_type_void <span class="op">=</span> <span class="op">{</span> FFI_TYPE_VOID<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span> <span class="op">};</span></span>
<span id="cb226-28"><a href="#cb226-28" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> FFIType ffi_type_sint8 <span class="op">=</span> <span class="op">{</span> FFI_TYPE_SINT8<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span> <span class="op">};</span></span>
<span id="cb226-29"><a href="#cb226-29" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> FFIType ffi_type_sint32 <span class="op">=</span> <span class="op">{</span> FFI_TYPE_SINT32<span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="dv">4</span> <span class="op">};</span></span>
<span id="cb226-30"><a href="#cb226-30" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> FFIType ffi_type_sint64 <span class="op">=</span> <span class="op">{</span> FFI_TYPE_SINT64<span class="op">,</span> <span class="dv">8</span><span class="op">,</span> <span class="dv">8</span> <span class="op">};</span></span>
<span id="cb226-31"><a href="#cb226-31" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> FFIType ffi_type_float <span class="op">=</span> <span class="op">{</span> FFI_TYPE_FLOAT<span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="dv">4</span> <span class="op">};</span></span>
<span id="cb226-32"><a href="#cb226-32" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> FFIType ffi_type_double <span class="op">=</span> <span class="op">{</span> FFI_TYPE_DOUBLE<span class="op">,</span> <span class="dv">8</span><span class="op">,</span> <span class="dv">8</span> <span class="op">};</span></span>
<span id="cb226-33"><a href="#cb226-33" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> FFIType ffi_type_pointer <span class="op">=</span> <span class="op">{</span> FFI_TYPE_POINTER<span class="op">,</span> <span class="dv">8</span><span class="op">,</span> <span class="dv">8</span> <span class="op">};</span></span></code></pre></div>
<h2>18.3 Function Binding and Calling</h2>
<h3>18.3.1 Dynamic Library Loading</h3>
<div class="sourceCode" id="cb227"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb227-1"><a href="#cb227-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> DynamicLibrary <span class="op">{</span></span>
<span id="cb227-2"><a href="#cb227-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span>handle<span class="op">;</span>           <span class="co">// dlopen handle</span></span>
<span id="cb227-3"><a href="#cb227-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>path<span class="op">;</span></span>
<span id="cb227-4"><a href="#cb227-4" aria-hidden="true" tabindex="-1"></a>    RefCount ref_count<span class="op">;</span></span>
<span id="cb227-5"><a href="#cb227-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb227-6"><a href="#cb227-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Symbol cache</span></span>
<span id="cb227-7"><a href="#cb227-7" aria-hidden="true" tabindex="-1"></a>    HashMap <span class="op">*</span>symbol_cache<span class="op">;</span></span>
<span id="cb227-8"><a href="#cb227-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb227-9"><a href="#cb227-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Dependency tracking</span></span>
<span id="cb227-10"><a href="#cb227-10" aria-hidden="true" tabindex="-1"></a>    DynamicLibrary <span class="op">**</span>dependencies<span class="op">;</span></span>
<span id="cb227-11"><a href="#cb227-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> dep_count<span class="op">;</span></span>
<span id="cb227-12"><a href="#cb227-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> DynamicLibrary<span class="op">;</span></span>
<span id="cb227-13"><a href="#cb227-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb227-14"><a href="#cb227-14" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> DynamicLibrary<span class="op">*</span> load_library<span class="op">(</span>FFIEngine <span class="op">*</span>ffi<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>path<span class="op">)</span> <span class="op">{</span></span>
<span id="cb227-15"><a href="#cb227-15" aria-hidden="true" tabindex="-1"></a>    DynamicLibrary <span class="op">*</span>lib <span class="op">=</span> allocate_library<span class="op">();</span></span>
<span id="cb227-16"><a href="#cb227-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb227-17"><a href="#cb227-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Load with appropriate flags</span></span>
<span id="cb227-18"><a href="#cb227-18" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> flags <span class="op">=</span> RTLD_LAZY <span class="op">|</span> RTLD_LOCAL<span class="op">;</span></span>
<span id="cb227-19"><a href="#cb227-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>ffi<span class="op">-&gt;</span>config<span class="op">.</span>global_symbols<span class="op">)</span> <span class="op">{</span></span>
<span id="cb227-20"><a href="#cb227-20" aria-hidden="true" tabindex="-1"></a>        flags <span class="op">|=</span> RTLD_GLOBAL<span class="op">;</span></span>
<span id="cb227-21"><a href="#cb227-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb227-22"><a href="#cb227-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb227-23"><a href="#cb227-23" aria-hidden="true" tabindex="-1"></a>    lib<span class="op">-&gt;</span>handle <span class="op">=</span> dlopen<span class="op">(</span>path<span class="op">,</span> flags<span class="op">);</span></span>
<span id="cb227-24"><a href="#cb227-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>lib<span class="op">-&gt;</span>handle<span class="op">)</span> <span class="op">{</span></span>
<span id="cb227-25"><a href="#cb227-25" aria-hidden="true" tabindex="-1"></a>        error<span class="op">(</span><span class="st">&quot;Failed to load library </span><span class="sc">%s</span><span class="st">: </span><span class="sc">%s</span><span class="st">&quot;</span><span class="op">,</span> path<span class="op">,</span> dlerror<span class="op">());</span></span>
<span id="cb227-26"><a href="#cb227-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> NULL<span class="op">;</span></span>
<span id="cb227-27"><a href="#cb227-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb227-28"><a href="#cb227-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb227-29"><a href="#cb227-29" aria-hidden="true" tabindex="-1"></a>    lib<span class="op">-&gt;</span>path <span class="op">=</span> strdup<span class="op">(</span>path<span class="op">);</span></span>
<span id="cb227-30"><a href="#cb227-30" aria-hidden="true" tabindex="-1"></a>    lib<span class="op">-&gt;</span>symbol_cache <span class="op">=</span> hashmap_create<span class="op">();</span></span>
<span id="cb227-31"><a href="#cb227-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb227-32"><a href="#cb227-32" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Initialize library if it has constructors</span></span>
<span id="cb227-33"><a href="#cb227-33" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">(*</span>init_func<span class="op">)(</span><span class="dt">void</span><span class="op">)</span> <span class="op">=</span> dlsym<span class="op">(</span>lib<span class="op">-&gt;</span>handle<span class="op">,</span> <span class="st">&quot;_init&quot;</span><span class="op">);</span></span>
<span id="cb227-34"><a href="#cb227-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>init_func<span class="op">)</span> <span class="op">{</span></span>
<span id="cb227-35"><a href="#cb227-35" aria-hidden="true" tabindex="-1"></a>        init_func<span class="op">();</span></span>
<span id="cb227-36"><a href="#cb227-36" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb227-37"><a href="#cb227-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb227-38"><a href="#cb227-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> lib<span class="op">;</span></span>
<span id="cb227-39"><a href="#cb227-39" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3>18.3.2 Function Resolution and Binding</h3>
<div class="sourceCode" id="cb228"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb228-1"><a href="#cb228-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> FFIFunction<span class="op">*</span> bind_function<span class="op">(</span>FFIEngine <span class="op">*</span>ffi<span class="op">,</span></span>
<span id="cb228-2"><a href="#cb228-2" aria-hidden="true" tabindex="-1"></a>                                  <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>name<span class="op">,</span></span>
<span id="cb228-3"><a href="#cb228-3" aria-hidden="true" tabindex="-1"></a>                                  FFISignature <span class="op">*</span>signature<span class="op">,</span></span>
<span id="cb228-4"><a href="#cb228-4" aria-hidden="true" tabindex="-1"></a>                                  DynamicLibrary <span class="op">*</span>lib<span class="op">)</span> <span class="op">{</span></span>
<span id="cb228-5"><a href="#cb228-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Resolve symbol</span></span>
<span id="cb228-6"><a href="#cb228-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span>symbol <span class="op">=</span> dlsym<span class="op">(</span>lib<span class="op">-&gt;</span>handle<span class="op">,</span> name<span class="op">);</span></span>
<span id="cb228-7"><a href="#cb228-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>symbol<span class="op">)</span> <span class="op">{</span></span>
<span id="cb228-8"><a href="#cb228-8" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Try mangled names for C++</span></span>
<span id="cb228-9"><a href="#cb228-9" aria-hidden="true" tabindex="-1"></a>        <span class="dt">char</span> mangled<span class="op">[</span><span class="dv">256</span><span class="op">];</span></span>
<span id="cb228-10"><a href="#cb228-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>try_demangle<span class="op">(</span>name<span class="op">,</span> mangled<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>mangled<span class="op">)))</span> <span class="op">{</span></span>
<span id="cb228-11"><a href="#cb228-11" aria-hidden="true" tabindex="-1"></a>            symbol <span class="op">=</span> dlsym<span class="op">(</span>lib<span class="op">-&gt;</span>handle<span class="op">,</span> mangled<span class="op">);</span></span>
<span id="cb228-12"><a href="#cb228-12" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb228-13"><a href="#cb228-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb228-14"><a href="#cb228-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb228-15"><a href="#cb228-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>symbol<span class="op">)</span> <span class="op">{</span></span>
<span id="cb228-16"><a href="#cb228-16" aria-hidden="true" tabindex="-1"></a>        error<span class="op">(</span><span class="st">&quot;Symbol not found: </span><span class="sc">%s</span><span class="st">&quot;</span><span class="op">,</span> name<span class="op">);</span></span>
<span id="cb228-17"><a href="#cb228-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> NULL<span class="op">;</span></span>
<span id="cb228-18"><a href="#cb228-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb228-19"><a href="#cb228-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb228-20"><a href="#cb228-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Create FFI function</span></span>
<span id="cb228-21"><a href="#cb228-21" aria-hidden="true" tabindex="-1"></a>    FFIFunction <span class="op">*</span>func <span class="op">=</span> allocate_ffi_function<span class="op">();</span></span>
<span id="cb228-22"><a href="#cb228-22" aria-hidden="true" tabindex="-1"></a>    func<span class="op">-&gt;</span>native_ptr <span class="op">=</span> symbol<span class="op">;</span></span>
<span id="cb228-23"><a href="#cb228-23" aria-hidden="true" tabindex="-1"></a>    func<span class="op">-&gt;</span>signature <span class="op">=</span> signature<span class="op">;</span></span>
<span id="cb228-24"><a href="#cb228-24" aria-hidden="true" tabindex="-1"></a>    func<span class="op">-&gt;</span>name <span class="op">=</span> strdup<span class="op">(</span>name<span class="op">);</span></span>
<span id="cb228-25"><a href="#cb228-25" aria-hidden="true" tabindex="-1"></a>    func<span class="op">-&gt;</span>library <span class="op">=</span> lib<span class="op">-&gt;</span>path<span class="op">;</span></span>
<span id="cb228-26"><a href="#cb228-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb228-27"><a href="#cb228-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Prepare CIF (Call Interface) for libffi</span></span>
<span id="cb228-28"><a href="#cb228-28" aria-hidden="true" tabindex="-1"></a>    prepare_ffi_cif<span class="op">(</span>func<span class="op">);</span></span>
<span id="cb228-29"><a href="#cb228-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb228-30"><a href="#cb228-30" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Add to function table</span></span>
<span id="cb228-31"><a href="#cb228-31" aria-hidden="true" tabindex="-1"></a>    register_ffi_function<span class="op">(</span>ffi<span class="op">,</span> func<span class="op">);</span></span>
<span id="cb228-32"><a href="#cb228-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb228-33"><a href="#cb228-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> func<span class="op">;</span></span>
<span id="cb228-34"><a href="#cb228-34" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb228-35"><a href="#cb228-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb228-36"><a href="#cb228-36" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> prepare_ffi_cif<span class="op">(</span>FFIFunction <span class="op">*</span>func<span class="op">)</span> <span class="op">{</span></span>
<span id="cb228-37"><a href="#cb228-37" aria-hidden="true" tabindex="-1"></a>    ffi_cif <span class="op">*</span>cif <span class="op">=</span> <span class="op">&amp;</span>func<span class="op">-&gt;</span>cif<span class="op">;</span></span>
<span id="cb228-38"><a href="#cb228-38" aria-hidden="true" tabindex="-1"></a>    FFISignature <span class="op">*</span>sig <span class="op">=</span> func<span class="op">-&gt;</span>signature<span class="op">;</span></span>
<span id="cb228-39"><a href="#cb228-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb228-40"><a href="#cb228-40" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Convert our types to libffi types</span></span>
<span id="cb228-41"><a href="#cb228-41" aria-hidden="true" tabindex="-1"></a>    ffi_type <span class="op">**</span>arg_types <span class="op">=</span> allocate_type_array<span class="op">(</span>sig<span class="op">-&gt;</span>param_count<span class="op">);</span></span>
<span id="cb228-42"><a href="#cb228-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> sig<span class="op">-&gt;</span>param_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb228-43"><a href="#cb228-43" aria-hidden="true" tabindex="-1"></a>        arg_types<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> convert_to_ffi_type<span class="op">(</span>sig<span class="op">-&gt;</span>param_types<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb228-44"><a href="#cb228-44" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb228-45"><a href="#cb228-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb228-46"><a href="#cb228-46" aria-hidden="true" tabindex="-1"></a>    ffi_type <span class="op">*</span>return_type <span class="op">=</span> convert_to_ffi_type<span class="op">(</span>sig<span class="op">-&gt;</span>return_type<span class="op">);</span></span>
<span id="cb228-47"><a href="#cb228-47" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb228-48"><a href="#cb228-48" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Prepare the CIF</span></span>
<span id="cb228-49"><a href="#cb228-49" aria-hidden="true" tabindex="-1"></a>    ffi_status status <span class="op">=</span> ffi_prep_cif<span class="op">(</span>cif<span class="op">,</span> FFI_DEFAULT_ABI<span class="op">,</span></span>
<span id="cb228-50"><a href="#cb228-50" aria-hidden="true" tabindex="-1"></a>                                     sig<span class="op">-&gt;</span>param_count<span class="op">,</span></span>
<span id="cb228-51"><a href="#cb228-51" aria-hidden="true" tabindex="-1"></a>                                     return_type<span class="op">,</span></span>
<span id="cb228-52"><a href="#cb228-52" aria-hidden="true" tabindex="-1"></a>                                     arg_types<span class="op">);</span></span>
<span id="cb228-53"><a href="#cb228-53" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb228-54"><a href="#cb228-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>status <span class="op">!=</span> FFI_OK<span class="op">)</span> <span class="op">{</span></span>
<span id="cb228-55"><a href="#cb228-55" aria-hidden="true" tabindex="-1"></a>        error<span class="op">(</span><span class="st">&quot;Failed to prepare FFI CIF: </span><span class="sc">%d</span><span class="st">&quot;</span><span class="op">,</span> status<span class="op">);</span></span>
<span id="cb228-56"><a href="#cb228-56" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb228-57"><a href="#cb228-57" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3>18.3.3 Foreign Function Invocation</h3>
<div class="sourceCode" id="cb229"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb229-1"><a href="#cb229-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> Value call_ffi_function<span class="op">(</span>FFIFunction <span class="op">*</span>func<span class="op">,</span> Value <span class="op">*</span>args<span class="op">,</span> <span class="dt">size_t</span> arg_count<span class="op">)</span> <span class="op">{</span></span>
<span id="cb229-2"><a href="#cb229-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Validate arguments</span></span>
<span id="cb229-3"><a href="#cb229-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>validate_ffi_call<span class="op">(</span>func<span class="op">,</span> args<span class="op">,</span> arg_count<span class="op">))</span> <span class="op">{</span></span>
<span id="cb229-4"><a href="#cb229-4" aria-hidden="true" tabindex="-1"></a>        error<span class="op">(</span><span class="st">&quot;FFI call validation failed&quot;</span><span class="op">);</span></span>
<span id="cb229-5"><a href="#cb229-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> NIL_VAL<span class="op">;</span></span>
<span id="cb229-6"><a href="#cb229-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb229-7"><a href="#cb229-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb229-8"><a href="#cb229-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Pin objects if needed (for GC safety)</span></span>
<span id="cb229-9"><a href="#cb229-9" aria-hidden="true" tabindex="-1"></a>    PinnedObjects pinned <span class="op">=</span> pin_ffi_arguments<span class="op">(</span>func<span class="op">,</span> args<span class="op">,</span> arg_count<span class="op">);</span></span>
<span id="cb229-10"><a href="#cb229-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb229-11"><a href="#cb229-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Marshal arguments</span></span>
<span id="cb229-12"><a href="#cb229-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">**</span>native_args <span class="op">=</span> marshal_arguments<span class="op">(</span>func<span class="op">,</span> args<span class="op">,</span> arg_count<span class="op">);</span></span>
<span id="cb229-13"><a href="#cb229-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span>return_buffer <span class="op">=</span> allocate_return_buffer<span class="op">(</span>func<span class="op">-&gt;</span>signature<span class="op">-&gt;</span>return_type<span class="op">);</span></span>
<span id="cb229-14"><a href="#cb229-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb229-15"><a href="#cb229-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Mark as in foreign call (for GC coordination)</span></span>
<span id="cb229-16"><a href="#cb229-16" aria-hidden="true" tabindex="-1"></a>    Thread <span class="op">*</span>thread <span class="op">=</span> get_current_thread<span class="op">();</span></span>
<span id="cb229-17"><a href="#cb229-17" aria-hidden="true" tabindex="-1"></a>    thread<span class="op">-&gt;</span>in_foreign_call <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb229-18"><a href="#cb229-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb229-19"><a href="#cb229-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Timing for profiling</span></span>
<span id="cb229-20"><a href="#cb229-20" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint64_t</span> start_time <span class="op">=</span> get_timestamp<span class="op">();</span></span>
<span id="cb229-21"><a href="#cb229-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb229-22"><a href="#cb229-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Actual FFI call using libffi</span></span>
<span id="cb229-23"><a href="#cb229-23" aria-hidden="true" tabindex="-1"></a>    ffi_call<span class="op">(&amp;</span>func<span class="op">-&gt;</span>cif<span class="op">,</span> func<span class="op">-&gt;</span>native_ptr<span class="op">,</span> return_buffer<span class="op">,</span> native_args<span class="op">);</span></span>
<span id="cb229-24"><a href="#cb229-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb229-25"><a href="#cb229-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Update profiling info</span></span>
<span id="cb229-26"><a href="#cb229-26" aria-hidden="true" tabindex="-1"></a>    func<span class="op">-&gt;</span>call_count<span class="op">++;</span></span>
<span id="cb229-27"><a href="#cb229-27" aria-hidden="true" tabindex="-1"></a>    func<span class="op">-&gt;</span>total_time <span class="op">+=</span> get_timestamp<span class="op">()</span> <span class="op">-</span> start_time<span class="op">;</span></span>
<span id="cb229-28"><a href="#cb229-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb229-29"><a href="#cb229-29" aria-hidden="true" tabindex="-1"></a>    thread<span class="op">-&gt;</span>in_foreign_call <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb229-30"><a href="#cb229-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb229-31"><a href="#cb229-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Unmarshal return value</span></span>
<span id="cb229-32"><a href="#cb229-32" aria-hidden="true" tabindex="-1"></a>    Value result <span class="op">=</span> unmarshal_return_value<span class="op">(</span>func<span class="op">-&gt;</span>signature<span class="op">-&gt;</span>return_type<span class="op">,</span></span>
<span id="cb229-33"><a href="#cb229-33" aria-hidden="true" tabindex="-1"></a>                                          return_buffer<span class="op">);</span></span>
<span id="cb229-34"><a href="#cb229-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb229-35"><a href="#cb229-35" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Cleanup</span></span>
<span id="cb229-36"><a href="#cb229-36" aria-hidden="true" tabindex="-1"></a>    unpin_objects<span class="op">(&amp;</span>pinned<span class="op">);</span></span>
<span id="cb229-37"><a href="#cb229-37" aria-hidden="true" tabindex="-1"></a>    free_marshal_buffers<span class="op">(</span>native_args<span class="op">,</span> return_buffer<span class="op">);</span></span>
<span id="cb229-38"><a href="#cb229-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb229-39"><a href="#cb229-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result<span class="op">;</span></span>
<span id="cb229-40"><a href="#cb229-40" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>18.4 Type Marshalling</h2>
<h3>18.4.1 Primitive Type Marshalling</h3>
<div class="sourceCode" id="cb230"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb230-1"><a href="#cb230-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> Marshaller <span class="op">{</span></span>
<span id="cb230-2"><a href="#cb230-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Type conversion functions</span></span>
<span id="cb230-3"><a href="#cb230-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span><span class="op">*</span> <span class="op">(*</span>to_native<span class="op">)(</span>Value value<span class="op">,</span> FFIType <span class="op">*</span>type<span class="op">);</span></span>
<span id="cb230-4"><a href="#cb230-4" aria-hidden="true" tabindex="-1"></a>    Value <span class="op">(*</span>from_native<span class="op">)(</span><span class="dt">void</span> <span class="op">*</span>native<span class="op">,</span> FFIType <span class="op">*</span>type<span class="op">);</span></span>
<span id="cb230-5"><a href="#cb230-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb230-6"><a href="#cb230-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Buffer management</span></span>
<span id="cb230-7"><a href="#cb230-7" aria-hidden="true" tabindex="-1"></a>    MarshalBuffer <span class="op">*</span>buffer_pool<span class="op">;</span></span>
<span id="cb230-8"><a href="#cb230-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> buffer_size<span class="op">;</span></span>
<span id="cb230-9"><a href="#cb230-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> Marshaller<span class="op">;</span></span>
<span id="cb230-10"><a href="#cb230-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb230-11"><a href="#cb230-11" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span><span class="op">*</span> marshal_primitive<span class="op">(</span>Value value<span class="op">,</span> FFIType <span class="op">*</span>type<span class="op">)</span> <span class="op">{</span></span>
<span id="cb230-12"><a href="#cb230-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span>buffer <span class="op">=</span> allocate_marshal_buffer<span class="op">(</span>type<span class="op">-&gt;</span>size<span class="op">);</span></span>
<span id="cb230-13"><a href="#cb230-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb230-14"><a href="#cb230-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> <span class="op">(</span>type<span class="op">-&gt;</span>kind<span class="op">)</span> <span class="op">{</span></span>
<span id="cb230-15"><a href="#cb230-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> FFI_TYPE_SINT32<span class="op">:</span></span>
<span id="cb230-16"><a href="#cb230-16" aria-hidden="true" tabindex="-1"></a>        <span class="op">*(</span><span class="dt">int32_t</span><span class="op">*)</span>buffer <span class="op">=</span> value_to_int32<span class="op">(</span>value<span class="op">);</span></span>
<span id="cb230-17"><a href="#cb230-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb230-18"><a href="#cb230-18" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb230-19"><a href="#cb230-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> FFI_TYPE_SINT64<span class="op">:</span></span>
<span id="cb230-20"><a href="#cb230-20" aria-hidden="true" tabindex="-1"></a>        <span class="op">*(</span><span class="dt">int64_t</span><span class="op">*)</span>buffer <span class="op">=</span> value_to_int64<span class="op">(</span>value<span class="op">);</span></span>
<span id="cb230-21"><a href="#cb230-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb230-22"><a href="#cb230-22" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb230-23"><a href="#cb230-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> FFI_TYPE_FLOAT<span class="op">:</span></span>
<span id="cb230-24"><a href="#cb230-24" aria-hidden="true" tabindex="-1"></a>        <span class="op">*(</span><span class="dt">float</span><span class="op">*)</span>buffer <span class="op">=</span> value_to_float<span class="op">(</span>value<span class="op">);</span></span>
<span id="cb230-25"><a href="#cb230-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb230-26"><a href="#cb230-26" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb230-27"><a href="#cb230-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> FFI_TYPE_DOUBLE<span class="op">:</span></span>
<span id="cb230-28"><a href="#cb230-28" aria-hidden="true" tabindex="-1"></a>        <span class="op">*(</span><span class="dt">double</span><span class="op">*)</span>buffer <span class="op">=</span> value_to_double<span class="op">(</span>value<span class="op">);</span></span>
<span id="cb230-29"><a href="#cb230-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb230-30"><a href="#cb230-30" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb230-31"><a href="#cb230-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> FFI_TYPE_POINTER<span class="op">:</span></span>
<span id="cb230-32"><a href="#cb230-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>IS_STRING<span class="op">(</span>value<span class="op">))</span> <span class="op">{</span></span>
<span id="cb230-33"><a href="#cb230-33" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Convert string to C string</span></span>
<span id="cb230-34"><a href="#cb230-34" aria-hidden="true" tabindex="-1"></a>            <span class="op">*(</span><span class="dt">char</span><span class="op">**)</span>buffer <span class="op">=</span> value_to_cstring<span class="op">(</span>value<span class="op">);</span></span>
<span id="cb230-35"><a href="#cb230-35" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>IS_BUFFER<span class="op">(</span>value<span class="op">))</span> <span class="op">{</span></span>
<span id="cb230-36"><a href="#cb230-36" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Get buffer pointer</span></span>
<span id="cb230-37"><a href="#cb230-37" aria-hidden="true" tabindex="-1"></a>            <span class="op">*(</span><span class="dt">void</span><span class="op">**)</span>buffer <span class="op">=</span> get_buffer_data<span class="op">(</span>value<span class="op">);</span></span>
<span id="cb230-38"><a href="#cb230-38" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb230-39"><a href="#cb230-39" aria-hidden="true" tabindex="-1"></a>            <span class="op">*(</span><span class="dt">void</span><span class="op">**)</span>buffer <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb230-40"><a href="#cb230-40" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb230-41"><a href="#cb230-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb230-42"><a href="#cb230-42" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb230-43"><a href="#cb230-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb230-44"><a href="#cb230-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> buffer<span class="op">;</span></span>
<span id="cb230-45"><a href="#cb230-45" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3>18.4.2 Complex Type Marshalling</h3>
<div class="sourceCode" id="cb231"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb231-1"><a href="#cb231-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span><span class="op">*</span> marshal_struct<span class="op">(</span>Value value<span class="op">,</span> FFIType <span class="op">*</span>struct_type<span class="op">)</span> <span class="op">{</span></span>
<span id="cb231-2"><a href="#cb231-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>IS_OBJECT<span class="op">(</span>value<span class="op">))</span> <span class="op">{</span></span>
<span id="cb231-3"><a href="#cb231-3" aria-hidden="true" tabindex="-1"></a>        error<span class="op">(</span><span class="st">&quot;Expected object for struct marshalling&quot;</span><span class="op">);</span></span>
<span id="cb231-4"><a href="#cb231-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> NULL<span class="op">;</span></span>
<span id="cb231-5"><a href="#cb231-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb231-6"><a href="#cb231-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb231-7"><a href="#cb231-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> struct_size <span class="op">=</span> struct_type<span class="op">-&gt;</span>size<span class="op">;</span></span>
<span id="cb231-8"><a href="#cb231-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span>buffer <span class="op">=</span> allocate_marshal_buffer<span class="op">(</span>struct_size<span class="op">);</span></span>
<span id="cb231-9"><a href="#cb231-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb231-10"><a href="#cb231-10" aria-hidden="true" tabindex="-1"></a>    Object <span class="op">*</span>obj <span class="op">=</span> AS_OBJECT<span class="op">(</span>value<span class="op">);</span></span>
<span id="cb231-11"><a href="#cb231-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb231-12"><a href="#cb231-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> struct_type<span class="op">-&gt;</span>data<span class="op">.</span>struct_type<span class="op">.</span>field_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb231-13"><a href="#cb231-13" aria-hidden="true" tabindex="-1"></a>        FFIType <span class="op">*</span>field_type <span class="op">=</span> struct_type<span class="op">-&gt;</span>data<span class="op">.</span>struct_type<span class="op">.</span>field_types<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb231-14"><a href="#cb231-14" aria-hidden="true" tabindex="-1"></a>        <span class="dt">size_t</span> offset <span class="op">=</span> struct_type<span class="op">-&gt;</span>data<span class="op">.</span>struct_type<span class="op">.</span>field_offsets<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb231-15"><a href="#cb231-15" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb231-16"><a href="#cb231-16" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Get field value from object</span></span>
<span id="cb231-17"><a href="#cb231-17" aria-hidden="true" tabindex="-1"></a>        Value field_value <span class="op">=</span> get_object_field<span class="op">(</span>obj<span class="op">,</span> i<span class="op">);</span></span>
<span id="cb231-18"><a href="#cb231-18" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb231-19"><a href="#cb231-19" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Marshal field</span></span>
<span id="cb231-20"><a href="#cb231-20" aria-hidden="true" tabindex="-1"></a>        <span class="dt">void</span> <span class="op">*</span>field_buffer <span class="op">=</span> marshal_value<span class="op">(</span>field_value<span class="op">,</span> field_type<span class="op">);</span></span>
<span id="cb231-21"><a href="#cb231-21" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb231-22"><a href="#cb231-22" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Copy to struct buffer</span></span>
<span id="cb231-23"><a href="#cb231-23" aria-hidden="true" tabindex="-1"></a>        memcpy<span class="op">((</span><span class="dt">char</span><span class="op">*)</span>buffer <span class="op">+</span> offset<span class="op">,</span> field_buffer<span class="op">,</span> field_type<span class="op">-&gt;</span>size<span class="op">);</span></span>
<span id="cb231-24"><a href="#cb231-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb231-25"><a href="#cb231-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb231-26"><a href="#cb231-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> buffer<span class="op">;</span></span>
<span id="cb231-27"><a href="#cb231-27" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb231-28"><a href="#cb231-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb231-29"><a href="#cb231-29" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> Value unmarshal_struct<span class="op">(</span><span class="dt">void</span> <span class="op">*</span>native<span class="op">,</span> FFIType <span class="op">*</span>struct_type<span class="op">)</span> <span class="op">{</span></span>
<span id="cb231-30"><a href="#cb231-30" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Create object to hold struct fields</span></span>
<span id="cb231-31"><a href="#cb231-31" aria-hidden="true" tabindex="-1"></a>    Object <span class="op">*</span>obj <span class="op">=</span> allocate_object<span class="op">(</span>struct_type<span class="op">-&gt;</span>data<span class="op">.</span>struct_type<span class="op">.</span>field_count<span class="op">);</span></span>
<span id="cb231-32"><a href="#cb231-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb231-33"><a href="#cb231-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> struct_type<span class="op">-&gt;</span>data<span class="op">.</span>struct_type<span class="op">.</span>field_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb231-34"><a href="#cb231-34" aria-hidden="true" tabindex="-1"></a>        FFIType <span class="op">*</span>field_type <span class="op">=</span> struct_type<span class="op">-&gt;</span>data<span class="op">.</span>struct_type<span class="op">.</span>field_types<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb231-35"><a href="#cb231-35" aria-hidden="true" tabindex="-1"></a>        <span class="dt">size_t</span> offset <span class="op">=</span> struct_type<span class="op">-&gt;</span>data<span class="op">.</span>struct_type<span class="op">.</span>field_offsets<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb231-36"><a href="#cb231-36" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb231-37"><a href="#cb231-37" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Unmarshal field</span></span>
<span id="cb231-38"><a href="#cb231-38" aria-hidden="true" tabindex="-1"></a>        <span class="dt">void</span> <span class="op">*</span>field_ptr <span class="op">=</span> <span class="op">(</span><span class="dt">char</span><span class="op">*)</span>native <span class="op">+</span> offset<span class="op">;</span></span>
<span id="cb231-39"><a href="#cb231-39" aria-hidden="true" tabindex="-1"></a>        Value field_value <span class="op">=</span> unmarshal_value<span class="op">(</span>field_ptr<span class="op">,</span> field_type<span class="op">);</span></span>
<span id="cb231-40"><a href="#cb231-40" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb231-41"><a href="#cb231-41" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Set field in object</span></span>
<span id="cb231-42"><a href="#cb231-42" aria-hidden="true" tabindex="-1"></a>        set_object_field<span class="op">(</span>obj<span class="op">,</span> i<span class="op">,</span> field_value<span class="op">);</span></span>
<span id="cb231-43"><a href="#cb231-43" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb231-44"><a href="#cb231-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb231-45"><a href="#cb231-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> OBJECT_VAL<span class="op">(</span>obj<span class="op">);</span></span>
<span id="cb231-46"><a href="#cb231-46" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3>18.4.3 String and Buffer Handling</h3>
<div class="sourceCode" id="cb232"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb232-1"><a href="#cb232-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> StringMarshaller <span class="op">{</span></span>
<span id="cb232-2"><a href="#cb232-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// String encoding</span></span>
<span id="cb232-3"><a href="#cb232-3" aria-hidden="true" tabindex="-1"></a>    Encoding default_encoding<span class="op">;</span></span>
<span id="cb232-4"><a href="#cb232-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb232-5"><a href="#cb232-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// String pools for efficiency</span></span>
<span id="cb232-6"><a href="#cb232-6" aria-hidden="true" tabindex="-1"></a>    StringPool <span class="op">*</span>cstring_pool<span class="op">;</span></span>
<span id="cb232-7"><a href="#cb232-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb232-8"><a href="#cb232-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Null termination handling</span></span>
<span id="cb232-9"><a href="#cb232-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> auto_null_terminate<span class="op">;</span></span>
<span id="cb232-10"><a href="#cb232-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> StringMarshaller<span class="op">;</span></span>
<span id="cb232-11"><a href="#cb232-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb232-12"><a href="#cb232-12" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">char</span><span class="op">*</span> marshal_string<span class="op">(</span>String <span class="op">*</span>str<span class="op">,</span> Encoding encoding<span class="op">)</span> <span class="op">{</span></span>
<span id="cb232-13"><a href="#cb232-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check if already cached</span></span>
<span id="cb232-14"><a href="#cb232-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span>cached <span class="op">=</span> string_pool_get<span class="op">(</span>vm<span class="op">-&gt;</span>ffi<span class="op">.</span>string_pool<span class="op">,</span> str<span class="op">);</span></span>
<span id="cb232-15"><a href="#cb232-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>cached<span class="op">)</span> <span class="cf">return</span> cached<span class="op">;</span></span>
<span id="cb232-16"><a href="#cb232-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb232-17"><a href="#cb232-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Convert encoding if needed</span></span>
<span id="cb232-18"><a href="#cb232-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>str<span class="op">-&gt;</span>encoding <span class="op">!=</span> encoding<span class="op">)</span> <span class="op">{</span></span>
<span id="cb232-19"><a href="#cb232-19" aria-hidden="true" tabindex="-1"></a>        str <span class="op">=</span> convert_string_encoding<span class="op">(</span>str<span class="op">,</span> encoding<span class="op">);</span></span>
<span id="cb232-20"><a href="#cb232-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb232-21"><a href="#cb232-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb232-22"><a href="#cb232-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Allocate C string</span></span>
<span id="cb232-23"><a href="#cb232-23" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> len <span class="op">=</span> str<span class="op">-&gt;</span>length<span class="op">;</span></span>
<span id="cb232-24"><a href="#cb232-24" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span>cstr <span class="op">=</span> allocate_cstring<span class="op">(</span>len <span class="op">+</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb232-25"><a href="#cb232-25" aria-hidden="true" tabindex="-1"></a>    memcpy<span class="op">(</span>cstr<span class="op">,</span> str<span class="op">-&gt;</span>data<span class="op">,</span> len<span class="op">);</span></span>
<span id="cb232-26"><a href="#cb232-26" aria-hidden="true" tabindex="-1"></a>    cstr<span class="op">[</span>len<span class="op">]</span> <span class="op">=</span> <span class="ch">&#39;</span><span class="sc">\0</span><span class="ch">&#39;</span><span class="op">;</span></span>
<span id="cb232-27"><a href="#cb232-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb232-28"><a href="#cb232-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Cache for reuse</span></span>
<span id="cb232-29"><a href="#cb232-29" aria-hidden="true" tabindex="-1"></a>    string_pool_put<span class="op">(</span>vm<span class="op">-&gt;</span>ffi<span class="op">.</span>string_pool<span class="op">,</span> str<span class="op">,</span> cstr<span class="op">);</span></span>
<span id="cb232-30"><a href="#cb232-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb232-31"><a href="#cb232-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> cstr<span class="op">;</span></span>
<span id="cb232-32"><a href="#cb232-32" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb232-33"><a href="#cb232-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb232-34"><a href="#cb232-34" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> String<span class="op">*</span> unmarshal_string<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>cstr<span class="op">,</span> Encoding encoding<span class="op">)</span> <span class="op">{</span></span>
<span id="cb232-35"><a href="#cb232-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>cstr<span class="op">)</span> <span class="cf">return</span> NULL<span class="op">;</span></span>
<span id="cb232-36"><a href="#cb232-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb232-37"><a href="#cb232-37" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> len <span class="op">=</span> strlen<span class="op">(</span>cstr<span class="op">);</span></span>
<span id="cb232-38"><a href="#cb232-38" aria-hidden="true" tabindex="-1"></a>    String <span class="op">*</span>str <span class="op">=</span> allocate_string<span class="op">(</span>len<span class="op">);</span></span>
<span id="cb232-39"><a href="#cb232-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb232-40"><a href="#cb232-40" aria-hidden="true" tabindex="-1"></a>    memcpy<span class="op">(</span>str<span class="op">-&gt;</span>data<span class="op">,</span> cstr<span class="op">,</span> len<span class="op">);</span></span>
<span id="cb232-41"><a href="#cb232-41" aria-hidden="true" tabindex="-1"></a>    str<span class="op">-&gt;</span>length <span class="op">=</span> len<span class="op">;</span></span>
<span id="cb232-42"><a href="#cb232-42" aria-hidden="true" tabindex="-1"></a>    str<span class="op">-&gt;</span>encoding <span class="op">=</span> encoding<span class="op">;</span></span>
<span id="cb232-43"><a href="#cb232-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb232-44"><a href="#cb232-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> str<span class="op">;</span></span>
<span id="cb232-45"><a href="#cb232-45" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>18.5 Callback Support</h2>
<h3>18.5.1 Managed to Native Callbacks</h3>
<div class="sourceCode" id="cb233"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb233-1"><a href="#cb233-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> FFICallback <span class="op">{</span></span>
<span id="cb233-2"><a href="#cb233-2" aria-hidden="true" tabindex="-1"></a>    Value callable<span class="op">;</span>           <span class="co">// Managed function/closure</span></span>
<span id="cb233-3"><a href="#cb233-3" aria-hidden="true" tabindex="-1"></a>    FFISignature <span class="op">*</span>signature<span class="op">;</span></span>
<span id="cb233-4"><a href="#cb233-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb233-5"><a href="#cb233-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Trampoline for native code</span></span>
<span id="cb233-6"><a href="#cb233-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span>trampoline<span class="op">;</span></span>
<span id="cb233-7"><a href="#cb233-7" aria-hidden="true" tabindex="-1"></a>    ffi_closure <span class="op">*</span>closure<span class="op">;</span></span>
<span id="cb233-8"><a href="#cb233-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb233-9"><a href="#cb233-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Reference tracking</span></span>
<span id="cb233-10"><a href="#cb233-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> ref_count<span class="op">;</span></span>
<span id="cb233-11"><a href="#cb233-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> is_permanent<span class="op">;</span></span>
<span id="cb233-12"><a href="#cb233-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> FFICallback<span class="op">;</span></span>
<span id="cb233-13"><a href="#cb233-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb233-14"><a href="#cb233-14" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span><span class="op">*</span> create_callback<span class="op">(</span>Value callable<span class="op">,</span> FFISignature <span class="op">*</span>signature<span class="op">)</span> <span class="op">{</span></span>
<span id="cb233-15"><a href="#cb233-15" aria-hidden="true" tabindex="-1"></a>    FFICallback <span class="op">*</span>callback <span class="op">=</span> allocate_ffi_callback<span class="op">();</span></span>
<span id="cb233-16"><a href="#cb233-16" aria-hidden="true" tabindex="-1"></a>    callback<span class="op">-&gt;</span>callable <span class="op">=</span> callable<span class="op">;</span></span>
<span id="cb233-17"><a href="#cb233-17" aria-hidden="true" tabindex="-1"></a>    callback<span class="op">-&gt;</span>signature <span class="op">=</span> signature<span class="op">;</span></span>
<span id="cb233-18"><a href="#cb233-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb233-19"><a href="#cb233-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Create closure using libffi</span></span>
<span id="cb233-20"><a href="#cb233-20" aria-hidden="true" tabindex="-1"></a>    callback<span class="op">-&gt;</span>closure <span class="op">=</span> ffi_closure_alloc<span class="op">(</span><span class="kw">sizeof</span><span class="op">(</span>ffi_closure<span class="op">),</span></span>
<span id="cb233-21"><a href="#cb233-21" aria-hidden="true" tabindex="-1"></a>                                          <span class="op">&amp;</span>callback<span class="op">-&gt;</span>trampoline<span class="op">);</span></span>
<span id="cb233-22"><a href="#cb233-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb233-23"><a href="#cb233-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>callback<span class="op">-&gt;</span>closure<span class="op">)</span> <span class="op">{</span></span>
<span id="cb233-24"><a href="#cb233-24" aria-hidden="true" tabindex="-1"></a>        error<span class="op">(</span><span class="st">&quot;Failed to allocate FFI closure&quot;</span><span class="op">);</span></span>
<span id="cb233-25"><a href="#cb233-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> NULL<span class="op">;</span></span>
<span id="cb233-26"><a href="#cb233-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb233-27"><a href="#cb233-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb233-28"><a href="#cb233-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Prepare closure</span></span>
<span id="cb233-29"><a href="#cb233-29" aria-hidden="true" tabindex="-1"></a>    ffi_cif <span class="op">*</span>cif <span class="op">=</span> prepare_callback_cif<span class="op">(</span>signature<span class="op">);</span></span>
<span id="cb233-30"><a href="#cb233-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb233-31"><a href="#cb233-31" aria-hidden="true" tabindex="-1"></a>    ffi_status status <span class="op">=</span> ffi_prep_closure_loc<span class="op">(</span>callback<span class="op">-&gt;</span>closure<span class="op">,</span> cif<span class="op">,</span></span>
<span id="cb233-32"><a href="#cb233-32" aria-hidden="true" tabindex="-1"></a>                                             callback_handler<span class="op">,</span></span>
<span id="cb233-33"><a href="#cb233-33" aria-hidden="true" tabindex="-1"></a>                                             callback<span class="op">,</span></span>
<span id="cb233-34"><a href="#cb233-34" aria-hidden="true" tabindex="-1"></a>                                             callback<span class="op">-&gt;</span>trampoline<span class="op">);</span></span>
<span id="cb233-35"><a href="#cb233-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb233-36"><a href="#cb233-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>status <span class="op">!=</span> FFI_OK<span class="op">)</span> <span class="op">{</span></span>
<span id="cb233-37"><a href="#cb233-37" aria-hidden="true" tabindex="-1"></a>        error<span class="op">(</span><span class="st">&quot;Failed to prepare FFI closure: </span><span class="sc">%d</span><span class="st">&quot;</span><span class="op">,</span> status<span class="op">);</span></span>
<span id="cb233-38"><a href="#cb233-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> NULL<span class="op">;</span></span>
<span id="cb233-39"><a href="#cb233-39" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb233-40"><a href="#cb233-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb233-41"><a href="#cb233-41" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Register callback to prevent GC</span></span>
<span id="cb233-42"><a href="#cb233-42" aria-hidden="true" tabindex="-1"></a>    register_callback<span class="op">(</span>vm<span class="op">-&gt;</span>ffi<span class="op">.</span>callbacks<span class="op">,</span> callback<span class="op">);</span></span>
<span id="cb233-43"><a href="#cb233-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb233-44"><a href="#cb233-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> callback<span class="op">-&gt;</span>trampoline<span class="op">;</span></span>
<span id="cb233-45"><a href="#cb233-45" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb233-46"><a href="#cb233-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb233-47"><a href="#cb233-47" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> callback_handler<span class="op">(</span>ffi_cif <span class="op">*</span>cif<span class="op">,</span> <span class="dt">void</span> <span class="op">*</span>ret<span class="op">,</span> </span>
<span id="cb233-48"><a href="#cb233-48" aria-hidden="true" tabindex="-1"></a>                            <span class="dt">void</span> <span class="op">**</span>args<span class="op">,</span> <span class="dt">void</span> <span class="op">*</span>user_data<span class="op">)</span> <span class="op">{</span></span>
<span id="cb233-49"><a href="#cb233-49" aria-hidden="true" tabindex="-1"></a>    FFICallback <span class="op">*</span>callback <span class="op">=</span> <span class="op">(</span>FFICallback<span class="op">*)</span>user_data<span class="op">;</span></span>
<span id="cb233-50"><a href="#cb233-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb233-51"><a href="#cb233-51" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Enter VM context</span></span>
<span id="cb233-52"><a href="#cb233-52" aria-hidden="true" tabindex="-1"></a>    Thread <span class="op">*</span>thread <span class="op">=</span> get_or_create_thread<span class="op">();</span></span>
<span id="cb233-53"><a href="#cb233-53" aria-hidden="true" tabindex="-1"></a>    VMContext ctx <span class="op">=</span> enter_vm_from_native<span class="op">(</span>thread<span class="op">);</span></span>
<span id="cb233-54"><a href="#cb233-54" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb233-55"><a href="#cb233-55" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Unmarshal arguments</span></span>
<span id="cb233-56"><a href="#cb233-56" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> arg_count <span class="op">=</span> callback<span class="op">-&gt;</span>signature<span class="op">-&gt;</span>param_count<span class="op">;</span></span>
<span id="cb233-57"><a href="#cb233-57" aria-hidden="true" tabindex="-1"></a>    Value <span class="op">*</span>managed_args <span class="op">=</span> allocate_value_array<span class="op">(</span>arg_count<span class="op">);</span></span>
<span id="cb233-58"><a href="#cb233-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb233-59"><a href="#cb233-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> arg_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb233-60"><a href="#cb233-60" aria-hidden="true" tabindex="-1"></a>        managed_args<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> unmarshal_value<span class="op">(</span>args<span class="op">[</span>i<span class="op">],</span></span>
<span id="cb233-61"><a href="#cb233-61" aria-hidden="true" tabindex="-1"></a>                                         callback<span class="op">-&gt;</span>signature<span class="op">-&gt;</span>param_types<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb233-62"><a href="#cb233-62" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb233-63"><a href="#cb233-63" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb233-64"><a href="#cb233-64" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Call managed function</span></span>
<span id="cb233-65"><a href="#cb233-65" aria-hidden="true" tabindex="-1"></a>    Value result <span class="op">=</span> call_value<span class="op">(</span>callback<span class="op">-&gt;</span>callable<span class="op">,</span> managed_args<span class="op">,</span> arg_count<span class="op">);</span></span>
<span id="cb233-66"><a href="#cb233-66" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb233-67"><a href="#cb233-67" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Marshal return value</span></span>
<span id="cb233-68"><a href="#cb233-68" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>callback<span class="op">-&gt;</span>signature<span class="op">-&gt;</span>return_type<span class="op">-&gt;</span>kin</span>
<span id="cb233-69"><a href="#cb233-69" aria-hidden="true" tabindex="-1"></a><span class="pp"># </span><span class="er">Chapter 19: Concurrency and Parallelism</span></span>
<span id="cb233-70"><a href="#cb233-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb233-71"><a href="#cb233-71" aria-hidden="true" tabindex="-1"></a><span class="pp">#</span><span class="er"># 19.1 Introduction</span></span>
<span id="cb233-72"><a href="#cb233-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb233-73"><a href="#cb233-73" aria-hidden="true" tabindex="-1"></a>This chapter explores Diyrbal<span class="ch">&#39;s</span><span class="er"> concurrency model, which draws inspiration from Joe Armstrong</span><span class="ch">&#39;</span>s actor model <span class="op">(</span>as seen in the uploaded thesis on concurrency<span class="op">)</span> <span class="cf">while</span> incorporating modern parallel execution capabilities<span class="op">.</span> We implement lightweight threads<span class="op">,</span> message passing<span class="op">,</span> shared<span class="op">-</span>nothing architecture<span class="op">,</span> and efficient work<span class="op">-</span>stealing <span class="cf">for</span> CPU<span class="op">-</span>bound tasks<span class="op">.</span></span>
<span id="cb233-74"><a href="#cb233-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb233-75"><a href="#cb233-75" aria-hidden="true" tabindex="-1"></a><span class="pp">#</span><span class="er"># 19.2 Concurrency Model Overview</span></span>
<span id="cb233-76"><a href="#cb233-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb233-77"><a href="#cb233-77" aria-hidden="true" tabindex="-1"></a><span class="pp">#</span><span class="er">## 19.2.1 Core Concepts</span></span>
<span id="cb233-78"><a href="#cb233-78" aria-hidden="true" tabindex="-1"></a>```c</span>
<span id="cb233-79"><a href="#cb233-79" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> ConcurrencyEngine <span class="op">{</span></span>
<span id="cb233-80"><a href="#cb233-80" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Thread management</span></span>
<span id="cb233-81"><a href="#cb233-81" aria-hidden="true" tabindex="-1"></a>    ThreadPool <span class="op">*</span>thread_pool<span class="op">;</span></span>
<span id="cb233-82"><a href="#cb233-82" aria-hidden="true" tabindex="-1"></a>    LightweightThreadScheduler <span class="op">*</span>lwt_scheduler<span class="op">;</span></span>
<span id="cb233-83"><a href="#cb233-83" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb233-84"><a href="#cb233-84" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Message passing</span></span>
<span id="cb233-85"><a href="#cb233-85" aria-hidden="true" tabindex="-1"></a>    MessageQueue <span class="op">*</span>global_mailbox<span class="op">;</span></span>
<span id="cb233-86"><a href="#cb233-86" aria-hidden="true" tabindex="-1"></a>    MessageRouter <span class="op">*</span>router<span class="op">;</span></span>
<span id="cb233-87"><a href="#cb233-87" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb233-88"><a href="#cb233-88" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Synchronization primitives</span></span>
<span id="cb233-89"><a href="#cb233-89" aria-hidden="true" tabindex="-1"></a>    LockManager <span class="op">*</span>lock_manager<span class="op">;</span></span>
<span id="cb233-90"><a href="#cb233-90" aria-hidden="true" tabindex="-1"></a>    AtomicOpsTable <span class="op">*</span>atomic_ops<span class="op">;</span></span>
<span id="cb233-91"><a href="#cb233-91" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb233-92"><a href="#cb233-92" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Work distribution</span></span>
<span id="cb233-93"><a href="#cb233-93" aria-hidden="true" tabindex="-1"></a>    WorkStealingQueue <span class="op">**</span>work_queues<span class="op">;</span></span>
<span id="cb233-94"><a href="#cb233-94" aria-hidden="true" tabindex="-1"></a>    LoadBalancer <span class="op">*</span>load_balancer<span class="op">;</span></span>
<span id="cb233-95"><a href="#cb233-95" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb233-96"><a href="#cb233-96" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Monitoring</span></span>
<span id="cb233-97"><a href="#cb233-97" aria-hidden="true" tabindex="-1"></a>    ConcurrencyMonitor <span class="op">*</span>monitor<span class="op">;</span></span>
<span id="cb233-98"><a href="#cb233-98" aria-hidden="true" tabindex="-1"></a>    DeadlockDetector <span class="op">*</span>deadlock_detector<span class="op">;</span></span>
<span id="cb233-99"><a href="#cb233-99" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> ConcurrencyEngine<span class="op">;</span></span>
<span id="cb233-100"><a href="#cb233-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb233-101"><a href="#cb233-101" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> LightweightThread <span class="op">{</span></span>
<span id="cb233-102"><a href="#cb233-102" aria-hidden="true" tabindex="-1"></a>    ThreadID id<span class="op">;</span></span>
<span id="cb233-103"><a href="#cb233-103" aria-hidden="true" tabindex="-1"></a>    ThreadState state<span class="op">;</span></span>
<span id="cb233-104"><a href="#cb233-104" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb233-105"><a href="#cb233-105" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Execution context</span></span>
<span id="cb233-106"><a href="#cb233-106" aria-hidden="true" tabindex="-1"></a>    Value <span class="op">*</span>stack<span class="op">;</span></span>
<span id="cb233-107"><a href="#cb233-107" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> stack_size<span class="op">;</span></span>
<span id="cb233-108"><a href="#cb233-108" aria-hidden="true" tabindex="-1"></a>    RegisterSet registers<span class="op">;</span></span>
<span id="cb233-109"><a href="#cb233-109" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb233-110"><a href="#cb233-110" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Message handling</span></span>
<span id="cb233-111"><a href="#cb233-111" aria-hidden="true" tabindex="-1"></a>    MessageQueue <span class="op">*</span>mailbox<span class="op">;</span></span>
<span id="cb233-112"><a href="#cb233-112" aria-hidden="true" tabindex="-1"></a>    MessagePattern <span class="op">*</span>receive_patterns<span class="op">;</span></span>
<span id="cb233-113"><a href="#cb233-113" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb233-114"><a href="#cb233-114" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Scheduling info</span></span>
<span id="cb233-115"><a href="#cb233-115" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint64_t</span> priority<span class="op">;</span></span>
<span id="cb233-116"><a href="#cb233-116" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint64_t</span> quantum_remaining<span class="op">;</span></span>
<span id="cb233-117"><a href="#cb233-117" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb233-118"><a href="#cb233-118" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Links and monitors</span></span>
<span id="cb233-119"><a href="#cb233-119" aria-hidden="true" tabindex="-1"></a>    ThreadID <span class="op">*</span>linked_threads<span class="op">;</span></span>
<span id="cb233-120"><a href="#cb233-120" aria-hidden="true" tabindex="-1"></a>    ThreadID <span class="op">*</span>monitoring_threads<span class="op">;</span></span>
<span id="cb233-121"><a href="#cb233-121" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> LightweightThread<span class="op">;</span></span></code></pre></div>
<h3>19.2.2 Actor-Based Architecture</h3>
<div class="sourceCode" id="cb234"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb234-1"><a href="#cb234-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> Actor <span class="op">{</span></span>
<span id="cb234-2"><a href="#cb234-2" aria-hidden="true" tabindex="-1"></a>    LightweightThread <span class="op">*</span>thread<span class="op">;</span></span>
<span id="cb234-3"><a href="#cb234-3" aria-hidden="true" tabindex="-1"></a>    ActorBehavior <span class="op">*</span>behavior<span class="op">;</span></span>
<span id="cb234-4"><a href="#cb234-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb234-5"><a href="#cb234-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// State isolation</span></span>
<span id="cb234-6"><a href="#cb234-6" aria-hidden="true" tabindex="-1"></a>    Heap <span class="op">*</span>private_heap<span class="op">;</span></span>
<span id="cb234-7"><a href="#cb234-7" aria-hidden="true" tabindex="-1"></a>    Value state<span class="op">;</span></span>
<span id="cb234-8"><a href="#cb234-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb234-9"><a href="#cb234-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Supervision</span></span>
<span id="cb234-10"><a href="#cb234-10" aria-hidden="true" tabindex="-1"></a>    ActorID supervisor<span class="op">;</span></span>
<span id="cb234-11"><a href="#cb234-11" aria-hidden="true" tabindex="-1"></a>    SupervisionStrategy strategy<span class="op">;</span></span>
<span id="cb234-12"><a href="#cb234-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb234-13"><a href="#cb234-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Lifecycle</span></span>
<span id="cb234-14"><a href="#cb234-14" aria-hidden="true" tabindex="-1"></a>    ActorState lifecycle_state<span class="op">;</span></span>
<span id="cb234-15"><a href="#cb234-15" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint64_t</span> restart_count<span class="op">;</span></span>
<span id="cb234-16"><a href="#cb234-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> Actor<span class="op">;</span></span>
<span id="cb234-17"><a href="#cb234-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb234-18"><a href="#cb234-18" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> Message <span class="op">{</span></span>
<span id="cb234-19"><a href="#cb234-19" aria-hidden="true" tabindex="-1"></a>    MessageID id<span class="op">;</span></span>
<span id="cb234-20"><a href="#cb234-20" aria-hidden="true" tabindex="-1"></a>    ActorID sender<span class="op">;</span></span>
<span id="cb234-21"><a href="#cb234-21" aria-hidden="true" tabindex="-1"></a>    ActorID receiver<span class="op">;</span></span>
<span id="cb234-22"><a href="#cb234-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb234-23"><a href="#cb234-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Payload</span></span>
<span id="cb234-24"><a href="#cb234-24" aria-hidden="true" tabindex="-1"></a>    Value content<span class="op">;</span></span>
<span id="cb234-25"><a href="#cb234-25" aria-hidden="true" tabindex="-1"></a>    MessageType type<span class="op">;</span></span>
<span id="cb234-26"><a href="#cb234-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb234-27"><a href="#cb234-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Delivery guarantees</span></span>
<span id="cb234-28"><a href="#cb234-28" aria-hidden="true" tabindex="-1"></a>    DeliveryMode mode<span class="op">;</span>  <span class="co">// AT_MOST_ONCE, EXACTLY_ONCE</span></span>
<span id="cb234-29"><a href="#cb234-29" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint64_t</span> timeout<span class="op">;</span></span>
<span id="cb234-30"><a href="#cb234-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb234-31"><a href="#cb234-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Tracing</span></span>
<span id="cb234-32"><a href="#cb234-32" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint64_t</span> timestamp<span class="op">;</span></span>
<span id="cb234-33"><a href="#cb234-33" aria-hidden="true" tabindex="-1"></a>    SpanContext trace_context<span class="op">;</span></span>
<span id="cb234-34"><a href="#cb234-34" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> Message<span class="op">;</span></span></code></pre></div>
<h2>19.3 Lightweight Thread Implementation</h2>
<h3>19.3.1 Thread Creation and Management</h3>
<div class="sourceCode" id="cb235"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb235-1"><a href="#cb235-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> LightweightThread<span class="op">*</span> create_lightweight_thread<span class="op">(</span>Value entry_point<span class="op">,</span></span>
<span id="cb235-2"><a href="#cb235-2" aria-hidden="true" tabindex="-1"></a>                                                   Value <span class="op">*</span>args<span class="op">,</span></span>
<span id="cb235-3"><a href="#cb235-3" aria-hidden="true" tabindex="-1"></a>                                                   <span class="dt">size_t</span> arg_count<span class="op">)</span> <span class="op">{</span></span>
<span id="cb235-4"><a href="#cb235-4" aria-hidden="true" tabindex="-1"></a>    LightweightThread <span class="op">*</span>thread <span class="op">=</span> allocate_lwt<span class="op">();</span></span>
<span id="cb235-5"><a href="#cb235-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb235-6"><a href="#cb235-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Allocate stack (small initial size)</span></span>
<span id="cb235-7"><a href="#cb235-7" aria-hidden="true" tabindex="-1"></a>    thread<span class="op">-&gt;</span>stack_size <span class="op">=</span> INITIAL_LWT_STACK_SIZE<span class="op">;</span>  <span class="co">// 8KB</span></span>
<span id="cb235-8"><a href="#cb235-8" aria-hidden="true" tabindex="-1"></a>    thread<span class="op">-&gt;</span>stack <span class="op">=</span> allocate_stack<span class="op">(</span>thread<span class="op">-&gt;</span>stack_size<span class="op">);</span></span>
<span id="cb235-9"><a href="#cb235-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb235-10"><a href="#cb235-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Initialize registers</span></span>
<span id="cb235-11"><a href="#cb235-11" aria-hidden="true" tabindex="-1"></a>    thread<span class="op">-&gt;</span>registers<span class="op">.</span>sp <span class="op">=</span> thread<span class="op">-&gt;</span>stack <span class="op">+</span> thread<span class="op">-&gt;</span>stack_size<span class="op">;</span></span>
<span id="cb235-12"><a href="#cb235-12" aria-hidden="true" tabindex="-1"></a>    thread<span class="op">-&gt;</span>registers<span class="op">.</span>fp <span class="op">=</span> thread<span class="op">-&gt;</span>registers<span class="op">.</span>sp<span class="op">;</span></span>
<span id="cb235-13"><a href="#cb235-13" aria-hidden="true" tabindex="-1"></a>    thread<span class="op">-&gt;</span>registers<span class="op">.</span>ip <span class="op">=</span> get_entry_address<span class="op">(</span>entry_point<span class="op">);</span></span>
<span id="cb235-14"><a href="#cb235-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb235-15"><a href="#cb235-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Setup initial frame</span></span>
<span id="cb235-16"><a href="#cb235-16" aria-hidden="true" tabindex="-1"></a>    push_frame<span class="op">(&amp;</span>thread<span class="op">-&gt;</span>registers<span class="op">,</span> entry_point<span class="op">,</span> args<span class="op">,</span> arg_count<span class="op">);</span></span>
<span id="cb235-17"><a href="#cb235-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb235-18"><a href="#cb235-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Create mailbox</span></span>
<span id="cb235-19"><a href="#cb235-19" aria-hidden="true" tabindex="-1"></a>    thread<span class="op">-&gt;</span>mailbox <span class="op">=</span> create_message_queue<span class="op">(</span>DEFAULT_MAILBOX_SIZE<span class="op">);</span></span>
<span id="cb235-20"><a href="#cb235-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb235-21"><a href="#cb235-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Set initial state</span></span>
<span id="cb235-22"><a href="#cb235-22" aria-hidden="true" tabindex="-1"></a>    thread<span class="op">-&gt;</span>state <span class="op">=</span> THREAD_READY<span class="op">;</span></span>
<span id="cb235-23"><a href="#cb235-23" aria-hidden="true" tabindex="-1"></a>    thread<span class="op">-&gt;</span>quantum_remaining <span class="op">=</span> DEFAULT_QUANTUM<span class="op">;</span></span>
<span id="cb235-24"><a href="#cb235-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb235-25"><a href="#cb235-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Register with scheduler</span></span>
<span id="cb235-26"><a href="#cb235-26" aria-hidden="true" tabindex="-1"></a>    schedule_thread<span class="op">(</span>vm<span class="op">-&gt;</span>concurrency<span class="op">.</span>lwt_scheduler<span class="op">,</span> thread<span class="op">);</span></span>
<span id="cb235-27"><a href="#cb235-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb235-28"><a href="#cb235-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> thread<span class="op">;</span></span>
<span id="cb235-29"><a href="#cb235-29" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb235-30"><a href="#cb235-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb235-31"><a href="#cb235-31" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> schedule_thread<span class="op">(</span>LightweightThreadScheduler <span class="op">*</span>scheduler<span class="op">,</span></span>
<span id="cb235-32"><a href="#cb235-32" aria-hidden="true" tabindex="-1"></a>                           LightweightThread <span class="op">*</span>thread<span class="op">)</span> <span class="op">{</span></span>
<span id="cb235-33"><a href="#cb235-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Add to appropriate run queue based on priority</span></span>
<span id="cb235-34"><a href="#cb235-34" aria-hidden="true" tabindex="-1"></a>    RunQueue <span class="op">*</span>queue <span class="op">=</span> get_priority_queue<span class="op">(</span>scheduler<span class="op">,</span> thread<span class="op">-&gt;</span>priority<span class="op">);</span></span>
<span id="cb235-35"><a href="#cb235-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb235-36"><a href="#cb235-36" aria-hidden="true" tabindex="-1"></a>    acquire_spinlock<span class="op">(&amp;</span>queue<span class="op">-&gt;</span>lock<span class="op">);</span></span>
<span id="cb235-37"><a href="#cb235-37" aria-hidden="true" tabindex="-1"></a>    enqueue_thread<span class="op">(</span>queue<span class="op">,</span> thread<span class="op">);</span></span>
<span id="cb235-38"><a href="#cb235-38" aria-hidden="true" tabindex="-1"></a>    release_spinlock<span class="op">(&amp;</span>queue<span class="op">-&gt;</span>lock<span class="op">);</span></span>
<span id="cb235-39"><a href="#cb235-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb235-40"><a href="#cb235-40" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Wake idle worker if available</span></span>
<span id="cb235-41"><a href="#cb235-41" aria-hidden="true" tabindex="-1"></a>    wake_idle_worker<span class="op">(</span>scheduler<span class="op">);</span></span>
<span id="cb235-42"><a href="#cb235-42" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3>19.3.2 Cooperative and Preemptive Scheduling</h3>
<div class="sourceCode" id="cb236"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb236-1"><a href="#cb236-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> LightweightThreadScheduler <span class="op">{</span></span>
<span id="cb236-2"><a href="#cb236-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Multi-level priority queues</span></span>
<span id="cb236-3"><a href="#cb236-3" aria-hidden="true" tabindex="-1"></a>    RunQueue <span class="op">*</span>priority_queues<span class="op">[</span>NUM_PRIORITIES<span class="op">];</span></span>
<span id="cb236-4"><a href="#cb236-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb236-5"><a href="#cb236-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Worker threads</span></span>
<span id="cb236-6"><a href="#cb236-6" aria-hidden="true" tabindex="-1"></a>    WorkerThread <span class="op">*</span>workers<span class="op">;</span></span>
<span id="cb236-7"><a href="#cb236-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> worker_count<span class="op">;</span></span>
<span id="cb236-8"><a href="#cb236-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb236-9"><a href="#cb236-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Scheduling policy</span></span>
<span id="cb236-10"><a href="#cb236-10" aria-hidden="true" tabindex="-1"></a>    SchedulingPolicy policy<span class="op">;</span></span>
<span id="cb236-11"><a href="#cb236-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint64_t</span> time_slice_ns<span class="op">;</span></span>
<span id="cb236-12"><a href="#cb236-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb236-13"><a href="#cb236-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Load tracking</span></span>
<span id="cb236-14"><a href="#cb236-14" aria-hidden="true" tabindex="-1"></a>    LoadStatistics <span class="op">*</span>load_stats<span class="op">;</span></span>
<span id="cb236-15"><a href="#cb236-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb236-16"><a href="#cb236-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Timer for preemption</span></span>
<span id="cb236-17"><a href="#cb236-17" aria-hidden="true" tabindex="-1"></a>    TimerHandle preemption_timer<span class="op">;</span></span>
<span id="cb236-18"><a href="#cb236-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> LightweightThreadScheduler<span class="op">;</span></span>
<span id="cb236-19"><a href="#cb236-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-20"><a href="#cb236-20" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> worker_thread_loop<span class="op">(</span>WorkerThread <span class="op">*</span>worker<span class="op">)</span> <span class="op">{</span></span>
<span id="cb236-21"><a href="#cb236-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(!</span>worker<span class="op">-&gt;</span>shutdown<span class="op">)</span> <span class="op">{</span></span>
<span id="cb236-22"><a href="#cb236-22" aria-hidden="true" tabindex="-1"></a>        LightweightThread <span class="op">*</span>thread <span class="op">=</span> get_next_thread<span class="op">(</span>worker<span class="op">);</span></span>
<span id="cb236-23"><a href="#cb236-23" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb236-24"><a href="#cb236-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(!</span>thread<span class="op">)</span> <span class="op">{</span></span>
<span id="cb236-25"><a href="#cb236-25" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Try work stealing</span></span>
<span id="cb236-26"><a href="#cb236-26" aria-hidden="true" tabindex="-1"></a>            thread <span class="op">=</span> steal_work<span class="op">(</span>worker<span class="op">);</span></span>
<span id="cb236-27"><a href="#cb236-27" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(!</span>thread<span class="op">)</span> <span class="op">{</span></span>
<span id="cb236-28"><a href="#cb236-28" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Park worker</span></span>
<span id="cb236-29"><a href="#cb236-29" aria-hidden="true" tabindex="-1"></a>                park_worker<span class="op">(</span>worker<span class="op">);</span></span>
<span id="cb236-30"><a href="#cb236-30" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb236-31"><a href="#cb236-31" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb236-32"><a href="#cb236-32" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb236-33"><a href="#cb236-33" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb236-34"><a href="#cb236-34" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Execute thread</span></span>
<span id="cb236-35"><a href="#cb236-35" aria-hidden="true" tabindex="-1"></a>        execute_lightweight_thread<span class="op">(</span>worker<span class="op">,</span> thread<span class="op">);</span></span>
<span id="cb236-36"><a href="#cb236-36" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb236-37"><a href="#cb236-37" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb236-38"><a href="#cb236-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-39"><a href="#cb236-39" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> execute_lightweight_thread<span class="op">(</span>WorkerThread <span class="op">*</span>worker<span class="op">,</span></span>
<span id="cb236-40"><a href="#cb236-40" aria-hidden="true" tabindex="-1"></a>                                      LightweightThread <span class="op">*</span>thread<span class="op">)</span> <span class="op">{</span></span>
<span id="cb236-41"><a href="#cb236-41" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Set current thread context</span></span>
<span id="cb236-42"><a href="#cb236-42" aria-hidden="true" tabindex="-1"></a>    worker<span class="op">-&gt;</span>current_thread <span class="op">=</span> thread<span class="op">;</span></span>
<span id="cb236-43"><a href="#cb236-43" aria-hidden="true" tabindex="-1"></a>    thread<span class="op">-&gt;</span>state <span class="op">=</span> THREAD_RUNNING<span class="op">;</span></span>
<span id="cb236-44"><a href="#cb236-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb236-45"><a href="#cb236-45" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Start preemption timer if needed</span></span>
<span id="cb236-46"><a href="#cb236-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>scheduler<span class="op">-&gt;</span>policy <span class="op">==</span> PREEMPTIVE<span class="op">)</span> <span class="op">{</span></span>
<span id="cb236-47"><a href="#cb236-47" aria-hidden="true" tabindex="-1"></a>        arm_preemption_timer<span class="op">(</span>thread<span class="op">-&gt;</span>quantum_remaining<span class="op">);</span></span>
<span id="cb236-48"><a href="#cb236-48" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb236-49"><a href="#cb236-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb236-50"><a href="#cb236-50" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Restore thread context</span></span>
<span id="cb236-51"><a href="#cb236-51" aria-hidden="true" tabindex="-1"></a>    restore_context<span class="op">(&amp;</span>thread<span class="op">-&gt;</span>registers<span class="op">);</span></span>
<span id="cb236-52"><a href="#cb236-52" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb236-53"><a href="#cb236-53" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Execute until yield/preemption/completion</span></span>
<span id="cb236-54"><a href="#cb236-54" aria-hidden="true" tabindex="-1"></a>    ExecutionResult result <span class="op">=</span> run_thread_quantum<span class="op">(</span>thread<span class="op">);</span></span>
<span id="cb236-55"><a href="#cb236-55" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb236-56"><a href="#cb236-56" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Save context if not completed</span></span>
<span id="cb236-57"><a href="#cb236-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>result <span class="op">!=</span> THREAD_COMPLETED<span class="op">)</span> <span class="op">{</span></span>
<span id="cb236-58"><a href="#cb236-58" aria-hidden="true" tabindex="-1"></a>        save_context<span class="op">(&amp;</span>thread<span class="op">-&gt;</span>registers<span class="op">);</span></span>
<span id="cb236-59"><a href="#cb236-59" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb236-60"><a href="#cb236-60" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Reschedule based on result</span></span>
<span id="cb236-61"><a href="#cb236-61" aria-hidden="true" tabindex="-1"></a>        <span class="cf">switch</span> <span class="op">(</span>result<span class="op">)</span> <span class="op">{</span></span>
<span id="cb236-62"><a href="#cb236-62" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> QUANTUM_EXPIRED<span class="op">:</span></span>
<span id="cb236-63"><a href="#cb236-63" aria-hidden="true" tabindex="-1"></a>            thread<span class="op">-&gt;</span>quantum_remaining <span class="op">=</span> DEFAULT_QUANTUM<span class="op">;</span></span>
<span id="cb236-64"><a href="#cb236-64" aria-hidden="true" tabindex="-1"></a>            thread<span class="op">-&gt;</span>state <span class="op">=</span> THREAD_READY<span class="op">;</span></span>
<span id="cb236-65"><a href="#cb236-65" aria-hidden="true" tabindex="-1"></a>            schedule_thread<span class="op">(</span>scheduler<span class="op">,</span> thread<span class="op">);</span></span>
<span id="cb236-66"><a href="#cb236-66" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span><span class="op">;</span></span>
<span id="cb236-67"><a href="#cb236-67" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb236-68"><a href="#cb236-68" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> THREAD_YIELDED<span class="op">:</span></span>
<span id="cb236-69"><a href="#cb236-69" aria-hidden="true" tabindex="-1"></a>            thread<span class="op">-&gt;</span>state <span class="op">=</span> THREAD_READY<span class="op">;</span></span>
<span id="cb236-70"><a href="#cb236-70" aria-hidden="true" tabindex="-1"></a>            schedule_thread<span class="op">(</span>scheduler<span class="op">,</span> thread<span class="op">);</span></span>
<span id="cb236-71"><a href="#cb236-71" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span><span class="op">;</span></span>
<span id="cb236-72"><a href="#cb236-72" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb236-73"><a href="#cb236-73" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> THREAD_BLOCKED<span class="op">:</span></span>
<span id="cb236-74"><a href="#cb236-74" aria-hidden="true" tabindex="-1"></a>            thread<span class="op">-&gt;</span>state <span class="op">=</span> THREAD_BLOCKED<span class="op">;</span></span>
<span id="cb236-75"><a href="#cb236-75" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Will be rescheduled when unblocked</span></span>
<span id="cb236-76"><a href="#cb236-76" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span><span class="op">;</span></span>
<span id="cb236-77"><a href="#cb236-77" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb236-78"><a href="#cb236-78" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb236-79"><a href="#cb236-79" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Thread completed</span></span>
<span id="cb236-80"><a href="#cb236-80" aria-hidden="true" tabindex="-1"></a>        cleanup_thread<span class="op">(</span>thread<span class="op">);</span></span>
<span id="cb236-81"><a href="#cb236-81" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb236-82"><a href="#cb236-82" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb236-83"><a href="#cb236-83" aria-hidden="true" tabindex="-1"></a>    worker<span class="op">-&gt;</span>current_thread <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb236-84"><a href="#cb236-84" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>19.4 Message Passing System</h2>
<h3>19.4.1 Asynchronous Message Passing</h3>
<div class="sourceCode" id="cb237"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb237-1"><a href="#cb237-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> send_message<span class="op">(</span>ActorID sender<span class="op">,</span> ActorID receiver<span class="op">,</span> Value content<span class="op">)</span> <span class="op">{</span></span>
<span id="cb237-2"><a href="#cb237-2" aria-hidden="true" tabindex="-1"></a>    Message <span class="op">*</span>msg <span class="op">=</span> allocate_message<span class="op">();</span></span>
<span id="cb237-3"><a href="#cb237-3" aria-hidden="true" tabindex="-1"></a>    msg<span class="op">-&gt;</span>id <span class="op">=</span> generate_message_id<span class="op">();</span></span>
<span id="cb237-4"><a href="#cb237-4" aria-hidden="true" tabindex="-1"></a>    msg<span class="op">-&gt;</span>sender <span class="op">=</span> sender<span class="op">;</span></span>
<span id="cb237-5"><a href="#cb237-5" aria-hidden="true" tabindex="-1"></a>    msg<span class="op">-&gt;</span>receiver <span class="op">=</span> receiver<span class="op">;</span></span>
<span id="cb237-6"><a href="#cb237-6" aria-hidden="true" tabindex="-1"></a>    msg<span class="op">-&gt;</span>content <span class="op">=</span> copy_value_deep<span class="op">(</span>content<span class="op">);</span>  <span class="co">// Immutable messages</span></span>
<span id="cb237-7"><a href="#cb237-7" aria-hidden="true" tabindex="-1"></a>    msg<span class="op">-&gt;</span>timestamp <span class="op">=</span> get_timestamp<span class="op">();</span></span>
<span id="cb237-8"><a href="#cb237-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb237-9"><a href="#cb237-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Route message</span></span>
<span id="cb237-10"><a href="#cb237-10" aria-hidden="true" tabindex="-1"></a>    Actor <span class="op">*</span>target <span class="op">=</span> lookup_actor<span class="op">(</span>receiver<span class="op">);</span></span>
<span id="cb237-11"><a href="#cb237-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>target<span class="op">)</span> <span class="op">{</span></span>
<span id="cb237-12"><a href="#cb237-12" aria-hidden="true" tabindex="-1"></a>        handle_dead_letter<span class="op">(</span>msg<span class="op">);</span></span>
<span id="cb237-13"><a href="#cb237-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span><span class="op">;</span></span>
<span id="cb237-14"><a href="#cb237-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb237-15"><a href="#cb237-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb237-16"><a href="#cb237-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Enqueue in target&#39;s mailbox</span></span>
<span id="cb237-17"><a href="#cb237-17" aria-hidden="true" tabindex="-1"></a>    MessageQueue <span class="op">*</span>mailbox <span class="op">=</span> target<span class="op">-&gt;</span>thread<span class="op">-&gt;</span>mailbox<span class="op">;</span></span>
<span id="cb237-18"><a href="#cb237-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>enqueue_message<span class="op">(</span>mailbox<span class="op">,</span> msg<span class="op">))</span> <span class="op">{</span></span>
<span id="cb237-19"><a href="#cb237-19" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Mailbox full</span></span>
<span id="cb237-20"><a href="#cb237-20" aria-hidden="true" tabindex="-1"></a>        handle_mailbox_overflow<span class="op">(</span>target<span class="op">,</span> msg<span class="op">);</span></span>
<span id="cb237-21"><a href="#cb237-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb237-22"><a href="#cb237-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb237-23"><a href="#cb237-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Wake target if sleeping</span></span>
<span id="cb237-24"><a href="#cb237-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>target<span class="op">-&gt;</span>thread<span class="op">-&gt;</span>state <span class="op">==</span> THREAD_BLOCKED_RECEIVE<span class="op">)</span> <span class="op">{</span></span>
<span id="cb237-25"><a href="#cb237-25" aria-hidden="true" tabindex="-1"></a>        target<span class="op">-&gt;</span>thread<span class="op">-&gt;</span>state <span class="op">=</span> THREAD_READY<span class="op">;</span></span>
<span id="cb237-26"><a href="#cb237-26" aria-hidden="true" tabindex="-1"></a>        schedule_thread<span class="op">(</span>scheduler<span class="op">,</span> target<span class="op">-&gt;</span>thread<span class="op">);</span></span>
<span id="cb237-27"><a href="#cb237-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb237-28"><a href="#cb237-28" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb237-29"><a href="#cb237-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb237-30"><a href="#cb237-30" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> Value receive_message<span class="op">(</span>Actor <span class="op">*</span>actor<span class="op">,</span> MessagePattern <span class="op">*</span>patterns<span class="op">,</span></span>
<span id="cb237-31"><a href="#cb237-31" aria-hidden="true" tabindex="-1"></a>                           <span class="dt">uint64_t</span> timeout_ms<span class="op">)</span> <span class="op">{</span></span>
<span id="cb237-32"><a href="#cb237-32" aria-hidden="true" tabindex="-1"></a>    LightweightThread <span class="op">*</span>thread <span class="op">=</span> actor<span class="op">-&gt;</span>thread<span class="op">;</span></span>
<span id="cb237-33"><a href="#cb237-33" aria-hidden="true" tabindex="-1"></a>    MessageQueue <span class="op">*</span>mailbox <span class="op">=</span> thread<span class="op">-&gt;</span>mailbox<span class="op">;</span></span>
<span id="cb237-34"><a href="#cb237-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb237-35"><a href="#cb237-35" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint64_t</span> deadline <span class="op">=</span> get_timestamp<span class="op">()</span> <span class="op">+</span> timeout_ms <span class="op">*</span> <span class="dv">1000000</span><span class="op">;</span></span>
<span id="cb237-36"><a href="#cb237-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb237-37"><a href="#cb237-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span><span class="kw">true</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb237-38"><a href="#cb237-38" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Try to match message</span></span>
<span id="cb237-39"><a href="#cb237-39" aria-hidden="true" tabindex="-1"></a>        Message <span class="op">*</span>msg <span class="op">=</span> dequeue_matching_message<span class="op">(</span>mailbox<span class="op">,</span> patterns<span class="op">);</span></span>
<span id="cb237-40"><a href="#cb237-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>msg<span class="op">)</span> <span class="op">{</span></span>
<span id="cb237-41"><a href="#cb237-41" aria-hidden="true" tabindex="-1"></a>            Value result <span class="op">=</span> msg<span class="op">-&gt;</span>content<span class="op">;</span></span>
<span id="cb237-42"><a href="#cb237-42" aria-hidden="true" tabindex="-1"></a>            free_message<span class="op">(</span>msg<span class="op">);</span></span>
<span id="cb237-43"><a href="#cb237-43" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> result<span class="op">;</span></span>
<span id="cb237-44"><a href="#cb237-44" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb237-45"><a href="#cb237-45" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb237-46"><a href="#cb237-46" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Check timeout</span></span>
<span id="cb237-47"><a href="#cb237-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>get_timestamp<span class="op">()</span> <span class="op">&gt;=</span> deadline<span class="op">)</span> <span class="op">{</span></span>
<span id="cb237-48"><a href="#cb237-48" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> TIMEOUT_VAL<span class="op">;</span></span>
<span id="cb237-49"><a href="#cb237-49" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb237-50"><a href="#cb237-50" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb237-51"><a href="#cb237-51" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Block thread</span></span>
<span id="cb237-52"><a href="#cb237-52" aria-hidden="true" tabindex="-1"></a>        thread<span class="op">-&gt;</span>state <span class="op">=</span> THREAD_BLOCKED_RECEIVE<span class="op">;</span></span>
<span id="cb237-53"><a href="#cb237-53" aria-hidden="true" tabindex="-1"></a>        thread<span class="op">-&gt;</span>receive_patterns <span class="op">=</span> patterns<span class="op">;</span></span>
<span id="cb237-54"><a href="#cb237-54" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb237-55"><a href="#cb237-55" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Yield to scheduler</span></span>
<span id="cb237-56"><a href="#cb237-56" aria-hidden="true" tabindex="-1"></a>        yield_thread<span class="op">();</span></span>
<span id="cb237-57"><a href="#cb237-57" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb237-58"><a href="#cb237-58" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3>19.4.2 Selective Receive and Pattern Matching</h3>
<div class="sourceCode" id="cb238"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb238-1"><a href="#cb238-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> MessagePattern <span class="op">{</span></span>
<span id="cb238-2"><a href="#cb238-2" aria-hidden="true" tabindex="-1"></a>    PatternType type<span class="op">;</span></span>
<span id="cb238-3"><a href="#cb238-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb238-4"><a href="#cb238-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">union</span> <span class="op">{</span></span>
<span id="cb238-5"><a href="#cb238-5" aria-hidden="true" tabindex="-1"></a>        <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb238-6"><a href="#cb238-6" aria-hidden="true" tabindex="-1"></a>            Value pattern<span class="op">;</span></span>
<span id="cb238-7"><a href="#cb238-7" aria-hidden="true" tabindex="-1"></a>            GuardFunction guard<span class="op">;</span></span>
<span id="cb238-8"><a href="#cb238-8" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> value_pattern<span class="op">;</span></span>
<span id="cb238-9"><a href="#cb238-9" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb238-10"><a href="#cb238-10" aria-hidden="true" tabindex="-1"></a>        <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb238-11"><a href="#cb238-11" aria-hidden="true" tabindex="-1"></a>            ActorID sender<span class="op">;</span></span>
<span id="cb238-12"><a href="#cb238-12" aria-hidden="true" tabindex="-1"></a>            MessageType type<span class="op">;</span></span>
<span id="cb238-13"><a href="#cb238-13" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> sender_pattern<span class="op">;</span></span>
<span id="cb238-14"><a href="#cb238-14" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb238-15"><a href="#cb238-15" aria-hidden="true" tabindex="-1"></a>        <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb238-16"><a href="#cb238-16" aria-hidden="true" tabindex="-1"></a>            PatternPredicate predicate<span class="op">;</span></span>
<span id="cb238-17"><a href="#cb238-17" aria-hidden="true" tabindex="-1"></a>            <span class="dt">void</span> <span class="op">*</span>context<span class="op">;</span></span>
<span id="cb238-18"><a href="#cb238-18" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> predicate_pattern<span class="op">;</span></span>
<span id="cb238-19"><a href="#cb238-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> data<span class="op">;</span></span>
<span id="cb238-20"><a href="#cb238-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb238-21"><a href="#cb238-21" aria-hidden="true" tabindex="-1"></a>    MessagePattern <span class="op">*</span>next<span class="op">;</span>  <span class="co">// For pattern chains</span></span>
<span id="cb238-22"><a href="#cb238-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> MessagePattern<span class="op">;</span></span>
<span id="cb238-23"><a href="#cb238-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb238-24"><a href="#cb238-24" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> Message<span class="op">*</span> dequeue_matching_message<span class="op">(</span>MessageQueue <span class="op">*</span>queue<span class="op">,</span></span>
<span id="cb238-25"><a href="#cb238-25" aria-hidden="true" tabindex="-1"></a>                                       MessagePattern <span class="op">*</span>patterns<span class="op">)</span> <span class="op">{</span></span>
<span id="cb238-26"><a href="#cb238-26" aria-hidden="true" tabindex="-1"></a>    acquire_lock<span class="op">(&amp;</span>queue<span class="op">-&gt;</span>lock<span class="op">);</span></span>
<span id="cb238-27"><a href="#cb238-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb238-28"><a href="#cb238-28" aria-hidden="true" tabindex="-1"></a>    Message <span class="op">*</span>prev <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb238-29"><a href="#cb238-29" aria-hidden="true" tabindex="-1"></a>    Message <span class="op">*</span>current <span class="op">=</span> queue<span class="op">-&gt;</span>head<span class="op">;</span></span>
<span id="cb238-30"><a href="#cb238-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb238-31"><a href="#cb238-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span>current<span class="op">)</span> <span class="op">{</span></span>
<span id="cb238-32"><a href="#cb238-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>matches_any_pattern<span class="op">(</span>current<span class="op">,</span> patterns<span class="op">))</span> <span class="op">{</span></span>
<span id="cb238-33"><a href="#cb238-33" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Remove from queue</span></span>
<span id="cb238-34"><a href="#cb238-34" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>prev<span class="op">)</span> <span class="op">{</span></span>
<span id="cb238-35"><a href="#cb238-35" aria-hidden="true" tabindex="-1"></a>                prev<span class="op">-&gt;</span>next <span class="op">=</span> current<span class="op">-&gt;</span>next<span class="op">;</span></span>
<span id="cb238-36"><a href="#cb238-36" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb238-37"><a href="#cb238-37" aria-hidden="true" tabindex="-1"></a>                queue<span class="op">-&gt;</span>head <span class="op">=</span> current<span class="op">-&gt;</span>next<span class="op">;</span></span>
<span id="cb238-38"><a href="#cb238-38" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb238-39"><a href="#cb238-39" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb238-40"><a href="#cb238-40" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(!</span>current<span class="op">-&gt;</span>next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb238-41"><a href="#cb238-41" aria-hidden="true" tabindex="-1"></a>                queue<span class="op">-&gt;</span>tail <span class="op">=</span> prev<span class="op">;</span></span>
<span id="cb238-42"><a href="#cb238-42" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb238-43"><a href="#cb238-43" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb238-44"><a href="#cb238-44" aria-hidden="true" tabindex="-1"></a>            queue<span class="op">-&gt;</span>size<span class="op">--;</span></span>
<span id="cb238-45"><a href="#cb238-45" aria-hidden="true" tabindex="-1"></a>            release_lock<span class="op">(&amp;</span>queue<span class="op">-&gt;</span>lock<span class="op">);</span></span>
<span id="cb238-46"><a href="#cb238-46" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> current<span class="op">;</span></span>
<span id="cb238-47"><a href="#cb238-47" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb238-48"><a href="#cb238-48" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb238-49"><a href="#cb238-49" aria-hidden="true" tabindex="-1"></a>        prev <span class="op">=</span> current<span class="op">;</span></span>
<span id="cb238-50"><a href="#cb238-50" aria-hidden="true" tabindex="-1"></a>        current <span class="op">=</span> current<span class="op">-&gt;</span>next<span class="op">;</span></span>
<span id="cb238-51"><a href="#cb238-51" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb238-52"><a href="#cb238-52" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb238-53"><a href="#cb238-53" aria-hidden="true" tabindex="-1"></a>    release_lock<span class="op">(&amp;</span>queue<span class="op">-&gt;</span>lock<span class="op">);</span></span>
<span id="cb238-54"><a href="#cb238-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> NULL<span class="op">;</span></span>
<span id="cb238-55"><a href="#cb238-55" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb238-56"><a href="#cb238-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb238-57"><a href="#cb238-57" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">bool</span> matches_pattern<span class="op">(</span>Message <span class="op">*</span>msg<span class="op">,</span> MessagePattern <span class="op">*</span>pattern<span class="op">)</span> <span class="op">{</span></span>
<span id="cb238-58"><a href="#cb238-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> <span class="op">(</span>pattern<span class="op">-&gt;</span>type<span class="op">)</span> <span class="op">{</span></span>
<span id="cb238-59"><a href="#cb238-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> PATTERN_VALUE<span class="op">:</span></span>
<span id="cb238-60"><a href="#cb238-60" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> match_value_pattern<span class="op">(</span>msg<span class="op">-&gt;</span>content<span class="op">,</span></span>
<span id="cb238-61"><a href="#cb238-61" aria-hidden="true" tabindex="-1"></a>                                   pattern<span class="op">-&gt;</span>data<span class="op">.</span>value_pattern<span class="op">.</span>pattern<span class="op">)</span> <span class="op">&amp;&amp;</span></span>
<span id="cb238-62"><a href="#cb238-62" aria-hidden="true" tabindex="-1"></a>               <span class="op">(!</span>pattern<span class="op">-&gt;</span>data<span class="op">.</span>value_pattern<span class="op">.</span>guard <span class="op">||</span></span>
<span id="cb238-63"><a href="#cb238-63" aria-hidden="true" tabindex="-1"></a>                pattern<span class="op">-&gt;</span>data<span class="op">.</span>value_pattern<span class="op">.</span>guard<span class="op">(</span>msg<span class="op">));</span></span>
<span id="cb238-64"><a href="#cb238-64" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb238-65"><a href="#cb238-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> PATTERN_SENDER<span class="op">:</span></span>
<span id="cb238-66"><a href="#cb238-66" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> msg<span class="op">-&gt;</span>sender <span class="op">==</span> pattern<span class="op">-&gt;</span>data<span class="op">.</span>sender_pattern<span class="op">.</span>sender <span class="op">&amp;&amp;</span></span>
<span id="cb238-67"><a href="#cb238-67" aria-hidden="true" tabindex="-1"></a>               msg<span class="op">-&gt;</span>type <span class="op">==</span> pattern<span class="op">-&gt;</span>data<span class="op">.</span>sender_pattern<span class="op">.</span>type<span class="op">;</span></span>
<span id="cb238-68"><a href="#cb238-68" aria-hidden="true" tabindex="-1"></a>               </span>
<span id="cb238-69"><a href="#cb238-69" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> PATTERN_PREDICATE<span class="op">:</span></span>
<span id="cb238-70"><a href="#cb238-70" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pattern<span class="op">-&gt;</span>data<span class="op">.</span>predicate_pattern<span class="op">.</span>predicate<span class="op">(</span></span>
<span id="cb238-71"><a href="#cb238-71" aria-hidden="true" tabindex="-1"></a>            msg<span class="op">,</span> pattern<span class="op">-&gt;</span>data<span class="op">.</span>predicate_pattern<span class="op">.</span>context<span class="op">);</span></span>
<span id="cb238-72"><a href="#cb238-72" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb238-73"><a href="#cb238-73" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb238-74"><a href="#cb238-74" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb238-75"><a href="#cb238-75" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>19.5 Parallel Execution</h2>
<h3>19.5.1 Work-Stealing Implementation</h3>
<div class="sourceCode" id="cb239"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb239-1"><a href="#cb239-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> WorkStealingQueue <span class="op">{</span></span>
<span id="cb239-2"><a href="#cb239-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Chase-Lev deque for work stealing</span></span>
<span id="cb239-3"><a href="#cb239-3" aria-hidden="true" tabindex="-1"></a>    atomic_size_t top<span class="op">;</span></span>
<span id="cb239-4"><a href="#cb239-4" aria-hidden="true" tabindex="-1"></a>    atomic_size_t bottom<span class="op">;</span></span>
<span id="cb239-5"><a href="#cb239-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb239-6"><a href="#cb239-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Circular buffer</span></span>
<span id="cb239-7"><a href="#cb239-7" aria-hidden="true" tabindex="-1"></a>    Task <span class="op">**</span>tasks<span class="op">;</span></span>
<span id="cb239-8"><a href="#cb239-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> capacity<span class="op">;</span></span>
<span id="cb239-9"><a href="#cb239-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb239-10"><a href="#cb239-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Owner worker</span></span>
<span id="cb239-11"><a href="#cb239-11" aria-hidden="true" tabindex="-1"></a>    WorkerID owner<span class="op">;</span></span>
<span id="cb239-12"><a href="#cb239-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> WorkStealingQueue<span class="op">;</span></span>
<span id="cb239-13"><a href="#cb239-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb239-14"><a href="#cb239-14" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> push_task<span class="op">(</span>WorkStealingQueue <span class="op">*</span>queue<span class="op">,</span> Task <span class="op">*</span>task<span class="op">)</span> <span class="op">{</span></span>
<span id="cb239-15"><a href="#cb239-15" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> b <span class="op">=</span> atomic_load<span class="op">(&amp;</span>queue<span class="op">-&gt;</span>bottom<span class="op">);</span></span>
<span id="cb239-16"><a href="#cb239-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> t <span class="op">=</span> atomic_load<span class="op">(&amp;</span>queue<span class="op">-&gt;</span>top<span class="op">);</span></span>
<span id="cb239-17"><a href="#cb239-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb239-18"><a href="#cb239-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>b <span class="op">-</span> t <span class="op">&gt;=</span> queue<span class="op">-&gt;</span>capacity <span class="op">-</span> <span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb239-19"><a href="#cb239-19" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Queue full, resize</span></span>
<span id="cb239-20"><a href="#cb239-20" aria-hidden="true" tabindex="-1"></a>        resize_queue<span class="op">(</span>queue<span class="op">);</span></span>
<span id="cb239-21"><a href="#cb239-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb239-22"><a href="#cb239-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb239-23"><a href="#cb239-23" aria-hidden="true" tabindex="-1"></a>    queue<span class="op">-&gt;</span>tasks<span class="op">[</span>b <span class="op">&amp;</span> <span class="op">(</span>queue<span class="op">-&gt;</span>capacity <span class="op">-</span> <span class="dv">1</span><span class="op">)]</span> <span class="op">=</span> task<span class="op">;</span></span>
<span id="cb239-24"><a href="#cb239-24" aria-hidden="true" tabindex="-1"></a>    atomic_fence<span class="op">();</span>  <span class="co">// Memory barrier</span></span>
<span id="cb239-25"><a href="#cb239-25" aria-hidden="true" tabindex="-1"></a>    atomic_store<span class="op">(&amp;</span>queue<span class="op">-&gt;</span>bottom<span class="op">,</span> b <span class="op">+</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb239-26"><a href="#cb239-26" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb239-27"><a href="#cb239-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb239-28"><a href="#cb239-28" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> Task<span class="op">*</span> pop_task<span class="op">(</span>WorkStealingQueue <span class="op">*</span>queue<span class="op">)</span> <span class="op">{</span></span>
<span id="cb239-29"><a href="#cb239-29" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> b <span class="op">=</span> atomic_load<span class="op">(&amp;</span>queue<span class="op">-&gt;</span>bottom<span class="op">)</span> <span class="op">-</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb239-30"><a href="#cb239-30" aria-hidden="true" tabindex="-1"></a>    atomic_store<span class="op">(&amp;</span>queue<span class="op">-&gt;</span>bottom<span class="op">,</span> b<span class="op">);</span></span>
<span id="cb239-31"><a href="#cb239-31" aria-hidden="true" tabindex="-1"></a>    atomic_fence<span class="op">();</span></span>
<span id="cb239-32"><a href="#cb239-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb239-33"><a href="#cb239-33" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> t <span class="op">=</span> atomic_load<span class="op">(&amp;</span>queue<span class="op">-&gt;</span>top<span class="op">);</span></span>
<span id="cb239-34"><a href="#cb239-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb239-35"><a href="#cb239-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>t <span class="op">&lt;=</span> b<span class="op">)</span> <span class="op">{</span></span>
<span id="cb239-36"><a href="#cb239-36" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Non-empty queue</span></span>
<span id="cb239-37"><a href="#cb239-37" aria-hidden="true" tabindex="-1"></a>        Task <span class="op">*</span>task <span class="op">=</span> queue<span class="op">-&gt;</span>tasks<span class="op">[</span>b <span class="op">&amp;</span> <span class="op">(</span>queue<span class="op">-&gt;</span>capacity <span class="op">-</span> <span class="dv">1</span><span class="op">)];</span></span>
<span id="cb239-38"><a href="#cb239-38" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb239-39"><a href="#cb239-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>t <span class="op">==</span> b<span class="op">)</span> <span class="op">{</span></span>
<span id="cb239-40"><a href="#cb239-40" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Last element - need CAS</span></span>
<span id="cb239-41"><a href="#cb239-41" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(!</span>atomic_compare_exchange<span class="op">(&amp;</span>queue<span class="op">-&gt;</span>top<span class="op">,</span> <span class="op">&amp;</span>t<span class="op">,</span> t <span class="op">+</span> <span class="dv">1</span><span class="op">))</span> <span class="op">{</span></span>
<span id="cb239-42"><a href="#cb239-42" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Failed race</span></span>
<span id="cb239-43"><a href="#cb239-43" aria-hidden="true" tabindex="-1"></a>                atomic_store<span class="op">(&amp;</span>queue<span class="op">-&gt;</span>bottom<span class="op">,</span> b <span class="op">+</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb239-44"><a href="#cb239-44" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> NULL<span class="op">;</span></span>
<span id="cb239-45"><a href="#cb239-45" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb239-46"><a href="#cb239-46" aria-hidden="true" tabindex="-1"></a>            atomic_store<span class="op">(&amp;</span>queue<span class="op">-&gt;</span>bottom<span class="op">,</span> b <span class="op">+</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb239-47"><a href="#cb239-47" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb239-48"><a href="#cb239-48" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> task<span class="op">;</span></span>
<span id="cb239-49"><a href="#cb239-49" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb239-50"><a href="#cb239-50" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Empty queue</span></span>
<span id="cb239-51"><a href="#cb239-51" aria-hidden="true" tabindex="-1"></a>        atomic_store<span class="op">(&amp;</span>queue<span class="op">-&gt;</span>bottom<span class="op">,</span> b <span class="op">+</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb239-52"><a href="#cb239-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> NULL<span class="op">;</span></span>
<span id="cb239-53"><a href="#cb239-53" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb239-54"><a href="#cb239-54" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb239-55"><a href="#cb239-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb239-56"><a href="#cb239-56" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> Task<span class="op">*</span> steal_task<span class="op">(</span>WorkStealingQueue <span class="op">*</span>queue<span class="op">)</span> <span class="op">{</span></span>
<span id="cb239-57"><a href="#cb239-57" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> t <span class="op">=</span> atomic_load<span class="op">(&amp;</span>queue<span class="op">-&gt;</span>top<span class="op">);</span></span>
<span id="cb239-58"><a href="#cb239-58" aria-hidden="true" tabindex="-1"></a>    atomic_fence<span class="op">();</span></span>
<span id="cb239-59"><a href="#cb239-59" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> b <span class="op">=</span> atomic_load<span class="op">(&amp;</span>queue<span class="op">-&gt;</span>bottom<span class="op">);</span></span>
<span id="cb239-60"><a href="#cb239-60" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb239-61"><a href="#cb239-61" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>t <span class="op">&lt;</span> b<span class="op">)</span> <span class="op">{</span></span>
<span id="cb239-62"><a href="#cb239-62" aria-hidden="true" tabindex="-1"></a>        Task <span class="op">*</span>task <span class="op">=</span> queue<span class="op">-&gt;</span>tasks<span class="op">[</span>t <span class="op">&amp;</span> <span class="op">(</span>queue<span class="op">-&gt;</span>capacity <span class="op">-</span> <span class="dv">1</span><span class="op">)];</span></span>
<span id="cb239-63"><a href="#cb239-63" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb239-64"><a href="#cb239-64" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>atomic_compare_exchange<span class="op">(&amp;</span>queue<span class="op">-&gt;</span>top<span class="op">,</span> <span class="op">&amp;</span>t<span class="op">,</span> t <span class="op">+</span> <span class="dv">1</span><span class="op">))</span> <span class="op">{</span></span>
<span id="cb239-65"><a href="#cb239-65" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> task<span class="op">;</span></span>
<span id="cb239-66"><a href="#cb239-66" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb239-67"><a href="#cb239-67" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb239-68"><a href="#cb239-68" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb239-69"><a href="#cb239-69" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> NULL<span class="op">;</span></span>
<span id="cb239-70"><a href="#cb239-70" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3>19.5.2 Parallel Constructs</h3>
<div class="sourceCode" id="cb240"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb240-1"><a href="#cb240-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Parallel map implementation</span></span>
<span id="cb240-2"><a href="#cb240-2" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> Value parallel_map<span class="op">(</span>Value collection<span class="op">,</span> Value function<span class="op">)</span> <span class="op">{</span></span>
<span id="cb240-3"><a href="#cb240-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> size <span class="op">=</span> get_collection_size<span class="op">(</span>collection<span class="op">);</span></span>
<span id="cb240-4"><a href="#cb240-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb240-5"><a href="#cb240-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Determine parallelism level</span></span>
<span id="cb240-6"><a href="#cb240-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> num_workers <span class="op">=</span> min<span class="op">(</span>size<span class="op">,</span> vm<span class="op">-&gt;</span>concurrency<span class="op">.</span>worker_count<span class="op">);</span></span>
<span id="cb240-7"><a href="#cb240-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> chunk_size <span class="op">=</span> <span class="op">(</span>size <span class="op">+</span> num_workers <span class="op">-</span> <span class="dv">1</span><span class="op">)</span> <span class="op">/</span> num_workers<span class="op">;</span></span>
<span id="cb240-8"><a href="#cb240-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb240-9"><a href="#cb240-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Create tasks</span></span>
<span id="cb240-10"><a href="#cb240-10" aria-hidden="true" tabindex="-1"></a>    ParallelTask <span class="op">*</span>tasks <span class="op">=</span> allocate_tasks<span class="op">(</span>num_workers<span class="op">);</span></span>
<span id="cb240-11"><a href="#cb240-11" aria-hidden="true" tabindex="-1"></a>    Value <span class="op">*</span>results <span class="op">=</span> allocate_value_array<span class="op">(</span>size<span class="op">);</span></span>
<span id="cb240-12"><a href="#cb240-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb240-13"><a href="#cb240-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> num_workers<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb240-14"><a href="#cb240-14" aria-hidden="true" tabindex="-1"></a>        tasks<span class="op">[</span>i<span class="op">].</span>function <span class="op">=</span> function<span class="op">;</span></span>
<span id="cb240-15"><a href="#cb240-15" aria-hidden="true" tabindex="-1"></a>        tasks<span class="op">[</span>i<span class="op">].</span>start <span class="op">=</span> i <span class="op">*</span> chunk_size<span class="op">;</span></span>
<span id="cb240-16"><a href="#cb240-16" aria-hidden="true" tabindex="-1"></a>        tasks<span class="op">[</span>i<span class="op">].</span>end <span class="op">=</span> min<span class="op">((</span>i <span class="op">+</span> <span class="dv">1</span><span class="op">)</span> <span class="op">*</span> chunk_size<span class="op">,</span> size<span class="op">);</span></span>
<span id="cb240-17"><a href="#cb240-17" aria-hidden="true" tabindex="-1"></a>        tasks<span class="op">[</span>i<span class="op">].</span>input <span class="op">=</span> collection<span class="op">;</span></span>
<span id="cb240-18"><a href="#cb240-18" aria-hidden="true" tabindex="-1"></a>        tasks<span class="op">[</span>i<span class="op">].</span>output <span class="op">=</span> results<span class="op">;</span></span>
<span id="cb240-19"><a href="#cb240-19" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb240-20"><a href="#cb240-20" aria-hidden="true" tabindex="-1"></a>        submit_parallel_task<span class="op">(&amp;</span>tasks<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb240-21"><a href="#cb240-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb240-22"><a href="#cb240-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb240-23"><a href="#cb240-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Wait for completion</span></span>
<span id="cb240-24"><a href="#cb240-24" aria-hidden="true" tabindex="-1"></a>    wait_all_tasks<span class="op">(</span>tasks<span class="op">,</span> num_workers<span class="op">);</span></span>
<span id="cb240-25"><a href="#cb240-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb240-26"><a href="#cb240-26" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Build result collection</span></span>
<span id="cb240-27"><a href="#cb240-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> create_collection_from_array<span class="op">(</span>results<span class="op">,</span> size<span class="op">);</span></span>
<span id="cb240-28"><a href="#cb240-28" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb240-29"><a href="#cb240-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb240-30"><a href="#cb240-30" aria-hidden="true" tabindex="-1"></a><span class="co">// Fork-join parallelism</span></span>
<span id="cb240-31"><a href="#cb240-31" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> Value fork_join<span class="op">(</span>TaskGroup <span class="op">*</span>group<span class="op">)</span> <span class="op">{</span></span>
<span id="cb240-32"><a href="#cb240-32" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Submit all tasks</span></span>
<span id="cb240-33"><a href="#cb240-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> group<span class="op">-&gt;</span>task_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb240-34"><a href="#cb240-34" aria-hidden="true" tabindex="-1"></a>        push_task<span class="op">(</span>get_worker_queue<span class="op">(</span>current_worker<span class="op">()),</span> <span class="op">&amp;</span>group<span class="op">-&gt;</span>tasks<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb240-35"><a href="#cb240-35" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb240-36"><a href="#cb240-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb240-37"><a href="#cb240-37" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Help with execution</span></span>
<span id="cb240-38"><a href="#cb240-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(!</span>all_tasks_complete<span class="op">(</span>group<span class="op">))</span> <span class="op">{</span></span>
<span id="cb240-39"><a href="#cb240-39" aria-hidden="true" tabindex="-1"></a>        Task <span class="op">*</span>task <span class="op">=</span> pop_task<span class="op">(</span>get_worker_queue<span class="op">(</span>current_worker<span class="op">()));</span></span>
<span id="cb240-40"><a href="#cb240-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(!</span>task<span class="op">)</span> <span class="op">{</span></span>
<span id="cb240-41"><a href="#cb240-41" aria-hidden="true" tabindex="-1"></a>            task <span class="op">=</span> steal_from_others<span class="op">(</span>current_worker<span class="op">());</span></span>
<span id="cb240-42"><a href="#cb240-42" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb240-43"><a href="#cb240-43" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb240-44"><a href="#cb240-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>task <span class="op">&amp;&amp;</span> task<span class="op">-&gt;</span>group <span class="op">==</span> group<span class="op">)</span> <span class="op">{</span></span>
<span id="cb240-45"><a href="#cb240-45" aria-hidden="true" tabindex="-1"></a>            execute_task<span class="op">(</span>task<span class="op">);</span></span>
<span id="cb240-46"><a href="#cb240-46" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb240-47"><a href="#cb240-47" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb240-48"><a href="#cb240-48" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb240-49"><a href="#cb240-49" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Combine results</span></span>
<span id="cb240-50"><a href="#cb240-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> reduce_task_results<span class="op">(</span>group<span class="op">);</span></span>
<span id="cb240-51"><a href="#cb240-51" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>19.6 Synchronization Primitives</h2>
<h3>19.6.1 Lock-Free Data Structures</h3>
<div class="sourceCode" id="cb241"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb241-1"><a href="#cb241-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> LockFreeStack <span class="op">{</span></span>
<span id="cb241-2"><a href="#cb241-2" aria-hidden="true" tabindex="-1"></a>    atomic_ptr_t head<span class="op">;</span></span>
<span id="cb241-3"><a href="#cb241-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> LockFreeStack<span class="op">;</span></span>
<span id="cb241-4"><a href="#cb241-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb241-5"><a href="#cb241-5" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> push_lockfree<span class="op">(</span>LockFreeStack <span class="op">*</span>stack<span class="op">,</span> Node <span class="op">*</span>node<span class="op">)</span> <span class="op">{</span></span>
<span id="cb241-6"><a href="#cb241-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">do</span> <span class="op">{</span></span>
<span id="cb241-7"><a href="#cb241-7" aria-hidden="true" tabindex="-1"></a>        Node <span class="op">*</span>head <span class="op">=</span> atomic_load<span class="op">(&amp;</span>stack<span class="op">-&gt;</span>head<span class="op">);</span></span>
<span id="cb241-8"><a href="#cb241-8" aria-hidden="true" tabindex="-1"></a>        node<span class="op">-&gt;</span>next <span class="op">=</span> head<span class="op">;</span></span>
<span id="cb241-9"><a href="#cb241-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">while</span> <span class="op">(!</span>atomic_compare_exchange_weak<span class="op">(&amp;</span>stack<span class="op">-&gt;</span>head<span class="op">,</span> <span class="op">&amp;</span>node<span class="op">-&gt;</span>next<span class="op">,</span> node<span class="op">));</span></span>
<span id="cb241-10"><a href="#cb241-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb241-11"><a href="#cb241-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb241-12"><a href="#cb241-12" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> Node<span class="op">*</span> pop_lockfree<span class="op">(</span>LockFreeStack <span class="op">*</span>stack<span class="op">)</span> <span class="op">{</span></span>
<span id="cb241-13"><a href="#cb241-13" aria-hidden="true" tabindex="-1"></a>    Node <span class="op">*</span>head<span class="op">;</span></span>
<span id="cb241-14"><a href="#cb241-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">do</span> <span class="op">{</span></span>
<span id="cb241-15"><a href="#cb241-15" aria-hidden="true" tabindex="-1"></a>        head <span class="op">=</span> atomic_load<span class="op">(&amp;</span>stack<span class="op">-&gt;</span>head<span class="op">);</span></span>
<span id="cb241-16"><a href="#cb241-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(!</span>head<span class="op">)</span> <span class="cf">return</span> NULL<span class="op">;</span></span>
<span id="cb241-17"><a href="#cb241-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">while</span> <span class="op">(!</span>atomic_compare_exchange_weak<span class="op">(&amp;</span>stack<span class="op">-&gt;</span>head<span class="op">,</span> <span class="op">&amp;</span>head<span class="op">,</span> head<span class="op">-&gt;</span>next<span class="op">));</span></span>
<span id="cb241-18"><a href="#cb241-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb241-19"><a href="#cb241-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> head<span class="op">;</span></span>
<span id="cb241-20"><a href="#cb241-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb241-21"><a href="#cb241-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb241-22"><a href="#cb241-22" aria-hidden="true" tabindex="-1"></a><span class="co">// Lock-free queue (Michael &amp; Scott algorithm)</span></span>
<span id="cb241-23"><a href="#cb241-23" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> LockFreeQueue <span class="op">{</span></span>
<span id="cb241-24"><a href="#cb241-24" aria-hidden="true" tabindex="-1"></a>    atomic_ptr_t head<span class="op">;</span></span>
<span id="cb241-25"><a href="#cb241-25" aria-hidden="true" tabindex="-1"></a>    atomic_ptr_t tail<span class="op">;</span></span>
<span id="cb241-26"><a href="#cb241-26" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> LockFreeQueue<span class="op">;</span></span>
<span id="cb241-27"><a href="#cb241-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb241-28"><a href="#cb241-28" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> enqueue_lockfree<span class="op">(</span>LockFreeQueue <span class="op">*</span>queue<span class="op">,</span> Node <span class="op">*</span>node<span class="op">)</span> <span class="op">{</span></span>
<span id="cb241-29"><a href="#cb241-29" aria-hidden="true" tabindex="-1"></a>    node<span class="op">-&gt;</span>next <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb241-30"><a href="#cb241-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb241-31"><a href="#cb241-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span><span class="kw">true</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb241-32"><a href="#cb241-32" aria-hidden="true" tabindex="-1"></a>        Node <span class="op">*</span>tail <span class="op">=</span> atomic_load<span class="op">(&amp;</span>queue<span class="op">-&gt;</span>tail<span class="op">);</span></span>
<span id="cb241-33"><a href="#cb241-33" aria-hidden="true" tabindex="-1"></a>        Node <span class="op">*</span>next <span class="op">=</span> atomic_load<span class="op">(&amp;</span>tail<span class="op">-&gt;</span>next<span class="op">);</span></span>
<span id="cb241-34"><a href="#cb241-34" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb241-35"><a href="#cb241-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>tail <span class="op">==</span> atomic_load<span class="op">(&amp;</span>queue<span class="op">-&gt;</span>tail<span class="op">))</span> <span class="op">{</span></span>
<span id="cb241-36"><a href="#cb241-36" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>next <span class="op">==</span> NULL<span class="op">)</span> <span class="op">{</span></span>
<span id="cb241-37"><a href="#cb241-37" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span>atomic_compare_exchange<span class="op">(&amp;</span>tail<span class="op">-&gt;</span>next<span class="op">,</span> <span class="op">&amp;</span>next<span class="op">,</span> node<span class="op">))</span> <span class="op">{</span></span>
<span id="cb241-38"><a href="#cb241-38" aria-hidden="true" tabindex="-1"></a>                    atomic_compare_exchange<span class="op">(&amp;</span>queue<span class="op">-&gt;</span>tail<span class="op">,</span> <span class="op">&amp;</span>tail<span class="op">,</span> node<span class="op">);</span></span>
<span id="cb241-39"><a href="#cb241-39" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">break</span><span class="op">;</span></span>
<span id="cb241-40"><a href="#cb241-40" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb241-41"><a href="#cb241-41" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb241-42"><a href="#cb241-42" aria-hidden="true" tabindex="-1"></a>                atomic_compare_exchange<span class="op">(&amp;</span>queue<span class="op">-&gt;</span>tail<span class="op">,</span> <span class="op">&amp;</span>tail<span class="op">,</span> next<span class="op">);</span></span>
<span id="cb241-43"><a href="#cb241-43" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb241-44"><a href="#cb241-44" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb241-45"><a href="#cb241-45" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb241-46"><a href="#cb241-46" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3>19.6.2 Software Transactional Memory</h3>
<div class="sourceCode" id="cb242"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb242-1"><a href="#cb242-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> STMTransaction <span class="op">{</span></span>
<span id="cb242-2"><a href="#cb242-2" aria-hidden="true" tabindex="-1"></a>    TransactionID id<span class="op">;</span></span>
<span id="cb242-3"><a href="#cb242-3" aria-hidden="true" tabindex="-1"></a>    TransactionState state<span class="op">;</span></span>
<span id="cb242-4"><a href="#cb242-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb242-5"><a href="#cb242-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Read and write sets</span></span>
<span id="cb242-6"><a href="#cb242-6" aria-hidden="true" tabindex="-1"></a>    ReadSet <span class="op">*</span>read_set<span class="op">;</span></span>
<span id="cb242-7"><a href="#cb242-7" aria-hidden="true" tabindex="-1"></a>    WriteSet <span class="op">*</span>write_set<span class="op">;</span></span>
<span id="cb242-8"><a href="#cb242-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb242-9"><a href="#cb242-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Version tracking</span></span>
<span id="cb242-10"><a href="#cb242-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint64_t</span> start_version<span class="op">;</span></span>
<span id="cb242-11"><a href="#cb242-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb242-12"><a href="#cb242-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Retry management</span></span>
<span id="cb242-13"><a href="#cb242-13" aria-hidden="true" tabindex="-1"></a>    WatchSet <span class="op">*</span>watch_set<span class="op">;</span></span>
<span id="cb242-14"><a href="#cb242-14" aria-hidden="true" tabindex="-1"></a>    ConditionVar retry_condition<span class="op">;</span></span>
<span id="cb242-15"><a href="#cb242-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> STMTransaction<span class="op">;</span></span>
<span id="cb242-16"><a href="#cb242-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb242-17"><a href="#cb242-17" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> Value stm_read<span class="op">(</span>STMTransaction <span class="op">*</span>tx<span class="op">,</span> STMVar <span class="op">*</span>var<span class="op">)</span> <span class="op">{</span></span>
<span id="cb242-18"><a href="#cb242-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check write set first</span></span>
<span id="cb242-19"><a href="#cb242-19" aria-hidden="true" tabindex="-1"></a>    WriteEntry <span class="op">*</span>entry <span class="op">=</span> find_in_write_set<span class="op">(</span>tx<span class="op">-&gt;</span>write_set<span class="op">,</span> var<span class="op">);</span></span>
<span id="cb242-20"><a href="#cb242-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>entry<span class="op">)</span> <span class="op">{</span></span>
<span id="cb242-21"><a href="#cb242-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> entry<span class="op">-&gt;</span>value<span class="op">;</span></span>
<span id="cb242-22"><a href="#cb242-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb242-23"><a href="#cb242-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb242-24"><a href="#cb242-24" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Add to read set</span></span>
<span id="cb242-25"><a href="#cb242-25" aria-hidden="true" tabindex="-1"></a>    add_to_read_set<span class="op">(</span>tx<span class="op">-&gt;</span>read_set<span class="op">,</span> var<span class="op">,</span> var<span class="op">-&gt;</span>version<span class="op">);</span></span>
<span id="cb242-26"><a href="#cb242-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb242-27"><a href="#cb242-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> var<span class="op">-&gt;</span>value<span class="op">;</span></span>
<span id="cb242-28"><a href="#cb242-28" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb242-29"><a href="#cb242-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb242-30"><a href="#cb242-30" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> stm_write<span class="op">(</span>STMTransaction <span class="op">*</span>tx<span class="op">,</span> STMVar <span class="op">*</span>var<span class="op">,</span> Value value<span class="op">)</span> <span class="op">{</span></span>
<span id="cb242-31"><a href="#cb242-31" aria-hidden="true" tabindex="-1"></a>    add_to_write_set<span class="op">(</span>tx<span class="op">-&gt;</span>write_set<span class="op">,</span> var<span class="op">,</span> value<span class="op">);</span></span>
<span id="cb242-32"><a href="#cb242-32" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb242-33"><a href="#cb242-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb242-34"><a href="#cb242-34" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">bool</span> stm_commit<span class="op">(</span>STMTransaction <span class="op">*</span>tx<span class="op">)</span> <span class="op">{</span></span>
<span id="cb242-35"><a href="#cb242-35" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Validate read set</span></span>
<span id="cb242-36"><a href="#cb242-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>validate_read_set<span class="op">(</span>tx<span class="op">))</span> <span class="op">{</span></span>
<span id="cb242-37"><a href="#cb242-37" aria-hidden="true" tabindex="-1"></a>        rollback_transaction<span class="op">(</span>tx<span class="op">);</span></span>
<span id="cb242-38"><a href="#cb242-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb242-39"><a href="#cb242-39" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb242-40"><a href="#cb242-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb242-41"><a href="#cb242-41" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Lock write set</span></span>
<span id="cb242-42"><a href="#cb242-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>lock_write_set<span class="op">(</span>tx<span class="op">))</span> <span class="op">{</span></span>
<span id="cb242-43"><a href="#cb242-43" aria-hidden="true" tabindex="-1"></a>        rollback_transaction<span class="op">(</span>tx<span class="op">);</span></span>
<span id="cb242-44"><a href="#cb242-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb242-45"><a href="#cb242-45" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb242-46"><a href="#cb242-46" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb242-47"><a href="#cb242-47" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Revalidate under locks</span></span>
<span id="cb242-48"><a href="#cb242-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>validate_read_set<span class="op">(</span>tx<span class="op">))</span> <span class="op">{</span></span>
<span id="cb242-49"><a href="#cb242-49" aria-hidden="true" tabindex="-1"></a>        unlock_write_set<span class="op">(</span>tx<span class="op">);</span></span>
<span id="cb242-50"><a href="#cb242-50" aria-hidden="true" tabindex="-1"></a>        rollback_transaction<span class="op">(</span>tx<span class="op">);</span></span>
<span id="cb242-51"><a href="#cb242-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb242-52"><a href="#cb242-52" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb242-53"><a href="#cb242-53" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb242-54"><a href="#cb242-54" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Commit writes</span></span>
<span id="cb242-55"><a href="#cb242-55" aria-hidden="true" tabindex="-1"></a>    commit_write_set<span class="op">(</span>tx<span class="op">);</span></span>
<span id="cb242-56"><a href="#cb242-56" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb242-57"><a href="#cb242-57" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Update versions and unlock</span></span>
<span id="cb242-58"><a href="#cb242-58" aria-hidden="true" tabindex="-1"></a>    update_versions<span class="op">(</span>tx<span class="op">);</span></span>
<span id="cb242-59"><a href="#cb242-59" aria-hidden="true" tabindex="-1"></a>    unlock_write_set<span class="op">(</span>tx<span class="op">);</span></span>
<span id="cb242-60"><a href="#cb242-60" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb242-61"><a href="#cb242-61" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Notify waiters</span></span>
<span id="cb242-62"><a href="#cb242-62" aria-hidden="true" tabindex="-1"></a>    notify_waiters<span class="op">(</span>tx<span class="op">);</span></span>
<span id="cb242-63"><a href="#cb242-63" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb242-64"><a href="#cb242-64" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb242-65"><a href="#cb242-65" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>19.7 Fault Tolerance and Supervision</h2>
<h3>19.7.1 Supervisor Trees</h3>
<div class="sourceCode" id="cb243"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb243-1"><a href="#cb243-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> Supervisor <span class="op">{</span></span>
<span id="cb243-2"><a href="#cb243-2" aria-hidden="true" tabindex="-1"></a>    Actor base<span class="op">;</span></span>
<span id="cb243-3"><a href="#cb243-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb243-4"><a href="#cb243-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Children management</span></span>
<span id="cb243-5"><a href="#cb243-5" aria-hidden="true" tabindex="-1"></a>    ActorID <span class="op">*</span>children<span class="op">;</span></span>
<span id="cb243-6"><a href="#cb243-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> child_count<span class="op">;</span></span>
<span id="cb243-7"><a href="#cb243-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> max_children<span class="op">;</span></span>
<span id="cb243-8"><a href="#cb243-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb243-9"><a href="#cb243-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Restart strategy</span></span>
<span id="cb243-10"><a href="#cb243-10" aria-hidden="true" tabindex="-1"></a>    RestartStrategy strategy<span class="op">;</span></span>
<span id="cb243-11"><a href="#cb243-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> max_restarts<span class="op">;</span></span>
<span id="cb243-12"><a href="#cb243-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint64_t</span> restart_window_ms<span class="op">;</span></span>
<span id="cb243-13"><a href="#cb243-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb243-14"><a href="#cb243-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Restart tracking</span></span>
<span id="cb243-15"><a href="#cb243-15" aria-hidden="true" tabindex="-1"></a>    RestartRecord <span class="op">*</span>restart_history<span class="op">;</span></span>
<span id="cb243-16"><a href="#cb243-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> history_size<span class="op">;</span></span>
<span id="cb243-17"><a href="#cb243-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> Supervisor<span class="op">;</span></span>
<span id="cb243-18"><a href="#cb243-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb243-19"><a href="#cb243-19" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">enum</span> <span class="op">{</span></span>
<span id="cb243-20"><a href="#cb243-20" aria-hidden="true" tabindex="-1"></a>    ONE_FOR_ONE<span class="op">,</span>    <span class="co">// Restart only failed child</span></span>
<span id="cb243-21"><a href="#cb243-21" aria-hidden="true" tabindex="-1"></a>    ONE_FOR_ALL<span class="op">,</span>    <span class="co">// Restart all children</span></span>
<span id="cb243-22"><a href="#cb243-22" aria-hidden="true" tabindex="-1"></a>    REST_FOR_ONE    <span class="co">// Restart failed child and those started after it</span></span>
<span id="cb243-23"><a href="#cb243-23" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> RestartStrategy<span class="op">;</span></span>
<span id="cb243-24"><a href="#cb243-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb243-25"><a href="#cb243-25" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> handle_child_failure<span class="op">(</span>Supervisor <span class="op">*</span>sup<span class="op">,</span> ActorID failed_child<span class="op">,</span></span>
<span id="cb243-26"><a href="#cb243-26" aria-hidden="true" tabindex="-1"></a>                                FailureReason reason<span class="op">)</span> <span class="op">{</span></span>
<span id="cb243-27"><a href="#cb243-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check restart frequency</span></span>
<span id="cb243-28"><a href="#cb243-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>exceeds_restart_threshold<span class="op">(</span>sup<span class="op">))</span> <span class="op">{</span></span>
<span id="cb243-29"><a href="#cb243-29" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Escalate to parent supervisor</span></span>
<span id="cb243-30"><a href="#cb243-30" aria-hidden="true" tabindex="-1"></a>        escalate_failure<span class="op">(</span>sup<span class="op">-&gt;</span>base<span class="op">.</span>supervisor<span class="op">,</span> sup<span class="op">-&gt;</span>base<span class="op">.</span>id<span class="op">,</span> reason<span class="op">);</span></span>
<span id="cb243-31"><a href="#cb243-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span><span class="op">;</span></span>
<span id="cb243-32"><a href="#cb243-32" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb243-33"><a href="#cb243-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb243-34"><a href="#cb243-34" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Record restart</span></span>
<span id="cb243-35"><a href="#cb243-35" aria-hidden="true" tabindex="-1"></a>    record_restart<span class="op">(</span>sup<span class="op">,</span> failed_child<span class="op">,</span> reason<span class="op">);</span></span>
<span id="cb243-36"><a href="#cb243-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb243-37"><a href="#cb243-37" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Apply restart strategy</span></span>
<span id="cb243-38"><a href="#cb243-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> <span class="op">(</span>sup<span class="op">-&gt;</span>strategy<span class="op">)</span> <span class="op">{</span></span>
<span id="cb243-39"><a href="#cb243-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> ONE_FOR_ONE<span class="op">:</span></span>
<span id="cb243-40"><a href="#cb243-40" aria-hidden="true" tabindex="-1"></a>        restart_actor<span class="op">(</span>failed_child<span class="op">);</span></span>
<span id="cb243-41"><a href="#cb243-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb243-42"><a href="#cb243-42" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb243-43"><a href="#cb243-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> ONE_FOR_ALL<span class="op">:</span></span>
<span id="cb243-44"><a href="#cb243-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> sup<span class="op">-&gt;</span>child_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb243-45"><a href="#cb243-45" aria-hidden="true" tabindex="-1"></a>            terminate_actor<span class="op">(</span>sup<span class="op">-&gt;</span>children<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb243-46"><a href="#cb243-46" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb243-47"><a href="#cb243-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> sup<span class="op">-&gt;</span>child_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb243-48"><a href="#cb243-48" aria-hidden="true" tabindex="-1"></a>            restart_actor<span class="op">(</span>sup<span class="op">-&gt;</span>children<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb243-49"><a href="#cb243-49" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb243-50"><a href="#cb243-50" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb243-51"><a href="#cb243-51" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb243-52"><a href="#cb243-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> REST_FOR_ONE<span class="op">:</span></span>
<span id="cb243-53"><a href="#cb243-53" aria-hidden="true" tabindex="-1"></a>        <span class="dt">size_t</span> failed_index <span class="op">=</span> find_child_index<span class="op">(</span>sup<span class="op">,</span> failed_child<span class="op">);</span></span>
<span id="cb243-54"><a href="#cb243-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> failed_index<span class="op">;</span> i <span class="op">&lt;</span> sup<span class="op">-&gt;</span>child_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb243-55"><a href="#cb243-55" aria-hidden="true" tabindex="-1"></a>            terminate_actor<span class="op">(</span>sup<span class="op">-&gt;</span>children<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb243-56"><a href="#cb243-56" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb243-57"><a href="#cb243-57" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> failed_index<span class="op">;</span> i <span class="op">&lt;</span> sup<span class="op">-&gt;</span>child_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb243-58"><a href="#cb243-58" aria-hidden="true" tabindex="-1"></a>            restart_actor<span class="op">(</span>sup<span class="op">-&gt;</span>children<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb243-59"><a href="#cb243-59" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb243-60"><a href="#cb243-60" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb243-61"><a href="#cb243-61" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb243-62"><a href="#cb243-62" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3>19.7.2 Process Linking and Monitoring</h3>
<div class="sourceCode" id="cb244"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb244-1"><a href="#cb244-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> link_actors<span class="op">(</span>ActorID actor1<span class="op">,</span> ActorID actor2<span class="op">)</span> <span class="op">{</span></span>
<span id="cb244-2"><a href="#cb244-2" aria-hidden="true" tabindex="-1"></a>    Actor <span class="op">*</span>a1 <span class="op">=</span> lookup_actor<span class="op">(</span>actor1<span class="op">);</span></span>
<span id="cb244-3"><a href="#cb244-3" aria-hidden="true" tabindex="-1"></a>    Actor <span class="op">*</span>a2 <span class="op">=</span> lookup_actor<span class="op">(</span>actor2<span class="op">);</span></span>
<span id="cb244-4"><a href="#cb244-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb244-5"><a href="#cb244-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Add bidirectional link</span></span>
<span id="cb244-6"><a href="#cb244-6" aria-hidden="true" tabindex="-1"></a>    add_link<span class="op">(</span>a1<span class="op">,</span> actor2<span class="op">);</span></span>
<span id="cb244-7"><a href="#cb244-7" aria-hidden="true" tabindex="-1"></a>    add_link<span class="op">(</span>a2<span class="op">,</span> actor1<span class="op">);</span></span>
<span id="cb244-8"><a href="#cb244-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb244-9"><a href="#cb244-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb244-10"><a href="#cb244-10" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> monitor_actor<span class="op">(</span>ActorID monitor<span class="op">,</span> ActorID monitored<span class="op">)</span> <span class="op">{</span></span>
<span id="cb244-11"><a href="#cb244-11" aria-hidden="true" tabindex="-1"></a>    Actor <span class="op">*</span>target <span class="op">=</span> lookup_actor<span class="op">(</span>monitored<span class="op">);</span></span>
<span id="cb244-12"><a href="#cb244-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb244-13"><a href="#cb244-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Add monitor</span></span>
<span id="cb244-14"><a href="#cb244-14" aria-hidden="true" tabindex="-1"></a>    add_monitor<span class="op">(</span>target<span class="op">,</span> monitor<span class="op">);</span></span>
<span id="cb244-15"><a href="#cb244-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb244-16"><a href="#cb244-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Send immediate DOWN if already terminated</span></span>
<span id="cb244-17"><a href="#cb244-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>target<span class="op">-&gt;</span>lifecycle_state <span class="op">==</span> ACTOR_TERMINATED<span class="op">)</span> <span class="op">{</span></span>
<span id="cb244-18"><a href="#cb244-18" aria-hidden="true" tabindex="-1"></a>        send_down_message<span class="op">(</span>monitor<span class="op">,</span> monitored<span class="op">,</span> target<span class="op">-&gt;</span>exit_reason<span class="op">);</span></span>
<span id="cb244-19"><a href="#cb244-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb244-20"><a href="#cb244-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb244-21"><a href="#cb244-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb244-22"><a href="#cb244-22" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> propagate_exit<span class="op">(</span>Actor <span class="op">*</span>actor<span class="op">,</span> ExitReason reason<span class="op">)</span> <span class="op">{</span></span>
<span id="cb244-23"><a href="#cb244-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Notify monitors</span></span>
<span id="cb244-24"><a href="#cb244-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> actor<span class="op">-&gt;</span>monitor_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb244-25"><a href="#cb244-25" aria-hidden="true" tabindex="-1"></a>        send_down_message<span class="op">(</span>actor<span class="op">-&gt;</span>monitors<span class="op">[</span>i<span class="op">],</span> actor<span class="op">-&gt;</span>id<span class="op">,</span> reason<span class="op">);</span></span>
<span id="cb244-26"><a href="#cb244-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb244-27"><a href="#cb244-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb244-28"><a href="#cb244-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Propagate to linked actors</span></span>
<span id="cb244-29"><a href="#cb244-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>reason <span class="op">!=</span> NORMAL_EXIT <span class="op">||</span> actor<span class="op">-&gt;</span>trap_exit<span class="op">)</span> <span class="op">{</span></span>
<span id="cb244-30"><a href="#cb244-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> actor<span class="op">-&gt;</span>link_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb244-31"><a href="#cb244-31" aria-hidden="true" tabindex="-1"></a>            Actor <span class="op">*</span>linked <span class="op">=</span> lookup_actor<span class="op">(</span>actor<span class="op">-&gt;</span>links<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb244-32"><a href="#cb244-32" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb244-33"><a href="#cb244-33" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>linked<span class="op">-&gt;</span>trap_exit<span class="op">)</span> <span class="op">{</span></span>
<span id="cb244-34"><a href="#cb244-34" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Convert to message</span></span>
<span id="cb244-35"><a href="#cb244-35" aria-hidden="true" tabindex="-1"></a>                send_exit_message<span class="op">(</span>linked<span class="op">-&gt;</span>id<span class="op">,</span> actor<span class="op">-&gt;</span>id<span class="op">,</span> reason<span class="op">);</span></span>
<span id="cb244-36"><a href="#cb244-36" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb244-37"><a href="#cb244-37" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Propagate termination</span></span>
<span id="cb244-38"><a href="#cb244-38" aria-hidden="true" tabindex="-1"></a>                terminate_actor_with_reason<span class="op">(</span>linked<span class="op">-&gt;</span>id<span class="op">,</span> reason<span class="op">);</span></span>
<span id="cb244-39"><a href="#cb244-39" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb244-40"><a href="#cb244-40" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb244-41"><a href="#cb244-41" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb244-42"><a href="#cb244-42" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2>19.8 Performance Optimization</h2>
<h3>19.8.1 NUMA-Aware Scheduling</h3>
<div class="sourceCode" id="cb245"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb245-1"><a href="#cb245-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> NUMAScheduler <span class="op">{</span></span>
<span id="cb245-2"><a href="#cb245-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// NUMA topology</span></span>
<span id="cb245-3"><a href="#cb245-3" aria-hidden="true" tabindex="-1"></a>    NUMANode <span class="op">*</span>nodes<span class="op">;</span></span>
<span id="cb245-4"><a href="#cb245-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> node_count<span class="op">;</span></span>
<span id="cb245-5"><a href="#cb245-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb245-6"><a href="#cb245-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Per-node queues</span></span>
<span id="cb245-7"><a href="#cb245-7" aria-hidden="true" tabindex="-1"></a>    RunQueue <span class="op">**</span>node_queues<span class="op">;</span></span>
<span id="cb245-8"><a href="#cb245-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb245-9"><a href="#cb245-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Memory allocation</span></span>
<span id="cb245-10"><a href="#cb245-10" aria-hidden="true" tabindex="-1"></a>    NUMAAllocator <span class="op">*</span>allocator<span class="op">;</span></span>
<span id="cb245-11"><a href="#cb245-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb245-12"><a href="#cb245-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Load balancing</span></span>
<span id="cb245-13"><a href="#cb245-13" aria-hidden="true" tabindex="-1"></a>    NUMABalancer <span class="op">*</span>balancer<span class="op">;</span></span>
<span id="cb245-14"><a href="#cb245-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> NUMAScheduler<span class="op">;</span></span>
<span id="cb245-15"><a href="#cb245-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb245-16"><a href="#cb245-16" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> numa_aware_schedule<span class="op">(</span>LightweightThread <span class="op">*</span>thread<span class="op">)</span> <span class="op">{</span></span>
<span id="cb245-17"><a href="#cb245-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Determine preferred NUMA node</span></span>
<span id="cb245-18"><a href="#cb245-18" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> preferred_node <span class="op">=</span> get_thread_numa_node<span class="op">(</span>thread<span class="op">);</span></span>
<span id="cb245-19"><a href="#cb245-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb245-20"><a href="#cb245-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>preferred_node <span class="op">&gt;=</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb245-21"><a href="#cb245-21" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Try to schedule on preferred node</span></span>
<span id="cb245-22"><a href="#cb245-22" aria-hidden="true" tabindex="-1"></a>        RunQueue <span class="op">*</span>node_queue <span class="op">=</span> numa_scheduler<span class="op">-&gt;</span>node_queues<span class="op">[</span>preferred_node<span class="op">];</span></span>
<span id="cb245-23"><a href="#cb245-23" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb245-24"><a href="#cb245-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>try_enqueue_local<span class="op">(</span>node_queue<span class="op">,</span> thread<span class="op">))</span> <span class="op">{</span></span>
<span id="cb245-25"><a href="#cb245-25" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span><span class="op">;</span></span>
<span id="cb245-26"><a href="#cb245-26" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb245-27"><a href="#cb245-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb245-28"><a href="#cb245-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb245-29"><a href="#cb245-29" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Fallback to least loaded node</span></span>
<span id="cb245-30"><a href="#cb245-30" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> target_node <span class="op">=</span> find_least_loaded_node<span class="op">();</span></span>
<span id="cb245-31"><a href="#cb245-31" aria-hidden="true" tabindex="-1"></a>    enqueue_thread<span class="op">(</span>numa_scheduler<span class="op">-&gt;</span>node_queues<span class="op">[</span>target_node<span class="op">],</span> thread<span class="op">);</span></span>
<span id="cb245-32"><a href="#cb245-32" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb245-33"><a href="#cb245-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb245-34"><a href="#cb245-34" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span><span class="op">*</span> numa_aware_allocate<span class="op">(</span><span class="dt">size_t</span> size<span class="op">,</span> <span class="dt">int</span> numa_node<span class="op">)</span> <span class="op">{</span></span>
<span id="cb245-35"><a href="#cb245-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>numa_node <span class="op">&lt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb245-36"><a href="#cb245-36" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Use current thread&#39;s node</span></span>
<span id="cb245-37"><a href="#cb245-37" aria-hidden="true" tabindex="-1"></a>        numa_node <span class="op">=</span> numa_node_of_cpu<span class="op">(</span>sched_getcpu<span class="op">());</span></span>
<span id="cb245-38"><a href="#cb245-38" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb245-39"><a href="#cb245-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb245-40"><a href="#cb245-40" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Allocate from node-local memory</span></span>
<span id="cb245-41"><a href="#cb245-41" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span>ptr <span class="op">=</span> numa_alloc_onnode<span class="op">(</span>size<span class="op">,</span> numa_node<span class="op">);</span></span>
<span id="cb245-42"><a href="#cb245-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb245-43"><a href="#cb245-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>ptr<span class="op">)</span> <span class="op">{</span></span>
<span id="cb245-44"><a href="#cb245-44" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Fallback to any node</span></span>
<span id="cb245-45"><a href="#cb245-45" aria-hidden="true" tabindex="-1"></a>        ptr <span class="op">=</span> numa_alloc<span class="op">(</span>size<span class="op">);</span></span>
<span id="cb245-46"><a href="#cb245-46" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb245-47"><a href="#cb245-47" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb245-48"><a href="#cb245-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ptr<span class="op">;</span></span>
<span id="cb245-49"><a href="#cb245-49" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3>19.8.2 Cache-Conscious Message Passing</h3>
<div class="sourceCode" id="cb246"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb246-1"><a href="#cb246-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> CacheLineAlignedMessage <span class="op">{</span></span>
<span id="cb246-2"><a href="#cb246-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Align to cache line to prevent false sharing</span></span>
<span id="cb246-3"><a href="#cb246-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">alignas</span><span class="op">(</span>CACHE_LINE_SIZE<span class="op">)</span> Message msg<span class="op">;</span></span>
<span id="cb246-4"><a href="#cb246-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb246-5"><a href="#cb246-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Padding for next message</span></span>
<span id="cb246-6"><a href="#cb246-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> padding<span class="op">[</span>CACHE_LINE_SIZE <span class="op">-</span> <span class="op">(</span><span class="kw">sizeof</span><span class="op">(</span>Message<span class="op">)</span> <span class="op">%</span> CACHE_LINE_SIZE<span class="op">)];</span></span>
<span id="cb246-7"><a href="#cb246-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> CacheLineAlignedMessage<span class="op">;</span></span>
<span id="cb246-8"><a href="#cb246-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb246-9"><a href="#cb246-9" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> MessageBatch <span class="op">{</span></span>
<span id="cb246-10"><a href="#cb246-10" aria-hidden="true" tabindex="-1"></a>    CacheLineAlignedMessage <span class="op">*</span>messages<span class="op">;</span></span>
<span id="cb246-11"><a href="#cb246-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> count<span class="op">;</span></span>
<span id="cb246-12"><a href="#cb246-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> capacity<span class="op">;</span></span>
<span id="cb246-13"><a href="#cb246-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb246-14"><a href="#cb246-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Batch metadata</span></span>
<span id="cb246-15"><a href="#cb246-15" aria-hidden="true" tabindex="-1"></a>    ActorID sender<span class="op">;</span></span>
<span id="cb246-16"><a href="#cb246-16" aria-hidden="true" tabindex="-1"></a>    ActorID receiver<span class="op">;</span></span>
<span id="cb246-17"><a href="#cb246-17" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint64_t</span> batch_id<span class="op">;</span></span>
<span id="cb246-18"><a href="#cb246-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> MessageBatch<span class="op">;</span></span>
<span id="cb246-19"><a href="#cb246-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb246-20"><a href="#cb246-20" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> send_message_batch<span class="op">(</span>MessageBatch <span class="op">*</span>batch<span class="op">)</span> <span class="op">{</span></span>
<span id="cb246-21"><a href="#cb246-21" aria-hidden="true" tabindex="-1"></a>    Actor <span class="op">*</span>target <span class="op">=</span> lookup_actor<span class="op">(</span>batch<span class="op">-&gt;</span>receiver<span class="op">);</span></span>
<span id="cb246-22"><a href="#cb246-22" aria-hidden="true" tabindex="-1"></a>    MessageQueue <span class="op">*</span>mailbox <span class="op">=</span> target<span class="op">-&gt;</span>thread<span class="op">-&gt;</span>mailbox<span class="op">;</span></span>
<span id="cb246-23"><a href="#cb246-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb246-24"><a href="#cb246-24" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Try to enqueue entire batch atomically</span></span>
<span id="cb246-25"><a href="#cb246-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>mailbox<span class="op">-&gt;</span>free_space <span class="op">&gt;=</span> batch<span class="op">-&gt;</span>count<span class="op">)</span> <span class="op">{</span></span>
<span id="cb246-26"><a href="#cb246-26" aria-hidden="true" tabindex="-1"></a>        acquire_lock<span class="op">(&amp;</span>mailbox<span class="op">-&gt;</span>lock<span class="op">);</span></span>
<span id="cb246-27"><a href="#cb246-27" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb246-28"><a href="#cb246-28" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Copy messages in bulk</span></span>
<span id="cb246-29"><a href="#cb246-29" aria-hidden="true" tabindex="-1"></a>        memcpy<span class="op">(</span>mailbox<span class="op">-&gt;</span>tail<span class="op">,</span> batch<span class="op">-&gt;</span>messages<span class="op">,</span> </span>
<span id="cb246-30"><a href="#cb246-30" aria-hidden="true" tabindex="-1"></a>               batch<span class="op">-&gt;</span>count <span class="op">*</span> <span class="kw">sizeof</span><span class="op">(</span>CacheLineAlignedMessage<span class="op">));</span></span>
<span id="cb246-31"><a href="#cb246-31" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb246-32"><a href="#cb246-32" aria-hidden="true" tabindex="-1"></a>        mailbox<span class="op">-&gt;</span>tail <span class="op">+=</span> batch<span class="op">-&gt;</span>count<span class="op">;</span></span>
<span id="cb246-33"><a href="#cb246-33" aria-hidden="true" tabindex="-1"></a>        mailbox<span class="op">-&gt;</span>size <span class="op">+=</span> batch<span class="op">-&gt;</span>count<span class="op">;</span></span>
<span id="cb246-34"><a href="#cb246-34" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb246-35"><a href="#cb246-35" aria-hidden="true" tabindex="-1"></a>        release_lock<span class="op">(&amp;</span>mailbox<span class="op">-&gt;</span>lock<span class="op">);</span></span>
<span id="cb246-36"><a href="#cb246-36" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb246-37"><a href="#cb246-37" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Single wake-up for entire batch</span></span>
<span id="cb246-38"><a href="#cb246-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>target<span class="op">-&gt;</span>thread<span class="op">-&gt;</span>state <span class="op">==</span> THREAD_BLOCKED_RECEIVE<span class="op">)</span> <span class="op">{</span></span>
<span id="cb246-39"><a href="#cb246-39" aria-hidden="true" tabindex="-1"></a>            wake_thread<span class="op">(</span>target<span class="op">-&gt;</span>thread<span class="op">);</span></span>
<span id="cb246-40"><a href="#cb246-40" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb246-41"><a href="#cb246-41" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb246-42"><a href="#cb246-42" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>This chapter establishes Diyrbal&#39;s comprehensive concurrency
framework, combining actor-model message passing with efficient parallel
execution primitives. The implementation focuses on scalability, fault
tolerance, and cache-conscious design for modern multi-core systems.</p>
<h1>Appendix A: Bytecode Instruction Reference &amp; Compilation
Schemes</h1>
<h2>A.1 Introduction</h2>
<p>This appendix provides a comprehensive reference for Diyrbal&#39;s
bytecode instruction set, drawing from the compilation schemes detailed
in the uploaded VM design references. Each instruction is documented
with its opcode, operand format, stack behavior, and compilation
patterns.</p>
<h2>A.2 Instruction Format</h2>
<h3>A.2.1 Basic Encoding</h3>
<div class="sourceCode" id="cb247"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb247-1"><a href="#cb247-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> Instruction <span class="op">{</span></span>
<span id="cb247-2"><a href="#cb247-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint8_t</span> opcode<span class="op">;</span>      <span class="co">// Primary opcode (0-255)</span></span>
<span id="cb247-3"><a href="#cb247-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint8_t</span> flags<span class="op">;</span>       <span class="co">// Instruction flags/modifiers</span></span>
<span id="cb247-4"><a href="#cb247-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint16_t</span> operand<span class="op">;</span>    <span class="co">// 16-bit immediate operand</span></span>
<span id="cb247-5"><a href="#cb247-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> __attribute__<span class="op">((</span>packed<span class="op">))</span> Instruction<span class="op">;</span></span>
<span id="cb247-6"><a href="#cb247-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb247-7"><a href="#cb247-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Extended format for larger operands</span></span>
<span id="cb247-8"><a href="#cb247-8" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> ExtendedInstruction <span class="op">{</span></span>
<span id="cb247-9"><a href="#cb247-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint8_t</span> opcode<span class="op">;</span>      <span class="co">// Must be OP_EXTENDED</span></span>
<span id="cb247-10"><a href="#cb247-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint8_t</span> ext_opcode<span class="op">;</span>  <span class="co">// Extended opcode</span></span>
<span id="cb247-11"><a href="#cb247-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint16_t</span> reserved<span class="op">;</span></span>
<span id="cb247-12"><a href="#cb247-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> operand<span class="op">;</span>    <span class="co">// 32-bit operand</span></span>
<span id="cb247-13"><a href="#cb247-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> __attribute__<span class="op">((</span>packed<span class="op">))</span> ExtendedInstruction<span class="op">;</span></span>
<span id="cb247-14"><a href="#cb247-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb247-15"><a href="#cb247-15" aria-hidden="true" tabindex="-1"></a><span class="co">// Instruction flags</span></span>
<span id="cb247-16"><a href="#cb247-16" aria-hidden="true" tabindex="-1"></a><span class="pp">#define FLAG_WIDE     </span><span class="bn">0x01</span><span class="pp">  </span><span class="co">// Wide operand follows</span></span>
<span id="cb247-17"><a href="#cb247-17" aria-hidden="true" tabindex="-1"></a><span class="pp">#define FLAG_TYPED    </span><span class="bn">0x02</span><span class="pp">  </span><span class="co">// Type-specialized variant</span></span>
<span id="cb247-18"><a href="#cb247-18" aria-hidden="true" tabindex="-1"></a><span class="pp">#define FLAG_PROFILE  </span><span class="bn">0x04</span><span class="pp">  </span><span class="co">// Profiling enabled</span></span>
<span id="cb247-19"><a href="#cb247-19" aria-hidden="true" tabindex="-1"></a><span class="pp">#define FLAG_DEBUG    </span><span class="bn">0x08</span><span class="pp">  </span><span class="co">// Debug info present</span></span></code></pre></div>
<h2>A.3 Stack Manipulation Instructions</h2>
<h3>A.3.1 Load/Store Operations</h3>
<p>OP_LOAD_CONST (0x00) Format: [opcode][index:16] Stack: []  [const]
Action: Push constant from constant pool Example: LOAD_CONST #5 // Push
constant at index 5</p>
<p>OP_LOAD_LOCAL (0x01) Format: [opcode][slot:16] Stack: []  [value]
Action: Load from local variable slot Compilation: codeV(x, , sl) =
LOAD_LOCAL (x)</p>
<p>OP_STORE_LOCAL (0x02) Format: [opcode][slot:16] Stack: [value]  []
Action: Store to local variable slot Compilation: codeL(x, , sl) =
STORE_LOCAL (x)</p>
<p>OP_LOAD_GLOBAL (0x03) Format: [opcode][index:16] Stack: []  [value]
Action: Load from global variable Note: Index refers to global variable
table</p>
<p>OP_STORE_GLOBAL (0x04) Format: [opcode][index:16] Stack: [value]  []
Action: Store to global variable</p>
<h3>A.3.2 Stack Operations</h3>
<p>OP_DUP (0x05) Format: [opcode] Stack: [a]  [a][a] Action: Duplicate
top of stack</p>
<p>OP_DUP2 (0x06) Format: [opcode] Stack: [a][b]  [a][b][a][b] Action:
Duplicate top two stack values</p>
<p>OP_SWAP (0x07) Format: [opcode] Stack: [a][b]  [b][a] Action: Swap
top two values</p>
<p>OP_ROT3 (0x08) Format: [opcode] Stack: [a][b][c]  [c][a][b] Action:
Rotate top three values</p>
<p>OP_POP (0x09) Format: [opcode] Stack: [a]  [] Action: Discard top
value</p>
<p>OP_POP_N (0x0A) Format: [opcode][count:16] Stack: [v1]...[vn]  []
Action: Pop n values from stack</p>
<h2>A.4 Arithmetic and Logical Instructions</h2>
<h3>A.4.1 Integer Arithmetic</h3>
<p>OP_ADD_INT (0x10) Format: [opcode] Stack: [a:int][b:int]  [a+b:int]
Action: Integer addition Flags: Sets overflow flag if applicable</p>
<p>OP_SUB_INT (0x11) Format: [opcode] Stack: [a:int][b:int]  [a-b:int]
Action: Integer subtraction</p>
<p>OP_MUL_INT (0x12) Format: [opcode] Stack: [a:int][b:int]  [a*b:int]
Action: Integer multiplication</p>
<p>OP_DIV_INT (0x13) Format: [opcode] Stack: [a:int][b:int]  [a/b:int]
Action: Integer division (truncating) Exception: DivisionByZero if b ==
0</p>
<p>OP_MOD_INT (0x14) Format: [opcode] Stack: [a:int][b:int]  [a%b:int]
Action: Integer modulo</p>
<p>OP_NEG_INT (0x15) Format: [opcode] Stack: [a:int]  [-a:int] Action:
Integer negation</p>
<h3>A.4.2 Floating-Point Arithmetic</h3>
<p>OP_ADD_FLOAT (0x16) Format: [opcode] Stack: [a:float][b:float] 
[a+b:float] Action: Floating-point addition</p>
<p>OP_SUB_FLOAT (0x17) Format: [opcode] Stack: [a:float][b:float] 
[a-b:float] Action: Floating-point subtraction</p>
<p>OP_MUL_FLOAT (0x18) Format: [opcode] Stack: [a:float][b:float] 
[a*b:float] Action: Floating-point multiplication</p>
<p>OP_DIV_FLOAT (0x19) Format: [opcode] Stack: [a:float][b:float] 
[a/b:float] Action: Floating-point division</p>
<h3>A.4.3 Bitwise Operations</h3>
<p>OP_AND (0x1A) Format: [opcode] Stack: [a:int][b:int]  [a&amp;b:int]
Action: Bitwise AND</p>
<p>OP_OR (0x1B) Format: [opcode] Stack: [a:int][b:int]  [a|b:int]
Action: Bitwise OR</p>
<p>OP_XOR (0x1C) Format: [opcode] Stack: [a:int][b:int]  [a^b:int]
Action: Bitwise XOR</p>
<p>OP_NOT (0x1D) Format: [opcode] Stack: [a:int]  [~a:int] Action:
Bitwise NOT</p>
<p>OP_SHL (0x1E) Format: [opcode] Stack: [a:int][b:int] 
[a&lt;&lt;b:int] Action: Shift left</p>
<p>OP_SHR (0x1F) Format: [opcode] Stack: [a:int][b:int] 
[a&gt;&gt;b:int] Action: Arithmetic shift right</p>
<h2>A.5 Control Flow Instructions</h2>
<h3>A.5.1 Unconditional Jumps</h3>
<p>OP_JUMP (0x20) Format: [opcode][offset:16] Stack: []  [] Action: PC
+= offset (signed) Compilation: JUMP label</p>
<p>OP_JUMP_LONG (0x21) Format: [opcode][0][offset:32] Stack: []  []
Action: PC += offset (32-bit signed) Note: Used for large functions</p>
<h3>A.5.2 Conditional Branches</h3>
<p>OP_JUMP_IF_TRUE (0x22) Format: [opcode][offset:16] Stack: [cond]  []
Action: if (cond) PC += offset Compilation: codeC(e, , sl, label_true,
label_false)</p>
<p>OP_JUMP_IF_FALSE (0x23) Format: [opcode][offset:16] Stack: [cond] 
[] Action: if (!cond) PC += offset</p>
<p>OP_JUMP_IF_EQ (0x24) Format: [opcode][offset:16] Stack: [a][b]  []
Action: if (a == b) PC += offset</p>
<p>OP_JUMP_IF_NE (0x25) Format: [opcode][offset:16] Stack: [a][b]  []
Action: if (a != b) PC += offset</p>
<p>OP_JUMP_IF_LT (0x26) Format: [opcode][offset:16] Stack: [a][b]  []
Action: if (a &lt; b) PC += offset</p>
<p>OP_JUMP_IF_LE (0x27) Format: [opcode][offset:16] Stack: [a][b]  []
Action: if (a &lt;= b) PC += offset</p>
<h3>A.5.3 Switch/Table Jump</h3>
<p>OP_TABLE_SWITCH (0x28) Format:
[opcode][default:16][low:16][high:16][...offsets...] Stack: [index]  []
Action: Jump based on table lookup Compilation: Used for dense switch
statements</p>
<p>OP_LOOKUP_SWITCH (0x29) Format:
[opcode][default:16][npairs:16][...key/offset pairs...] Stack: [key] 
[] Action: Binary search for key, then jump Compilation: Used for sparse
switch statements</p>
<h2>A.6 Function Call Instructions</h2>
<h3>A.6.1 Call and Return</h3>
<p>OP_CALL (0x30) Format: [opcode][argc:8][method_id:16] Stack:
[obj][arg1]...[argn]  [result] Action: Invoke method with arguments
Frame: Creates new stack frame</p>
<p>OP_CALL_STATIC (0x31) Format: [opcode][argc:8][function_id:16] Stack:
[arg1]...[argn]  [result] Action: Call static function Note: No
receiver object</p>
<p>OP_CALL_VIRTUAL (0x32) Format: [opcode][argc:8][vtable_index:16]
Stack: [obj][arg1]...[argn]  [result] Action: Virtual dispatch through
vtable</p>
<p>OP_CALL_INTERFACE (0x33) Format: [opcode][argc:8][interface_id:16]
Stack: [obj][arg1]...[argn]  [result] Action: Interface method
dispatch</p>
<p>OP_RETURN (0x34) Format: [opcode] Stack: [value]  [] Action: Return
from function Frame: Restores previous frame</p>
<p>OP_RETURN_VOID (0x35) Format: [opcode] Stack: []  [] Action: Return
without value</p>
<h3>A.6.2 Tail Calls</h3>
<p>OP_TAIL_CALL (0x36) Format: [opcode][argc:8][method_id:16] Stack:
[obj][arg1]...[argn]  [result] Action: Tail-recursive call (reuses
frame) Optimization: No new frame allocation</p>
<p>OP_TAIL_CALL_STATIC (0x37) Format: [opcode][argc:8][function_id:16]
Stack: [arg1]...[argn]  [result] Action: Static tail call</p>
<h2>A.7 Object and Array Instructions</h2>
<h3>A.7.1 Object Operations</h3>
<p>OP_NEW (0x40) Format: [opcode][class_id:16] Stack: []  [obj] Action:
Allocate new object GC: May trigger collection</p>
<p>OP_GET_FIELD (0x41) Format: [opcode][field_id:16] Stack: [obj] 
[value] Action: Read object field</p>
<p>OP_PUT_FIELD (0x42) Format: [opcode][field_id:16] Stack: [obj][value]
 [] Action: Write object field</p>
<p>OP_GET_STATIC_FIELD (0x43) Format: [opcode][field_id:16] Stack: [] 
[value] Action: Read static field</p>
<p>OP_PUT_STATIC_FIELD (0x44) Format: [opcode][field_id:16] Stack:
[value]  [] Action: Write static field</p>
<h3>A.7.2 Array Operations</h3>
<p>OP_NEW_ARRAY (0x45) Format: [opcode][type:8] Stack: [size]  [array]
Action: Allocate array</p>
<p>OP_ARRAY_LENGTH (0x46) Format: [opcode] Stack: [array]  [length]
Action: Get array length</p>
<p>OP_ARRAY_LOAD (0x47) Format: [opcode] Stack: [array][index]  [value]
Action: Load array element Exception: BoundsCheck if index out of
range</p>
<p>OP_ARRAY_STORE (0x48) Format: [opcode] Stack: [array][index][value] 
[] Action: Store array element</p>
<h2>A.8 Type Instructions</h2>
<h3>A.8.1 Type Checking</h3>
<p>OP_INSTANCEOF (0x50) Format: [opcode][type_id:16] Stack: [obj] 
[bool] Action: Test if object is instance of type</p>
<p>OP_CHECKCAST (0x51) Format: [opcode][type_id:16] Stack: [obj]  [obj]
Action: Verify cast, throw if invalid Exception: ClassCastException on
failure</p>
<h3>A.8.2 Type Conversion</h3>
<p>OP_INT_TO_FLOAT (0x52) Format: [opcode] Stack: [int]  [float]
Action: Convert integer to float</p>
<p>OP_FLOAT_TO_INT (0x53) Format: [opcode] Stack: [float]  [int]
Action: Convert float to integer (truncate)</p>
<p>OP_INT_TO_STRING (0x54) Format: [opcode] Stack: [int]  [string]
Action: Convert integer to string</p>
<p>OP_BOX (0x55) Format: [opcode][type:8] Stack: [primitive]  [boxed]
Action: Box primitive value</p>
<p>OP_UNBOX (0x56) Format: [opcode][type:8] Stack: [boxed]  [primitive]
Action: Unbox to primitive</p>
<h2>A.9 Exception Handling Instructions</h2>
<h3>A.9.1 Exception Control Flow</h3>
<p>OP_THROW (0x60) Format: [opcode] Stack: [exception]  [] Action:
Throw exception Frame: Unwinds stack to handler</p>
<p>OP_MONITOR_ENTER (0x61) Format: [opcode] Stack: [obj]  [] Action:
Acquire object monitor Sync: May block on contention</p>
<p>OP_MONITOR_EXIT (0x62) Format: [opcode] Stack: [obj]  [] Action:
Release object monitor Exception: IllegalMonitorState if not owned</p>
<h2>A.10 Specialized Instructions</h2>
<h3>A.10.1 Quick Instructions (After Resolution)</h3>
<p>OP_GET_FIELD_QUICK (0x70) Format: [opcode][offset:16] Stack: [obj] 
[value] Action: Direct field access (resolved) Note: Replaces GET_FIELD
after first execution</p>
<p>OP_PUT_FIELD_QUICK (0x71) Format: [opcode][offset:16] Stack:
[obj][value]  [] Action: Direct field write (resolved)</p>
<p>OP_INVOKE_VIRTUAL_QUICK (0x72) Format: [opcode][vtable_offset:16]
Stack: [obj][</p>
<h1>Appendix B: C API Documentation</h1>
<h2>B.1 Introduction</h2>
<p>This appendix provides comprehensive documentation for Diyrbal&#39;s C
API, enabling native extension development and embedding of the VM into
host applications. The API follows consistent naming conventions and
memory management patterns to ensure safety and ease of use.</p>
<h2>B.2 Core VM API</h2>
<h3>B.2.1 VM Initialization and Lifecycle</h3>
<div class="sourceCode" id="cb248"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb248-1"><a href="#cb248-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* VM instance management */</span></span>
<span id="cb248-2"><a href="#cb248-2" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> DiyrbalVM DiyrbalVM<span class="op">;</span></span>
<span id="cb248-3"><a href="#cb248-3" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> DiyrbalConfig DiyrbalConfig<span class="op">;</span></span>
<span id="cb248-4"><a href="#cb248-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-5"><a href="#cb248-5" aria-hidden="true" tabindex="-1"></a><span class="co">/* Create and configure VM */</span></span>
<span id="cb248-6"><a href="#cb248-6" aria-hidden="true" tabindex="-1"></a>DiyrbalConfig<span class="op">*</span> dyr_config_new<span class="op">(</span><span class="dt">void</span><span class="op">);</span></span>
<span id="cb248-7"><a href="#cb248-7" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> dyr_config_set_heap_size<span class="op">(</span>DiyrbalConfig<span class="op">*</span> config<span class="op">,</span> <span class="dt">size_t</span> min<span class="op">,</span> <span class="dt">size_t</span> max<span class="op">);</span></span>
<span id="cb248-8"><a href="#cb248-8" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> dyr_config_set_stack_size<span class="op">(</span>DiyrbalConfig<span class="op">*</span> config<span class="op">,</span> <span class="dt">size_t</span> size<span class="op">);</span></span>
<span id="cb248-9"><a href="#cb248-9" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> dyr_config_set_gc_threshold<span class="op">(</span>DiyrbalConfig<span class="op">*</span> config<span class="op">,</span> <span class="dt">size_t</span> threshold<span class="op">);</span></span>
<span id="cb248-10"><a href="#cb248-10" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> dyr_config_enable_jit<span class="op">(</span>DiyrbalConfig<span class="op">*</span> config<span class="op">,</span> <span class="dt">bool</span> enable<span class="op">);</span></span>
<span id="cb248-11"><a href="#cb248-11" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> dyr_config_set_optimization_level<span class="op">(</span>DiyrbalConfig<span class="op">*</span> config<span class="op">,</span> <span class="dt">int</span> level<span class="op">);</span></span>
<span id="cb248-12"><a href="#cb248-12" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> dyr_config_free<span class="op">(</span>DiyrbalConfig<span class="op">*</span> config<span class="op">);</span></span>
<span id="cb248-13"><a href="#cb248-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-14"><a href="#cb248-14" aria-hidden="true" tabindex="-1"></a><span class="co">/* VM lifecycle */</span></span>
<span id="cb248-15"><a href="#cb248-15" aria-hidden="true" tabindex="-1"></a>DiyrbalVM<span class="op">*</span> dyr_vm_create<span class="op">(</span>DiyrbalConfig<span class="op">*</span> config<span class="op">);</span></span>
<span id="cb248-16"><a href="#cb248-16" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> dyr_vm_initialize<span class="op">(</span>DiyrbalVM<span class="op">*</span> vm<span class="op">);</span></span>
<span id="cb248-17"><a href="#cb248-17" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> dyr_vm_shutdown<span class="op">(</span>DiyrbalVM<span class="op">*</span> vm<span class="op">);</span></span>
<span id="cb248-18"><a href="#cb248-18" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> dyr_vm_destroy<span class="op">(</span>DiyrbalVM<span class="op">*</span> vm<span class="op">);</span></span>
<span id="cb248-19"><a href="#cb248-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-20"><a href="#cb248-20" aria-hidden="true" tabindex="-1"></a><span class="co">/* Error handling */</span></span>
<span id="cb248-21"><a href="#cb248-21" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">enum</span> <span class="op">{</span></span>
<span id="cb248-22"><a href="#cb248-22" aria-hidden="true" tabindex="-1"></a>    DYR_OK <span class="op">=</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb248-23"><a href="#cb248-23" aria-hidden="true" tabindex="-1"></a>    DYR_ERROR_OOM <span class="op">=</span> <span class="op">-</span><span class="dv">1</span><span class="op">,</span></span>
<span id="cb248-24"><a href="#cb248-24" aria-hidden="true" tabindex="-1"></a>    DYR_ERROR_INVALID_ARG <span class="op">=</span> <span class="op">-</span><span class="dv">2</span><span class="op">,</span></span>
<span id="cb248-25"><a href="#cb248-25" aria-hidden="true" tabindex="-1"></a>    DYR_ERROR_TYPE_MISMATCH <span class="op">=</span> <span class="op">-</span><span class="dv">3</span><span class="op">,</span></span>
<span id="cb248-26"><a href="#cb248-26" aria-hidden="true" tabindex="-1"></a>    DYR_ERROR_NULL_POINTER <span class="op">=</span> <span class="op">-</span><span class="dv">4</span><span class="op">,</span></span>
<span id="cb248-27"><a href="#cb248-27" aria-hidden="true" tabindex="-1"></a>    DYR_ERROR_INDEX_BOUNDS <span class="op">=</span> <span class="op">-</span><span class="dv">5</span><span class="op">,</span></span>
<span id="cb248-28"><a href="#cb248-28" aria-hidden="true" tabindex="-1"></a>    DYR_ERROR_RUNTIME <span class="op">=</span> <span class="op">-</span><span class="dv">6</span><span class="op">,</span></span>
<span id="cb248-29"><a href="#cb248-29" aria-hidden="true" tabindex="-1"></a>    DYR_ERROR_COMPILATION <span class="op">=</span> <span class="op">-</span><span class="dv">7</span></span>
<span id="cb248-30"><a href="#cb248-30" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> DyrStatus<span class="op">;</span></span>
<span id="cb248-31"><a href="#cb248-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-32"><a href="#cb248-32" aria-hidden="true" tabindex="-1"></a><span class="dt">const</span> <span class="dt">char</span><span class="op">*</span> dyr_error_string<span class="op">(</span>DyrStatus status<span class="op">);</span></span>
<span id="cb248-33"><a href="#cb248-33" aria-hidden="true" tabindex="-1"></a>DyrStatus dyr_get_last_error<span class="op">(</span>DiyrbalVM<span class="op">*</span> vm<span class="op">);</span></span>
<span id="cb248-34"><a href="#cb248-34" aria-hidden="true" tabindex="-1"></a><span class="dt">const</span> <span class="dt">char</span><span class="op">*</span> dyr_get_error_message<span class="op">(</span>DiyrbalVM<span class="op">*</span> vm<span class="op">);</span></span></code></pre></div>
<h3>B.2.2 Thread Management</h3>
<div class="sourceCode" id="cb249"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb249-1"><a href="#cb249-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* Thread context */</span></span>
<span id="cb249-2"><a href="#cb249-2" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> DyrThread DyrThread<span class="op">;</span></span>
<span id="cb249-3"><a href="#cb249-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb249-4"><a href="#cb249-4" aria-hidden="true" tabindex="-1"></a><span class="co">/* Thread operations */</span></span>
<span id="cb249-5"><a href="#cb249-5" aria-hidden="true" tabindex="-1"></a>DyrThread<span class="op">*</span> dyr_thread_current<span class="op">(</span>DiyrbalVM<span class="op">*</span> vm<span class="op">);</span></span>
<span id="cb249-6"><a href="#cb249-6" aria-hidden="true" tabindex="-1"></a>DyrThread<span class="op">*</span> dyr_thread_create<span class="op">(</span>DiyrbalVM<span class="op">*</span> vm<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span><span class="op">*</span> name<span class="op">);</span></span>
<span id="cb249-7"><a href="#cb249-7" aria-hidden="true" tabindex="-1"></a>DyrStatus dyr_thread_start<span class="op">(</span>DyrThread<span class="op">*</span> thread<span class="op">,</span> DyrValue<span class="op">*</span> callable<span class="op">,</span> </span>
<span id="cb249-8"><a href="#cb249-8" aria-hidden="true" tabindex="-1"></a>                          DyrValue<span class="op">*</span> args<span class="op">,</span> <span class="dt">int</span> argc<span class="op">);</span></span>
<span id="cb249-9"><a href="#cb249-9" aria-hidden="true" tabindex="-1"></a>DyrStatus dyr_thread_join<span class="op">(</span>DyrThread<span class="op">*</span> thread<span class="op">,</span> DyrValue<span class="op">**</span> result<span class="op">);</span></span>
<span id="cb249-10"><a href="#cb249-10" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> dyr_thread_yield<span class="op">(</span><span class="dt">void</span><span class="op">);</span></span>
<span id="cb249-11"><a href="#cb249-11" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> dyr_thread_is_alive<span class="op">(</span>DyrThread<span class="op">*</span> thread<span class="op">);</span></span>
<span id="cb249-12"><a href="#cb249-12" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> dyr_thread_interrupt<span class="op">(</span>DyrThread<span class="op">*</span> thread<span class="op">);</span></span>
<span id="cb249-13"><a href="#cb249-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb249-14"><a href="#cb249-14" aria-hidden="true" tabindex="-1"></a><span class="co">/* Thread-local storage */</span></span>
<span id="cb249-15"><a href="#cb249-15" aria-hidden="true" tabindex="-1"></a>DyrStatus dyr_thread_set_local<span class="op">(</span>DyrThread<span class="op">*</span> thread<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span><span class="op">*</span> key<span class="op">,</span> </span>
<span id="cb249-16"><a href="#cb249-16" aria-hidden="true" tabindex="-1"></a>                               DyrValue<span class="op">*</span> value<span class="op">);</span></span>
<span id="cb249-17"><a href="#cb249-17" aria-hidden="true" tabindex="-1"></a>DyrValue<span class="op">*</span> dyr_thread_get_local<span class="op">(</span>DyrThread<span class="op">*</span> thread<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span><span class="op">*</span> key<span class="op">);</span></span></code></pre></div>
<h2>B.3 Value System API</h2>
<h3>B.3.1 Value Types and Creation</h3>
<div class="sourceCode" id="cb250"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb250-1"><a href="#cb250-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* Value handle */</span></span>
<span id="cb250-2"><a href="#cb250-2" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> DyrValue DyrValue<span class="op">;</span></span>
<span id="cb250-3"><a href="#cb250-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb250-4"><a href="#cb250-4" aria-hidden="true" tabindex="-1"></a><span class="co">/* Type enumeration */</span></span>
<span id="cb250-5"><a href="#cb250-5" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">enum</span> <span class="op">{</span></span>
<span id="cb250-6"><a href="#cb250-6" aria-hidden="true" tabindex="-1"></a>    DYR_TYPE_NULL<span class="op">,</span></span>
<span id="cb250-7"><a href="#cb250-7" aria-hidden="true" tabindex="-1"></a>    DYR_TYPE_BOOLEAN<span class="op">,</span></span>
<span id="cb250-8"><a href="#cb250-8" aria-hidden="true" tabindex="-1"></a>    DYR_TYPE_INTEGER<span class="op">,</span></span>
<span id="cb250-9"><a href="#cb250-9" aria-hidden="true" tabindex="-1"></a>    DYR_TYPE_FLOAT<span class="op">,</span></span>
<span id="cb250-10"><a href="#cb250-10" aria-hidden="true" tabindex="-1"></a>    DYR_TYPE_STRING<span class="op">,</span></span>
<span id="cb250-11"><a href="#cb250-11" aria-hidden="true" tabindex="-1"></a>    DYR_TYPE_OBJECT<span class="op">,</span></span>
<span id="cb250-12"><a href="#cb250-12" aria-hidden="true" tabindex="-1"></a>    DYR_TYPE_ARRAY<span class="op">,</span></span>
<span id="cb250-13"><a href="#cb250-13" aria-hidden="true" tabindex="-1"></a>    DYR_TYPE_FUNCTION<span class="op">,</span></span>
<span id="cb250-14"><a href="#cb250-14" aria-hidden="true" tabindex="-1"></a>    DYR_TYPE_CLASS<span class="op">,</span></span>
<span id="cb250-15"><a href="#cb250-15" aria-hidden="true" tabindex="-1"></a>    DYR_TYPE_NATIVE_POINTER</span>
<span id="cb250-16"><a href="#cb250-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> DyrType<span class="op">;</span></span>
<span id="cb250-17"><a href="#cb250-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb250-18"><a href="#cb250-18" aria-hidden="true" tabindex="-1"></a><span class="co">/* Type checking */</span></span>
<span id="cb250-19"><a href="#cb250-19" aria-hidden="true" tabindex="-1"></a>DyrType dyr_value_type<span class="op">(</span>DyrValue<span class="op">*</span> value<span class="op">);</span></span>
<span id="cb250-20"><a href="#cb250-20" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> dyr_value_is_null<span class="op">(</span>DyrValue<span class="op">*</span> value<span class="op">);</span></span>
<span id="cb250-21"><a href="#cb250-21" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> dyr_value_is_boolean<span class="op">(</span>DyrValue<span class="op">*</span> value<span class="op">);</span></span>
<span id="cb250-22"><a href="#cb250-22" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> dyr_value_is_number<span class="op">(</span>DyrValue<span class="op">*</span> value<span class="op">);</span></span>
<span id="cb250-23"><a href="#cb250-23" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> dyr_value_is_string<span class="op">(</span>DyrValue<span class="op">*</span> value<span class="op">);</span></span>
<span id="cb250-24"><a href="#cb250-24" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> dyr_value_is_object<span class="op">(</span>DyrValue<span class="op">*</span> value<span class="op">);</span></span>
<span id="cb250-25"><a href="#cb250-25" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> dyr_value_is_array<span class="op">(</span>DyrValue<span class="op">*</span> value<span class="op">);</span></span>
<span id="cb250-26"><a href="#cb250-26" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> dyr_value_is_function<span class="op">(</span>DyrValue<span class="op">*</span> value<span class="op">);</span></span>
<span id="cb250-27"><a href="#cb250-27" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> dyr_value_is_instance_of<span class="op">(</span>DyrValue<span class="op">*</span> value<span class="op">,</span> DyrValue<span class="op">*</span> class_value<span class="op">);</span></span>
<span id="cb250-28"><a href="#cb250-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb250-29"><a href="#cb250-29" aria-hidden="true" tabindex="-1"></a><span class="co">/* Primitive value creation */</span></span>
<span id="cb250-30"><a href="#cb250-30" aria-hidden="true" tabindex="-1"></a>DyrValue<span class="op">*</span> dyr_null<span class="op">(</span>DiyrbalVM<span class="op">*</span> vm<span class="op">);</span></span>
<span id="cb250-31"><a href="#cb250-31" aria-hidden="true" tabindex="-1"></a>DyrValue<span class="op">*</span> dyr_boolean<span class="op">(</span>DiyrbalVM<span class="op">*</span> vm<span class="op">,</span> <span class="dt">bool</span> value<span class="op">);</span></span>
<span id="cb250-32"><a href="#cb250-32" aria-hidden="true" tabindex="-1"></a>DyrValue<span class="op">*</span> dyr_integer<span class="op">(</span>DiyrbalVM<span class="op">*</span> vm<span class="op">,</span> <span class="dt">int64_t</span> value<span class="op">);</span></span>
<span id="cb250-33"><a href="#cb250-33" aria-hidden="true" tabindex="-1"></a>DyrValue<span class="op">*</span> dyr_float<span class="op">(</span>DiyrbalVM<span class="op">*</span> vm<span class="op">,</span> <span class="dt">double</span> value<span class="op">);</span></span>
<span id="cb250-34"><a href="#cb250-34" aria-hidden="true" tabindex="-1"></a>DyrValue<span class="op">*</span> dyr_string<span class="op">(</span>DiyrbalVM<span class="op">*</span> vm<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span><span class="op">*</span> str<span class="op">);</span></span>
<span id="cb250-35"><a href="#cb250-35" aria-hidden="true" tabindex="-1"></a>DyrValue<span class="op">*</span> dyr_string_n<span class="op">(</span>DiyrbalVM<span class="op">*</span> vm<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span><span class="op">*</span> str<span class="op">,</span> <span class="dt">size_t</span> len<span class="op">);</span></span></code></pre></div>
<h3>B.3.2 Value Conversion</h3>
<div class="sourceCode" id="cb251"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb251-1"><a href="#cb251-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* Extract C values */</span></span>
<span id="cb251-2"><a href="#cb251-2" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> dyr_to_boolean<span class="op">(</span>DyrValue<span class="op">*</span> value<span class="op">,</span> <span class="dt">bool</span><span class="op">*</span> result<span class="op">);</span></span>
<span id="cb251-3"><a href="#cb251-3" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> dyr_to_integer<span class="op">(</span>DyrValue<span class="op">*</span> value<span class="op">,</span> <span class="dt">int64_t</span><span class="op">*</span> result<span class="op">);</span></span>
<span id="cb251-4"><a href="#cb251-4" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> dyr_to_float<span class="op">(</span>DyrValue<span class="op">*</span> value<span class="op">,</span> <span class="dt">double</span><span class="op">*</span> result<span class="op">);</span></span>
<span id="cb251-5"><a href="#cb251-5" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> dyr_to_string<span class="op">(</span>DyrValue<span class="op">*</span> value<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span><span class="op">**</span> result<span class="op">,</span> <span class="dt">size_t</span><span class="op">*</span> len<span class="op">);</span></span>
<span id="cb251-6"><a href="#cb251-6" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> dyr_to_cstring<span class="op">(</span>DyrValue<span class="op">*</span> value<span class="op">,</span> <span class="dt">char</span><span class="op">*</span> buffer<span class="op">,</span> <span class="dt">size_t</span> buffer_size<span class="op">);</span></span>
<span id="cb251-7"><a href="#cb251-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb251-8"><a href="#cb251-8" aria-hidden="true" tabindex="-1"></a><span class="co">/* String operations */</span></span>
<span id="cb251-9"><a href="#cb251-9" aria-hidden="true" tabindex="-1"></a><span class="dt">size_t</span> dyr_string_length<span class="op">(</span>DyrValue<span class="op">*</span> string<span class="op">);</span></span>
<span id="cb251-10"><a href="#cb251-10" aria-hidden="true" tabindex="-1"></a><span class="dt">const</span> <span class="dt">char</span><span class="op">*</span> dyr_string_data<span class="op">(</span>DyrValue<span class="op">*</span> string<span class="op">);</span></span>
<span id="cb251-11"><a href="#cb251-11" aria-hidden="true" tabindex="-1"></a>DyrValue<span class="op">*</span> dyr_string_concat<span class="op">(</span>DiyrbalVM<span class="op">*</span> vm<span class="op">,</span> DyrValue<span class="op">*</span> s1<span class="op">,</span> DyrValue<span class="op">*</span> s2<span class="op">);</span></span>
<span id="cb251-12"><a href="#cb251-12" aria-hidden="true" tabindex="-1"></a>DyrValue<span class="op">*</span> dyr_string_substring<span class="op">(</span>DiyrbalVM<span class="op">*</span> vm<span class="op">,</span> DyrValue<span class="op">*</span> str<span class="op">,</span> </span>
<span id="cb251-13"><a href="#cb251-13" aria-hidden="true" tabindex="-1"></a>                               <span class="dt">size_t</span> start<span class="op">,</span> <span class="dt">size_t</span> len<span class="op">);</span></span>
<span id="cb251-14"><a href="#cb251-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb251-15"><a href="#cb251-15" aria-hidden="true" tabindex="-1"></a><span class="co">/* Type conversion */</span></span>
<span id="cb251-16"><a href="#cb251-16" aria-hidden="true" tabindex="-1"></a>DyrValue<span class="op">*</span> dyr_convert_to_string<span class="op">(</span>DiyrbalVM<span class="op">*</span> vm<span class="op">,</span> DyrValue<span class="op">*</span> value<span class="op">);</span></span>
<span id="cb251-17"><a href="#cb251-17" aria-hidden="true" tabindex="-1"></a>DyrValue<span class="op">*</span> dyr_convert_to_number<span class="op">(</span>DiyrbalVM<span class="op">*</span> vm<span class="op">,</span> DyrValue<span class="op">*</span> value<span class="op">);</span></span>
<span id="cb251-18"><a href="#cb251-18" aria-hidden="true" tabindex="-1"></a>DyrValue<span class="op">*</span> dyr_convert_to_boolean<span class="op">(</span>DiyrbalVM<span class="op">*</span> vm<span class="op">,</span> DyrValue<span class="op">*</span> value<span class="op">);</span></span></code></pre></div>
<h2>B.4 Object and Class API</h2>
<h3>B.4.1 Class Definition</h3>
<div class="sourceCode" id="cb252"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb252-1"><a href="#cb252-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* Class builder */</span></span>
<span id="cb252-2"><a href="#cb252-2" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> DyrClassBuilder DyrClassBuilder<span class="op">;</span></span>
<span id="cb252-3"><a href="#cb252-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb252-4"><a href="#cb252-4" aria-hidden="true" tabindex="-1"></a><span class="co">/* Class creation */</span></span>
<span id="cb252-5"><a href="#cb252-5" aria-hidden="true" tabindex="-1"></a>DyrClassBuilder<span class="op">*</span> dyr_class_builder_new<span class="op">(</span>DiyrbalVM<span class="op">*</span> vm<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span><span class="op">*</span> name<span class="op">);</span></span>
<span id="cb252-6"><a href="#cb252-6" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> dyr_class_set_super<span class="op">(</span>DyrClassBuilder<span class="op">*</span> builder<span class="op">,</span> DyrValue<span class="op">*</span> super_class<span class="op">);</span></span>
<span id="cb252-7"><a href="#cb252-7" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> dyr_class_add_field<span class="op">(</span>DyrClassBuilder<span class="op">*</span> builder<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span><span class="op">*</span> name<span class="op">,</span> </span>
<span id="cb252-8"><a href="#cb252-8" aria-hidden="true" tabindex="-1"></a>                         DyrType type<span class="op">,</span> <span class="dt">bool</span> is_static<span class="op">);</span></span>
<span id="cb252-9"><a href="#cb252-9" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> dyr_class_add_method<span class="op">(</span>DyrClassBuilder<span class="op">*</span> builder<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span><span class="op">*</span> name<span class="op">,</span></span>
<span id="cb252-10"><a href="#cb252-10" aria-hidden="true" tabindex="-1"></a>                         DyrNativeMethod method<span class="op">,</span> <span class="dt">int</span> argc<span class="op">,</span> <span class="dt">bool</span> is_static<span class="op">);</span></span>
<span id="cb252-11"><a href="#cb252-11" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> dyr_class_add_property<span class="op">(</span>DyrClassBuilder<span class="op">*</span> builder<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span><span class="op">*</span> name<span class="op">,</span></span>
<span id="cb252-12"><a href="#cb252-12" aria-hidden="true" tabindex="-1"></a>                           DyrNativeGetter getter<span class="op">,</span> DyrNativeSetter setter<span class="op">);</span></span>
<span id="cb252-13"><a href="#cb252-13" aria-hidden="true" tabindex="-1"></a>DyrValue<span class="op">*</span> dyr_class_build<span class="op">(</span>DyrClassBuilder<span class="op">*</span> builder<span class="op">);</span></span>
<span id="cb252-14"><a href="#cb252-14" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> dyr_class_builder_free<span class="op">(</span>DyrClassBuilder<span class="op">*</span> builder<span class="op">);</span></span>
<span id="cb252-15"><a href="#cb252-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb252-16"><a href="#cb252-16" aria-hidden="true" tabindex="-1"></a><span class="co">/* Class introspection */</span></span>
<span id="cb252-17"><a href="#cb252-17" aria-hidden="true" tabindex="-1"></a><span class="dt">const</span> <span class="dt">char</span><span class="op">*</span> dyr_class_name<span class="op">(</span>DyrValue<span class="op">*</span> class_value<span class="op">);</span></span>
<span id="cb252-18"><a href="#cb252-18" aria-hidden="true" tabindex="-1"></a>DyrValue<span class="op">*</span> dyr_class_get_super<span class="op">(</span>DyrValue<span class="op">*</span> class_value<span class="op">);</span></span>
<span id="cb252-19"><a href="#cb252-19" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> dyr_class_has_field<span class="op">(</span>DyrValue<span class="op">*</span> class_value<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span><span class="op">*</span> name<span class="op">);</span></span>
<span id="cb252-20"><a href="#cb252-20" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> dyr_class_has_method<span class="op">(</span>DyrValue<span class="op">*</span> class_value<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span><span class="op">*</span> name<span class="op">);</span></span>
<span id="cb252-21"><a href="#cb252-21" aria-hidden="true" tabindex="-1"></a>DyrValue<span class="op">*</span> dyr_class_get_method<span class="op">(</span>DyrValue<span class="op">*</span> class_value<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span><span class="op">*</span> name<span class="op">);</span></span></code></pre></div>
<h3>B.4.2 Object Operations</h3>
<div class="sourceCode" id="cb253"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb253-1"><a href="#cb253-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* Object creation and field access */</span></span>
<span id="cb253-2"><a href="#cb253-2" aria-hidden="true" tabindex="-1"></a>DyrValue<span class="op">*</span> dyr_object_new<span class="op">(</span>DiyrbalVM<span class="op">*</span> vm<span class="op">,</span> DyrValue<span class="op">*</span> class_value<span class="op">);</span></span>
<span id="cb253-3"><a href="#cb253-3" aria-hidden="true" tabindex="-1"></a>DyrValue<span class="op">*</span> dyr_object_get_field<span class="op">(</span>DyrValue<span class="op">*</span> object<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span><span class="op">*</span> field<span class="op">);</span></span>
<span id="cb253-4"><a href="#cb253-4" aria-hidden="true" tabindex="-1"></a>DyrStatus dyr_object_set_field<span class="op">(</span>DyrValue<span class="op">*</span> object<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span><span class="op">*</span> field<span class="op">,</span> </span>
<span id="cb253-5"><a href="#cb253-5" aria-hidden="true" tabindex="-1"></a>                               DyrValue<span class="op">*</span> value<span class="op">);</span></span>
<span id="cb253-6"><a href="#cb253-6" aria-hidden="true" tabindex="-1"></a>DyrValue<span class="op">*</span> dyr_object_get_class<span class="op">(</span>DyrValue<span class="op">*</span> object<span class="op">);</span></span>
<span id="cb253-7"><a href="#cb253-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb253-8"><a href="#cb253-8" aria-hidden="true" tabindex="-1"></a><span class="co">/* Property access (triggers getters/setters) */</span></span>
<span id="cb253-9"><a href="#cb253-9" aria-hidden="true" tabindex="-1"></a>DyrValue<span class="op">*</span> dyr_object_get_property<span class="op">(</span>DyrValue<span class="op">*</span> object<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span><span class="op">*</span> property<span class="op">);</span></span>
<span id="cb253-10"><a href="#cb253-10" aria-hidden="true" tabindex="-1"></a>DyrStatus dyr_object_set_property<span class="op">(</span>DyrValue<span class="op">*</span> object<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span><span class="op">*</span> property<span class="op">,</span></span>
<span id="cb253-11"><a href="#cb253-11" aria-hidden="true" tabindex="-1"></a>                                  DyrValue<span class="op">*</span> value<span class="op">);</span></span>
<span id="cb253-12"><a href="#cb253-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb253-13"><a href="#cb253-13" aria-hidden="true" tabindex="-1"></a><span class="co">/* Method invocation */</span></span>
<span id="cb253-14"><a href="#cb253-14" aria-hidden="true" tabindex="-1"></a>DyrValue<span class="op">*</span> dyr_object_call_method<span class="op">(</span>DyrValue<span class="op">*</span> object<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span><span class="op">*</span> method<span class="op">,</span></span>
<span id="cb253-15"><a href="#cb253-15" aria-hidden="true" tabindex="-1"></a>                                 DyrValue<span class="op">**</span> args<span class="op">,</span> <span class="dt">int</span> argc<span class="op">);</span></span></code></pre></div>
<h2>B.5 Array API</h2>
<h3>B.5.1 Array Operations</h3>
<div class="sourceCode" id="cb254"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb254-1"><a href="#cb254-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* Array creation */</span></span>
<span id="cb254-2"><a href="#cb254-2" aria-hidden="true" tabindex="-1"></a>DyrValue<span class="op">*</span> dyr_array_new<span class="op">(</span>DiyrbalVM<span class="op">*</span> vm<span class="op">,</span> <span class="dt">size_t</span> length<span class="op">);</span></span>
<span id="cb254-3"><a href="#cb254-3" aria-hidden="true" tabindex="-1"></a>DyrValue<span class="op">*</span> dyr_array_new_typed<span class="op">(</span>DiyrbalVM<span class="op">*</span> vm<span class="op">,</span> DyrType element_type<span class="op">,</span> </span>
<span id="cb254-4"><a href="#cb254-4" aria-hidden="true" tabindex="-1"></a>                              <span class="dt">size_t</span> length<span class="op">);</span></span>
<span id="cb254-5"><a href="#cb254-5" aria-hidden="true" tabindex="-1"></a>DyrValue<span class="op">*</span> dyr_array_from_values<span class="op">(</span>DiyrbalVM<span class="op">*</span> vm<span class="op">,</span> DyrValue<span class="op">**</span> values<span class="op">,</span> </span>
<span id="cb254-6"><a href="#cb254-6" aria-hidden="true" tabindex="-1"></a>                                <span class="dt">size_t</span> count<span class="op">);</span></span>
<span id="cb254-7"><a href="#cb254-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb254-8"><a href="#cb254-8" aria-hidden="true" tabindex="-1"></a><span class="co">/* Array access */</span></span>
<span id="cb254-9"><a href="#cb254-9" aria-hidden="true" tabindex="-1"></a><span class="dt">size_t</span> dyr_array_length<span class="op">(</span>DyrValue<span class="op">*</span> array<span class="op">);</span></span>
<span id="cb254-10"><a href="#cb254-10" aria-hidden="true" tabindex="-1"></a>DyrValue<span class="op">*</span> dyr_array_get<span class="op">(</span>DyrValue<span class="op">*</span> array<span class="op">,</span> <span class="dt">size_t</span> index<span class="op">);</span></span>
<span id="cb254-11"><a href="#cb254-11" aria-hidden="true" tabindex="-1"></a>DyrStatus dyr_array_set<span class="op">(</span>DyrValue<span class="op">*</span> array<span class="op">,</span> <span class="dt">size_t</span> index<span class="op">,</span> DyrValue<span class="op">*</span> value<span class="op">);</span></span>
<span id="cb254-12"><a href="#cb254-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb254-13"><a href="#cb254-13" aria-hidden="true" tabindex="-1"></a><span class="co">/* Array manipulation */</span></span>
<span id="cb254-14"><a href="#cb254-14" aria-hidden="true" tabindex="-1"></a>DyrStatus dyr_array_push<span class="op">(</span>DyrValue<span class="op">*</span> array<span class="op">,</span> DyrValue<span class="op">*</span> value<span class="op">);</span></span>
<span id="cb254-15"><a href="#cb254-15" aria-hidden="true" tabindex="-1"></a>DyrValue<span class="op">*</span> dyr_array_pop<span class="op">(</span>DyrValue<span class="op">*</span> array<span class="op">);</span></span>
<span id="cb254-16"><a href="#cb254-16" aria-hidden="true" tabindex="-1"></a>DyrStatus dyr_array_insert<span class="op">(</span>DyrValue<span class="op">*</span> array<span class="op">,</span> <span class="dt">size_t</span> index<span class="op">,</span> DyrValue<span class="op">*</span> value<span class="op">);</span></span>
<span id="cb254-17"><a href="#cb254-17" aria-hidden="true" tabindex="-1"></a>DyrStatus dyr_array_remove<span class="op">(</span>DyrValue<span class="op">*</span> array<span class="op">,</span> <span class="dt">size_t</span> index<span class="op">);</span></span>
<span id="cb254-18"><a href="#cb254-18" aria-hidden="true" tabindex="-1"></a>DyrValue<span class="op">*</span> dyr_array_slice<span class="op">(</span>DiyrbalVM<span class="op">*</span> vm<span class="op">,</span> DyrValue<span class="op">*</span> array<span class="op">,</span> </span>
<span id="cb254-19"><a href="#cb254-19" aria-hidden="true" tabindex="-1"></a>                         <span class="dt">size_t</span> start<span class="op">,</span> <span class="dt">size_t</span> end<span class="op">);</span></span>
<span id="cb254-20"><a href="#cb254-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb254-21"><a href="#cb254-21" aria-hidden="true" tabindex="-1"></a><span class="co">/* Array utilities */</span></span>
<span id="cb254-22"><a href="#cb254-22" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> dyr_array_sort<span class="op">(</span>DyrValue<span class="op">*</span> array<span class="op">,</span> DyrCompareFunc compare<span class="op">);</span></span>
<span id="cb254-23"><a href="#cb254-23" aria-hidden="true" tabindex="-1"></a>DyrValue<span class="op">*</span> dyr_array_map<span class="op">(</span>DiyrbalVM<span class="op">*</span> vm<span class="op">,</span> DyrValue<span class="op">*</span> array<span class="op">,</span> </span>
<span id="cb254-24"><a href="#cb254-24" aria-hidden="true" tabindex="-1"></a>                       DyrMapFunc mapper<span class="op">);</span></span>
<span id="cb254-25"><a href="#cb254-25" aria-hidden="true" tabindex="-1"></a>DyrValue<span class="op">*</span> dyr_array_filter<span class="op">(</span>DiyrbalVM<span class="op">*</span> vm<span class="op">,</span> DyrValue<span class="op">*</span> array<span class="op">,</span> </span>
<span id="cb254-26"><a href="#cb254-26" aria-hidden="true" tabindex="-1"></a>                          DyrFilterFunc predicate<span class="op">);</span></span></code></pre></div>
<h2>B.6 Function API</h2>
<h3>B.6.1 Native Function Registration</h3>
<div class="sourceCode" id="cb255"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb255-1"><a href="#cb255-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* Native function signature */</span></span>
<span id="cb255-2"><a href="#cb255-2" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> DyrValue<span class="op">*</span> <span class="op">(*</span>DyrNativeFunc<span class="op">)(</span>DiyrbalVM<span class="op">*</span> vm<span class="op">,</span> DyrValue<span class="op">*</span> this<span class="op">,</span> </span>
<span id="cb255-3"><a href="#cb255-3" aria-hidden="true" tabindex="-1"></a>                                   DyrValue<span class="op">**</span> args<span class="op">,</span> <span class="dt">int</span> argc<span class="op">);</span></span>
<span id="cb255-4"><a href="#cb255-4" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> DyrValue<span class="op">*</span> <span class="op">(*</span>DyrNativeMethod<span class="op">)(</span>DyrValue<span class="op">*</span> this<span class="op">,</span> DyrValue<span class="op">**</span> args<span class="op">,</span> </span>
<span id="cb255-5"><a href="#cb255-5" aria-hidden="true" tabindex="-1"></a>                                     <span class="dt">int</span> argc<span class="op">);</span></span>
<span id="cb255-6"><a href="#cb255-6" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> DyrValue<span class="op">*</span> <span class="op">(*</span>DyrNativeGetter<span class="op">)(</span>DyrValue<span class="op">*</span> this<span class="op">);</span></span>
<span id="cb255-7"><a href="#cb255-7" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="dt">void</span> <span class="op">(*</span>DyrNativeSetter<span class="op">)(</span>DyrValue<span class="op">*</span> this<span class="op">,</span> DyrValue<span class="op">*</span> value<span class="op">);</span></span>
<span id="cb255-8"><a href="#cb255-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb255-9"><a href="#cb255-9" aria-hidden="true" tabindex="-1"></a><span class="co">/* Function registration */</span></span>
<span id="cb255-10"><a href="#cb255-10" aria-hidden="true" tabindex="-1"></a>DyrStatus dyr_register_function<span class="op">(</span>DiyrbalVM<span class="op">*</span> vm<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span><span class="op">*</span> name<span class="op">,</span></span>
<span id="cb255-11"><a href="#cb255-11" aria-hidden="true" tabindex="-1"></a>                                DyrNativeFunc func<span class="op">,</span> <span class="dt">int</span> min_args<span class="op">,</span> </span>
<span id="cb255-12"><a href="#cb255-12" aria-hidden="true" tabindex="-1"></a>                                <span class="dt">int</span> max_args<span class="op">);</span></span>
<span id="cb255-13"><a href="#cb255-13" aria-hidden="true" tabindex="-1"></a>DyrStatus dyr_register_module_function<span class="op">(</span>DiyrbalVM<span class="op">*</span> vm<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span><span class="op">*</span> module<span class="op">,</span></span>
<span id="cb255-14"><a href="#cb255-14" aria-hidden="true" tabindex="-1"></a>                                       <span class="dt">const</span> <span class="dt">char</span><span class="op">*</span> name<span class="op">,</span> DyrNativeFunc func<span class="op">,</span></span>
<span id="cb255-15"><a href="#cb255-15" aria-hidden="true" tabindex="-1"></a>                                       <span class="dt">int</span> min_args<span class="op">,</span> <span class="dt">int</span> max_args<span class="op">);</span></span>
<span id="cb255-16"><a href="#cb255-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb255-17"><a href="#cb255-17" aria-hidden="true" tabindex="-1"></a><span class="co">/* Function metadata */</span></span>
<span id="cb255-18"><a href="#cb255-18" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb255-19"><a href="#cb255-19" aria-hidden="true" tabindex="-1"></a>    <span class="dt">const</span> <span class="dt">char</span><span class="op">*</span> name<span class="op">;</span></span>
<span id="cb255-20"><a href="#cb255-20" aria-hidden="true" tabindex="-1"></a>    <span class="dt">const</span> <span class="dt">char</span><span class="op">*</span> signature<span class="op">;</span></span>
<span id="cb255-21"><a href="#cb255-21" aria-hidden="true" tabindex="-1"></a>    <span class="dt">const</span> <span class="dt">char</span><span class="op">*</span> doc_string<span class="op">;</span></span>
<span id="cb255-22"><a href="#cb255-22" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> is_variadic<span class="op">;</span></span>
<span id="cb255-23"><a href="#cb255-23" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> DyrFunctionInfo<span class="op">;</span></span>
<span id="cb255-24"><a href="#cb255-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb255-25"><a href="#cb255-25" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> dyr_function_set_info<span class="op">(</span>DyrValue<span class="op">*</span> func<span class="op">,</span> <span class="dt">const</span> DyrFunctionInfo<span class="op">*</span> info<span class="op">);</span></span>
<span id="cb255-26"><a href="#cb255-26" aria-hidden="true" tabindex="-1"></a><span class="dt">const</span> DyrFunctionInfo<span class="op">*</span> dyr_function_get_info<span class="op">(</span>DyrValue<span class="op">*</span> func<span class="op">);</span></span></code></pre></div>
<h3>B.6.2 Function Invocation</h3>
<div class="sourceCode" id="cb256"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb256-1"><a href="#cb256-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* Call functions */</span></span>
<span id="cb256-2"><a href="#cb256-2" aria-hidden="true" tabindex="-1"></a>DyrValue<span class="op">*</span> dyr_call<span class="op">(</span>DyrValue<span class="op">*</span> callable<span class="op">,</span> DyrValue<span class="op">**</span> args<span class="op">,</span> <span class="dt">int</span> argc<span class="op">);</span></span>
<span id="cb256-3"><a href="#cb256-3" aria-hidden="true" tabindex="-1"></a>DyrValue<span class="op">*</span> dyr_call_method<span class="op">(</span>DyrValue<span class="op">*</span> object<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span><span class="op">*</span> method<span class="op">,</span></span>
<span id="cb256-4"><a href="#cb256-4" aria-hidden="true" tabindex="-1"></a>                         DyrValue<span class="op">**</span> args<span class="op">,</span> <span class="dt">int</span> argc<span class="op">);</span></span>
<span id="cb256-5"><a href="#cb256-5" aria-hidden="true" tabindex="-1"></a>DyrValue<span class="op">*</span> dyr_apply<span class="op">(</span>DyrValue<span class="op">*</span> callable<span class="op">,</span> DyrValue<span class="op">*</span> arg_array<span class="op">);</span></span>
<span id="cb256-6"><a href="#cb256-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb256-7"><a href="#cb256-7" aria-hidden="true" tabindex="-1"></a><span class="co">/* Protected calls (catch exceptions) */</span></span>
<span id="cb256-8"><a href="#cb256-8" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb256-9"><a href="#cb256-9" aria-hidden="true" tabindex="-1"></a>    DyrValue<span class="op">*</span> result<span class="op">;</span></span>
<span id="cb256-10"><a href="#cb256-10" aria-hidden="true" tabindex="-1"></a>    DyrValue<span class="op">*</span> exception<span class="op">;</span></span>
<span id="cb256-11"><a href="#cb256-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">const</span> <span class="dt">char</span><span class="op">*</span> error_message<span class="op">;</span></span>
<span id="cb256-12"><a href="#cb256-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> DyrCallResult<span class="op">;</span></span>
<span id="cb256-13"><a href="#cb256-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb256-14"><a href="#cb256-14" aria-hidden="true" tabindex="-1"></a>DyrCallResult dyr_pcall<span class="op">(</span>DyrValue<span class="op">*</span> callable<span class="op">,</span> DyrValue<span class="op">**</span> args<span class="op">,</span> <span class="dt">int</span> argc<span class="op">);</span></span>
<span id="cb256-15"><a href="#cb256-15" aria-hidden="true" tabindex="-1"></a>DyrCallResult dyr_pcall_method<span class="op">(</span>DyrValue<span class="op">*</span> object<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span><span class="op">*</span> method<span class="op">,</span></span>
<span id="cb256-16"><a href="#cb256-16" aria-hidden="true" tabindex="-1"></a>                               DyrValue<span class="op">**</span> args<span class="op">,</span> <span class="dt">int</span> argc<span class="op">);</span></span></code></pre></div>
<h2>B.7 Memory Management API</h2>
<h3>B.7.1 Handle Management</h3>
<div class="sourceCode" id="cb257"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb257-1"><a href="#cb257-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* Handle creation and management */</span></span>
<span id="cb257-2"><a href="#cb257-2" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> DyrHandle DyrHandle<span class="op">;</span></span>
<span id="cb257-3"><a href="#cb257-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb257-4"><a href="#cb257-4" aria-hidden="true" tabindex="-1"></a>DyrHandle<span class="op">*</span> dyr_handle_new<span class="op">(</span>DiyrbalVM<span class="op">*</span> vm<span class="op">,</span> DyrValue<span class="op">*</span> value<span class="op">);</span></span>
<span id="cb257-5"><a href="#cb257-5" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> dyr_handle_free<span class="op">(</span>DyrHandle<span class="op">*</span> handle<span class="op">);</span></span>
<span id="cb257-6"><a href="#cb257-6" aria-hidden="true" tabindex="-1"></a>DyrValue<span class="op">*</span> dyr_handle_get<span class="op">(</span>DyrHandle<span class="op">*</span> handle<span class="op">);</span></span>
<span id="cb257-7"><a href="#cb257-7" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> dyr_handle_set<span class="op">(</span>DyrHandle<span class="op">*</span> handle<span class="op">,</span> DyrValue<span class="op">*</span> value<span class="op">);</span></span>
<span id="cb257-8"><a href="#cb257-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb257-9"><a href="#cb257-9" aria-hidden="true" tabindex="-1"></a><span class="co">/* Handle scopes for automatic cleanup */</span></span>
<span id="cb257-10"><a href="#cb257-10" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> DyrHandleScope DyrHandleScope<span class="op">;</span></span>
<span id="cb257-11"><a href="#cb257-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb257-12"><a href="#cb257-12" aria-hidden="true" tabindex="-1"></a>DyrHandleScope<span class="op">*</span> dyr_handle_scope_new<span class="op">(</span>DiyrbalVM<span class="op">*</span> vm<span class="op">);</span></span>
<span id="cb257-13"><a href="#cb257-13" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> dyr_handle_scope_close<span class="op">(</span>DyrHandleScope<span class="op">*</span> scope<span class="op">);</span></span>
<span id="cb257-14"><a href="#cb257-14" aria-hidden="true" tabindex="-1"></a>DyrValue<span class="op">*</span> dyr_handle_scope_add<span class="op">(</span>DyrHandleScope<span class="op">*</span> scope<span class="op">,</span> DyrValue<span class="op">*</span> value<span class="op">);</span></span>
<span id="cb257-15"><a href="#cb257-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb257-16"><a href="#cb257-16" aria-hidden="true" tabindex="-1"></a><span class="co">/* Convenience macro for handle scopes */</span></span>
<span id="cb257-17"><a href="#cb257-17" aria-hidden="true" tabindex="-1"></a><span class="pp">#define DYR_WITH_HANDLE_SCOPE</span><span class="op">(</span><span class="pp">vm</span><span class="op">,</span><span class="pp"> scope_var</span><span class="op">)</span><span class="pp"> </span><span class="op">\</span></span>
<span id="cb257-18"><a href="#cb257-18" aria-hidden="true" tabindex="-1"></a><span class="pp">    </span><span class="cf">for</span><span class="pp"> </span><span class="op">(</span><span class="pp">DyrHandleScope</span><span class="op">*</span><span class="pp"> scope_var </span><span class="op">=</span><span class="pp"> dyr_handle_scope_new</span><span class="op">(</span><span class="pp">vm</span><span class="op">);</span><span class="pp"> </span><span class="op">\</span></span>
<span id="cb257-19"><a href="#cb257-19" aria-hidden="true" tabindex="-1"></a><span class="pp">         scope_var</span><span class="op">;</span><span class="pp"> </span><span class="op">\</span></span>
<span id="cb257-20"><a href="#cb257-20" aria-hidden="true" tabindex="-1"></a><span class="pp">         dyr_handle_scope_close</span><span class="op">(</span><span class="pp">scope_var</span><span class="op">),</span><span class="pp"> scope_var </span><span class="op">=</span><span class="pp"> NULL</span><span class="op">)</span></span></code></pre></div>
<h3>B.7.2 GC Control</h3>
<div class="sourceCode" id="cb258"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb258-1"><a href="#cb258-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* GC operations */</span></span>
<span id="cb258-2"><a href="#cb258-2" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> dyr_gc_collect<span class="op">(</span>DiyrbalVM<span class="op">*</span> vm<span class="op">);</span></span>
<span id="cb258-3"><a href="#cb258-3" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> dyr_gc_collect_full<span class="op">(</span>DiyrbalVM<span class="op">*</span> vm<span class="op">);</span></span>
<span id="cb258-4"><a href="#cb258-4" aria-hidden="true" tabindex="-1"></a><span class="dt">size_t</span> dyr_gc_memory_used<span class="op">(</span>DiyrbalVM<span class="op">*</span> vm<span class="op">);</span></span>
<span id="cb258-5"><a href="#cb258-5" aria-hidden="true" tabindex="-1"></a><span class="dt">size_t</span> dyr_gc_memory_limit<span class="op">(</span>DiyrbalVM<span class="op">*</span> vm<span class="op">);</span></span>
<span id="cb258-6"><a href="#cb258-6" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> dyr_gc_set_memory_limit<span class="op">(</span>DiyrbalVM<span class="op">*</span> vm<span class="op">,</span> <span class="dt">size_t</span> limit<span class="op">);</span></span>
<span id="cb258-7"><a href="#cb258-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb258-8"><a href="#cb258-8" aria-hidden="true" tabindex="-1"></a><span class="co">/* GC control */</span></span>
<span id="cb258-9"><a href="#cb258-9" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> dyr_gc_disable<span class="op">(</span>DiyrbalVM<span class="op">*</span> vm<span class="op">);</span></span>
<span id="cb258-10"><a href="#cb258-10" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> dyr_gc_enable<span class="op">(</span>DiyrbalVM<span class="op">*</span> vm<span class="op">);</span></span>
<span id="cb258-11"><a href="#cb258-11" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> dyr_gc_is_enabled<span class="op">(</span>DiyrbalVM<span class="op">*</span> vm<span class="op">);</span></span>
<span id="cb258-12"><a href="#cb258-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb258-13"><a href="#cb258-13" aria-hidden="true" tabindex="-1"></a><span class="co">/* Root management */</span></span>
<span id="cb258-14"><a href="#cb258-14" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> dyr_gc_add_root<span class="op">(</span>DiyrbalVM<span class="op">*</span> vm<span class="op">,</span> DyrValue<span class="op">*</span> value<span class="op">);</span></span>
<span id="cb258-15"><a href="#cb258-15" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> dyr_gc_remove_root<span class="op">(</span>DiyrbalVM<span class="op">*</span> vm<span class="op">,</span> DyrValue<span class="op">*</span> value<span class="op">);</span></span>
<span id="cb258-16"><a href="#cb258-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb258-17"><a href="#cb258-17" aria-hidden="true" tabindex="-1"></a><span class="co">/* Weak references */</span></span>
<span id="cb258-18"><a href="#cb258-18" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="dt">void</span> <span class="op">(*</span>DyrWeakCallback<span class="op">)(</span>DyrValue<span class="op">*</span> value<span class="op">,</span> <span class="dt">void</span><span class="op">*</span> data<span class="op">);</span></span>
<span id="cb258-19"><a href="#cb258-19" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> dyr_gc_make_weak<span class="op">(</span>DyrValue<span class="op">*</span> value<span class="op">,</span> DyrWeakCallback callback<span class="op">,</span> </span>
<span id="cb258-20"><a href="#cb258-20" aria-hidden="true" tabindex="-1"></a>                      <span class="dt">void</span><span class="op">*</span> data<span class="op">);</span></span></code></pre></div>
<h2>B.8 Module System API</h2>
<h3>B.8.1 Module Management</h3>
<div class="sourceCode" id="cb259"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb259-1"><a href="#cb259-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* Module operations */</span></span>
<span id="cb259-2"><a href="#cb259-2" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> DyrModule DyrModule<span class="op">;</span></span>
<span id="cb259-3"><a href="#cb259-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb259-4"><a href="#cb259-4" aria-hidden="true" tabindex="-1"></a>DyrModule<span class="op">*</span> dyr_module_create<span class="op">(</span>DiyrbalVM<span class="op">*</span> vm<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span><span class="op">*</span> name<span class="op">);</span></span>
<span id="cb259-5"><a href="#cb259-5" aria-hidden="true" tabindex="-1"></a>DyrStatus dyr_module_load<span class="op">(</span>DiyrbalVM<span class="op">*</span> vm<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span><span class="op">*</span> path<span class="op">);</span></span>
<span id="cb259-6"><a href="#cb259-6" aria-hidden="true" tabindex="-1"></a>DyrStatus dyr_module_load_source<span class="op">(</span>DiyrbalVM<span class="op">*</span> vm<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span><span class="op">*</span> name<span class="op">,</span></span>
<span id="cb259-7"><a href="#cb259-7" aria-hidden="true" tabindex="-1"></a>                                 <span class="dt">const</span> <span class="dt">char</span><span class="op">*</span> source<span class="op">);</span></span>
<span id="cb259-8"><a href="#cb259-8" aria-hidden="true" tabindex="-1"></a>DyrModule<span class="op">*</span> dyr_module_get<span class="op">(</span>DiyrbalVM<span class="op">*</span> vm<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span><span class="op">*</span> name<span class="op">);</span></span>
<span id="cb259-9"><a href="#cb259-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb259-10"><a href="#cb259-10" aria-hidden="true" tabindex="-1"></a><span class="co">/* Module exports */</span></span>
<span id="cb259-11"><a href="#cb259-11" aria-hidden="true" tabindex="-1"></a>DyrStatus dyr_module_export_value<span class="op">(</span>DyrModule<span class="op">*</span> module<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span><span class="op">*</span> name<span class="op">,</span></span>
<span id="cb259-12"><a href="#cb259-12" aria-hidden="true" tabindex="-1"></a>                                  DyrValue<span class="op">*</span> value<span class="op">);</span></span>
<span id="cb259-13"><a href="#cb259-13" aria-hidden="true" tabindex="-1"></a>DyrStatus dyr_module_export_function<span class="op">(</span>DyrModule<span class="op">*</span> module<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span><span class="op">*</span> name<span class="op">,</span></span>
<span id="cb259-14"><a href="#cb259-14" aria-hidden="true" tabindex="-1"></a>                                     DyrNativeFunc func<span class="op">,</span> <span class="dt">int</span> min_args<span class="op">,</span></span>
<span id="cb259-15"><a href="#cb259-15" aria-hidden="true" tabindex="-1"></a>                                     <span class="dt">int</span> max_args<span class="op">);</span></span>
<span id="cb259-16"><a href="#cb259-16" aria-hidden="true" tabindex="-1"></a>DyrStatus dyr_module_export_class<span class="op">(</span>DyrModule<span class="op">*</span> module<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span><span class="op">*</span> name<span class="op">,</span></span>
<span id="cb259-17"><a href="#cb259-17" aria-hidden="true" tabindex="-1"></a>                                  DyrValue<span class="op">*</span> class_value<span class="op">);</span></span>
<span id="cb259-18"><a href="#cb259-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb259-19"><a href="#cb259-19" aria-hidden="true" tabindex="-1"></a><span class="co">/* Module imports */</span></span>
<span id="cb259-20"><a href="#cb259-20" aria-hidden="true" tabindex="-1"></a>DyrValue<span class="op">*</span> dyr_module_import<span class="op">(</span>DiyrbalVM<span class="op">*</span> vm<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span><span class="op">*</span> module</span></code></pre></div>
</body>
</html>
